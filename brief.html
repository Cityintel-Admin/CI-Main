<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CityIntel — Intelligence Brief</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Data -->
  <script src="filterEvents.js"></script>
  <script src="auth.js"></script>
  <script src="alerts-data.js"></script>

  <script>
(function pageGuard(){
  const NEED_LOGIN = true;          // this page requires a login
  const NEED_SUB = false;           // set to true on pages that require an active sub

  // Must be logged in?
  if (NEED_LOGIN && (!window.CIAuth || !CIAuth.isLoggedIn())) {
    const here = location.pathname.split('/').pop() || 'index.html';
    const next = encodeURIComponent(here + location.search + location.hash);
    location.href = 'login.html?next=' + next;
    return;
  }

  // Must be subscribed?
  if (NEED_SUB) {
    const isSub = localStorage.getItem('ci_subscribed') === 'true';
    if (!isSub) {
      location.href = 'subscribe.html';
      return;
    }
  }
})();
</script>
  
  
  
  <script>
(function compatProfileShim(){
  if (!window.CIAuth || !CIAuth.isLoggedIn()) return;
  const u = CIAuth.who();
  if (!u) return;
  localStorage.setItem('ci_profile', JSON.stringify({
    name: u.name || 'CityIntel User',
    email: u.email,
    role: u.role || 'Admin',
    is_admin: (u.role||'').toLowerCase()==='admin'
  }));
  // Do NOT auto-set ci_subscribed here anymore
})();
</script>

  
  <style>
    :root{
      --brand-red:#D01616; --brand-black:#0C0C0C;
      --gray-900:#111214; --gray-800:#16171a; --gray-700:#1c1e22; --gray-600:#24272c;
      --muted:#8e97a3; --text:#e9edf2; --ok:#33c48d; --warn:#f0b429; --danger:#ff5a5f;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:linear-gradient(180deg,var(--gray-900),var(--gray-800));
      color:var(--text); font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }

    .wrap{max-width:1000px;margin:28px auto;padding:0 16px 40px}
    .topbar{display:flex;align-items:center;gap:12px;margin-bottom:14px}
    .brand{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:12px;
      background:linear-gradient(90deg,rgba(208,22,22,0.2),rgba(208,22,22,0));}
    .brand img{width:34px;height:34px;object-fit:contain;border-radius:6px;background:#fff}
    .brand .t{font-weight:800;letter-spacing:.3px}

    h1{margin:10px 0 2px 0;font-size:26px;letter-spacing:.2px}
    .date-sub{color:var(--muted);margin-bottom:18px}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{
      background:linear-gradient(180deg,#1a1c20,#131417);
      border:1px solid var(--gray-600); border-radius:var(--radius); padding:16px;
      box-shadow:0 8px 24px rgba(0,0,0,.35)
    }
    .card h2{margin:0 0 10px 0;font-size:18px;letter-spacing:.2px}
    .muted{color:var(--muted)}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;border:1px solid transparent;font-size:12px}
    .pill.high{background:rgba(255,90,95,.15);color:var(--danger);border-color:rgba(255,90,95,.35)}
    .pill.med {background:rgba(240,180,41,.15);color:var(--warn);border-color:rgba(240,180,41,.35)}
    .pill.low {background:rgba(51,196,141,.15);color:var(--ok);border-color:rgba(51,196,141,.35)}

    /* KPI band */
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .kpi{background:rgba(255,255,255,0.02);border:1px solid var(--gray-600);border-radius:12px;padding:12px}
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .value{font-size:26px;font-weight:800;margin-top:2px}
    .kpi .delta{font-size:12px;margin-left:6px;padding:2px 8px;border-radius:999px;border:1px solid transparent}
    .delta.up{background:rgba(51,196,141,.15);color:var(--ok);border:1px solid rgba(51,196,141,.35)}
    .delta.down{background:rgba(255,90,95,.15);color:var(--danger);border:1px solid rgba(255,90,95,.35)}

    /* Lists & tables */
    ul.clean{list-style:none;margin:0;padding:0}
    ul.clean li{padding:8px 0;border-top:1px solid var(--gray-600)}
    ul.clean li:first-child{border-top:none}

    table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
    th{background:var(--gray-700);text-align:left;padding:8px;color:var(--muted);font-weight:600}
    td{padding:8px;border-top:1px solid var(--gray-600)}
    tr:hover td{background:rgba(255,255,255,0.02)}

    /* Bars (risk distribution) */
    .bars{display:grid;gap:8px}
    .bar-row{display:flex;align-items:center;gap:10px}
    .bar-lbl{width:70px;color:var(--muted);font-size:12px}
    .bar-wrap{flex:1;height:12px;background:var(--gray-700);border:1px solid var(--gray-600);border-radius:999px;overflow:hidden}
    .bar-fill{height:100%}
    .bar-high{background:var(--danger)} .bar-med{background:var(--warn)} .bar-low{background:var(--ok)}

    /* Cards sizing */
    .span-12{grid-column:span 12}
    .span-6{grid-column:span 6}
    .span-4{grid-column:span 4}
    .span-8{grid-column:span 8}

    /* Footer nav */
    .footer-links{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .btn-link{display:inline-block;padding:8px 12px;border-radius:999px;border:1px solid var(--gray-600);text-decoration:none;color:var(--text)}
    .btn-link:hover{background:rgba(255,255,255,0.04)}
  </style>
</head>

<script>
  // must be after the header DOM exists
  document.addEventListener('DOMContentLoaded', function(){
    CIAuth.injectUserChip(document.getElementById('topActions'));
    CIAuth.updateSidebarForRole(document.querySelector('aside.sidebar nav'));
  });
</script>


<body>
  <div class="wrap">

    <!-- header -->
    <div class="topbar">
      <div class="brand">
        <img src="CityintLogo.jpg" alt="CityIntel Logo" />
        <div class="t">CityIntel</div>
      </div>
    </div>
    <h1>Intelligence Brief</h1>
    <div class="date-sub" id="briefDate"></div>

<div id="trial-banner" style="display:none;background:#3b0a0a;color:#fecaca;padding:8px 12px;text-align:center;">
  <span id="trial-text">Your trial ends soon.</span>
</div>	

    
    <!-- KPI band -->
    <div class="kpis" style="margin-bottom:16px">
      <div class="kpi">
        <div class="label">Active (24h)</div>
        <div><span class="value" id="kpi24">0</span><span class="delta" id="kpi24Delta" style="display:none"></span></div>
      </div>
      <div class="kpi">
        <div class="label">Upcoming (7 days)</div>
        <div><span class="value" id="kpi7">0</span><span class="delta" id="kpi7Delta" style="display:none"></span></div>
      </div>
      <div class="kpi">
        <div class="label">High-Risk (next 7 days)</div>
        <div><span class="value" id="kpiHigh" style="color:var(--danger)">0</span><span class="delta" id="kpiHighDelta" style="display:none"></span></div>
      </div>
    </div>

    <div class="grid">
      <!-- Top high risk list -->
      <section class="card span-6">
        <h2>Top Upcoming High-Risk</h2>
        <ul class="clean" id="topHighList"></ul>
      </section>

      <!-- Risk distribution -->
      <section class="card span-6">
        <h2>Risk Distribution (7 days)</h2>
        <div class="bars" id="riskBars">
          <!-- filled by JS -->
        </div>
        <div class="muted" id="riskBarsNote" style="margin-top:8px"></div>
      </section>

      <!-- Regional outlook -->
      <section class="card span-8">
        <h2>Regional Outlook</h2>
        <ul class="clean" id="regionalList"></ul>
      </section>

      <!-- Source activity -->
      <section class="card span-4">
        <h2>Source Activity (24h)</h2>
        <table>
          <thead>
            <tr><th>Metric</th><th>Value</th></tr>
          </thead>
          <tbody id="sourceTable">
            <!-- JS -->
          </tbody>
        </table>
        <div class="muted" style="margin-top:8px">Derived from unique source domains in alerts.</div>
      </section>

      <!-- Analyst Notes (static for now) -->
      <section class="card span-12">
        <h2>Analyst Notes</h2>
        <ul class="clean">
          <li>Education-sector actions clustering across West Africa; monitor spillover routes.</li>
          <li>Transport unions signalling synchronized actions in major Latin American hubs.</li>
          <li>Online mobilization spikes precede on-street activity by ~48–72h in several metros.</li>
        </ul>

        <div class="footer-links">
          <a class="btn-link" href="index.html">← Back to Dashboard</a>
          <a class="btn-link" href="alerts.html">View All Alerts</a>
          <a class="btn-link" href="events.html">Browse Events</a>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ----- helpers -----
    const DATA = Array.isArray(window.alertsData) ? window.alertsData : [];
    const CIF = window.CIFilter || {};

    const parse = v => (window.CIHelpers && CIHelpers.parseWhenAny(v)) || (v?new Date(v):null);
    const riskKey = r => {
      const s = String(r||'').toLowerCase();
      if (s.startsWith('hi')) return 'high';
      if (s.startsWith('me')) return 'med';
      return 'low';
    };
    const labelRisk = r => r==='high'?'High':r==='med'?'Medium':'Low';

    // Upcoming list (future only), with normalized fields
    function upcomingAll(){
      // Use shared helper if available, otherwise fallback
      if (CIF.upcoming) return CIF.upcoming(DATA);
      const now = new Date();
      return (DATA||[])
        .map(a => ({...a, risk: riskKey(a.risk), _dt: parse(a.time||a.datetime||a.date||a.when)}))
        .filter(a => a._dt && a._dt >= now)
        .sort((a,b)=> a._dt - b._dt);
    }

    // Window counters
    function countInWindow(start, end, predicate = ()=>true){
      let n=0;
      for (const a of DATA) {
        const dt = parse(a.time||a.datetime||a.date||a.when);
        if (!dt) continue;
        if (dt > start && dt <= end && predicate(a)) n++;
      }
      return n;
    }

    function domainOf(src){
      try {
        if (!src) return '';
        const u = new URL(src);
        return u.hostname.replace(/^www\./,'');
      } catch(e){ return ''; }
    }

    // ----- render -----
    (function renderBrief(){
      // Header date
      const now = new Date();
      document.getElementById('briefDate').textContent =
        now.toLocaleString('en-GB',{weekday:'long', day:'2-digit', month:'short', year:'numeric'});

      // KPIs
      const k24   = document.getElementById('kpi24');
      const k24D  = document.getElementById('kpi24Delta');
      const k7    = document.getElementById('kpi7');
      const k7D   = document.getElementById('kpi7Delta');
      const kHi   = document.getElementById('kpiHigh');
      const kHiD  = document.getElementById('kpiHighDelta');

      const tNow  = new Date();
      const t24   = new Date(tNow.getTime() - 24*3600*1000);
      const tPrev = new Date(t24.getTime() - 24*3600*1000);
      const next7 = new Date(tNow.getTime() + 7*24*3600*1000);
      const prev7 = new Date(tNow.getTime() - 7*24*3600*1000);

      const activeCurr = countInWindow(t24, tNow);
      const activePrev = countInWindow(tPrev, t24);
      k24.textContent = activeCurr;
      if (activePrev>0){ k24D.textContent = deltaPct(activeCurr, activePrev); k24D.className = 'delta '+trendClass(activeCurr-activePrev); k24D.style.display='inline-block'; }

      const upcomingCurr = countInWindow(tNow, next7);
      const upcomingPrev = countInWindow(prev7, tNow);
      k7.textContent = upcomingCurr;
      if (upcomingPrev>0){ k7D.textContent = deltaPct(upcomingCurr, upcomingPrev); k7D.className = 'delta '+trendClass(upcomingCurr-upcomingPrev); k7D.style.display='inline-block'; }

      const isHigh = a => riskKey(a.risk)==='high';
      const hiCurr = countInWindow(tNow, next7, isHigh);
      const hiPrev = countInWindow(prev7, tNow, isHigh);
      kHi.textContent = hiCurr;
      if (hiPrev>0){ kHiD.textContent = deltaPct(hiCurr, hiPrev); kHiD.className = 'delta '+trendClass(hiCurr-hiPrev); kHiD.style.display='inline-block'; }

      // Top upcoming high-risk (5)
      const topList = document.getElementById('topHighList');
      topList.innerHTML = '';
      const soon = upcomingAll().filter(a => a.risk==='high').slice(0,5);
      if (!soon.length){
        topList.innerHTML = `<li class="muted">No upcoming high-risk events.</li>`;
      } else {
        soon.forEach(a=>{
          const when = a._dt ? a._dt.toLocaleString('en-GB',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}) : '';
          const loc  = [a.city||'', a.country||a.Country||''].filter(Boolean).join(' — ');
          const src  = a.source ? ` <a href="${a.source}" target="_blank" rel="noopener" style="color:#9ccaff;text-decoration:none">source ↗</a>` : '';
          const li = document.createElement('li');
          li.innerHTML = `<span class="pill high" style="margin-right:6px">High</span> <strong>${loc || (a.title||'')}</strong> — ${a.title||''} <span class="muted">— ${when}</span>${src}`;
          topList.appendChild(li);
        });
      }

      // Risk distribution (next 7d)
      const bars = document.getElementById('riskBars');
      const barsNote = document.getElementById('riskBarsNote');
      const next7Items = upcomingAll().filter(a => a._dt <= next7);
      const counts = {high:0, med:0, low:0};
      next7Items.forEach(a=> counts[a.risk] = (counts[a.risk]||0) + 1);
      const total = counts.high + counts.med + counts.low;
      bars.innerHTML = '';
      [['High','high','bar-high'],['Medium','med','bar-med'],['Low','low','bar-low']].forEach(([lbl,key,cls])=>{
        const pct = total ? Math.round((counts[key] / total)*100) : 0;
        const row = document.createElement('div'); row.className = 'bar-row';
        const l = document.createElement('div'); l.className='bar-lbl'; l.textContent = lbl;
        const w = document.createElement('div'); w.className='bar-wrap';
        const f = document.createElement('div'); f.className='bar-fill '+cls; f.style.width = pct+'%';
        w.appendChild(f); row.appendChild(l); row.appendChild(w);
        const v = document.createElement('div'); v.style.minWidth='46px'; v.style.textAlign='right'; v.textContent = `${counts[key]} (${pct}%)`;
        row.appendChild(v);
        bars.appendChild(row);
      });
      barsNote.textContent = total ? `${total} total upcoming events considered.` : 'No upcoming events in next 7 days.';

      // Regional outlook (next 7d vs previous 7d)
      const regionalList = document.getElementById('regionalList');
      regionalList.innerHTML = '';
      const continents = ["Africa","Asia","Europe","North America","South America","Oceania"];

      function countByCont(start, end){
        const out = new Map();
        for (const a of DATA){
          const dt = parse(a.time||a.datetime||a.date||a.when);
          if (!dt || dt<=start || dt>end) continue;
          const cont = a.Continent || a.continent || '';
          if (!cont) continue;
          const rk = riskKey(a.risk);
          if (!out.has(cont)) out.set(cont, {total:0, high:0, med:0, low:0});
          const row = out.get(cont);
          row.total++; row[rk]++; out.set(cont,row);
        }
        return out;
      }

      const currCont = countByCont(tNow, next7);
      const prevCont = countByCont(prev7, tNow);

      continents.forEach(c=>{
        const cur = currCont.get(c) || {total:0,high:0,med:0,low:0};
        const prv = prevCont.get(c) || {total:0,high:0,med:0,low:0};
        const diff = cur.total - prv.total;
        const trend = diff===0 ? '→' : (diff>0 ? '↑' : '↓');
        const trendClr = diff>0 ? 'var(--ok)' : diff<0 ? 'var(--danger)' : 'var(--muted)';
        const riskNote =
          cur.high ? 'Elevated' : (cur.med ? 'Moderate' : (cur.total? 'Low' : 'No upcoming'));
        const li = document.createElement('li');
        li.innerHTML = `
          <strong>${c}</strong>
          <span class="muted">— ${riskNote}</span>
          <span style="margin-left:8px;color:${trendClr}">${trend} ${Math.abs(diff)}</span>
          <div class="muted" style="margin-top:4px">
            High ${cur.high} • Med ${cur.med} • Low ${cur.low} (total ${cur.total})
          </div>`;
        regionalList.appendChild(li);
      });

      // Source Activity (24h)
      const sourceT = document.getElementById('sourceTable');
      const last24 = DATA.filter(a=>{
        const dt = parse(a.time||a.datetime||a.date||a.when);
        return dt && dt > t24 && dt <= tNow;
      });
      const uniqueDomains = new Set(last24.map(a=>domainOf(a.source)).filter(Boolean));
      const hiShare = last24.length ? Math.round(100*last24.filter(a=>riskKey(a.risk)==='high').length / last24.length) : 0;

      sourceT.innerHTML = `
        <tr><td>Alerts ingested (24h)</td><td><strong>${last24.length}</strong></td></tr>
        <tr><td>Unique source domains</td><td><strong>${uniqueDomains.size}</strong></td></tr>
        <tr><td>High-risk proportion</td><td><strong>${hiShare}%</strong></td></tr>
        <tr><td>Reliability (est.)</td><td><span class="muted">n/a (static)</span></td></tr>
      `;

      // small utils
      function deltaPct(curr, prev){
        const diff = curr - prev;
        const pct  = Math.round((diff/prev)*100);
        return (diff>=0?'+':'') + pct + '%';
      }
      function trendClass(diff){ return diff>=0 ? 'up' : 'down'; }
    })();
  </script>


<script>
(function(){
  const API_BASE = 'https://api.cityintelapi.com';
  const bar = document.getElementById('trial-banner');
  const txt = document.getElementById('trial-text');

  function who(){ try { return JSON.parse(localStorage.getItem('ci_profile')||'{}'); } catch { return {}; } }
  function pad(n){ return String(n).padStart(2,'0'); }

  async function getStatus(email){
    const u = new URL(API_BASE + '/api/sub-status');
    u.searchParams.set('email', email);
    const r = await fetch(u);
    if (!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  }

  function startCountdown(endIso){
    const end = new Date(endIso).getTime();
    function tick(){
      const now = Date.now();
      const ms = end - now;
      if (ms <= 0){
        // trial ended → bounce to subscribe
        bar.style.display = 'none';
        location.href = 'subscribe.html?reason=trial_ended';
        return;
      }
      const s = Math.floor(ms/1000);
      const d = Math.floor(s/86400);
      const h = Math.floor((s%86400)/3600);
      const m = Math.floor((s%3600)/60);
      const sec = s%60;
      const parts = [];
      if (d) parts.push(d+'d');
      parts.push(pad(h)+'h', pad(m)+'m', pad(sec)+'s');
      txt.textContent = 'Trial active — ends in ' + parts.join(' ');
      bar.style.display = '';
    }
    tick();
    return setInterval(tick, 1000);
  }

  (async function init(){
    const p = who();
    if (!p.email) return; // not logged in

    try{
      const data = await getStatus(p.email);
      if (data.trialEndsAt){
        startCountdown(data.trialEndsAt);
      }
    }catch(e){
      // silent
      console.warn('trial banner error', e);
    }
  })();
})();
</script>

  
</body>
</html>





