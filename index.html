<!doctype html>
<html lang="en">
<head>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">
<style>
  /* Risk map container */
  #riskMap { height: 460px; border-radius: 14px; overflow: hidden; }
  /* Control bar */
  .riskctl {
    background: rgba(22,23,26,.95);
    color: #e9edf2;
    border: 1px solid #2e3238;
    border-radius: 12px;
    padding: 10px 12px;
    font: 13px/1.4 system-ui;
    display: grid; gap: 8px;
  }
  .riskctl label { display:flex; align-items:center; gap:10px; }
  .risklegend {
    background: rgba(22,23,26,.95);
    color:#e9edf2; border:1px solid #2e3238; border-radius:12px; padding:8px 10px; font:12px system-ui;
  }
  .chip{display:inline-block;width:10px;height:10px;border-radius:2px;margin-right:6px}
</style>

  <meta charset="utf-8" />
  <title>CityIntel — Situational Intelligence Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="icon" href="./CityintLogo.jpg">
  <meta property="og:title" content="CityIntel – Situational Intelligence" />
  <meta property="og:description" content="Live alerts, upcoming events, and risk visualization." />
  <meta property="og:image" content="./assets/og-preview.jpg" />
  <meta name="twitter:card" content="summary_large_image" />

  <style>
/* ===== CityIntel theme + components ===== */
:root{
  --brand-red:#D01616; --brand-black:#0C0C0C;
  --brand-gray-900:#111214; --brand-gray-800:#16171a; --brand-gray-700:#1c1e22;
  --brand-gray-600:#24272c; --brand-gray-500:#2e3238;
  --muted:#8e97a3; --text:#e9edf2; --ok:#33c48d; --warn:#f0b429; --danger:#ff5a5f;
  --card-radius:16px; --shadow:0 8px 24px rgba(0,0,0,0.35);
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0; background:linear-gradient(180deg,var(--brand-gray-900),var(--brand-gray-800));
  color:var(--text); font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
}

/* Layout */
.app{
  display:grid; grid-template-columns:260px 1fr; grid-template-rows:60px auto 1fr;
  grid-template-areas:"sidebar topbar" "sidebar banner" "sidebar main"; min-height:100vh;
}
.sidebar{
  grid-area:sidebar; background:linear-gradient(180deg,var(--brand-black),#131416);
  border-right:1px solid var(--brand-gray-600); display:flex; flex-direction:column; padding:18px 14px; gap:18px;
}
.brand{display:flex;align-items:center;gap:10px; padding:8px 10px; border-radius:12px;
  background:linear-gradient(90deg,rgba(208,22,22,0.2),rgba(208,22,22,0));}
.brand img{width:34px;height:34px;object-fit:contain;border-radius:6px;background:#fff}
.brand .title{font-weight:700;letter-spacing:.3px}
nav a{display:flex;align-items:center;gap:10px;color:#e9edf2;text-decoration:none;
  padding:10px 12px;border-radius:10px;border:1px solid transparent}
nav a:hover{background:#24272c;border-color:#2e3238}
nav a.active{background:rgba(208,22,22,0.15);border-color:#D01616}

.topbar{
  grid-area:topbar;background:rgba(255,255,255,0.02);border-bottom:1px solid var(--brand-gray-600);
  display:flex;align-items:center;gap:12px;padding:10px 16px;position:sticky;top:0;z-index:10;backdrop-filter:blur(8px)
}
.search{flex:1;display:flex;align-items:center;gap:10px;background:var(--brand-gray-700);
  border:1px solid var(--brand-gray-600);border-radius:12px;padding:8px 12px}
.search input{flex:1;background:transparent;border:none;outline:none;color:var(--text)}
.pill{padding:8px 12px;border-radius:999px;background:var(--brand-red);color:#fff;font-weight:600;border:1px solid #9c0f0f}
.user{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;background:var(--brand-gray-700);border:1px solid var(--brand-gray-600)}
.avatar{width:28px;height:28px;background:#fff;color:#000;border-radius:50%;display:grid;place-items:center;font-weight:700}

.main{grid-area:main;padding:18px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}

/* Cards */
.card{background:linear-gradient(180deg,#1a1c20,#131417);border:1px solid var(--brand-gray-600);
  border-radius:var(--card-radius);box-shadow:var(--shadow);padding:16px}
.card h3{margin:0 0 10px 0;font-size:16px;letter-spacing:.2px}
.metric{display:flex;align-items:baseline;gap:10px}
.metric .value{font-size:28px;font-weight:800}
.metric .delta{font-size:12px;padding:2px 8px;border-radius:999px}
.delta.up{background:rgba(51,196,141,.15);color:var(--ok);border:1px solid rgba(51,196,141,.35)}
.delta.down{background:rgba(255,90,95,.15);color:var(--danger);border:1px solid rgba(255,90,95,.35)}


/* ===== Today's Protests Banner ===== */
.banner{
  grid-area: banner;
  margin: 6px 0 10px 0;
  padding: 0 16px;
  border:1px solid var(--brand-gray-600);
  border-top: 1px solid var(--brand-gray-600);
  border-radius:12px;
  background:linear-gradient(90deg, rgba(208,22,22,0.2), rgba(208,22,22,0));
  overflow:hidden;
  z-index: 9;
}

.ticker{position:relative;overflow:hidden;white-space:nowrap;
}

.ticker-track{display:flex;gap:2rem;                      /* space between items */
  will-change: transform; animation: tickerLinear var(--ticker-duration, 110s) linear infinite;
  animation-fill-mode: both; animation-name:tickerLinear;
  animation-delay:0s;
  animation-play-state: running
}

.ticker-track > span{display:flex;gap:2rem;padding:10px 14px;
}

.ticker-track:hover { animation-play-state: paused; }

@media (prefers-reduced-motion: reduce){.ticker-track { animation: none !important; }
}

@keyframes tickerLinear {from { transform: translateX(0); } to { transform: translateX(calc(-1*var(--loop-distance,1000px))); }
}

.banner strong {color: #ff5a5f;margin-right: 4px;}



.cell div {backdrop-filter: blur(4px); text-shadow: 0 1px 2px rgba(0,0,0,0.4);}


/* Table */
table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:12px}
thead th{text-align:left;font-size:12px;color:var(--muted);background:var(--brand-gray-700);padding:10px;border-bottom:1px solid var(--brand-gray-600)}
tbody td{padding:12px 10px;border-bottom:1px solid var(--brand-gray-600)}
tr:hover td{background:rgba(255,255,255,0.02)}

/* Alerts list (red left column look) */
.alert{
  border:1px solid var(--brand-gray-600);
  border-left:4px solid var(--brand-red);
  background:linear-gradient(90deg,rgba(208,22,22,.1),rgba(208,22,22,0));
  padding:12px;border-radius:12px;margin-bottom:10px;
}
.alert small{color:var(--muted)}

/* Heatmap */
.heatmap{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:10px}
#risk-heatmap {
  display: flex;
  justify-content: space-evenly;   /* evenly distribute the continents */
  align-items: center;             /* vertically center cells */
  flex-wrap: nowrap;               /* keep in one row */
  gap: 12px;                       /* consistent spacing between cells */
  margin-top: 10px;
}

.cell{width:60px;height:60px;border-radius:6px;border:1px solid #2e3238;display:flex;align-items:flex-end;justify-content:center;font-size:11px;font-weight:600;color:#e9edf2;text-align:center;padding:4px}

#risk-heatmap .cell {
  width: 100px;                    /* same width for all */
  height: 70px;                    /* slightly taller for readability */
  display: flex;
  align-items: flex-end;
  justify-content: center;
  border-radius: 8px;
  font-weight: 600;
  text-align: center;
  position: relative;
}

.lv1{background:#20312b} .lv3{background:#473a23} .lv4{background:#5c2b2b}
.cell:hover{outline:2px solid #D01616;cursor:pointer}

/* Keep Real-Time Alerts compact */
#realtimeAlerts{max-height:220px;overflow-y:auto}

/* Responsive */
@media (max-width:1100px){.app{grid-template-columns:68px 1fr}.brand .title,nav span{display:none}.sidebar{padding:14px 10px}}
@media (max-width:880px){.grid{grid-template-columns:1fr}}

.login-btn {
  display:inline-block;
  padding:8px 12px;
  border-radius:999px;
  background:#D01616;
  border:1px solid #9c0f0f;
  color:#fff;
  font-weight:700;
  text-decoration:none;
  white-space:nowrap;
}
.login-btn:hover { filter:brightness(1.05); }

.user { display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:12px; background:var(--brand-gray-700); border:1px solid var(--brand-gray-600); cursor:pointer; }
.avatar { width:28px;height:28px; background:#fff;color:#000;border-radius:50%; display:grid;place-items:center;font-weight:700; }

.dropdown {
  position:absolute; right:0; top:calc(100% + 6px);
  background:#1a1c20; border:1px solid var(--brand-gray-600); border-radius:10px;
  padding:6px 0; box-shadow:0 4px 12px rgba(0,0,0,0.4);
  display:none; min-width:140px; z-index:50;
}
.dropdown a { display:block; padding:8px 12px; color:var(--text); text-decoration:none; font-size:14px; }
.dropdown a:hover { background:rgba(255,255,255,0.05); }
  </style>
</head>
<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">
        <img src="CityintLogo.jpg" alt="CityIntel Logo" />
        <div class="title">CityIntel</div>
      </div>
      <div class="section-label"></div>
      <nav>
        <a href="index.html" class="active">Dashboard</a>
        <a href="alerts.html">Alerts</a>
        <a href="events.html">Events</a>
		<a href="live-feed.html">Live Feed</a>
		<a href="test.html">Test Feed</a>  
	<a href="brief.html">Intelligence Brief</a>
	<a href="incident.html">Incident Drilldown</a>
	<a href="trends.html">Trends & Forecasts</a>
        <a href="reports.html">Reports</a>
		<a href="sources.html">Sources</a>
        <a href="settings.html">Settings</a>
        <a href="about.html">About</a>
      </nav>
      <div style="margin-top:auto;color:var(--muted);font-size:12px">For information use only — not for redistribution</div>
    </aside>

    <!-- TOPBAR -->
    <header class="topbar">
      <div class="search">🔎 <input placeholder="Search events, locations, groups…" /></div>
      <div id="topActions" style="position:relative"></div>
    </header>


<div class="banner" id="ci-banner">
  <div class="ticker">
    <div class="ticker-track" id="tickerTrack">
      <!-- JS will inject two identical <span> blocks -->
    </div>
  </div>
</div>




    <!-- MAIN -->
    <main class="main">

      <div class="grid">
        <!-- KPIs -->

        <section class="card" style="grid-column: span 3;">
          <h3>Active Protests (24h)</h3>
          <div class="metric">    
          <div class="value" id="kpi-active-24h">0</div>
          <div class="delta" id="kpi-active-24h-delta" style="display:none"></div>
  </div>
  <small style="color:var(--muted)">Across tracked sources</small>
</section>

        <section class="card" style="grid-column: span 3;">
          <h3>Upcoming (7 days)</h3>
  <div class="metric">
    <div class="value" id="kpi-upcoming-7d">0</div>
    <div class="delta" id="kpi-upcoming-7d-delta" style="display:none"></div>
  </div>
  <small style="color:var(--muted)">Based on tracked sources</small>
</section>

        <section class="card" style="grid-column: span 3;">
          <h3>High Risk Protests / Events</h3>
          <div class="metric">
          <div class="value" id="kpi-high-risk" style="color:var(--danger)">0</div>
          <div class="delta" id="kpi-high-risk-delta" style="display:none"></div>
          </div>
  <small style="color:var(--muted)">Crowd + Counter-presence</small>
</section>

        <section class="card" style="grid-column: span 3;">
          <h3>Data Freshness</h3>
          <div class="metric"><div class="value">96%</div><div class="delta up">+4%</div></div>
          <small style="color:var(--muted)">Last ingest: 10 mins ago</small>
        </section>


        <!-- Left: Real-Time Alerts (now data-driven) -->
        <section class="card" style="grid-column: span 5;">
          <h3>Real-Time Alerts</h3>
          <div id="realtimeAlerts"></div>
        </section>

        <!-- Right: Upcoming Events (data-driven) -->
        <section class="card" style="grid-column: span 7;">
          <h3>Upcoming Events</h3>
          <table>
            <thead>
              <tr>
                <th>Event</th>
                <th>City</th>
                <th>Date</th>
                <th>Risk</th>
              </tr>
            </thead>
            <tbody id="upcomingBody"></tbody>
          </table>
        </section>

        <!-- Bottom row -->
        <section class="card" style="grid-column: span 12;">
          <h3>Risk Heatmap</h3>
          <div id="risk-heatmap" class="heatmap"></div>
          <div class="legend" style="margin-top:10px">
            <span style="display:inline-block;width:20px;height:14px;background:#20312b;border-radius:4px;border:1px solid #2e3238"></span> Low
            <span style="display:inline-block;width:20px;height:14px;background:#473a23;border-radius:4px;border:1px solid #2e3238;margin-left:10px"></span> Med
            <span style="display:inline-block;width:20px;height:14px;background:#5c2b2b;border-radius:4px;border:1px solid #2e3238;margin-left:10px"></span> High
          </div>
</section>

<div></div>
<div class="card" style="grid-column: span 12;">
  <h3>Global Protest Risk Map</h3>
  <div id="riskMap"></div>
</div>
</div>


<script src="filterEvents.js"></script>
<script src="alerts-data.js"></script>
<script src="metrics.js"></script>

<script>
(function compatProfileShim(){
  if (!window.CIAuth || !CIAuth.isLoggedIn()) return;
  const u = CIAuth.who();
  if (!u) return;
  localStorage.setItem('ci_profile', JSON.stringify({
    name: u.name || 'CityIntel User',
    email: u.email,
    role: u.role || 'Admin',
    is_admin: (u.role||'').toLowerCase()==='admin'
  }));
  // Do NOT auto-set ci_subscribed here anymore
})();
</script>

		
<script>

(function(){
  // Robust date parser
  const MONTHS = { jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,sept:8,oct:9,nov:10,dec:11 };
  function cleanDateStr(s){
    return String(s||'')
      .replace(/\b(\d{1,2})(st|nd|rd|th)\b/gi, '$1')
      .replace(/\bat\b/gi, ' ')
      .replace(/\bGMT|BST|UTC|CEST|CET|IST\b/gi,'')
      .replace(/,\s*/g, ' ')
      .replace(/\s+/g,' ')
      .trim();
  }
  function parseWhenAny(raw){
    if (raw == null) return null;
    if (typeof raw === 'number') { const d = new Date(raw); return isNaN(d) ? null : d; }
    const s0 = String(raw).trim();
    const iso = new Date(s0);
    if (!isNaN(iso)) return iso;
    const s = cleanDateStr(s0);

    let m = s.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
    if (m){ const [_,Y,Mo,Da,H='12',Mi='00',Se='00'] = m; const d = new Date(+Y, +Mo-1, +Da, +H, +Mi, +Se); return isNaN(d)?null:d; }

    m = s.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
    if (m){ const [_,Da,Mo,Y,H='12',Mi='00',Se='00'] = m; const d = new Date(+Y, +Mo-1, +Da, +H, +Mi, +Se); return isNaN(d)?null:d; }

    m = s.match(/^(\d{1,2})\s+([A-Za-z]{3,9})\.?\s+(\d{4})(?:\s+(\d{1,2})(?::(\d{2}))?)?$/);
    if (m){ const [_,Da,Mon,Y,H='12',Mi='00'] = m; const idx = MONTHS[Mon.toLowerCase().slice(0,4)]; const d = new Date(+Y,(idx??0),+Da,+H,+Mi); return isNaN(d)?null:d; }

    m = s.match(/^([A-Za-z]{3,9})\.?\s+(\d{1,2}),?\s+(\d{4})(?:\s+(\d{1,2})(?::(\d{2}))?)?$/);
    if (m){ const [_,Mon,Da,Y,H='12',Mi='00'] = m; const idx = MONTHS[Mon.toLowerCase().slice(0,4)]; const d = new Date(+Y,(idx??0),+Da,+H,+Mi); return isNaN(d)?null:d; }

    return null;
  }
  window.CIHelpers = { parseWhenAny };

  // diagnostics
  const data = Array.isArray(window.alertsData) ? window.alertsData : [];
  const diag = data.map(a=>{
    const raw = a.time ?? a.datetime ?? a.date ?? a.when ?? null;
    const parsed = parseWhenAny(raw);
    return { title:a.title||'', city:a.city||'', raw_time:raw, parsed_ok:!!parsed, parsed_iso: parsed?parsed.toISOString():'' };
  });
  const unparsed = diag.filter(r=>!r.parsed_ok);
  console.info(`CityIntel: alerts=${data.length}, parsed=${diag.length-unparsed.length}, unparsed=${unparsed.length}`);
  if (unparsed.length) console.table(unparsed.slice(0,10));
})();
</script>


<!-- Today's Protests Banner Script -->

<script>
(function mountSeamlessBannerWrap(){
  const track = document.getElementById('tickerTrack');
  const wrap  = track?.closest('.ticker');
  if (!track || !wrap || !Array.isArray(window.alertsData)) return;

  const parse = v => (window.CIHelpers && CIHelpers.parseWhenAny(v)) || (v?new Date(v):null);
  const today = new Date();
  const sameDay = (a,b)=> a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
  const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const fmt = d => `${String(d.getDate()).padStart(2,'0')} ${MONTHS[d.getMonth()]} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;

  const riskChip = r => {
    const s = String(r||'').toLowerCase();
    const t = s.startsWith('hi')?'High':s.startsWith('me')?'Medium':'Low';
    const c = s.startsWith('hi')?'var(--danger)':s.startsWith('me')?'var(--warn)':'var(--ok)';
    return `<span style="display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);color:${c};font-weight:700">${t}</span>`;
  };

  const items = window.alertsData
    .map(a => ({...a, _dt: parse(a.time ?? a.datetime ?? a.date ?? a.when)}))
    .filter(a => a._dt && sameDay(a._dt, today))
    .sort((a,b) => a._dt - b._dt);

  const bits = items.length
    ? items.map(a => `${riskChip(a.risk)} ${a.city || a.country || ''} — ${a.title || ''} — ${fmt(a._dt)}`)
    : ['No events found for today'];

  // Build one block we can measure
  const gapPx = 32; // keep in sync with --gap
  track.style.setProperty('--gap', gapPx + 'px');

  const block = document.createElement('span');
  block.style.display = 'inline-flex';
  block.style.alignItems = 'center';
  block.style.gap = gapPx + 'px';
  block.innerHTML = bits.join('<span style="opacity:.35">|</span>');

  // Reset, append, measure
  track.innerHTML = '';
  track.appendChild(block);

  requestAnimationFrame(() => {
    const blockW = Math.max(10, block.getBoundingClientRect().width); // guard tiny
    const wrapW  = wrap.clientWidth;

    // Clone the block enough times to always have another one directly behind
    // We want at least 3x wrapper width for safety.
    while (track.scrollWidth < wrapW * 3) {
      track.appendChild(block.cloneNode(true));
    }

    // Animate the width of exactly one block (seamless wrap)
    track.style.setProperty('--loop-distance', blockW + 'px');

    // Keep your chosen speed
    track.style.setProperty('--ticker-duration', '110s');

    // Ensure immediate start
    void track.offsetWidth; // reflow
    track.style.animationPlayState = 'running';
  });
})();
</script>
 
<script>
(function mountHeatmap(){
  const grid = document.getElementById("risk-heatmap");
  if (!grid) return;
  grid.innerHTML = "";

  const continents = ["Africa","Asia","Europe","North America","South America","Oceania"];
  const COLORS = { low: "#20312b", med: "#473a23", high: "#5c2b2b" };

  const parse = v => (window.CIHelpers && CIHelpers.parseWhenAny(v)) || (v ? new Date(v) : null);
  const normRisk = r => {
    const s = String(r||'').toLowerCase();
    if (s.startsWith('hi')) return 'high';
    if (s.startsWith('me')) return 'med';
    return 'low';
  };

  // Upcoming-only, sorted
  const upcoming = (Array.isArray(window.alertsData) ? window.alertsData : [])
    .map(a => ({...a, _dt: parse(a.time ?? a.datetime ?? a.date ?? a.when), risk: normRisk(a.risk)}))
    .filter(a => a._dt && a._dt >= new Date())
    .sort((a,b)=> a._dt - b._dt);

  // Group by continent (supports Continent/continent keys)
  const byCont = new Map();
  upcoming.forEach(a => {
    const cont = (a.Continent ?? a.continent ?? '').trim();
    if (!cont) return;
    if (!byCont.has(cont)) byCont.set(cont, []);
    byCont.get(cont).push(a);
  });

  function blend(counts){
    const present = [];
    if (counts.high) present.push('high');
    if (counts.med)  present.push('med');
    if (counts.low)  present.push('low');
    if (present.length >= 3){
      const [r1,r2,r3] = present;
      return `linear-gradient(180deg, ${COLORS[r1]} 0% 33%, ${COLORS[r2]} 33% 66%, ${COLORS[r3]} 66% 100%)`;
    } else if (present.length === 2){
      const [r1,r2] = present;
      return `linear-gradient(180deg, ${COLORS[r1]} 0% 50%, ${COLORS[r2]} 50% 100%)`;
    }
    return COLORS[present[0] || 'low'];
  }

  continents.forEach(cont => {
    const rows = byCont.get(cont) || [];
    const counts = { low:0, med:0, high:0 };
    rows.forEach(r => counts[normRisk(r.risk)]++);

    const total = counts.low + counts.med + counts.high;

    const a = document.createElement("a");
    a.className = "cell";
    a.style.position = "relative";
    a.innerText = cont;
    a.style.background = total ? blend(counts) : COLORS.low;
    a.style.border = "1px solid #2e3238";
    a.href = `risk-detail.html?continent=${encodeURIComponent(cont)}`;
    a.title = total
      ? `${cont} — ${total} upcoming event${total!==1?'s':''}`
      : `${cont} — No upcoming data`;

    const badge = document.createElement("div");
    badge.textContent = total ? String(total) : "";
    badge.style.position = "absolute";
    badge.style.top = "4px";
    badge.style.right = "6px";
    badge.style.fontSize = "11px";
    badge.style.fontWeight = "700";
    badge.style.color = "#fff";
    badge.style.background = "rgba(0,0,0,0.4)";
    badge.style.border = "1px solid rgba(255,255,255,0.2)";
    badge.style.padding = "1px 5px";
    badge.style.borderRadius = "6px";

    a.appendChild(badge);
    grid.appendChild(a);
  });
})();
</script>



        </section>

        <section class="card" style="grid-column: span 7;">
          <h3>Notes / Analyst Scratchpad</h3>
          <p style="color:var(--muted);margin-top:6px">Use this space to capture hypotheses, route changes, risk factors, or requests from stakeholders.</p>
          <ul style="margin-top:4px">
            <li>Watch coach bookings for Edinburgh (threshold > 40 per hour).</li>
            <li>Check Leeds venue permits; verify separation plan for counter-protests.</li>
            <li>Flag any WhatsApp flyer variants for authenticity review.</li>
          </ul>
        </section>

<section class="card" style="grid-column: span 7;">
  <h3>Projections (next 14 days)</h3>
  <div id="proj14d" style="display:grid;grid-template-columns:1fr 1fr;gap:10px"></div>
  <small style="color:#8e97a3">Heuristic projection uses the last 14 days’ average per continent and risk.</small>
</section>

      </div>
    </main>
  </div>

  <!-- Active nav highlight -->
  <script>
    (function () {
      const here = location.pathname.split("/").pop() || "index.html";
      document.querySelectorAll("aside.sidebar nav a").forEach(a=>{
        if ((here === "" && a.getAttribute("href")==="index.html") || here === a.getAttribute("href")) {
          a.classList.add("active");
        }
      });
    })();
  </script>

  <!-- Real-Time Alerts: High risk only, one-line rows, auto-refresh -->
<script>
(function renderRealtimeHighRisk(){
  const box = document.getElementById('realtimeAlerts');
  if (!box) return;

  const parse = v => (window.CIHelpers && CIHelpers.parseWhenAny(v)) || (v ? new Date(v) : null);
  const normRisk = r => {
    const s = String(r||'').toLowerCase();
    if (s.startsWith('hi')) return 'high';
    if (s.startsWith('me')) return 'med';
    return 'low';
  };

  function render(){
    box.innerHTML = "";

    // Upcoming-only, sorted, with _dt
    const soon = (Array.isArray(window.alertsData) ? window.alertsData : [])
      .map(a => ({...a, _dt: parse(a.time ?? a.datetime ?? a.date ?? a.when), risk: normRisk(a.risk)}))
      .filter(a => a._dt && a._dt >= new Date())
      .sort((a,b)=> a._dt - b._dt);

    const high = soon.filter(a => a.risk === 'high').slice(0,5);

    if (!high.length) {
      box.innerHTML = `<p style="color:#8e97a3">No high-risk alerts available.</p>`;
      return;
    }

    high.forEach(a => {
      const pretty = a._dt
        ? a._dt.toLocaleString('en-GB',{ timeZone:'Europe/London', day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' })
        : '';

      const card = document.createElement('div');
      card.className = "alert";
      card.style.cursor = a.source ? "pointer" : "default";
      card.innerHTML = `
        <strong>${a.city || a.Country || ''} — ${a.title || ''}</strong>
        <div style="font-size:13px;color:#c9d1d9;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
          ${(a.summary||'').trim()}${pretty ? ` — ${pretty}` : ``}
        </div>
      `;
      if (a.source) card.addEventListener('click', ()=>window.open(a.source,'_blank','noopener'));
      box.appendChild(card);
    });
  }

  render();
  setInterval(render, 60000);
})();
</script>


  <!-- Upcoming Events with pill-style risk badges -->
  <script>
  (function renderUpcoming(){
    const tbody = document.getElementById('upcomingBody');
    if (!tbody) return;

    const parse = v => (window.CIHelpers && CIHelpers.parseWhenAny(v)) || null;

    const normRisk = (r='')=>{
      const s = r.toLowerCase();
      if (s.startsWith('hi')) return 'high';
      if (s.startsWith('me')) return 'med';
      return 'low';
    };

    const pillStyle = {
      high:'background:rgba(255,90,95,.15);color:#ff5a5f;border:1px solid rgba(255,90,95,.35)',
      med: 'background:rgba(240,180,41,.15);color:#f0b429;border:1px solid rgba(240,180,41,.35)',
      low: 'background:rgba(51,196,141,.15);color:#33c48d;border:1px solid rgba(51,196,141,.35)'
    };
    const makePill = (risk)=>{
      const r = normRisk(risk);
      const txt = r[0].toUpperCase()+r.slice(1);
      const st = pillStyle[r] || pillStyle.low;
      return `<span style="display:inline-block;padding:4px 10px;border-radius:999px;font-weight:700;${st}">${txt}</span>`;
    };

    const now = new Date();
    const data = Array.isArray(window.alertsData) ? window.alertsData : [];

    // Normalize rows
    const items = data.map(a=>{
      const raw = a.time ?? a.datetime ?? a.date ?? a.when ?? null;
      const _dt = parse(raw);
      return {...a, _dt, risk:normRisk(a.risk)};
    }).filter(a => a._dt && a._dt >= now)
      .sort((a,b)=> a._dt - b._dt);

    // De-dup
    const seen = new Set();
    const uniq = [];
    for (const it of items) {
      const iso = it._dt.toISOString().slice(0,16);
      const key = it.id
        ? `id|${it.id}`
        : (it.source ? `src|${it.source}` : `tcm|${it.title}|${it.city}|${iso}`);
      if (seen.has(key)) continue;
      seen.add(key);
      uniq.push(it);
    }

   const rows = CIFilter.upcoming(window.alertsData).slice(0,3);
    tbody.innerHTML = '';

    if (!rows.length) {
      tbody.innerHTML = `<tr><td colspan="4" style="color:#8e97a3;padding:10px">No upcoming events.</td></tr>`;
      return;
    }

    rows.forEach(i=>{
      const pretty = i._dt.toLocaleString('en-GB',{
        timeZone:'Europe/London',
        day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit'
      });
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i.title || ''}</td>
        <td>${(i.city || '').split('/')[0].trim()}</td>
        <td>${pretty}</td>
        <td>${makePill(i.risk)}</td>
      `;
      if (i.source) {
        tr.style.cursor = 'pointer';
        tr.addEventListener('click', ()=>window.open(i.source,'_blank','noopener'));
      }
      tbody.appendChild(tr);
    });
  })();
  </script>

  <script>
  // TEMP: debug table inputs
  (function debugUpcoming(){
    const now = new Date();
    const data = Array.isArray(window.alertsData) ? window.alertsData : [];
    const rows = data.map(a=>{
      const raw = a.time ?? a.datetime ?? a.date ?? a.when ?? null;
      const dt = window.CIHelpers.parseWhenAny(raw);
      return {title:a.title, city:a.city, country:a.country, risk:a.risk, raw, iso: dt?dt.toISOString():'', future: !!(dt && dt>=now)};
    }).filter(x=>x.future)
      .sort((a,b)=> a.iso.localeCompare(b.iso))
      .slice(0,4);
    console.table(rows);
  })();
  </script>


<script>
(function mountActive24hKPI(){
  // Helper: robust timestamp parse (uses your global helper if present)
  const parse = v => (window.CIHelpers && CIHelpers.parseWhenAny(v)) || (v ? new Date(v) : null);

  // Count events in a time window [start, end]
  function countInWindow(data, start, end, {includePredictive=false}={}){
    let n = 0;
    for (const a of data || []) {
      if (!includePredictive && a.predictive === true) continue;
      const dt = parse(a.time ?? a.datetime ?? a.date ?? a.when);
      if (!dt) continue;
      if (dt >= start && dt <= end) n++;
    }
    return n;
  }

  function render(){
    const elVal   = document.getElementById('kpi-active-24h');
    const elDelta = document.getElementById('kpi-active-24h-delta');
    if (!elVal) return;

    const data = Array.isArray(window.alertsData) ? window.alertsData : [];

    const now  = new Date();
    const t0   = new Date(now.getTime() - 24*60*60*1000);      // last 24h window start
    const p0   = new Date(t0.getTime() - 24*60*60*1000);       // previous 24h window start

    // change includePredictive to true if you want to count predictive entries
    const opts = { includePredictive: false };

    const curr = countInWindow(data, t0, now, opts);
    const prev = countInWindow(data, p0, t0,  opts);

    // Update number
    elVal.textContent = curr;

    // Optional delta if the element exists
    if (elDelta) {
      if (prev === 0) {
        elDelta.style.display = 'none';
      } else {
        const diff = curr - prev;
        const pct  = Math.round((diff / prev) * 100);
        elDelta.textContent = (diff >= 0 ? `+${pct}%` : `${pct}%`);
        elDelta.className = 'delta ' + (diff >= 0 ? 'up' : 'down');
        elDelta.style.display = '';
      }
    }
  }

  // Initial render + refresh every 600s
  render();
  setInterval(render, 600000);
})();
</script>


<script>
(function mountUpcoming7dKPI(){
  // Robust parse (uses your helper if present)
  const parse = v => (window.CIHelpers && CIHelpers.parseWhenAny(v)) || (v ? new Date(v) : null);

  // Count events in window (start < dt <= end) — future-facing
  function countInWindow(data, start, end, {includePredictive=false}={}){
    let n = 0;
    for (const a of data || []) {
      if (!includePredictive && a.predictive === true) continue;
      const dt = parse(a.time ?? a.datetime ?? a.date ?? a.when);
      if (!dt) continue;
      if (dt > start && dt <= end) n++;
    }
    return n;
  }

  function render(){
    const elVal   = document.getElementById('kpi-upcoming-7d');
    const elDelta = document.getElementById('kpi-upcoming-7d-delta');
    if (!elVal) return;

    const data = Array.isArray(window.alertsData) ? window.alertsData : [];

    const now   = new Date();
    const next7 = new Date(now.getTime() + 7*24*60*60*1000);   // end of forward window
    const prev0 = new Date(now.getTime() - 7*24*60*60*1000);   // start of backward window

    // Change to true if you want to include predictive entries
    const opts = { includePredictive: false };

    // Current = next 7 days; Previous = the 7 days before now (for trend context)
    const curr = countInWindow(data, now, next7, opts);
    const prev = countInWindow(data, prev0, now,  opts);

    elVal.textContent = curr;

    if (elDelta) {
      if (prev === 0) {
        elDelta.style.display = 'none';
      } else {
        const diff = curr - prev;
        const pct  = Math.round((diff / prev) * 100);
        elDelta.textContent = (diff >= 0 ? `+${pct}%` : `${pct}%`);
        elDelta.className = 'delta ' + (diff >= 0 ? 'up' : 'down');
        elDelta.style.display = '';
      }
    }
  }

  // Initial + refresh every 600s
  render();
  setInterval(render, 600000);
})();
</script>


<script>
(function mountHighRiskKPI(){
  const parse = v => (window.CIHelpers && CIHelpers.parseWhenAny(v)) || (v ? new Date(v) : null);
  const isHigh = r => String(r||'').toLowerCase().startsWith('hi');

  function countHighInWindow(data, start, end, {includePredictive=false}={}) {
    let n = 0;
    for (const a of data || []) {
      if (!includePredictive && a.predictive === true) continue;
      const dt = parse(a.time ?? a.datetime ?? a.date ?? a.when);
      if (!dt) continue;
      if (dt > start && dt <= end && isHigh(a.risk)) n++;
    }
    return n;
  }

  function render(){
    const elVal   = document.getElementById('kpi-high-risk');
    const elDelta = document.getElementById('kpi-high-risk-delta');
    if (!elVal) return;

    const data = Array.isArray(window.alertsData) ? window.alertsData : [];

    const now    = new Date();
    const next7  = new Date(now.getTime() + 7*24*60*60*1000);
    const prev0  = new Date(now.getTime() - 7*24*60*60*1000);

    const opts = { includePredictive: false };

    const curr = countHighInWindow(data, now,  next7, opts);
    const prev = countHighInWindow(data, prev0, now,  opts);

    // Always keep the number red
    elVal.textContent = curr;
    elVal.style.color = 'var(--danger)';

    if (elDelta) {
      if (prev === 0) {
        elDelta.style.display = 'none';
      } else {
        const diff = curr - prev;
        const pct  = Math.round((diff / prev) * 100);
        elDelta.textContent = (diff >= 0 ? `+${pct}%` : `${pct}%`);
        elDelta.className = 'delta ' + (diff >= 0 ? 'up' : 'down');
        elDelta.style.display = '';
      }
    }
  }

  render();
  setInterval(render, 600000); // refresh every 10 minute
})();
</script>

<script src="auth.js"></script>

<script>
(function mountTopActions(){
  function host(){ return document.getElementById('topActions'); }

  function render(){
    const el = host();
    if (!el) return;

    // If auth lib isn't ready yet, try again shortly
    if (!window.CIAuth){ el.innerHTML = ''; return; }

    if (CIAuth.isLoggedIn()){
      const u = CIAuth.who();
      const initials = (u.name||'CI').split(/\s+/).slice(0,2).map(s=>s[0]?.toUpperCase()||'').join('') || 'CI';
      const role = u.role || 'Analyst';
      el.innerHTML = `
        <div class="user" id="userChip" style="display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;background:#1c1e22;border:1px solid #2e3238;cursor:pointer">
          <div class="avatar" style="width:28px;height:28px;background:#fff;color:#000;border-radius:50%;display:grid;place-items:center;font-weight:700">${initials}</div>
          ${role}
        </div>
        <div class="dropdown" id="userMenu" style="position:absolute;right:0;top:calc(100% + 6px);background:#1a1c20;border:1px solid #2e3238;border-radius:10px;padding:6px 0;box-shadow:0 4px 12px rgba(0,0,0,.4);display:none;min-width:160px;z-index:50">
          <a href="settings.html" style="display:block;padding:8px 12px;color:#e9edf2;text-decoration:none;font-size:14px">Settings</a>
          <a href="profile.html" style="display:block;padding:8px 12px;color:#e9edf2;text-decoration:none;font-size:14px">Profile</a>
          <a href="#" id="logoutLink" style="display:block;padding:8px 12px;color:#e9edf2;text-decoration:none;font-size:14px">Log out</a>
        </div>
      `;

      const chip = document.getElementById('userChip');
      const menu = document.getElementById('userMenu');
      chip.addEventListener('click', ()=> menu.style.display = (menu.style.display==='block'?'none':'block'));
      document.addEventListener('click', e => { if (!el.contains(e.target)) menu.style.display='none'; });
      document.getElementById('logoutLink').addEventListener('click', e=>{
        e.preventDefault();
        CIAuth.logout();
        // Emit and update UI
        window.dispatchEvent(new Event('ci:auth:logout'));
        render();
      });

    } else {
      const here = location.pathname.split('/').pop() || 'index.html';
      const next = encodeURIComponent(here + location.search + location.hash);
      el.innerHTML = `<a class="login-btn" href="login.html?next=${next}">Log in</a>`;
    }
  }

  // First paint
  document.addEventListener('DOMContentLoaded', render);

  // React to auth changes & cross-tab updates
  window.addEventListener('ci:auth:login', render);
  window.addEventListener('ci:auth:logout', render);
  window.addEventListener('storage', (e)=>{
    if (['ci_user','ci_token'].includes(e.key)) render();
  });

  // Small fallback to catch race with auth.js
  let tries = 10;
  const t = setInterval(()=>{
    if (--tries <= 0) clearInterval(t);
    render();
  }, 300);
})();
</script>
	
<script src="admin-links.js"></script>


<script>
(function projections14d(){
  const host = document.getElementById('proj14d');
  if (!host || !window.alertsData) return;

  const TZ = 'Europe/London';
  const parseTime = v => {
    const d = new Date(v);
    return isNaN(d) ? null : d;
  };

  const now = new Date();
  const start = new Date(+now - 14*864e5);

  // Aggregate by continent + risk for last 14 days
  const agg = {}; // { [continent]: { low:n, medium:n, high:n, total:n } }
  (alertsData||[]).forEach(a=>{
    const dt = parseTime(a.time);
    if (!dt || dt < start || dt > now) return;
    const cont = (a.continent || a.Continent || 'Unknown').trim();
    const r = String(a.risk||'').toLowerCase().startsWith('hi') ? 'high'
            : String(a.risk||'').toLowerCase().startsWith('me') ? 'medium'
            : 'low';
    if (!agg[cont]) agg[cont] = {low:0, medium:0, high:0, total:0};
    agg[cont][r]++; agg[cont].total++;
  });

  // Projection = average per day * 14, per continent/risk
  const out = Object.entries(agg).map(([cont, row])=>{
    const factor = 14 / 14; // trivial, kept for future weighting
    return {
      continent: cont,
      low: Math.round((row.low/14)*14*factor),
      medium: Math.round((row.medium/14)*14*factor),
      high: Math.round((row.high/14)*14*factor),
      total: Math.round((row.total/14)*14*factor)
    };
  }).sort((a,b)=> b.total - a.total);

  // Render
  host.innerHTML = '';
  out.forEach(x=>{
    const card = document.createElement('div');
    card.style.border = '1px solid var(--brand-gray-600)';
    card.style.borderRadius = '12px';
    card.style.padding = '10px 12px';
    card.style.background = 'linear-gradient(180deg,#1a1c20,#131417)';

    card.innerHTML = `
      <div style="font-weight:800;margin-bottom:6px">${x.continent}</div>
      <div style="display:flex;gap:10px;align-items:center">
        <span style="display:inline-block;padding:3px 8px;border-radius:999px;background:rgba(255,90,95,.15);color:#ff5a5f;border:1px solid rgba(255,90,95,.35);font-weight:700">High ${x.high}</span>
        <span style="display:inline-block;padding:3px 8px;border-radius:999px;background:rgba(240,180,41,.15);color:#f0b429;border:1px solid rgba(240,180,41,.35);font-weight:700">Med ${x.medium}</span>
        <span style="display:inline-block;padding:3px 8px;border-radius:999px;background:rgba(51,196,141,.15);color:#33c48d;border:1px solid rgba(51,196,141,.35);font-weight:700">Low ${x.low}</span>
        <span style="margin-left:auto;color:#cfd6e1">Total <b>${x.total}</b></span>
      </div>
    `;
    host.appendChild(card);
  });

  if (!out.length){
    host.innerHTML = `<div style="color:#8e97a3">Insufficient recent data to project.</div>`;
  }
})();
</script>





<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
<script src="https://unpkg.com/topojson-client@3"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
/* ===============================
   Global Protest Risk Map (Leaflet)
   Expects:
     - window.alertsData = [{title, city, Country, Continent, risk, time, summary, predictive?}]
     - world countries GeoJSON at: /assets/geo/world-countries.geojson
   =============================== */

(function(){
  const MAP_EL = 'riskMap';
  const TOPO_URL = "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json";
  const palette = { low:'#6bcf6b', medium:'#f0b429', high:'#ff5a5f', none:'#2e3238' };
  const riskScore = {low:1, medium:2, high:3};

  const now = new Date();
  let windowDays = 30;
  let includePredictive = false;

  const norm = s => (s||'').trim().toLowerCase();
  const alias = new Map([
    ['england','united kingdom'],['scotland','united kingdom'],['wales','united kingdom'],
    ['czech republic','czechia'],['vatican city','holy see'],
  ]);

  function emitCountrySelected(name, items){
    try {
      window.dispatchEvent(new CustomEvent('ci:countrySelected', { detail: { country: name, items } }));
    } catch(e) { console.warn('countrySelected event error', e); }
  }

  // Map init
  const map = L.map(MAP_EL, { scrollWheelZoom:true, worldCopyJump:true }).setView([18, 10], 2);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);

  L.Control.geocoder({ defaultMarkGeocode: false, placeholder: 'Search country…' })
    .on('markgeocode', e => { if (e?.geocode?.bbox) map.fitBounds(e.geocode.bbox); })
    .addTo(map);

  // Control bar
  const RiskCtl = L.Control.extend({
    onAdd: function(){
      const wrap = L.DomUtil.create('div', 'riskctl');
      wrap.innerHTML = `
        <div><b>Window:</b> <span id="wval">${windowDays}</span> days</div>
        <input id="wslider" type="range" min="7" max="120" step="1" value="${windowDays}">
        <label><input id="togglePred" type="checkbox"> Include predictive entries</label>
      `;
      L.DomEvent.disableClickPropagation(wrap);
      return wrap;
    }
  });
  map.addControl(new RiskCtl({ position:'topright' }));

  // Legend
  const Legend = L.Control.extend({
    onAdd: function(){
      const d = L.DomUtil.create('div','risklegend');
      d.innerHTML = `
        <div><span class="chip" style="background:${palette.low}"></span>Low</div>
        <div><span class="chip" style="background:${palette.medium}"></span>Medium</div>
        <div><span class="chip" style="background:${palette.high}"></span>High</div>
        <div style="margin-top:6px;border-top:1px solid #2e3238;padding-top:6px;">Dashed outline = mixed risk</div>
      `;
      return d;
    }
  });
  map.addControl(new Legend({position:'bottomright'}));

  let geoLayer = null;

  function aggregate(alerts){
    const end = new Date(+now + windowDays*86400000);
    const by = {};
    for(const a of alerts || []){
      if(!a || !a.country || !a.time) continue;
      if(!includePredictive && a.predictive === true) continue;

      const t = new Date(a.time);
      if(t < now || t > end) continue;

      let country = a.Country;
      const n = alias.get(norm(country));
      if(n) country = n.replace(/\b\w/g,m=>m.toUpperCase());

      const rk = norm(a.risk);
      const score = rk.startsWith('hi') ? 3 : rk.startsWith('me') ? 2 : 1;

      if(!by[country]) by[country] = {max:0, counts:{low:0, medium:0, high:0}, items:[]};
      by[country].max = Math.max(by[country].max, score);
      if(rk.startsWith('hi')) by[country].counts.high++;
      else if(rk.startsWith('me')) by[country].counts.medium++;
      else by[country].counts.low++;
      by[country].items.push(a);
    }
    for(const k in by){
      const c = by[k].counts;
      by[k].mix = ((c.high>0 && c.low>0) || (c.medium>0 && c.high>0) || (c.medium>0 && c.low>0));
    }
    return by;
  }

  function draw(){
    fetch(TOPO_URL).then(r=>r.json()).then(topology=>{
      const geo = topojson.feature(topology, topology.objects.countries);
      geo.features.forEach(f=>{
        const n = f.properties.name || f.properties.NAME || "";
        f.properties.ADMIN = n;
      });

      const alerts = window.alertsData || [];
      const agg = aggregate(alerts);

      if(geoLayer) geoLayer.remove();
      geoLayer = L.geoJSON(geo, {
        style: f => {
          const name = (f.properties.ADMIN || f.properties.NAME || '').trim();
          const row  = agg[name];
          if(!row) return { fillColor: palette.none, fillOpacity:.25, color:'#111', weight:.6 };
          const col = row.max===3? palette.high : row.max===2? palette.medium : palette.low;
          return {
            fillColor: col, fillOpacity:.85,
            color: row.mix ? '#ffffff' : '#111',
            dashArray: row.mix ? '6 3' : null,
            weight: row.mix ? 1.2 : .6
          };
        },
        onEachFeature: (f, layer) => {
          const name = (f.properties.ADMIN || f.properties.NAME || '').trim();
          const row = agg[name];
          const tot = row? (row.counts.low + row.counts.medium + row.counts.high) : 0;
          const chips = row ? `
            <span class="chip" style="background:${palette.high}"></span>${row.counts.high}
            <span class="chip" style="background:${palette.medium}"></span>${row.counts.medium}
            <span class="chip" style="background:${palette.low}"></span>${row.counts.low}
          ` : 'No events';
          layer.bindPopup(`<b>${name}</b><br>${tot} event(s) in next ${windowDays} days<br>${chips}`);
          layer.on('click', ()=>{
            const items = (row && row.items) ? row.items.slice().sort((a,b)=>new Date(a.time)-new Date(b.time)) : [];
            emitCountrySelected(name, items);
          });
        }
      }).addTo(map);
    });
  }

  // Wire controls -> redraw
  document.addEventListener('change', e=>{
    if(e.target && e.target.id==='togglePred'){
      includePredictive = e.target.checked;
      draw();
    }
  });
  document.addEventListener('input', e=>{
    if(e.target && e.target.id==='wslider'){
      windowDays = parseInt(e.target.value,10);
      const wval = document.getElementById('wval');
      if (wval) wval.textContent = windowDays;
      draw();
    }
  });

  // initial draw
  draw();
})();
</script>

</body>
</html>



















