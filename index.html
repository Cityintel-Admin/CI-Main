<!doctype html>
<html lang="en">
<head>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">
<style>
  /* Risk map container */
  #riskMap { height: 460px; border-radius: 14px; overflow: hidden; }
  /* Control bar */
  .riskctl {
    background: rgba(22,23,26,.95);
    color: #e9edf2;
    border: 1px solid #2e3238;
    border-radius: 12px;
    padding: 10px 12px;
    font: 13px/1.4 system-ui;
    display: grid; gap: 8px;
  }
  .riskctl label { display:flex; align-items:center; gap:10px; }
  .risklegend {
    background: rgba(22,23,26,.95);
    color:#e9edf2; border:1px solid #2e3238; border-radius:12px; padding:8px 10px; font:12px system-ui;
  }
  .chip{display:inline-block;width:10px;height:10px;border-radius:2px;margin-right:6px}
</style>

  <meta charset="utf-8" />
  <title>CityIntel ‚Äî Situational Intelligence Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="icon" href="./CityintLogo.jpg">
  <meta property="og:title" content="CityIntel ‚Äì Situational Intelligence" />
  <meta property="og:description" content="Live alerts, upcoming events, and risk visualization." />
  <meta property="og:image" content="./assets/og-preview.jpg" />
  <meta name="twitter:card" content="summary_large_image" />

  <style>
/* ===== CityIntel theme + components ===== */
:root{
  --brand-red:#D01616; --brand-black:#0C0C0C;
  --brand-gray-900:#111214; --brand-gray-800:#16171a; --brand-gray-700:#1c1e22;
  --brand-gray-600:#24272c; --brand-gray-500:#2e3238;
  --muted:#8e97a3; --text:#e9edf2; --ok:#33c48d; --warn:#f0b429; --danger:#ff5a5f;
  --card-radius:16px; --shadow:0 8px 24px rgba(0,0,0,0.35);
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0; background:linear-gradient(180deg,var(--brand-gray-900),var(--brand-gray-800));
  color:var(--text); font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
}

/* Layout */
.app{
  display:grid; grid-template-columns:260px 1fr; grid-template-rows:60px auto 1fr;
  grid-template-areas:"sidebar topbar" "sidebar banner" "sidebar main"; min-height:100vh;
}
.sidebar{
  grid-area:sidebar; background:linear-gradient(180deg,var(--brand-black),#131416);
  border-right:1px solid var(--brand-gray-600); display:flex; flex-direction:column; padding:18px 14px; gap:18px;
}
.brand{display:flex;align-items:center;gap:10px; padding:8px 10px; border-radius:12px;
  background:linear-gradient(90deg,rgba(208,22,22,0.2),rgba(208,22,22,0));}
.brand img{width:34px;height:34px;object-fit:contain;border-radius:6px;background:#fff}
.brand .title{font-weight:700;letter-spacing:.3px}
nav a{display:flex;align-items:center;gap:10px;color:#e9edf2;text-decoration:none;
  padding:10px 12px;border-radius:10px;border:1px solid transparent}
nav a:hover{background:#24272c;border-color:#2e3238}
nav a.active{background:rgba(208,22,22,0.15);border-color:#D01616}

.topbar{
  grid-area:topbar;background:rgba(255,255,255,0.02);border-bottom:1px solid var(--brand-gray-600);
  display:flex;align-items:center;gap:12px;padding:10px 16px;position:sticky;top:0;z-index:10;backdrop-filter:blur(8px)
}
.search{flex:1;display:flex;align-items:center;gap:10px;background:var(--brand-gray-700);
  border:1px solid var(--brand-gray-600);border-radius:12px;padding:8px 12px}
.search input{flex:1;background:transparent;border:none;outline:none;color:var(--text)}
.pill{padding:8px 12px;border-radius:999px;background:var(--brand-red);color:#fff;font-weight:600;border:1px solid #9c0f0f}
.user{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;background:var(--brand-gray-700);border:1px solid var(--brand-gray-600)}
.avatar{width:28px;height:28px;background:#fff;color:#000;border-radius:50%;display:grid;place-items:center;font-weight:700}

.main{grid-area:main;padding:18px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}

/* Cards */
.card{background:linear-gradient(180deg,#1a1c20,#131417);border:1px solid var(--brand-gray-600);
  border-radius:var(--card-radius);box-shadow:var(--shadow);padding:16px}
.card h3{margin:0 0 10px 0;font-size:16px;letter-spacing:.2px}
.metric{display:flex;align-items:baseline;gap:10px}
.metric .value{font-size:28px;font-weight:800}
.metric .delta{font-size:12px;padding:2px 8px;border-radius:999px}
.delta.up{background:rgba(51,196,141,.15);color:var(--ok);border:1px solid rgba(51,196,141,.35)}
.delta.down{background:rgba(255,90,95,.15);color:var(--danger);border:1px solid rgba(255,90,95,.35)}


/* ===== Today's Protests Banner ===== */
.banner{
  grid-area: banner;
  margin: 6px 0 10px 0;
  padding: 0 16px;
  border:1px solid var(--brand-gray-600);
  border-top: 1px solid var(--brand-gray-600);
  border-radius:12px;
  background:linear-gradient(90deg, rgba(208,22,22,0.2), rgba(208,22,22,0));
  overflow:hidden;
  z-index: 9;
}

.ticker{position:relative;overflow:hidden;white-space:nowrap;
}

.ticker-track{display:flex;gap:2rem;                      /* space between items */
  will-change: transform; animation: tickerLinear var(--ticker-duration, 110s) linear infinite;
  animation-fill-mode: both; animation-name:tickerLinear;
  animation-delay:0s;
  animation-play-state: running
}

.ticker-track > span{display:flex;gap:2rem;padding:10px 14px;
}

.ticker-track:hover { animation-play-state: paused; }

@media (prefers-reduced-motion: reduce){.ticker-track { animation: none !important; }
}

@keyframes tickerLinear {from { transform: translateX(0); } to { transform: translateX(calc(-1*var(--loop-distance,1000px))); }
}

.banner strong {color: #ff5a5f;margin-right: 4px;}



.cell div {backdrop-filter: blur(4px); text-shadow: 0 1px 2px rgba(0,0,0,0.4);}


/* Table */
table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:12px}
thead th{text-align:left;font-size:12px;color:var(--muted);background:var(--brand-gray-700);padding:10px;border-bottom:1px solid var(--brand-gray-600)}
tbody td{padding:12px 10px;border-bottom:1px solid var(--brand-gray-600)}
tr:hover td{background:rgba(255,255,255,0.02)}

/* Alerts list (red left column look) */
.alert{
  border:1px solid var(--brand-gray-600);
  border-left:4px solid var(--brand-red);
  background:linear-gradient(90deg,rgba(208,22,22,.1),rgba(208,22,22,0));
  padding:12px;border-radius:12px;margin-bottom:10px;
}
.alert small{color:var(--muted)}

/* Heatmap */
.heatmap{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:10px}
#risk-heatmap {
  display: flex;
  justify-content: space-evenly;   /* evenly distribute the continents */
  align-items: center;             /* vertically center cells */
  flex-wrap: nowrap;               /* keep in one row */
  gap: 12px;                       /* consistent spacing between cells */
  margin-top: 10px;
}

.cell{width:60px;height:60px;border-radius:6px;border:1px solid #2e3238;display:flex;align-items:flex-end;justify-content:center;font-size:11px;font-weight:600;color:#e9edf2;text-align:center;padding:4px}

#risk-heatmap .cell {
  width: 100px;                    /* same width for all */
  height: 70px;                    /* slightly taller for readability */
  display: flex;
  align-items: flex-end;
  justify-content: center;
  border-radius: 8px;
  font-weight: 600;
  text-align: center;
  position: relative;
}


/* ==== Geocoder (search) control ‚Äì CityIntel dark theme ==== */
.leaflet-control-geocoder {
  background: rgba(22,23,26,.95);
  border-radius: 12px;
  border: 1px solid #2e3238;
  color: #e9edf2;
  box-shadow: var(--shadow);
  padding: 6px 8px;
  min-width: 260px;          /* wider box */
}

.leaflet-control-geocoder-expanded {
  min-width: 260px;          /* keep width when expanded */
}

.leaflet-control-geocoder-form {
  display: flex;
  align-items: center;
  gap: 6px;
}

.leaflet-control-geocoder-icon {
  width: 18px;
  height: 18px;
  background: none;          /* remove black square */
  border: none;
  box-shadow: none;
  margin: 0;
  padding: 0;
  filter: invert(1);         /* white icon on dark bg */
}

.leaflet-control-geocoder input {
  flex: 1;
  padding: 4px 8px;
  border-radius: 8px;
  border: 1px solid #2e3238;
  background: #111214;
  color: #e9edf2;
  font-size: 13px;
}

.leaflet-control-geocoder input::placeholder {
  color: #8e97a3;
}

.leaflet-control-geocoder .leaflet-control-geocoder-alternatives {
  background: #1a1c20;
  border-radius: 8px;
  border: 1px solid #2e3238;
}

.leaflet-control-geocoder .leaflet-control-geocoder-alternatives li {
  padding: 4px 8px;
}

.leaflet-control-geocoder .leaflet-control-geocoder-alternatives li:hover {
  background: rgba(255,255,255,0.05);
}

/* Map card header layout */
.map-card-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-bottom:8px;
}

.map-card-header h3{
  margin:0;
}

/* Right-hand side toolbar */
.map-toolbar{
  display:flex;
  align-items:center;
  gap:12px;
  flex-wrap:wrap;
  justify-content:flex-end;
}

/* Search input styling */
#mapSearchInput{
  min-width:230px;
  max-width:280px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--brand-gray-600);
  background:var(--brand-gray-700);
  color:var(--text);
  font-size:13px;
}
#mapSearchInput::placeholder{
  color:#8e97a3;
}

/* Window slider + predictive */
.map-window-ctl{
  display:flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:12px;
  background:rgba(22,23,26,.95);
  border:1px solid var(--brand-gray-600);
  font-size:13px;
}

.map-window-ctl span{
  white-space:nowrap;
}

.map-window-ctl input[type="range"]{
  width:130px;
}

.map-pred-toggle{
  display:flex;
  align-items:center;
  gap:4px;
  font-size:12px;
}



	  
.lv1{background:#20312b} .lv3{background:#473a23} .lv4{background:#5c2b2b}
.cell:hover{outline:2px solid #D01616;cursor:pointer}

/* Keep Real-Time Alerts compact */
#realtimeAlerts{max-height:220px;overflow-y:auto}

/* Responsive */
@media (max-width:1100px){.app{grid-template-columns:68px 1fr}.brand .title,nav span{display:none}.sidebar{padding:14px 10px}}
@media (max-width:880px){.grid{grid-template-columns:1fr}}

.login-btn {
  display:inline-block;
  padding:8px 12px;
  border-radius:999px;
  background:#D01616;
  border:1px solid #9c0f0f;
  color:#fff;
  font-weight:700;
  text-decoration:none;
  white-space:nowrap;
}
.login-btn:hover { filter:brightness(1.05); }

.user { display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:12px; background:var(--brand-gray-700); border:1px solid var(--brand-gray-600); cursor:pointer; }
.avatar { width:28px;height:28px; background:#fff;color:#000;border-radius:50%; display:grid;place-items:center;font-weight:700; }

.dropdown {
  position:absolute; right:0; top:calc(100% + 6px);
  background:#1a1c20; border:1px solid var(--brand-gray-600); border-radius:10px;
  padding:6px 0; box-shadow:0 4px 12px rgba(0,0,0,0.4);
  display:none; min-width:140px; z-index:50;
}
.dropdown a { display:block; padding:8px 12px; color:var(--text); text-decoration:none; font-size:14px; }
.dropdown a:hover { background:rgba(255,255,255,0.05); }



/* ===== Map markers: assets & travellers ===== */
.ci-marker{ width: 24px; height: 24px; border-radius: 999px; display: flex; align-items: center;
  justify-content: center; font-size: 12px; font-weight: 700; box-shadow: 0 0 0 2px rgba(0,0,0,0.7);
  background: #1a1c20; color: #e9edf2;}

.ci-marker-asset{ border: 2px solid #4f8bff; background: rgba(79,139,255,0.25);}

.ci-marker-traveller{ border: 2px solid #f0b429; background: rgba(240,180,41,0.25);}

.ci-marker span{ pointer-events: none;   /* so clicks go to the marker */}



	  
/* ===== Mobile layout tweaks ===== */
@media (max-width: 720px) {
  /* Stack layout: topbar, sidebar row, then main content */
  .app{
    grid-template-columns: 1fr;
    grid-template-rows: auto auto 1fr;
    grid-template-areas:
      "topbar"
      "sidebar"
      "main";
  }

  .sidebar{
    border-right: none;
    border-top: 1px solid var(--brand-gray-600);
    flex-direction: row;
    align-items: center;
    gap: 8px;
    padding: 8px;
    overflow-x: auto;
    white-space: nowrap;
  }

  .sidebar nav{
    display: flex;
    flex-wrap: nowrap;
    gap: 8px;
  }

  .sidebar nav a{
    font-size: 12px;
    padding: 6px 10px;
    white-space: nowrap;
  }

  .brand{
    flex-shrink: 0;
  }

  .main{
    padding: 10px;
  }

  .card{
    padding: 12px;
  }

  /* Map + heatmap sizing on small screens */
  #riskMap{
    height: 320px;
  }

  #risk-heatmap .cell{
    width: 72px;
    height: 52px;
    font-size: 10px;
  }

  /* Map toolbar (search + window slider) stack nicely */
  .risk-toolbar{
    flex-direction: column;
    align-items: stretch;
    gap: 6px;
  }
}
 
	  
  </style>
<style id="ci-panic-banner-css">
  /* Panic banner (injected) */
  #ciPanicBanner{
    position:fixed; top:0; left:0; right:0;
    z-index:9999;
    background: rgba(80, 15, 18, 0.92);
    border-bottom: 1px solid rgba(255,255,255,0.08);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  #ciPanicBanner .ci-inner{
    display:flex; align-items:center; justify-content:center;
    gap:14px;
    padding:10px 14px;
  }
  #ciPanicBanner .ci-left, #ciPanicBanner .ci-right{ flex:0 0 auto; display:flex; align-items:center; gap:10px; }
  #ciPanicBanner .ci-center{ flex:1 1 auto; display:flex; justify-content:center; align-items:center; gap:12px; text-align:center; min-width: 0; }
  #ciPanicBanner .ci-badge{
    font-weight:800; letter-spacing:.02em; text-transform:uppercase;
    padding:6px 10px; border-radius:999px;
    background: rgba(220, 38, 38, 0.18);
    border: 1px solid rgba(220, 38, 38, 0.35);
  }
  #ciPanicBanner .ci-badge.ci-pulse{
    animation: ciPanicPulse 1.2s ease-in-out infinite;
  }
  @keyframes ciPanicPulse{
    0%,100%{ transform: scale(1); filter: brightness(1); }
    50%{ transform: scale(1.04); filter: brightness(1.15); }
  }
  #ciPanicBanner .ci-meta{
    opacity:.9; font-size:13px; white-space:normal; overflow:hidden; text-overflow:ellipsis;
    max-width: 60vw;
  }
  #ciPanicBanner a{ color: inherit; text-decoration: underline; }
  #ciPanicBanner button{
    cursor:pointer;
    border: 1px solid rgba(255,255,255,0.18);
    background: rgba(20,20,20,0.35);
    color: #fff;
    border-radius: 999px;
    padding: 6px 10px;
    font-weight: 600;
  }
  body.ci-has-panic-banner{ padding-top: 46px; }
</style>
</head>
<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">
        <img src="CityintLogo.jpg" alt="CityIntel Logo" />
        <div class="title">CityIntel</div>
      </div>
      <div class="section-label"></div>
      <nav>
        <a href="index.html" class="active">Dashboard</a>
		<a href="Dmck.html">Dale start here</a>
		<a href="assets.html">Assets</a>
		<a href="travellers.html">Travellers</a>
        <a href="alerts.html">Alerts</a>
        <a href="events.html">Events</a>
		<a href="live-feed.html">Live Feed</a>
		<a href="test.html">Test Feed</a>  
	<a href="brief.html">Intelligence Brief</a>
	<a href="trends.html">Trends & Forecasts</a>
        <a href="reports.html">Reports</a>
		<a href="sources.html">Sources</a>
        <a href="settings.html">Settings</a>
        <a href="about.html">About</a>
      </nav>
    </aside>

    <!-- TOPBAR -->
    <header class="topbar">
      <div class="search">üîé <input placeholder="Search events, locations, groups‚Ä¶" /></div>
      <div id="topActions" style="position:relative"></div>
    </header>


<div class="banner" id="ci-banner">
  <div class="ticker">
    <div class="ticker-track" id="tickerTrack">
      <!-- JS will inject two identical <span> blocks -->
    </div>
  </div>
</div>




    <!-- MAIN -->
    <main class="main">

      <div class="grid">
        <!-- KPIs -->

        <section class="card" style="grid-column: span 3;">
          <h3>Active Protests (24h)</h3>
          <div class="metric">    
          <div class="value" id="kpi-active-24h">0</div>
          <div class="delta" id="kpi-active-24h-delta" style="display:none"></div>
  </div>
  <small style="color:var(--muted)">Across tracked sources</small>
</section>

        <section class="card" style="grid-column: span 3;">
          <h3>Upcoming (7 days)</h3>
  <div class="metric">
    <div class="value" id="kpi-upcoming-7d">0</div>
    <div class="delta" id="kpi-upcoming-7d-delta" style="display:none"></div>
  </div>
  <small style="color:var(--muted)">Based on tracked sources</small>
</section>

        <section class="card" style="grid-column: span 3;">
          <h3>High Risk Protests / Events</h3>
          <div class="metric">
          <div class="value" id="kpi-high-risk" style="color:var(--danger)">0</div>
          <div class="delta" id="kpi-high-risk-delta" style="display:none"></div>
          </div>
  <small style="color:var(--muted)">Crowd + Counter-presence</small>
</section>

        <section class="card" style="grid-column: span 3;">
          <h3>Data Freshness</h3>
          <div class="metric"><div class="value">96%</div><div class="delta up">+4%</div></div>
          <small style="color:var(--muted)">Last ingest: 10 mins ago</small>
        </section>


        <!-- Left: Real-Time Alerts (now data-driven) -->
        <section class="card" style="grid-column: span 5;">
          <h3>High Risk Events</h3>
          <div id="realtimeAlerts"></div>
        </section>

        <!-- Right: Upcoming Events (data-driven) -->
        <section class="card" style="grid-column: span 7;">
          <h3>Upcoming Events</h3>
          <table>
            <thead>
              <tr>
                <th>Event</th>
                <th>City</th>
                <th>Date</th>
                <th>Risk</th>
              </tr>
            </thead>
            <tbody id="upcomingBody"></tbody>
          </table>
        </section>

        <!-- Bottom row -->
        <section class="card" style="grid-column: span 12;">
          <h3>Risk Heatmap</h3>
          <div id="risk-heatmap" class="heatmap"></div>
          <div class="legend" style="margin-top:10px">
            <span style="display:inline-block;width:20px;height:14px;background:#20312b;border-radius:4px;border:1px solid #2e3238"></span> Low
            <span style="display:inline-block;width:20px;height:14px;background:#473a23;border-radius:4px;border:1px solid #2e3238;margin-left:10px"></span> Med
            <span style="display:inline-block;width:20px;height:14px;background:#5c2b2b;border-radius:4px;border:1px solid #2e3238;margin-left:10px"></span> High
          </div>
</section>

<div></div>
<div class="card" style="grid-column: span 12;">
  <div class="map-card-header">
    <h3>Global Protest Risk Map</h3>

    <div class="map-toolbar">
      <!-- Search -->
      <input
        id="mapSearchInput"
        type="text"
        placeholder="Search country or city‚Ä¶"
      />

      <!-- Window + predictive toggle -->
      <div class="map-window-ctl">
        <span>Window: Next <span id="wval">30</span> days</span>
        <input id="wslider" type="range" min="7" max="90" step="1" value="30" />
        <label class="map-pred-toggle">
          <input id="togglePred" type="checkbox" />
          Include predictive entries
        </label>
      </div>
    </div>
  </div>

  <div id="riskMap"></div>
</div>

</div>


<script src="filterEvents.js"></script>
<script src="alerts-data.js"></script>
<script src="metrics.js"></script>
<script src="assets-data.js"></script>
<script src="travellers-data.js"></script>

		
<script>
(function compatProfileShim(){
  if (!window.CIAuth || !CIAuth.isLoggedIn()) return;
  const u = CIAuth.who();
  if (!u) return;
  localStorage.setItem('ci_profile', JSON.stringify({
    name: u.name || 'CityIntel User',
    email: u.email,
    role: u.role || 'Admin',
    is_admin: (u.role||'').toLowerCase()==='admin'
  }));
  // Do NOT auto-set ci_subscribed here anymore
})();
</script>


<script>
(function syncPresenceFromStorage(){
  function loadList(key, fallback){
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return fallback;
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : fallback;
    } catch (e) {
      console.warn('CityIntel: failed to load', key, 'from localStorage', e);
      return fallback;
    }
  }

  // Seed from static JS, then override with stored values if present
  const seedAssets     = Array.isArray(window.CIAssets)     ? window.CIAssets     : [];
  const seedTravellers = Array.isArray(window.CITravellers) ? window.CITravellers : [];

  window.CIAssets     = loadList('ci_assets', seedAssets);
  window.CITravellers = loadList('ci_travellers', seedTravellers);
})();
</script>

		
		
<script>

(function(){
  // Robust date parser
  const MONTHS = { jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,sept:8,oct:9,nov:10,dec:11 };
  function cleanDateStr(s){
    return String(s||'')
      .replace(/\b(\d{1,2})(st|nd|rd|th)\b/gi, '$1')
      .replace(/\bat\b/gi, ' ')
      .replace(/\bGMT|BST|UTC|CEST|CET|IST\b/gi,'')
      .replace(/,\s*/g, ' ')
      .replace(/\s+/g,' ')
      .trim();
  }
  function parseWhenAny(raw){
    if (raw == null) return null;
    if (typeof raw === 'number') { const d = new Date(raw); return isNaN(d) ? null : d; }
    const s0 = String(raw).trim();
    const iso = new Date(s0);
    if (!isNaN(iso)) return iso;
    const s = cleanDateStr(s0);

    let m = s.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
    if (m){ const [_,Y,Mo,Da,H='12',Mi='00',Se='00'] = m; const d = new Date(+Y, +Mo-1, +Da, +H, +Mi, +Se); return isNaN(d)?null:d; }

    m = s.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
    if (m){ const [_,Da,Mo,Y,H='12',Mi='00',Se='00'] = m; const d = new Date(+Y, +Mo-1, +Da, +H, +Mi, +Se); return isNaN(d)?null:d; }

    m = s.match(/^(\d{1,2})\s+([A-Za-z]{3,9})\.?\s+(\d{4})(?:\s+(\d{1,2})(?::(\d{2}))?)?$/);
    if (m){ const [_,Da,Mon,Y,H='12',Mi='00'] = m; const idx = MONTHS[Mon.toLowerCase().slice(0,4)]; const d = new Date(+Y,(idx??0),+Da,+H,+Mi); return isNaN(d)?null:d; }

    m = s.match(/^([A-Za-z]{3,9})\.?\s+(\d{1,2}),?\s+(\d{4})(?:\s+(\d{1,2})(?::(\d{2}))?)?$/);
    if (m){ const [_,Mon,Da,Y,H='12',Mi='00'] = m; const idx = MONTHS[Mon.toLowerCase().slice(0,4)]; const d = new Date(+Y,(idx??0),+Da,+H,+Mi); return isNaN(d)?null:d; }

    return null;
  }
  window.CIHelpers = { parseWhenAny };

  // diagnostics
  const data = Array.isArray(window.alertsData) ? window.alertsData : [];
  const diag = data.map(a=>{
    const raw = a.time ?? a.datetime ?? a.date ?? a.when ?? null;
    const parsed = parseWhenAny(raw);
    return { title:a.title||'', city:a.city||'', raw_time:raw, parsed_ok:!!parsed, parsed_iso: parsed?parsed.toISOString():'' };
  });
  const unparsed = diag.filter(r=>!r.parsed_ok);
  console.info(`CityIntel: alerts=${data.length}, parsed=${diag.length-unparsed.length}, unparsed=${unparsed.length}`);
  if (unparsed.length) console.table(unparsed.slice(0,10));
})();
</script>


<!-- Today's Protests Banner Script -->

<script>
(function mountSeamlessBannerWrap(){
  const track = document.getElementById('tickerTrack');
  const wrap  = track?.closest('.ticker');
  if (!track || !wrap || !Array.isArray(window.alertsData)) return;

  const parse = v => (window.CIHelpers && CIHelpers.parseWhenAny(v)) || (v?new Date(v):null);
  const today = new Date();
  const sameDay = (a,b)=> a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
  const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const fmt = d => `${String(d.getDate()).padStart(2,'0')} ${MONTHS[d.getMonth()]} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;

  const riskChip = r => {
    const s = String(r||'').toLowerCase();
    const t = s.startsWith('hi')?'High':s.startsWith('me')?'Medium':'Low';
    const c = s.startsWith('hi')?'var(--danger)':s.startsWith('me')?'var(--warn)':'var(--ok)';
    return `<span style="display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);color:${c};font-weight:700">${t}</span>`;
  };

  const items = window.alertsData
    .map(a => ({...a, _dt: parse(a.time ?? a.datetime ?? a.date ?? a.when)}))
    .filter(a => a._dt && sameDay(a._dt, today))
    .sort((a,b) => a._dt - b._dt);

  const bits = items.length
    ? items.map(a => `${riskChip(a.risk)} ${a.city || a.country || ''} ‚Äî ${a.title || ''} ‚Äî ${fmt(a._dt)}`)
    : ['No events found for today'];

  // Build one block we can measure
  const gapPx = 32; // keep in sync with --gap
  track.style.setProperty('--gap', gapPx + 'px');

  const block = document.createElement('span');
  block.style.display = 'inline-flex';
  block.style.alignItems = 'center';
  block.style.gap = gapPx + 'px';
  block.innerHTML = bits.join('<span style="opacity:.35">|</span>');

  // Reset, append, measure
  track.innerHTML = '';
  track.appendChild(block);

  requestAnimationFrame(() => {
    const blockW = Math.max(10, block.getBoundingClientRect().width); // guard tiny
    const wrapW  = wrap.clientWidth;

    // Clone the block enough times to always have another one directly behind
    // We want at least 3x wrapper width for safety.
    while (track.scrollWidth < wrapW * 3) {
      track.appendChild(block.cloneNode(true));
    }

    // Animate the width of exactly one block (seamless wrap)
    track.style.setProperty('--loop-distance', blockW + 'px');

    // Keep your chosen speed
    track.style.setProperty('--ticker-duration', '110s');

    // Ensure immediate start
    void track.offsetWidth; // reflow
    track.style.animationPlayState = 'running';
  });
})();
</script>


		
<script>
(function mountHeatmap(){
  const grid = document.getElementById("risk-heatmap");
  if (!grid) return;
  grid.innerHTML = "";

  const continents = ["Africa","Asia","Europe","North America","South America","Oceania"];
  const COLORS = { low: "#20312b", med: "#473a23", high: "#5c2b2b" };

  const parse = v => (window.CIHelpers && CIHelpers.parseWhenAny(v)) || (v ? new Date(v) : null);
  const normRisk = r => {
    const s = String(r||'').toLowerCase();
    if (s.startsWith('hi')) return 'high';
    if (s.startsWith('me')) return 'med';
    return 'low';
  };

  // Upcoming-only, sorted
  const upcoming = (Array.isArray(window.alertsData) ? window.alertsData : [])
    .map(a => ({...a, _dt: parse(a.time ?? a.datetime ?? a.date ?? a.when), risk: normRisk(a.risk)}))
    .filter(a => a._dt && a._dt >= new Date())
    .sort((a,b)=> a._dt - b._dt);

  // Group by continent (supports Continent/continent keys)
  const byCont = new Map();
  upcoming.forEach(a => {
    const cont = (a.Continent ?? a.continent ?? '').trim();
    if (!cont) return;
    if (!byCont.has(cont)) byCont.set(cont, []);
    byCont.get(cont).push(a);
  });

  function blend(counts){
    const present = [];
    if (counts.high) present.push('high');
    if (counts.med)  present.push('med');
    if (counts.low)  present.push('low');
    if (present.length >= 3){
      const [r1,r2,r3] = present;
      return `linear-gradient(180deg, ${COLORS[r1]} 0% 33%, ${COLORS[r2]} 33% 66%, ${COLORS[r3]} 66% 100%)`;
    } else if (present.length === 2){
      const [r1,r2] = present;
      return `linear-gradient(180deg, ${COLORS[r1]} 0% 50%, ${COLORS[r2]} 50% 100%)`;
    }
    return COLORS[present[0] || 'low'];
  }

  continents.forEach(cont => {
    const rows = byCont.get(cont) || [];
    const counts = { low:0, med:0, high:0 };
    rows.forEach(r => counts[normRisk(r.risk)]++);

    const total = counts.low + counts.med + counts.high;

    const a = document.createElement("a");
    a.className = "cell";
    a.style.position = "relative";
    a.innerText = cont;
    a.style.background = total ? blend(counts) : COLORS.low;
    a.style.border = "1px solid #2e3238";
    a.href = `risk-detail.html?continent=${encodeURIComponent(cont)}`;
    a.title = total
      ? `${cont} ‚Äî ${total} upcoming event${total!==1?'s':''}`
      : `${cont} ‚Äî No upcoming data`;

    const badge = document.createElement("div");
    badge.textContent = total ? String(total) : "";
    badge.style.position = "absolute";
    badge.style.top = "4px";
    badge.style.right = "6px";
    badge.style.fontSize = "11px";
    badge.style.fontWeight = "700";
    badge.style.color = "#fff";
    badge.style.background = "rgba(0,0,0,0.4)";
    badge.style.border = "1px solid rgba(255,255,255,0.2)";
    badge.style.padding = "1px 5px";
    badge.style.borderRadius = "6px";

    a.appendChild(badge);
    grid.appendChild(a);
  });
})();
</script>



        </section>

        <section class="card" style="grid-column: span 7;">
          <h3>Notes / Analyst Scratchpad</h3>
          <p style="color:var(--muted);margin-top:6px">Use this space to capture hypotheses, route changes, risk factors, or requests from stakeholders.</p>
          <ul style="margin-top:4px">
            <li>Watch coach bookings for Edinburgh (threshold > 40 per hour).</li>
            <li>Check Leeds venue permits; verify separation plan for counter-protests.</li>
            <li>Flag any WhatsApp flyer variants for authenticity review.</li>
          </ul>
        </section>

<section class="card" style="grid-column: span 7;">
  <h3>Projections (next 14 days)</h3>
  <div id="proj14d" style="display:grid;grid-template-columns:1fr 1fr;gap:10px"></div>
  <small style="color:#8e97a3">Heuristic projection uses the last 14 days‚Äô average per continent and risk.</small>
</section>

      </div>
    </main>
  </div>

  <!-- Active nav highlight -->
  <script>
    (function () {
      const here = location.pathname.split("/").pop() || "index.html";
      document.querySelectorAll("aside.sidebar nav a").forEach(a=>{
        if ((here === "" && a.getAttribute("href")==="index.html") || here === a.getAttribute("href")) {
          a.classList.add("active");
        }
      });
    })();
  </script>

  <!-- Real-Time Alerts: High risk only, one-line rows, auto-refresh -->
<script>
(function renderRealtimeHighRisk(){
  const box = document.getElementById('realtimeAlerts');
  if (!box) return;

  const parse = v => (window.CIHelpers && CIHelpers.parseWhenAny(v)) || (v ? new Date(v) : null);
  const normRisk = r => {
    const s = String(r||'').toLowerCase();
    if (s.startsWith('hi')) return 'high';
    if (s.startsWith('me')) return 'med';
    return 'low';
  };

  function render(){
    box.innerHTML = "";

    // Upcoming-only, sorted, with _dt
    const soon = (Array.isArray(window.alertsData) ? window.alertsData : [])
      .map(a => ({...a, _dt: parse(a.time ?? a.datetime ?? a.date ?? a.when), risk: normRisk(a.risk)}))
      .filter(a => a._dt && a._dt >= new Date())
      .sort((a,b)=> a._dt - b._dt);

    const high = soon.filter(a => a.risk === 'high').slice(0,5);

    if (!high.length) {
      box.innerHTML = `<p style="color:#8e97a3">No high-risk alerts available.</p>`;
      return;
    }

    high.forEach(a => {
      const pretty = a._dt
        ? a._dt.toLocaleString('en-GB',{ timeZone:'Europe/London', day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' })
        : '';

      const card = document.createElement('div');
      card.className = "alert";
      card.style.cursor = a.source ? "pointer" : "default";
      card.innerHTML = `
        <strong>${a.city || a.Country || ''} ‚Äî ${a.title || ''}</strong>
        <div style="font-size:13px;color:#c9d1d9;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
          ${(a.summary||'').trim()}${pretty ? ` ‚Äî ${pretty}` : ``}
        </div>
      `;
      if (a.source) card.addEventListener('click', ()=>window.open(a.source,'_blank','noopener'));
      box.appendChild(card);
    });
  }

  render();
  setInterval(render, 60000);
})();
</script>


  <!-- Upcoming Events with pill-style risk badges -->
  <script>
  (function renderUpcoming(){
    const tbody = document.getElementById('upcomingBody');
    if (!tbody) return;

    const parse = v => (window.CIHelpers && CIHelpers.parseWhenAny(v)) || null;

    const normRisk = (r='')=>{
      const s = r.toLowerCase();
      if (s.startsWith('hi')) return 'high';
      if (s.startsWith('me')) return 'med';
      return 'low';
    };

    const pillStyle = {
      high:'background:rgba(255,90,95,.15);color:#ff5a5f;border:1px solid rgba(255,90,95,.35)',
      med: 'background:rgba(240,180,41,.15);color:#f0b429;border:1px solid rgba(240,180,41,.35)',
      low: 'background:rgba(51,196,141,.15);color:#33c48d;border:1px solid rgba(51,196,141,.35)'
    };
    const makePill = (risk)=>{
      const r = normRisk(risk);
      const txt = r[0].toUpperCase()+r.slice(1);
      const st = pillStyle[r] || pillStyle.low;
      return `<span style="display:inline-block;padding:4px 10px;border-radius:999px;font-weight:700;${st}">${txt}</span>`;
    };

    const now = new Date();
    const data = Array.isArray(window.alertsData) ? window.alertsData : [];

    // Normalize rows
    const items = data.map(a=>{
      const raw = a.time ?? a.datetime ?? a.date ?? a.when ?? null;
      const _dt = parse(raw);
      return {...a, _dt, risk:normRisk(a.risk)};
    }).filter(a => a._dt && a._dt >= now)
      .sort((a,b)=> a._dt - b._dt);

    // De-dup
    const seen = new Set();
    const uniq = [];
    for (const it of items) {
      const iso = it._dt.toISOString().slice(0,16);
      const key = it.id
        ? `id|${it.id}`
        : (it.source ? `src|${it.source}` : `tcm|${it.title}|${it.city}|${iso}`);
      if (seen.has(key)) continue;
      seen.add(key);
      uniq.push(it);
    }

   const rows = CIFilter.upcoming(window.alertsData).slice(0,3);
    tbody.innerHTML = '';

    if (!rows.length) {
      tbody.innerHTML = `<tr><td colspan="4" style="color:#8e97a3;padding:10px">No upcoming events.</td></tr>`;
      return;
    }

    rows.forEach(i=>{
      const pretty = i._dt.toLocaleString('en-GB',{
        timeZone:'Europe/London',
        day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit'
      });
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i.title || ''}</td>
        <td>${(i.city || '').split('/')[0].trim()}</td>
        <td>${pretty}</td>
        <td>${makePill(i.risk)}</td>
      `;
      if (i.source) {
        tr.style.cursor = 'pointer';
        tr.addEventListener('click', ()=>window.open(i.source,'_blank','noopener'));
      }
      tbody.appendChild(tr);
    });
  })();
  </script>

  <script>
  // TEMP: debug table inputs
  (function debugUpcoming(){
    const now = new Date();
    const data = Array.isArray(window.alertsData) ? window.alertsData : [];
    const rows = data.map(a=>{
      const raw = a.time ?? a.datetime ?? a.date ?? a.when ?? null;
      const dt = window.CIHelpers.parseWhenAny(raw);
      return {title:a.title, city:a.city, country:a.country, risk:a.risk, raw, iso: dt?dt.toISOString():'', future: !!(dt && dt>=now)};
    }).filter(x=>x.future)
      .sort((a,b)=> a.iso.localeCompare(b.iso))
      .slice(0,4);
    console.table(rows);
  })();
  </script>


<script>
(function mountActive24hKPI(){
  // Helper: robust timestamp parse (uses your global helper if present)
  const parse = v => (window.CIHelpers && CIHelpers.parseWhenAny(v)) || (v ? new Date(v) : null);

  // Count events in a time window [start, end]
  function countInWindow(data, start, end, {includePredictive=false}={}){
    let n = 0;
    for (const a of data || []) {
      if (!includePredictive && a.predictive === true) continue;
      const dt = parse(a.time ?? a.datetime ?? a.date ?? a.when);
      if (!dt) continue;
      if (dt >= start && dt <= end) n++;
    }
    return n;
  }

  function render(){
    const elVal   = document.getElementById('kpi-active-24h');
    const elDelta = document.getElementById('kpi-active-24h-delta');
    if (!elVal) return;

    const data = Array.isArray(window.alertsData) ? window.alertsData : [];

    const now  = new Date();
    const t0   = new Date(now.getTime() - 24*60*60*1000);      // last 24h window start
    const p0   = new Date(t0.getTime() - 24*60*60*1000);       // previous 24h window start

    // change includePredictive to true if you want to count predictive entries
    const opts = { includePredictive: false };

    const curr = countInWindow(data, t0, now, opts);
    const prev = countInWindow(data, p0, t0,  opts);

    // Update number
    elVal.textContent = curr;

    // Optional delta if the element exists
    if (elDelta) {
      if (prev === 0) {
        elDelta.style.display = 'none';
      } else {
        const diff = curr - prev;
        const pct  = Math.round((diff / prev) * 100);
        elDelta.textContent = (diff >= 0 ? `+${pct}%` : `${pct}%`);
        elDelta.className = 'delta ' + (diff >= 0 ? 'up' : 'down');
        elDelta.style.display = '';
      }
    }
  }

  // Initial render + refresh every 600s
  render();
  setInterval(render, 600000);
})();
</script>


<script>
(function mountUpcoming7dKPI(){
  // Robust parse (uses your helper if present)
  const parse = v => (window.CIHelpers && CIHelpers.parseWhenAny(v)) || (v ? new Date(v) : null);

  // Count events in window (start < dt <= end) ‚Äî future-facing
  function countInWindow(data, start, end, {includePredictive=false}={}){
    let n = 0;
    for (const a of data || []) {
      if (!includePredictive && a.predictive === true) continue;
      const dt = parse(a.time ?? a.datetime ?? a.date ?? a.when);
      if (!dt) continue;
      if (dt > start && dt <= end) n++;
    }
    return n;
  }

  function render(){
    const elVal   = document.getElementById('kpi-upcoming-7d');
    const elDelta = document.getElementById('kpi-upcoming-7d-delta');
    if (!elVal) return;

    const data = Array.isArray(window.alertsData) ? window.alertsData : [];

    const now   = new Date();
    const next7 = new Date(now.getTime() + 7*24*60*60*1000);   // end of forward window
    const prev0 = new Date(now.getTime() - 7*24*60*60*1000);   // start of backward window

    // Change to true if you want to include predictive entries
    const opts = { includePredictive: false };

    // Current = next 7 days; Previous = the 7 days before now (for trend context)
    const curr = countInWindow(data, now, next7, opts);
    const prev = countInWindow(data, prev0, now,  opts);

    elVal.textContent = curr;

    if (elDelta) {
      if (prev === 0) {
        elDelta.style.display = 'none';
      } else {
        const diff = curr - prev;
        const pct  = Math.round((diff / prev) * 100);
        elDelta.textContent = (diff >= 0 ? `+${pct}%` : `${pct}%`);
        elDelta.className = 'delta ' + (diff >= 0 ? 'up' : 'down');
        elDelta.style.display = '';
      }
    }
  }

  // Initial + refresh every 600s
  render();
  setInterval(render, 600000);
})();
</script>


<script>
(function mountHighRiskKPI(){
  const parse = v => (window.CIHelpers && CIHelpers.parseWhenAny(v)) || (v ? new Date(v) : null);
  const isHigh = r => String(r||'').toLowerCase().startsWith('hi');

  function countHighInWindow(data, start, end, {includePredictive=false}={}) {
    let n = 0;
    for (const a of data || []) {
      if (!includePredictive && a.predictive === true) continue;
      const dt = parse(a.time ?? a.datetime ?? a.date ?? a.when);
      if (!dt) continue;
      if (dt > start && dt <= end && isHigh(a.risk)) n++;
    }
    return n;
  }

  function render(){
    const elVal   = document.getElementById('kpi-high-risk');
    const elDelta = document.getElementById('kpi-high-risk-delta');
    if (!elVal) return;

    const data = Array.isArray(window.alertsData) ? window.alertsData : [];

    const now    = new Date();
    const next7  = new Date(now.getTime() + 7*24*60*60*1000);
    const prev0  = new Date(now.getTime() - 7*24*60*60*1000);

    const opts = { includePredictive: false };

    const curr = countHighInWindow(data, now,  next7, opts);
    const prev = countHighInWindow(data, prev0, now,  opts);

    // Always keep the number red
    elVal.textContent = curr;
    elVal.style.color = 'var(--danger)';

    if (elDelta) {
      if (prev === 0) {
        elDelta.style.display = 'none';
      } else {
        const diff = curr - prev;
        const pct  = Math.round((diff / prev) * 100);
        elDelta.textContent = (diff >= 0 ? `+${pct}%` : `${pct}%`);
        elDelta.className = 'delta ' + (diff >= 0 ? 'up' : 'down');
        elDelta.style.display = '';
      }
    }
  }

  render();
  setInterval(render, 600000); // refresh every 10 minute
})();
</script>

<script src="auth.js"></script>

<script>
(function mountTopActions(){
  function host(){ return document.getElementById('topActions'); }

  function render(){
    const el = host();
    if (!el) return;

    // If auth lib isn't ready yet, try again shortly
    if (!window.CIAuth){ el.innerHTML = ''; return; }

    if (CIAuth.isLoggedIn()){
      const u = CIAuth.who();
      const initials = (u.name||'CI').split(/\s+/).slice(0,2).map(s=>s[0]?.toUpperCase()||'').join('') || 'CI';
      const role = u.role || 'Analyst';
      el.innerHTML = `
        <div class="user" id="userChip" style="display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;background:#1c1e22;border:1px solid #2e3238;cursor:pointer">
          <div class="avatar" style="width:28px;height:28px;background:#fff;color:#000;border-radius:50%;display:grid;place-items:center;font-weight:700">${initials}</div>
          ${role}
        </div>
        <div class="dropdown" id="userMenu" style="position:absolute;right:0;top:calc(100% + 6px);background:#1a1c20;border:1px solid #2e3238;border-radius:10px;padding:6px 0;box-shadow:0 4px 12px rgba(0,0,0,.4);display:none;min-width:160px;z-index:50">
          <a href="settings.html" style="display:block;padding:8px 12px;color:#e9edf2;text-decoration:none;font-size:14px">Settings</a>
          <a href="profile.html" style="display:block;padding:8px 12px;color:#e9edf2;text-decoration:none;font-size:14px">Profile</a>
          <a href="#" id="logoutLink" style="display:block;padding:8px 12px;color:#e9edf2;text-decoration:none;font-size:14px">Log out</a>
        </div>
      `;

      const chip = document.getElementById('userChip');
      const menu = document.getElementById('userMenu');
      chip.addEventListener('click', ()=> menu.style.display = (menu.style.display==='block'?'none':'block'));
      document.addEventListener('click', e => { if (!el.contains(e.target)) menu.style.display='none'; });
      document.getElementById('logoutLink').addEventListener('click', e=>{
        e.preventDefault();
        CIAuth.logout();
        // Emit and update UI
        window.dispatchEvent(new Event('ci:auth:logout'));
        render();
      });

    } else {
      const here = location.pathname.split('/').pop() || 'index.html';
      const next = encodeURIComponent(here + location.search + location.hash);
      el.innerHTML = `<a class="login-btn" href="login.html?next=${next}">Log in</a>`;
    }
  }

  // First paint
  document.addEventListener('DOMContentLoaded', render);

  // React to auth changes & cross-tab updates
  window.addEventListener('ci:auth:login', render);
  window.addEventListener('ci:auth:logout', render);
  window.addEventListener('storage', (e)=>{
    if (['ci_user','ci_token'].includes(e.key)) render();
  });

  // Small fallback to catch race with auth.js
  let tries = 10;
  const t = setInterval(()=>{
    if (--tries <= 0) clearInterval(t);
    render();
  }, 300);
})();
</script>
	
<script src="admin-links.js"></script>


<script>
(function projections14d(){
  const host = document.getElementById('proj14d');
  if (!host || !window.alertsData) return;

  const TZ = 'Europe/London';
  const parseTime = v => {
    const d = new Date(v);
    return isNaN(d) ? null : d;
  };

  const now = new Date();
  const start = new Date(+now - 14*864e5);

  // Aggregate by continent + risk for last 14 days
  const agg = {}; // { [continent]: { low:n, medium:n, high:n, total:n } }
  (alertsData||[]).forEach(a=>{
    const dt = parseTime(a.time);
    if (!dt || dt < start || dt > now) return;
    const cont = (a.continent || a.Continent || 'Unknown').trim();
    const r = String(a.risk||'').toLowerCase().startsWith('hi') ? 'high'
            : String(a.risk||'').toLowerCase().startsWith('me') ? 'medium'
            : 'low';
    if (!agg[cont]) agg[cont] = {low:0, medium:0, high:0, total:0};
    agg[cont][r]++; agg[cont].total++;
  });

  // Projection = average per day * 14, per continent/risk
  const out = Object.entries(agg).map(([cont, row])=>{
    const factor = 14 / 14; // trivial, kept for future weighting
    return {
      continent: cont,
      low: Math.round((row.low/14)*14*factor),
      medium: Math.round((row.medium/14)*14*factor),
      high: Math.round((row.high/14)*14*factor),
      total: Math.round((row.total/14)*14*factor)
    };
  }).sort((a,b)=> b.total - a.total);

  // Render
  host.innerHTML = '';
  out.forEach(x=>{
    const card = document.createElement('div');
    card.style.border = '1px solid var(--brand-gray-600)';
    card.style.borderRadius = '12px';
    card.style.padding = '10px 12px';
    card.style.background = 'linear-gradient(180deg,#1a1c20,#131417)';

    card.innerHTML = `
      <div style="font-weight:800;margin-bottom:6px">${x.continent}</div>
      <div style="display:flex;gap:10px;align-items:center">
        <span style="display:inline-block;padding:3px 8px;border-radius:999px;background:rgba(255,90,95,.15);color:#ff5a5f;border:1px solid rgba(255,90,95,.35);font-weight:700">High ${x.high}</span>
        <span style="display:inline-block;padding:3px 8px;border-radius:999px;background:rgba(240,180,41,.15);color:#f0b429;border:1px solid rgba(240,180,41,.35);font-weight:700">Med ${x.medium}</span>
        <span style="display:inline-block;padding:3px 8px;border-radius:999px;background:rgba(51,196,141,.15);color:#33c48d;border:1px solid rgba(51,196,141,.35);font-weight:700">Low ${x.low}</span>
        <span style="margin-left:auto;color:#cfd6e1">Total <b>${x.total}</b></span>
      </div>
    `;
    host.appendChild(card);
  });

  if (!out.length){
    host.innerHTML = `<div style="color:#8e97a3">Insufficient recent data to project.</div>`;
  }
})();
</script>





<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
<script src="https://unpkg.com/topojson-client@3"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
/* ===============================
   Global Protest Risk Map (Leaflet)
   =============================== */
(function(){
  const MAP_EL   = 'riskMap';
  const TOPO_URL = "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json";

  const palette   = { low:'#6bcf6b', medium:'#f0b429', high:'#ff5a5f', none:'#2e3238' };
  const riskScore = { low:1, medium:2, high:3 };

	  // Custom markers for assets & travellers
  const assetIcon = L.divIcon({ className: 'ci-marker ci-marker-asset',
    html: '<span>üè¢</span>', iconSize: [24, 24], iconAnchor: [12, 12] });

  const travellerIcon = L.divIcon({ className: 'ci-marker ci-marker-traveller',
    html: '<span>üë§</span>', iconSize: [24, 24], iconAnchor: [12, 12] });

  let windowDays       = 30;      // default
  let includePredictive = false;

  const norm = s => (s || '').trim().toLowerCase();

  const alias = new Map([
    ['england','united kingdom'],
    ['scotland','united kingdom'],
    ['wales','united kingdom'],
    ['czech republic','czechia'],
    ['vatican city','holy see']
  ]);

  function emitCountrySelected(name, items){
    try {
      window.dispatchEvent(new CustomEvent('ci:countrySelected', {
        detail: { country: name, items }
      }));
    } catch(e) {
      console.warn('countrySelected event error', e);
    }
  }

  // --- Map init ---
  const map = L.map(MAP_EL, {
    scrollWheelZoom: true,
    worldCopyJump: true,
    boxZoom: false         // prevent grey zoom box lines
  }).setView([18, 10], 2);

	const assetLayer     = L.layerGroup().addTo(map);
    const travellerLayer = L.layerGroup().addTo(map);

  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
  }).addTo(map);

  // Legend (keep inside map)
  const Legend = L.Control.extend({
    onAdd: function(){
      const d = L.DomUtil.create('div','risklegend');
      d.innerHTML = `
        <div><span class="chip" style="background:${palette.low}"></span>Low</div>
        <div><span class="chip" style="background:${palette.medium}"></span>Medium</div>
        <div><span class="chip" style="background:${palette.high}"></span>High</div>
        <div style="margin-top:6px;border-top:1px solid #2e3238;padding-top:6px;">Dashed outline = mixed risk</div>
      `;
      return d;
    }
  });

	L.control.layers(null, { "Company assets": assetLayer, "Travellers": travellerLayer}, {
    position: 'topright', collapsed: true}).addTo(map);

  map.addControl(new Legend({position:'bottomright'}));

  let geoLayer = null;

	

  const HISTORY_DAYS = 180;   // lookback for structural risk (~6 months)

const parseTime = v =>
  (window.CIHelpers && CIHelpers.parseWhenAny(v)) || (v ? new Date(v) : null);

function aggregate(alerts){
  const now        = new Date();
  const futureEnd  = new Date(+now + windowDays * 86400000);
  const histStart  = new Date(+now - HISTORY_DAYS * 86400000);

  const by = {};

  for (const a of alerts || []) {
    if (!a) continue;

    const dt = parseTime(a.time ?? a.datetime ?? a.date ?? a.when);
    if (!dt) continue;

    // Normalise country (same logic as before)
    let rawCountry = (a.country ?? a.Country ?? a.country_name ?? '').trim();
    if (!rawCountry) continue;

    const key = norm(rawCountry);
    if (alias.has(key)) rawCountry = alias.get(key);
    const country = rawCountry.replace(/\b\w/g, m => m.toUpperCase());

    // Normalise risk band
    const rk = norm(a.risk);
    let band = 'low';
    if (rk.startsWith('hi')) band = 'high';
    else if (rk.startsWith('me')) band = 'medium';

    // Ensure bucket
    if (!by[country]) {
      by[country] = {
        hist:   { low:0, medium:0, high:0 },
        fut:    { low:0, medium:0, high:0 },
        mixFuture: false,
        band: 'low',
        items: []
      };
    }
    const row = by[country];

    // History window (structural risk)
    if (dt >= histStart && dt <= now) {
      row.hist[band]++;
    }

    // Future window (current/forecast) ‚Äì honour includePredictive
    if (dt > now && dt <= futureEnd) {
      if (!includePredictive && a.predictive === true) {
        // skip predictive if checkbox is off
      } else {
        row.fut[band]++;
        row.items.push(a);
      }
    }
  }

  // Derive mix + combined band for shading
  for (const k in by) {
    const row = by[k];

    // Mixed future risk (for dashed outline)
    const f = row.fut;
    row.mixFuture =
      (f.high > 0 && f.low > 0) ||
      (f.medium > 0 && f.high > 0) ||
      (f.medium > 0 && f.low > 0);

    // Scores: history weight 1√ó, future weight 2√ó
    const histHigh   = row.hist.high;
    const histMed    = row.hist.medium;
    const histLow    = row.hist.low;

    const futHigh    = row.fut.high;
    const futMed     = row.fut.medium;
    const futLow     = row.fut.low;

    const highScore   = 3 * (histHigh + 2 * futHigh);
    const mediumScore = 2 * (histMed  + 2 * futMed);
    const lowScore    = 1 * (histLow  + 2 * futLow);

    const totalScore  = highScore + mediumScore + lowScore;

    if (totalScore === 0) {
      row.band = 'none';
      continue;
    }

    const highRatio = highScore / totalScore;
    const midRatio  = (highScore + mediumScore) / totalScore;

    // Thresholds ‚Äì tweak to taste
    if (highRatio >= 0.4 || highScore >= 12) {
      row.band = 'high';
    } else if (midRatio >= 0.5 || mediumScore >= 8) {
      row.band = 'medium';
    } else {
      row.band = 'low';
    }
  }

  return by;
}



	
// ----- Company assets & travellers on map -----
function renderAssetsAndTravellers(){
  assetLayer.clearLayers();
  travellerLayer.clearLayers();

  const assets = Array.isArray(window.CIAssets) ? window.CIAssets : [];
  const trips  = Array.isArray(window.CITravellers) ? window.CITravellers : [];

  // Assets: blue-ish markers
    // Assets: blue badge markers
  assets.forEach(a => {
    if (typeof a.lat !== 'number' || typeof a.lon !== 'number') return;

    const m = L.marker([a.lat, a.lon], { icon: assetIcon });
    m.bindPopup(`
      <b>${a.name}</b><br>
      ${a.address ? a.address + '<br>' : ''}
      ${a.city || ''}, ${a.country || ''}<br>
      <small>Type: ${a.type || 'asset'}</small>
    `);
    assetLayer.addLayer(m);
  });

  // Travellers: amber badge markers
  const today = new Date();
  trips.forEach(t => {
    if (typeof t.lat !== 'number' || typeof t.lon !== 'number') return;

    const from = new Date(t.from);
    const to   = new Date(t.to);
    if (isNaN(from) || isNaN(to) || today < from || today > to) return;

    const m = L.marker([t.lat, t.lon], { icon: travellerIcon });
    m.bindPopup(`
      <b>${t.name}</b> ‚Äî ${t.role || ''}<br>
      ${t.city || ''}, ${t.country || ''}<br>
      <small>Stay: ${t.from} ‚Üí ${t.to}<br>
      ${t.hotel ? 'Hotel: ' + t.hotel + '<br>' : ''}
      ${t.address ? 'Address: ' + t.address : ''}
      </small>
    `);
    travellerLayer.addLayer(m);
  });

}


function countPresenceForCountry(countryName){
  const assets = Array.isArray(window.CIAssets) ? window.CIAssets : [];
  const trips  = Array.isArray(window.CITravellers) ? window.CITravellers : [];

  const normCountry = c => (c || '').trim().toLowerCase();
  const key = normCountry(countryName);

  const today = new Date();

  const assetMatches = assets.filter(a =>
    normCountry(a.country) === key
  );

  const travellerMatches = trips.filter(t => {
    if (normCountry(t.country) !== key) return false;
    const from = new Date(t.from);
    const to   = new Date(t.to);
    if (isNaN(from) || isNaN(to)) return false;
    return today >= from && today <= to;
  });

  return { assetMatches, travellerMatches };
}


	

  // ----- Draw / redraw map -----
  function draw(){
    fetch(TOPO_URL)
      .then(r => r.json())
      .then(topology => {
        const geo = topojson.feature(topology, topology.objects.countries);
        geo.features.forEach(f => {
          const n = f.properties.name || f.properties.NAME || "";
          f.properties.ADMIN = n;
        });

        const alerts = window.alertsData || [];
        const agg = aggregate(alerts);

        if (geoLayer) geoLayer.remove();

        geoLayer = L.geoJSON(geo, {
          style: f => {
  const name = (f.properties.ADMIN || f.properties.NAME || '').trim();
  const row  = agg[name];

  if (!row || row.band === 'none') {
    return { fillColor: palette.none, fillOpacity:.25, color:'#111', weight:.6 };
  }

  const col = palette[row.band] || palette.low;

  return {
    fillColor: col,
    fillOpacity: .85,
    color: row.mixFuture ? '#ffffff' : '#111',
    dashArray: row.mixFuture ? '6 3' : null,
    weight: row.mixFuture ? 1.2 : .6
  };
},

			
          onEachFeature: (f, layer) => {
  const name = (f.properties.ADMIN || f.properties.NAME || '').trim();
  const row  = agg[name];

  if (!row) {
    const presence = countPresenceForCountry(name);
    layer.bindPopup(` <b>${name}</b><br> No protest data<br>  Assets in country: <b>${presence.assetMatches.length}</b><br>
      Travellers in country (current): <b>${presence.travellerMatches.length}</b> `);
    return;
  }

  const h = row.hist;
  const fwd = row.fut;
  const histTotal = h.low + h.medium + h.high;
  const futTotal  = fwd.low + fwd.medium + fwd.high;

  const histLine = histTotal
    ? `Last 6 months: `
      + `<span class="chip" style="background:${palette.high}"></span>${h.high} `
      + `<span class="chip" style="background:${palette.medium}"></span>${h.medium} `
      + `<span class="chip" style="background:${palette.low}"></span>${h.low}`
    : `Last 6 months: no data`;

  const futLine = futTotal
    ? `Next ${windowDays} days: `
      + `<span class="chip" style="background:${palette.high}"></span>${fwd.high} `
      + `<span class="chip" style="background:${palette.medium}"></span>${fwd.medium} `
      + `<span class="chip" style="background:${palette.low}"></span>${fwd.low}`
    : `Next ${windowDays} days: no scheduled events`;

  const presence = countPresenceForCountry(name);

  layer.bindPopup(` <b>${name}</b><br> Overall band: <b>${row.band.toUpperCase()}</b><br>
    ${histLine}<br> ${futLine}<br><br> Assets in country: <b>${presence.assetMatches.length}</b><br>
    Travellers in country (current): <b>${presence.travellerMatches.length}</b>
  `);

  layer.on('click', () => {
    const items = row.items
      ? row.items.slice().sort((a,b)=>parseTime(a.time)-parseTime(b.time))
      : [];
    emitCountrySelected(name, items);
  });
}

        }).addTo(map);
      });
  }

   // ----- Wire header controls -----
  const slider = document.getElementById('wslider');
  const wval   = document.getElementById('wval');

  if (slider && wval) {
    slider.value = windowDays;
    wval.textContent = windowDays;
    slider.addEventListener('input', () => {
      windowDays = parseInt(slider.value, 10) || 30;
      wval.textContent = windowDays;
      draw();
    });
  }

  const predChk = document.getElementById('togglePred');
  if (predChk) {
    predChk.addEventListener('change', () => {
      includePredictive = predChk.checked;
      draw();
    });
  }

  // === Search box using leaflet-control-geocoder backend ===
   // === Search box using Nominatim (OpenStreetMap) ===
  (function wireSearchBox(){
    const searchInput = document.getElementById('mapSearchInput');
    if (!searchInput) {
      console.warn('CI map: #mapSearchInput not found');
      return;
    }

    searchInput.addEventListener('keydown', async (e) => {
      if (e.key !== 'Enter') return;

      const q = searchInput.value.trim();
      if (!q) return;

      try {
        // Ask Nominatim for the first matching result
        const url = `https://nominatim.openstreetmap.org/search` +
                    `?format=json&limit=1&q=${encodeURIComponent(q)}`;

        const res = await fetch(url, {
          headers: {
            // helps with polite usage; fine in browser
            'Accept': 'application/json'
          }
        });

        const data = await res.json();
        console.log('CI map search results for', q, data);

        if (!Array.isArray(data) || !data.length) {
          console.info('No location found for', q);
          return;
        }

        const r = data[0];

        // boundingbox: [south, north, west, east]
              if (Array.isArray(r.boundingbox) && r.boundingbox.length === 4) {
        const south = parseFloat(r.boundingbox[0]);
        const north = parseFloat(r.boundingbox[1]);
        const west  = parseFloat(r.boundingbox[2]);
        const east  = parseFloat(r.boundingbox[3]);

        const bounds = L.latLngBounds(
          [south, west],
          [north, east]
        );

        // Compute a zoom that fits the bounds, but cap it so we don't zoom too far in
        const fitZoom  = map.getBoundsZoom(bounds);
        const maxZoom  = 6;  // tweak if you want closer / wider
        const targetZ  = Math.min(fitZoom, maxZoom);
        const center   = bounds.getCenter();

        map.setView(center, targetZ);
      } else if (r.lat && r.lon) {
        const maxZoom = 6;
        map.setView(
          [parseFloat(r.lat), parseFloat(r.lon)],
          maxZoom
        );
      }


      } catch (err) {
        console.error('CI map search error for', q, err);
      }
    });
  })();

  // Initial draw
  draw();
  renderAssetsAndTravellers();
})();
</script>


<script id="ci-panic-banner-js">
(function(){
  const API_BASE = 'https://api.cityintelapi.com';
  const POLL_MS = 7000;

  function getProfile(){
    try { return JSON.parse(localStorage.getItem('ci_profile')||'null'); } catch { return null; }
  }
  function makeHeaders(){
    const p = getProfile();
    if (!p || !p.email) return null;
    return {
      'X-User-Email': p.email,
      'X-User-Name': p.name || 'CityIntel User',
      'X-User-Id': p.id || ('email:' + String(p.email).toLowerCase()),
    };
  }

  function ensureBanner(){
    let el = document.getElementById('ciPanicBanner');
    if (el) return el;
    el = document.createElement('div');
    el.id = 'ciPanicBanner';
    el.style.display = 'none';
    el.innerHTML = `
      <div class="ci-inner">
        <div class="ci-left"></div>
        <div class="ci-center">
          <span class="ci-badge ci-pulse">PANIC ALARM ACTIVE</span>
          <span class="ci-meta" id="ciPanicMeta"></span>
          <a id="ciPanicOpen" href="panicalarm.html">Open</a>
        </div>
        <div class="ci-right">
          <button id="ciPanicHide" type="button">Hide</button>
        </div>
      </div>`;
    document.body.prepend(el);

    el.querySelector('#ciPanicHide')?.addEventListener('click', () => {
      try { localStorage.setItem('ci_panic_banner_hidden', '1'); } catch {}
      el.style.display = 'none';
      document.body.classList.remove('ci-has-panic-banner');
    });

    return el;
  }

  function setBannerVisible(visible){
    const el = ensureBanner();
    if (visible) {
      if (localStorage.getItem('ci_panic_banner_hidden') === '1') return;
      el.style.display = '';
      document.body.classList.add('ci-has-panic-banner');
    } else {
      el.style.display = 'none';
      document.body.classList.remove('ci-has-panic-banner');
    }
  }

  async function refresh(){
    const headers = makeHeaders();
    if (!headers) { setBannerVisible(false); return; }

    try{
      const res = await fetch(API_BASE + '/api/org/panic', { headers });
      const json = await res.json().catch(()=>null);
      const data = json && (json.data ?? json);
      const state = (data && typeof data === 'object') ? data : null;

      // expected shape: { active, activated_by, activated_at, message }
      const active = !!(state && state.active);
      if (!active) { setBannerVisible(false); return; }

      const meta = [];
      const who = (state.actorName || state.activated_by || '').trim() || (state.actorEmail || '').trim();
      if (who) meta.push(`Activated by ${who}`);
      if (state.activated_at) {
        try {
          const d = new Date(state.activated_at);
          meta.push(isNaN(d.getTime()) ? String(state.activated_at) : d.toLocaleString());
        } catch { meta.push(String(state.activated_at)); }
      }
      if (state.phone || state.actorPhone) meta.push(`Phone: ${(state.phone || state.actorPhone)}`);
            if ((state.travellerName || state.actorTravellerName)) meta.push(`Traveller: ${(state.travellerName || state.actorTravellerName)}`);
if (state.message) meta.push(`Note: ${state.message}`);
      const metaEl = document.getElementById('ciPanicMeta');
      if (metaEl) metaEl.textContent = meta.join('  ‚Ä¢  ');

      setBannerVisible(true);
    } catch(e){
      // silent fail; don't spam UI
    }
  }

  // reset hide when alarm becomes active again later (optional)
  function clearHideOnNewActivation(metaText){
    // keep simple; do nothing for now
  }

  // Run now + poll
  ensureBanner();
  refresh();
  setInterval(refresh, POLL_MS);
})();
</script>
</body>
</html>




