<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<title>CityIntel â€” Travellers</title>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<link href="./CityintLogo.jpg" rel="icon"/>
<style>
  /* ===== CityIntel theme + components ===== */
  :root{
    --brand-red:#D01616; --brand-black:#0C0C0C;
    --brand-gray-900:#111214; --brand-gray-800:#16171a; --brand-gray-700:#1c1e22;
    --brand-gray-600:#24272c; --brand-gray-500:#2e3238;
    --muted:#8e97a3; --text:#e9edf2; --ok:#33c48d; --warn:#f0b429; --danger:#ff5a5f;
    --card-radius:16px; --shadow:0 8px 24px rgba(0,0,0,0.35);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,var(--brand-gray-900),var(--brand-gray-800));
    color:var(--text); font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  }

  .app{
    display:grid; grid-template-columns:260px 1fr; grid-template-rows:60px auto 1fr;
    grid-template-areas:"sidebar topbar" "sidebar main" "sidebar main"; min-height:100vh;
  }
  .sidebar{
    grid-area:sidebar; background:linear-gradient(180deg,var(--brand-black),#131416);
    border-right:1px solid var(--brand-gray-600); display:flex; flex-direction:column; padding:18px 14px; gap:18px;
  }
  .brand{display:flex;align-items:center;gap:10px; padding:8px 10px; border-radius:12px;
    background:linear-gradient(90deg,rgba(208,22,22,0.2),rgba(208,22,22,0));}
  .brand img{width:34px;height:34px;object-fit:contain;border-radius:6px;background:#fff}
  .brand .title{font-weight:700;letter-spacing:.3px}
  nav a{display:flex;align-items:center;gap:10px;color:#e9edf2;text-decoration:none;
    padding:10px 12px;border-radius:10px;border:1px solid transparent}
  nav a:hover{background:#24272c;border-color:#2e3238}
  nav a.active{background:rgba(208,22,22,0.15);border-color:#D01616}

  .topbar{
    grid-area:topbar;background:rgba(255,255,255,0.02);border-bottom:1px solid var(--brand-gray-600);
    display:flex;align-items:center;gap:12px;padding:10px 16px;position:sticky;top:0;z-index:10;backdrop-filter:blur(8px)
  }
  .search{flex:1;display:flex;align-items:center;gap:10px;background:var(--brand-gray-700);
    border:1px solid var(--brand-gray-600);border-radius:12px;padding:8px 12px}
  .search input{flex:1;background:transparent;border:none;outline:none;color:var(--text)}

  .login-btn {
    display:inline-block;
    padding:8px 12px;
    border-radius:999px;
    background:#D01616;
    border:1px solid #9c0f0f;
    color:#fff;
    font-weight:700;
    text-decoration:none;
    white-space:nowrap;
  }
  .login-btn:hover { filter:brightness(1.05); }

  .user { display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:12px; background:var(--brand-gray-700); border:1px solid var(--brand-gray-600); cursor:pointer; }
  .avatar { width:28px;height:28px; background:#fff;color:#000;border-radius:50%; display:grid;place-items:center;font-weight:700; }

  .dropdown {
    position:absolute; right:0; top:calc(100% + 6px);
    background:#1a1c20; border:1px solid var(--brand-gray-600); border-radius:10px;
    padding:6px 0; box-shadow:0 4px 12px rgba(0,0,0,0.4);
    display:none; min-width:140px; z-index:50;
  }
  .dropdown a { display:block; padding:8px 12px; color:var(--text); text-decoration:none; font-size:14px; }
  .dropdown a:hover { background:rgba(255,255,255,0.05); }

  .main{grid-area:main;padding:18px}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}

  .card{background:linear-gradient(180deg,#1a1c20,#131417);border:1px solid var(--brand-gray-600);
    border-radius:var(--card-radius);box-shadow:var(--shadow);padding:16px}
  .card h3{margin:0 0 10px 0;font-size:16px;letter-spacing:.2px}

  table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:12px}
  thead th{text-align:left;font-size:12px;color:var(--muted);background:var(--brand-gray-700);padding:10px;border-bottom:1px solid var(--brand-gray-600)}
  tbody td{padding:10px;border-bottom:1px solid var(--brand-gray-600);font-size:13px}
  tr:hover td{background:rgba(255,255,255,0.02)}

  .badge{
    display:inline-block;
    padding:2px 8px;
    border-radius:999px;
    font-size:11px;
    border:1px solid rgba(255,255,255,0.15);
    background:rgba(255,255,255,0.06);
  }

  .btn{
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--brand-gray-600);
    background:var(--brand-gray-700);
    color:var(--text);
    font-size:13px;
    cursor:pointer;
  }
  .btn:hover{background:#24272c}
  .btn-danger{
    border-color:#5c2b2b;
    background:rgba(92,43,43,0.4);
    color:#ff7a7f;
  }
  .btn-danger:hover{background:rgba(92,43,43,0.8)}

  .form-grid{
    display:grid;
    grid-template-columns:repeat(2, minmax(0,1fr));
    gap:10px;
  }
  .form-grid .full{grid-column:1/-1}
  .field{
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .field label{
    font-size:12px;
    color:var(--muted);
  }
  .field input,
  .field select{
    padding:6px 8px;
    border-radius:8px;
    border:1px solid var(--brand-gray-600);
    background:var(--brand-gray-800);
    color:var(--text);
    font-size:13px;
  }
  .field input:focus,
  .field select:focus{
    outline:none;
    border-color:#D01616;
  }

  .pill-hint{
    font-size:12px;
    color:var(--muted);
    margin-top:6px;
  }

  @media (max-width:1100px){
    .app{grid-template-columns:68px 1fr}
    .brand .title,nav span{display:none}
    .sidebar{padding:14px 10px}
  }
  @media (max-width:880px){
    .grid{grid-template-columns:1fr}
  }


/* ===== Mobile layout tweaks ===== */
@media (max-width: 720px) {
  /* Stack layout: topbar, sidebar row, then main content */
  .app{
    grid-template-columns: 1fr;
    grid-template-rows: auto auto 1fr;
    grid-template-areas:
      "topbar"
      "sidebar"
      "main";
  }

  .sidebar{
    border-right: none;
    border-top: 1px solid var(--brand-gray-600);
    flex-direction: row;
    align-items: center;
    gap: 8px;
    padding: 8px;
    overflow-x: auto;
    white-space: nowrap;
  }

  .sidebar nav{
    display: flex;
    flex-wrap: nowrap;
    gap: 8px;
  }

  .sidebar nav a{
    font-size: 12px;
    padding: 6px 10px;
    white-space: nowrap;
  }

  .brand{
    flex-shrink: 0;
  }

  .main{
    padding: 10px;
  }

  .card{
    padding: 12px;
  }

  /* Map + heatmap sizing on small screens */
  #riskMap{
    height: 320px;
  }

  #risk-heatmap .cell{
    width: 72px;
    height: 52px;
    font-size: 10px;
  }

  /* Map toolbar (search + window slider) stack nicely */
  .risk-toolbar{
    flex-direction: column;
    align-items: stretch;
    gap: 6px;
  }
}

    
  </style>
</head>
<body>
<div class="app">
<!-- SIDEBAR -->
<aside class="sidebar">
<div class="brand">
<img alt="CityIntel Logo" src="CityintLogo.jpg"/>
<div class="title">CityIntel</div>
</div>
<nav>
<a href="index.html">Dashboard</a>
<a href="alerts.html">Alerts</a>
<a href="events.html">Events</a>
<a href="test.html">Test Feed</a>
<a href="brief.html">Intelligence Brief</a>
<a href="trends.html">Trends &amp; Forecasts</a>
<a href="reports.html">Reports</a>
<a href="sources.html">Sources</a>
<a href="settings.html">Settings</a>
<a href="about.html">About</a>
<!-- current page -->
<a class="active" href="travellers.html">Travellers</a>
</nav>
</aside>
<!-- TOPBAR -->
<header class="topbar">
<div class="search">ðŸ”Ž <input placeholder="Search travellers, citiesâ€¦"/></div>
<div id="topActions" style="position:relative"></div>
</header>
<!-- MAIN -->
<main class="main">
<div class="grid">
<!-- Left: Travellers table -->
<section class="card" style="grid-column: span 7;">
<h3>Active &amp; Upcoming Travellers</h3>
<p style="color:var(--muted);margin-top:4px">
            Track travelling staff and their locations. These records feed into the Global Protest Risk Map
            so you can see exposure to events.
          </p>
<table style="margin-top:10px">
<thead>
<tr>
<th>Name</th>
<th>Role</th>
<th>Phone</th>
<th>Email</th>
<th>City</th>
<th>Country</th>
<th>From</th>
<th>To</th>
<th style="width:80px">Actions</th>
</tr>
</thead>
<tbody id="travellersBody"></tbody>
</table>
</section>
<!-- Right: Traveller form -->
<section class="card" style="grid-column: span 5;">
<h3>Add / Edit Traveller</h3>
<p class="pill-hint">
            Add travellers with their trip window and hotel. Lat/Lon are optional but required if you want
            them visible on the map.
          </p>
<form id="travellerForm" style="margin-top:10px">
<input id="travIndex" type="hidden" value=""/>
<div class="form-grid">
<input id="travName" type="hidden"/>
<div class="grid2">
<div class="field">
<label for="travFirst">First name</label>
<input id="travFirst" placeholder="e.g. Jane" required=""/>
</div>
<div class="field">
<label for="travSurname">Surname</label>
<input id="travSurname" placeholder="e.g. Doe" required=""/>
</div>
</div>
<div class="field full">
<label for="travRole">Role / Title</label>
<input id="travRole" placeholder="e.g. Regional Sales Manager"/>
</div>
<div class="grid2">
<div class="field">
<label for="travPhone">Phone (optional)</label>
<input id="travPhone" placeholder="e.g. +44 7700 900123"/>
</div>
<div class="field">
<label for="travEmail">Email (optional)</label>
<input id="travEmail" placeholder="e.g. jane.doe@company.com"/>
</div>
</div>
<div class="field full">
<label for="travHotel">Hotel (optional)</label>
<input id="travHotel" placeholder="e.g. Hilton Midtown"/>
</div>
<div class="field full">
<label for="travAddress">Address (optional)</label>
<input id="travAddress" placeholder="e.g. 731 Lexington Ave, Manhattan"/>
</div>
<div class="field">
<label for="travPostcode">Postcode (optional)</label>
<input id="travPostcode" placeholder="e.g. E14 9SH"/>
</div>
<div class="field">
<label for="travCity">City</label>
<input id="travCity" placeholder="e.g. New York" required=""/>
</div>
<div class="field">
<label for="travCountry">Country</label>
<input id="travCountry" placeholder="e.g. United States" required=""/>
</div>
<div class="field">
<label for="travFrom">From</label>
<input id="travFrom" required="" type="date"/>
</div>
<div class="field">
<label for="travTo">To</label>
<input id="travTo" required="" type="date"/>
</div>
<div class="field">
<label for="travLat">Latitude</label>
<input id="travLat" placeholder="40.7617" step="0.000001" type="number"/>
</div>
<div class="field">
<label for="travLon">Longitude</label>
<input id="travLon" placeholder="-73.9696" step="0.000001" type="number"/>
</div>
<div class="field full">
<button class="btn" id="travGeoBtn" type="button">
                  Auto-locate from address, city &amp; country
                </button>
<div class="pill-hint">
                  You can paste a full address like "731 Lexington Ave, New York, USA" and we'll look up coordinates.
                </div>
</div>
</div>
<div style="display:flex;align-items:center;gap:8px;margin-top:14px">
<button class="btn" id="travSaveBtn" type="submit">Save traveller</button>
<button class="btn" id="travResetBtn" type="button">Clear form</button>
<button class="btn btn-danger" id="travDeleteBtn" style="margin-left:auto;display:none" type="button">
                Delete traveller
              </button>
</div>
</form>
</section>
</div>
</main>
</div>
<!-- Active nav highlight (fallback) -->
<script>
    (function () {
      const here = location.pathname.split("/").pop() || "travellers.html";
      document.querySelectorAll("aside.sidebar nav a").forEach(a=>{
        if ((here === "" && a.getAttribute("href")==="index.html") || here === a.getAttribute("href")) {
          a.classList.add("active");
        }
      });
    })();
  </script>
<!-- Auth + user menu -->
<script src="auth.js"></script>
<script>
  (function mountTopActions(){
    function host(){ return document.getElementById('topActions'); }

    function render(){
      const el = host();
      if (!el) return;

      if (!window.CIAuth){ el.innerHTML = ''; return; }

      if (CIAuth.isLoggedIn()){
        const u = CIAuth.who();
        const initials = (u.name||'CI').split(/\s+/).slice(0,2).map(s=>s[0]?.toUpperCase()||'').join('') || 'CI';
        const role = u.role || 'Analyst';
        el.innerHTML = `
          <div class="user" id="userChip" style="display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;background:#1c1e22;border:1px solid #2e3238;cursor:pointer">
            <div class="avatar" style="width:28px;height:28px;background:#fff;color:#000;border-radius:50%;display:grid;place-items:center;font-weight:700">${initials}</div>
            ${role}
          </div>
          <div class="dropdown" id="userMenu">
            <a href="settings.html">Settings</a>
            <a href="profile.html">Profile</a>
            <a href="#" id="logoutLink">Log out</a>
          </div>
        `;

        const chip = document.getElementById('userChip');
        const menu = document.getElementById('userMenu');
        chip.addEventListener('click', ()=> menu.style.display = (menu.style.display==='block'?'none':'block'));
        document.addEventListener('click', e => { if (!el.contains(e.target)) menu.style.display='none'; });
        document.getElementById('logoutLink').addEventListener('click', e=>{
          e.preventDefault();
          CIAuth.logout();
          window.dispatchEvent(new Event('ci:auth:logout'));
          render();
        });

      } else {
        const here = location.pathname.split('/').pop() || 'travellers.html';
        const next = encodeURIComponent(here + location.search + location.hash);
        el.innerHTML = `<a class="login-btn" href="login.html?next=${next}">Log in</a>`;
      }
    }

    document.addEventListener('DOMContentLoaded', render);
    window.addEventListener('ci:auth:login', render);
    window.addEventListener('ci:auth:logout', render);
    window.addEventListener('storage', (e)=>{
      if (['ci_user','ci_token'].includes(e.key)) render();
    });

    let tries = 10;
    const t = setInterval(()=>{
      if (--tries <= 0) clearInterval(t);
      render();
    }, 300);
  })();
  </script>
<script src="admin-links.js"></script>
<!-- Traveller management logic -->
<script>
    
  (async function travellerManager(){
  // --- elements ---
  const tbody = document.getElementById('travellersBody');
  const form = document.getElementById('travellerForm');

  const $ = (id)=>document.getElementById(id);

  const els = {
    first: $('travFirst'),
    surname: $('travSurname'),
    role: $('travRole'),
    phone: $('travPhone'),
    email: $('travEmail'),
    hotel: $('travHotel'),
    address: $('travAddress'),
    postcode: $('travPostcode'),
    city: $('travCity'),
    country: $('travCountry'),
    from: $('travFrom'),
    to: $('travTo'),
    lat: $('travLat'),
    lon: $('travLon'),
    cancelEdit: $('cancelEditBtn'),
    saveBtn: $('saveTravellerBtn'),
  };

  function escapeHtml(v){
    return String(v ?? '').replace(/[&<>"']/g, (c)=>({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[c]));
  }

  // Build headers expected by the Worker CORS policy (NO X-Authorization-Removed header)
  function authHeaders(){
    const sess = (window.CIAuth && typeof CIAuth.getSession === 'function') ? CIAuth.getSession() : null;
    const email = (sess && sess.email) || localStorage.getItem('ci_user_email') || localStorage.getItem('CI_USER_EMAIL') || '';
    const name  = (sess && sess.name)  || localStorage.getItem('ci_user_name')  || localStorage.getItem('CI_USER_NAME')  || '';
    const userId = (sess && sess.userId) || localStorage.getItem('ci_user_id') || localStorage.getItem('CI_USER_ID') || '';
    const adminToken = (sess && sess.adminToken) || localStorage.getItem('ci_admin_token') || localStorage.getItem('CI_ADMIN_TOKEN') || '';
    const h = { 'Content-Type': 'application/json' };
    if (email) h['X-User-Email'] = email;
    if (name)  h['X-User-Name']  = name;
    if (userId) h['X-User-Id']   = userId;
    if (adminToken) h['X-Admin-Token'] = adminToken;
    return h;
  }

  // Load travellers from the Worker API (org-scoped), with safe local fallback.
  // This avoids hard-failing the whole page if auth/org context isn't available yet.
  async function loadTravellersFromOrgOrLocal(fallbackList){
  const apiBase = (window.CI_API_BASE || 'https://api.cityintelapi.com').replace(/\/$/, '');
  const tryJson = async (url, opts) => {
    const r = await fetch(url, opts);
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.json();
  };

  // 1) Try WITHOUT auth headers first (avoids CORS preflight problems if the API doesn't allow X-Authorization-Removed).
  try{
    const data = await tryJson(`${apiBase}/api/org/travellers`, { headers: { 'Accept':'application/json' } });
    const list = Array.isArray(data) ? data : (data.travellers || data.items || data.rows || []);
    if(Array.isArray(list)){
      try{ localStorage.setItem('ci_travellers_cache', JSON.stringify(list)); }catch(_e){}
      return list;
    }
  }catch(_e){}

  // 2) Try WITH auth headers (requires Worker to include `X-Authorization-Removed` in Access-Control-Allow-Headers)
  try{
    const data = await tryJson(`${apiBase}/api/org/travellers`, { headers: { 'Accept':'application/json', ...authHeaders() } });
    const list = Array.isArray(data) ? data : (data.travellers || data.items || data.rows || []);
    if(Array.isArray(list)){
      try{ localStorage.setItem('ci_travellers_cache', JSON.stringify(list)); }catch(_e){}
      return list;
    }
  }catch(e){
    console.warn('Traveller API unavailable, using local fallback', e);
  }

  // 3) Local cache
  try{
    const cached = localStorage.getItem('ci_travellers_cache');
    if(cached) return JSON.parse(cached);
  }catch(_e){}

  // 4) Passed fallback list
  return Array.isArray(fallbackList) ? fallbackList : [];
}


  function splitName(full){
    const s = String(full ?? '').trim();
    if(!s) return { first_name:'', surname:'' };
    const parts = s.split(/\s+/);
    if(parts.length===1) return { first_name: parts[0], surname: '' };
    return { first_name: parts[0], surname: parts.slice(1).join(' ') };
  }

  function normaliseTraveller(t){
    const obj = (t && typeof t === 'object') ? t : {};
    const full = (obj.name ?? obj.full_name ?? '').toString().trim();
    const fn = (obj.first_name ?? '').toString().trim();
    const sn = (obj.surname ?? '').toString().trim();
    const derived = splitName(full);

    const first_name = fn || derived.first_name;
    const surname = sn || derived.surname;
    const name = (first_name || surname) ? `${first_name}${surname ? ' ' + surname : ''}`.trim() : full;

    return {
      id: obj.id || `trav-${Date.now()}-${Math.random().toString(16).slice(2)}`,
      first_name,
      surname,
      name,
      role: obj.role ?? '',
      phone: obj.phone ?? '',
      email: obj.email ?? '',
      hotel: obj.hotel ?? '',
      address: obj.address ?? '',
      postcode: obj.postcode ?? '',
      city: obj.city ?? '',
      country: obj.country ?? '',
      from: obj.from ?? '',
      to: obj.to ?? '',
      lat: (obj.lat ?? '') === null ? '' : (obj.lat ?? ''),
      lon: (obj.lon ?? '') === null ? '' : (obj.lon ?? ''),
    };
  }

  function clearForm(){
    form.dataset.editId = '';
    els.first.value = '';
    els.surname.value = '';
    els.role.value = '';
    els.phone.value = '';
    els.email.value = '';
    els.hotel.value = '';
    els.address.value = '';
    els.postcode.value = '';
    els.city.value = '';
    els.country.value = '';
    els.from.value = '';
    els.to.value = '';
    els.lat.value = '';
    els.lon.value = '';
    if(els.cancelEdit) els.cancelEdit.style.display = 'none';
    if(els.saveBtn) els.saveBtn.textContent = 'Save traveller';
  }

  function fillFormFromTraveller(t){
    const x = normaliseTraveller(t);
    form.dataset.editId = x.id;
    els.first.value = x.first_name || '';
    els.surname.value = x.surname || '';
    els.role.value = x.role || '';
    els.phone.value = x.phone || '';
    els.email.value = x.email || '';
    els.hotel.value = x.hotel || '';
    els.address.value = x.address || '';
    els.postcode.value = x.postcode || '';
    els.city.value = x.city || '';
    els.country.value = x.country || '';
    els.from.value = x.from || '';
    els.to.value = x.to || '';
    els.lat.value = x.lat ?? '';
    els.lon.value = x.lon ?? '';
    if(els.cancelEdit) els.cancelEdit.style.display = 'inline-flex';
    if(els.saveBtn) els.saveBtn.textContent = 'Update traveller';
  }

  function renderTable(list){
    if(!tbody) return;
    const rows = (list || []).map(normaliseTraveller);

    // Sort by from date then name (stable-ish)
    rows.sort((a,b)=>{
      const ad = a.from ? Date.parse(a.from) : 0;
      const bd = b.from ? Date.parse(b.from) : 0;
      if(ad !== bd) return ad - bd;
      return (a.name||'').localeCompare(b.name||'');
    });

    tbody.innerHTML = rows.map(t => `
      <tr data-id="${escapeHtml(t.id)}">
        <td>${escapeHtml(t.name)}</td>
        <td>${escapeHtml(t.role)}</td>
        <td>${escapeHtml(t.phone)}</td>
        <td>${escapeHtml(t.email)}</td>
        <td>${escapeHtml(t.city)}</td>
        <td>${escapeHtml(t.country)}</td>
        <td>${escapeHtml(t.from)}</td>
        <td>${escapeHtml(t.to)}</td>
        <td><button class="btn btn-sm" data-action="edit" data-id="${escapeHtml(t.id)}">Edit</button></td>
      </tr>
    `).join('');
  }

  async function loadTravellers(){
    try{
      const list = await loadTravellersFromOrgOrLocal([]);
      return Array.isArray(list) ? list : [];
    }catch(e){
      console.warn('Failed to load travellers, using local fallback', e);
      try{
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      }catch(_){
        return [];
      }
    }
  }

  async function saveTravellers(list){
  const payload = Array.isArray(list) ? list : [];
  const url = 'https://api.cityintelapi.com/api/org/travellers';
  try{
    const res = await fetch(url, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', ...authHeaders() },
      body: JSON.stringify({ travellers: payload }),
    });

    if(!res.ok){
      const txt = await res.text().catch(()=> '');
      throw new Error(`Save failed (${res.status}): ${txt || res.statusText}`);
    }

    // refresh cache
    try{ localStorage.setItem('ci_travellers_cache', JSON.stringify(payload)); }catch(_e){}
  }catch(e){
    // Most common failure on GitHub Pages is CORS preflight rejecting the X-Authorization-Removed header.
    console.warn('SaveTravellers error', e);
    throw e;
  }
}
  }

  // --- boot ---
  let travellers = (await loadTravellers()).map(normaliseTraveller);
  renderTable(travellers);

  // table events
  tbody?.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-action="edit"]');
    if(!btn) return;
    const id = btn.getAttribute('data-id');
    const t = travellers.find(x => String(x.id) === String(id));
    if(t) fillFormFromTraveller(t);
  });

  // cancel edit
  els.cancelEdit?.addEventListener('click', (e)=>{
    e.preventDefault();
    clearForm();
  });

  // submit
  form?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const editId = form.dataset.editId || '';
    const t = normaliseTraveller({
      id: editId || undefined,
      first_name: els.first.value,
      surname: els.surname.value,
      role: els.role.value,
      phone: els.phone.value,
      email: els.email.value,
      hotel: els.hotel.value,
      address: els.address.value,
      postcode: els.postcode.value,
      city: els.city.value,
      country: els.country.value,
      from: els.from.value,
      to: els.to.value,
      lat: els.lat.value,
      lon: els.lon.value,
    });

    if(!t.name){
      alert('Please enter at least a first name or surname.');
      return;
    }

    if(editId){
      travellers = travellers.map(x => String(x.id) === String(editId) ? t : x);
    }else{
      travellers = [...travellers, t];
    }

    try{
      await saveTravellers(travellers);
      // Reload from server so we reflect whatever the worker returns
      travellers = (await loadTravellers()).map(normaliseTraveller);
      renderTable(travellers);
      clearForm();
    }catch(err){
      console.error(err);
      alert(err?.message || 'Save failed.');
    }
  });

  // initial clear state
  clearForm();
})();;
</script>
</body>
</html>
