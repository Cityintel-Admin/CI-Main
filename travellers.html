<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CityIntel â€” Travellers</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="./CityintLogo.jpg">

  <style>
  /* ===== CityIntel theme + components ===== */
  :root{
    --brand-red:#D01616; --brand-black:#0C0C0C;
    --brand-gray-900:#111214; --brand-gray-800:#16171a; --brand-gray-700:#1c1e22;
    --brand-gray-600:#24272c; --brand-gray-500:#2e3238;
    --muted:#8e97a3; --text:#e9edf2; --ok:#33c48d; --warn:#f0b429; --danger:#ff5a5f;
    --card-radius:16px; --shadow:0 8px 24px rgba(0,0,0,0.35);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,var(--brand-gray-900),var(--brand-gray-800));
    color:var(--text); font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  }

  .app{
    display:grid; grid-template-columns:260px 1fr; grid-template-rows:60px auto 1fr;
    grid-template-areas:"sidebar topbar" "sidebar main" "sidebar main"; min-height:100vh;
  }
  .sidebar{
    grid-area:sidebar; background:linear-gradient(180deg,var(--brand-black),#131416);
    border-right:1px solid var(--brand-gray-600); display:flex; flex-direction:column; padding:18px 14px; gap:18px;
  }
  .brand{display:flex;align-items:center;gap:10px; padding:8px 10px; border-radius:12px;
    background:linear-gradient(90deg,rgba(208,22,22,0.2),rgba(208,22,22,0));}
  .brand img{width:34px;height:34px;object-fit:contain;border-radius:6px;background:#fff}
  .brand .title{font-weight:700;letter-spacing:.3px}
  nav a{display:flex;align-items:center;gap:10px;color:#e9edf2;text-decoration:none;
    padding:10px 12px;border-radius:10px;border:1px solid transparent}
  nav a:hover{background:#24272c;border-color:#2e3238}
  nav a.active{background:rgba(208,22,22,0.15);border-color:#D01616}

  .topbar{
    grid-area:topbar;background:rgba(255,255,255,0.02);border-bottom:1px solid var(--brand-gray-600);
    display:flex;align-items:center;gap:12px;padding:10px 16px;position:sticky;top:0;z-index:10;backdrop-filter:blur(8px)
  }
  .search{flex:1;display:flex;align-items:center;gap:10px;background:var(--brand-gray-700);
    border:1px solid var(--brand-gray-600);border-radius:12px;padding:8px 12px}
  .search input{flex:1;background:transparent;border:none;outline:none;color:var(--text)}

  .login-btn {
    display:inline-block;
    padding:8px 12px;
    border-radius:999px;
    background:#D01616;
    border:1px solid #9c0f0f;
    color:#fff;
    font-weight:700;
    text-decoration:none;
    white-space:nowrap;
  }
  .login-btn:hover { filter:brightness(1.05); }

  .user { display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:12px; background:var(--brand-gray-700); border:1px solid var(--brand-gray-600); cursor:pointer; }
  .avatar { width:28px;height:28px; background:#fff;color:#000;border-radius:50%; display:grid;place-items:center;font-weight:700; }

  .dropdown {
    position:absolute; right:0; top:calc(100% + 6px);
    background:#1a1c20; border:1px solid var(--brand-gray-600); border-radius:10px;
    padding:6px 0; box-shadow:0 4px 12px rgba(0,0,0,0.4);
    display:none; min-width:140px; z-index:50;
  }
  .dropdown a { display:block; padding:8px 12px; color:var(--text); text-decoration:none; font-size:14px; }
  .dropdown a:hover { background:rgba(255,255,255,0.05); }

  .main{grid-area:main;padding:18px}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}

  .card{background:linear-gradient(180deg,#1a1c20,#131417);border:1px solid var(--brand-gray-600);
    border-radius:var(--card-radius);box-shadow:var(--shadow);padding:16px}
  .card h3{margin:0 0 10px 0;font-size:16px;letter-spacing:.2px}

  table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:12px}
  thead th{text-align:left;font-size:12px;color:var(--muted);background:var(--brand-gray-700);padding:10px;border-bottom:1px solid var(--brand-gray-600)}
  tbody td{padding:10px;border-bottom:1px solid var(--brand-gray-600);font-size:13px}
  tr:hover td{background:rgba(255,255,255,0.02)}

  .badge{
    display:inline-block;
    padding:2px 8px;
    border-radius:999px;
    font-size:11px;
    border:1px solid rgba(255,255,255,0.15);
    background:rgba(255,255,255,0.06);
  }

  .btn{
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--brand-gray-600);
    background:var(--brand-gray-700);
    color:var(--text);
    font-size:13px;
    cursor:pointer;
  }
  .btn:hover{background:#24272c}
  .btn-danger{
    border-color:#5c2b2b;
    background:rgba(92,43,43,0.4);
    color:#ff7a7f;
  }
  .btn-danger:hover{background:rgba(92,43,43,0.8)}

  .form-grid{
    display:grid;
    grid-template-columns:repeat(2, minmax(0,1fr));
    gap:10px;
  }
  .form-grid .full{grid-column:1/-1}
  .field{
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .field label{
    font-size:12px;
    color:var(--muted);
  }
  .field input,
  .field select{
    padding:6px 8px;
    border-radius:8px;
    border:1px solid var(--brand-gray-600);
    background:var(--brand-gray-800);
    color:var(--text);
    font-size:13px;
  }
  .field input:focus,
  .field select:focus{
    outline:none;
    border-color:#D01616;
  }

  .pill-hint{
    font-size:12px;
    color:var(--muted);
    margin-top:6px;
  }

  @media (max-width:1100px){
    .app{grid-template-columns:68px 1fr}
    .brand .title,nav span{display:none}
    .sidebar{padding:14px 10px}
  }
  @media (max-width:880px){
    .grid{grid-template-columns:1fr}
  }


/* ===== Mobile layout tweaks ===== */
@media (max-width: 720px) {
  /* Stack layout: topbar, sidebar row, then main content */
  .app{
    grid-template-columns: 1fr;
    grid-template-rows: auto auto 1fr;
    grid-template-areas:
      "topbar"
      "sidebar"
      "main";
  }

  .sidebar{
    border-right: none;
    border-top: 1px solid var(--brand-gray-600);
    flex-direction: row;
    align-items: center;
    gap: 8px;
    padding: 8px;
    overflow-x: auto;
    white-space: nowrap;
  }

  .sidebar nav{
    display: flex;
    flex-wrap: nowrap;
    gap: 8px;
  }

  .sidebar nav a{
    font-size: 12px;
    padding: 6px 10px;
    white-space: nowrap;
  }

  .brand{
    flex-shrink: 0;
  }

  .main{
    padding: 10px;
  }

  .card{
    padding: 12px;
  }

  /* Map + heatmap sizing on small screens */
  #riskMap{
    height: 320px;
  }

  #risk-heatmap .cell{
    width: 72px;
    height: 52px;
    font-size: 10px;
  }

  /* Map toolbar (search + window slider) stack nicely */
  .risk-toolbar{
    flex-direction: column;
    align-items: stretch;
    gap: 6px;
  }
}

    
  </style>
</head>
<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">
        <img src="CityintLogo.jpg" alt="CityIntel Logo" />
        <div class="title">CityIntel</div>
      </div>
      <nav>
        <a href="index.html">Dashboard</a>
		    <a href="alerts.html">Alerts</a>
        <a href="events.html">Events</a>
		    <a href="test.html">Test Feed</a>  
	      <a href="brief.html">Intelligence Brief</a>
	      <a href="trends.html">Trends & Forecasts</a>
        <a href="reports.html">Reports</a>
		    <a href="sources.html">Sources</a>
        <a href="settings.html">Settings</a>
        <a href="about.html">About</a>
        <!-- current page -->
        <a href="travellers.html" class="active">Travellers</a>
      </nav>
    </aside>

    <!-- TOPBAR -->
    <header class="topbar">
      <div class="search">ðŸ”Ž <input placeholder="Search travellers, citiesâ€¦" /></div>
      <div id="topActions" style="position:relative"></div>
    </header>

    <!-- MAIN -->
    <main class="main">
      <div class="grid">
        <!-- Left: Travellers table -->
        <section class="card" style="grid-column: span 7;">
          <h3>Active & Upcoming Travellers</h3>
          <p style="color:var(--muted);margin-top:4px">
            Track travelling staff and their locations. These records feed into the Global Protest Risk Map
            so you can see exposure to events.
          </p>

          <table style="margin-top:10px">
            <thead>
              <tr>
                <th>Name</th>
                <th>Role</th>
                <th>Phone</th>
                <th>Email</th>
                <th>City</th>
                <th>Country</th>
                <th>From</th>
                <th>To</th>
                <th style="width:80px">Actions</th>
              </tr>
            </thead>
            <tbody id="travellersBody"></tbody>
          </table>
        </section>

        <!-- Right: Traveller form -->
        <section class="card" style="grid-column: span 5;">
          <h3>Add / Edit Traveller</h3>
          <p class="pill-hint">
            Add travellers with their trip window and hotel. Lat/Lon are optional but required if you want
            them visible on the map.
          </p>

          <form id="travellerForm" style="margin-top:10px">
            <input type="hidden" id="travIndex" value="">
            <div class="form-grid">
              
              <input type="hidden" id="travName">
              <div class="grid2">
                <div class="field">
                  <label for="travFirst">First name</label>
                  <input id="travFirst" required placeholder="e.g. Jane">
                </div>
                <div class="field">
                  <label for="travSurname">Surname</label>
                  <input id="travSurname" required placeholder="e.g. Doe">
                </div>
              </div>
              <div class="field full">
                <label for="travRole">Role / Title</label>
                <input id="travRole" placeholder="e.g. Regional Sales Manager">
              </div>

              <div class="grid2">
                <div class="field">
                  <label for="travPhone">Phone (optional)</label>
                  <input id="travPhone" placeholder="e.g. +44 7700 900123">
                </div>
                <div class="field">
                  <label for="travEmail">Email (optional)</label>
                  <input id="travEmail" placeholder="e.g. jane.doe@company.com">
                </div>
              </div>
              <div class="field full">
                <label for="travHotel">Hotel (optional)</label>
                <input id="travHotel" placeholder="e.g. Hilton Midtown">
              </div>
              
              <div class="field full">
                <label for="travAddress">Address (optional)</label>
                <input id="travAddress" placeholder="e.g. 731 Lexington Ave, Manhattan">
              </div>
             <div class="field">
               <label for="travPostcode">Postcode (optional)</label>
               <input id="travPostcode" placeholder="e.g. E14 9SH">
             </div>
              
              <div class="field">
                <label for="travCity">City</label>
                <input id="travCity" required placeholder="e.g. New York">
              </div>
              <div class="field">
                <label for="travCountry">Country</label>
                <input id="travCountry" required placeholder="e.g. United States">
              </div>
              
              <div class="field">
                <label for="travFrom">From</label>
                <input id="travFrom" type="date" required>
              </div>
              <div class="field">
                <label for="travTo">To</label>
                <input id="travTo" type="date" required>
              </div>
              <div class="field">
                <label for="travLat">Latitude</label>
                <input id="travLat" type="number" step="0.000001" placeholder="40.7617">
              </div>
              <div class="field">
                <label for="travLon">Longitude</label>
                <input id="travLon" type="number" step="0.000001" placeholder="-73.9696">
              </div>

              <div class="field full">
                <button type="button" class="btn" id="travGeoBtn">
                  Auto-locate from address, city &amp; country
                </button>
                <div class="pill-hint">
                  You can paste a full address like "731 Lexington Ave, New York, USA" and we'll look up coordinates.
                </div>
              </div>
            </div>

            <div style="display:flex;align-items:center;gap:8px;margin-top:14px">
              <button type="submit" class="btn" id="travSaveBtn">Save traveller</button>
              <button type="button" class="btn" id="travResetBtn">Clear form</button>
              <button type="button" class="btn btn-danger" id="travDeleteBtn" style="margin-left:auto;display:none">
                Delete traveller
              </button>
            </div>
          </form>
        </section>
      </div>
    </main>
  </div>

  <!-- Active nav highlight (fallback) -->
  <script>
    (function () {
      const here = location.pathname.split("/").pop() || "travellers.html";
      document.querySelectorAll("aside.sidebar nav a").forEach(a=>{
        if ((here === "" && a.getAttribute("href")==="index.html") || here === a.getAttribute("href")) {
          a.classList.add("active");
        }
      });
    })();
  </script>

  <!-- Auth + user menu -->
  <script src="auth.js"></script>
  <script>
  (function mountTopActions(){
    function host(){ return document.getElementById('topActions'); }

    function render(){
      const el = host();
      if (!el) return;

      if (!window.CIAuth){ el.innerHTML = ''; return; }

      if (CIAuth.isLoggedIn()){
        const u = CIAuth.who();
        const initials = (u.name||'CI').split(/\s+/).slice(0,2).map(s=>s[0]?.toUpperCase()||'').join('') || 'CI';
        const role = u.role || 'Analyst';
        el.innerHTML = `
          <div class="user" id="userChip" style="display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;background:#1c1e22;border:1px solid #2e3238;cursor:pointer">
            <div class="avatar" style="width:28px;height:28px;background:#fff;color:#000;border-radius:50%;display:grid;place-items:center;font-weight:700">${initials}</div>
            ${role}
          </div>
          <div class="dropdown" id="userMenu">
            <a href="settings.html">Settings</a>
            <a href="profile.html">Profile</a>
            <a href="#" id="logoutLink">Log out</a>
          </div>
        `;

        const chip = document.getElementById('userChip');
        const menu = document.getElementById('userMenu');
        chip.addEventListener('click', ()=> menu.style.display = (menu.style.display==='block'?'none':'block'));
        document.addEventListener('click', e => { if (!el.contains(e.target)) menu.style.display='none'; });
        document.getElementById('logoutLink').addEventListener('click', e=>{
          e.preventDefault();
          CIAuth.logout();
          window.dispatchEvent(new Event('ci:auth:logout'));
          render();
        });

      } else {
        const here = location.pathname.split('/').pop() || 'travellers.html';
        const next = encodeURIComponent(here + location.search + location.hash);
        el.innerHTML = `<a class="login-btn" href="login.html?next=${next}">Log in</a>`;
      }
    }

    document.addEventListener('DOMContentLoaded', render);
    window.addEventListener('ci:auth:login', render);
    window.addEventListener('ci:auth:logout', render);
    window.addEventListener('storage', (e)=>{
      if (['ci_user','ci_token'].includes(e.key)) render();
    });

    let tries = 10;
    const t = setInterval(()=>{
      if (--tries <= 0) clearInterval(t);
      render();
    }, 300);
  })();
  </script>

  <script src="admin-links.js"></script>

  <!-- Traveller management logic -->
  <script>
    
  (async function travellerManager(){
    const STORAGE_KEY = 'ci_travellers';

    function seedFromGlobal(){
      return Array.isArray(window.CITravellers) ? window.CITravellers : [];
    }

    function loadTravellers(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return seedFromGlobal();
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : seedFromGlobal();
      } catch(e){
        console.warn('Failed to parse ci_travellers from localStorage', e);
        return seedFromGlobal();
      }
    }

    async function authHeaders(){
  const me = (window.CIAuth && CIAuth.who && CIAuth.who()) || null;
  if (!me?.email) throw new Error('Not logged in (missing CIAuth user)');
  return {
    'Content-Type': 'application/json',
    'X-User-Email': me.email,
    'X-User-Name': me.name || '',
    'X-User-Id': me.id || ''
  };
}

async function saveTravellers(list){
  // local first (keeps UI snappy)
  localStorage.setItem('ci_travellers', JSON.stringify(list));
  window.CITravellers = list;

  // push to org (shared)
  try{
    const headers = await authHeaders();
    await fetch('https://api.cityintelapi.com/api/org/travellers', {
      method: 'PUT',
      headers,
      body: JSON.stringify(list)
    });
  }catch(e){
    console.warn('Org traveller save failed (still saved locally):', e);
  }
}

    
async function loadTravellersFromOrgOrLocal(seed){
  try{
    const headers = await authHeaders();
    const res = await fetch('https://api.cityintelapi.com/api/org/travellers', { headers });
    const json = await res.json();
    if (json?.ok && Array.isArray(json.data)) {
      localStorage.setItem('ci_travellers', JSON.stringify(json.data));
      window.CITravellers = json.data;
      return json.data;
    }
  }catch(e){
    console.warn('Org traveller load failed, using local:', e);
  }
  return seed;
}


    let travellers = await loadTravellersFromOrgOrLocal(loadTravellers());


    const tbody        = document.getElementById('travellersBody');
    const form         = document.getElementById('travellerForm');
    const idxInput     = document.getElementById('travIndex');
    const firstInput   = document.getElementById('travFirst');
    const surnameInput = document.getElementById('travSurname');
    const phoneInput   = document.getElementById('travPhone');
    const emailInput   = document.getElementById('travEmail');
    const nameInput    = document.getElementById('travName');
    const roleInput    = document.getElementById('travRole');
    const hotelInput   = document.getElementById('travHotel');
    const addressInput = document.getElementById('travAddress');
    const postcodeInput  = document.getElementById('travPostcode');
    const cityInput    = document.getElementById('travCity');
    const countryInput = document.getElementById('travCountry');
    const fromInput    = document.getElementById('travFrom');
    const toInput      = document.getElementById('travTo');
    const latInput     = document.getElementById('travLat');
    const lonInput     = document.getElementById('travLon');
    const resetBtn     = document.getElementById('travResetBtn');
    const deleteBtn    = document.getElementById('travDeleteBtn');
    const geoBtn       = document.getElementById('travGeoBtn');

    function renderTable(){
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!travellers.length){
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="color:#8e97a3;padding:10px">
              No travellers yet. Use the form on the right to add active or upcoming trips.
            </td>
          </tr>`;
        return;
      }

      travellers.forEach((t, idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${t.name || ''}</td>
          <td>${t.role || ''}</td>
          <td>${t.city || ''}</td>
          <td>${t.country || ''}</td>
          <td>${t.from || ''}</td>
          <td>${t.to || ''}</td>
          <td>
            <button class="btn" data-action="edit" data-idx="${idx}" style="padding:3px 8px;font-size:11px;">Edit</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function clearForm(){
      idxInput.value = '';
      nameInput.value = '';
      if (firstInput) firstInput.value = '';
      if (surnameInput) surnameInput.value = '';
      roleInput.value = '';
      if (phoneInput) phoneInput.value = '';
      if (emailInput) emailInput.value = '';
      hotelInput.value = '';
      addressInput.value = '';
      postcodeInput.value = '';
      cityInput.value = '';
      countryInput.value = '';
      fromInput.value = '';
      toInput.value = '';
      latInput.value = '';
      lonInput.value = '';
      deleteBtn.style.display = 'none';
    }

    function fillFormFromTraveller(t, idx){
      idxInput.value = String(idx);
      const displayName = (t.first_name || t.surname) ? [t.first_name, t.surname].filter(Boolean).join(' ').trim() : (t.name || '');
      const parts = displayName.split(/\s+/).filter(Boolean);
      nameInput.value = displayName;
      if (firstInput) firstInput.value = t.first_name || parts.shift() || '';
      if (surnameInput) surnameInput.value = t.surname || parts.join(' ') || '';
      if (phoneInput) phoneInput.value = t.phone || '';
      if (emailInput) emailInput.value = t.email || '';
      
      roleInput.value = t.role || '';
      hotelInput.value = t.hotel || '';
      addressInput.value = t.address || '';
      postcodeInput.value = t.postcode || '';
      cityInput.value = t.city || '';
      countryInput.value = t.country || '';
      fromInput.value = t.from || '';
      toInput.value = t.to || '';
      latInput.value = (typeof t.lat === 'number') ? t.lat : (t.lat || '');
      lonInput.value = (typeof t.lon === 'number') ? t.lon : (t.lon || '');
      deleteBtn.style.display = 'inline-block';
    }

    // Table edit click
    if (tbody){
      tbody.addEventListener('click', e=>{
        const btn = e.target.closest('button[data-action="edit"]');
        if (!btn) return;
        const idx = parseInt(btn.getAttribute('data-idx'), 10);
        if (isNaN(idx) || !travellers[idx]) return;
        fillFormFromTraveller(travellers[idx], idx);
      });
    }

    // Auto-locate using address/city/country
    if (geoBtn){
  geoBtn.addEventListener('click', async () => {
    const addr = addressInput.value.trim();
    const pc   = postcodeInput.value.trim();
    const city = cityInput.value.trim();
    const ctry = countryInput.value.trim();
    const name = (((firstInput?.value||'') + ' ' + (surnameInput?.value||'')).trim() || nameInput.value.trim());

    let parts;
    if (addr || pc) {
      // Prefer detailed address + postcode when available
      parts = [addr, pc, city, ctry];
    } else {
      // Fallback: name + city + country
      parts = [name, city, ctry];
    }

    parts = parts.filter(Boolean);
    if (!parts.length){
      alert('Please enter at least city and country first.');
      return;
    }

        const query = parts.join(', ');

        try {
          geoBtn.textContent = 'Locating...';
          geoBtn.disabled = true;

          const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`;
          const res = await fetch(url, { headers:{'Accept':'application/json'} });
          const data = await res.json();
          console.log('Traveller geo result for', query, data);

          if (!Array.isArray(data) || !data.length){
            alert('Location not found. Try adjusting the address or country.');
          } else {
            latInput.value = Number(data[0].lat).toFixed(6);
            lonInput.value = Number(data[0].lon).toFixed(6);
          }
        } catch (err) {
          console.error('Traveller geo lookup failed', err);
          alert('Geocoding error. Please try again.');
        } finally {
          geoBtn.textContent = 'Auto-locate from address, city & country';
          geoBtn.disabled = false;
        }
      });
    }

    // Save traveller
    if (form){
      form.addEventListener('submit', e=>{
        e.preventDefault();
        const idx = idxInput.value === '' ? -1 : parseInt(idxInput.value, 10);

        const base = {
  id: (idx >= 0 && travellers[idx] && travellers[idx].id) ||
      `trav-${Date.now()}-${Math.random().toString(16).slice(2,6)}`,

  first_name: (firstInput?.value || '').trim(),
  surname: (surnameInput?.value || '').trim(),
  full_name: (((firstInput?.value || '') + ' ' + (surnameInput?.value || '')).trim() || nameInput.value.trim()),
  name: (((firstInput?.value || '') + ' ' + (surnameInput?.value || '')).trim() || nameInput.value.trim()),
  phone: (phoneInput?.value || '').trim(),
  email: (emailInput?.value || '').trim(),
  role: roleInput.value.trim(),
  hotel: hotelInput.value.trim(),
  address: addressInput.value.trim(),
  postcode: postcodeInput.value.trim(),   // âœ… add this
  city: cityInput.value.trim(),
  country: countryInput.value.trim(),
  from: fromInput.value,
  to: toInput.value
};

        const lat = parseFloat(latInput.value);
        const lon = parseFloat(lonInput.value);
        if (!isNaN(lat)) base.lat = lat;
        if (!isNaN(lon)) base.lon = lon;

        if (!base.name || !base.city || !base.country || !base.from || !base.to){
          alert('Please fill in at least name, city, country, from and to dates.');
          return;
        }

        if (idx >= 0 && travellers[idx]){
          travellers[idx] = Object.assign({}, travellers[idx], base);
        } else {
          travellers.push(base);
        }

        saveTravellers(travellers);
        renderTable();
        clearForm();
      });
    }

    // Clear form
    if (resetBtn){
      resetBtn.addEventListener('click', e=>{
        e.preventDefault();
        clearForm();
      }); 
    }

    // Delete traveller
    if (deleteBtn){
      deleteBtn.addEventListener('click', e=>{
        e.preventDefault();
        const idx = idxInput.value === '' ? -1 : parseInt(idxInput.value, 10);
        if (idx < 0 || !travellers[idx]) return;
        if (!confirm(`Delete traveller "${travellers[idx].name}"?`)) return;
        travellers.splice(idx,1);
        saveTravellers(travellers);
        renderTable();
        clearForm();
      });
    }

    // Initial render
    renderTable();
  })();
  </script>
</body>
</html>
