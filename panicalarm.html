<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CityIntel — Panic Alarm</title>
  <script src="auth.js"></script>
  <style>
    :root{--brand-red:#D01616;--bg:#0f1114;--panel:#15181d;--line:#2a2f36;--text:#e9edf2;--muted:#8e97a3}
    body{margin:0;font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b0c0e,#111214);color:var(--text)}
    .wrap{max-width:860px;margin:28px auto;padding:20px}
    .card{background:linear-gradient(180deg,#161a20,#121419);border:1px solid var(--line);border-radius:16px;padding:16px;margin-bottom:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:#0e1116;color:var(--text);font-weight:700}
    .pill.ok{border-color:rgba(51,196,141,.35);background:rgba(51,196,141,.10);color:#bff4df}
    .pill.bad{border-color:rgba(255,90,95,.35);background:rgba(255,90,95,.12);color:#ffd3d4}
    .btn{border:none;border-radius:999px;padding:12px 16px;font-weight:800;cursor:pointer}
    .btn.primary{background:var(--brand-red);color:white;border:1px solid #9c0f0f}
    .btn.neutral{background:#fff;color:#111;border:1px solid #cfd3d8}
    .btn.danger{background:#ff5a5f;color:#111;border:1px solid #d34b4f}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    input, textarea{width:100%;max-width:100%;box-sizing:border-box;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#0e1116;color:var(--text)}
    textarea{min-height:90px;resize:vertical}
    .muted{color:var(--muted)}
    .tiny{font-size:12px}
    a{color:#e9edf2}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <h2 style="margin:0">Panic Alarm</h2>
        <a href="index.html" class="muted" style="text-decoration:none">Back to Dashboard</a>
      </div>
      <p class="muted" style="margin:8px 0 0">
        Use this only in an emergency test / real scenario. This will notify everyone in your organisation.
      </p>
    </div>

    <div class="card" id="loginCard" style="display:none">
      <h3 style="margin:0 0 6px">You’re not signed in</h3>
      <p class="muted" style="margin:0 0 10px">Please log in first.</p>
      <a class="btn primary" href="login.html?next=panicalarm.html" style="display:inline-block;text-decoration:none">Log in</a>
    </div>

    <div class="card" id="mainCard" style="display:none">
      <div class="row" style="align-items:flex-start">
        <div>
          <div id="statusPill" class="pill">Loading…</div>
          <div class="tiny muted" id="statusMeta" style="margin-top:6px"></div>
        </div>
        <div class="row" style="justify-content:flex-end">
          <button class="btn neutral" id="btnRefresh" type="button">Refresh</button>
        </div>
      </div>

      <hr style="margin:14px 0;opacity:.2" />

      <div style="display:grid;grid-template-columns:1fr;gap:12px">
        <div>
          <label style="display:block;font-weight:700;margin:0 0 6px">Message (optional)</label>
          <textarea id="panicMessage" placeholder="e.g. I need urgent assistance at [location]."></textarea>
          <div class="tiny muted" style="margin-top:6px">Tip: include your location and what you need.</div>
        </div>

        <div class="row" style="justify-content:flex-start">
          <button class="btn danger" id="btnActivate" type="button">Activate Panic Alarm</button>
          <button class="btn neutral" id="btnCancel" type="button">Reset Panic Alarm</button>
        </div>

        <div class="tiny muted" id="msgLine"></div>
      </div>
    </div>
  </div>

<script>
(function pageGuard(){
  if (!window.CIAuth || !CIAuth.isLoggedIn || !CIAuth.isLoggedIn()){
    document.getElementById('loginCard').style.display = '';
    return;
  }
  document.getElementById('mainCard').style.display = '';
})();
</script>

<script>
(function(){
  const API_BASE = (window.API_BASE) || 'https://api.cityintelapi.com';

  const el = {
    pill: document.getElementById('statusPill'),
    meta: document.getElementById('statusMeta'),
    msg:  document.getElementById('panicMessage'),
    line: document.getElementById('msgLine'),
    activate: document.getElementById('btnActivate'),
    cancel: document.getElementById('btnCancel'),
    refresh: document.getElementById('btnRefresh'),
  };

  function setLine(t){ el.line.textContent = t || ''; }

  function getAuthHeaders(){
    const u = (window.CIAuth && CIAuth.who && CIAuth.who()) || null;
    if (!u?.email) throw new Error('Not logged in');
    return {
      'Content-Type':'application/json',
      'X-User-Email': u.email,
      'X-User-Name': u.name || '',
      'X-User-Id': u.id || ''
    };
  }

  async function api(path, opts={}){
    const headers = { ...(opts.headers||{}), ...getAuthHeaders() };
    const res = await fetch(API_BASE + path, { ...opts, headers });
    const json = await res.json().catch(()=> ({}));
    if (!res.ok || json?.ok === false) throw new Error(json?.error || ('HTTP '+res.status));
    return json;
  }

  function render(payload){
    const p = payload?.data || payload || {};
    const active = !!p.active;

    el.pill.className = 'pill ' + (active ? 'bad' : 'ok');
    el.pill.textContent = active ? 'PANIC ALARM ACTIVE' : 'No active panic alarm';
    const by = p.byEmail || p.by || '—';
    const at = p.at ? new Date(p.at).toLocaleString() : '—';
    const note = p.note || '';
    el.meta.textContent =
      (active ? `Activated by: ${by} • ${at}` : `Last update: ${at}`) + (note ? ` • Note: ${note}` : '');
  }

  async function load(){
    setLine('Loading status…');
    try{
      const res = await api('/api/org/panic', { method:'GET' });
      render(res);
      setLine('');
    }catch(e){
      setLine('Could not load panic status: ' + e.message);
    }
  }

  async function setPanic(active){
    const u = CIAuth.who();
    const now = new Date().toISOString();
    if (active){
      const payload = {
        active: true,
        at: now,
        byEmail: u.email,
        byName: u.name || '',
        note: (el.msg.value || '').trim()
      };
      await api('/api/org/panic', { method:'PUT', body: JSON.stringify(payload) });
    } else {
      const reason = prompt('Cancel / reset note (optional):', 'Resolved / false alarm') || '';
      const payload = {
        active: false,
        at: now,
        byEmail: u.email,
        byName: u.name || '',
        note: reason.trim()
      };
      await api('/api/org/panic', { method:'PUT', body: JSON.stringify(payload) });
    }
  }

  el.refresh.addEventListener('click', load);

  el.activate.addEventListener('click', async ()=>{
    if (!confirm('Activate panic alarm for your organisation?')) return;
    el.activate.disabled = true;
    try{
      await setPanic(true);
      await load();
      setLine('Panic Alarm Activated.');
    }catch(e){
      setLine('Activate failed: ' + e.message);
    }finally{
      el.activate.disabled = false;
    }
  });

  el.cancel.addEventListener('click', async ()=>{
    if (!confirm('Cancel / reset the panic alarm for your organisation?')) return;
    el.cancel.disabled = true;
    try{
      await setPanic(false);
      await load();
      setLine('Panic Alarm Cleared.');
    }catch(e){
      setLine('Reset failed: ' + e.message);
    }finally{
      el.cancel.disabled = false;
    }
  });

  load();
  setInterval(load, 10000);
})();
</script>
</body>
</html>
