<!doctype html>
<html lang="en">
<head>
  <script src="auth.js"></script>

  <script>
(function pageGuard(){
  const NEED_LOGIN = true;          // this page requires a login
  const NEED_SUB = false;           // set to true on pages that require an active sub

  // Must be logged in?
  if (NEED_LOGIN && (!window.CIAuth || !CIAuth.isLoggedIn())) {
    const here = location.pathname.split('/').pop() || 'index.html';
    const next = encodeURIComponent(here + location.search + location.hash);
    location.href = 'login.html?next=' + next;
    return;
  }

  // Must be subscribed?
  if (NEED_SUB) {
    const isSub = localStorage.getItem('ci_subscribed') === 'true';
    if (!isSub) {
      location.href = 'subscribe.html';
      return;
    }
  }
})();
</script>

  <script>
(function compatProfileShim(){
  if (!window.CIAuth || !CIAuth.isLoggedIn()) return;
  const u = CIAuth.who();
  if (!u) return;
  localStorage.setItem('ci_profile', JSON.stringify({
    name: u.name || 'CityIntel User',
    email: u.email,
    role: u.role || 'Admin',
    is_admin: (u.role||'').toLowerCase()==='admin'
  }));
  // Do NOT auto-set ci_subscribed here anymore
})();
</script>

  <script src="metrics.js"></script>

  <meta charset="utf-8" />
  <title>CityIntel — Panic Alarm</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{--brand-red:#D01616;--gray-900:#111214;--gray-800:#16171a;--gray-700:#1c1e22;--gray-600:#24272c;--gray-500:#2e3238;--text:#e9edf2}
    body{margin:0;font:14px/1.5 system-ui;background:linear-gradient(180deg,var(--gray-900),var(--gray-800));color:var(--text)}
    .app{display:grid;grid-template-columns:260px 1fr;grid-template-rows:60px 1fr;grid-template-areas:"sidebar topbar" "sidebar main";min-height:100vh}
    .sidebar{grid-area:sidebar;background:#0c0c0c;border-right:1px solid var(--gray-600);display:flex;flex-direction:column;padding:18px 14px;gap:18px}
    .brand{display:flex;align-items:center;gap:10px;padding:8px 10px;background:rgba(208,22,22,0.1);border-radius:12px}
    .brand img{width:34px;height:34px;background:#fff;border-radius:6px}
    nav a{display:flex;align-items:center;padding:10px 12px;border-radius:10px;text-decoration:none;color:var(--text);border:1px solid transparent}
    nav a:hover{background:var(--gray-600);border-color:var(--gray-500)}
    nav a.active{background:rgba(208,22,22,0.15);border-color:var(--brand-red)}
    .sidebar .footnote{margin-top:auto;font-size:12px;color:#8e97a3}
    .topbar{ grid-area: topbar;background: rgba(255,255,255,0.02);border-bottom:1px solid var(--brand-gray-600);display:flex; align-items:center; gap:12px;
      padding:10px 16px;position:sticky; top:0; z-index:10;backdrop-filter: blur(8px);}
    .search{flex:1;display:flex; align-items:center; gap:10px;background:var(--brand-gray-700);border:1px solid var(--brand-gray-600);
      border-radius:12px; padding:8px 12px;min-width: 0;}
    .search input{flex:1; min-width:0;background:transparent; border:none; outline:none; color:var(--text);}

    #topActions{margin-left:auto;display:flex; align-items:center; gap:10px;min-width: fit-content;position: relative;}

    .main{grid-area:main;padding:20px}
    .card{background:#16171a;border:1px solid var(--gray-600);border-radius:16px;padding:16px;margin-bottom:20px}
    .login-btn{ display:inline-block;padding:8px 12px;border-radius:999px;background:#D01616;
      border:1px solid #9c0f0f;color:#fff;font-weight:700;text-decoration:none;white-space:nowrap;
    }
    .login-btn:hover{filter:brightness(1.05)}
    .user{ display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;
      background:#1c1e22;border:1px solid #24272c;cursor:pointer;
    }
    .avatar{ width:28px;height:28px;background:#fff;color:#000;border-radius:50%;
      display:grid;place-items:center;font-weight:700;
    }
    .dropdown{ position:absolute;right:0;top:calc(100% + 6px);background:#1a1c20;border:1px solid #24272c;
      border-radius:10px;padding:6px 0;box-shadow:0 4px 12px rgba(0,0,0,.4);display:none;min-width:140px;z-index:50;
    }
    .dropdown a{display:block;padding:8px 12px;color:#e9edf2;text-decoration:none;font-size:14px}
    .dropdown a:hover{background:rgba(255,255,255,0.05)}

    .brandbar{display:flex;align-items:center;gap:10px;padding:16px 20px;border-bottom:1px solid rgba(255,255,255,.08);
      background:linear-gradient(90deg,rgba(208,22,22,.2),rgba(208,22,22,0))}
    .brandbar img{width:auto;height:60px;object-fit:contain;border-radius:6px;background:#fff}

    /* ===== Mobile layout tweaks ===== */
    @media (max-width: 720px) {
      .app{
        grid-template-columns: 1fr;
        grid-template-rows: auto auto 1fr;
        grid-template-areas:
          "topbar"
          "sidebar"
          "main";
      }
      .sidebar{
        border-right: none;
        border-top: 1px solid var(--brand-gray-600);
        flex-direction: row;
        align-items: center;
        gap: 8px;
        padding: 8px;
        overflow-x: auto;
        white-space: nowrap;
      }
      .sidebar nav{display:flex;flex-wrap:nowrap;gap:8px}
      .sidebar nav a{font-size:12px;padding:6px 10px;white-space:nowrap}
      .brand{flex-shrink:0}
      .main{padding:10px}
      .card{padding:12px}
    }
  </style>

  <style>
    .page { max-width: 1120px; margin: 0 auto; padding: 22px 18px 60px; }
    .page-header { display:flex; align-items:flex-start; justify-content:space-between; gap:16px; margin-bottom:16px; }
    .page-header h1 { font-size: 34px; line-height:1.1; margin:0 0 6px; }
    .muted { color: rgba(255,255,255,.72); }
    .grid-2 { display:grid; grid-template-columns: 360px 1fr; gap:18px; }
    @media (max-width: 980px){ .grid-2 { grid-template-columns: 1fr; } }
    .card { background: rgba(18,18,18,.72); border: 1px solid rgba(255,255,255,.08); border-radius: 18px; padding:18px; box-shadow: 0 10px 30px rgba(0,0,0,.35); backdrop-filter: blur(10px); }
    .divider { height:1px; background: rgba(255,255,255,.10); margin:14px 0; }
    .btn { border: 1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.08); color:#fff; border-radius: 999px; padding: 10px 14px; font-weight: 700; cursor:pointer; }
    .btn:hover { background: rgba(255,255,255,.12); }
    .btn.ghost { background: transparent; }
    .btn.danger { background: rgba(255,64,64,.9); border-color: rgba(255,64,64,.35); color:#111; }
    .btn.danger:hover { filter: brightness(1.05); }
    .btn:disabled { opacity: .55; cursor: not-allowed; }
    .status-head { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .status-pill { display:inline-flex; align-items:center; gap:10px; padding:10px 12px; border-radius: 999px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); font-weight:800; }
    .dot { width:10px; height:10px; border-radius:50%; background: rgba(255,255,255,.35); box-shadow: 0 0 0 3px rgba(255,255,255,.08); }
    .status-meta { margin-top:10px; }
    .form-grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px 14px; }
    .field-full { grid-column: 1 / -1; }
    label { display:block; font-weight:800; margin:0 0 6px; }
    input, textarea, select { width:100%; border-radius: 14px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.35); color:#fff; padding: 10px 12px; outline:none; }
    
    select option { background:#fff; color:#111; }
input:focus, textarea:focus, select:focus { border-color: rgba(255,255,255,.22); }
    .help { margin-top:6px; font-size: 12.5px; }
    .inline { display:flex; gap:10px; align-items:center; }
    .inline input { flex:1; }
    .actions { display:flex; gap:12px; margin-top:14px; flex-wrap: wrap; align-items: center; }
    .toast { margin-top: 12px; font-weight: 800; display:none; padding: 10px 12px; border-radius: 14px; border: 1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.35); }
    .toast.show { display:block; }
    .share-row { display:flex; align-items:center; gap:10px; }
  </style>
</head>

<body>

  <div class="brandbar">
    <img src="CityintLogo.jpg" alt="CityIntel Logo">
    <div class="title" style="font-weight:700;font-size:18px">CityIntel</div>

    <div id="trial-banner" style="display:none;position:absolute;left:50%; transform:translateX(-50%); background:none;color:#fecaca; padding:8px 12px; text-align:center;">
      <span id="trial-text">Your trial ends soon.</span>
    </div>

    <div id="topActions" style="position:relative"></div>
  </div>

  <div class="app">
    <aside class="sidebar">
      <nav>
        <a href="index.html">Dashboard</a>
        <a href="alerts.html">Alerts</a>
        <a href="events.html">Events</a>
        <a href="live-feed.html">Live Feed</a>
        <a href="brief.html">Intelligence Brief</a>
        <a href="reports.html">Reports</a>
        <a href="trends.html">Trends & Forecasts</a>
        <a href="sources.html">Sources</a>
        <a href="settings.html">Settings</a>
        <a href="about.html">About</a>
      </nav>
    </aside>

    <main class="main">
      <div class="page">
        <div class="page-header">
          <div>
            <h1>Panic Alarm</h1>
            <p class="muted">Emergency activation page for logged-in staff or shared/mobile use (with invite code).</p>
          </div>
          <div class="page-actions">
            <a class="btn ghost" href="index.html">Back to Dashboard</a>
          </div>
        </div>

        <div class="grid-2">
          <section class="card">
            <h3>Emergency use</h3>
            <p>This page can be used by logged-in staff, or shared for emergency use on mobile.</p>
            <p>If you are using a shared link, enter your <strong>invite code</strong> and your name.</p>
            <p class="muted"><strong>Privacy note:</strong> keep messages brief and avoid highly sensitive details.</p>
            <div class="divider"></div>
            <div class="share-row">
              <button id="copyShareBtn" class="btn ghost">Copy share link</button>
              <span id="shareHint" class="muted"></span>
            </div>
          </section>

          <section class="card">
            <div class="status-head">
              <div class="status-pill" id="statusPill">
                <span class="dot" id="statusDot"></span>
                <span id="statusText">Checking status…</span>
              </div>
              <button id="refreshBtn" class="btn">Refresh</button>
            </div>

            <div class="status-meta muted" id="statusMeta"></div>
            <div class="divider"></div>

            <div class="form-grid">
              <div class="field" id="inviteBlock">
                <label for="inviteCode">Invite code (for shared links)</label>
                <input id="inviteCode" type="text" placeholder="e.g. 8-char invite code" autocomplete="off" />
                <div class="help muted" id="inviteHelp">If you are logged in, this can be left blank. If you are using a shared link, this is required.</div>
              </div>

              <!-- Location full-width so first+surname share same row -->
              <div class="field field-full">
                <label for="locationText">Location (optional)</label>
                <div class="inline">
                  <input id="locationText" type="text" placeholder="e.g. Lagos Airport / London HQ / City name" autocomplete="off" />
                  <button id="useLocationBtn" class="btn ghost" type="button">Use my location</button>
                </div>
                <div class="help muted">Stored as text only in v1 (no precise coordinates).</div>
              </div>

              <div class="field">
                <label for="firstName">First name</label>
                <input id="firstName" type="text" placeholder="First name" autocomplete="given-name" />
              </div>

              <div class="field">
                <label for="surname">Surname</label>
                <input id="surname" type="text" placeholder="Surname" autocomplete="family-name" />
              </div>

              <div class="field">
                <label for="email">Email (optional)</label>
                <input id="email" type="email" placeholder="e.g. name@company.com" autocomplete="email" />
              </div>

              <div class="field">
                <label for="phone">Phone (optional)</label>
                <input id="phone" type="tel" placeholder="e.g. +44 7..." autocomplete="tel" />
              </div>

              <div class="field field-full">
                <label for="message">Message (optional)</label>
                <textarea id="message" rows="4" placeholder="e.g. I need urgent assistance at [location]."></textarea>
                <div class="help muted">Tip: include what you need and who should respond (security / HR / local office lead).</div>
              </div>
            </div>

            <div class="actions">
              <button id="activateBtn" class="btn danger">Activate Panic Alarm</button>

              <select id="resetReason" class="btn" title="Reset reason" style="max-width: 220px;">
                <option value="Test">Test</option>
                <option value="Mistake">Mistake</option>
                <option value="False activation">False activation</option>
                <option value="Confirmed safe" selected>Confirmed safe</option>
              </select>

              <button id="resetBtn" class="btn">Reset Panic Alarm</button>
            </div>

            <div id="toast" class="toast" role="status" aria-live="polite"></div>
          </section>
        </div>
      </div>
    </main>
  </div>

  <script>
    const here=location.pathname.split("/").pop()||"index.html";
    document.querySelectorAll("aside.sidebar nav a").forEach(a=>{
      if(a.getAttribute("href")===here) a.classList.add("active")
    });
  </script>

  <script>
(function mountTopActions(){
  const host = document.getElementById('topActions');
  if (!host) return;

  const initialsOf = (nameOrEmail='CI') => {
    const s = String(nameOrEmail).trim();
    if (!s) return 'CI';
    if (s.includes('@')) return s[0].toUpperCase();
    const parts = s.split(/\s+/);
    return (parts[0]?.[0]||'C').toUpperCase() + (parts[1]?.[0]||'I').toUpperCase();
  };

  if (window.CIAuth && CIAuth.isLoggedIn()) {
    const u = CIAuth.who();
    const initials = initialsOf(u.name || u.email);
    const role = u.role || 'Member';
    const isAdmin = String(role).toLowerCase() === 'admin';

    host.innerHTML = `
      <div class="user" id="userChip" style="cursor:pointer">
        <div class="avatar">${initials}</div>
        ${role}
      </div>
      <div class="dropdown" id="userMenu">
        ${isAdmin ? `<a href="analytics.html">Analytics</a><a href="system-flow.html">System Flow</a><a href="operationslog.html">Operations Log</a>` : ``}
        <a href="settings.html">Manage Billing</a>
        <a href="#" id="logoutLink">Log out</a>
      </div>
    `;

    const chip = document.getElementById('userChip');
    const menu = document.getElementById('userMenu');
    chip.addEventListener('click', () => {
      menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
    });
    document.addEventListener('click', (e) => {
      if (!host.contains(e.target)) menu.style.display = 'none';
    });

    document.getElementById('logoutLink').addEventListener('click', (e) => {
      e.preventDefault();
      try { CIAuth.logout(); } catch(_) {}
      location.href = 'index.html';
    });

  } else {
    const here = location.pathname.split('/').pop() || 'index.html';
    const next = encodeURIComponent(here + location.search + location.hash);
    host.innerHTML = `<a class="login-btn" href="login.html?next=${next}">Log in</a>`;
  }
})();
</script>

  <script>
(function(){
  const API_BASE = "https://api.cityintelapi.com";

  // --- auth/profile helpers ---
  function getProfile() {
    try { return JSON.parse(localStorage.getItem("ci_profile") || "{}"); }
    catch { return {}; }
  }

  function isLoggedIn() {
    const p = getProfile();
    return !!(p && (p.email || p.id));
  }

  function getOrCreateGuestProfile(inviteCode) {
    const key = "ci_guest_profile_v1";
    try {
      const existing = JSON.parse(localStorage.getItem(key) || "null");
      if (existing?.email) return existing;
    } catch {}

    const rnd = Math.random().toString(36).slice(2, 10);
    const email = `guest+${String(inviteCode || "noinvite").toLowerCase()}-${rnd}@cityintel.local`;
    const profile = { email, name: "Guest", id: "email:" + email.toLowerCase() };
    localStorage.setItem(key, JSON.stringify(profile));
    return profile;
  }

  function getAuthHeaders(inviteCodeMaybe = "") {
    const profile = getProfile();
    const headers = { "Content-Type": "application/json" };

    // Logged-in
    if (profile?.email) {
      headers["X-User-Email"] = profile.email;
      if (profile?.name) headers["X-User-Name"] = profile.name;
      headers["X-User-Id"] = profile.id || ("email:" + String(profile.email).toLowerCase());
      return headers;
    }

    // Shared (guest) – only when invite present
    const invite = String(inviteCodeMaybe || "").trim();
    if (invite) {
      const g = getOrCreateGuestProfile(invite);
      headers["X-User-Email"] = g.email;
      headers["X-User-Name"] = g.name || "Guest";
      headers["X-User-Id"] = g.id || ("email:" + String(g.email).toLowerCase());
    }

    return headers;
  }

  // --- DOM ---
  const els = {
    statusText: document.getElementById("statusText"),
    statusMeta: document.getElementById("statusMeta"),
    statusDot: document.getElementById("statusDot"),

    btnRefresh: document.getElementById("refreshBtn"),
    btnActivate: document.getElementById("activateBtn"),
    btnReset: document.getElementById("resetBtn"),
    btnShare: document.getElementById("copyShareBtn"),
    btnUseLocation: document.getElementById("useLocationBtn"),

    inviteCode: document.getElementById("inviteCode"),
    firstName: document.getElementById("firstName"),
    surname: document.getElementById("surname"),
    email: document.getElementById("email"),
    phone: document.getElementById("phone"),
    location: document.getElementById("locationText"),
    message: document.getElementById("message"),
    resetReason: document.getElementById("resetReason"),
  };

  // Hide invite block for logged-in users
  (function toggleInviteBlock(){
    const b = document.getElementById("inviteBlock");
    if (!b) return;
    b.style.display = isLoggedIn() ? "none" : "";
  })();

  // Auto-fill invite code from URL hash: #invite=XXXXXXXX
  (function autofillInviteFromHash(){
    try {
      const h = location.hash || "";
      const m = h.match(/invite=([^&]+)/);
      if (m && els.inviteCode && !els.inviteCode.value) {
        els.inviteCode.value = decodeURIComponent(m[1]);
      }
    } catch {}
  })();

  // Prefill name fields for logged-in users
  (function prefillLoggedInFields() {
    if (!isLoggedIn()) return;
    const profile = getProfile();
    if (profile?.name && els.firstName && els.surname) {
      const parts = String(profile.name).trim().split(/\s+/);
      if (parts.length === 1) {
        if (!els.firstName.value) els.firstName.value = parts[0];
      } else {
        if (!els.firstName.value) els.firstName.value = parts.slice(0, -1).join(" ");
        if (!els.surname.value) els.surname.value = parts.slice(-1).join(" ");
      }
    }
    if (els.inviteCode) {
      els.inviteCode.placeholder = "not required when logged in";
    }
  })();

  // --- UI helpers (these were missing; fixes your console error) ---
  function setPill(active) {
    if (els.statusText) els.statusText.textContent = active ? "PANIC ALARM ACTIVE" : "No Alarms Activated";
    if (els.statusDot) els.statusDot.style.background = active ? "rgba(255,60,60,0.95)" : "rgba(44,255,170,0.85)";
    document.body.classList.toggle("panic-active", !!active);
  }

  function setMetaLine(text) {
    if (els.statusMeta) els.statusMeta.textContent = text || "";
  }

  function toast(msg, kind = "info") {
    const t = document.getElementById("toast");
    if (!t) { setMetaLine(msg); return; }
    t.textContent = msg;
    t.dataset.kind = kind;
    t.classList.add("show");
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(() => t.classList.remove("show"), 2600);
  }

  function setMsg(msg) {
    if (!msg) {
      const t = document.getElementById("toast");
      if (t) { t.textContent = ""; t.classList.remove("show"); }
      return;
    }
    toast(msg, "err");
  }

  function clearMsg() { setMsg(""); }

  function setBusy(busy) {
    const list = [els.btnRefresh, els.btnActivate, els.btnReset, els.btnShare, els.btnUseLocation];
    list.forEach(btn => { if (btn) btn.disabled = !!busy; });
    document.body.style.cursor = busy ? "progress" : "";
  }

  function renderStatus(data) {
    const active = (data?.active === true || data?.active === 'true' || data?.active === 1 || data?.active === '1');
    setPill(active);

    if (active) {
      const who =
        (data?.firstName || data?.surname)
          ? `${data?.firstName || ""} ${data?.surname || ""}`.trim()
          : (data?.actorName || data?.actorEmail || "");

      const where = (data?.location || "").trim();
      const at = data?.activated_at || "";
      const msg = (data?.message || "").trim();

      let meta = `Activated by: ${who || "Unknown"}`;
      if (where) meta += ` • Location: ${where}`;
      if (at) meta += ` • ${at}`;
      if (msg) meta += ` • Note: ${msg}`;
      setMetaLine(meta);
    } else {
      const upd = data?.resolved_at || data?.updated_at || "";
      const reason = (data?.resetReason || "").trim();
      let meta = "No active panic alarm";
      if (upd) meta += ` • Last update: ${upd}`;
      if (reason) meta += ` • Reset reason: ${reason}`;
      setMetaLine(meta);
    }
  }

  // Track if location was set via geolocation button
  function markLocationSource(src) {
    if (!els.location) return;
    els.location.dataset.source = src;
  }

  async function collectLocationText() {
    const locationText = (els.location?.value || "").trim();
    const locationSource = (els.location?.dataset?.source || (locationText ? "manual" : "")).trim();
    return { locationText, locationSource };
  }

  function currentActor() {
    const profile = getProfile();
    const fn = (els.firstName?.value || "").trim();
    const sn = (els.surname?.value || "").trim();
    const full = [fn, sn].filter(Boolean).join(" ").trim();

    const phone = (els.phone?.value || "").trim();
    const emailInput = (els.email?.value || "").trim();
    const invite = (els.inviteCode?.value || "").trim();

    if (isLoggedIn()) {
      return {
        name: profile.name || full || "User",
        email: emailInput || profile.email || "",
        id: profile.id || ("email:" + String(profile.email || "").toLowerCase()),
        phone,
        source: "loggedin",
      };
    }

    if (invite) {
      const g = getOrCreateGuestProfile(invite);
      return {
        name: full || "Shared user",
        email: emailInput || g.email,
        id: g.id,
        phone,
        source: "shared",
      };
    }

    return { name: full || "Shared user", email: "", id: "", phone, source: "shared" };
  }

  // --- shared / guest join flow ---
  let joinedViaInvite = false;

  async function ensureJoinedIfInvitePresent(inviteCode) {
    if (!inviteCode) return;
    if (joinedViaInvite) return;
    if (isLoggedIn()) return;

    const res = await fetch(`${API_BASE}/api/org/join`, {
      method: "POST",
      headers: getAuthHeaders(inviteCode),
      body: JSON.stringify({ inviteCode }),
    });
    if (!res.ok) {
      const t = await res.text().catch(() => "");
      throw new Error(`Join failed (${res.status}) ${t}`);
    }
    joinedViaInvite = true;
  }

  async function ensureSharedJoin() {
    if (isLoggedIn()) return;

    const invite = (els.inviteCode?.value || "").trim();
    if (!invite) {
      setMsg("Invite code is required for shared links.");
      throw new Error("missing invite");
    }

    const fn = (els.firstName?.value || "").trim();
    const sn = (els.surname?.value || "").trim();
    if (!fn && !sn) {
      setMsg("Please enter your name (first name and/or surname).");
      throw new Error("missing name");
    }

    await ensureJoinedIfInvitePresent(invite);
  }

  // --- panic API ---
  async function fetchPanic() {
    const invite = (els.inviteCode?.value || "").trim();
    const res = await fetch(`${API_BASE}/api/org/panic?ts=${Date.now()}`, {
      method: "GET",
      headers: getAuthHeaders(invite),
      cache: "no-store",
    });
    if (!res.ok) {
      const t = await res.text().catch(() => "");
      throw new Error(`Status failed (${res.status}) ${t}`);
    }
    const j = await res.json().catch(() => ({}));
    // Worker wraps payload as { ok, updatedAt, data }
    return (j && typeof j === 'object' && 'data' in j) ? (j.data ?? null) : j;
  }

  async function updatePanic(active, opts = {}) {
    const payload = {
      active,
      message: opts.message || "",
      source: opts.source || (isLoggedIn() ? "loggedin" : "shared"),
      location: opts.location || "",
      locationSource: opts.locationSource || "",

      // fields index.html expects
      firstName: opts.firstName || "",
      surname: opts.surname || "",
      email: opts.email || "",
      phone: opts.phone || "",

      // back-compat / audit
      actorName: opts.actorName || "",
      actorEmail: opts.actorEmail || "",
      actorPhone: opts.actorPhone || "",
      actorId: opts.actorId || "",
      activated_at: opts.activated_at || "",
      resolved_at: opts.resolved_at || "",
      resetReason: opts.resetReason || "",
    };

    const res = await fetch(`${API_BASE}/api/org/panic?ts=${Date.now()}`, {
      method: "PUT",
      headers: getAuthHeaders((els.inviteCode?.value || "").trim()),
      body: JSON.stringify(payload),
    });
    if (!res.ok) {
      const t = await res.text().catch(() => "");
      throw new Error(`Update failed (${res.status}) ${t}`);
    }
    // PUT returns { ok:true, orgId } on success
    return await res.json().catch(() => ({}));
  }

  async function updatePanicAndVerify(desiredActive, opts = {}) {
    let err = null;
    try {
      await updatePanic(desiredActive, opts);
    } catch (e) {
      err = e;
    }

    const isActiveVal = (v) => (v === true || v === 'true' || v === 1 || v === '1');

    let status = null;
    const attempts = 5;
    for (let i = 0; i < attempts; i++) {
      try {
        status = await fetchPanic();
        const activeNow = isActiveVal(status?.active);
        if (activeNow === !!desiredActive) break;
      } catch (e2) {
        if (i === attempts - 1) throw err || e2;
      }
      await new Promise(r => setTimeout(r, 250));
    }

    const okDesired = !!status && ( (status?.active === true || status?.active === 'true' || status?.active === 1 || status?.active === '1') === !!desiredActive );
    return { okDesired, status, err };
  }

  async function refresh() {
    try {
      setMetaLine("Checking status...");
      const data = await fetchPanic();
      renderStatus(data);
    } catch (e) {
      setPill(false);
      setMetaLine("Status check failed");
      console.error(e);
    }
  }

  // --- actions ---
  async function onActivate() {
    clearMsg();

    try {
      await ensureSharedJoin();
    } catch {
      return;
    }

    setBusy(true);
    try {
      const actor = currentActor();
      const loc = await collectLocationText();

      const payload = {
        firstName: (els.firstName?.value || "").trim(),
        surname: (els.surname?.value || "").trim(),
        location: loc.locationText || "",
        locationSource: loc.locationSource || "",

        email: actor.email || "",
        phone: actor.phone || "",
        message: (els.message?.value || "").trim(),

        actorName: actor.name || "",
        actorEmail: actor.email || "",
        actorPhone: actor.phone || "",
        actorId: actor.id || "",
        activated_at: new Date().toISOString(),
      };

      const { okDesired, status, err } = await updatePanicAndVerify(true, payload);
      renderStatus(status);

      if (okDesired) {
        toast("PANIC ALARM ACTIVATED", "ok");
      } else {
        setMsg("PANIC ALARM ACTIVATED.");
        if (err) console.warn("Activate error (but status read-back succeeded):", err);
      }
    } catch (e) {
      console.error(e);
      setMsg("Activate failed.");
    } finally {
      setBusy(false);
    }
  }

  async function onReset() {
    clearMsg();
    setBusy(true);
    try {
      const reason = els.resetReason?.value || "Confirmed safe";
      const payload = {
        resetReason: reason,
        resolved_at: new Date().toISOString(),
      };

      const { okDesired, status, err } = await updatePanicAndVerify(false, payload);
      renderStatus(status);

      if (okDesired) {
        toast("Panic alarm reset", "ok");
      } else {
        setMsg("Reset may not have completed. Please refresh to confirm.");
        if (err) console.warn("Reset error (but status read-back succeeded):", err);
      }
    } catch (e) {
      console.error(e);
      setMsg("Reset failed.");
    } finally {
      setBusy(false);
    }
  }

  function onCopyShareLink() {
    const base = window.location.href.split("#")[0];
    const invite = (els.inviteCode?.value || "").trim();
    const url = invite ? `${base}#invite=${encodeURIComponent(invite)}` : base;
    navigator.clipboard?.writeText(url).then(
      () => toast("Share link copied", "ok"),
      () => toast("Copy failed (clipboard blocked)", "err")
    );
  }

  function onUseLocation() {
    if (!navigator.geolocation) return toast("Geolocation not supported", "err");
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude.toFixed(4);
        const lon = pos.coords.longitude.toFixed(4);
        if (els.location) els.location.value = `${lat}, ${lon}`;
        markLocationSource("geo");
        toast("Location added", "ok");
      },
      () => toast("Location permission denied", "err"),
      { enableHighAccuracy: false, timeout: 8000 }
    );
  }

  // if user types location manually, mark source manual
  els.location?.addEventListener("input", () => markLocationSource("manual"));

  // Wire up
  els.btnRefresh?.addEventListener("click", refresh);
  els.btnActivate?.addEventListener("click", onActivate);
  els.btnReset?.addEventListener("click", onReset);
  els.btnShare?.addEventListener("click", onCopyShareLink);
  els.btnUseLocation?.addEventListener("click", onUseLocation);

  // Initial load
  refresh();
}

// Try to capture browser GPS location (used for map pin). Returns null if blocked/unavailable.
function getGeoOnce(timeoutMs = 5000){
  return new Promise((resolve) => {
    try{
      if (!navigator.geolocation) return resolve(null);
      let done = false;
      const timer = setTimeout(() => {
        if (done) return;
        done = true;
        resolve(null);
      }, timeoutMs);

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          if (done) return;
          done = true;
          clearTimeout(timer);
          resolve({
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
            accuracy: typeof pos.coords.accuracy === 'number' ? pos.coords.accuracy : null
          });
        },
        () => {
          if (done) return;
          done = true;
          clearTimeout(timer);
          resolve(null);
        },
        { enableHighAccuracy: true, maximumAge: 15000, timeout: timeoutMs }
      );
    } catch(e){
      resolve(null);
    }
  });
}
)();
</script>

</body>
</html>
