<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CityIntel — Panic Alarm</title>
  <style>
    :root{
      --bg:#070a0e;
      --bg2:#05070a;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.04);
      --stroke:rgba(255,255,255,.10);
      --text:#eaeaea;
      --muted:#9fb0c0;
      --danger:#ff5a5f;
      --danger2:#ff2d55;
      --ok:#19c37d;
      --warn:#f5b301;
      --shadow:0 18px 60px rgba(0,0,0,.55);
      --radius:18px;
      --radius2:22px;
      --focus:0 0 0 3px rgba(255,90,95,.22);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(255,90,95,.18), transparent 55%),
        radial-gradient(1000px 650px at 85% 30%, rgba(255,90,95,.10), transparent 55%),
        radial-gradient(900px 500px at 40% 90%, rgba(255,255,255,.06), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
    }

    .topbar{
      height:64px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 22px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
      position:sticky;
      top:0;
      z-index:5;
    }
    .brand{display:flex;align-items:center;gap:12px;}
    .logo{
      width:36px;height:36px;border-radius:10px;
      background:radial-gradient(circle at 30% 30%, rgba(255,90,95,.95), rgba(90,0,0,.15));
      border:1px solid rgba(255,255,255,.16);
      box-shadow:0 10px 35px rgba(0,0,0,.35);
      display:grid;place-items:center;
      overflow:hidden;
    }
    .logo svg{width:22px;height:22px;opacity:.95}
    .brand .name{font-weight:800;letter-spacing:.2px;font-size:18px}
    .brand .tag{font-size:12px;color:var(--muted);margin-top:2px}

    .navlinks{display:flex;gap:12px;align-items:center}
    .link{
      color:var(--muted);
      text-decoration:none;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid transparent;
    }
    .link:hover{color:var(--text);border-color:rgba(255,255,255,.12);background:rgba(255,255,255,.04)}

    .wrap{max-width:980px;margin:40px auto 90px;padding:0 18px;}

    .hero{
      display:flex;align-items:flex-start;justify-content:space-between;gap:16px;
      padding:22px 22px;
      border-radius:var(--radius2);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      box-shadow:var(--shadow);
    }
    .hero h1{margin:0 0 6px;font-size:26px}
    .hero p{margin:0;color:var(--muted);max-width:680px;line-height:1.45}

    .card{
      margin-top:18px;
      padding:22px;
      border-radius:var(--radius2);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      box-shadow:var(--shadow);
    }

    .row{display:flex;gap:14px;flex-wrap:wrap;align-items:flex-end}
    .field{flex:1;min-width:190px}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 8px}
    input, textarea{
      width:100%;
      background:rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      padding:12px 12px;
      border-radius:14px;
      outline:none;
    }
    textarea{min-height:110px;resize:vertical}
    input:focus, textarea:focus{box-shadow:var(--focus);border-color:rgba(255,90,95,.35)}

    .pill{
      display:inline-flex;align-items:center;gap:10px;
      padding:10px 14px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.22);
      font-weight:800;
      letter-spacing:.2px;
    }
    .pill.ok{border-color:rgba(25,195,125,.35);color:#c9ffe5}
    .pill.danger{border-color:rgba(255,90,95,.45);color:#ffd3d5}

    .meta{margin-top:10px;color:var(--muted);font-size:13px}
    .meta strong{color:var(--text)}

    .divider{height:1px;background:rgba(255,255,255,.10);margin:18px 0}

    .btns{display:flex;gap:12px;flex-wrap:wrap;margin-top:14px;align-items:center}
    .btn{
      border:none;cursor:pointer;
      padding:12px 16px;
      border-radius:999px;
      font-weight:800;
      letter-spacing:.2px;
      transition:transform .05s ease, filter .15s ease;
      user-select:none;
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:linear-gradient(180deg, var(--danger), var(--danger2));color:#120202}
    .btn.ghost{background:rgba(255,255,255,.92);color:#111}
    .btn.soft{background:rgba(255,255,255,.08);color:var(--text);border:1px solid rgba(255,255,255,.14)}
    .btn.soft:hover{filter:brightness(1.06)}

    .right{margin-left:auto}

    .hint{margin-top:10px;font-size:12px;color:var(--muted);line-height:1.45}

    .toast{
      position:fixed;left:50%;bottom:22px;transform:translateX(-50%);
      background:rgba(0,0,0,.70);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 14px;border-radius:14px;
      color:var(--text);
      box-shadow:0 16px 50px rgba(0,0,0,.55);
      opacity:0;pointer-events:none;
      transition:opacity .2s ease, transform .2s ease;
      z-index:99;
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}

    /* Pulse animation (subtle) */
    @keyframes ciPulse {0%,100%{filter:brightness(1)}50%{filter:brightness(1.28)}}
    .pulse{animation:ciPulse 1.2s ease-in-out infinite}

    @media (max-width:640px){
      .topbar{padding:0 14px}
      .wrap{margin-top:22px}
      .hero{flex-direction:column}
      .right{margin-left:0}
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2l8 4v6c0 5-3.4 9.4-8 10-4.6-.6-8-5-8-10V6l8-4z" stroke="rgba(255,255,255,.92)" stroke-width="1.6"/>
          <path d="M12 7v7" stroke="rgba(255,255,255,.92)" stroke-width="1.6" stroke-linecap="round"/>
          <circle cx="12" cy="17.5" r="1" fill="rgba(255,255,255,.92)"/>
        </svg>
      </div>
      <div>
        <div class="name">CityIntel</div>
        <div class="tag">Emergency signalling</div>
      </div>
    </div>
    <nav class="navlinks">
      <a class="link" href="index.html">Back to Dashboard</a>
    </nav>
  </header>

  <main class="wrap">
    <section class="hero">
      <div>
        <h1>Panic Alarm</h1>
        <p>Use this only in an emergency test or real scenario. When activated, it will notify everyone in your organisation via the dashboard banner.</p>
      </div>
      <div class="btns" style="margin-top:0">
        <button id="btnRefresh" class="btn ghost">Refresh</button>
      </div>
    </section>

    <section class="card" aria-live="polite">
      <div class="row" style="align-items:center">
        <div>
          <span id="statusPill" class="pill ok">No active panic alarm</span>
          <div id="statusMeta" class="meta">Last update: <strong>—</strong></div>
        </div>
        <div class="btns right" style="margin-top:0">
          <button id="btnCopyLink" class="btn soft">Copy share link</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <div class="field">
          <label for="firstName">First name</label>
          <input id="firstName" type="text" autocomplete="given-name" placeholder="e.g. Dale" />
        </div>
        <div class="field">
          <label for="lastName">Surname</label>
          <input id="lastName" type="text" autocomplete="family-name" placeholder="e.g. McK" />
        </div>
        <div class="field">
          <label for="orgCode">Organisation code (optional)</label>
          <input id="orgCode" type="text" inputmode="text" placeholder="Invite / organisation code (for shared link)" />
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="field" style="flex:2;min-width:260px">
          <label for="locationText">Your location (optional)</label>
          <input id="locationText" type="text" placeholder="City / office / landmark — or use ‘Use my location’" />
        </div>
        <div class="btns" style="margin-top:0">
          <button id="btnUseLocation" class="btn soft">Use my location</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <label for="message">Message (optional)</label>
        <textarea id="message" placeholder="e.g. I need urgent assistance at [location]."></textarea>
        <div class="hint">Tip: include what you need and who to contact. If you add your location above, it will be included automatically.</div>
      </div>

      <div class="btns">
        <button id="btnActivate" class="btn primary">Activate Panic Alarm</button>
        <button id="btnReset" class="btn ghost">Reset Panic Alarm</button>
        <span id="busy" class="hint" style="display:none">Working…</span>
      </div>

      <div class="hint" style="margin-top:14px">
        <strong>Reset / cancel:</strong> Use “Reset Panic Alarm” for false alarms or after the situation is resolved. This will clear the dashboard banner.
      </div>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // =========================
    // Config
    // =========================
    const API_BASE = 'https://api.cityintelapi.com';

    // =========================
    // Lightweight auth header reader (matches v2)
    // =========================
    const CIAuth = {
      getUser() {
        try {
          const raw = localStorage.getItem('cityintelUser');
          if (!raw) return null;
          const u = JSON.parse(raw);
          if (!u || !u.email) return null;
          return u;
        } catch {
          return null;
        }
      },
      headers() {
        const u = this.getUser();
        if (!u) return {};
        return {
          'X-User-Email': u.email,
          'X-User-Name': u.name || '',
          'X-User-Id': u.id || (u.email ? ('email:' + u.email.toLowerCase()) : ''),
        };
      }
    };

    // =========================
    // UI helpers
    // =========================
    const $ = (id) => document.getElementById(id);

    function toast(msg) {
      const el = $('toast');
      el.textContent = msg;
      el.classList.add('show');
      clearTimeout(window.__toastT);
      window.__toastT = setTimeout(() => el.classList.remove('show'), 2400);
    }

    function setBusy(on) {
      $('busy').style.display = on ? 'inline' : 'none';
      $('btnActivate').disabled = on;
      $('btnReset').disabled = on;
      $('btnRefresh').disabled = on;
      $('btnUseLocation').disabled = on;
      $('btnCopyLink').disabled = on;
    }

    function fmtTime(iso) {
      if (!iso) return '—';
      try {
        const d = new Date(iso);
        return d.toLocaleString();
      } catch { return String(iso); }
    }

    // Persist name/location (convenience)
    function loadPrefs() {
      $('firstName').value = localStorage.getItem('ci_panic_first') || '';
      $('lastName').value  = localStorage.getItem('ci_panic_last')  || '';
      $('locationText').value = localStorage.getItem('ci_panic_loc') || '';
      $('orgCode').value = localStorage.getItem('ci_panic_org') || '';
    }
    function savePrefs() {
      localStorage.setItem('ci_panic_first', ($('firstName').value || '').trim());
      localStorage.setItem('ci_panic_last',  ($('lastName').value || '').trim());
      localStorage.setItem('ci_panic_loc',   ($('locationText').value || '').trim());
      localStorage.setItem('ci_panic_org',   ($('orgCode').value || '').trim());
    }

    // =========================
    // Location helper
    // =========================
    let lastGeo = null; // {lat,lon, label}

    async function reverseGeocode(lat, lon) {
      // Best-effort: if blocked, we still keep coordinates.
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if (!res.ok) return null;
      const j = await res.json().catch(() => null);
      const a = j && j.address ? j.address : null;
      if (!a) return j?.display_name || null;
      return a.city || a.town || a.village || a.county || a.state || j.display_name || null;
    }

    async function useMyLocation() {
      if (!('geolocation' in navigator)) {
        toast('Geolocation not supported on this device.');
        return;
      }
      setBusy(true);
      try {
        const pos = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 12000,
            maximumAge: 60_000,
          });
        });

        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        let label = `${lat.toFixed(5)}, ${lon.toFixed(5)}`;

        try {
          const place = await reverseGeocode(lat, lon);
          if (place) label = place;
        } catch {}

        lastGeo = { lat, lon, label };
        $('locationText').value = label;
        savePrefs();
        toast('Location added.');
      } catch (e) {
        toast('Could not get location (permission denied or timeout).');
      } finally {
        setBusy(false);
      }
    }

    // =========================
    // API helpers
    // =========================
    const qs = new URLSearchParams(location.search);

    function buildShareUrl() {
      const base = `${location.origin}${location.pathname}`;
      const org = ($('orgCode').value || '').trim();
      const p = new URLSearchParams();
      p.set('share', '1');
      if (org) p.set('org', org);
      return `${base}?${p.toString()}`;
    }

    async function copyShareLink() {
      savePrefs();
      const url = buildShareUrl();

      try {
        await navigator.clipboard.writeText(url);
        toast('Share link copied.');
      } catch {
        // fallback
        const ta = document.createElement('textarea');
        ta.value = url;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
        toast('Share link copied.');
      }
    }

    function sharedOrgCodeFromUrlOrInput() {
      return (qs.get('org') || $('orgCode').value || '').trim();
    }

    async function apiFetch(path, opts = {}) {
      const url = API_BASE + path;
      return fetch(url, opts);
    }

    async function getStatus() {
      // 1) Prefer logged-in org route (/api/org/panic)
      // 2) If no user (or share mode requested), try shared route (/api/panic?org=...)
      const user = CIAuth.getUser();
      const shareMode = qs.get('share') === '1' || !user;

      if (!shareMode) {
        const res = await apiFetch('/api/org/panic', {
          method: 'GET',
          headers: { ...CIAuth.headers() }
        });
        const j = await res.json().catch(() => null);
        if (!res.ok || !j?.ok) throw new Error(j?.error || 'Failed to read panic status');
        return j.data || { active: false };
      }

      const org = sharedOrgCodeFromUrlOrInput();
      if (!org) return { active: false, _needsOrg: true };

      // Shared route (best-effort). Your worker must support this.
      const res = await apiFetch(`/api/panic?org=${encodeURIComponent(org)}`, { method: 'GET' });
      const j = await res.json().catch(() => null);
      if (!res.ok || !j?.ok) {
        // fall back to empty if not available
        return { active: false, _sharedNotReady: true };
      }
      return j.data || j.panic || j || { active: false };
    }

    function composeMessagePayload(mode) {
      savePrefs();
      const fn = ($('firstName').value || '').trim();
      const ln = ($('lastName').value || '').trim();
      const loc = ($('locationText').value || '').trim();
      const msg = ($('message').value || '').trim();

      const name = [fn, ln].filter(Boolean).join(' ');

      const parts = [];
      if (name) parts.push(`Name: ${name}`);
      if (loc) parts.push(`Location: ${loc}`);
      if (msg) parts.push(`Message: ${msg}`);

      const flatMessage = parts.join(' | ');

      return {
        active: mode === 'activate',
        activatedBy: name || CIAuth.getUser()?.email || 'shared',
        message: flatMessage || (mode === 'activate' ? 'User triggered panic alarm' : 'Resolved / false alarm'),
        location: lastGeo ? { lat: lastGeo.lat, lon: lastGeo.lon, label: lastGeo.label } : (loc ? { label: loc } : null),
      };
    }

    async function setStatus(mode) {
      const user = CIAuth.getUser();
      const shareMode = qs.get('share') === '1' || !user;

      const payload = composeMessagePayload(mode);

      // basic validation
      const fn = ($('firstName').value || '').trim();
      const ln = ($('lastName').value || '').trim();
      if (shareMode && (!fn || !ln)) {
        toast('Please enter first name + surname for shared use.');
        return;
      }

      if (shareMode) {
        const org = sharedOrgCodeFromUrlOrInput();
        if (!org) {
          toast('Enter an organisation code (or open a share link that includes one).');
          return;
        }

        // Shared route (best-effort). Your worker must support this.
        const res = await apiFetch(`/api/panic?org=${encodeURIComponent(org)}`, {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const j = await res.json().catch(() => null);
        if (!res.ok || !j?.ok) {
          toast('Shared panic endpoint not available yet. Use logged-in mode for now.');
          return;
        }
        return;
      }

      // Logged in org route (existing)
      const res = await apiFetch('/api/org/panic', {
        method: 'PUT',
        headers: { 'content-type': 'application/json', ...CIAuth.headers() },
        body: JSON.stringify(payload)
      });
      const j = await res.json().catch(() => null);
      if (!res.ok || !j?.ok) throw new Error(j?.error || 'Failed to update panic status');
    }

    // =========================
    // Render
    // =========================
    function renderStatus(data) {
      const active = !!data?.active;
      const pill = $('statusPill');
      pill.className = 'pill ' + (active ? 'danger pulse' : 'ok');
      pill.textContent = active ? 'PANIC ALARM ACTIVE' : 'No active panic alarm';

      const meta = $('statusMeta');
      const when = active ? (data.activatedAt || data.activated_at || null) : (data.resolvedAt || data.resolved_at || data.activatedAt || data.activated_at || null);
      const note = data.message || data.note || '';

      const extra = [];
      if (data.activatedBy || data.activated_by) extra.push(`Activated by: ${data.activatedBy || data.activated_by}`);
      if (when) extra.push(fmtTime(when));
      if (note) extra.push(`Note: ${note}`);

      meta.innerHTML = `Last update: <strong>${when ? fmtTime(when) : '—'}</strong>${note ? ` • <span style="color:var(--muted)">Note: ${escapeHtml(note).slice(0,180)}</span>` : ''}`;

      // If share mode needs org code, hint the user
      if (data?._needsOrg) toast('Optional: enter your organisation code to enable shared mode.');
      if (data?._sharedNotReady) {
        // no toast spam; keep it subtle
      }
    }

    function escapeHtml(s){
      return String(s||'')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }

    async function refresh() {
      setBusy(true);
      try {
        const data = await getStatus();
        renderStatus(data);
      } catch (e) {
        console.error(e);
        toast(String(e?.message || e));
      } finally {
        setBusy(false);
      }
    }

    async function activate() {
      if (!confirm('Activate panic alarm? This will notify everyone in your organisation.')) return;
      setBusy(true);
      try {
        await setStatus('activate');
        toast('Panic alarm activated.');
        await refresh();
      } catch (e) {
        console.error(e);
        toast(String(e?.message || e));
      } finally {
        setBusy(false);
      }
    }

    async function reset() {
      const note = prompt('Reset/cancel panic alarm?\n\nOptionally add a short note (e.g. “False alarm” or “Resolved”).', 'Resolved / false alarm');
      if (note === null) return;

      // set note into message box temporarily if empty
      if (!($('message').value || '').trim()) $('message').value = note;

      setBusy(true);
      try {
        await setStatus('reset');
        toast('Panic alarm reset.');
        await refresh();
      } catch (e) {
        console.error(e);
        toast(String(e?.message || e));
      } finally {
        setBusy(false);
      }
    }

    // =========================
    // Init
    // =========================
    loadPrefs();

    $('btnRefresh').addEventListener('click', refresh);
    $('btnActivate').addEventListener('click', activate);
    $('btnReset').addEventListener('click', reset);
    $('btnUseLocation').addEventListener('click', useMyLocation);
    $('btnCopyLink').addEventListener('click', copyShareLink);

    // Auto refresh
    refresh();
  </script>
</body>
</html>
