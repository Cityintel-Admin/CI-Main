<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CityIntel — Panic Alarm</title>
  <style>
  :root{--brand-red:#D01616;--gray-900:#111214;--gray-800:#16171a;--gray-700:#1c1e22;--gray-600:#24272c;--gray-500:#2e3238;--text:#e9edf2}
    body{margin:0;font:14px/1.5 system-ui;background:linear-gradient(180deg,var(--gray-900),var(--gray-800));color:var(--text)}
    .app{display:grid;grid-template-columns:260px 1fr;grid-template-rows:60px 1fr;grid-template-areas:"sidebar topbar" "sidebar main";min-height:100vh}
    .sidebar{grid-area:sidebar;background:#0c0c0c;border-right:1px solid var(--gray-600);display:flex;flex-direction:column;padding:18px 14px;gap:18px}
    .brand{display:flex;align-items:center;gap:10px;padding:8px 10px;background:rgba(208,22,22,0.1);border-radius:12px}
    .brand img{width:34px;height:34px;background:#fff;border-radius:6px}
    nav a{display:flex;align-items:center;padding:10px 12px;border-radius:10px;text-decoration:none;color:var(--text);border:1px solid transparent}
    nav a:hover{background:var(--gray-600);border-color:var(--gray-500)}
    nav a.active{background:rgba(208,22,22,0.15);border-color:var(--brand-red)}
    .sidebar .footnote{margin-top:auto;font-size:12px;color:#8e97a3}
    .topbar{ grid-area: topbar;background: rgba(255,255,255,0.02);border-bottom:1px solid var(--brand-gray-600);display:flex; align-items:center; gap:12px;
  padding:10px 16px;position:sticky; top:0; z-index:10;backdrop-filter: blur(8px);}
    .search{flex:1;display:flex; align-items:center; gap:10px;background:var(--brand-gray-700);border:1px solid var(--brand-gray-600);
  border-radius:12px; padding:8px 12px;min-width: 0;}
    .search input{flex:1; min-width:0;background:transparent; border:none; outline:none; color:var(--text);}

#topActions{margin-left:auto;display:flex; align-items:center; gap:10px;min-width: fit-content;position: relative;}
    
    .main{grid-area:main;padding:20px}
    .card{background:#16171a;border:1px solid var(--gray-600);border-radius:16px;padding:16px;margin-bottom:20px}
    .alert{border-left:4px solid var(--brand-red);padding:12px;border-radius:10px;margin-bottom:12px;background:linear-gradient(90deg,rgba(208,22,22,.1),rgba(208,22,22,0))}
    .alert strong{display:block;margin-bottom:6px}
    .alert small{color:#8e97a3}
    .alert.med{ border-left-color:#f0b429; background:linear-gradient(90deg,rgba(240,180,41,.12),rgba(240,180,41,0)); }
    .alert.high{ border-left-color:#ff5a5f; background:linear-gradient(90deg,rgba(255,90,95,.12),rgba(255,90,95,0)); }
    .alert.low{ border-left-color:#33c48d;  background:linear-gradient(90deg,rgba(51,196,141,.12),rgba(51,196,141,0));}
	.btn{display:inline-block; padding:6px 10px; border-radius:10px;border:1px solid #2e3238; text-decoration:none; color:#e9edf2;
}
    .btn:hover{border-color:#D01616 }

    .login-btn{ display:inline-block;padding:8px 12px;border-radius:999px;background:#D01616;
  border:1px solid #9c0f0f;color:#fff;font-weight:700;text-decoration:none;white-space:nowrap;
}
    .login-btn:hover{filter:brightness(1.05)}
    .user{ display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;
  background:#1c1e22;border:1px solid #24272c;cursor:pointer;
}
    .avatar{ width:28px;height:28px;background:#fff;color:#000;border-radius:50%;
  display:grid;place-items:center;font-weight:700;
}
    .dropdown{ position:absolute;right:0;top:calc(100% + 6px);background:#1a1c20;border:1px solid #24272c;
  border-radius:10px;padding:6px 0;box-shadow:0 4px 12px rgba(0,0,0,.4);display:none;min-width:140px;z-index:50;
}
    .dropdown a{display:block;padding:8px 12px;color:#e9edf2;text-decoration:none;font-size:14px}
    .dropdown a:hover{background:rgba(255,255,255,0.05)}

  .brandbar{display:flex;align-items:center;gap:10px;padding:16px 20px;border-bottom:1px solid var(--line);
    background:linear-gradient(90deg,rgba(208,22,22,.2),rgba(208,22,22,0))}
  .brandbar img{width:auto;height:60px;object-fit:contain;border-radius:6px;background:#fff}
  .wrap{max-width:1100px;margin:28px auto;padding:20px}
  .hero{text-align:center;margin:6px 0 18px}
  .hero h1{margin:0 0 6px;font-size:26px;color:var(--brand-red)}
  .hero p{margin:0;color:var(--muted)}
	  
	/* ===== Mobile layout tweaks ===== */
@media (max-width: 720px) {
  /* Stack layout: topbar, sidebar row, then main content */
  .app{
    grid-template-columns: 1fr;
    grid-template-rows: auto auto 1fr;
    grid-template-areas:
      "topbar"
      "sidebar"
      "main";
  }

  .sidebar{
    border-right: none;
    border-top: 1px solid var(--brand-gray-600);
    flex-direction: row;
    align-items: center;
    gap: 8px;
    padding: 8px;
    overflow-x: auto;
    white-space: nowrap;
  }

  .sidebar nav{
    display: flex;
    flex-wrap: nowrap;
    gap: 8px;
  }

  .sidebar nav a{
    font-size: 12px;
    padding: 6px 10px;
    white-space: nowrap;
  }

  .brand{
    flex-shrink: 0;
  }

  .main{
    padding: 10px;
  }

  .card{
    padding: 12px;
  }
</style>

</head>


<body>

  <div class="brandbar">
    <img src="CityintLogo.jpg" alt="CityIntel Logo">
    <div class="title" style="font-weight:700;font-size:18px">CityIntel</div>
	<div id="trial-banner" style="display:none;position:absolute;
    left:50%; transform:translateX(-50%); background:none;
    color:#fecaca; padding:8px 12px; text-align:center;">
  <span id="trial-text">Your trial ends soon.</span>
</div>	
	  <div id="topActions" style="position:relative"></div>
  </div>

  
<script>
(function(){
  const API_ORIGIN = (window.CI_API_ORIGIN || 'https://api.cityintelapi.com').replace(/\/+$/,'');

  // --- Shared link support (no login) ---------------------------------
  // If the URL has ?org=<ORG_ID>&token=<INVITE_OR_SHARED_TOKEN>, we will
  // send those on requests so people can trigger/reset without having a user login.
  //
  // Your Worker must accept these headers/query values on a dedicated route.
  // If your route names differ, change SHARED_* constants below.
  const qp = new URLSearchParams(location.search);
  const SHARED_ORG   = (qp.get('org') || '').trim();
  const SHARED_TOKEN = (qp.get('token') || '').trim();

  // Default routes (adjust if your Worker uses different ones)
  const SHARED_GET_PATH    = '/api/org/panic';           // can be same as normal if your worker allows shared GET
  const SHARED_SET_PATH    = '/api/org/panic/shared';    // suggested: shared trigger/reset route
  const SHARED_LOG_PATH    = '/api/org/panic/log';       // optional: recent activations (if implemented)

  function hasSharedAccess(){
    return !!(SHARED_ORG && SHARED_TOKEN);
  }

  function sharedHeaders(){
    return {
      'X-Org-Id': SHARED_ORG,
      'X-Org-Token': SHARED_TOKEN,
    };
  }

  // --- Auth / user -----------------------------------------------------
  const isLoggedIn = (window.CIAuth && CIAuth.isLoggedIn && CIAuth.isLoggedIn());
  const user = (window.CIAuth && CIAuth.getUser) ? (CIAuth.getUser() || {}) : {};
  const currentUser = isLoggedIn ? user : { email:'', name:'' };

  const el = {
    statusBadge: document.getElementById('statusBadge'),
    statusLine: document.getElementById('statusLine'),
    activate: document.getElementById('activateBtn'),
    cancel: document.getElementById('cancelBtn'),
    refresh: document.getElementById('refreshBtn'),
    msg: document.getElementById('msg'),
    first: document.getElementById('firstName'),
    last: document.getElementById('lastName'),
    loc: document.getElementById('locationText'),
  };

  // Prefill name fields from logged-in account if available
  if (currentUser?.name) {
    const parts = String(currentUser.name).trim().split(/\s+/);
    if (parts.length) el.first.value = parts[0] || '';
    if (parts.length > 1) el.last.value = parts.slice(1).join(' ') || '';
  }

  function setLine(t){ el.statusLine.textContent = t; }

  function fmtWhen(iso){
    if (!iso) return '';
    try{
      const d = new Date(iso);
      return d.toLocaleString();
    }catch{ return String(iso); }
  }

  async function api(path, opts={}){
    const headers = Object.assign(
      { 'Content-Type': 'application/json' },
      opts.headers || {}
    );

    // Logged-in path (existing)
    if (isLoggedIn && currentUser?.email) {
      headers['X-User-Email'] = currentUser.email;
      headers['X-User-Name']  = currentUser.name || '';
      if (currentUser.id) headers['X-User-Id'] = currentUser.id;
    }

    // Shared path (no login)
    if (!isLoggedIn && hasSharedAccess()) {
      Object.assign(headers, sharedHeaders());
    }

    const res = await fetch(API_ORIGIN + path, { ...opts, headers });
    const txt = await res.text();
    let data = null;
    try{ data = txt ? JSON.parse(txt) : null; }catch{ data = null; }

    if (!res.ok) {
      const msg = (data && (data.error || data.message)) ? (data.error || data.message) : (`HTTP ${res.status}`);
      throw new Error(msg);
    }
    return data;
  }

  function buildDisplayName(){
    const first = (el.first.value || '').trim();
    const last  = (el.last.value  || '').trim();
    const full = [first, last].filter(Boolean).join(' ');
    return full;
  }

  function requireIdentity(){
    // If logged-in, we still want name fields filled (for better log context),
    // but we can fallback to account name.
    const displayName = buildDisplayName() || (currentUser.name || '').trim();
    const email = (currentUser.email || '').trim();

    // Shared access: require a name because there is no user identity.
    if (!isLoggedIn) {
      if (!hasSharedAccess()) {
        throw new Error('You are not logged in. Use a shared panic link or sign in.');
      }
      if (!displayName) {
        throw new Error('Please enter your first name and surname.');
      }
    }

    return { displayName, email };
  }

  async function load(){
    setLine('Loading…');
    try{
      // prefer normal route (works for logged-in)
      let st = await api('/api/org/panic', { method:'GET' });

      const active = !!st?.data?.active;
      const by = st?.data?.byEmail || st?.data?.byName || '—';
      const when = st?.data?.at ? fmtWhen(st.data.at) : '—';
      const note = st?.data?.note ? String(st.data.note) : '';

      if (active){
        el.statusBadge.textContent = 'PANIC ALARM ACTIVE';
        el.statusBadge.style.background = 'rgba(255, 59, 48, .20)';
        el.statusBadge.style.borderColor = 'rgba(255, 59, 48, .35)';
        setLine(`Activated by: ${by} • ${when}${note ? ' • Note: ' + note : ''}`);
        el.activate.disabled = true;
        el.cancel.disabled = false;
      } else {
        el.statusBadge.textContent = 'No active panic alarm';
        el.statusBadge.style.background = 'rgba(46, 204, 113, .10)';
        el.statusBadge.style.borderColor = 'rgba(46, 204, 113, .25)';
        setLine('No active alarm for your organisation.');
        el.activate.disabled = false;
        el.cancel.disabled = true;
      }
    } catch(e){
      setLine('Load failed: ' + e.message);
    }
  }

  async function setPanic(nextActive){
    const now = new Date().toISOString();
    const ident = requireIdentity();

    const loc = (el.loc.value || '').trim();
    const msg = (el.msg.value || '').trim();

    // We store a single "note" string for now (simple v1).
    // Format is readable and easy to evolve later into structured fields.
    const noteParts = [];
    const dn = ident.displayName;
    if (dn) noteParts.push(`Name: ${dn}`);
    if (loc) noteParts.push(`Location: ${loc}`);
    if (msg) noteParts.push(`Message: ${msg}`);
    const note = noteParts.join(' | ');

    const payload = {
      active: !!nextActive,
      at: now,
      byEmail: ident.email || '',
      byName: dn || ident.email || '',
      note
    };

    // If shared access (no login), hit the shared route (recommended).
    // If your Worker allows shared PUT on /api/org/panic, you can change SHARED_SET_PATH.
    const path = (!isLoggedIn && hasSharedAccess()) ? SHARED_SET_PATH : '/api/org/panic';

    await api(path, { method:'PUT', body: JSON.stringify(payload) });
  }

  el.refresh.addEventListener('click', load);

  el.activate.addEventListener('click', async ()=>{
    try{
      if (!confirm('Activate panic alarm for your organisation?')) return;
      el.activate.disabled = true;
      await setPanic(true);
      await load();
      setLine('Panic Alarm Activated.');
    } catch(e){
      setLine('Activate failed: ' + e.message);
    } finally {
      el.activate.disabled = false;
    }
  });

  el.cancel.addEventListener('click', async ()=>{
    try{
      if (!confirm('Cancel / reset the panic alarm for your organisation?')) return;

      // ask for an optional resolution note (will be appended into note)
      const reason = prompt('Cancel / reset note (optional):', 'Resolved / false alarm') || '';
      if (reason && !el.msg.value) el.msg.value = reason;

      el.cancel.disabled = true;
      await setPanic(false);
      await load();
      setLine('Panic Alarm Cleared.');
    } catch(e){
      setLine('Reset failed: ' + e.message);
    } finally {
      el.cancel.disabled = false;
    }
  });

  // If not logged in but shared token exists, make it obvious the page is usable
  if (!isLoggedIn && hasSharedAccess()){
    const pill = document.getElementById('userPill');
    if (pill) pill.textContent = 'Shared Access';
  }

  load();
  setInterval(load, 30_000);
})();
</script>

</body>
</html>
