<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CityIntel — Panic Alarm</title>
<link rel="icon" href="favicon.ico">
<style>
  :root{
    --bg0:#07080a;
    --bg1:#0b0d10;
    --panel:rgba(16,18,22,.78);
    --panel2:rgba(18,20,26,.88);
    --border:rgba(255,255,255,.08);
    --text:#e9ecf1;
    --muted:rgba(233,236,241,.7);
    --muted2:rgba(233,236,241,.55);
    --accent:#b32b2b;
    --accent2:#ff4d4d;
    --ok:#2bd38f;
    --warn:#ffb020;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    color:var(--text);
    background:
      radial-gradient(1200px 700px at 50% 20%, rgba(179,43,43,.22), rgba(0,0,0,0) 60%),
      radial-gradient(900px 600px at 70% 80%, rgba(70,95,180,.16), rgba(0,0,0,0) 60%),
      linear-gradient(180deg, #050609, #090a0e 55%, #06070a);
    min-height:100vh;
  }

  /* Top bar (matches other pages) */
  .topbar{
    position:sticky; top:0; z-index:50;
    height:84px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 18px 0 18px;
    background: linear-gradient(90deg, rgba(130,18,18,.88), rgba(15,16,20,.88) 70%);
    border-bottom:1px solid rgba(255,255,255,.06);
    backdrop-filter: blur(10px);
  }
  .brand{
    display:flex; align-items:center; gap:14px;
  }
  .brand img{
    width:46px; height:46px; border-radius:12px;
    box-shadow: 0 10px 30px rgba(0,0,0,.45);
  }
  .brand .name{
    font-size:28px; font-weight:800; letter-spacing:.2px;
  }
  .topActions{ display:flex; align-items:center; gap:12px; }

  /* Layout */
  .wrap{
    max-width:1100px;
    margin: 22px auto 60px auto;
    padding: 0 16px;
    display:grid;
    grid-template-columns: 260px 1fr;
    gap:18px;
  }
  @media (max-width: 980px){
    .wrap{ grid-template-columns:1fr; }
  }

  .card{
    background: linear-gradient(180deg, var(--panel2), var(--panel));
    border:1px solid var(--border);
    border-radius:18px;
    box-shadow: 0 18px 60px rgba(0,0,0,.55);
  }
  .sideHint{
    padding:16px;
  }
  .sideHint h3{
    margin:0 0 10px 0; font-size:14px; letter-spacing:.3px; text-transform:uppercase; color:rgba(255,255,255,.78);
  }
  .sideHint p{
    margin:0 0 10px 0; color:var(--muted); line-height:1.35;
    font-size:13px;
  }

  .mainHeader{
    padding:18px 18px 14px 18px;
    display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
  }
  .mainHeader h1{
    margin:0;
    font-size:28px;
    letter-spacing:.2px;
  }
  .mainHeader .sub{
    margin-top:6px;
    color:var(--muted);
    font-size:13px;
    line-height:1.35;
    max-width:640px;
  }
  .backLink{
    color:#9cc5ff;
    text-decoration:none;
    font-weight:700;
    margin-top:6px;
  }
  .backLink:hover{ text-decoration:underline; }

  .panel{
    padding:18px;
  }

  .statusRow{
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding-bottom:14px; border-bottom:1px solid rgba(255,255,255,.07);
    margin-bottom:14px;
  }
  .statusPill{
    display:inline-flex; align-items:center; gap:10px;
    padding:10px 14px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.25);
    font-weight:800;
  }
  .dot{
    width:10px; height:10px; border-radius:999px;
    background: var(--ok);
    box-shadow: 0 0 0 4px rgba(43,211,143,.12);
  }
  .dot.red{
    background: var(--accent2);
    box-shadow: 0 0 0 4px rgba(255,77,77,.12);
  }
  .meta{
    margin-top:6px; color:var(--muted2); font-size:12px;
  }

  .btn{
    border:0;
    border-radius:999px;
    padding:12px 18px;
    font-weight:800;
    cursor:pointer;
    background: rgba(255,255,255,.92);
    color:#121318;
    box-shadow: 0 10px 28px rgba(0,0,0,.35);
  }
  .btn:active{ transform: translateY(1px); }
  .btn.secondary{
    background: rgba(255,255,255,.12);
    color: rgba(255,255,255,.92);
    border: 1px solid rgba(255,255,255,.12);
    box-shadow:none;
  }
  .btn.danger{
    background: linear-gradient(180deg, #ff5a5a, #e33636);
    color:#160b0b;
  }

  .grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:14px;
  }
  @media (max-width: 820px){
    .grid{ grid-template-columns:1fr; }
  }

  label{
    display:block;
    font-size:12px;
    color: rgba(255,255,255,.78);
    margin-bottom:7px;
    letter-spacing:.2px;
  }
  input, textarea{
    width:100%;
    border-radius:14px;
    background: rgba(0,0,0,.28);
    border: 1px solid rgba(255,255,255,.10);
    padding:12px 12px;
    color: rgba(255,255,255,.92);
    outline:none;
  }
  input::placeholder, textarea::placeholder{ color: rgba(255,255,255,.38); }
  textarea{ min-height:92px; resize:vertical; }

  .helpText{
    margin-top:8px;
    color: var(--muted2);
    font-size:12px;
    line-height:1.35;
  }

  .actions{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    padding-top:14px;
  }

  .toast{
    position:fixed;
    left:50%;
    bottom:18px;
    transform:translateX(-50%);
    padding:10px 14px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.55);
    color: rgba(255,255,255,.92);
    font-weight:700;
    display:none;
    z-index:100;
  }

  /* Small: match other pages user chip injected into #topActions */
  .chipWrap{ display:flex; align-items:center; gap:10px; }
</style>
<script src="auth.js"></script>
</head>
<body>

<header class="topbar">
  <div class="brand">
    <img src="cityintel_logo.png" alt="CityIntel Logo" onerror="this.style.display='none'">
    <div class="name">CityIntel</div>
  </div>
  <div id="topActions" class="topActions">
    <div id="fallbackGuestPill" class="statusPill" style="padding:10px 14px;">
      <span class="dot"></span>
      <span>Guest / Shared</span>
    </div>
  </div>
</header>

<main class="wrap">
  <aside class="card sideHint">
    <h3>Emergency use</h3>
    <p>This page can be used by logged-in staff or shared for emergency use on mobile.</p>
    <p>If you are using a shared link, enter your <b>invite code</b> and your name.</p>
    <p class="helpText"><b>Privacy note:</b> keep messages brief and avoid highly sensitive details.</p>
  </aside>

  <section>
    <div class="card mainHeader">
      <div>
        <h1>Panic Alarm</h1>
        <div class="sub">
          Use this only in an emergency test / real scenario. When activated, a banner appears for all users in your organisation.
          To reset after a false alarm, use <b>Reset Panic Alarm</b> and include a short note.
        </div>
      </div>
      <a class="backLink" href="index.html">Back to Dashboard</a>
    </div>

    <div class="card panel" style="margin-top:16px;">
      <div class="statusRow">
        <div>
          <div id="statusPill" class="statusPill">
            <span id="statusDot" class="dot"></span>
            <span id="statusText">Checking status…</span>
          </div>
          <div class="meta" id="statusMeta">—</div>
        </div>
        <button class="btn" id="btnRefresh">Refresh</button>
      </div>

      <div class="grid">
        <div>
          <label for="inviteCode">Invite code (for shared links)</label>
          <input id="inviteCode" placeholder="e.g. 8-char invite code" autocomplete="off" />
          <div class="helpText" id="inviteHelp">
            If you are logged in, this can be left blank. If you are using a shared link, this is required.
          </div>
        </div>
        <div>
          <label for="locationText">Location (optional)</label>
          <div style="display:flex; gap:10px; align-items:stretch;">
            <input id="locationText" placeholder="e.g. Lagos Airport / London HQ / City name" autocomplete="off" />
            <button class="btn secondary" id="btnUseLocation" type="button">Use my location</button>
          </div>
          <div class="helpText">We store this as text only in v1 (no precise coordinates).</div>
        </div>

        <div>
          <label for="firstName">First name</label>
          <input id="firstName" placeholder="First name" autocomplete="given-name" />
        </div>
        <div>
          <label for="surname">Surname</label>
          <input id="surname" placeholder="Surname" autocomplete="family-name" />
        </div>
      </div>

      <div style="margin-top:14px;">
        <label for="messageText">Message (optional)</label>
        <textarea id="messageText" placeholder="e.g. I need urgent assistance at [location]."></textarea>
        <div class="helpText">Tip: include what you need and who should respond (security / HR / local office lead).</div>
      </div>

      <div class="actions">
        <button class="btn danger" id="btnActivate">Activate Panic Alarm</button>
        <button class="btn" id="btnReset">Reset Panic Alarm</button>
        <button class="btn secondary" id="btnCopyShare">Copy share link</button>
      </div>
    </div>
  </section>
</main>

<div id="toast" class="toast"></div>

<script>
(function(){
  const API_BASE = 'https://api.cityintelapi.com/api';

  const els = {
    statusPill: document.getElementById('statusPill'),
    statusDot: document.getElementById('statusDot'),
    statusText: document.getElementById('statusText'),
    statusMeta: document.getElementById('statusMeta'),
    inviteCode: document.getElementById('inviteCode'),
    locationText: document.getElementById('locationText'),
    firstName: document.getElementById('firstName'),
    surname: document.getElementById('surname'),
    messageText: document.getElementById('messageText'),
    btnRefresh: document.getElementById('btnRefresh'),
    btnUseLocation: document.getElementById('btnUseLocation'),
    btnActivate: document.getElementById('btnActivate'),
    btnReset: document.getElementById('btnReset'),
    btnCopyShare: document.getElementById('btnCopyShare'),
    toast: document.getElementById('toast'),
    fallbackGuestPill: document.getElementById('fallbackGuestPill'),
  };

  function toast(msg){
    els.toast.textContent = msg;
    els.toast.style.display = 'block';
    clearTimeout(toast._t);
    toast._t = setTimeout(()=> els.toast.style.display='none', 2400);
  }

  function isLoggedIn(){
    return !!(window.CIAuth && typeof CIAuth.isLoggedIn === 'function' && CIAuth.isLoggedIn());
  }

  function who(){
    try { return CIAuth && CIAuth.who ? CIAuth.who() : null; } catch(e){ return null; }
  }

  function prefillFromUser(){
    if (!isLoggedIn()) return;
    const u = who();
    if (!u) return;
    // Hide guest pill, let injected chip show
    if (els.fallbackGuestPill) els.fallbackGuestPill.style.display = 'none';
    const name = (u.name || '').trim();
    if (name && (!els.firstName.value && !els.surname.value)){
      const parts = name.split(/\s+/).filter(Boolean);
      if (parts.length === 1) els.firstName.value = parts[0];
      if (parts.length >= 2){
        els.firstName.value = parts[0];
        els.surname.value = parts.slice(1).join(' ');
      }
    }
    // Invite code not needed when logged in
    els.inviteCode.placeholder = '(not required when logged in)';
  }

  function getInviteFromURL(){
    const q = new URLSearchParams(location.search);
    const code = (q.get('org') || q.get('invite') || q.get('code') || '').trim();
    if (code) els.inviteCode.value = code;
  }

  async function api(path, opts){
    const headers = Object.assign({'Content-Type':'application/json'}, (opts && opts.headers) || {});
    const o = Object.assign({}, opts || {}, {headers});
    // If auth.js provides a helper to attach headers, use it.
    try {
      if (isLoggedIn() && CIAuth && typeof CIAuth.attachAuthHeaders === 'function'){
        CIAuth.attachAuthHeaders(headers);
      }
    } catch(e){}
    const res = await fetch(API_BASE + path, o);
    let data = null;
    const ct = res.headers.get('content-type') || '';
    if (ct.includes('application/json')) data = await res.json().catch(()=>null);
    else data = await res.text().catch(()=>null);
    if (!res.ok){
      const msg = (data && data.error) ? data.error : (typeof data === 'string' ? data : res.statusText);
      const err = new Error(msg || ('HTTP ' + res.status));
      err.status = res.status;
      err.data = data;
      throw err;
    }
    return data;
  }

  function setStatus(active, meta){
    if (active){
      els.statusDot.classList.add('red');
      els.statusText.textContent = 'PANIC ALARM ACTIVE';
    } else {
      els.statusDot.classList.remove('red');
      els.statusText.textContent = 'No active panic alarm';
    }
    els.statusMeta.textContent = meta || '—';
  }

  function buildActivationPayload(){
    const first = (els.firstName.value || '').trim();
    const last = (els.surname.value || '').trim();
    const msg = (els.messageText.value || '').trim();
    const loc = (els.locationText.value || '').trim();
    return {
      name_first: first,
      name_last: last,
      message: msg,
      location: loc
    };
  }

  function requireSharedFields(){
    const code = (els.inviteCode.value || '').trim();
    const first = (els.firstName.value || '').trim();
    const last = (els.surname.value || '').trim();
    if (!code) throw new Error('Invite code is required for shared links.');
    if (!first || !last) throw new Error('Please enter first name and surname.');
    return code;
  }

  async function refreshStatus(){
    try{
      const data = await api('/org/panic/status', {method:'GET'});
      if (data && data.active){
        const by = data.activated_by || data.activatedBy || 'Unknown';
        const at = data.activated_at || data.activatedAt || '';
        const note = data.message || data.note || '';
        setStatus(true, `Activated by: ${by}${at ? ' • ' + at : ''}${note ? ' • Note: ' + note : ''}`);
      } else {
        const updated = (data && (data.updated_at || data.updatedAt)) ? (data.updated_at || data.updatedAt) : '';
        const note = (data && (data.message || data.note)) ? (data.message || data.note) : '';
        setStatus(false, `Last update: ${updated || '—'}${note ? ' • Note: ' + note : ''}`);
      }
    } catch(e){
      setStatus(false, 'Status check failed');
      console.error(e);
      toast('Status check failed');
    }
  }

  async function activate(){
    try{
      const payload = buildActivationPayload();
      if (isLoggedIn()){
        await api('/org/panic/activate', {method:'POST', body: JSON.stringify(payload)});
      } else {
        const code = requireSharedFields();
        await api('/org/panic/activate-shared', {method:'POST', body: JSON.stringify(Object.assign({invite_code: code}, payload))});
      }
      toast('Activated');
      await refreshStatus();
    } catch(e){
      console.error(e);
      toast('Activate failed: ' + (e.message || 'error'));
    }
  }

  async function reset(){
    try{
      const payload = buildActivationPayload();
      if (isLoggedIn()){
        await api('/org/panic/reset', {method:'POST', body: JSON.stringify(payload)});
      } else {
        const code = requireSharedFields();
        await api('/org/panic/reset-shared', {method:'POST', body: JSON.stringify(Object.assign({invite_code: code}, payload))});
      }
      toast('Reset sent');
      await refreshStatus();
    } catch(e){
      console.error(e);
      toast('Reset failed: ' + (e.message || 'error'));
    }
  }

  async function copyShareLink(){
    const code = (els.inviteCode.value || '').trim();
    const url = new URL(location.href);
    url.searchParams.set('org', code || '');
    const finalUrl = url.toString();
    try{
      await navigator.clipboard.writeText(finalUrl);
      toast('Share link copied');
    } catch(e){
      // fallback
      prompt('Copy this link:', finalUrl);
    }
  }

  async function useMyLocation(){
    if (!navigator.geolocation){
      toast('Geolocation not available');
      return;
    }
    els.btnUseLocation.disabled = true;
    els.btnUseLocation.textContent = 'Locating…';
    navigator.geolocation.getCurrentPosition(async (pos)=>{
      try{
        const {latitude, longitude} = pos.coords;
        // Reverse geocode via Nominatim (lightweight) - optional. If blocked, fall back.
        const label = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
        els.locationText.value = label;
        toast('Location set');
      } finally {
        els.btnUseLocation.disabled = false;
        els.btnUseLocation.textContent = 'Use my location';
      }
    }, (err)=>{
      els.btnUseLocation.disabled = false;
      els.btnUseLocation.textContent = 'Use my location';
      toast('Location denied');
    }, {enableHighAccuracy:false, timeout:8000, maximumAge:60000});
  }

  // Wire up
  els.btnRefresh.addEventListener('click', refreshStatus);
  els.btnActivate.addEventListener('click', activate);
  els.btnReset.addEventListener('click', reset);
  els.btnCopyShare.addEventListener('click', copyShareLink);
  els.btnUseLocation.addEventListener('click', useMyLocation);

  // Init
  getInviteFromURL();
  document.addEventListener('DOMContentLoaded', function(){
    try{
      if (window.CIAuth && typeof CIAuth.injectUserChip === 'function'){
        CIAuth.injectUserChip(document.getElementById('topActions'));
      }
    } catch(e){}
    prefillFromUser();
    refreshStatus();
  });

})();
</script>

</body>
</html>
