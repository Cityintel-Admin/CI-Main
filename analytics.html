<!doctype html>
<html lang="en">
<head>

<script src="metrics.js"></script>
<script src="auth.js"></script>
<script src="alerts-data.js"></script>

<script>
  CIAuth.requireAuth();
  CIAuth.requireRole(['admin']); // redirect to index if not admin
</script>


  <meta charset="utf-8" />
  <title>CityIntel â€” Analytics </title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --brand-red:#D01616; --brand-black:#0C0C0C;
      --g900:#111214; --g800:#16171a; --g700:#1c1e22; --g600:#24272c; --g500:#2e3238;
      --text:#e9edf2; --muted:#8e97a3; --ok:#33c48d; --warn:#f0b429; --danger:#ff5a5f;
      --radius:16px;
    }
    body{margin:0;background:linear-gradient(180deg,var(--g900),var(--g800));color:var(--text);font:14px/1.5 system-ui}
    .app{display:grid;grid-template-columns:260px 1fr;grid-template-rows:60px 1fr;grid-template-areas:"sidebar topbar" "sidebar main";min-height:100vh}
    .sidebar{grid-area:sidebar;background:#0c0c0c;border-right:1px solid var(--g600);display:flex;flex-direction:column;padding:18px 14px;gap:18px}
    .brand{display:flex;align-items:center;gap:10px;padding:8px 10px;background:rgba(208,22,22,.1);border-radius:12px}
    .brand img{width:34px;height:34px;background:#fff;border-radius:6px}
    nav a{display:flex;align-items:center;padding:10px 12px;border-radius:10px;text-decoration:none;color:var(--text);border:1px solid transparent}
    nav a:hover{background:var(--g600);border-color:var(--g500)}
    .sidebar .footnote{margin-top:auto;font-size:12px;color:var(--muted)}
    .topbar{grid-area:topbar;background:rgba(255,255,255,.02);border-bottom:1px solid var(--g600);display:flex;align-items:center;gap:12px;padding:10px 16px;position:sticky;top:0;z-index:10;backdrop-filter:blur(8px)}
    .search{flex:1;display:flex;align-items:center;gap:10px;background:var(--g700);border:1px solid var(--g600);border-radius:12px;padding:8px 12px;min-width:0}
    .search input{flex:1;min-width:0;background:transparent;border:none;outline:none;color:var(--text)}
    #topActions{margin-left:auto;display:flex;align-items:center;gap:10px;min-width:fit-content;position:relative}
    .user{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;background:var(--g700);border:1px solid var(--g600);cursor:pointer}
    .avatar{width:28px;height:28px;background:#fff;color:#000;border-radius:50%;display:grid;place-items:center;font-weight:700}
    .dropdown{position:absolute;right:0;top:calc(100% + 6px);background:#1a1c20;border:1px solid var(--g600);border-radius:10px;padding:6px 0;box-shadow:0 4px 12px rgba(0,0,0,.4);display:none;min-width:140px;z-index:50}
    .dropdown a{display:block;padding:8px 12px;color:var(--text);text-decoration:none;font-size:14px}
    .dropdown a:hover{background:rgba(255,255,255,.05)}

    .main{grid-area:main;padding:18px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{background:#16171a;border:1px solid var(--g600);border-radius:var(--radius);padding:16px}
    .card h3{margin:0 0 10px 0;font-size:16px}
    .kpi{display:flex;align-items:baseline;gap:10px}
    .kpi .value{font-size:28px;font-weight:800}
    .legend{font-size:12px;color:var(--muted)}
    .btn{display:inline-block;padding:8px 12px;border-radius:10px;border:1px solid var(--g500);text-decoration:none;color:var(--text)}
    .btn:hover{border-color:#D01616}

    /* simple bars */
    .bar{height:24px;border-radius:8px;background:#222;position:relative;overflow:hidden;border:1px solid var(--g600)}
    .bar > span{position:absolute;left:0;top:0;bottom:0}
  </style>
</head>
<body>
  <div class="app">
    <!-- SIDEBAR (no analytics link; injected elsewhere for admins only) -->
    <aside class="sidebar">
      <div class="brand"><img src="CityintLogo.jpg" alt=""><div>CityIntel</div></div>
      <nav>
        <a href="index.html">Dashboard</a>
        <a href="alerts.html">Alerts</a>
        <a href="events.html">Events</a>
        <a href="reports.html">Reports</a>
        <a href="settings.html">Settings</a>
      </nav>
      <div class="footnote">For information use only â€” not for redistribution</div>
    </aside>

    <!-- TOPBAR -->
    <header class="topbar">
      <div class="search">ðŸ”Ž <input placeholder="Searchâ€¦" /></div>
      <div id="topActions"></div>
    </header>

    <!-- MAIN -->
    <main class="main">

<div class="grid" style="margin-bottom:20px;">
  <section class="card" style="grid-column: span 3;">
    <h3>Subscriptions (All)</h3>
    <div class="kpi"><div id="kpiSubsAll" class="value">0</div></div>
    <div class="legend">Since launch</div>
  </section>

  <section class="card" style="grid-column: span 3;">
    <h3>Subscriptions (Monthly)</h3>
    <div class="kpi"><div id="kpiSubsMonthly" class="value">0</div></div>
    <div class="legend">New in last 30 days</div>
  </section>

  <section class="card" style="grid-column: span 3;">
    <h3>Site Visits (All)</h3>
    <div class="kpi"><div id="kpiVisitsAll" class="value">0</div></div>
    <div class="legend">Total since launch</div>
  </section>

  <section class="card" style="grid-column: span 3;">
    <h3>Site Visits (Monthly)</h3>
    <div class="kpi"><div id="kpiVisitsMonthly" class="value">0</div></div>
    <div class="legend">Past 30 days</div>
  </section>
</div>



<div class="grid" style="margin-bottom:20px;">
  <section class="card" style="grid-column:span 3">
    <h3>30-Day Free Members</h3>
    <div class="kpi"><div id="kpiTrial30" class="value">0</div></div>
    <div class="legend">Active trials (â‰¤30 days)</div>
  </section>
  <section class="card" style="grid-column:span 3">
    <h3>Paid Members</h3>
    <div class="kpi"><div id="kpiPaid" class="value" style="color:#33c48d">0</div></div>
    <div class="legend">Active paid (not cancelled)</div>
  </section>
  <section class="card" style="grid-column:span 3">
    <h3>Cancelled (All)</h3>
    <div class="kpi"><div id="kpiCancAll" class="value" style="color:#ff5a5f">0</div></div>
    <div class="legend">Total cancellations</div>
  </section>
  <section class="card" style="grid-column:span 3">
    <h3>Cancelled (Monthly)</h3>
    <div class="kpi"><div id="kpiCanc30" class="value" style="color:#ff5a5f">0</div></div>
    <div class="legend">Last 30 days</div>
  </section>
</div>

      <div class="grid">
        <!-- KPIs -->
        <section class="card" style="grid-column:span 3">
          <h3>Upcoming (all)</h3>
          <div class="kpi"><div id="kpiUpcoming" class="value">0</div></div>
          <div class="legend">Only future-dated alerts</div>
        </section>
        <section class="card" style="grid-column:span 3">
          <h3>High Risk</h3>
          <div class="kpi"><div id="kpiHigh" class="value" style="color:#ff5a5f">0</div></div>
          <div class="legend">Future high-risk only</div>
        </section>
        <section class="card" style="grid-column:span 3">
          <h3>Medium Risk</h3>
          <div class="kpi"><div id="kpiMed" class="value" style="color:#f0b429">0</div></div>
          <div class="legend">Future medium-risk only</div>
        </section>
        <section class="card" style="grid-column:span 3">
          <h3>Cities Covered</h3>
          <div class="kpi"><div id="kpiCities" class="value">0</div></div>
          <div class="legend">Unique cities with upcoming</div>
        </section>

        <!-- Risk Mix -->
        <section class="card" style="grid-column:span 12">
          <h3>Risk Mix (Global)</h3>
          <div id="riskMixAll" ></div>
          <div class="legend" style="margin-top:8px">Upcoming protests Globally by risk level</div>


          <h3>Risk Mix Africa(All)</h3>
          <div id="riskMixAfrica" ></div>
          <div class="legend" style="margin-top:8px">Upcoming protests by risk level Africa</div>


          <h3>Risk Mix Europe(All)</h3>
          <div id="riskMixEurope" ></div>
          <div class="legend" style="margin-top:8px">Upcoming protests by risk level Africa</div>


	  <h3>Risk Mix North America(All)</h3>
          <div id="riskMixNA" ></div>
          <div class="legend" style="margin-top:8px">Upcoming protests by risk level North America</div>


	  <h3>Risk Mix South America(All)</h3>
          <div id="riskMixSA" ></div>
          <div class="legend" style="margin-top:8px">Upcoming protests by risk level South America</div>


	  <h3>Risk Mix Asia(All)</h3>
          <div id="riskMixAsia" ></div>
          <div class="legend" style="margin-top:8px">Upcoming protests by risk level Asia</div>

	  <h3>Risk Mix Oceania(All)</h3>
          <div id="riskMixOceania" ></div>
          <div class="legend" style="margin-top:8px">Upcoming protests by risk level Oceania</div>

        </section>


        <!-- Upcoming by Day -->
        <section class="card" style="grid-column:span 6">
          <h3>Upcoming by Day (Next 14)</h3>
          <div id="byDay"></div>
          <div class="legend" style="margin-top:8px">Bars show count per day</div>
        </section>

        <!-- Top Cities -->
        <section class="card" style="grid-column:span 6">
          <h3>Top Cities (Upcoming)</h3>
          <table style="width:100%;border-collapse:collapse">
            <thead>
              <tr style="background:#1c1e22">
                <th style="padding:8px;text-align:left">City</th>
                <th style="padding:8px;text-align:left">Count</th>
              </tr>
            </thead>
            <tbody id="citiesBody"></tbody>
          </table>
        </section>
          </div>
</section>

  <!-- DATA -->


  <!-- ADMIN GUARD + USER CHIP -->
  <script>
    // Admin-only guard
    (function enforceAdmin(){
      let ok=false;
      try{
        const p = JSON.parse(localStorage.getItem('ci_profile')||'{}');
        ok = localStorage.getItem('ci_subscribed')==='true' &&
             ((p.role||'').toLowerCase()==='admin' || p.is_admin===true);
      }catch(e){}
      if(!ok){ location.replace('index.html'); }
    })();

    // User chip (re-using your pattern)
    (function mountTopActions(){
      const host = document.getElementById('topActions');
      if (!host) return;
      const isSub = localStorage.getItem('ci_subscribed') === 'true';
      let initials='CI', role='Analyst';
      try{
        const p=JSON.parse(localStorage.getItem('ci_profile')||'{}');
        if (p.name){
          const parts=p.name.trim().split(/\s+/);
          initials=parts.slice(0,2).map(s=>s[0]?.toUpperCase()||'').join('')||'CI';
        }
        if (p.role) role=p.role;
      }catch(e){}
      host.innerHTML='';
      if (isSub){
        host.innerHTML = `
          <div class="user" id="userChip"><div class="avatar">${initials}</div>${role}</div>
          <div class="dropdown" id="userMenu"><a href="#" id="logoutLink">Log out</a></div>`;
        const chip=document.getElementById('userChip'), menu=document.getElementById('userMenu');
        chip.addEventListener('click',()=>{menu.style.display=menu.style.display==='block'?'none':'block';});
        document.addEventListener('click',e=>{ if(!host.contains(e.target)) menu.style.display='none'; });
        document.getElementById('logoutLink').addEventListener('click',e=>{
          e.preventDefault(); localStorage.removeItem('ci_subscribed'); localStorage.removeItem('ci_profile'); location.reload();
        });
      } else {
        const here=location.pathname.split('/').pop()||'index.html';
        const next=encodeURIComponent(here+location.search+location.hash);
        host.innerHTML = `<a class="btn" href="login.html?next=${next}">Log in</a>`;
      }
    })();
  </script>




  <!-- ANALYTICS RENDERER -->
  <script>
  (function renderAnalytics(){
    // ---------- Admin chip already mounted above ----------

    // ---------- Tolerant date parsing ----------
       const LONDON_TZ = 'Europe/London';
    const now = new Date();

    function parseDate(obj){
      const cand = obj.time || obj.datetime || obj.date || '';
      if (!cand) return null;

      // 1) Native parse
      let d = new Date(cand);
      if (!isNaN(d)) return d;

      // 2) ISO date only (YYYY-MM-DD) -> force midday UTC
      const iso = String(cand).match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (iso) {
        d = new Date(`${iso[1]}-${iso[2]}-${iso[3]}T12:00:00Z`);
        if (!isNaN(d)) return d;
      }

      // 3) "25 Oct 2025"
      const dmy = String(cand).match(/^(\d{1,2})\s+([A-Za-z]{3,})\s+(\d{4})$/);
      if (dmy) {
        d = new Date(`${dmy[1]} ${dmy[2]} ${dmy[3]} 12:00:00 GMT`);
        if (!isNaN(d)) return d;
      }

      return null;
    }

    function normRisk(r='') {
      const s = String(r).toLowerCase();
      if (s.startsWith('hi') || s.includes('high')) return 'high';
      if (s.startsWith('me') || s.includes('medium')) return 'med';
      if (s.startsWith('lo') || s.includes('low')) return 'low';
      return 'low';
    }


    // ---------- Load alerts data safely ----------
    if (!Array.isArray(window.alertsData)) {
      console.warn('alerts-data.js not loaded or malformed.');
      window.alertsData = [];
    }

    const raw = window.alertsData;
    const all = raw.map(a => {
      const _dt = parseDate(a);
      return {
        ...a,
        risk: normRisk(a.risk),
        city: a.city || '',
        _dt
      };
    });

  // If nothing parses, avoid total wipe-out: treat undated as future.
  const anyParsed = all.some(x => x._dt instanceof Date);
  let upcoming = all
    .filter(a => a._dt ? (a._dt >= now) : !anyParsed) // keep undated only if nothing parsed
    .sort((a,b) => {
      if (a._dt && b._dt) return a._dt - b._dt;
      if (a._dt) return -1;
      if (b._dt) return 1;
      return 0;
    });


    // ---------- KPIs: Upcoming / High / Med / Cities ----------
    const high = upcoming.filter(d=>d.risk==='high').length;
    const med  = upcoming.filter(d=>d.risk==='med').length;
    const low  = upcoming.filter(d=>d.risk==='low').length;

    const setText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };

setText('kpiUpcoming', upcoming.length);
    setText('kpiHigh', high);
    setText('kpiMed',  med);
    setText('kpiCities', new Set(upcoming.map(d=> (d.city||'').split('/')[0].trim())).size);

    // ---------- Risk Mix bars ----------
function renderGlobalRiskMix(upcoming) {
  const counts = { high:0, med:0, low:0 };
  upcoming.forEach(s => { counts[s.risk] = (counts[s.risk] || 0) + 1; });

 const total = Math.max(1, upcoming.length);

  const makeBar = (label, count, color) => {
    const pct = (count / total) * 100;
    return `
      <div class="bar" title="${label}">
        <span style="width:${pct}%; background:${color};
                     display:flex; align-items:center; justify-content:flex-end;
                     padding-right:4px; font-size:12px; color:#fff;">
          ${upcoming.length ? pct.toFixed(0)+'%' : ''}
        </span>
      </div>
    `;
  };

  document.getElementById('riskMixAll').innerHTML = `
    ${makeBar('High', counts.high, '#5c2b2b')}
    ${makeBar('Medium', counts.med, '#473a23')}
    ${makeBar('Low', counts.low, '#20312b')}
    <div class="legend" style="margin-top:8px">
      ${upcoming.length ? `${upcoming.length} upcoming protests (global)` : `No upcoming protests`}
    </div>
  `;
}

renderGlobalRiskMix(upcoming);
renderRiskMixByContinent('Africa', 'riskMixAfrica');
renderRiskMixByContinent('Europe', 'riskMixEurope');
renderRiskMixByContinent('North America', 'riskMixNA');
renderRiskMixByContinent('South America', 'riskMixSA');
renderRiskMixByContinent('Asia', 'riskMixAsia');
renderRiskMixByContinent('Oceania', 'riskMixOceania');

// ---- Helper: render 3-bar risk mix inside a container ----
function renderRiskMixByContinent(continentName, mountId) {
  const mount = document.getElementById(mountId);
  if (!mount) return;

  // Filter upcoming by continent (case-insensitive)
  const subset = (upcoming || []).filter(a => 
    String(a.continent || '').toLowerCase() === String(continentName || '').toLowerCase()
  );

  // Tally
  const counts = { high:0, med:0, low:0 };
  subset.forEach(s => { counts[s.risk] = (counts[s.risk] || 0) + 1; });

  // Total (avoid divide-by-zero)
  const total = Math.max(1, subset.length);

  // Build bars (same style as main Risk Mix)

const makeBar = (label, count, color) => {
    const pct = (count / total) * 100;
    return `
      <div class="bar" title="${label}">
        <span style="width:${pct}%; background:${color};
                     display:flex; align-items:center; justify-content:flex-end;
                     padding-right:4px; font-size:12px; color:#fff;">
          ${subset.length ? pct.toFixed(0)+'%' : ''}
        </span>
      </div>
    `;
  };

  mount.innerHTML = `
    ${makeBar('High', counts.high, '#5c2b2b')}
    ${makeBar('Medium', counts.med, '#473a23')}
    ${makeBar('Low', counts.low, '#20312b')}
    <div class="legend" style="margin-top:8px">
      ${subset.length ? `${subset.length} upcoming in ${continentName}` : `No upcoming in ${continentName}`}
    </div>
  `;
}


    // ---------- Upcoming by Day (next 14 labels) ----------
    const byDayMap = {};
    upcoming.forEach(d=>{
      if (!d._dt) return;
      const key = d._dt.toLocaleDateString('en-GB',{timeZone:LONDON_TZ});
      byDayMap[key] = (byDayMap[key]||0)+1;
    });
    const byDayArr = Object.entries(byDayMap).sort((a,b)=>{
      const da = new Date(a[0].split('/').reverse().join('-'));
      const db = new Date(b[0].split('/').reverse().join('-'));
      return da - db;
    }).slice(0,19);

    const byDayHost = document.getElementById('byDay');
    if (byDayHost) {
      byDayHost.innerHTML = '';
      if (byDayArr.length === 0) {
        byDayHost.innerHTML = `<div style="color:#8e97a3">No upcoming dates.</div>`;
      } else {
        const max = Math.max(...byDayArr.map(x=>x[1]));
        byDayArr.forEach(([day,count])=>{
          const row=document.createElement('div');
          row.style.display='grid';
          row.style.gridTemplateColumns='110px 1fr 32px';
          row.style.alignItems='center';
          row.style.gap='8px';
          row.style.margin='6px 0';
          row.innerHTML = `
            <div style="color:#c9d1d9">${day}</div>
            <div class="bar"><span style="width:${(count/max)*100}%; background:#2e3238"></span></div>
            <div style="text-align:right">${count}</div>
          `;
          byDayHost.appendChild(row);
        });
      }
    }

    // ---------- Top Cities ----------
    const citiesBody=document.getElementById('citiesBody');
    if (citiesBody){
      citiesBody.innerHTML='';
      const cityCount = {};
      upcoming.forEach(d=>{
        const c=(d.city||'').split('/')[0].trim();
        if(!c) return;
        cityCount[c]=(cityCount[c]||0)+1;
      });
      const rows = Object.entries(cityCount).sort((a,b)=>b[1]-a[1]).slice(0,10);
      if (rows.length === 0) {
        const tr=document.createElement('tr');
        tr.innerHTML = `<td style="padding:8px;color:#8e97a3" colspan="2">No upcoming data.</td>`;
        citiesBody.appendChild(tr);
      } else {
        rows.forEach(([city,count])=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `<td style="padding:8px">${city}</td><td style="padding:8px">${count}</td>`;
          citiesBody.appendChild(tr);
        });
      }
    }


    // ---------- Metrics (subs / visits / cancels) ----------
    const DAY_MS = 24*60*60*1000;
    const sinceDays = (iso, days) => { const d=new Date(iso); return !isNaN(d) && (now - d) <= (days*DAY_MS); };
    const evs = (window.CIMetrics && CIMetrics.getEvents && CIMetrics.getEvents()) || [];

    const subsAll   = evs.filter(e => e.type==='subscribe');
    const subs30    = subsAll.filter(e => sinceDays(e.ts, 30));
    const cancAll   = evs.filter(e => e.type==='cancel');
    const canc30    = cancAll.filter(e => sinceDays(e.ts, 30));
    const visitsAll = evs.filter(e => e.type==='visit');
    const visits30  = visitsAll.filter(e => sinceDays(e.ts, 30));

    const byEmail = {};
    evs.forEach(e=>{
      const key=(e.email||'').toLowerCase();
      if(!key) return;
      (byEmail[key]=byEmail[key]||[]).push(e);
    });
    let trial30Count=0, paidCount=0;
    Object.values(byEmail).forEach(list=>{
      list.sort((a,b)=> new Date(a.ts)-new Date(b.ts));
      const lastSub = [...list].reverse().find(ev=>ev.type==='subscribe');
      const lastCancel = [...list].reverse().find(ev=>ev.type==='cancel');
      const canceledAfter = lastCancel && lastSub && new Date(lastCancel.ts) > new Date(lastSub.ts);
      if (lastSub && !canceledAfter){
        if (lastSub.plan === 'paid') paidCount += 1;
        else if (sinceDays(lastSub.ts, 30)) trial30Count += 1;
      }
    });

    setText('kpiSubsAll', subsAll.length);
    setText('kpiSubsMonthly', subs30.length);
    setText('kpiVisitsAll', visitsAll.length);
    setText('kpiVisitsMonthly', visits30.length);
    setText('kpiTrial30', trial30Count);
    setText('kpiPaid', paidCount);
    setText('kpiCancAll', cancAll.length);
    setText('kpiCanc30', canc30.length);
  })();
</script>

</body>
</html>