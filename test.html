<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CityIntel Live Feed</title>
  <link rel="stylesheet" href="style.css" />

  <style>
    /* LIVE badge animation */
    .live-badge {
      position: absolute;
      top: 12px;
      right: 18px;
      background-color: #ff1e1e;
      color: white;
      font-weight: bold;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 6px;
      animation: pulse 1.2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.05); }
    }
  </style>
</head>

<body>
  <!-- Page Guard -->
  <script>
    CIAuth.requireAuth();
  </script>

  <!-- Sidebar + Banner (unchanged) -->
  <div class="brandbar">
    <img src="CityintLogo.jpg" alt="CityIntel Logo" />
    <div class="title">CityIntel</div>
    <div id="trial-banner" style="display:none;background:none;color:#fecaca;padding:8px;text-align:center;">
      <span id="trial-text">Your trial ends soon.</span>
    </div>
    <div id="topActions" style="position:relative"></div>
  </div>

  <div class="sidebar">
    <a href="index.html">Dashboard</a>
    <a href="alerts.html">Alerts</a>
    <a href="live-feed.html" class="active">Live Feed</a>
    <a href="incident.html">Incidents</a>
    <a href="reports.html">Reports</a>
    <a href="settings.html">Settings</a>
    <a href="#" onclick="CIAuth.logout();location.href='login.html';" style="color:#f87171;">Log Out</a>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="header">
      <h1>Live Intelligence Feed</h1>
      <button id="addFeed" class="add-feed-btn">Add Feed</button>
    </div>

    <div id="feedsContainer" class="feeds-grid"></div>
  </div>

  <!-- Feed Settings Modal -->
  <div id="feedModal" class="modal">
    <div class="modal-content">
      <h2>Feed Settings</h2>
      <label>Cities (comma-separated):</label>
      <input type="text" id="feedCities" placeholder="e.g. London, Paris, Berlin" />
      <label>Risk Levels:</label>
      <select id="feedRisk" multiple>
        <option value="high">High</option>
        <option value="med">Medium</option>
        <option value="low">Low</option>
      </select>
      <label>
        <input type="checkbox" id="feedLiveToggle" />
        Use Live Intel Feed (beta)
      </label>
      <div class="modal-actions">
        <button id="saveFeed" class="btn-primary">Save</button>
        <button id="cancelFeed" class="btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Incident Panel (slide-in) -->
  <div id="incidentPanel" class="incident-panel">
    <div class="panel-content">
      <button class="close-panel">&times;</button>
      <div id="incidentDetails"></div>
      <button id="viewFullIncident" class="btn-primary" style="margin-top:15px;">View Full Incident</button>
    </div>
  </div>

  <script>
    // ---------- FEED SYSTEM ----------
    const feedsContainer = document.getElementById("feedsContainer");
    const addFeedBtn = document.getElementById("addFeed");
    const feedModal = document.getElementById("feedModal");
    const feedCities = document.getElementById("feedCities");
    const feedRisk = document.getElementById("feedRisk");
    const feedLiveToggle = document.getElementById("feedLiveToggle");
    const saveFeedBtn = document.getElementById("saveFeed");
    const cancelFeedBtn = document.getElementById("cancelFeed");

    let feeds = JSON.parse(localStorage.getItem("cityintel_feeds") || "[]");
    let editingIndex = null;

    function renderFeeds() {
      feedsContainer.innerHTML = "";
      feeds.forEach((feed, idx) => {
        const card = document.createElement("div");
        card.className = "feed-card";
        card.style.position = "relative";

        const header = document.createElement("div");
        header.innerHTML = `<h3>${feed.cities.join(", ")}</h3>
                            <span style="color:#9ca3af">Risk: ${feed.risk.join(", ")}</span>`;

        if (feed.useLive) {
          const badge = document.createElement("div");
          badge.className = "live-badge";
          badge.textContent = "LIVE";
          card.appendChild(badge);
        }

        const editBtn = document.createElement("button");
        editBtn.textContent = "Edit";
        editBtn.className = "btn-secondary";
        editBtn.style.position = "absolute";
        editBtn.style.bottom = "12px";
        editBtn.style.right = "12px";
        editBtn.onclick = () => openFeedModal(feed, idx);

        const list = document.createElement("div");
        list.className = "feed-list";
        card.appendChild(header);
        card.appendChild(list);
        card.appendChild(editBtn);
        feedsContainer.appendChild(card);

        refreshFeedCard(card, feed);
      });
    }

    async function refreshFeedCard(card, feed) {
      const list = card.querySelector(".feed-list");
      list.innerHTML = "<p style='color:#888;'>Loading...</p>";

      try {
        let url = feed.useLive
          ? `https://api.cityintelapi.com/api/live-news?cities=${feed.cities.join(",")}&risk=${feed.risk.join(",")}`
          : `https://api.cityintelapi.com/api/live?cities=${feed.cities.join(",")}&risk=${feed.risk.join(",")}`;

        if (feed.useLive) console.log("Live feed active");

        const res = await fetch(url);
        const data = await res.json();

        list.innerHTML = "";
        (data.events || []).forEach((ev) => {
          const row = document.createElement("div");
          row.className = "feed-row";
          row.textContent = `${ev.city} â€” ${ev.title}`;
          row.onclick = () => openIncidentPanel(ev);
          list.appendChild(row);
        });
      } catch (err) {
        list.innerHTML = `<p style='color:#f87171;'>Error loading feed</p>`;
      }
    }

    function openFeedModal(feed = null, idx = null) {
      feedCities.value = feed ? feed.cities.join(", ") : "";
      Array.from(feedRisk.options).forEach((opt) => (opt.selected = feed?.risk.includes(opt.value)));
      feedLiveToggle.checked = !!feed?.useLive;
      editingIndex = idx;
      feedModal.style.display = "flex";
    }

    function closeFeedModal() {
      feedModal.style.display = "none";
      editingIndex = null;
    }

    saveFeedBtn.onclick = () => {
      const cities = feedCities.value.split(",").map((c) => c.trim()).filter(Boolean);
      const risk = Array.from(feedRisk.selectedOptions).map((o) => o.value);
      const useLive = feedLiveToggle.checked;

      if (!cities.length) return alert("Please enter at least one city.");

      const newFeed = { cities, risk, useLive };
      if (editingIndex !== null) feeds[editingIndex] = newFeed;
      else feeds.push(newFeed);

      localStorage.setItem("cityintel_feeds", JSON.stringify(feeds));
      closeFeedModal();
      renderFeeds();
    };

    cancelFeedBtn.onclick = closeFeedModal;
    addFeedBtn.onclick = () => openFeedModal();

    // ---------- INCIDENT PANEL ----------
    const incidentPanel = document.getElementById("incidentPanel");
    const incidentDetails = document.getElementById("incidentDetails");
    const closePanelBtn = document.querySelector(".close-panel");
    const viewFullIncident = document.getElementById("viewFullIncident");

    let selectedIncident = null;

    function openIncidentPanel(ev) {
      selectedIncident = ev;
      incidentDetails.innerHTML = `
        <h3>${ev.title}</h3>
        <p><strong>City:</strong> ${ev.city}</p>
        <p><strong>Risk:</strong> ${ev.risk}</p>
        <p><strong>Source:</strong> ${ev.src}</p>
      `;
      incidentPanel.classList.add("open");
    }

    closePanelBtn.onclick = () => incidentPanel.classList.remove("open");

    viewFullIncident.onclick = () => {
      if (!selectedIncident) return;
      localStorage.setItem("selectedIncident", JSON.stringify(selectedIncident));
      location.href = "incident.html";
    };

    // ---------- INIT ----------
    renderFeeds();
  </script>
</body>
</html>
