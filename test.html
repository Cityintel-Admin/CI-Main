
<!doctype html>
<html lang="en">
<head>

  <script src="auth.js"></script>


<script>
(function pageGuard(){
  const NEED_LOGIN = true;          // this page requires a login
  const NEED_SUB = false;           // set to true on pages that require an active sub

  // Must be logged in?
  if (NEED_LOGIN && (!window.CIAuth || !CIAuth.isLoggedIn())) {
    const here = location.pathname.split('/').pop() || 'index.html';
    const next = encodeURIComponent(here + location.search + location.hash);
    location.href = 'login.html?next=' + next;
    return;
  }

  // Must be subscribed?
  if (NEED_SUB) {
    const isSub = localStorage.getItem('ci_subscribed') === 'true';
    if (!isSub) {
      location.href = 'subscribe.html';
      return;
    }
  }
})();
</script>

<script>
(function compatProfileShim(){
  if (!window.CIAuth || !CIAuth.isLoggedIn()) return;
  const u = CIAuth.who();
  if (!u) return;
  localStorage.setItem('ci_profile', JSON.stringify({
    name: u.name || 'CityIntel User',
    email: u.email,
    role: u.role || 'Admin',
    is_admin: (u.role||'').toLowerCase()==='admin'
  }));
  // Do NOT auto-set ci_subscribed here anymore
})();
</script>


  
  <meta charset="utf-8" />
  <title>CityIntel — Live Feed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <style>
      :root{--brand-red:#D01616;--gray-900:#111214;--gray-800:#16171a;--gray-700:#1c1e22;--gray-600:#24272c;--gray-500:#2e3238;--text:#e9edf2}
      body{margin:0;font:14px/1.5 system-ui;background:linear-gradient(180deg,var(--gray-900),var(--gray-800));color:var(--text)}

     .app{display:grid;grid-template-columns:260px 1fr;grid-template-rows:60px 1fr;grid-template-areas:"sidebar topbar" "sidebar main";min-height:100vh}
    .sidebar{grid-area:sidebar;background:#0c0c0c;border-right:1px solid var(--gray-600);display:flex;flex-direction:column;padding:18px 14px;gap:18px}
      nav a{display:flex;align-items:center;padding:10px 12px;border-radius:10px;text-decoration:none;color:var(--text);border:1px solid transparent}
      nav a:hover{background:var(--gray-600);border-color:var(--gray-500)}
      nav a.active{background:rgba(208,22,22,0.15);border-color:var(--brand-red)}

    .topbar{ grid-area: topbar;background: rgba(255,255,255,0.02);border-bottom:1px solid var(--brand-gray-600);display:flex; align-items:center; gap:12px;
     padding:10px 16px;position:sticky; top:0; z-index:10;backdrop-filter: blur(8px);}

#topActions{margin-left:auto;display:flex; align-items:center; gap:10px;min-width: fit-content;position: relative;}
    
    .user{ display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;
  background:#1c1e22;border:1px solid #24272c;cursor:pointer;
}
    .avatar{ width:28px;height:28px;background:#fff;color:#000;border-radius:50%;
  display:grid;place-items:center;font-weight:700;
}
    .dropdown{ position:absolute;right:0;top:calc(100% + 6px);background:#1a1c20;border:1px solid #24272c;
  border-radius:10px;padding:6px 0;box-shadow:0 4px 12px rgba(0,0,0,.4);display:none;min-width:140px;z-index:50;
}
    .dropdown a{display:block;padding:8px 12px;color:#e9edf2;text-decoration:none;font-size:14px}
    .dropdown a:hover{background:rgba(255,255,255,0.05)}

  .brandbar{display:flex;align-items:center;gap:10px;padding:16px 20px;border-bottom:1px solid var(--line);
    background:linear-gradient(90deg,rgba(208,22,22,.2),rgba(208,22,22,0))}
  .brandbar img{width:auto;height:60px;object-fit:contain;border-radius:6px;background:#fff}



    #trial-banner{
      flex:1;
      text-align:center;
      font-size:12px;
      font-weight:600;
      color:#fecaca;
    }


    .logout-link{
      color:#8e97a3;
      font-size:12px;
    }

    .main{
      grid-area:main;
      padding:18px;
    }

    .page-head{
      display:flex;
      align-items:flex-start;
      flex-wrap:wrap;
      gap:12px;
      margin-bottom:16px;
    }
    .page-head-left h2{
      margin:0;
      font-size:16px;
      font-weight:600;
      color:var(--text);
    }
    .page-head-left .sub{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }
    .page-head-right{
      margin-left:auto;
      display:flex;
      flex-direction:column;
      align-items:center;
      min-width:160px;
      gap:8px;
    }

    .btn-red{
      background:#D01616;
      color:#fff;
      font-size:13px;
      font-weight:600;
      border:1px solid #D01616;
      border-radius:10px;
      padding:8px 12px;
      cursor:pointer;
      line-height:1.2;
      text-align:center;
      min-width:140px;
    }
    .btn-red:hover{
      background:#ff2a2a;
      border-color:#ff2a2a;
    }

    .feeds-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(min(360px,100%),1fr));
      gap:16px;
    }

    .feed-card{
      background:linear-gradient(180deg,#1a1c20,#131417);
      border:1px solid var(--g600);
      border-radius:16px;
      display:flex;
      flex-direction:column;
      min-height:260px;
      max-height:400px;
    }

    .feed-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      border-bottom:1px solid var(--g600);
      padding:12px 16px;
    }
    .feed-head-left{
      font-size:13px;
      color:var(--text);
      line-height:1.4;
    }
    .feed-city{
      font-weight:600;
      font-size:14px;
      color:#fff;
    }
    .feed-risk{
      display:inline-block;
      font-size:11px;
      line-height:1.2;
      font-weight:600;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.15);
    }
    .feed-risk.high{
      background:rgba(255,90,95,.12);
      border-color:rgba(255,90,95,.35);
      color:#ff5a5f;
    }
    .feed-risk.med{
      background:rgba(240,180,41,.12);
      border-color:rgba(240,180,41,.35);
      color:#f0b429;
    }
    .feed-risk.low{
      background:rgba(51,196,141,.12);
      border-color:rgba(51,196,141,.35);
      color:#33c48d;
    }
    .feed-head-right{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:4px;
    }


	  
	  
/* LIVE badge in feed header */
    .live-pill {
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:rgba(208,22,22,0.15);
      border:1px solid #D01616;
      color:#ff4d4d;
      font-size:11px;
      font-weight:600;
      line-height:1.2;
      padding:3px 8px;
      border-radius:999px;
    }
    .live-dot {
      width:6px;
      height:6px;
      border-radius:50%;
      background:#ff4d4d;
      box-shadow:0 0 6px #ff4d4d,0 0 10px #ff4d4d;
    }

    /* checkbox row in modal */
    .modal-row-inline {
      display:flex;
      align-items:flex-start;
      gap:8px;
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
      margin-bottom:12px;
    }
    .modal-row-inline input[type="checkbox"] {
      margin-top:2px;
      accent-color:#D01616; /* modern browsers */
    }
    .modal-row-inline .live-row-text {
      color:#fff;
      font-size:13px;
      line-height:1.4;
    }
    .modal-row-inline .live-row-hint {
      font-size:11px;
      color:var(--muted);
      line-height:1.4;
    }

	  
	  
    .btn-ghost{
      background:#1f2024;
      color:#e9edf2;
      border:1px solid var(--g600);
      border-radius:8px;
      padding:4px 8px;
      font-size:12px;
      line-height:1.2;
      cursor:pointer;
    }
    .btn-ghost:hover{
      background:#2a2d32;
    }

    .feed-body{
      flex:1;
      overflow-y:auto;
      padding:12px 16px 16px;
      font-size:13px;
    }
    .feed-item{
      border-left:4px solid #D01616;
      background:linear-gradient(90deg,rgba(208,22,22,.1),rgba(208,22,22,0));
      border-radius:8px;
      border:1px solid var(--g600);
      padding:10px 12px;
      margin-bottom:10px;
      cursor:pointer;
    }
    .feed-item:last-child{
      margin-bottom:0;
    }
    .feed-title-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:8px;
      font-size:13px;
      font-weight:600;
      color:#fff;
    }
    .feed-meta{
      font-size:11px;
      color:var(--muted);
      line-height:1.4;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }

    .feed-footer{
      border-top:1px solid var(--g600);
      padding:10px 16px;
      font-size:11px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .feed-footer .src{
      color:var(--muted);
    }
    .feed-footer .refresh{
      cursor:pointer;
      color:#8e97a3;
    }
    .feed-footer .refresh:hover{
      color:#fff;
    }

    /* slide-in detail panel */
    .detail-panel{
      position:fixed;
      top:0;
      right:0;
      height:100vh;
      width:360px;
      max-width:80%;
      background:#1a1c20;
      border-left:1px solid var(--g600);
      box-shadow:-20px 0 40px rgba(0,0,0,.8);
      color:#e9edf2;
      font-size:13px;
      line-height:1.5;
      display:flex;
      flex-direction:column;
      transform:translateX(100%);
      transition:transform .25s ease;
      z-index:10000;
    }
    .detail-panel.open{
      transform:translateX(0%);
    }

    .detail-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      padding:16px;
      border-bottom:1px solid var(--g600);
      background:#131417;
    }
    .detail-head-left{
      max-width:260px;
    }
    .detail-title{
      font-size:14px;
      font-weight:600;
      color:#fff;
      margin-bottom:4px;
    }
    .detail-meta{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }
    .detail-close{
      background:none;
      border:0;
      color:#8e97a3;
      font-size:12px;
      cursor:pointer;
      padding:4px 6px;
      border-radius:6px;
    }
    .detail-close:hover{
      color:#fff;
      background:#2a2d32;
    }

    .detail-body{
      flex:1;
      overflow-y:auto;
      padding:16px;
    }
    .detail-section{
      margin-bottom:16px;
      background:linear-gradient(180deg,#1a1c20,#131417);
      border:1px solid var(--g600);
      border-radius:12px;
      padding:12px;
    }
    .detail-section h4{
      margin:0 0 6px;
      font-size:12px;
      font-weight:600;
      color:#fff;
      text-transform:uppercase;
      letter-spacing:.03em;
    }
    .detail-section .small{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }

    .detail-footer{
      border-top:1px solid var(--g600);
      background:#131417;
      padding:12px 16px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .btn-full-incident{
      background:#D01616;
      color:#fff;
      border:1px solid #D01616;
      border-radius:10px;
      padding:10px 12px;
      font-size:13px;
      font-weight:600;
      line-height:1.2;
      text-align:center;
      text-decoration:none;
      cursor:pointer;
    }
    .btn-full-incident:hover{
      background:#ff2a2a;
      border-color:#ff2a2a;
    }

    .btn-back-dash{
      display:inline-block;
      text-decoration:none;
      color:#ff5a5f;
      font-size:12px;
      font-weight:600;
      text-align:center;
    }

    /* Add Feed modal */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:10001;
    }
    .modal-box{
      background:#1a1c20;
      border:1px solid var(--g600);
      border-radius:16px;
      width:320px;
      max-width:90%;
      box-shadow:0 30px 60px rgba(0,0,0,.9);
      padding:16px;
      color:var(--text);
      font-size:13px;
    }
    .modal-box h3{
      margin:0 0 12px;
      font-size:14px;
      font-weight:600;
      color:#fff;
    }
    .modal-row{
      margin-bottom:12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .modal-row label{
      font-size:12px;
      color:var(--muted);
    }
    .modal-row input, .modal-row select{
      background:#1f2024;
      border:1px solid var(--g600);
      border-radius:8px;
      color:#fff;
      padding:8px 10px;
      font-size:13px;
      line-height:1.4;
      outline:none;
      width:100%;
    }
    .modal-row input:focus,
    .modal-row select:focus{
      border-color:#D01616;
    }
    .modal-actions{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .btn-cancel{
      background:#1f2024;
      border:1px solid var(--g600);
      border-radius:8px;
      color:#8e97a3;
      font-size:12px;
      line-height:1.2;
      padding:8px 10px;
      cursor:pointer;
      flex:1;
      text-align:center;
    }
    .btn-cancel:hover{
      background:#2a2d32;
      color:#fff;
    }
    .btn-save{
      background:#D01616;
      border:1px solid #D01616;
      border-radius:8px;
      color:#fff;
      font-size:12px;
      font-weight:600;
      line-height:1.2;
      padding:8px 10px;
      cursor:pointer;
      flex:1;
      text-align:center;
    }
    .btn-save:hover{
      background:#ff2a2a;
      border-color:#ff2a2a;
    }

    @media (max-width:900px){
      .app{
        grid-template-columns:1fr;
        grid-template-areas:
          "topbar"
          "main";
      }
      .sidebar{
        display:none;
      }
      .detail-panel{
        width:80%;
        max-width:400px;
      }
    }
  </style>
</head>


  <script>
  // must be after the header DOM exists
  document.addEventListener('DOMContentLoaded', function(){
    CIAuth.injectUserChip(document.getElementById('topActions'));
    CIAuth.updateSidebarForRole(document.querySelector('aside.sidebar nav'));
  });
</script>

  
<body>
    
 <div class="brandbar">
    <img src="CityintLogo.jpg" alt="CityIntel Logo">
    <div class="title" style="font-weight:700;font-size:18px">CityIntel</div>
	<div id="trial-banner" style="display:none;position:absolute;
    left:50%; transform:translateX(-50%); background:none;
    color:#fecaca; padding:8px 12px; text-align:center;">
  <span id="trial-text">Your trial ends soon.</span>
</div>	
	  <div id="topActions" style="position:relative"></div>
  </div>
	
  <div class="app">
    <aside class="sidebar">
       <div class="section-label"></div>
      <nav>
        <a href="index.html">Dashboard</a>
        <a href="alerts.html">Alerts</a>
        <a href="events.html">Events</a>
		<a href="live-feed.html">Live Feed</a>
	<a href="brief.html">Intelligence Brief</a>
	<a href="incident.html">Incident Drilldown</a>
	    <a href="reports.html">Reports</a>
	<a href="trends.html">Trends & Forecasts</a>
		<a href="sources.html">Sources</a>
        <a href="settings.html">Settings</a>
        <a href="about.html">About</a>
      </nav>
      <div class="footnote">For information use only — not for redistribution</div>
    </aside>


  <!-- MAIN -->
  <main class="main">
    <div class="page-head">
      <div class="page-head-left">
        <h2>Live Feed</h2>
        <div class="sub">Streaming incident chatter for your selected regions.</div>
      </div>

      <div class="page-head-right">
        <!-- centered static red button -->
        <button id="btnAddFeed" class="btn-red" type="button">+ Add Feed</button>
      </div>
    </div>

    <div id="feedsGrid" class="feeds-grid">
      <!-- Cards injected here -->
    </div>
  </main>
</div>

<!-- DETAIL PANEL -->
<aside id="detailPanel" class="detail-panel">
  <div class="detail-head">
    <div class="detail-head-left">
      <div id="detailTitle" class="detail-title">[Incident Title]</div>
      <div class="detail-meta" id="detailMeta">
        [City / Risk / Time]
      </div>
    </div>
    <button class="detail-close" id="detailClose">Close ✕</button>
  </div>

  <div class="detail-body">
    <div class="detail-section">
      <h4>Summary</h4>
      <div id="detailSummary" class="small">
        -
      </div>
    </div>

    <div class="detail-section">
      <h4>Location / Impact</h4>
      <div id="detailLocation" class="small">
        Approx. location details here.
      </div>
      <div id="detailImpact" class="small" style="margin-top:8px;">
        Impact to nearby assets here.
      </div>

<canvas id="detailMiniMap" width="320" height="180" style="margin-top:10px;border-radius:10px;border:1px solid var(--g600);background:#0f1013;"></canvas>
<div id="detailCoords" class="small" style="margin-top:6px;opacity:.8;"></div>
		
    </div>

    <div class="detail-section">
      <h4>Earlier Today in This Area</h4>
      <div id="detailEarlier" class="small">
        No earlier incidents recorded.
      </div>
    </div>
  </div>

  <div class="detail-footer">
    <a id="viewFullBtn" class="btn-full-incident" href="#">View Full Incident →</a>
    <a class="btn-back-dash" href="index.html">← Back to Dashboard</a>
  </div>
</aside>

<!-- ADD FEED MODAL -->
<div id="modalOverlay" class="modal-overlay">
  <div class="modal-box">
    <h3>Add Feed</h3>
    <div class="modal-row">
      <label for="feedCityInput">City / Region (e.g. London)</label>
      <input id="feedCityInput" type="text" placeholder="London" />
    </div>
    <div class="modal-row">
      <label for="feedRiskSelect">Risk Levels to Include</label>
      <select id="feedRiskSelect" multiple size="3">
        <option value="high">High</option>
        <option value="med">Medium</option>
        <option value="low">Low</option>
      </select>
      <div style="font-size:11px;color:var(--muted);line-height:1.4;">
        Hold Ctrl (or Cmd on Mac) to select multiple.
      </div>
    </div>

  <!-- NEW CHECKBOX ROW -->
  <div class="modal-row-inline">
    <input type="checkbox" id="feedLiveCheck" />
    <div>
      <div class="live-row-text">Live news mode</div>
      <div class="live-row-hint">Pull from external breaking sources (slower, rate-limited in test)</div>
    </div>
  </div>

	  
    <div class="modal-actions">
      <button class="btn-cancel" id="modalCancel">Cancel</button>
      <button class="btn-save" id="modalSave">Save Feed</button>
    </div>
  </div>
</div>

<script>
// -------------------- top bar user chip / dropdown --------------------
(function mountTopActions(){
  const host = document.getElementById('topActions');
  if (!host) return;

  const p = JSON.parse(localStorage.getItem('ci_profile') || '{}');
  const initials = (function(name){
    if(!name) return 'CI';
    const parts = name.trim().split(/\s+/);
    return parts.slice(0,2).map(s=>s[0]?.toUpperCase()||'').join('') || 'CI';
  })(p.name);

  const role = p.role || 'Analyst';
  const isSub = (localStorage.getItem('ci_subscribed') === 'true');

  host.innerHTML = `
    <div class="user" id="userChip">
      <div class="avatar">${initials}</div>
      ${role}
    </div>
    <div class="dropdown" id="userMenu">
      <a href="settings.html">Settings</a>
      <a href="analytics.html">Analytics</a>
      <a href="system-flow.html">System Flow</a>
      <a href="operations-log.html">Operations Log</a>
      <a href="#" id="logoutLink"><span class="logout-link">Log out</span></a>
    </div>
  `;

  const chip  = document.getElementById('userChip');
  const menu  = document.getElementById('userMenu');
  const logoutLink = document.getElementById('logoutLink');

  chip.addEventListener('click', ()=>{
    menu.style.display = (menu.style.display==='block')?'none':'block';
  });
  document.addEventListener('click',(e)=>{
    if(!host.contains(e.target)) menu.style.display='none';
  });

  logoutLink.addEventListener('click',(e)=>{
    e.preventDefault();
    if(window.CIAuth && CIAuth.logout) CIAuth.logout();
    location.href='index.html';
  });

  // trial banner logic
  const trialBanner = document.getElementById('trial-banner');
  const trialText   = document.getElementById('trial-text');
  const trialEnds   = localStorage.getItem('ci_trialEndsAt');
  const subscribed  = (localStorage.getItem('ci_subscribed') === 'true');

  if (!subscribed && trialEnds) {
    // show "Your trial ends <time>"
    try {
      const d = new Date(trialEnds);
      const leftMin = Math.max(0, Math.round((d - Date.now()) / 60000));
      trialBanner.style.display='block';
      if (leftMin <= 0) {
        trialText.textContent = 'Your trial has ended.';
      } else if (leftMin < 60) {
        trialText.textContent = `Your trial ends in ${leftMin} min`;
      } else {
        const leftHr = Math.round(leftMin/60);
        trialText.textContent = `Your trial ends in ${leftHr} hour${leftHr!==1?'s':''}`;
      }
    } catch(e){
      trialBanner.style.display='block';
      trialText.textContent = 'Trial active.';
    }
  }
})();

// -------------------- FEED STORAGE / STATE --------------------
const STORAGE_KEY = 'ci_live_feeds_v1';

// read feeds from localStorage
function loadFeeds(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr)?arr:[];
  }catch(e){
    return [];
  }
}

// save feeds to localStorage
function saveFeeds(feeds){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(feeds));
}

// add a feed definition {id, places[], risks[]}
function addFeedDef(def){
  const feeds = loadFeeds();
    feeds.push({ ...def, useLive: !!def.useLive });
  saveFeeds(feeds);
}

// -------------------- RENDER / FETCH MOCK DATA --------------------
async function fetchMockEventsForFeed(feed){
  // feed.places is array of cities, feed.risks is array of risk levels
  // We'll ask Worker for mock data (still fake but consistent format)
  const params = new URLSearchParams();
  if(feed.places && feed.places.length){
    params.set('cities', feed.places.join(','));
  }
  if(feed.risks && feed.risks.length){
    params.set('risk', feed.risks.join(','));
  }

  // choose live (GDELT) vs mock
  const provider = 'gdelt'; // keep gdelt as default for live
  const base = 'https://api.cityintelapi.com';

  // NOTE: always use absolute URL to your Worker
  const url = feed.useLive
    ? `${base}/api/live-news?${params.toString()}&provider=${provider}`
    : `${base}/api/live?${params.toString()}`;
	

  try {
    const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
    if (!res.ok) {
      // helpful console output while testing
      const txt = await res.text().catch(() => '');
      console.error('Live fetch failed', res.status, txt);
      return [];
    }
    const data = await res.json().catch(() => ({}));
    return Array.isArray(data.events) ? data.events : [];
  } catch (e) {
    console.warn('Fetch error', e);
    return [];
  }
}


function riskClass(r){
  if(r==='high') return 'high';
  if(r==='med')  return 'med';
  return 'low';
}

function fmtWhen(iso){
  try{
    return new Date(iso).toLocaleString('en-GB',{
      timeZone:'Europe/London',
      day:'2-digit',month:'short',
      hour:'2-digit',minute:'2-digit'
    });
  }catch(e){
    return iso||'';
  }
}

// -------------------- DETAIL PANEL HANDLING --------------------
const detailPanel   = document.getElementById('detailPanel');
const detailTitleEl = document.getElementById('detailTitle');
const detailMetaEl  = document.getElementById('detailMeta');
const detailSummaryEl = document.getElementById('detailSummary');
const detailLocationEl = document.getElementById('detailLocation');
const detailImpactEl   = document.getElementById('detailImpact');
const detailEarlierEl  = document.getElementById('detailEarlier');
const detailCloseBtn = document.getElementById('detailClose');
const viewFullBtn   = document.getElementById('viewFullBtn');



function lonLatToXY(lon, lat, w, h) {
  // Equirectangular projection (fast and fine for a mini-hint map)
  const x = (lon + 180) * (w / 360);
  const y = (90 - lat) * (h / 180);
  return [x, y];
}

function drawMiniMapPin(lat, lon) {
  const cvs = document.getElementById('detailMiniMap');
  const coordsEl = document.getElementById('detailCoords');
  if (!cvs || !coordsEl) return;

  const ctx = cvs.getContext('2d');
  const w = cvs.width, h = cvs.height;

  // background grid
  ctx.clearRect(0, 0, w, h);
  ctx.fillStyle = '#14161a';
  ctx.fillRect(0, 0, w, h);
  ctx.strokeStyle = 'rgba(255,255,255,0.07)';
  ctx.lineWidth = 1;
  for (let gx = 0; gx <= w; gx += 32) {
    ctx.beginPath(); ctx.moveTo(gx, 0); ctx.lineTo(gx, h); ctx.stroke();
  }
  for (let gy = 0; gy <= h; gy += 24) {
    ctx.beginPath(); ctx.moveTo(0, gy); ctx.lineTo(w, gy); ctx.stroke();
  }

  // a faint oval “coastline” to avoid a flat background
  ctx.strokeStyle = 'rgba(255,255,255,0.05)';
  ctx.beginPath();
  ctx.ellipse(w/2, h/2, w*0.46, h*0.36, 0, 0, Math.PI*2);
  ctx.stroke();

  if (typeof lat === 'number' && typeof lon === 'number') {
    const [x, y] = lonLatToXY(lon, lat, w, h);

    // glow
    ctx.beginPath();
    ctx.arc(x, y, 7, 0, Math.PI*2);
    ctx.fillStyle = 'rgba(255,77,77,0.25)';
    ctx.fill();

    // pin
    ctx.beginPath();
    ctx.arc(x, y, 3, 0, Math.PI*2);
    ctx.fillStyle = '#ff4d4d';
    ctx.shadowColor = '#ff4d4d';
    ctx.shadowBlur = 8;
    ctx.fill();
    ctx.shadowBlur = 0;

    coordsEl.textContent = `Coordinates: ${lat.toFixed(3)}, ${lon.toFixed(3)}`;
  } else {
    coordsEl.textContent = 'No coordinates provided for this alert.';
  }
}

	
function openDetailPanel(item, relatedList){
  // Text fields
  detailTitleEl.textContent = item.title || '[Incident Title]';
  detailMetaEl.textContent = `${item.city||'Unknown'} • ${item.risk||'n/a'} • ${fmtWhen(item.when)}`;

  detailSummaryEl.textContent = item.description ||
                                `Ongoing situation reported in ${item.city||'the area'}.`;

  detailLocationEl.textContent =
    `Approx area: ${item.city||'unknown'} (exact location may be refining).`;
  detailImpactEl.textContent =
    `Nearest office: CityIntel HQ, ~2km. Impact: Elevated security posture recommended.`;

  // Mini-map pin (lat/lon come from the event if present)
  if (typeof item.lat === 'number' && typeof item.lon === 'number') {
    drawMiniMapPin(item.lat, item.lon);
  } else {
    drawMiniMapPin(null, null);
  }

  // Earlier today in same city
  const sameCityEarlier = (relatedList||[])
    .filter(x => x.city===item.city && x.when !== item.when)
    .slice(0,3)
    .map(x => `• ${fmtWhen(x.when)} — ${x.title}`)
    .join('\n');
  detailEarlierEl.textContent = sameCityEarlier || 'No earlier incidents recorded.';

  // Deep link
  viewFullBtn.href = 'incident.html';

  // Open
  detailPanel.classList.add('open');
}

	
function closeDetailPanel(){  
	
	const cvs = document.getElementById('detailMiniMap');
	
  if (cvs) cvs.getContext('2d').clearRect(0,0,cvs.width,cvs.height);
  detailPanel.classList.remove('open');

{
  detailPanel.classList.remove('open');
}
detailCloseBtn.addEventListener('click', closeDetailPanel);

// close if click outside panel (optional)
// window.addEventListener('click', (e)=>{
//   if(detailPanel.classList.contains('open')){
//     // if click is not inside panel
//     if(!detailPanel.contains(e.target)){
//       closeDetailPanel();
//     }
//   }
// });
}


// Re-render a single card (fetch -> DOM -> schedule next refresh)
async function refreshSingleFeedCard(cardEl, feed){
  try {
    const events = await fetchMockEventsForFeed(feed);
    renderEventsIntoCard(cardEl, events, feed);
  } finally {
    scheduleNextRefresh(cardEl, feed);
  }
}

// Put the events into an existing card (no refetch here)
function renderEventsIntoCard(cardEl, events, feed){
  const bodyEl = cardEl.querySelector('.feed-body');

  // header: live badge
  const headRight = cardEl.querySelector('.feed-head-right');

  const editBtnExisting = headRight.querySelector('.btn-edit-feed');
  const delBtnExisting  = headRight.querySelector('.btn-del-feed');
	
  const liveMarkup = feed.useLive
    ? `<div class="live-pill"><span class="live-dot"></span><span>LIVE</span></div>`
    : ``;

  headRight.innerHTML = `
    ${liveMarkup}
    <div style="display:flex;gap:6px;">
      ${editBtnExisting ? editBtnExisting.outerHTML
                        : `<button class="btn-ghost btn-edit-feed" data-feedid="${feed.id}">Edit</button>`}
      ${delBtnExisting  ? delBtnExisting.outerHTML
                        : `<button class="btn-ghost btn-del-feed" data-feedid="${feed.id}" style="color:#ff5a5f;border-color:#ff5a5f;">✕</button>`}
    </div>
  `;

  // Re-bind events because innerHTML resets listeners
  const editBtn = headRight.querySelector('.btn-edit-feed');
  if (editBtn){
    editBtn.addEventListener('click', ()=> openFeedModal(feed));
  }
  const delBtn = headRight.querySelector('.btn-del-feed');
  if (delBtn){
    delBtn.addEventListener('click', ()=>{
      if (!confirm('Remove this feed?')) return;
      const updated = loadFeeds().filter(f => f.id !== feed.id);
      saveFeeds(updated);
      renderFeeds();
    });
  }



	
  // body
if (!events.length) {
  const placesLabel = (feed.places || []).join(', ');
  if (feed.useLive) {
    // Live feeds get a more dynamic hint
    bodyEl.innerHTML = `
      <div style="color:var(--muted);font-size:12px;">
        No recent items in ${placesLabel}. 
        <span style="opacity:.8">Listening for live updates…</span>
      </div>`;
  } else {
    // Mock/simulated feeds keep a simpler line
    bodyEl.innerHTML = `
      <div style="color:var(--muted);font-size:12px;">
        No recent items in ${placesLabel}.
      </div>`;
  }
}
  
  else {
   
	  bodyEl.innerHTML = '';
    const topCity = (feed.places && feed.places[0]) || 'Unknown';
    events.slice(0,8).forEach(ev=>{
      const itemEl = document.createElement('div');
      itemEl.className = 'feed-item';
      itemEl.style.borderLeftColor =
        ev.risk==='high' ? '#ff5a5f' :
        ev.risk==='med'  ? '#f0b429' :
                           '#33c48d';
      itemEl.innerHTML = `
        <div class="feed-title-row">
          <div>${ev.city || topCity} — ${ev.title}</div>
          <div class="feed-risk ${riskClass(ev.risk)}">${ev.risk}</div>
        </div>
        <div class="feed-meta">
          <span>${fmtWhen(ev.when)}</span>
          <span>${(ev.risk||'').toUpperCase()} priority</span>
        </div>
      `;
      // open slide panel
      itemEl.addEventListener('click', ()=> openDetailPanel(ev, events));
      bodyEl.appendChild(itemEl);
    });
  }

// footer: correct source + timestamp
const srcEl = cardEl.querySelector('.feed-footer .src');
if (srcEl) srcEl.textContent = feed.useLive ? 'source: live stream' : 'source: simulated source';

const lu = cardEl.querySelector('.feed-footer .last-updated');
if (lu) {
  const ts = new Date().toLocaleString('en-GB', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
  lu.textContent = `last updated ${ts}`;
}


// Timer per card (60s live, 120s mock) + small jitter so cards don't all refresh together
function scheduleNextRefresh(cardEl, feed){
  const base   = feed.useLive ? 60_000 : 120_000;            // 60s live, 120s mock
  const jitter = Math.floor(Math.random() * 10_000) - 5_000; // -5s .. +5s
  const ms     = Math.max(15_000, base + jitter);            // never less than 15s

  clearTimeout(cardEl.__nextTimer);
  cardEl.__nextTimer = setTimeout(()=>{
    // reload latest feed definition in case user edited it
    const fresh = loadFeeds().find(f => f.id === feed.id);
    if (fresh) refreshSingleFeedCard(cardEl, fresh);
  }, ms);
}





// -------------------- FEED MODAL LOGIC --------------------
const overlayEl = document.getElementById('modalOverlay');
const cityInput = document.getElementById('feedCityInput');
const riskSel   = document.getElementById('feedRiskSelect');
const liveCheck = document.getElementById('feedLiveCheck');	
const cancelBtn = document.getElementById('modalCancel');
const saveBtn   = document.getElementById('modalSave');
const addFeedBtn= document.getElementById('btnAddFeed');

let editingFeedId = null;

function openFeedModal(feed){
  editingFeedId = feed ? feed.id : null;
  overlayEl.style.display='flex';

  if(feed){
    cityInput.value = (feed.places||[]).join(', ');
    // reset all first
    for (let i=0;i<riskSel.options.length;i++){
      riskSel.options[i].selected = false;
    }
    (feed.risks||[]).forEach(r=>{
      for (let i=0;i<riskSel.options.length;i++){
        if(riskSel.options[i].value===r){
          riskSel.options[i].selected = true;
        }
      }
    });

liveCheck.checked = !!feed.useLive;
	  
  } else {
    cityInput.value = '';
    for (let i=0;i<riskSel.options.length;i++){
      riskSel.options[i].selected = false;
    }
    // default select high+med
    for (let i=0;i<riskSel.options.length;i++){
      if(['high','med'].includes(riskSel.options[i].value)){
        riskSel.options[i].selected = true;
      }
    }
	   liveCheck.checked = false;
  }
}

function closeFeedModal(){
  overlayEl.style.display='none';
  editingFeedId = null;
}

cancelBtn.addEventListener('click', closeFeedModal);
overlayEl.addEventListener('click',(e)=>{
  if(e.target===overlayEl){
    closeFeedModal();
  }
});
addFeedBtn.addEventListener('click', ()=>openFeedModal(null));

saveBtn.addEventListener('click', ()=>{
  const rawCities = cityInput.value.trim();
  if(!rawCities){
    alert('Please enter at least one city/region.');
    return;
  }
  const places = rawCities.split(',').map(s=>s.trim()).filter(Boolean);

  const risks = [];
  for (let i=0;i<riskSel.options.length;i++){
    if(riskSel.options[i].selected){
      risks.push(riskSel.options[i].value);
    }
  }
  if(!risks.length){
    alert('Please pick at least one risk level.');
    return;
  }

  const feeds = loadFeeds();
  const liveMode = !!liveCheck.checked;
	
  if(editingFeedId){
    // update existing
    const idx = feeds.findIndex(f=>f.id===editingFeedId);
    if(idx>=0){
      feeds[idx].places = places;
      feeds[idx].risks  = risks;
	  feeds[idx].useLive = liveMode;
    }
    saveFeeds(feeds);
  } else {
    // create new
    const id = 'feed-' + Date.now().toString(36);
    feeds.push({ id, places, risks, useLive: liveMode });
  }
  saveFeeds(feeds);
  closeFeedModal();
  renderFeeds();
});
	

	
// -------------------- CARD RENDER --------------------
async function renderFeeds(){
  const grid = document.getElementById('feedsGrid');

  // use let (we mutate this below)
  let feeds = loadFeeds();
  if (!Array.isArray(feeds)) feeds = [];

  // Seed a default feed if none exist
  if (!feeds.length === 0){
    const first = {
      id: 'default-1',
      places: ['London'],
      risks: ['high','med','low'],
      useLive: false
    };
    saveFeeds([first]);
    feeds = [first];
  }

  grid.innerHTML = '';

  for (const feed of feeds){
    const citiesLabel = (feed.places||[]).join(', ');
    const risksLabel  = (feed.risks||[]).join(', ');

    const card = document.createElement('section');
    card.className = 'feed-card';
    card.dataset.id = feed.id;

    card.innerHTML = `
      <div class="feed-head">
        <div class="feed-head-left">
          <div class="feed-city">${citiesLabel}</div>
          <div style="margin-top:4px;font-size:12px;color:${feed.risks.includes('high')?'#ff5a5f':feed.risks.includes('med')?'#f0b429':'#33c48d'};">
            Watching: ${risksLabel}
          </div>
        </div>
        <div class="feed-head-right">
          ${feed.useLive ? `<div class="live-pill"><span class="live-dot"></span><span>LIVE</span></div>` : ``}
          <div style="display:flex;gap:6px;">
            <button class="btn-ghost btn-edit-feed" data-feedid="${feed.id}">Edit</button>
            <button class="btn-ghost btn-del-feed" data-feedid="${feed.id}" style="color:#ff5a5f;border-color:#ff5a5f;">✕</button>
          </div>
        </div>
      </div>

      <div class="feed-body"></div>

<div class="feed-footer">
  <div class="src">${feed.useLive ? 'source: live stream' : 'source: simulated source'}</div>
  <div class="refresh" data-feedid="${feed.id}">↻ refresh</div>
  <div class="last-updated" data-feedid="${feed.id}" style="margin-left:auto;">—</div>
</div>
    `;

    // refresh link
    card.querySelector('.refresh').addEventListener('click', ()=>{
      const fresh = loadFeeds().find(f=>f.id===feed.id) || feed;
      refreshSingleFeedCard(card, fresh);
    });

    // edit feed (fixed the missing dot before addEventListener)
    card.querySelector('.btn-edit-feed').addEventListener('click', ()=>{
      openFeedModal(feed);
    });

    // delete feed
    card.querySelector('.btn-del-feed').addEventListener('click', ()=>{
      if (!confirm('Remove this feed?')) return;
      const updated = loadFeeds().filter(f => f.id !== feed.id);
      saveFeeds(updated);
      renderFeeds();
    });

    grid.appendChild(card);

    // initial fetch & schedule next refresh
    refreshSingleFeedCard(card, feed);
  }
}


// -------------------- INIT --------------------
renderFeeds();

// ---- link View Full Incident to incident.html ----
viewFullBtn.addEventListener('click', (e)=>{
  e.preventDefault();
  // Build a minimal object to pass along
  const incidentData = {
    title: detailTitleEl.textContent,
    meta: detailMetaEl.textContent,
    summary: detailSummaryEl.textContent,
    location: detailLocationEl.textContent,
    impact: detailImpactEl.textContent,
    earlier: detailEarlierEl.textContent,
  };

  // Generate a temp ID (could use timestamp)
  const incId = 'inc-' + Date.now().toString(36);

  // Persist in sessionStorage
  const all = JSON.parse(sessionStorage.getItem('ci_incidents') || '{}');
  all[incId] = incidentData;
  sessionStorage.setItem('ci_incidents', JSON.stringify(all));

  // Redirect with ?id=
  location.href = 'incident.html?id=' + encodeURIComponent(incId);
});

	
</script>

<!-- auth helpers / admin links -->

<script src="admin-links.js"></script>

</body>
</html>
