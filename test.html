
<!doctype html>
<html lang="en">
<head>

  <script src="auth.js"></script>
  <script src="assets-data.js"></script>
  <script src="travellers-data.js"></script>
  <script src="alerts-data.js"></script>

<script>
(function pageGuard(){
  const NEED_LOGIN = true;          // this page requires a login
  const NEED_SUB = false;           // set to true on pages that require an active sub

  // Must be logged in?
  if (NEED_LOGIN && (!window.CIAuth || !CIAuth.isLoggedIn())) {
    const here = location.pathname.split('/').pop() || 'index.html';
    const next = encodeURIComponent(here + location.search + location.hash);
    location.href = 'login.html?next=' + next;
    return;
  }

  // Must be subscribed?
  if (NEED_SUB) {
    const isSub = localStorage.getItem('ci_subscribed') === 'true';
    if (!isSub) {
      location.href = 'subscribe.html';
      return;
    }
  }
})();
</script>

<script>
(function compatProfileShim(){
  if (!window.CIAuth || !CIAuth.isLoggedIn()) return;
  const u = CIAuth.who();
  if (!u) return;
  localStorage.setItem('ci_profile', JSON.stringify({
    name: u.name || 'CityIntel User',
    email: u.email,
    role: u.role || 'Admin',
    is_admin: (u.role||'').toLowerCase()==='admin'
  }));
  // Do NOT auto-set ci_subscribed here anymore
})();
</script>

	

	<script>
(function syncPresenceFromStorage(){
  function loadList(key, fallback){
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return fallback;
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : fallback;
    } catch (e) {
      console.warn('CityIntel: failed to load', key, 'from localStorage', e);
      return fallback;
    }
  }

  const seedAssets     = Array.isArray(window.CIAssets)     ? window.CIAssets     : [];
  const seedTravellers = Array.isArray(window.CITravellers) ? window.CITravellers : [];

  window.CIAssets     = loadList('ci_assets', seedAssets);
  window.CITravellers = loadList('ci_travellers', seedTravellers);
})();
</script>


	
<script>
/**
 * CIExposure ‚Äì helper to find assets & travellers
 * that match an event by city/country.
 */
(function(){
  const norm = s => (s || '').toString().trim().toLowerCase();

  function exposureFor(city, country){
    const cCity = norm(city);
    const cCountry = norm(country);

    const assets = (Array.isArray(window.CIAssets) ? window.CIAssets : []).filter(a =>
      (!cCity    || norm(a.city)    === cCity) &&
      (!cCountry || norm(a.country) === cCountry)
    );

    const travellers = (Array.isArray(window.CITravellers) ? window.CITravellers : []).filter(t =>
      (!cCity    || norm(t.city)    === cCity) &&
      (!cCountry || norm(t.country) === cCountry)
    );

    return { assets, travellers };
  }

  window.CIExposure = { exposureFor };
})();
</script>

	
	<link rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin="anonymous">

  
  <meta charset="utf-8" />
  <title>CityIntel ‚Äî Live Feed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <style>
      :root{--brand-red:#D01616;--gray-900:#111214;--gray-800:#16171a;--gray-700:#1c1e22;--gray-600:#24272c;--gray-500:#2e3238;--text:#e9edf2}
      body{margin:0;font:14px/1.5 system-ui;background:linear-gradient(180deg,var(--gray-900),var(--gray-800));color:var(--text)}

     .app{display:grid;grid-template-columns:260px 1fr;grid-template-rows:60px 1fr;grid-template-areas:"sidebar topbar" "sidebar main";min-height:100vh}
    .sidebar{grid-area:sidebar;background:#0c0c0c;border-right:1px solid var(--gray-600);display:flex;flex-direction:column;padding:18px 14px;gap:18px}
      nav a{display:flex;align-items:center;padding:10px 12px;border-radius:10px;text-decoration:none;color:var(--text);border:1px solid transparent}
      nav a:hover{background:var(--gray-600);border-color:var(--gray-500)}
      nav a.active{background:rgba(208,22,22,0.15);border-color:var(--brand-red)}

    .topbar{ grid-area: topbar;background: rgba(255,255,255,0.02);border-bottom:1px solid var(--brand-gray-600);display:flex; align-items:center; gap:12px;
     padding:10px 16px;position:sticky; top:0; z-index:10;backdrop-filter: blur(8px);}

#topActions{margin-left:auto;display:flex; align-items:center; gap:10px;min-width: fit-content;position: relative;}
    
    .user{ display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;
  background:#1c1e22;border:1px solid #24272c;cursor:pointer;
}
    .avatar{ width:28px;height:28px;background:#fff;color:#000;border-radius:50%;
  display:grid;place-items:center;font-weight:700;
}
    .dropdown{ position:absolute;right:0;top:calc(100% + 6px);background:#1a1c20;border:1px solid #24272c;
  border-radius:10px;padding:6px 0;box-shadow:0 4px 12px rgba(0,0,0,.4);display:none;min-width:140px;z-index:50;
}
    .dropdown a{display:block;padding:8px 12px;color:#e9edf2;text-decoration:none;font-size:14px}
    .dropdown a:hover{background:rgba(255,255,255,0.05)}

  .brandbar{display:flex;align-items:center;gap:10px;padding:16px 20px;border-bottom:1px solid var(--line);
    background:linear-gradient(90deg,rgba(208,22,22,.2),rgba(208,22,22,0))}
  .brandbar img{width:auto;height:60px;object-fit:contain;border-radius:6px;background:#fff}



    #trial-banner{
      flex:1;
      text-align:center;
      font-size:12px;
      font-weight:600;
      color:#fecaca;
    }


    .logout-link{
      color:#8e97a3;
      font-size:12px;
    }

    .main{
      grid-area:main;
      padding:18px;
    }

    .page-head{
      display:flex;
      align-items:flex-start;
      flex-wrap:wrap;
      gap:12px;
      margin-bottom:16px;
    }
    .page-head-left h2{
      margin:0;
      font-size:16px;
      font-weight:600;
      color:var(--text);
    }
    .page-head-left .sub{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }
    .page-head-right{
      margin-left:auto;
      display:flex;
      flex-direction:column;
      align-items:center;
      min-width:160px;
      gap:8px;
    }


.page-title-bar{
  display:flex;
  align-items:flex-start;
  gap:10px;
  margin-bottom:12px;
}

.page-title-main{
  display:flex;
  flex-direction:column;
  gap:4px;
}

.page-title-bar h2{
  margin:0;
  font-size:18px;
  font-weight:600;
  color:var(--text);
}

.page-title-sub{
  font-size:12px;
  color:#8e97a3; /* muted */
}

.page-title-actions{
  margin-left:auto;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}

.btn-outline-pill{
  border-radius:999px;
  border:1px solid var(--gray-600);
  background:#1f2024;
  color:#e9edf2;
  font-size:12px;
  font-weight:500;
  padding:6px 12px;
  cursor:pointer;
  text-decoration:none;
  display:inline-flex;
  align-items:center;
  gap:6px;
  white-space:nowrap;
}

.btn-outline-pill:hover{
  background:#2a2d32;
  border-color:#D01616;
  color:#fff;
}


	  

    .btn-red{
      background:#D01616;
      color:#fff;
      font-size:13px;
      font-weight:600;
      border:1px solid #D01616;
      border-radius:10px;
      padding:8px 12px;
      cursor:pointer;
      line-height:1.2;
      text-align:center;
      min-width:140px;
    }
    .btn-red:hover{
      background:#ff2a2a;
      border-color:#ff2a2a;
    }

    .feeds-grid{
  display: grid;
  gap: 16px;
  /* default: responsive 1‚Äì2 columns */
  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
}

/* On wider screens, force 3 equal columns */
@media (min-width: 1280px){
  .feeds-grid{
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }
}


    .feed-card{
      background:linear-gradient(180deg,#1a1c20,#131417);
      border:1px solid var(--g600);
      border-radius:16px;
      display:flex;
      flex-direction:column;
      min-height:260px;
      max-height:400px;
    }

    .feed-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      border-bottom:1px solid var(--g600);
      padding:12px 16px;
    }
    .feed-head-left{
      font-size:13px;
      color:var(--text);
      line-height:1.4;
    }
    .feed-city{
      font-weight:600;
      font-size:14px;
      color:#fff;
    }

    .feed-head-meta{
      margin-top:4px;
      font-size:11px;
      color:#9ca3af;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
    }

    .feed-head-meta span.badge{
      padding:2px 6px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.45);
      background:rgba(15,23,42,.8);
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.03em;
    }

	  
    .feed-risk{
      display:inline-block;
      font-size:11px;
      line-height:1.2;
      font-weight:600;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.15);
    }
    .feed-risk.high{
      background:rgba(255,90,95,.12);
      border-color:rgba(255,90,95,.35);
      color:#ff5a5f;
    }
    .feed-risk.med{
      background:rgba(240,180,41,.12);
      border-color:rgba(240,180,41,.35);
      color:#f0b429;
    }
    .feed-risk.low{
      background:rgba(51,196,141,.12);
      border-color:rgba(51,196,141,.35);
      color:#33c48d;
    }
    .feed-head-right{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:4px;
    }

	.feed-kw{
     margin-top:4px;
     font-size:12px;
     color:var(--muted);
     white-space:nowrap;
     overflow:hidden;
     text-overflow:ellipsis;
     max-width: 100%;
    }

.kw-chip{
  display:inline-block;
  padding:2px 6px;
  border:1px solid var(--g600);
  border-radius:999px;
  font-size:11px;
  color:#cfd6df;
  background:#1f2024;
  margin-right:6px;
}
.kw-more{
  font-size:11px;
  opacity:.8;
}


/* ---------------------------------------------------------
   RECENCY AGE VISUALS
--------------------------------------------------------- */

.age-fresh {
  opacity: 1;
  border-color: #3f3f3f !important;
}

.age-recent {
  opacity: 0.85;
  border-color: #333 !important;
}

.age-older {
  opacity: 0.65;
  border-color: #262626 !important;
}

.age-stale {
  opacity: 0.45;
  border-color: #1e1e1e !important;
}
	  
 
	  
/* LIVE badge in feed header */
    .live-pill {
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:rgba(208,22,22,0.15);
      border:1px solid #D01616;
      color:#ff4d4d;
      font-size:11px;
      font-weight:600;
      line-height:1.2;
      padding:3px 8px;
      border-radius:999px;
    }
    .live-dot {
      width:6px;
      height:6px;
      border-radius:50%;
      background:#ff4d4d;
      box-shadow:0 0 6px #ff4d4d,0 0 10px #ff4d4d;
    }

    /* checkbox row in modal */
    .modal-row-inline {
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
      margin-bottom:12px;
    }
    .modal-row-inline input[type="checkbox"] {
      margin-top:2px;
      accent-color:#D01616; /* modern browsers */
    }
    .modal-row-inline .live-row-text {
      color:#fff;
      font-size:13px;
      line-height:1.4;
    }
    .modal-row-inline .live-row-hint {
      font-size:11px;
      color:var(--muted);
      line-height:1.4;
    }

	  
	  
    .btn-ghost{
      background:#1f2024;
      color:#e9edf2;
      border:1px solid var(--g600);
      border-radius:8px;
      padding:4px 8px;
      font-size:12px;
      line-height:1.2;
      cursor:pointer;
    }
    .btn-ghost:hover{
      background:#2a2d32;
    }

    .feed-body{
      flex:1;
      overflow-y:auto;
      padding:12px 16px 16px;
      font-size:13px;
    }
    .feed-item{
      border-left:4px solid #D01616;
      background:linear-gradient(90deg,rgba(208,22,22,.1),rgba(208,22,22,0));
      border-radius:8px;
      border:1px solid var(--g600);
      padding:10px 12px;
      margin-bottom:10px;
      cursor:pointer;
    }
    .feed-item:last-child{
      margin-bottom:0;
    }
    .feed-title-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:8px;
      font-size:13px;
      font-weight:600;
      color:#fff;
    }
    .feed-meta{
      font-size:11px;
      color:var(--muted);
      line-height:1.4;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }

    .feed-footer{
      border-top:1px solid var(--g600);
      padding:10px 16px;
      font-size:11px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .feed-footer .src{
      color:var(--muted);
    }
    .feed-footer .refresh{
      cursor:pointer;
      color:#8e97a3;
    }
    .feed-footer .refresh:hover{
      color:#fff;
    }

    /* slide-in detail panel */
    .detail-panel{
      position:fixed;
      top:0;
      right:0;
      height:100vh;
      width:360px;
      max-width:80%;
      background:#1a1c20;
      border-left:1px solid var(--g600);
      box-shadow:-20px 0 40px rgba(0,0,0,.8);
      color:#e9edf2;
      font-size:13px;
      line-height:1.5;
      display:flex;
      flex-direction:column;
      transform:translateX(100%);
      transition:transform .25s ease;
      z-index:10000;
    }
    .detail-panel.open{
      transform:translateX(0%);
    }

    .detail-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      padding:16px;
      border-bottom:1px solid var(--g600);
      background:#131417;
    }
    .detail-head-left{
      max-width:260px;
    }
    .detail-title{
      font-size:14px;
      font-weight:600;
      color:#fff;
      margin-bottom:4px;
    }
    .detail-meta{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }
    .detail-close{
      background:none;
      border:0;
      color:#8e97a3;
      font-size:12px;
      cursor:pointer;
      padding:4px 6px;
      border-radius:6px;
    }
    .detail-close:hover{
      color:#fff;
      background:#2a2d32;
    }

    .detail-body{
      flex:1;
      overflow-y:auto;
      padding:16px;
    }
    .detail-section{
      margin-bottom:16px;
      background:linear-gradient(180deg,#1a1c20,#131417);
      border:1px solid var(--g600);
      border-radius:12px;
      padding:12px;
    }
    .detail-section h4{
      margin:0 0 6px;
      font-size:12px;
      font-weight:600;
      color:#fff;
      text-transform:uppercase;
      letter-spacing:.03em;
    }
    .detail-section .small{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }

    .detail-footer{
      border-top:1px solid var(--g600);
      background:#131417;
      padding:12px 16px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .earlier-list {
  margin: 0;
  padding-left: 18px;
  list-style: disc;
  line-height: 1.4;
  gap: 4px;
}
    .earlier-list li {
  margin-bottom: 4px;
}


.event-group {
  background: #1a1a1a;
  padding: 14px;
  border-radius: 10px;
  margin-bottom: 10px;
  border: 1px solid #2a2a2a;
}

.eg-header {
  display: flex;
  justify-content: space-between;
  cursor: pointer;
  align-items: center;
}

.eg-title {
  font-size: 15px;
  font-weight: 600;
  display: flex;
  gap: 8px;
  align-items: center;
}

.eg-icon {
  display: inline-flex;
  width: 22px;
  height: 22px;
  border-radius: 6px;
  background: #333;
  justify-content: center;
  align-items: center;
  font-size: 12px;
  font-weight: 700;
}

.eg-meta {
  display: flex;
  gap: 10px;
  font-size: 13px;
  opacity: 0.9;
}

.eg-sub {
  margin-top: 3px;
  font-size: 12px;
  opacity: 0.85;
  display: flex;
  gap: 12px;
}

.eg-when {
  opacity: 0.85;
}

	  
.eg-body {
  margin-top: 12px;
  padding-left: 8px;
  border-left: 2px solid #333;
  max-height: 140px;      /* adjust if you want more/less */
  overflow-y: auto;
}

.eg-item {
  margin-bottom: 9px;
}

.eg-item-when {
  font-size: 12px;
  opacity: 0.7;
}

.eg-item-text {
  font-size: 13px;
  line-height: 1.3;
  display: -webkit-box;
  -webkit-line-clamp: 3;     /* show up to 3 lines */
  -webkit-box-orient: vertical;
  overflow: hidden;
}
	.eg-footer {
  margin-top: 8px;
  text-align: right;
}
.eg-footer .eg-view-btn {
  font-size: 11px;
  padding: 4px 8px;
}  


/* --- Global "Now" strip above feeds --- */
.live-now-strip{
  margin: 10px 0 14px;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid var(--g600);
  background: linear-gradient(90deg, rgba(208,22,22,.14), rgba(12,10,20,.9));
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 8px;
  font-size: 12px;
}

.live-now-label{
  font-weight: 600;
  color: #fecaca;
  text-transform: uppercase;
  letter-spacing: .06em;
  font-size: 11px;
}

.live-now-stats{
  color: #e5e7eb;
  opacity: .9;
}

.live-now-stats span{
  margin-right: 6px;
}

.live-now-stats .dot-high{ color:#f97373; }
.live-now-stats .dot-med { color:#fbbf24; }
.live-now-stats .dot-low { color:#4ade80; }

.live-now-pills{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin-left:auto;
}

.live-now-pill{
  border-radius:999px;
  border:1px solid rgba(248,113,113,.7);
  background:rgba(127,29,29,.9);
  color:#fee2e2;
  font-size:11px;
  padding:4px 8px;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:4px;
  white-space:nowrap;
}

.live-now-pill span:first-child{
  font-size:13px;
}

.live-now-pill:hover{
  filter:brightness(1.1);
}

.live-now-empty{
  font-size:12px;
  color:#9ca3af;
}



	  
	  
    .btn-full-incident{
      background:#D01616;
      color:#fff;
      border:1px solid #D01616;
      border-radius:10px;
      padding:10px 12px;
      font-size:13px;
      font-weight:600;
      line-height:1.2;
      text-align:center;
      text-decoration:none;
      cursor:pointer;
    }
    .btn-full-incident:hover{
      background:#ff2a2a;
      border-color:#ff2a2a;
    }

    .btn-back-dash{
      display:inline-block;
      text-decoration:none;
      color:#ff5a5f;
      font-size:12px;
      font-weight:600;
      text-align:center;
    }

    /* Add Feed modal */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:10001;
    }
    .modal-box{
      background:#1a1c20;
      border:1px solid var(--g600);
      border-radius:16px;
      width:420px;
      max-width:90%;
      box-shadow:0 30px 60px rgba(0,0,0,.9);
      padding:16px;
      color:var(--text);
      font-size:13px;
    }
    .modal-box h3{
      margin:0 0 12px;
      font-size:14px;
      font-weight:600;
      color:#fff;
    }
    .modal-row{
      margin-bottom:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .modal-row label{
      font-size:12px;
      color:var(--muted);
    }
    .modal-row input, .modal-row select{
      background:#1f2024;
      border:1px solid var(--g600);
      border-radius:8px;
      color:#fff;
      padding:10px 12px;
      font-size:14px;
      line-height:1.4;
      outline:none;
      width:90%;
    }
    .modal-row input:focus,
    .modal-row select:focus{
      border-color:#D01616;
    }
    .modal-actions{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .btn-cancel{
      background:#1f2024;
      border:1px solid var(--g600);
      border-radius:8px;
      color:#8e97a3;
      font-size:12px;
      line-height:1.2;
      padding:8px 10px;
      cursor:pointer;
      flex:1;
      text-align:center;
    }
    .btn-cancel:hover{
      background:#2a2d32;
      color:#fff;
    }
    .btn-save{
      background:#D01616;
      border:1px solid #D01616;
      border-radius:8px;
      color:#fff;
      font-size:12px;
      font-weight:600;
      line-height:1.2;
      padding:8px 10px;
      cursor:pointer;
      flex:1;
      text-align:center;
    }
    .btn-save:hover{
      background:#ff2a2a;
      border-color:#ff2a2a;
    }


	  /* Card that holds the live map */
.live-map-card{
  position: relative;
  padding: 16px 18px 20px;
}
	  



/* Map + sidebar layout */
.live-map-shell{
  display:flex;
  gap:14px;
  align-items:stretch;
}

.live-map-main{
  flex:1;
  height:480px;          /* tweak: taller map */
  border-radius:14px;
  overflow:hidden;
}

/* Right-hand column */
.live-map-sidebar{
  width:250px;
  background:#05070b;
  border-radius:14px;
  border:1px solid #2e3238;
  padding:10px 12px;
  font-size:11px;
  color:#e5e7eb;
  display:flex;
  flex-direction:column;
  gap:10px;
}

/* Legend block */
.live-map-legend-block{
  border-radius:10px;
  background:#06070c;
  padding:8px 10px;
  border:1px solid #2e3238;
}

.live-map-legend-row{
  display:flex;
  align-items:center;
  gap:6px;
  margin-bottom:4px;
}

.live-map-legend-row:last-child{
  margin-bottom:0;
}

.live-map-chip{
  width:12px;
  height:12px;
  border-radius:3px;
  border:1px solid #111827;
}

.live-map-chip-high{ background:#ff5a5f; }
.live-map-chip-med { background:#f0b429; }
.live-map-chip-low { background:#6bcf6b; }

.live-map-dot{
  width:9px;
  height:9px;
  border-radius:999px;
  display:inline-block;
}

.live-map-dot-asset{ background:#3b82f6; }
.live-map-dot-trav { background:#f97316; }

/* Feeds area */
.live-map-sidebar-section{
  border-radius:10px;
  background:#05070b;
  border:1px solid #111827;
  padding:8px 8px 10px;
}

.live-map-sidebar-title{
  font-size:10px;
  letter-spacing:.06em;
  text-transform:uppercase;
  opacity:.75;
  margin-bottom:6px;
}

.live-map-feeds-list{
  display:flex;
  flex-direction:column;
  gap:4px;
  max-height:160px;
  overflow-y:auto;
}

.live-map-feed-btn{
  width:100%;
  text-align:left;
  border-radius:999px;
  border:1px solid #374151;
  background:#111827;
  color:#e5e7eb;
  padding:4px 8px;
  font-size:11px;
  cursor:pointer;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.live-map-feed-btn:hover{
  background:#1f2937;
  border-color:#9ca3af;
}

.live-map-add-btn{
  margin-top:8px;
  width:100%;
  border-radius:999px;
  border:1px dashed #4b5563;
  background:#05070b;
  color:#e5e7eb;
  font-size:11px;
  padding:4px 6px;
  cursor:pointer;
}

.live-map-add-btn:hover{
  background:#111827;
}

/* highlight when sidebar scrolls you to a feed card */
.feed-card-pulse{
  box-shadow:0 0 0 2px rgba(248,113,113,.8);
  transition:box-shadow .3s ease;
}



.live-radius-block{
  margin-top:12px;
  padding-top:8px;
  border-top:1px solid #2e3238;
}

.live-radius-label{
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.08em;
  color:#9ca3af;
  margin-bottom:6px;
}

.live-radius-pills{
  display:flex;
  gap:6px;
}

.radius-pill{
  flex:1;
  border-radius:999px;
  border:1px solid #4b5563;
  background:#111827;
  color:#e5e7eb;
  font-size:11px;
  padding:4px 0;
  cursor:pointer;
  text-align:center;
}

.radius-pill.active{
  border-color:#f97373;
  background:#7f1d1d;
  color:#fee2e2;
}


	/* --- Map sidebar: selected feed alerts list --- */
.map-alerts-list{
  display:flex;
  flex-direction:column;
  gap:8px;
  max-height:240px;     /* adjust if you want */
  overflow-y:auto;
  padding-right:2px;
}

.map-alert-item{
  border-radius:12px;
  border:1px solid #374151;
  background:#0b1120;
  padding:8px 10px;
  cursor:pointer;
}

.map-alert-item:hover{
  background:#111827;
  border-color:#4b5563;
}

.map-alert-top{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:8px;
  margin-bottom:6px;
}

.map-alert-title{
  font-size:12px;
  font-weight:600;
  color:#e5e7eb;
  line-height:1.25;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
}

.map-alert-when{
  font-size:11px;
  opacity:.75;
  white-space:nowrap;
}

.map-alert-meta{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  align-items:center;
  font-size:11px;
  opacity:.9;
}

.map-risk-pill{
  font-size:10px;
  font-weight:700;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.15);
}

.map-risk-high{ background:rgba(255,90,95,.14); border-color:rgba(255,90,95,.35); color:#ff5a5f; }
.map-risk-med { background:rgba(240,180,41,.14); border-color:rgba(240,180,41,.35); color:#f0b429; }
.map-risk-low { background:rgba(51,196,141,.14); border-color:rgba(51,196,141,.35); color:#33c48d; }

.map-alert-empty{
  font-size:12px;
  opacity:.75;
  padding:8px 2px;
}
  
	  

/* brief highlight when we jump to a feed card */
.feed-card-pulse{
  box-shadow:
    0 0 0 1px #f97316,
    0 0 10px rgba(249,115,22,0.7);
  transition: box-shadow .3s ease;
}


	  /* --- Global Risk & Exposure layout --- */
.global-map-wrap{
  margin-top: 10px;
  padding: 12px 14px 16px;
  display: grid;
  grid-template-columns: minmax(260px, 320px) minmax(0, 1fr); /* sidebar | map */
  gap: 16px;
  align-items: stretch;
}

.global-map-main{
  background:#020617;
  border-radius:16px;
  overflow:hidden;
  border:1px solid var(--gray-700);
  grid-column: 2;	
}

/* This is critical ‚Äì gives the Leaflet container height */
#liveRiskMap{
  width:100%;
  height:480px;
}

#liveMapFeedsList { max-height: 260px; overflow:auto; }

	  
/* Right-hand side panel */
.global-map-side{
  background:#050708;
  border-radius:16px;
  border:1px solid var(--gray-700);
  padding:12px 14px;
  font-size:12px;
  height: 480px
  display:flex;
  flex-direction:column;
  gap:12px;
  grid-column: 1;	
}

/* Legend styling */
.global-map-legend-block{
  border-bottom:1px solid #2e3238;
  padding-bottom:8px;
}
.gm-legend-title{
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.08em;
  opacity:.8;
  margin-bottom:6px;
}
.gm-legend-row{
  display:flex;
  align-items:center;
  gap:6px;
  margin-bottom:3px;
}
.gm-chip{
  width:12px;
  height:12px;
  border-radius:3px;
  border:1px solid #111827;
}
.gm-high{ background:#ff5a5f; }
.gm-med{  background:#f0b429; }
.gm-low{  background:#6bcf6b; }

.gm-dot{
  width:10px;
  height:10px;
  border-radius:999px;
  display:inline-block;
}
.gm-asset{ background:#3b82f6; }
.gm-trav{  background:#f97316; }

/* Feed list inside side panel */
.global-map-feeds-block{
  margin-top:4px;
}
.gm-feeds-title{
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.08em;
  opacity:.75;
  margin-bottom:6px;
}
.gm-feed-pill{
  width:100%;
  text-align:left;
  border-radius:999px;
  border:1px solid #374151;
  background:#0b1120;
  color:#e5e7eb;
  font-size:12px;
  padding:5px 8px;
  margin-bottom:4px;
  cursor:pointer;
}
.gm-feed-pill:hover{
  background:#111827;
  border-color:#4b5563;
}
.gm-feed-add{
  width:100%;
  margin-top:4px;
  border-radius:999px;
  border:1px solid #4b5563;
  background:#111827;
  color:#e5e7eb;
  font-size:11px;
  padding:5px 8px;
  cursor:pointer;
}
.gm-feed-add:hover{
  background:#1f2937;
}

/* subtle highlight when a feed is jumped to */
.feed-card-highlight{
  box-shadow:0 0 0 2px rgba(248,113,113,.7);
  transition:box-shadow .25s ease;
}



	  
/* asset / traveller markers */
.ci-asset-marker,
.ci-trav-marker{
  background:#111827;
  border-radius:999px;
  border:2px solid #000;
  box-shadow:0 0 6px rgba(0,0,0,0.6);
  color:#fff;
  font-size:10px;
  font-weight:700;
  line-height:18px;
  text-align:center;
}
.ci-asset-marker{ background:#3b82f6; }    /* blue */
.ci-trav-marker{ background:#f97316; }    /* orange */


	  

    @media (max-width:900px){
      .app{
        grid-template-columns:1fr;
        grid-template-areas:
          "topbar"
          "main";
      }
      .sidebar{
        display:none;
      }
      .detail-panel{
        width:80%;
        max-width:400px;
      }
    }
  </style>
</head>


  
<script>

	// must be after the header DOM exists
document.addEventListener('DOMContentLoaded', () => {
  const topActions = document.getElementById('topActions');
  if (window.CIAuth && typeof CIAuth.injectUserChip === 'function' && topActions) {
    CIAuth.injectUserChip(topActions);
  }

  const nav = document.querySelector('aside.sidebar nav');
  if (window.CIAuth && typeof CIAuth.updateSidebarForRole === 'function' && nav) {
    CIAuth.updateSidebarForRole(nav);
  }
});
</script>


  
<body>
    
<div class="brandbar">
  <img src="CityintLogo.jpg" alt="CityIntel Logo">
  <div class="title" style="font-weight:700;font-size:18px">CityIntel</div>

  <div id="trial-banner" style="display:none;position:absolute;
       left:50%; transform:translateX(-50%); background:none;
       color:#fecaca; padding:8px 12px; text-align:center;">
    <span id="trial-text">Your trial ends soon.</span>
  </div>

  <!-- keep topActions INSIDE the brandbar -->
  <div id="topActions" style="position:relative;margin-left:auto"></div>
</div>
		

	
  <div class="app">
    <aside class="sidebar">
       <div class="section-label"></div>
      <nav>
        <a href="index.html">Dashboard</a>
        <a href="assets.html">Assets</a>
		<a href="travellers.html">Travellers</a>  
        <a href="alerts.html">Alerts</a>
        <a href="events.html">Events</a>
		<a href="live-feed.html">Live Feed</a>
	<a href="brief.html">Intelligence Brief</a>
	    <a href="reports.html">Reports</a>
	<a href="trends.html">Trends & Forecasts</a>
		<a href="sources.html">Sources</a>
        <a href="settings.html">Settings</a>
        <a href="about.html">About</a>
      </nav>
      <div class="footnote">For information use only ‚Äî not for redistribution</div>
    </aside>


  <!-- MAIN -->
  <main class="main">

    <!-- Top title bar for page -->
    <div class="page-title-bar">
      <div class="page-title-main">
        <h2>Global Risk & Live Exposure</h2>
        <div class="page-title-sub">
          Last 6 months risk shading, overlaid with your company assets and travellers.
        </div>
      </div>

      <div class="page-title-actions">
        <a href="assets.html" class="btn-outline-pill">
          üè¢ Manage assets
        </a>
        <a href="travellers.html" class="btn-outline-pill">
          ‚úàÔ∏è Manage travellers
        </a>
      </div>
	</div>



	  
<div id="liveNowStrip" class="live-now-strip">
      <div class="live-now-label">NOW</div>
      <div class="live-now-stats live-now-empty">No alerts in the current window.</div>
    </div>


	  
<section id="liveMapCard" style="
    margin: 4px 0 14px;
    padding: 12px 14px 10px;
    border-radius: 16px;
    background: linear-gradient(180deg,#1a1c20,#131417);
    border: 1px solid #24272c;
    position: relative;
  ">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
    <h3 style="margin:0;font-size:14px;font-weight:600;">Global Risk &amp; Exposure Map</h3>
    <div style="font-size:11px;color:#9ca3af;">
      Last 6 months risk ‚Ä¢ company assets &amp; travellers overlay
    </div>
  </div>
	

	
<!-- Global Risk & Exposure Map card body -->
<div class="global-map-wrap">


<!-- RIGHT-HAND SIDE PANEL -->
  <aside class="global-map-side">
    <div class="live-radius-block">
  <div class="live-radius-label">Incident radius</div>
  <div class="live-radius-pills">
    <button type="button" class="radius-pill active" data-radius-km="1">1 km</button>
    <button type="button" class="radius-pill" data-radius-km="5">5 km</button>
    <button type="button" class="radius-pill" data-radius-km="10">10 km</button>
  </div>
      <div class="gm-legend-row" style="margin-top:6px;">
        <span class="gm-dot gm-asset"></span> Assets
      </div>
      <div class="gm-legend-row">
        <span class="gm-dot gm-trav"></span> Travellers
      </div>
    </div>

     <!-- Feeds summary -->
    <div class="live-map-sidebar-section">
      <div class="live-map-sidebar-title">Feeds on this page</div>
      <div id="liveMapFeedsList" class="live-map-feeds-list">
        <!-- JS will fill this with buttons like ‚ÄúEU‚Äù, ‚ÄúLondon‚Äù, etc -->
      </div>
      <button type="button"
              class="live-map-add-btn"
              onclick="window.ciOpenAddFeed && window.ciOpenAddFeed()">
        + Add feed
      </button>
    </div>

 <!-- ‚úÖ PASTE PART 1 HERE (directly under feeds summary) -->
  <div class="live-map-sidebar-section" id="mapAlertsPanel" style="display:none;">
    <div class="live-map-sidebar-title" id="mapAlertsTitle">Latest incidents</div>

    <div id="mapAlertsList" class="map-alerts-list"></div>

    <button type="button" class="live-map-add-btn" id="mapAlertsBackBtn">
      ‚Üê Back to feeds
    </button>
  </div>
	  
  </aside>


	
	<!-- MAP AREA -->
  <div class="global-map-main">
    <div id="liveRiskMap"></div>
  </div>


</div>
   
</section>
	  
	  
    <div class="page-head">
      <div class="page-head-left">
        <h2>Live Feed</h2>
        <div class="sub">Streaming incident chatter for your selected regions.</div>
      </div>

      <div class="page-head-right">
  <!-- Add Feed button -->
  <button id="btnAddFeed" class="btn-red" type="button">+ Add Feed</button>

  <!-- Global time window selector -->
  <div style="margin-top:8px; font-size:11px; color:var(--muted); text-align:center;">
    Showing last
    <select id="windowSelect"
            style="background:#1f2024;border:1px solid var(--g600);color:#e9edf2;
                   border-radius:6px;padding:4px 6px;font-size:11px;margin:0 4px;">
      <option value="1">1h</option>
      <option value="3">3h</option>
      <option value="6">6h</option>
      <option value="12">12h</option>
      <option value="24">24h</option>
      <option value="48">48h</option>
      <option value="72">72h</option>
    </select>
    of alerts
  </div>
</div>


    <div id="feedsGrid" class="feeds-grid">
      <!-- Cards injected here -->
    </div>
  </main>
</div>

<!-- DETAIL PANEL -->
<aside id="detailPanel" class="detail-panel">
  <div class="detail-head">
    <div class="detail-head-left">
      <div id="detailTitle" class="detail-title">[Incident Title]</div>
      <div class="detail-meta" id="detailMeta">
        [City / Risk / Time]
      </div>
    </div>
    <button class="detail-close" id="detailClose">Close ‚úï</button>
  </div>

  <div class="detail-body">
    <div class="detail-section">
      <h4>Summary</h4>
      <div id="detailTag" class="small" style="margin-bottom:6px;font-weight:600;opacity:.9;"></div>
      <div id="detailSummary" class="small">
        -
      </div>
    </div>

    <div class="detail-section">
      <h4>Location / Impact</h4>
      <div id="detailLocation" class="small">
        Approx. location details here.
      </div>
      <div id="detailImpact" class="small" style="margin-top:8px;">
        Impact to nearby assets here.
      </div>

		
	<div id="detailExposureList" class="small" style="margin-top:8px;"></div>

		
<canvas id="detailMiniMap" width="320" height="180"
    style="margin-top:10px;border-radius:10px;border:1px solid var(--g600);background:#0f1013;"></canvas>
  <div id="detailCoords" class="small" style="margin-top:6px;opacity:.8;"></div>		
    </div>

    <div class="detail-section">
      <h4>Earlier Today in This Area</h4>
      <div id="detailEarlier" class="small">
        No earlier incidents recorded.
      </div>
    </div>
  </div>

  <div class="detail-footer">
    <a id="viewFullBtn" class="btn-full-incident" href="#">View Full Incident ‚Üí</a>
    <a class="btn-back-dash" href="index.html">‚Üê Back to Dashboard</a>
  </div>
</aside>

<!-- ADD FEED MODAL -->
<div id="modalOverlay" class="modal-overlay">
  <div class="modal-box">
    <h3>Add Feed</h3>
   
	  <div class="modal-row">
      <label for="feedCityInput">City / Region (e.g. London)</label>
      <input id="feedCityInput" type="text" placeholder="London" />

	  <div style="font-size:11px;color:var(--muted);line-height:1.4;">
  Tip: you can use shortcuts like <code>uk</code>, <code>us</code>, <code>eu</code>, 
  <code>apac</code>, <code>mea</code>, <code>latam</code>, or <code>global</code>.
</div></div>

<div class="modal-row">
  <label for="feedKeywordsInput">Keywords (optional)</label>
  <input id="feedKeywordsInput" type="text"
         placeholder='e.g. UK OR Britain, flooding, evacuation' />
  <div style="font-size:11px;color:var(--muted);line-height:1.4;">
    Tip: use comma-separated terms or OR logic. Examples:<br>
    <code>UK OR Britain</code>, <code>flooding</code>, <code>evacuation</code>
  </div>
</div>

	  
    <div class="modal-row">
      <label for="feedRiskSelect">Risk Levels to Include</label>
      <select id="feedRiskSelect" multiple size="3">
        <option value="high">High</option>
        <option value="med">Medium</option>
        <option value="low">Low</option>
      </select>
      <div style="font-size:11px;color:var(--muted);line-height:1.4;">
        Hold Ctrl (or Cmd on Mac) to select multiple.
      </div>
    </div>


	  
  <!-- NEW CHECKBOX ROW -->
  <div class="modal-row-inline">
    <input type="checkbox" id="feedLiveCheck" />
    <div>
      <div class="live-row-text">Live news mode</div>
      <div class="live-row-hint">Pull from external breaking sources (slower, rate-limited in test)</div>
    </div>
  </div>

	  
    <div class="modal-actions">
      <button class="btn-cancel" id="modalCancel">Cancel</button>
      <button class="btn-save" id="modalSave">Save Feed</button>
    </div>
  </div>
</div>

<script>
// -------------------- top bar user chip / dropdown --------------------
(function mountTopActions(){
  const host = document.getElementById('topActions');
  if (!host) return;

  const p = JSON.parse(localStorage.getItem('ci_profile') || '{}');
  const initials = (function(name){
    if(!name) return 'CI';
    const parts = name.trim().split(/\s+/);
    return parts.slice(0,2).map(s=>s[0]?.toUpperCase()||'').join('') || 'CI';
  })(p.name);

  const role = p.role || 'Analyst';
  const isSub = (localStorage.getItem('ci_subscribed') === 'true');

  host.innerHTML = `
    <div class="user" id="userChip">
      <div class="avatar">${initials}</div>
      ${role}
    </div>
    <div class="dropdown" id="userMenu">
      <a href="settings.html">Settings</a>
      <a href="analytics.html">Analytics</a>
      <a href="system-flow.html">System Flow</a>
      <a href="operations-log.html">Operations Log</a>
      <a href="#" id="logoutLink"><span class="logout-link">Log out</span></a>
    </div>
  `;

  const chip  = document.getElementById('userChip');
  const menu  = document.getElementById('userMenu');
  const logoutLink = document.getElementById('logoutLink');

  chip.addEventListener('click', ()=>{
    menu.style.display = (menu.style.display==='block')?'none':'block';
  });
  document.addEventListener('click',(e)=>{
    if(!host.contains(e.target)) menu.style.display='none';
  });

  logoutLink.addEventListener('click',(e)=>{
    e.preventDefault();
    if(window.CIAuth && CIAuth.logout) CIAuth.logout();
    location.href='index.html';
  });

  // trial banner logic
  const trialBanner = document.getElementById('trial-banner');
  const trialText   = document.getElementById('trial-text');
  const trialEnds   = localStorage.getItem('ci_trialEndsAt');
  const subscribed  = (localStorage.getItem('ci_subscribed') === 'true');

  if (!subscribed && trialEnds) {
    // show "Your trial ends <time>"
    try {
      const d = new Date(trialEnds);
      const leftMin = Math.max(0, Math.round((d - Date.now()) / 60000));
      trialBanner.style.display='block';
      if (leftMin <= 0) {
        trialText.textContent = 'Your trial has ended.';
      } else if (leftMin < 60) {
        trialText.textContent = `Your trial ends in ${leftMin} min`;
      } else {
        const leftHr = Math.round(leftMin/60);
        trialText.textContent = `Your trial ends in ${leftHr} hour${leftHr!==1?'s':''}`;
      }
    } catch(e){
      trialBanner.style.display='block';
      trialText.textContent = 'Trial active.';
    }
  }
})();

// -------------------- FEED STORAGE / STATE --------------------
const STORAGE_KEY = 'ci_live_feeds_v1';
const FEED_EVENTS_KEY = 'ci_live_feed_events_v1';
const HISTORY_WINDOWS = [12, 24, 48, 72];                    // For "Load earlier" ‚Äì how far back we go on each click (in hours)



// === FEED ‚Üî MAP SIDEBAR BRIDGE ==========================
window.ciFeedSummaries = window.ciFeedSummaries || {};

/**
 * Store a small summary per feed so the map sidebar can render it.
 */
function publishFeedSummary(feed, events){
  if (!feed || !feed.id) return;
  const list = Array.isArray(events) ? events : [];

  let hi = 0, med = 0, low = 0;
  list.forEach(ev => {
    const r = (ev.risk || '').toLowerCase();
    if (r === 'high') hi++;
    else if (r === 'med' || r === 'medium') med++;
    else low++;
  });

  const label =
    (feed.places && feed.places.length)
      ? feed.places.join(', ')
      : (feed.keywords && feed.keywords.length
           ? feed.keywords.join(', ')
           : 'Custom feed');

  window.ciFeedSummaries[feed.id] = {
    id: feed.id,
    label,
    high: hi,
    med,
    low,
    total: list.length
  };

  // Let the map sidebar refresh if it's ready
  if (typeof window.ciUpdateMapSidebar === 'function') {
    window.ciUpdateMapSidebar(window.ciFeedSummaries);
  }
}



	
// per-feed UI cache (so cards can show stuff before network finishes)
const FEED_UI_CACHE_TTL = 30 * 60 * 1000; // 30 minutes

function saveUiCache(feedId, events) {
  if (!feedId) return;
  const key = 'ci_ui_feed_' + feedId;
  localStorage.setItem(key, JSON.stringify({
    at: Date.now(),
    events: Array.isArray(events) ? events : []
  }));
}

function loadUiCache(feedId) {
  if (!feedId) return null;
  const key = 'ci_ui_feed_' + feedId;
  try {
    const obj = JSON.parse(localStorage.getItem(key) || 'null');
    if (!obj || !obj.at) return null;
    if (Date.now() - obj.at > FEED_UI_CACHE_TTL) return null;
    return obj.events || [];
  } catch {
    return null;
  }
}
	

	
function storeFeedEvents(feedId, events) {
  const all = JSON.parse(localStorage.getItem(FEED_EVENTS_KEY) || '{}');
  all[feedId] = { at: Date.now(), events };
  localStorage.setItem(FEED_EVENTS_KEY, JSON.stringify(all));
}

function loadFeedEvents(feedId) {
  const all = JSON.parse(localStorage.getItem(FEED_EVENTS_KEY) || '{}');
  const entry = all[feedId];
  if (!entry) return null;
  // 15-minute TTL
  if (Date.now() - entry.at > 15 * 60 * 1000) return null;
  return entry;
}

	
// read feeds from localStorage
function loadFeeds(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr)?arr:[];
  }catch(e){
    return [];
  }
}

// save feeds to localStorage
function saveFeeds(feeds){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(feeds));
}

// add a feed definition {id, places[], risks[]}
function addFeedDef(def){
  const feeds = loadFeeds();
    feeds.push({ ...def, useLive: !!def.useLive });
  saveFeeds(feeds);
}

function truncate(str, n=48) {
  return (str.length > n) ? (str.slice(0, n-1) + '‚Ä¶') : str;
}

function escapeHtml(s='') {
  return s.replace(/[&<>"']/g, m =>
    ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

// ---- 7-day per-feed archive (new) ----
const FEED_ARCHIVE_KEY = 'ci_live_feed_archive_v1';

function loadArchiveMap(){
  try { return JSON.parse(localStorage.getItem(FEED_ARCHIVE_KEY) || '{}'); }
  catch { return {}; }
}
function saveArchiveMap(map){
  localStorage.setItem(FEED_ARCHIVE_KEY, JSON.stringify(map));
}
function archiveMerge(feedId, events, { maxItems = 300 } = {}){
  if (!feedId || !Array.isArray(events) || !events.length) return;
  const map = loadArchiveMap();
  const current = Array.isArray(map[feedId]) ? map[feedId] : [];

  // üí° dedupe by src + trimmed time + title ONLY ‚Äì ignore id
  const makeKey = (e) =>
    `${(e.src || '').toLowerCase()}|${(e.when || '').slice(0,16)}|${(e.title || '')
      .toLowerCase()
      .replace(/\s+/g,' ')
      .slice(0,80)}`;

  const seen = new Set(current.map(makeKey));

  for (const ev of events){
    const key = makeKey(ev);
    if (!seen.has(key)) {
      current.push(ev);
      seen.add(key);
    }
  }

  current.sort((a,b) => (Date.parse(b.when)||0) - (Date.parse(a.when)||0));
  map[feedId] = current.slice(0, maxItems);
  saveArchiveMap(map);
}

function loadArchive(feedId){
  const map = loadArchiveMap();
  return Array.isArray(map[feedId]) ? map[feedId] : [];
}

	

	function renderKeywordsLine(keywords = []) {
  if (!keywords.length) return '';
  const max = 3;
  const shown = keywords.slice(0, max);
  const extra = Math.max(0, keywords.length - shown.length);
  const chips = shown.map(k => `<span class="kw-chip">${escapeHtml(k)}</span>`).join(' ');
  const more  = extra ? `<span class="kw-more">+${extra} more</span>` : '';
  const full  = escapeHtml(keywords.join(', '));
  return `<div class="feed-kw" title="${full}">Topics: ${chips} ${more}</div>`;
}


	
// ---- unified way to get events for a feed (archive > UI cache > short cache) ----
function getEventsForFeed(feed){
  if (!feed || !feed.id) return [];
  // 1) 7-day archive
  let events = loadArchive(feed.id);
  if (Array.isArray(events) && events.length) return events;

  // 2) per-feed UI cache
  const ui = loadUiCache(feed.id);
  if (Array.isArray(ui) && ui.length) return ui;

  // 3) 15-min feedEvents cache
  const cached = loadFeedEvents(feed.id);
  if (cached && Array.isArray(cached.events) && cached.events.length) {
    return cached.events;
  }
  return [];
}


	
// ---- Per-feed mini summary in the header ----
function updateFeedHeaderStats(feed, events){
  if (!feed || !feed.id) return;

  const metaEl = document.getElementById(`feedMeta-${feed.id}`);
  if (!metaEl) return;

  const windowHours = getCurrentWindowHours();
  const cutoffMs    = Date.now() - windowHours * 3600_000;

  const list = Array.isArray(events) ? events : [];
  const inWindow = list.filter(ev => {
    const t = Date.parse(ev.when || '');
    return !isNaN(t) && t >= cutoffMs;
  });

  if (!inWindow.length){
    metaEl.innerHTML = `
      <span class="live-now-empty">
        No alerts in last ${windowHours}h.
      </span>
    `;
    return;
  }

  let hi = 0, med = 0, low = 0;
  const typeCounts = {};

  inWindow.forEach(ev => {
    const r = (ev.risk || '').toLowerCase();
    if (r === 'high') hi++;
    else if (r === 'med' || r === 'medium') med++;
    else low++;

    // reuse your classifier for top types
    const { emoji, label } = classifyIncident(ev || {});
    const key = `${emoji} ${label}`;
    typeCounts[key] = (typeCounts[key] || 0) + 1;
  });

  const total = inWindow.length;

  // pick top 3 incident type emojis
  const topTypes = Object.entries(typeCounts)
    .sort((a,b) => b[1] - a[1])
    .slice(0,3)
    .map(([k]) => k.split(' ')[0])      // just the emoji
    .join(' ');

  const bits = [];
  if (hi)  bits.push(`${hi} high`);
  if (med) bits.push(`${med} med`);
  if (low) bits.push(`${low} low`);
  const riskText = bits.join(', ');

  metaEl.innerHTML = `
    <span class="badge">Last ${windowHours}h</span>
    <span>${total} alerts${riskText ? ` (${riskText})` : ''}</span>
    ${topTypes ? `<span style="opacity:.9;">Types: ${topTypes}</span>` : ''}
  `;
}
	

	
	// ---- lightweight client-side incident filter (new) ----
const INCIDENT_POSITIVE = [
  'protest','demonstration','clashes','riot','unrest','blockade','strike',
  'explosion','blast','bomb','fire','evacuation','evacuated','lockdown',
  'shooting','stabbing','gunfire','shots fired','attack','assault',
  'road closed','road closure','traffic disruption','derailment',
  'power outage','blackout','hazmat','chemical spill','gas leak',
  'police','security incident','incident','emergency'
];
const INCIDENT_BAD_WORDS = [
  'live scoring','live blog','live stream','how to watch','tickets',
  'premier league','tottenham','manchester united','arsenal','chelsea','liverpool',
  'rugby','cricket','nba','mlb','celebrity','fashion','award','red carpet','tv show',
  'movie','music','festival','actor','actress','singer','rapper','royal family',
  'restaurant review','shop opening','store opening','photo gallery','in pictures',
  'style','trend','beauty tips'
];
function isLikelyIncidentClient(ev){
  const text = `${ev.title||''} ${ev.description||''}`.toLowerCase();
  if (INCIDENT_BAD_WORDS.some(b => text.includes(b))) return false;
  if (INCIDENT_POSITIVE.some(g => text.includes(g))) return true;
  const r = (ev.risk||'').toLowerCase();
  return r === 'high' || r === 'med';
}


	
// ---- Global time window control (hours) ----
const WINDOW_STORAGE_KEY = 'ci_feed_window_hours';

function getCurrentWindowHours() {
  const raw = localStorage.getItem(WINDOW_STORAGE_KEY);
  const h = Number(raw);
  if (!Number.isFinite(h) || h <= 0) return 6;
  return Math.min(72, h);
}

function initWindowSelector() {
  const sel = document.getElementById('windowSelect');
  if (!sel) return;

  // initialise from storage
  const current = String(getCurrentWindowHours());
  if ([...sel.options].some(o => o.value === current)) {
    sel.value = current;
  }

  sel.addEventListener('change', () => {
    const h = Number(sel.value || '6') || 6;
    const clamped = Math.max(1, Math.min(72, h));
    localStorage.setItem(WINDOW_STORAGE_KEY, String(clamped));
    // re-run all feeds with the new window
    renderFeeds();
  });
}

// call once after DOM is ready
document.addEventListener('DOMContentLoaded', initWindowSelector);
	

// -------------------- RENDER / FETCH MOCK DATA --------------------
async function fetchMockEventsForFeed(feed) {
  const params = new URLSearchParams();
  if (feed.places?.length)   params.set('cities',   feed.places.join(','));
  if (feed.risks?.length)    params.set('risk',     feed.risks.join(','));
  if (feed.keywords?.length) params.set('keywords', feed.keywords.join(','));

  const base = 'https://api.cityintelapi.com';
  const provider = 'newsdata';
  const windowHours = getCurrentWindowHours();
params.set('window', String(windowHours));

	
  // primary + backup candidates
  const urls = feed.useLive
    ? [
        `${base}/api/live-news?${params.toString()}&provider=${provider}`,            // primary
        `${base}/api/live-news?${params.toString()}&provider=${provider}&alt=1`      // backup ‚Äì change to your 2nd key
      ]
    : [
        `${base}/api/live?${params.toString()}`,                                     // primary
        `${base}/api/live?${params.toString()}&alt=1`                                // backup ‚Äì change to your 2nd key
      ];

  for (const url of urls) {
    try {
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      // if quota hit we often get 429
      if (!res.ok) {
        if (res.status === 429) continue; // try next URL
        continue;
      }
		
      const data = await res.json().catch(() => ({}));
      let events = Array.isArray(data.events) ? data.events : [];

// FRONTEND safety filter (client-side guard)
events = events.filter(isLikelyIncidentClient);

return events;
		
    } catch (err) {
      // try next candidate
      continue;
    }
  }

  // if both failed
  return [];
}



function riskClass(r){
  if(r==='high') return 'high';
  if(r==='med')  return 'med';
  return 'low';
}

function fmtWhen(iso) {
  try {
    const s = new Date(iso).toLocaleString('en-GB', {
      timeZone: 'Europe/London',
      day: '2-digit',
      month: 'short',
      hour: '2-digit',
      minute: '2-digit',
      hour12: false
    });
    // drop trailing ", 12:18 am" ‚Üí or just the AM/PM part
    return s.replace(/,\s*(\d{2}:\d{2})\s*(AM|PM)$/i, ' $1')
            .replace(/\s*(AM|PM)$/i, '');
  } catch (e) {
    return iso || '';
  }
}

// ---- Global "Now" strip across all feeds ----
function recomputeGlobalStrip(){
  const strip = document.getElementById('liveNowStrip');
  if (!strip) return;

  const windowHours = getCurrentWindowHours();
  const cutoffMs    = Date.now() - windowHours * 3600_000;

  const feeds = loadFeeds();
  let all = [];

  feeds.forEach(feed => {
    const evs = getEventsForFeed(feed);
    evs.forEach(ev => {
      const t = Date.parse(ev.when || '');
      if (!t || t < cutoffMs) return;
      all.push({ ...ev, __feedId: feed.id });
    });
  });

  // empty state
  if (!all.length){
    strip.innerHTML = `
      <div class="live-now-label">NOW</div>
      <div class="live-now-stats live-now-empty">
        No alerts in the current ${windowHours}h window.
      </div>
    `;
    return;
  }

  // counts by risk
  let hi = 0, med = 0, low = 0;
  all.forEach(ev => {
    const r = (ev.risk || '').toLowerCase();
    if (r === 'high') hi++;
    else if (r === 'med' || r === 'medium') med++;
    else low++;
  });

  // pick top 3 incidents: high > med > low, then newest first
  const riskScore = r => r === 'high' ? 3 : (r === 'med' || r === 'medium' ? 2 : 1);
  all.sort((a,b) => {
    const rs = riskScore(b.risk || '') - riskScore(a.risk || '');
    if (rs !== 0) return rs;
    return (Date.parse(b.when||0) || 0) - (Date.parse(a.when||0) || 0);
  });

  const top = all.slice(0,3);

  // build pills
  const pillsHtml = top.map(ev => {
    const { emoji, label } = classifyIncident(ev || {});
    const city = ev.city || 'Unknown';
    const title = ev.title || ev.summary || '(no title)';
    const shortTitle = title.length > 40 ? title.slice(0,37) + '‚Ä¶' : title;
    const safeTitle = (ev.title || '').replace(/"/g, '&quot;');
    return `
      <button class="live-now-pill"
              data-feedid="${ev.__feedId}"
              data-title="${safeTitle}">
        <span>${emoji}</span>
        <span>${city}: ${shortTitle}</span>
      </button>
    `;
  }).join('');

  strip.innerHTML = `
    <div class="live-now-label">NOW</div>
    <div class="live-now-stats">
      <span><span class="dot-high">‚óè</span> ${hi} high</span>
      <span><span class="dot-med">‚óè</span> ${med} med</span>
      <span><span class="dot-low">‚óè</span> ${low} low</span>
      <span style="opacity:.75;margin-left:4px;">in last ${windowHours}h</span>
    </div>
    <div class="live-now-pills">
      ${pillsHtml || '<span class="live-now-empty">No headline incidents to highlight.</span>'}
    </div>
  `;
}


	
// Click: jump to card + open detail panel
document.addEventListener('click', (e) => {
  const pill = e.target.closest('.gm-feed-pill');
  if (!pill) return;

  const feedId = pill.dataset.feedid;
  if (!feedId) return;
  const title  = pill.getAttribute('data-title') || '';

  const feeds = loadFeeds();
  const feed  = feeds.find(f => f.id === feedId);
  if (!feed) return;

  const events = getEventsForFeed(feed);
  if (!events.length) return;

  // try to find matching event by exact title
  let ev = events.find(ev => (ev.title || '') === title);
  if (!ev) {
    // fallback: first event in that feed
    ev = events[0];
  }

  // scroll the card into view
  const card = document.querySelector(`.feed-card[data-id="${feedId}"]`);
  if (!card) return;

  card.scrollIntoView({ behavior: 'smooth', block: 'start' });
  card.classList.add('feed-card-highlight');
  setTimeout(() => card.classList.remove('feed-card-highlight'), 1400);
  

  // open detail panel with full list as related
  if (ev) {
    openDetailPanel(ev, events);
  }
});

	

// -------------------- DETAIL PANEL HANDLING --------------------

function buildIntelSummary(ev, earlierList) {
  if (!ev) return '';

  const where = ev.city || 'the area';
  const riskRaw = (ev.risk || '').toLowerCase();
  const riskLabel =
    riskRaw === 'high' ? 'High‚Äìpriority' :
    riskRaw === 'med'  ? 'Medium‚Äìpriority' :
    'Low‚Äìpriority';

  const whenLabel = ev.when ? fmtWhen(ev.when) : 'recently';
  const lines = [];

  lines.push(`${riskLabel} incident reported in ${where} at ${whenLabel}.`);

  if (ev.title) {
    lines.push(`Headline: ${ev.title}`);
  }

  const desc = (ev.description || '').trim();
  if (desc) {
    const trimmed = desc.length > 220 ? desc.slice(0, 217).trimEnd() + '‚Ä¶' : desc;
    lines.push(trimmed);
  }

  const earlierCount = Array.isArray(earlierList) ? earlierList.length : 0;
  if (earlierCount > 0) {
    lines.push(
      `Earlier today: ${earlierCount} additional alert${earlierCount > 1 ? 's' : ''} logged in ${where}.`
    );
  }

  return lines.join('\n\n');
}	


// NEW: simple incident type classifier for the tag line
function classifyIncident(ev) {
  const text = `${ev.title || ''} ${ev.description || ''}`.toLowerCase();

  if (/fire|blaze|explosion|blast|smoke|burning|warehouse fire/.test(text)) {
    return { emoji: 'üî•', label: 'Fire / Explosion' };
  }
  if (/protest|demonstration|rally|march|unrest|riot|blockade|strike|picket/.test(text)) {
    return { emoji: '‚ö†Ô∏è', label: 'Civil Unrest / Protest' };
  }
  if (/shooting|stabbing|knife attack|gunfire|shots fired|assault|robbery|armed/.test(text)) {
    return { emoji: 'üö®', label: 'Crime / Violence' };
  }
  if (/road closed|traffic|collision|crash|derailment|train disruption|airport closed|flight/.test(text)) {
    return { emoji: 'üöß', label: 'Transport / Traffic' };
  }
  if (/power outage|blackout|grid failure|water outage|gas leak|chemical spill|hazmat|outage/.test(text)) {
    return { emoji: '‚ö°', label: 'Infrastructure / Outage' };
  }

  return { emoji: 'üìç', label: 'General Incident' };
}

	
const detailPanel   = document.getElementById('detailPanel');
const detailTitleEl = document.getElementById('detailTitle');
const detailMetaEl  = document.getElementById('detailMeta');
const detailSummaryEl = document.getElementById('detailSummary');
const detailLocationEl = document.getElementById('detailLocation');
const detailImpactEl   = document.getElementById('detailImpact');
const detailEarlierEl  = document.getElementById('detailEarlier');
const detailCloseBtn = document.getElementById('detailClose');
const viewFullBtn   = document.getElementById('viewFullBtn');
const detailTagEl   = document.getElementById('detailTag'); 
	

function lonLatToXY(lon, lat, w, h) {
  // quick equirectangular projection
  const x = (lon + 180) * (w / 360);
  const y = (90 - lat) * (h / 180);
  return [x, y];
}

function drawMiniMapPin(lat, lon) {
  const cvs = document.getElementById('detailMiniMap');
  const coordsEl = document.getElementById('detailCoords');
  if (!cvs || !coordsEl) return;

  const ctx = cvs.getContext('2d');
  const w = cvs.width, h = cvs.height;

  // background grid
  ctx.clearRect(0, 0, w, h);
  ctx.fillStyle = '#14161a';
  ctx.fillRect(0, 0, w, h);
  ctx.strokeStyle = 'rgba(255,255,255,0.07)';
  ctx.lineWidth = 1;
  for (let gx = 0; gx <= w; gx += 32) { ctx.beginPath(); ctx.moveTo(gx, 0); ctx.lineTo(gx, h); ctx.stroke(); }
  for (let gy = 0; gy <= h; gy += 24) { ctx.beginPath(); ctx.moveTo(0, gy); ctx.lineTo(w, gy); ctx.stroke(); }

  // subtle oval to avoid flat look
  ctx.strokeStyle = 'rgba(255,255,255,0.05)';
  ctx.beginPath();
  ctx.ellipse(w/2, h/2, w*0.46, h*0.36, 0, 0, Math.PI*2);
  ctx.stroke();

  if (typeof lat === 'number' && typeof lon === 'number') {
    const [x, y] = lonLatToXY(lon, lat, w, h);

    // glow
    ctx.beginPath();
    ctx.arc(x, y, 7, 0, Math.PI*2);
    ctx.fillStyle = 'rgba(255,77,77,0.25)';
    ctx.fill();

    // pin
    ctx.beginPath();
    ctx.arc(x, y, 3, 0, Math.PI*2);
    ctx.fillStyle = '#ff4d4d';
    ctx.shadowColor = '#ff4d4d';
    ctx.shadowBlur = 8;
    ctx.fill();
    ctx.shadowBlur = 0;

    coordsEl.textContent = `Coordinates: ${lat.toFixed(3)}, ${lon.toFixed(3)}`;
  } else {
    coordsEl.textContent = 'No coordinates provided for this alert.';
  }
}

	
function openDetailPanel(item, relatedList){
  // item = {title, city, risk, when, ...}
  // relatedList = array of all events in that feed (for "earlier today")

  const earlier = (relatedList || [])
    .filter(x => x.city === item.city && x.when !== item.when)
    .slice(0, 3);

  detailTitleEl.textContent = item.title || '[Incident Title]';
  detailMetaEl.textContent = `${item.city || 'Unknown'} ‚Ä¢ ${item.risk || 'n/a'} ‚Ä¢ ${fmtWhen(item.when)}`;

  if (detailTagEl) {
    const { emoji, label } = classifyIncident(item || {});
    detailTagEl.textContent = `${emoji} ${label}`;
  }

	
	  // NEW: richer intel-style summary
  detailSummaryEl.textContent = buildIntelSummary(item, earlier);

    // location text
    detailLocationEl.textContent =
    `Approx area: ${item.city || 'unknown'}${item.country ? ', ' + item.country : ''}.`;


	
  // real exposure based on stored assets/travellers
  let exposure = { assets: [], travellers: [] };
  if (window.CIExposure && CIExposure.exposureFor) {
    exposure = CIExposure.exposureFor(item.city || item.City,
                                      item.country || item.Country);
  }
  const nA = exposure.assets.length;
  const nT = exposure.travellers.length;

  if (nA || nT) {
    const assetStr = nA
      ? `${nA} mapped asset${nA > 1 ? 's' : ''}`
      : 'no mapped assets';
    const travStr  = nT
      ? `${nT} mapped traveller${nT > 1 ? 's' : ''}`
      : 'no mapped travellers';

    detailImpactEl.innerHTML = `
      <span style="font-weight:700;letter-spacing:.03em;font-size:11px;color:#fecaca;">
        ASSETS &amp; TRAVELLERS </span><br>
      <span style="color:#f97373;font-weight:600;">
        ${assetStr}; ${travStr}
      </span><br> <span style="opacity:.85;">Review posture for affected locations and contact travellers as needed.</span>
    `;
  } else {
    detailImpactEl.innerHTML = `
      <span style="font-weight:700;letter-spacing:.03em;font-size:11px;color:#9ca3af;">
        ASSETS &amp; TRAVELLERS</span><br><span style="opacity:.9;">
        No mapped company assets or travellers currently in this city(based on stored data). </span>
    `;
  }

	  const detailExposureListEl = document.getElementById('detailExposureList');

  if (detailExposureListEl) {
    if (nA || nT) {
      const assetLines = exposure.assets.map(a =>
        `<li><b>${a.name || 'Asset'}</b>${a.type ? ` ‚Äî ${a.type}` : ''}${
          a.city || a.country ? ` (${[a.city, a.country].filter(Boolean).join(', ')})` : ''
        }</li>`
      ).join('');

      const travLines = exposure.travellers.map(t =>
        `<li><b>${t.name || 'Traveller'}</b>${t.role ? ` ‚Äî ${t.role}` : ''}${
          t.hotel ? ` ‚Äî ${t.hotel}` : ''
        }</li>`
      ).join('');

      detailExposureListEl.innerHTML = `
        ${assetLines ? `<div style="margin-bottom:6px;"><b>Assets</b><ul>${assetLines}</ul></div>` : ''}
        ${travLines ? `<div><b>Travellers</b><ul>${travLines}</ul></div>` : ''}
      `;
    } else {
      detailExposureListEl.innerHTML =
        `<span style="opacity:.85;">No mapped assets or travellers in this city.</span>`;
    }
  }



  // Mini-map pin (lat/lon come from the event if present)
  if (typeof item.lat === 'number' && typeof item.lon === 'number') {
    drawMiniMapPin(item.lat, item.lon);
  } else {
    drawMiniMapPin(null, null);
  }

	
  // earlier today in same city (re-use the list we already built)
  if (earlier.length) {
    detailEarlierEl.innerHTML =
      '<ul class="earlier-list">' +
      earlier.map(x => `<li>${fmtWhen(x.when)} ‚Äî ${x.title}</li>`).join('') +
      '</ul>';
  } else {
    detailEarlierEl.textContent = 'No earlier incidents recorded.';
  }


  // notify map to jump / highlight this incident
  try {
    window.dispatchEvent(new CustomEvent('ci:jumpToIncident', {
      detail: {
        city:    item.city    || item.City    || null,
        country: item.country || item.Country || null,
        lat: (typeof item.lat === 'number') ? item.lat : null,
        lon: (typeof item.lon === 'number') ? item.lon : null
      }
    }));
  } catch (e) {
    console.warn('ci:jumpToIncident dispatch failed', e);
  }


	
  // incident deep-link -> you already pass this into incident.html
  viewFullBtn.href = 'incident.html';

  // keep last item handy for the incident drilldown handover
  window.__lastDetailItem = item;

  detailPanel.classList.add('open');
}



	
function closeDetailPanel() {
  const cvs = document.getElementById('detailMiniMap');
  if (cvs) {
    const ctx = cvs.getContext('2d');
    ctx.clearRect(0, 0, cvs.width, cvs.height);
  }
  detailPanel.classList.remove('open');
}

// attach listeners ONCE
detailCloseBtn.addEventListener('click', closeDetailPanel);
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeDetailPanel();
  }
});



// Re-render a single card (fetch -> DOM -> schedule next refresh)
async function refreshSingleFeedCard(cardEl, feed){
  try {
    const events = await fetchMockEventsForFeed(feed);
    renderEventsIntoCard(cardEl, events, feed);
  } finally {
    scheduleNextRefresh(cardEl, feed);
  }
}


	

	// -------------------------------------------------------------
// GROUPING ENGINE ‚Äî collapses similar alerts into update threads
// -------------------------------------------------------------
function groupEvents(events) {

  // helper: normalise titles for fuzzy-matching
  const norm = (s='') =>
    s.toLowerCase()
     .replace(/[^a-z0-9 ]+/g, '')
     .replace(/\s+/g, ' ')
     .trim();

  // helper: check if two timestamps are within 60 minutes
  const within60 = (a, b) => {
    try {
      const aa = new Date(a).getTime();
      const bb = new Date(b).getTime();
      return Math.abs(aa - bb) <= 3600_000; // 1 hour
    } catch (e) {
      return false;
    }
  };

  const groups = [];

  events.forEach(ev => {
    const nTitle = norm(ev.title || ev.summary || ev.description || '');

    let matched = null;

    // try to match with existing groups
    for (const g of groups) {
      if (
        g.city === ev.city &&                  // same city
        g.category === ev.category &&          // same category  
        within60(g.latestWhen, ev.when) &&     // close in time
        (norm(g.baseTitle).includes(nTitle) || // fuzzy title match
         nTitle.includes(norm(g.baseTitle)))
      ) {
        matched = g;
        break;
      }
    }

    if (!matched) {
      // make a new group
      matched = {
        city: ev.city,
        category: ev.category,
        events: [],
        baseTitle: ev.title || ev.summary || '',
        latestWhen: ev.when
      };
      groups.push(matched);
    }

    matched.events.push(ev);

    // update latest timestamp
    if (new Date(ev.when) > new Date(matched.latestWhen)) {
      matched.latestWhen = ev.when;
      matched.baseTitle = ev.title || ev.summary || matched.baseTitle;
    }
  });

  // sort groups newest ‚Üí oldest
  groups.sort((a, b) =>
    new Date(b.latestWhen) - new Date(a.latestWhen)
  );

  // inside each group, sort events newest ‚Üí oldest
  groups.forEach(g =>
    g.events.sort((a, b) =>
      new Date(b.when) - new Date(a.when)
    )
  );

  return groups;
}



	// -------------------------------------------------------------
// RECENCY AGE CLASSIFIER
// -------------------------------------------------------------
function getAgeClass(when) {
  let t = 0;
  try { t = new Date(when).getTime(); } catch(e) {}
  if (!t) return 'age-stale';

  const ageMin = (Date.now() - t) / 60000; // minutes

  if (ageMin <= 10)  return 'age-fresh';   // 0‚Äì10 min
  if (ageMin <= 30)  return 'age-recent';  // 10‚Äì30 min
  if (ageMin <= 60)  return 'age-older';   // 30‚Äì60 min
  return 'age-stale';                      // 60+ min
}


	
function ageLabel(when) {
  const t = Date.parse(when || '');
  if (isNaN(t)) return '';

  const mins = Math.round((Date.now() - t) / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return `${mins} min ago`;

  const hrs = Math.round(mins / 60);
  if (hrs < 24) return `${hrs}h ago`;

  const days = Math.round(hrs / 24);
  return `${days}d ago`;
}

	

// Put the events into an existing card (no refetch here)
const MAX_VISIBLE_EVENTS = 20;

function renderEventsIntoCard(cardEl, events, feed) {
  const bodyEl = cardEl.querySelector('.feed-body');
  const list   = bodyEl;

  // Fallback to cached events if nothing new came in
  let listEvents = Array.isArray(events) ? events : [];
  if (!listEvents.length) {
    const cached = loadUiCache(feed.id) || (loadFeedEvents(feed.id)?.events || []);
    if (cached && cached.length) {
      listEvents = cached;
    }
  }

  // Update caches if we actually have something
  if (Array.isArray(listEvents) && listEvents.length) {
    storeFeedEvents(feed.id, listEvents);
    saveUiCache(feed.id, listEvents);
    archiveMerge(feed.id, listEvents);
  }

  // Prefer 7-day archive if present
  const archived   = loadArchive(feed.id);
  const renderList = (archived && archived.length) ? archived : listEvents;

  // Keep it ‚Äúfresh‚Äù by default: prefer last 3h if available
  const now       = Date.now();
  const MAX_AGE_MS = 3 * 60 * 60 * 1000;
  const fresh = renderList.filter(ev => {
    const t = Date.parse(ev.when || '');
    return !isNaN(t) && (now - t <= MAX_AGE_MS);
  });

  const displayEvents = fresh.length ? fresh : renderList;

  // update per-feed header stats
  updateFeedHeaderStats(feed, displayEvents);
  publishFeedSummary(feed, displayEvents);
	
  // Track some stats for the refresh scheduler
  cardEl.__state = cardEl.__state || { lastLen: 0, lastHighAt: 0 };
  cardEl.__state.lastLen = displayEvents.length;
  if (displayEvents.some(e => (e.risk || '').toLowerCase() === 'high')) {
    cardEl.__state.lastHighAt = Date.now();
  }

  bodyEl.innerHTML = '';

  if (!displayEvents.length) {
    bodyEl.innerHTML = `
      <div style="font-size:12px;color:var(--muted);opacity:.8;">
        No alerts in the selected window.
      </div>
    `;
  } else {
    // ---------- GROUPED VIEW ----------
    const groups = groupEvents(displayEvents);

    // take only the newest 8 grouped threads
    groups.slice(0, 8).forEach(g => {
      const first   = g.events[0];       // newest in the group
      const updates = g.events.length - 1;

      const risk = (first.risk || '').toLowerCase();
      const riskColor =
        risk === 'high'   ? '#b21f1f' :
        risk === 'medium' ? '#d97706' :
        risk === 'low'    ? '#15803d' :
                            '#666';

      const cat      = first.category || first.type || 'i';
      const whenNice = fmtWhen(first.when);

      const groupEl  = document.createElement('div');
      const ageClass = getAgeClass(first.when);

		
      // NEW: exposure (assets + travellers) for this city/country
            let exposureHtml = '';
      if (window.CIExposure && CIExposure.exposureFor) {
        const exp = CIExposure.exposureFor(first.city || first.City,
                                           first.country || first.Country);
        const nA = exp.assets.length;
        const nT = exp.travellers.length;
        if (nA || nT) {
          exposureHtml = `
            <div class="eg-exposure" style="margin-top:6px;font-size:12px;">
              <span style=" display:inline-block; padding:3px 8px;
                border-radius:999px; background:rgba(59,130,246,0.32);   /* brighter blue */
                border:1px solid rgba(59,130,246,0.9); color:#e5f0ff;
                font-weight:600; margin-right:6px;">Assets: <b>${nA}</b></span>
              
			  <span style=" display:inline-block; padding:3px 8px; border-radius:999px;
                background:rgba(245,158,11,0.32);   /* brighter amber */
                border:1px solid rgba(245,158,11,0.9);color:#fff7e6;font-weight:600;
              ">Travellers: <b>${nT}</b></span></div>
          `;
        }
      }


		
            groupEl.className = `event-group ${ageClass}`;
            groupEl.innerHTML = `
  	<div class="eg-header">
    <div class="eg-title">
      <span class="eg-icon">${cat.slice(0,1).toUpperCase()}</span>
      ${first.title || first.summary || '(no title)'}
    </div>
    <div class="eg-meta">
      <span class="eg-updates">${updates > 0 ? `(${updates} updates)` : ''}</span>
      <span class="eg-arrow">‚ñº</span>
    </div>
  </div>

  <div class="eg-sub">
    <div class="eg-risk" style="color:${riskColor}">${risk || 'n/a'}</div>
    <div class="eg-when">${whenNice} ‚Ä¢ ${ageLabel(first.when)}</div>
  </div>

  ${exposureHtml}

  <div class="eg-body" style="display:none;">
    ${g.events.map(ev => `
      <div class="eg-item">
        <div class="eg-item-when">${fmtWhen(ev.when)}</div>
        <div class="eg-item-text">
          ${ev.summary || ev.description || ev.title}
        </div>
      </div>
    `).join('')}
  </div>

  <div class="eg-footer">
    <button class="btn-ghost eg-view-btn" type="button">
      View incident details ‚Üí
    </button>
  </div>
`;



      // collapse / expand behaviour on header
      const headerEl = groupEl.querySelector('.eg-header');
      headerEl.addEventListener('click', () => {
        const body  = groupEl.querySelector('.eg-body');
        const arrow = groupEl.querySelector('.eg-arrow');
        const open  = body.style.display === 'block';
        body.style.display = open ? 'none' : 'block';
        arrow.textContent  = open ? '‚ñº' : '‚ñ≤';
      });
		
const viewBtn = groupEl.querySelector('.eg-view-btn');
if (viewBtn) {
  viewBtn.addEventListener('click', (e) => {
    e.stopPropagation();              // don‚Äôt toggle collapse
    openDetailPanel(first, g.events); // show slide-out panel
  });
}
      // CLICK ANY UPDATE ‚Üí open side detail panel
      const itemNodes = groupEl.querySelectorAll('.eg-item');
      g.events.forEach((ev, idx) => {
        const node = itemNodes[idx];
        if (!node) return;
        node.addEventListener('click', (e) => {
          e.stopPropagation();               // don‚Äôt toggle the collapse
          openDetailPanel(ev, g.events);     // show slide-out with this alert
        });
      });

      list.appendChild(groupEl);
    });
  }

  // --- Footer: source label + timestamp -------------------------------
  const srcEl = cardEl.querySelector('.feed-footer .src');
  if (srcEl) {
    const usedFallback = feed.useLive && !listEvents.length;
    const base = feed.useLive
      ? (usedFallback ? 'source: live stream (fallback active)' : 'source: live stream')
      : 'source: simulated source';
    const time = new Date().toLocaleTimeString();
    srcEl.textContent = `${base} ‚Ä¢ updated ${time}`;
  }
}


// Timer per card (60s live, 120s mock) + small jitter so cards don't all refresh together
function scheduleNextRefresh(cardEl, feed){
  // safety guard ‚Äì if something calls us without a card or feed, bail out
  if (!cardEl || !feed) return;

  // keep lightweight state per card
  cardEl.__state = cardEl.__state || { lastLen: 0, lastHighAt: 0 };
  const { lastLen, lastHighAt } = cardEl.__state;

  // base cadence
  let base = feed.useLive ? 600_000 : 1200_000;

  // if last pull had zero items on a LIVE feed, try a bit sooner
  if (feed.useLive && lastLen === 0) base = 600_000;

  // if we saw a high-risk item recently, keep it hot for 5 minutes
  if (feed.useLive && Date.now() - lastHighAt < 5*60_000) base = Math.min(base, 25_000);

  const jitter = Math.floor(Math.random() * 60_000) - 30_000;
  const ms = Math.max(60_000, base + jitter);

  clearTimeout(cardEl.__nextTimer);
  cardEl.__nextTimer = setTimeout(()=>{
    const fresh = loadFeeds().find(f => f.id === feed.id);
    if (fresh) refreshSingleFeedCard(cardEl, fresh);
  }, ms);

	  // keep global strip in sync with latest per-feed data
  recomputeGlobalStrip();

}



// -------------------- FEED MODAL LOGIC --------------------
const overlayEl = document.getElementById('modalOverlay');
const cityInput = document.getElementById('feedCityInput');
const riskSel   = document.getElementById('feedRiskSelect');
const kwInput = document.getElementById('feedKeywordsInput');
const liveCheck = document.getElementById('feedLiveCheck');	
const cancelBtn = document.getElementById('modalCancel');
const saveBtn   = document.getElementById('modalSave');
const addFeedBtn= document.getElementById('btnAddFeed');

let editingFeedId = null;

function openFeedModal(feed){
  editingFeedId = feed ? feed.id : null;
  overlayEl.style.display='flex';

  if(feed){
    cityInput.value = (feed.places||[]).join(', ');
    // reset all first
    for (let i=0;i<riskSel.options.length;i++){
      riskSel.options[i].selected = false;
    }
    (feed.risks||[]).forEach(r=>{
      for (let i=0;i<riskSel.options.length;i++){
        if(riskSel.options[i].value===r){
          riskSel.options[i].selected = true;
        }
      }
    });

liveCheck.checked = !!feed.useLive;
kwInput.value = (feed.keywords || []).join(', ');	  
  } 
  
  else {
    cityInput.value = '';
    for (let i=0;i<riskSel.options.length;i++){
      riskSel.options[i].selected = false;
    }
    // default select high+med
  for (let i = 0; i < riskSel.options.length; i++) {
    if (riskSel.options[i].value === 'high') {
      riskSel.options[i].selected = true;
      break;
    }
  }
  liveCheck.checked = false;
  kwInput.value = '';
}
}

function closeFeedModal(){
  overlayEl.style.display='none';
  editingFeedId = null;
}

cancelBtn.addEventListener('click', closeFeedModal);
overlayEl.addEventListener('click',(e)=>{
  if(e.target===overlayEl){
    closeFeedModal();
  }
});
addFeedBtn.addEventListener('click', ()=>openFeedModal(null));


// allow the map legend's "+ Add feed" button to open the same modal
window.ciOpenAddFeed = function(){
  const btn = document.getElementById('btnAddFeed');
  if (btn) btn.click();
  const grid = document.getElementById('feedsGrid');
  if (grid) {
    grid.scrollIntoView({ behavior:'smooth', block:'start' });
  }
};

	
saveBtn.addEventListener('click', ()=>{
  const rawCities = cityInput.value.trim();
  const rawKeywords = kwInput.value.trim();

  // NEW: allow either cities or keywords
  if (!rawCities && !rawKeywords) {
    alert('Enter at least one city/region OR at least one keyword.');
    return;
  }
	
  let places = rawCities ? rawCities.split(',').map(s=>s.trim()).filter(Boolean) : [];

// Expand region shortcuts
const EXPANSIONS = {
  uk: [
    'London','Manchester','Birmingham','Leeds','Liverpool',
'Bristol','Glasgow','Edinburgh','Cardiff','Belfast',
'Nottingham','Sheffield','Newcastle','Leicester','Portsmouth',
'Southampton','Coventry','Bradford','Derby','Stoke-on-Trent',
'Sunderland','Wolverhampton','Hull','Plymouth','Brighton',
'Cambridge','cambridgeshire','Oxford','Exeter','Norwich','York',
'Preston','Canterbury','Lancaster','Chester','Milton Keynes',
'Swansea','Aberdeen','Dundee','Inverness','Newport',
'Luton','Reading','Watford','Blackpool','Middlesbrough',
'Bolton','Warrington','Huddersfield','Peterborough','Northampton',
'Chelmsford','Colchester','Ipswich','Slough','Basildon',
'Woking','Crawley','Bournemouth','Poole','Bath',
'Gloucester','Hereford','Carlisle','Wakefield','Telford',
'Doncaster','Rotherham','Barnsley','Oldham','Wigan',
'Burnley','Blackburn','Stockport','Swindon','Hastings'
  ]
};

if (places.length) {
    places = places.flatMap(p => EXPANSIONS[p.toLowerCase()] || [p]);
  }


  // keywords
  const keywords = rawKeywords
    ? rawKeywords.split(',').map(s=>s.trim()).filter(Boolean)
    : [];
	
	
  const risks = [];
  for (let i=0;i<riskSel.options.length;i++){
    if(riskSel.options[i].selected){
      risks.push(riskSel.options[i].value);
    }
  }
  if(!risks.length){
    alert('Please pick at least one risk level.');
    return;
  }

	
  const feeds = loadFeeds();
  const liveMode = !!liveCheck.checked;
	
  if(editingFeedId){
    // update existing
    const idx = feeds.findIndex(f=>f.id===editingFeedId);
    if(idx>=0){
      feeds[idx].places = places;
      feeds[idx].risks  = risks;
	  feeds[idx].useLive = liveMode;
	  feeds[idx].keywords = keywords;
    }
    saveFeeds(feeds);
  } else {
    // create new
    const id = 'feed-' + Date.now().toString(36);
    feeds.push({ id, places, risks, useLive: liveMode, keywords });
  }
  saveFeeds(feeds);
  closeFeedModal();
  renderFeeds();
});
	

	
// -------------------- CARD RENDER --------------------
async function renderFeeds(){
  const grid = document.getElementById('feedsGrid');

  // use let (we mutate this below)
  let feeds = loadFeeds();
  if (!Array.isArray(feeds)) feeds = [];

// Auto-seed several useful starters if none exist
if (feeds.length === 0){
  const starters = [
    { id: 'seed-global', title: 'Global (live)', places: ['global'],  risks: ['high','med'], useLive: true  },
    { id: 'seed-eu',     title: 'Europe (live)', places: ['eu'],      risks: ['high','med'], useLive: true  },
    { id: 'seed-uk',     title: 'UK (live)',     places: ['uk'],      risks: ['high','med'], useLive: true  },
    { id: 'seed-usa',    title: 'US (live)',     places: ['us'],      risks: ['high','med'], useLive: true  },
  ];

  // persist (title is only for display ‚Äì we derive label from places below)
  saveFeeds(starters.map(s => ({
    id: s.id, places: s.places, risks: s.risks, useLive: s.useLive,
    // keywords left empty by default
  })));

  feeds = loadFeeds();
}



  grid.innerHTML = '';

  for (const feed of feeds){
    const risksLabel  = (feed.risks||[]).join(', ');

    const card = document.createElement('section');
    card.className = 'feed-card';
    card.dataset.id = feed.id;


const keywordsLine = renderKeywordsLine(feed.keywords || []);
const prettyName =
  (feed.id && feed.id.startsWith('seed-')) ? (
    feed.id==='seed-global' ? 'Global (live)' :
    feed.id==='seed-eu'     ? 'Europe (live)' :
    feed.id==='seed-uk'     ? 'UK (live)' :
    feed.id==='seed-usa'    ? 'US (live)' :
    null
  ) : null;

const citiesLabel = prettyName ?? (feed.places || []).join(', ');  
	  
       card.innerHTML = `
      <div class="feed-head">
        <div class="feed-head-left">
          <div class="feed-city">${citiesLabel}</div>
          <div style="margin-top:4px;font-size:12px;color:${feed.risks.includes('high')?'#ff5a5f':feed.risks.includes('med')?'#f0b429':'#33c48d'};">
            Watching: ${risksLabel}
          </div>
          <div id="feedMeta-${feed.id}" class="feed-head-meta">
            <!-- stats injected by JS -->
          </div>
          ${keywordsLine}
        </div>
        <div class="feed-head-right">
          ${feed.useLive ? `<div class="live-pill"><span class="live-dot"></span><span>LIVE</span></div>` : ``}
          <div style="display:flex;gap:6px;">
            <button class="btn-ghost btn-edit-feed" data-feedid="${feed.id}">Edit</button>
            <button class="btn-ghost btn-del-feed" data-feedid="${feed.id}" style="color:#ff5a5f;border-color:#ff5a5f;">‚úï</button>
          </div>
        </div>
      </div>

      <div class="feed-body"></div>

      <div class="feed-footer">
        <div class="src">
          ${feed.useLive ? 'source: live stream' : 'source: simulated source'}
        </div>
        <div style="display:flex;gap:10px;align-items:center;">
          <div class="refresh" data-feedid="${feed.id}">‚Üª refresh</div>
          <button class="btn-ghost btn-earlier" data-feedid="${feed.id}" type="button">
            Load earlier‚Ä¶
          </button>
        </div>
      </div>
    `;



    // refresh link
    card.querySelector('.refresh').addEventListener('click', ()=>{
      const fresh = loadFeeds().find(f=>f.id===feed.id) || feed;
      refreshSingleFeedCard(card, fresh);
    });

    // edit feed (fixed the missing dot before addEventListener)
    card.querySelector('.btn-edit-feed').addEventListener('click', ()=>{
      openFeedModal(feed);
    });

	  // optional: click the topics line to edit
const kwEl = card.querySelector('.feed-kw');
if (kwEl) kwEl.addEventListener('click', () => openFeedModal(feed));


        // delete feed
    card.querySelector('.btn-del-feed').addEventListener('click', ()=>{
      if (!confirm('Remove this feed?')) return;
      const updated = loadFeeds().filter(f => f.id !== feed.id);
      saveFeeds(updated);
      renderFeeds();
    });

    // "Load earlier" button ‚Äì step through 12h ‚Üí 24h ‚Üí 48h ‚Üí 72h for this feed
    const earlierBtn = card.querySelector('.btn-earlier');
    if (earlierBtn) {
      earlierBtn.addEventListener('click', async () => {
        const step = card.__historyStep || 0;
        if (step >= HISTORY_WINDOWS.length) {
          alert('No more earlier history available (up to last 72h).');
          return;
        }
        const hours = HISTORY_WINDOWS[step];
        card.__historyStep = step + 1;  // next click will go further back

        const params = new URLSearchParams();
        if (feed.places?.length)   params.set('cities',   feed.places.join(','));
        if (feed.risks?.length)    params.set('risk',     feed.risks.join(','));
        if (feed.keywords?.length) params.set('keywords', feed.keywords.join(','));
        params.set('provider', 'newsdata');
        params.set('window', String(Math.min(72, hours)));

        const base = 'https://api.cityintelapi.com';
        const url  = base + '/api/live-news?' + params.toString();

        try {
          const res  = await fetch(url, { headers: { 'Accept': 'application/json' } });
          const data = await res.json().catch(() => ({}));
          const events = Array.isArray(data.events) ? data.events : [];

          // merge into archive and then render full archive timeline
          archiveMerge(feed.id, events);
          const merged = loadArchive(feed.id);
          renderEventsIntoCard(card, merged, feed);
        } catch (e) {
          console.error('load earlier failed', e);
        }
      });
    }

    grid.appendChild(card);

	  window.ciScrollToFeed = function(feedId){
  const card = document.querySelector(`.feed-card[data-id="${feedId}"]`);
  if (!card) return;

  card.scrollIntoView({ behavior: 'smooth', block: 'start' });
  card.classList.add('feed-card-pulse');
  setTimeout(() => card.classList.remove('feed-card-pulse'), 1400);
};



// 1) try UI cache (prettier, per-feed)
const uiEvents = loadUiCache(feed.id);
if (uiEvents && uiEvents.length) {
  renderEventsIntoCard(card, uiEvents, feed);
} else {
  // 2) fallback to your existing 15min cache
  const cached = loadFeedEvents(feed.id);
  if (cached && cached.events) {
    renderEventsIntoCard(card, cached.events, feed);
  }
}

  if (window.ciRefreshMapSidebarFeeds) {
    window.ciRefreshMapSidebarFeeds();
  }


	  
// 3) always go fetch fresh + schedule
refreshSingleFeedCard(card, feed);
	    // after all cards are created / refreshed
  recomputeGlobalStrip();
}

  // after all feeds rendered, nudge sidebar once more
  if (typeof window.ciUpdateMapSidebar === 'function') {
    window.ciUpdateMapSidebar(window.ciFeedSummaries || {});
  }
	
}


// -------------------- INIT --------------------
renderFeeds();

// ---- link View Full Incident to incident.html ----
viewFullBtn.addEventListener('click', (e)=>{
  e.preventDefault();
  // Build a minimal object to pass along
  const incidentData = {
    title: detailTitleEl.textContent,
    meta: detailMetaEl.textContent,
    summary: detailSummaryEl.textContent,
    location: detailLocationEl.textContent,
    impact: detailImpactEl.textContent,
    earlier: detailEarlierEl.textContent,
    url: window.__lastDetailItem?.url || null,
    src: window.__lastDetailItem?.src || null,
    description: window.__lastDetailItem?.description || null,
    when: window.__lastDetailItem?.when || null,
    city: window.__lastDetailItem?.city || null,
    risk: window.__lastDetailItem?.risk || null,
	lat: window.__lastDetailItem?.lat ?? null,
    lon: window.__lastDetailItem?.lon ?? null  
  };

  // Generate a temp ID (could use timestamp)
  const incId = 'inc-' + Date.now().toString(36);

  // Persist in sessionStorage
  const all = JSON.parse(sessionStorage.getItem('ci_incidents') || '{}');
  all[incId] = incidentData;
  sessionStorage.setItem('ci_incidents', JSON.stringify(all));

  // Redirect with ?id=
  location.href = 'incident.html?id=' + encodeURIComponent(incId);
});

	
</script>


<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin="anonymous"></script>
<script src="https://unpkg.com/topojson-client@3"></script>


	
<script>
(function(){
  const el = document.getElementById('liveRiskMap');
  if (!el || typeof L === 'undefined') return;

window.ciIncidentRadiusKm = window.ciIncidentRadiusKm || 5;
 window.ciLastIncident = window.ciLastIncident || null;
	
  const LOOKBACK_DAYS = 180;
  const palette = {
    low:   '#6bcf6b',
    medium:'#f0b429',
    high:  '#ff5a5f',
    none:  '#2e3238'
  };

  const alias = new Map([
    ['england','united kingdom'],
    ['scotland','united kingdom'],
    ['wales','united kingdom'],
    ['czech republic','czechia'],
    ['vatican city','holy see']
  ]);
  const norm = s => (s || '').toString().trim().toLowerCase();

  function loadMiniFeeds(){
    try {
      const raw = localStorage.getItem('ci_live_feeds_v1');
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    } catch (e) {
      return [];
    }
  }


	
  // ---- Map init ----
  const WORLD_BOUNDS = L.latLngBounds(
    [-60, -180],
    [ 75,  180]
  );

  // IMPORTANT: use the name "map" everywhere
  const map = L.map('liveRiskMap', {
    scrollWheelZoom: true,
    worldCopyJump: false,
    maxBounds: WORLD_BOUNDS,
    maxBoundsViscosity: 1.0,
    minZoom: 2,
	zoomControl: false 
  });

  L.control.zoom({ position: 'topright' }).addTo(map);
	
  map.fitBounds(WORLD_BOUNDS);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap',
    noWrap: true
  }).addTo(map);


	
   // keep track of current incident highlight on the map
  let incidentRadiusLayer = null;


  // ---- Risk aggregation from alertsData (last 6 months) ----
  function aggregateRisk(){
    const alerts = Array.isArray(window.alertsData) ? window.alertsData : [];
    const now = Date.now();
    const cutoff = now - LOOKBACK_DAYS * 864e5;
    const by = {};

    alerts.forEach(a => {
      if (!a || !a.Country || !a.time) return;
      const t = new Date(a.time);
      const ms = t.getTime();
      if (!ms || ms < cutoff || ms > now) return;

      let c = a.Country;
      const aliased = alias.get(norm(c));
      if (aliased) c = aliased;

      const rRaw = (a.risk || '').toString().toLowerCase();
      const r = rRaw.startsWith('hi') ? 'high'
              : rRaw.startsWith('me') ? 'medium'
              : 'low';

      if (!by[c]) by[c] = { low:0, medium:0, high:0 };
      by[c][r]++;
    });

    const result = {};
    Object.keys(by).forEach(name => {
      const row = by[name];
      const total = row.low + row.medium + row.high;
      if (!total) return;

      const shareHigh = row.high / total;
      const shareMed  = row.medium / total;

      let level = 'low';
      if (shareHigh >= 0.4 || row.high >= 3) {
        level = 'high';
      } else if (shareMed >= 0.3 || row.medium >= 2 || row.high > 0) {
        level = 'medium';
      }

      result[name] = { level, counts: row, total };
    });
    return result;
  }

  // ---- Draw country risk shading ----
  let countryLayer = null;

  function drawRisk(){
    const agg = aggregateRisk();
    if (!agg) return;

    fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json')
      .then(r => r.json())
      .then(topology => {
        const geo = topojson.feature(topology, topology.objects.countries);
        geo.features.forEach(f => {
          f.properties.ADMIN = f.properties.name || f.properties.NAME || '';
        });

        if (countryLayer) countryLayer.remove();

        countryLayer = L.geoJSON(geo, {
          style: f => {
            const name = (f.properties.ADMIN || '').trim();
            const row = agg[name];
            if (!row) {
              return {
                fillColor: palette.none,
                fillOpacity: 0.18,
                color: '#111',
                weight: 0.4
              };
            }
            const col = palette[row.level] || palette.low;
            return {
              fillColor: col,
              fillOpacity: 0.85,
              color: '#111',
              weight: 0.6
            };
          },
          onEachFeature: (f, layer) => {
            const name = (f.properties.ADMIN || '').trim();
            const row = agg[name];
            if (!row) {
              layer.bindPopup(
                `<b>${name}</b><br>No incidents in last ${LOOKBACK_DAYS} days.`
              );
            } else {
              const c = row.counts;
              layer.bindPopup(
                `<b>${name}</b><br>${row.total} incident(s) in last ${LOOKBACK_DAYS} days<br>
                 <span style="color:${palette.high}">High: ${c.high}</span> ¬∑
                 <span style="color:${palette.medium}">Med: ${c.medium}</span> ¬∑
                 <span style="color:${palette.low}">Low: ${c.low}</span>`
              );
            }
          }
        }).addTo(map);
      });
  }

  // ---- Assets & travellers markers ----
  const assetLayer = L.layerGroup().addTo(map);
  const travLayer  = L.layerGroup().addTo(map);

  const assetIcon = L.divIcon({
    className: 'ci-asset-marker',
    html: 'A',
    iconSize: [18, 18]
  });
  const travIcon  = L.divIcon({
    className: 'ci-trav-marker',
    html: 'T',
    iconSize: [18, 18]
  });

  function refreshPresenceMarkers(){
    assetLayer.clearLayers();
    travLayer.clearLayers();

    (window.CIAssets || []).forEach(a => {
      if (typeof a.lat !== 'number' || typeof a.lon !== 'number') return;
      L.marker([a.lat, a.lon], { icon: assetIcon })
        .addTo(assetLayer)
        .bindPopup(
          `<b>${a.name || 'Asset'}</b><br>` +
          `${[a.city, a.country].filter(Boolean).join(', ')}`
        );
    });

    (window.CITravellers || []).forEach(t => {
      if (typeof t.lat !== 'number' || typeof t.lon !== 'number') return;
      L.marker([t.lat, t.lon], { icon: travIcon })
        .addTo(travLayer)
        .bindPopup(
          `<b>${t.name || 'Traveller'}</b><br>` +
          `${t.role || ''}${t.hotel ? ' ‚Äî ' + t.hotel : ''}`
        );
    });
  }

	
  // ---- React when an incident is opened (jump to city) ----
    function pulseAt(lat, lon, label){
    // centre on the incident
    map.setView([lat, lon], 7);

    // clear previous highlight if any
    if (incidentRadiusLayer) {
      map.removeLayer(incidentRadiusLayer);
      incidentRadiusLayer = null;
    }



		
    // 1) radius circle (e.g. 15km)
    const radiusKm = window.ciIncidentRadiusKm || 5;
    const radiusCircle = L.circle([lat, lon], {
      radius: radiusKm * 1000,           // metres
      color: '#ff4d4d',
      weight: 1.5,
      opacity: 0.9,
      dashArray: '4 4',
      fillColor: '#ff4d4d',
      fillOpacity: 0.15
    });

    // 2) central dot (your existing pulse marker)
    const centreDot = L.circleMarker([lat, lon], {
      radius: 6,
      color: '#ff4d4d',
      weight: 2,
      fillColor: '#ff4d4d',
      fillOpacity: 0.9
    });

    // group them so we can remove in one go
    incidentRadiusLayer = L.layerGroup([radiusCircle, centreDot]).addTo(map);

    if (label) {
      centreDot.bindPopup(label).openPopup();
    }

    // optional: fade out after 300s
    setTimeout(() => {
      if (incidentRadiusLayer) {
        map.removeLayer(incidentRadiusLayer);
        incidentRadiusLayer = null;
      }
    }, 30_0000);
  }


  window.addEventListener('ci:jumpToIncident', e => {
    const d = e.detail || {};
    const lat = typeof d.lat === 'number' ? d.lat : null;
    const lon = typeof d.lon === 'number' ? d.lon : null;

    if (lat != null && lon != null) {
       window.ciLastIncident = { lat, lon, label: 'Current incident' };
		pulseAt(lat, lon, 'Current incident');
      return;
    }

    const city    = (d.city || '').toString().trim().toLowerCase();
    const country = (d.country || '').toString().trim().toLowerCase();
    const pts = [];

    (window.CIAssets || []).forEach(a => {
      if (typeof a.lat !== 'number' || typeof a.lon !== 'number') return;
      if (city && (a.city || '').toLowerCase() !== city) return;
      if (country && (a.country || '').toLowerCase() !== country) return;
      pts.push([a.lat, a.lon]);
    });

    (window.CITravellers || []).forEach(t => {
      if (typeof t.lat !== 'number' || typeof t.lon !== 'number') return;
      if (city && (t.city || '').toLowerCase() !== city) return;
      if (country && (t.country || '').toLowerCase() !== country) return;
      pts.push([t.lat, t.lon]);
    });

    if (pts.length) {
      const avgLat = pts.reduce((s,p)=>s+p[0],0)/pts.length;
      const avgLon = pts.reduce((s,p)=>s+p[1],0)/pts.length;
      window.ciLastIncident = {
        lat: avgLat,
        lon: avgLon,
        label: 'Incident city (assets/travellers nearby)'
      };
      pulseAt(avgLat, avgLon, 'Incident city (assets/travellers nearby)');
    }
  });



  function renderSidebarFeeds(){
    const listEl = document.getElementById('liveMapFeedsList');
    if (!listEl) return;

    const feeds = loadMiniFeeds();
    if (!feeds.length){
      listEl.innerHTML =
        '<div style="font-size:11px;opacity:.7;">No feeds yet. Use ‚Äú+ Add feed‚Äù.</div>';
      return;
    }

    listEl.innerHTML = '';
    feeds.slice(0, 6).forEach(feed => {
      const label =
        (feed.places && feed.places.length)
          ? feed.places.join(', ')
          : (feed.keywords && feed.keywords.length
              ? feed.keywords.join(', ')
              : 'Custom feed');

      const btn = document.createElement('button');
      btn.className = 'live-map-feed-btn';
      btn.textContent = label;
	  btn.dataset.feedid = feed.id;
      btn.addEventListener('click', (e) => {
  e.preventDefault();
  e.stopPropagation();

  // NEW: open the "Latest incidents" panel if it exists
  if (typeof window.ciOpenMapFeedAlerts === 'function') {
    window.ciOpenMapFeedAlerts(feed.id, label);
    return;
  }

  // fallback: old behaviour
  if (window.ciScrollToFeed) window.ciScrollToFeed(feed.id);
});

      listEl.appendChild(btn);
    });
  }

  renderSidebarFeeds();
  // let other scripts refresh it after feeds change
  window.ciRefreshMapSidebarFeeds = renderSidebarFeeds;



  // === SIDEBAR FEED LIST RENDERER =========================
  window.ciUpdateMapSidebar = function(summaryMap){
    const host = document.getElementById('liveMapFeedsList');
    if (!host) return;

    const summaries = Object.values(summaryMap || {});
    host.innerHTML = '';

    if (!summaries.length){
      host.innerHTML = '<div class="live-map-feed-empty">No feeds configured yet.</div>';
      return;
    }

    // sort: highest total first
    summaries.sort((a,b) => (b.total||0) - (a.total||0));

    summaries.forEach(s => {
      const row = document.createElement('div');
      row.className = 'live-map-feed-row';
      row.dataset.feedid = s.id;

      row.innerHTML = `
        <div class="live-map-feed-label">${s.label || 'Feed'}</div>
        <div class="live-map-feed-counts">
          <span><span class="dot dot-high"></span>${s.high || 0}</span>
          <span><span class="dot dot-med"></span>${s.med  || 0}</span>
          <span><span class="dot dot-low"></span>${s.low  || 0}</span>
          <span style="margin-left:auto;opacity:.75;">
            ${s.total || 0} alerts
          </span>
        </div>
      `;

      host.appendChild(row);
    });
  };

  // click in sidebar feed list ‚Üí scroll to that feed card
  document.addEventListener('click', (e) => {
    const row = e.target.closest('.live-map-feed-row');
    if (!row) return;
    const feedId = row.dataset.feedid;
    if (!feedId) return;

    if (typeof window.ciScrollToFeed === 'function') {
      window.ciScrollToFeed(feedId);
    } else {
      // simple fallback: scroll card into view by data-id
      const card = document.querySelector(`.feed-card[data-id="${feedId}"]`);
      if (card) card.scrollIntoView({ behavior:'smooth', block:'start' });
    }
  });

  // "+ Add feed" button in sidebar
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('#liveMapAddFeedBtn');
    if (!btn) return;
    if (typeof window.ciOpenAddFeed === 'function') {
      window.ciOpenAddFeed();
    } else {
      // fallback to main button
      const mainBtn = document.getElementById('btnAddFeed');
      if (mainBtn) mainBtn.click();
    }
  });


	
function redrawIncidentRadius(){
    if (!window.ciLastIncident) return;
    const { lat, lon, label } = window.ciLastIncident;
    if (typeof lat !== 'number' || typeof lon !== 'number') return;
    pulseAt(lat, lon, label || 'Current incident');
  }

	
  // optional export so the radius pills can trigger a redraw
  window.ciRedrawIncidentRadius = redrawIncidentRadius;
	

	

// ===== Map sidebar: switch between Feeds panel and Alerts panel =====
(function setupMapSidebarAlerts(){
  const feedsPanel  = document.getElementById('mapFeedsPanel');
  const alertsPanel = document.getElementById('mapAlertsPanel');
  const alertsTitle = document.getElementById('mapAlertsTitle');
  const alertsList  = document.getElementById('mapAlertsList');
  const backBtn     = document.getElementById('mapAlertsBackBtn');

  if (!feedsPanel || !alertsPanel || !alertsTitle || !alertsList || !backBtn) return;

  function showFeeds(){
    alertsPanel.style.display = 'none';
    feedsPanel.style.display  = 'block';
    alertsList.innerHTML = '';
  }

  function showAlerts(){
    feedsPanel.style.display  = 'none';
    alertsPanel.style.display = 'block';
  }

  backBtn.addEventListener('click', showFeeds);

  function riskPill(risk){
    const r = (risk || '').toLowerCase();
    if (r === 'high') return `<span class="map-risk-pill map-risk-high">HIGH</span>`;
    if (r === 'med' || r === 'medium') return `<span class="map-risk-pill map-risk-med">MED</span>`;
    return `<span class="map-risk-pill map-risk-low">LOW</span>`;
  }

  function safe(s){
    return String(s || '').replace(/[&<>"']/g, m =>
      ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function fmt(iso){
    try{
      return new Date(iso).toLocaleString('en-GB', {
        timeZone:'Europe/London',
        day:'2-digit', month:'short',
        hour:'2-digit', minute:'2-digit',
        hour12:false
      }).replace(',', '');
    } catch { return iso || ''; }
  }

  // Pull events for a feed from your existing caches (archive > ui cache > 15min cache)
  function getFeedEvents(feedId){
    // These helpers exist in your main script scope (not inside this IIFE),
    // so we access them via window if needed.
    const loadArchive   = window.loadArchive   || (typeof loadArchive === 'function' ? loadArchive : null);
    const loadUiCache   = window.loadUiCache   || (typeof loadUiCache === 'function' ? loadUiCache : null);
    const loadFeedEvents= window.loadFeedEvents|| (typeof loadFeedEvents === 'function' ? loadFeedEvents : null);

    if (loadArchive){
      const a = loadArchive(feedId);
      if (Array.isArray(a) && a.length) return a;
    }
    if (loadUiCache){
      const u = loadUiCache(feedId);
      if (Array.isArray(u) && u.length) return u;
    }
    if (loadFeedEvents){
      const c = loadFeedEvents(feedId);
      if (c && Array.isArray(c.events) && c.events.length) return c.events;
    }
    return [];
  }

  // Render alerts list for a feed
  function openFeedAlerts(feedId, label){
    const events = getFeedEvents(feedId)
      .slice()
      .sort((a,b) => (Date.parse(b.when)||0) - (Date.parse(a.when)||0))
      .slice(0, 10);

    alertsTitle.textContent = label ? `Latest incidents ‚Äî ${label}` : 'Latest incidents';
    alertsList.innerHTML = '';

    if (!events.length){
      alertsList.innerHTML = `<div class="map-alert-empty">No cached alerts yet ‚Äî give it a refresh.</div>`;
      showAlerts();
      return;
    }

    events.forEach(ev => {
      const title = ev.title || ev.summary || ev.description || '(no title)';
      const city  = ev.city || 'Unknown';
      const when  = ev.when ? fmt(ev.when) : '';

      const row = document.createElement('div');
      row.className = 'map-alert-item';
      row.innerHTML = `
        <div class="map-alert-top">
          <div class="map-alert-title">${safe(title)}</div>
          <div class="map-alert-when">${safe(when)}</div>
        </div>
        <div class="map-alert-meta">
          ${riskPill(ev.risk)}
          <span style="opacity:.85;">${safe(city)}</span>
        </div>
      `;

      row.addEventListener('click', () => {
        // Scroll to feed card
        if (typeof window.ciScrollToFeed === 'function') {
          window.ciScrollToFeed(feedId);
        }

        // Open the detail panel with this incident
        if (typeof window.openDetailPanel === 'function') {
          window.openDetailPanel(ev, events);
        } else if (typeof openDetailPanel === 'function') {
          openDetailPanel(ev, events);
        }
      });

      alertsList.appendChild(row);
    });

    showAlerts();
  }

  // Intercept clicks on the feeds list to open alerts panel
  document.addEventListener('click', (e) => {
    // Works for both:
    // 1) the detailed summary rows (.live-map-feed-row)
    // 2) the simple buttons (.live-map-feed-btn)
    const row = e.target.closest('.live-map-feed-row');
    const btn = e.target.closest('.live-map-feed-btn');

    if (!row && !btn) return;

    const feedId = (row && row.dataset.feedid) || (btn && btn.dataset.feedid);
    if (!feedId) return;

    // Determine label
    let label = '';
    if (row){
      const l = row.querySelector('.live-map-feed-label');
      label = l ? l.textContent.trim() : '';
    } else if (btn){
      label = btn.textContent.trim();
    }

    openFeedAlerts(feedId, label);
  });

window.ciOpenMapFeedAlerts = openFeedAlerts;

	
  // default view
  showFeeds();
})();



	
	
  // initial draw
  drawRisk();
  refreshPresenceMarkers();

	
  // refresh markers if assets/travellers change in another tab
  window.addEventListener('storage', e => {
    if (e.key === 'ci_assets' || e.key === 'ci_travellers') {
      setTimeout(() => {
        try{
          const a = JSON.parse(localStorage.getItem('ci_assets') || '[]');
          const t = JSON.parse(localStorage.getItem('ci_travellers') || '[]');
          if (Array.isArray(a)) window.CIAssets = a;
          if (Array.isArray(t)) window.CITravellers = t;
        } catch {}
        refreshPresenceMarkers();
      }, 200);
    }
  });

  // optional export
  window.ciLiveMap = map;
  window.liveMap   = map;
})();


	
// When user clicks a feed name in the map legend, jump to that feed card below
document.addEventListener('click', (e) => {
  const link = e.target.closest('.legend-feed-link');
  if (!link) return;

  const feedId = link.getAttribute('data-feedid');
  if (!feedId) return;

  const card = document.querySelector(`.feed-card[data-id="${feedId}"]`);
  if (!card) return;

  card.scrollIntoView({ behavior: 'smooth', block: 'start' });

  // brief visual pulse so it's obvious which card we jumped to
  card.classList.add('feed-card-pulse');
  setTimeout(() => {
    card.classList.remove('feed-card-pulse');
  }, 1500);
});

	
</script>


<script>
document.addEventListener('DOMContentLoaded', () => {
  const pills = document.querySelectorAll('.radius-pill');
  if (!pills.length) return;

  pills.forEach(btn => {
    btn.addEventListener('click', () => {
      const km = Number(btn.getAttribute('data-radius-km')) || 5;
      window.ciIncidentRadiusKm = km;

      // toggle active state
      pills.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

// NEW: immediately redraw the circle for the last incident
      if (window.ciRedrawIncidentRadius) {
        window.ciRedrawIncidentRadius();
		}
    });
  });
});
</script>




	
	
<!-- auth helpers / admin links -->

<script src="admin-links.js"></script>

</body>
</html>
