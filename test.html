

<!doctype html>
<html lang="en">
<head>

  <script src="auth.js"></script>


<script>
(function pageGuard(){
  const NEED_LOGIN = true;          // this page requires a login
  const NEED_SUB = false;           // set to true on pages that require an active sub

  // Must be logged in?
  if (NEED_LOGIN && (!window.CIAuth || !CIAuth.isLoggedIn())) {
    const here = location.pathname.split('/').pop() || 'index.html';
    const next = encodeURIComponent(here + location.search + location.hash);
    location.href = 'login.html?next=' + next;
    return;
  }

  // Must be subscribed?
  if (NEED_SUB) {
    const isSub = localStorage.getItem('ci_subscribed') === 'true';
    if (!isSub) {
      location.href = 'subscribe.html';
      return;
    }
  }
})();
</script>

<script>
(function compatProfileShim(){
  if (!window.CIAuth || !CIAuth.isLoggedIn()) return;
  const u = CIAuth.who();
  if (!u) return;
  localStorage.setItem('ci_profile', JSON.stringify({
    name: u.name || 'CityIntel User',
    email: u.email,
    role: u.role || 'Admin',
    is_admin: (u.role||'').toLowerCase()==='admin'
  }));
  // Do NOT auto-set ci_subscribed here anymore
})();
</script>


  
  <meta charset="utf-8" />
  <title>CityIntel ‚Äî Live Feed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <style>
      :root{--brand-red:#D01616;--gray-900:#111214;--gray-800:#16171a;--gray-700:#1c1e22;--gray-600:#24272c;--gray-500:#2e3238;--text:#e9edf2}
      body{margin:0;font:14px/1.5 system-ui;background:linear-gradient(180deg,var(--gray-900),var(--gray-800));color:var(--text)}

     .app{display:grid;grid-template-columns:260px 1fr;grid-template-rows:60px 1fr;grid-template-areas:"sidebar topbar" "sidebar main";min-height:100vh}
    .sidebar{grid-area:sidebar;background:#0c0c0c;border-right:1px solid var(--gray-600);display:flex;flex-direction:column;padding:18px 14px;gap:18px}
      nav a{display:flex;align-items:center;padding:10px 12px;border-radius:10px;text-decoration:none;color:var(--text);border:1px solid transparent}
      nav a:hover{background:var(--gray-600);border-color:var(--gray-500)}
      nav a.active{background:rgba(208,22,22,0.15);border-color:var(--brand-red)}

    .topbar{ grid-area: topbar;background: rgba(255,255,255,0.02);border-bottom:1px solid var(--brand-gray-600);display:flex; align-items:center; gap:12px;
     padding:10px 16px;position:sticky; top:0; z-index:10;backdrop-filter: blur(8px);}

#topActions{margin-left:auto;display:flex; align-items:center; gap:10px;min-width: fit-content;position: relative;}
    
    .user{ display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;
  background:#1c1e22;border:1px solid #24272c;cursor:pointer;
}
    .avatar{ width:28px;height:28px;background:#fff;color:#000;border-radius:50%;
  display:grid;place-items:center;font-weight:700;
}
    .dropdown{ position:absolute;right:0;top:calc(100% + 6px);background:#1a1c20;border:1px solid #24272c;
  border-radius:10px;padding:6px 0;box-shadow:0 4px 12px rgba(0,0,0,.4);display:none;min-width:140px;z-index:50;
}
    .dropdown a{display:block;padding:8px 12px;color:#e9edf2;text-decoration:none;font-size:14px}
    .dropdown a:hover{background:rgba(255,255,255,0.05)}

  .brandbar{display:flex;align-items:center;gap:10px;padding:16px 20px;border-bottom:1px solid var(--line);
    background:linear-gradient(90deg,rgba(208,22,22,.2),rgba(208,22,22,0))}
  .brandbar img{width:auto;height:60px;object-fit:contain;border-radius:6px;background:#fff}



    #trial-banner{
      flex:1;
      text-align:center;
      font-size:12px;
      font-weight:600;
      color:#fecaca;
    }


    .logout-link{
      color:#8e97a3;
      font-size:12px;
    }

    .main{
      grid-area:main;
      padding:18px;
    }

    .page-head{
      display:flex;
      align-items:flex-start;
      flex-wrap:wrap;
      gap:12px;
      margin-bottom:16px;
    }
    .page-head-left h2{
      margin:0;
      font-size:16px;
      font-weight:600;
      color:var(--text);
    }
    .page-head-left .sub{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }
    .page-head-right{
      margin-left:auto;
      display:flex;
      flex-direction:column;
      align-items:center;
      min-width:160px;
      gap:8px;
    }

    .btn-red{
      background:#D01616;
      color:#fff;
      font-size:13px;
      font-weight:600;
      border:1px solid #D01616;
      border-radius:10px;
      padding:8px 12px;
      cursor:pointer;
      line-height:1.2;
      text-align:center;
      min-width:140px;
    }
    .btn-red:hover{
      background:#ff2a2a;
      border-color:#ff2a2a;
    }

    .feeds-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(min(360px,100%),1fr));
      gap:16px;
    }

    .feed-card{
      background:linear-gradient(180deg,#1a1c20,#131417);
      border:1px solid var(--g600);
      border-radius:16px;
      display:flex;
      flex-direction:column;
      min-height:260px;
      max-height:400px;
    }

    .feed-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      border-bottom:1px solid var(--g600);
      padding:12px 16px;
    }
    .feed-head-left{
      font-size:13px;
      color:var(--text);
      line-height:1.4;
    }
    .feed-city{
      font-weight:600;
      font-size:14px;
      color:#fff;
    }
    .feed-risk{
      display:inline-block;
      font-size:11px;
      line-height:1.2;
      font-weight:600;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.15);
    }
    .feed-risk.high{
      background:rgba(255,90,95,.12);
      border-color:rgba(255,90,95,.35);
      color:#ff5a5f;
    }
    .feed-risk.med{
      background:rgba(240,180,41,.12);
      border-color:rgba(240,180,41,.35);
      color:#f0b429;
    }
    .feed-risk.low{
      background:rgba(51,196,141,.12);
      border-color:rgba(51,196,141,.35);
      color:#33c48d;
    }
    .feed-head-right{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:4px;
    }

	.feed-kw{
     margin-top:4px;
     font-size:12px;
     color:var(--muted);
     white-space:nowrap;
     overflow:hidden;
     text-overflow:ellipsis;
     max-width: 100%;
    }

.kw-chip{
  display:inline-block;
  padding:2px 6px;
  border:1px solid var(--g600);
  border-radius:999px;
  font-size:11px;
  color:#cfd6df;
  background:#1f2024;
  margin-right:6px;
}
.kw-more{
  font-size:11px;
  opacity:.8;
}
	  
 
	  
/* LIVE badge in feed header */
    .live-pill {
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:rgba(208,22,22,0.15);
      border:1px solid #D01616;
      color:#ff4d4d;
      font-size:11px;
      font-weight:600;
      line-height:1.2;
      padding:3px 8px;
      border-radius:999px;
    }
    .live-dot {
      width:6px;
      height:6px;
      border-radius:50%;
      background:#ff4d4d;
      box-shadow:0 0 6px #ff4d4d,0 0 10px #ff4d4d;
    }

    /* checkbox row in modal */
    .modal-row-inline {
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
      margin-bottom:12px;
    }
    .modal-row-inline input[type="checkbox"] {
      margin-top:2px;
      accent-color:#D01616; /* modern browsers */
    }
    .modal-row-inline .live-row-text {
      color:#fff;
      font-size:13px;
      line-height:1.4;
    }
    .modal-row-inline .live-row-hint {
      font-size:11px;
      color:var(--muted);
      line-height:1.4;
    }

	  
	  
    .btn-ghost{
      background:#1f2024;
      color:#e9edf2;
      border:1px solid var(--g600);
      border-radius:8px;
      padding:4px 8px;
      font-size:12px;
      line-height:1.2;
      cursor:pointer;
    }
    .btn-ghost:hover{
      background:#2a2d32;
    }

    .feed-body{
      flex:1;
      overflow-y:auto;
      padding:12px 16px 16px;
      font-size:13px;
    }
    .feed-item{
      border-left:4px solid #D01616;
      background:linear-gradient(90deg,rgba(208,22,22,.1),rgba(208,22,22,0));
      border-radius:8px;
      border:1px solid var(--g600);
      padding:10px 12px;
      margin-bottom:10px;
      cursor:pointer;
    }
    .feed-item:last-child{
      margin-bottom:0;
    }
    .feed-title-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:8px;
      font-size:13px;
      font-weight:600;
      color:#fff;
    }
    .feed-meta{
      font-size:11px;
      color:var(--muted);
      line-height:1.4;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }

    .feed-footer{
      border-top:1px solid var(--g600);
      padding:10px 16px;
      font-size:11px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .feed-footer .src{
      color:var(--muted);
    }
    .feed-footer .refresh{
      cursor:pointer;
      color:#8e97a3;
    }
    .feed-footer .refresh:hover{
      color:#fff;
    }

    /* slide-in detail panel */
    .detail-panel{
      position:fixed;
      top:0;
      right:0;
      height:100vh;
      width:360px;
      max-width:80%;
      background:#1a1c20;
      border-left:1px solid var(--g600);
      box-shadow:-20px 0 40px rgba(0,0,0,.8);
      color:#e9edf2;
      font-size:13px;
      line-height:1.5;
      display:flex;
      flex-direction:column;
      transform:translateX(100%);
      transition:transform .25s ease;
      z-index:10000;
    }
    .detail-panel.open{
      transform:translateX(0%);
    }

    .detail-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      padding:16px;
      border-bottom:1px solid var(--g600);
      background:#131417;
    }
    .detail-head-left{
      max-width:260px;
    }
    .detail-title{
      font-size:14px;
      font-weight:600;
      color:#fff;
      margin-bottom:4px;
    }
    .detail-meta{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }
    .detail-close{
      background:none;
      border:0;
      color:#8e97a3;
      font-size:12px;
      cursor:pointer;
      padding:4px 6px;
      border-radius:6px;
    }
    .detail-close:hover{
      color:#fff;
      background:#2a2d32;
    }

    .detail-body{
      flex:1;
      overflow-y:auto;
      padding:16px;
    }
    .detail-section{
      margin-bottom:16px;
      background:linear-gradient(180deg,#1a1c20,#131417);
      border:1px solid var(--g600);
      border-radius:12px;
      padding:12px;
    }
    .detail-section h4{
      margin:0 0 6px;
      font-size:12px;
      font-weight:600;
      color:#fff;
      text-transform:uppercase;
      letter-spacing:.03em;
    }
    .detail-section .small{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }

    .detail-footer{
      border-top:1px solid var(--g600);
      background:#131417;
      padding:12px 16px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .earlier-list {
  margin: 0;
  padding-left: 18px;
  list-style: disc;
  line-height: 1.4;
  gap: 4px;
}
    .earlier-list li {
  margin-bottom: 4px;
}

	  
    .btn-full-incident{
      background:#D01616;
      color:#fff;
      border:1px solid #D01616;
      border-radius:10px;
      padding:10px 12px;
      font-size:13px;
      font-weight:600;
      line-height:1.2;
      text-align:center;
      text-decoration:none;
      cursor:pointer;
    }
    .btn-full-incident:hover{
      background:#ff2a2a;
      border-color:#ff2a2a;
    }

    .btn-back-dash{
      display:inline-block;
      text-decoration:none;
      color:#ff5a5f;
      font-size:12px;
      font-weight:600;
      text-align:center;
    }

    /* Add Feed modal */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:10001;
    }
    .modal-box{
      background:#1a1c20;
      border:1px solid var(--g600);
      border-radius:16px;
      width:420px;
      max-width:90%;
      box-shadow:0 30px 60px rgba(0,0,0,.9);
      padding:16px;
      color:var(--text);
      font-size:13px;
    }
    .modal-box h3{
      margin:0 0 12px;
      font-size:14px;
      font-weight:600;
      color:#fff;
    }
    .modal-row{
      margin-bottom:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .modal-row label{
      font-size:12px;
      color:var(--muted);
    }
    .modal-row input, .modal-row select{
      background:#1f2024;
      border:1px solid var(--g600);
      border-radius:8px;
      color:#fff;
      padding:10px 12px;
      font-size:14px;
      line-height:1.4;
      outline:none;
      width:90%;
    }
    .modal-row input:focus,
    .modal-row select:focus{
      border-color:#D01616;
    }
    .modal-actions{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .btn-cancel{
      background:#1f2024;
      border:1px solid var(--g600);
      border-radius:8px;
      color:#8e97a3;
      font-size:12px;
      line-height:1.2;
      padding:8px 10px;
      cursor:pointer;
      flex:1;
      text-align:center;
    }
    .btn-cancel:hover{
      background:#2a2d32;
      color:#fff;
    }
    .btn-save{
      background:#D01616;
      border:1px solid #D01616;
      border-radius:8px;
      color:#fff;
      font-size:12px;
      font-weight:600;
      line-height:1.2;
      padding:8px 10px;
      cursor:pointer;
      flex:1;
      text-align:center;
    }
    .btn-save:hover{
      background:#ff2a2a;
      border-color:#ff2a2a;
    }

    @media (max-width:900px){
      .app{
        grid-template-columns:1fr;
        grid-template-areas:
          "topbar"
          "main";
      }
      .sidebar{
        display:none;
      }
      .detail-panel{
        width:80%;
        max-width:400px;
      }
    }
  </style>
</head>


  
<script>

	// must be after the header DOM exists
document.addEventListener('DOMContentLoaded', () => {
  const topActions = document.getElementById('topActions');
  if (window.CIAuth && typeof CIAuth.injectUserChip === 'function' && topActions) {
    CIAuth.injectUserChip(topActions);
  }

  const nav = document.querySelector('aside.sidebar nav');
  if (window.CIAuth && typeof CIAuth.updateSidebarForRole === 'function' && nav) {
    CIAuth.updateSidebarForRole(nav);
  }
});
</script>


  
<body>
    
<div class="brandbar">
  <img src="CityintLogo.jpg" alt="CityIntel Logo">
  <div class="title" style="font-weight:700;font-size:18px">CityIntel</div>

  <div id="trial-banner" style="display:none;position:absolute;
       left:50%; transform:translateX(-50%); background:none;
       color:#fecaca; padding:8px 12px; text-align:center;">
    <span id="trial-text">Your trial ends soon.</span>
  </div>

  <!-- keep topActions INSIDE the brandbar -->
  <div id="topActions" style="position:relative;margin-left:auto"></div>
</div>
		

	
  <div class="app">
    <aside class="sidebar">
       <div class="section-label"></div>
      <nav>
        <a href="index.html">Dashboard</a>
        <a href="alerts.html">Alerts</a>
        <a href="events.html">Events</a>
		<a href="live-feed.html">Live Feed</a>
	<a href="brief.html">Intelligence Brief</a>
	<a href="incident.html">Incident Drilldown</a>
	    <a href="reports.html">Reports</a>
	<a href="trends.html">Trends & Forecasts</a>
		<a href="sources.html">Sources</a>
        <a href="settings.html">Settings</a>
        <a href="about.html">About</a>
      </nav>
      <div class="footnote">For information use only ‚Äî not for redistribution</div>
    </aside>


  <!-- MAIN -->
  <main class="main">
    <div class="page-head">
      <div class="page-head-left">
        <h2>Live Feed</h2>
        <div class="sub">Streaming incident chatter for your selected regions.</div>
      </div>

      <div class="page-head-right">
        <!-- centered static red button -->
        <button id="btnAddFeed" class="btn-red" type="button">+ Add Feed</button>
      </div>
    </div>

    <div id="feedsGrid" class="feeds-grid">
      <!-- Cards injected here -->
    </div>
  </main>
</div>

<!-- DETAIL PANEL -->
<aside id="detailPanel" class="detail-panel">
  <div class="detail-head">
    <div class="detail-head-left">
      <div id="detailTitle" class="detail-title">[Incident Title]</div>
      <div class="detail-meta" id="detailMeta">
        [City / Risk / Time]
      </div>
    </div>
    <button class="detail-close" id="detailClose">Close ‚úï</button>
  </div>

  <div class="detail-body">
    <div class="detail-section">
      <h4>Summary</h4>
      <div id="detailSummary" class="small">
        -
      </div>
    </div>

    <div class="detail-section">
      <h4>Location / Impact</h4>
      <div id="detailLocation" class="small">
        Approx. location details here.
      </div>
      <div id="detailImpact" class="small" style="margin-top:8px;">
        Impact to nearby assets here.
      </div>

<canvas id="detailMiniMap" width="320" height="180"
    style="margin-top:10px;border-radius:10px;border:1px solid var(--g600);background:#0f1013;"></canvas>
  <div id="detailCoords" class="small" style="margin-top:6px;opacity:.8;"></div>		
    </div>

    <div class="detail-section">
      <h4>Earlier Today in This Area</h4>
      <div id="detailEarlier" class="small">
        No earlier incidents recorded.
      </div>
    </div>
  </div>

  <div class="detail-footer">
    <a id="viewFullBtn" class="btn-full-incident" href="#">View Full Incident ‚Üí</a>
    <a class="btn-back-dash" href="index.html">‚Üê Back to Dashboard</a>
  </div>
</aside>

<!-- ADD FEED MODAL -->
<div id="modalOverlay" class="modal-overlay">
  <div class="modal-box">
    <h3>Add Feed</h3>
   
	  <div class="modal-row">
      <label for="feedCityInput">City / Region (e.g. London)</label>
      <input id="feedCityInput" type="text" placeholder="London" />

	  <div style="font-size:11px;color:var(--muted);line-height:1.4;">
  Tip: you can use shortcuts like <code>uk</code>, <code>us</code>, <code>eu</code>, 
  <code>apac</code>, <code>mea</code>, <code>latam</code>, or <code>global</code>.
</div></div>

<div class="modal-row">
  <label for="feedKeywordsInput">Keywords (optional)</label>
  <input id="feedKeywordsInput" type="text"
         placeholder='e.g. UK OR Britain, flooding, evacuation' />
  <div style="font-size:11px;color:var(--muted);line-height:1.4;">
    Tip: use comma-separated terms or OR logic. Examples:<br>
    <code>UK OR Britain</code>, <code>flooding</code>, <code>evacuation</code>
  </div>
</div>

	  
    <div class="modal-row">
      <label for="feedRiskSelect">Risk Levels to Include</label>
      <select id="feedRiskSelect" multiple size="3">
        <option value="high">High</option>
        <option value="med">Medium</option>
        <option value="low">Low</option>
      </select>
      <div style="font-size:11px;color:var(--muted);line-height:1.4;">
        Hold Ctrl (or Cmd on Mac) to select multiple.
      </div>
    </div>


	  
  <!-- NEW CHECKBOX ROW -->
  <div class="modal-row-inline">
    <input type="checkbox" id="feedLiveCheck" />
    <div>
      <div class="live-row-text">Live news mode</div>
      <div class="live-row-hint">Pull from external breaking sources (slower, rate-limited in test)</div>
    </div>
  </div>

	  
    <div class="modal-actions">
      <button class="btn-cancel" id="modalCancel">Cancel</button>
      <button class="btn-save" id="modalSave">Save Feed</button>
    </div>
  </div>
</div>

<script>
// -------------------- top bar user chip / dropdown --------------------
(function mountTopActions(){
  const host = document.getElementById('topActions');
  if (!host) return;

  const p = JSON.parse(localStorage.getItem('ci_profile') || '{}');
  const initials = (function(name){
    if(!name) return 'CI';
    const parts = name.trim().split(/\s+/);
    return parts.slice(0,2).map(s=>s[0]?.toUpperCase()||'').join('') || 'CI';
  })(p.name);

  const role = p.role || 'Analyst';
  const isSub = (localStorage.getItem('ci_subscribed') === 'true');

  host.innerHTML = `
    <div class="user" id="userChip">
      <div class="avatar">${initials}</div>
      ${role}
    </div>
    <div class="dropdown" id="userMenu">
      <a href="settings.html">Settings</a>
      <a href="analytics.html">Analytics</a>
      <a href="system-flow.html">System Flow</a>
      <a href="operations-log.html">Operations Log</a>
      <a href="#" id="logoutLink"><span class="logout-link">Log out</span></a>
    </div>
  `;

  const chip  = document.getElementById('userChip');
  const menu  = document.getElementById('userMenu');
  const logoutLink = document.getElementById('logoutLink');

  chip.addEventListener('click', ()=>{
    menu.style.display = (menu.style.display==='block')?'none':'block';
  });
  document.addEventListener('click',(e)=>{
    if(!host.contains(e.target)) menu.style.display='none';
  });

  logoutLink.addEventListener('click',(e)=>{
    e.preventDefault();
    if(window.CIAuth && CIAuth.logout) CIAuth.logout();
    location.href='index.html';
  });

  // trial banner logic
  const trialBanner = document.getElementById('trial-banner');
  const trialText   = document.getElementById('trial-text');
  const trialEnds   = localStorage.getItem('ci_trialEndsAt');
  const subscribed  = (localStorage.getItem('ci_subscribed') === 'true');

  if (!subscribed && trialEnds) {
    // show "Your trial ends <time>"
    try {
      const d = new Date(trialEnds);
      const leftMin = Math.max(0, Math.round((d - Date.now()) / 60000));
      trialBanner.style.display='block';
      if (leftMin <= 0) {
        trialText.textContent = 'Your trial has ended.';
      } else if (leftMin < 60) {
        trialText.textContent = `Your trial ends in ${leftMin} min`;
      } else {
        const leftHr = Math.round(leftMin/60);
        trialText.textContent = `Your trial ends in ${leftHr} hour${leftHr!==1?'s':''}`;
      }
    } catch(e){
      trialBanner.style.display='block';
      trialText.textContent = 'Trial active.';
    }
  }
})();

// -------------------- FEED STORAGE / STATE --------------------
const STORAGE_KEY = 'ci_live_feeds_v1';
const FEED_EVENTS_KEY = 'ci_live_feed_events_v1';


// per-feed UI cache (so cards can show stuff before network finishes)
const FEED_UI_CACHE_TTL = 30 * 60 * 1000; // 30 minutes

function saveUiCache(feedId, events) {
  if (!feedId) return;
  const key = 'ci_ui_feed_' + feedId;
  localStorage.setItem(key, JSON.stringify({
    at: Date.now(),
    events: Array.isArray(events) ? events : []
  }));
}

function loadUiCache(feedId) {
  if (!feedId) return null;
  const key = 'ci_ui_feed_' + feedId;
  try {
    const obj = JSON.parse(localStorage.getItem(key) || 'null');
    if (!obj || !obj.at) return null;
    if (Date.now() - obj.at > FEED_UI_CACHE_TTL) return null;
    return obj.events || [];
  } catch {
    return null;
  }
}
	

	
function storeFeedEvents(feedId, events) {
  const all = JSON.parse(localStorage.getItem(FEED_EVENTS_KEY) || '{}');
  all[feedId] = { at: Date.now(), events };
  localStorage.setItem(FEED_EVENTS_KEY, JSON.stringify(all));
}

function loadFeedEvents(feedId) {
  const all = JSON.parse(localStorage.getItem(FEED_EVENTS_KEY) || '{}');
  const entry = all[feedId];
  if (!entry) return null;
  // 15-minute TTL
  if (Date.now() - entry.at > 15 * 60 * 1000) return null;
  return entry;
}

	
// read feeds from localStorage
function loadFeeds(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr)?arr:[];
  }catch(e){
    return [];
  }
}

// save feeds to localStorage
function saveFeeds(feeds){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(feeds));
}

// add a feed definition {id, places[], risks[]}
function addFeedDef(def){
  const feeds = loadFeeds();
    feeds.push({ ...def, useLive: !!def.useLive });
  saveFeeds(feeds);
}

function truncate(str, n=48) {
  return (str.length > n) ? (str.slice(0, n-1) + '‚Ä¶') : str;
}

function escapeHtml(s='') {
  return s.replace(/[&<>"']/g, m =>
    ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

// ---- 7-day per-feed archive (new) ----
const FEED_ARCHIVE_KEY = 'ci_live_feed_archive_v1';

function loadArchiveMap(){
  try { return JSON.parse(localStorage.getItem(FEED_ARCHIVE_KEY) || '{}'); }
  catch { return {}; }
}
function saveArchiveMap(map){
  localStorage.setItem(FEED_ARCHIVE_KEY, JSON.stringify(map));
}
function archiveMerge(feedId, events, { maxItems = 300 } = {}){
  if (!feedId || !Array.isArray(events) || !events.length) return;
  const map = loadArchiveMap();
  const current = Array.isArray(map[feedId]) ? map[feedId] : [];

  // üí° dedupe by src + trimmed time + title ONLY ‚Äì ignore id
  const makeKey = (e) =>
    `${(e.src || '').toLowerCase()}|${(e.when || '').slice(0,16)}|${(e.title || '')
      .toLowerCase()
      .replace(/\s+/g,' ')
      .slice(0,80)}`;

  const seen = new Set(current.map(makeKey));

  for (const ev of events){
    const key = makeKey(ev);
    if (!seen.has(key)) {
      current.push(ev);
      seen.add(key);
    }
  }

  current.sort((a,b) => (Date.parse(b.when)||0) - (Date.parse(a.when)||0));
  map[feedId] = current.slice(0, maxItems);
  saveArchiveMap(map);
}

function loadArchive(feedId){
  const map = loadArchiveMap();
  return Array.isArray(map[feedId]) ? map[feedId] : [];
}

	

	function renderKeywordsLine(keywords = []) {
  if (!keywords.length) return '';
  const max = 3;
  const shown = keywords.slice(0, max);
  const extra = Math.max(0, keywords.length - shown.length);
  const chips = shown.map(k => `<span class="kw-chip">${escapeHtml(k)}</span>`).join(' ');
  const more  = extra ? `<span class="kw-more">+${extra} more</span>` : '';
  const full  = escapeHtml(keywords.join(', '));
  return `<div class="feed-kw" title="${full}">Topics: ${chips} ${more}</div>`;
}

	// ---- lightweight client-side incident filter (new) ----
const INCIDENT_POSITIVE = [
  'protest','demonstration','clashes','riot','unrest','blockade','strike',
  'explosion','blast','bomb','fire','evacuation','evacuated','lockdown',
  'shooting','stabbing','gunfire','shots fired','attack','assault',
  'road closed','road closure','traffic disruption','derailment',
  'power outage','blackout','hazmat','chemical spill','gas leak',
  'police','security incident','incident','emergency'
];
const INCIDENT_BAD_WORDS = [
  'live scoring','live blog','live stream','how to watch','tickets',
  'premier league','tottenham','manchester united','arsenal','chelsea','liverpool',
  'rugby','cricket','nba','mlb','celebrity','fashion','award','red carpet','tv show',
  'movie','music','festival','actor','actress','singer','rapper','royal family',
  'restaurant review','shop opening','store opening','photo gallery','in pictures',
  'style','trend','beauty tips'
];
function isLikelyIncidentClient(ev){
  const text = `${ev.title||''} ${ev.description||''}`.toLowerCase();
  if (INCIDENT_BAD_WORDS.some(b => text.includes(b))) return false;
  if (INCIDENT_POSITIVE.some(g => text.includes(g))) return true;
  const r = (ev.risk||'').toLowerCase();
  return r === 'high' || r === 'med';
}


	
// ---- Global time window control (hours) ----
const WINDOW_STORAGE_KEY = 'ci_feed_window_hours';

function getCurrentWindowHours() {
  const raw = localStorage.getItem(WINDOW_STORAGE_KEY);
  const h = Number(raw);
  if (!Number.isFinite(h) || h <= 0) return 6;
  return Math.min(72, h);
}

function initWindowSelector() {
  const sel = document.getElementById('windowSelect');
  if (!sel) return;

  // initialise from storage
  const current = String(getCurrentWindowHours());
  if ([...sel.options].some(o => o.value === current)) {
    sel.value = current;
  }

  sel.addEventListener('change', () => {
    const h = Number(sel.value || '6') || 6;
    const clamped = Math.max(1, Math.min(72, h));
    localStorage.setItem(WINDOW_STORAGE_KEY, String(clamped));
    // re-run all feeds with the new window
    renderFeeds();
  });
}

// call once after DOM is ready
document.addEventListener('DOMContentLoaded', initWindowSelector);
	

// -------------------- RENDER / FETCH MOCK DATA --------------------
async function fetchMockEventsForFeed(feed) {
  const params = new URLSearchParams();
  if (feed.places?.length)   params.set('cities',   feed.places.join(','));
  if (feed.risks?.length)    params.set('risk',     feed.risks.join(','));
  if (feed.keywords?.length) params.set('keywords', feed.keywords.join(','));

  const base = 'https://api.cityintelapi.com';
  const provider = 'newsdata';
  const windowHours = getCurrentWindowHours();
params.set('window', String(windowHours));

	
  // primary + backup candidates
  const urls = feed.useLive
    ? [
        `${base}/api/live-news?${params.toString()}&provider=${provider}`,            // primary
        `${base}/api/live-news?${params.toString()}&provider=${provider}&alt=1`      // backup ‚Äì change to your 2nd key
      ]
    : [
        `${base}/api/live?${params.toString()}`,                                     // primary
        `${base}/api/live?${params.toString()}&alt=1`                                // backup ‚Äì change to your 2nd key
      ];

  for (const url of urls) {
    try {
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      // if quota hit we often get 429
      if (!res.ok) {
        if (res.status === 429) continue; // try next URL
        continue;
      }
		
      const data = await res.json().catch(() => ({}));
      let events = Array.isArray(data.events) ? data.events : [];

// FRONTEND safety filter (client-side guard)
events = events.filter(isLikelyIncidentClient);

return events;
		
    } catch (err) {
      // try next candidate
      continue;
    }
  }

  // if both failed
  return [];
}



function riskClass(r){
  if(r==='high') return 'high';
  if(r==='med')  return 'med';
  return 'low';
}

function fmtWhen(iso) {
  try {
    const s = new Date(iso).toLocaleString('en-GB', {
      timeZone: 'Europe/London',
      day: '2-digit',
      month: 'short',
      hour: '2-digit',
      minute: '2-digit',
      hour12: false
    });
    // drop trailing ", 12:18 am" ‚Üí or just the AM/PM part
    return s.replace(/,\s*(\d{2}:\d{2})\s*(AM|PM)$/i, ' $1')
            .replace(/\s*(AM|PM)$/i, '');
  } catch (e) {
    return iso || '';
  }
}


// -------------------- DETAIL PANEL HANDLING --------------------
const detailPanel   = document.getElementById('detailPanel');
const detailTitleEl = document.getElementById('detailTitle');
const detailMetaEl  = document.getElementById('detailMeta');
const detailSummaryEl = document.getElementById('detailSummary');
const detailLocationEl = document.getElementById('detailLocation');
const detailImpactEl   = document.getElementById('detailImpact');
const detailEarlierEl  = document.getElementById('detailEarlier');
const detailCloseBtn = document.getElementById('detailClose');
const viewFullBtn   = document.getElementById('viewFullBtn');


function lonLatToXY(lon, lat, w, h) {
  // quick equirectangular projection
  const x = (lon + 180) * (w / 360);
  const y = (90 - lat) * (h / 180);
  return [x, y];
}

function drawMiniMapPin(lat, lon) {
  const cvs = document.getElementById('detailMiniMap');
  const coordsEl = document.getElementById('detailCoords');
  if (!cvs || !coordsEl) return;

  const ctx = cvs.getContext('2d');
  const w = cvs.width, h = cvs.height;

  // background grid
  ctx.clearRect(0, 0, w, h);
  ctx.fillStyle = '#14161a';
  ctx.fillRect(0, 0, w, h);
  ctx.strokeStyle = 'rgba(255,255,255,0.07)';
  ctx.lineWidth = 1;
  for (let gx = 0; gx <= w; gx += 32) { ctx.beginPath(); ctx.moveTo(gx, 0); ctx.lineTo(gx, h); ctx.stroke(); }
  for (let gy = 0; gy <= h; gy += 24) { ctx.beginPath(); ctx.moveTo(0, gy); ctx.lineTo(w, gy); ctx.stroke(); }

  // subtle oval to avoid flat look
  ctx.strokeStyle = 'rgba(255,255,255,0.05)';
  ctx.beginPath();
  ctx.ellipse(w/2, h/2, w*0.46, h*0.36, 0, 0, Math.PI*2);
  ctx.stroke();

  if (typeof lat === 'number' && typeof lon === 'number') {
    const [x, y] = lonLatToXY(lon, lat, w, h);

    // glow
    ctx.beginPath();
    ctx.arc(x, y, 7, 0, Math.PI*2);
    ctx.fillStyle = 'rgba(255,77,77,0.25)';
    ctx.fill();

    // pin
    ctx.beginPath();
    ctx.arc(x, y, 3, 0, Math.PI*2);
    ctx.fillStyle = '#ff4d4d';
    ctx.shadowColor = '#ff4d4d';
    ctx.shadowBlur = 8;
    ctx.fill();
    ctx.shadowBlur = 0;

    coordsEl.textContent = `Coordinates: ${lat.toFixed(3)}, ${lon.toFixed(3)}`;
  } else {
    coordsEl.textContent = 'No coordinates provided for this alert.';
  }
}

	
function openDetailPanel(item, relatedList){
  // item = {title, city, risk, when, ...}
  // relatedList = array of all events in that feed (for "earlier today")

  detailTitleEl.textContent = item.title || '[Incident Title]';
  detailMetaEl.textContent = `${item.city||'Unknown'} ‚Ä¢ ${item.risk||'n/a'} ‚Ä¢ ${fmtWhen(item.when)}`;

  detailSummaryEl.textContent = item.description ||
                                `Ongoing situation reported in ${item.city||'the area'}.`;

  // mock "location / impact"
  detailLocationEl.textContent =
    `Approx area: ${item.city||'unknown'} (exact location may be refining).`;
  detailImpactEl.textContent =
    `Nearest office: CityIntel HQ, ~2km. Impact: Elevated security posture recommended.`;

	// Mini-map pin (lat/lon come from the event if present)
if (typeof item.lat === 'number' && typeof item.lon === 'number') {
  drawMiniMapPin(item.lat, item.lon);
} else {
  drawMiniMapPin(null, null);
}

  // earlier today in same city
 const earlier = (relatedList || [])
  .filter(x => x.city === item.city && x.when !== item.when)
  .slice(0, 3);

if (earlier.length) {
  detailEarlierEl.innerHTML =
    '<ul class="earlier-list">' +
    earlier.map(x => `<li>${fmtWhen(x.when)} ‚Äî ${x.title}</li>`).join('') +
    '</ul>';
} else {
  detailEarlierEl.textContent = 'No earlier incidents recorded.';
}


  // incident deep-link -> you could add query params later
  viewFullBtn.href = 'incident.html';
 
  window.__lastDetailItem = item; 
	
  detailPanel.classList.add('open');
}


	
function closeDetailPanel() {
  const cvs = document.getElementById('detailMiniMap');
  if (cvs) {
    const ctx = cvs.getContext('2d');
    ctx.clearRect(0, 0, cvs.width, cvs.height);
  }
  detailPanel.classList.remove('open');
}

// attach listeners ONCE
detailCloseBtn.addEventListener('click', closeDetailPanel);
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeDetailPanel();
  }
});



// Re-render a single card (fetch -> DOM -> schedule next refresh)
async function refreshSingleFeedCard(cardEl, feed){
  try {
    const events = await fetchMockEventsForFeed(feed);
    renderEventsIntoCard(cardEl, events, feed);
  } finally {
    scheduleNextRefresh(cardEl, feed);
  }
}

// Put the events into an existing card (no refetch here)
const MAX_VISIBLE_EVENTS = 20;

function renderEventsIntoCard(cardEl, events, feed){
  const bodyEl = cardEl.querySelector('.feed-body');

  // Fallback to cached events if nothing new came in
  let listEvents = Array.isArray(events) ? events : [];
  if (!listEvents.length) {
    const cached = loadUiCache(feed.id) || (loadFeedEvents(feed.id)?.events || []);
    if (cached && cached.length) {
      listEvents = cached;
    }
  }

  // Update caches if we actually have something
  if (Array.isArray(listEvents) && listEvents.length) {
    storeFeedEvents(feed.id, listEvents);
    saveUiCache(feed.id, listEvents);
    archiveMerge(feed.id, listEvents);
  }

  // For rendering, prefer the 7-day archive if present
  const archived = loadArchive(feed.id);
  const renderList = (archived && archived.length) ? archived : listEvents;

 const now = Date.now();
 const MAX_AGE_MS = 3 * 60 * 60 * 1000;
 const fresh = renderList.filter(ev => {
 const t = Date.parse(ev.when || '');
  return !isNaN(t) && (now - t <= MAX_AGE_MS);
});

const displayEvents = fresh.length ? fresh : renderList; // fallback if literally nothing
if (!displayEvents.length) {
  // ‚ÄúNo recent items‚Äù message
} else {
  bodyEl.innerHTML = '';
  const topCity = (feed.places && feed.places[0]) || 'Unknown';
  displayEvents.slice(0,8).forEach(ev => {
  });
}

	
  // --- Header: LIVE pill + buttons -----------------------------------
  const headRight = cardEl.querySelector('.feed-head-right');
  const editBtnExisting = headRight.querySelector('.btn-edit-feed');
  const delBtnExisting  = headRight.querySelector('.btn-del-feed');

  const liveMarkup = feed.useLive
    ? `<div class="live-pill"><span class="live-dot"></span><span>LIVE</span></div>`
    : ``;

  headRight.innerHTML = `
    ${liveMarkup}
    <div style="display:flex;gap:6px;">
      ${editBtnExisting ? editBtnExisting.outerHTML
                        : `<button class="btn-ghost btn-edit-feed" data-feedid="${feed.id}">Edit</button>`}
      ${delBtnExisting  ? delBtnExisting.outerHTML
                        : `<button class="btn-ghost btn-del-feed" data-feedid="${feed.id}" style="color:#ff5a5f;border-color:#ff5a5f;">‚úï</button>`}
    </div>
  `;

  // Re-bind header button handlers after innerHTML reset
  const editBtn = headRight.querySelector('.btn-edit-feed');
  if (editBtn){
    editBtn.addEventListener('click', ()=> openFeedModal(feed));
  }
  const delBtn = headRight.querySelector('.btn-del-feed');
  if (delBtn){
    delBtn.addEventListener('click', ()=>{
      if (!confirm('Remove this feed?')) return;
      const updated = loadFeeds().filter(f => f.id !== feed.id);
      saveFeeds(updated);
      renderFeeds();
    });
  }

  // --- Body: events list / empty state --------------------------------
  if (!renderList.length) {
    const placesLabel = (feed.places || []).join(', ') || 'this area';
    if (feed.useLive) {
      bodyEl.innerHTML = `
        <div style="color:var(--muted);font-size:12px;">
          No recent items in ${placesLabel}. 
          <span style="opacity:.8">Listening for live updates‚Ä¶</span>
        </div>`;
    } else {
      bodyEl.innerHTML = `
        <div style="color:var(--muted);font-size:12px;">
          No recent items in ${placesLabel}.
        </div>`;
    }
  } else {
    bodyEl.innerHTML = '';
    const topCity = (feed.places && feed.places[0]) || 'Unknown';
    renderList.slice(0, 8).forEach(ev => {
      const itemEl = document.createElement('div');
      itemEl.className = 'feed-item';
      itemEl.style.borderLeftColor =
        ev.risk === 'high' ? '#ff5a5f' :
        ev.risk === 'med'  ? '#f0b429' :
                             '#33c48d';
      itemEl.innerHTML = `
        <div class="feed-title-row">
          <div>${ev.city || topCity} ‚Äî ${ev.title}</div>
          <div class="feed-risk ${riskClass(ev.risk)}">${ev.risk}</div>
        </div>
        <div class="feed-meta">
          <span>${fmtWhen(ev.when)}</span>
          <span>${(ev.risk||'').toUpperCase()} priority</span>
        </div>
      `;
      itemEl.addEventListener('click', () => openDetailPanel(ev, renderList));
      bodyEl.appendChild(itemEl);
    });
  }

  // --- Footer: source label + timestamp -------------------------------
  const srcEl = cardEl.querySelector('.feed-footer .src');
  if (srcEl) {
    const usedFallback = feed.useLive && !listEvents.length;
    const base = feed.useLive
      ? (usedFallback ? 'source: live stream (fallback active)' : 'source: live stream')
      : 'source: simulated source';
    const time = new Date().toLocaleTimeString();
    srcEl.textContent = `${base} ‚Ä¢ updated ${time}`;
  }
}


// Timer per card (60s live, 120s mock) + small jitter so cards don't all refresh together
function scheduleNextRefresh(cardEl, feed){
  // keep lightweight state per card
  cardEl.__state = cardEl.__state || { lastLen: 0, lastHighAt: 0 };
  const { lastLen, lastHighAt } = cardEl.__state;

  // base cadence
  let base = feed.useLive ? 600_000 : 1200_000;

  // if last pull had zero items on a LIVE feed, try a bit sooner
  if (feed.useLive && lastLen === 0) base = 600_000;

  // if we saw a high-risk item recently, keep it hot for 5 minutes
  if (feed.useLive && Date.now() - lastHighAt < 5*60_000) base = Math.min(base, 25_000);

  const jitter = Math.floor(Math.random() * 60_000) - 30_000;
  const ms = Math.max(60_000, base + jitter);

  clearTimeout(cardEl.__nextTimer);
  cardEl.__nextTimer = setTimeout(()=>{
    const fresh = loadFeeds().find(f => f.id === feed.id);
    if (fresh) refreshSingleFeedCard(cardEl, fresh);
  }, ms);
}



// -------------------- FEED MODAL LOGIC --------------------
const overlayEl = document.getElementById('modalOverlay');
const cityInput = document.getElementById('feedCityInput');
const riskSel   = document.getElementById('feedRiskSelect');
const kwInput = document.getElementById('feedKeywordsInput');
const liveCheck = document.getElementById('feedLiveCheck');	
const cancelBtn = document.getElementById('modalCancel');
const saveBtn   = document.getElementById('modalSave');
const addFeedBtn= document.getElementById('btnAddFeed');

let editingFeedId = null;

function openFeedModal(feed){
  editingFeedId = feed ? feed.id : null;
  overlayEl.style.display='flex';

  if(feed){
    cityInput.value = (feed.places||[]).join(', ');
    // reset all first
    for (let i=0;i<riskSel.options.length;i++){
      riskSel.options[i].selected = false;
    }
    (feed.risks||[]).forEach(r=>{
      for (let i=0;i<riskSel.options.length;i++){
        if(riskSel.options[i].value===r){
          riskSel.options[i].selected = true;
        }
      }
    });

liveCheck.checked = !!feed.useLive;
kwInput.value = (feed.keywords || []).join(', ');	  
  } 
  
  else {
    cityInput.value = '';
    for (let i=0;i<riskSel.options.length;i++){
      riskSel.options[i].selected = false;
    }
    // default select high+med
  for (let i = 0; i < riskSel.options.length; i++) {
    if (riskSel.options[i].value === 'high') {
      riskSel.options[i].selected = true;
      break;
    }
  }
  liveCheck.checked = false;
  kwInput.value = '';
}
}

function closeFeedModal(){
  overlayEl.style.display='none';
  editingFeedId = null;
}

cancelBtn.addEventListener('click', closeFeedModal);
overlayEl.addEventListener('click',(e)=>{
  if(e.target===overlayEl){
    closeFeedModal();
  }
});
addFeedBtn.addEventListener('click', ()=>openFeedModal(null));

saveBtn.addEventListener('click', ()=>{
  const rawCities = cityInput.value.trim();
  const rawKeywords = kwInput.value.trim();

  // NEW: allow either cities or keywords
  if (!rawCities && !rawKeywords) {
    alert('Enter at least one city/region OR at least one keyword.');
    return;
  }
	
  let places = rawCities ? rawCities.split(',').map(s=>s.trim()).filter(Boolean) : [];

// Expand region shortcuts
const EXPANSIONS = {
  uk: [
    'London','Manchester','Birmingham','Leeds','Liverpool',
'Bristol','Glasgow','Edinburgh','Cardiff','Belfast',
'Nottingham','Sheffield','Newcastle','Leicester','Portsmouth',
'Southampton','Coventry','Bradford','Derby','Stoke-on-Trent',
'Sunderland','Wolverhampton','Hull','Plymouth','Brighton',
'Cambridge','cambridgeshire','Oxford','Exeter','Norwich','York',
'Preston','Canterbury','Lancaster','Chester','Milton Keynes',
'Swansea','Aberdeen','Dundee','Inverness','Newport',
'Luton','Reading','Watford','Blackpool','Middlesbrough',
'Bolton','Warrington','Huddersfield','Peterborough','Northampton',
'Chelmsford','Colchester','Ipswich','Slough','Basildon',
'Woking','Crawley','Bournemouth','Poole','Bath',
'Gloucester','Hereford','Carlisle','Wakefield','Telford',
'Doncaster','Rotherham','Barnsley','Oldham','Wigan',
'Burnley','Blackburn','Stockport','Swindon','Hastings'
  ]
};

if (places.length) {
    places = places.flatMap(p => EXPANSIONS[p.toLowerCase()] || [p]);
  }


  // keywords
  const keywords = rawKeywords
    ? rawKeywords.split(',').map(s=>s.trim()).filter(Boolean)
    : [];
	
	
  const risks = [];
  for (let i=0;i<riskSel.options.length;i++){
    if(riskSel.options[i].selected){
      risks.push(riskSel.options[i].value);
    }
  }
  if(!risks.length){
    alert('Please pick at least one risk level.');
    return;
  }

	
  const feeds = loadFeeds();
  const liveMode = !!liveCheck.checked;
	
  if(editingFeedId){
    // update existing
    const idx = feeds.findIndex(f=>f.id===editingFeedId);
    if(idx>=0){
      feeds[idx].places = places;
      feeds[idx].risks  = risks;
	  feeds[idx].useLive = liveMode;
	  feeds[idx].keywords = keywords;
    }
    saveFeeds(feeds);
  } else {
    // create new
    const id = 'feed-' + Date.now().toString(36);
    feeds.push({ id, places, risks, useLive: liveMode, keywords });
  }
  saveFeeds(feeds);
  closeFeedModal();
  renderFeeds();
});
	

	
// -------------------- CARD RENDER --------------------
async function renderFeeds(){
  const grid = document.getElementById('feedsGrid');

  // use let (we mutate this below)
  let feeds = loadFeeds();
  if (!Array.isArray(feeds)) feeds = [];

// Auto-seed several useful starters if none exist
if (feeds.length === 0){
  const starters = [
    { id: 'seed-global', title: 'Global (live)', places: ['global'],  risks: ['high','med'], useLive: true  },
    { id: 'seed-eu',     title: 'Europe (live)', places: ['eu'],      risks: ['high','med'], useLive: true  },
    { id: 'seed-uk',     title: 'UK (live)',     places: ['uk'],      risks: ['high','med'], useLive: true  },
    { id: 'seed-usa',    title: 'US (live)',     places: ['us'],      risks: ['high','med'], useLive: true  },
  ];

  // persist (title is only for display ‚Äì we derive label from places below)
  saveFeeds(starters.map(s => ({
    id: s.id, places: s.places, risks: s.risks, useLive: s.useLive,
    // keywords left empty by default
  })));

  feeds = loadFeeds();
}



  grid.innerHTML = '';

  for (const feed of feeds){
    const risksLabel  = (feed.risks||[]).join(', ');

    const card = document.createElement('section');
    card.className = 'feed-card';
    card.dataset.id = feed.id;


const keywordsLine = renderKeywordsLine(feed.keywords || []);
const prettyName =
  (feed.id && feed.id.startsWith('seed-')) ? (
    feed.id==='seed-global' ? 'Global (live)' :
    feed.id==='seed-eu'     ? 'Europe (live)' :
    feed.id==='seed-uk'     ? 'UK (live)' :
    feed.id==='seed-usa'    ? 'US (live)' :
    null
  ) : null;

const citiesLabel = prettyName ?? (feed.places || []).join(', ');  
	  
    card.innerHTML = `
      <div class="feed-head">
        <div class="feed-head-left">
          <div class="feed-city">${citiesLabel}</div>
          <div style="margin-top:4px;font-size:12px;color:${feed.risks.includes('high')?'#ff5a5f':feed.risks.includes('med')?'#f0b429':'#33c48d'};">
            Watching: ${risksLabel}
          </div>
          ${keywordsLine}  <!-- NEW: compact keywords row -->
        </div>
        <div class="feed-head-right">
          ${feed.useLive ? `<div class="live-pill"><span class="live-dot"></span><span>LIVE</span></div>` : ``}
          <div style="display:flex;gap:6px;">
            <button class="btn-ghost btn-edit-feed" data-feedid="${feed.id}">Edit</button>
            <button class="btn-ghost btn-del-feed" data-feedid="${feed.id}" style="color:#ff5a5f;border-color:#ff5a5f;">‚úï</button>
          </div>
        </div>
      </div>

      <div class="feed-body"></div>

      <div class="feed-footer">
  <div class="src">${feed.useLive ? 'source: live stream' : 'source: simulated source'}</div>
  <div style="display:flex;gap:10px;align-items:center;">
    <div class="refresh" data-feedid="${feed.id}">‚Üª refresh</div>
    <select class="earlier" data-feedid="${feed.id}" style="background:#1f2024;border:1px solid var(--g600);border-radius:6px;color:#e9edf2;font-size:11px;padding:4px 6px;">
      <option value="">Load earlier‚Ä¶</option>
      <option value="720">Last 12h</option>
      <option value="1440">Last 24h</option>
      <option value="2880">Last 48h</option>
      <option value="4320">Last 72h</option>
    </select>
  </div>
</div> `;

    // refresh link
    card.querySelector('.refresh').addEventListener('click', ()=>{
      const fresh = loadFeeds().find(f=>f.id===feed.id) || feed;
      refreshSingleFeedCard(card, fresh);
    });

    // edit feed (fixed the missing dot before addEventListener)
    card.querySelector('.btn-edit-feed').addEventListener('click', ()=>{
      openFeedModal(feed);
    });

	  // optional: click the topics line to edit
const kwEl = card.querySelector('.feed-kw');
if (kwEl) kwEl.addEventListener('click', () => openFeedModal(feed));


    // delete feed
    card.querySelector('.btn-del-feed').addEventListener('click', ()=>{
      if (!confirm('Remove this feed?')) return;
      const updated = loadFeeds().filter(f => f.id !== feed.id);
      saveFeeds(updated);
      renderFeeds();
    });


// "Load earlier" selector
const earlierSel = card.querySelector('.earlier');
if (earlierSel){
  earlierSel.addEventListener('change', async () => {
const mins = Number(earlierSel.value || 0);
if (!mins) return;
const hours = Math.max(1, Math.round(mins / 60)); // 720 -> 12, 1440 -> 24, etc.

// build the same filters as before
const params = new URLSearchParams();
if (feed.places?.length)   params.set('cities',   feed.places.join(','));
if (feed.risks?.length)    params.set('risk',     feed.risks.join(','));
if (feed.keywords?.length) params.set('keywords', feed.keywords.join(','));
params.set('provider', 'newsdata');

// NEW: explicit window in hours
params.set('window', String(Math.min(72, hours)));

    const base = 'https://api.cityintelapi.com';
    const url  = `${base}/api/live-news?${params.toString()}`;
    try {
      const res  = await fetch(url, { headers: { 'Accept': 'application/json' } });
      const data = await res.json().catch(()=>({}));
      const events = Array.isArray(data.events) ? data.events : [];
      // merge into archive and render from archive
      archiveMerge(feed.id, events);
      const merged = loadArchive(feed.id);
      renderEventsIntoCard(card, merged, feed); // shows many more items
    } catch {}
    earlierSel.value = '';
  });
}
	  

    grid.appendChild(card);

// 1) try UI cache (prettier, per-feed)
const uiEvents = loadUiCache(feed.id);
if (uiEvents && uiEvents.length) {
  renderEventsIntoCard(card, uiEvents, feed);
} else {
  // 2) fallback to your existing 15min cache
  const cached = loadFeedEvents(feed.id);
  if (cached && cached.events) {
    renderEventsIntoCard(card, cached.events, feed);
  }
}

// 3) always go fetch fresh + schedule
refreshSingleFeedCard(card, feed);

  }
}


// -------------------- INIT --------------------
renderFeeds();

// ---- link View Full Incident to incident.html ----
viewFullBtn.addEventListener('click', (e)=>{
  e.preventDefault();
  // Build a minimal object to pass along
  const incidentData = {
    title: detailTitleEl.textContent,
    meta: detailMetaEl.textContent,
    summary: detailSummaryEl.textContent,
    location: detailLocationEl.textContent,
    impact: detailImpactEl.textContent,
    earlier: detailEarlierEl.textContent,
    url: window.__lastDetailItem?.url || null,
    src: window.__lastDetailItem?.src || null,
    description: window.__lastDetailItem?.description || null,
    when: window.__lastDetailItem?.when || null,
    city: window.__lastDetailItem?.city || null,
    risk: window.__lastDetailItem?.risk || null
  };

  // Generate a temp ID (could use timestamp)
  const incId = 'inc-' + Date.now().toString(36);

  // Persist in sessionStorage
  const all = JSON.parse(sessionStorage.getItem('ci_incidents') || '{}');
  all[incId] = incidentData;
  sessionStorage.setItem('ci_incidents', JSON.stringify(all));

  // Redirect with ?id=
  location.href = 'incident.html?id=' + encodeURIComponent(incId);
});

	
</script>

<!-- auth helpers / admin links -->

<script src="admin-links.js"></script>

</body>
</html>
