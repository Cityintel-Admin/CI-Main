<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CityIntel â€” Live Feed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --g900:#111214;
      --g800:#16171a;
      --g700:#1c1e22;
      --g600:#2e3238;
      --text:#e9edf2;
      --muted:#8e97a3;
      --danger:#ff5a5f;
      --warn:#f0b429;
      --ok:#33c48d;
      --accent:#D01616;
    }

    body{
      margin:0;
      background:linear-gradient(180deg,var(--g900),var(--g800));
      color:var(--text);
      font:14px/1.6 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }

    .app{
      display:grid;
      grid-template-columns:260px 1fr;
      grid-template-rows:60px 1fr;
      grid-template-areas:
        "sidebar topbar"
        "sidebar main";
      min-height:100vh;
    }

    .sidebar{
      grid-area:sidebar;
      background:linear-gradient(180deg,#0C0C0C,#131416);
      border-right:1px solid var(--g600);
      padding:18px 14px;
      min-height:100%;
    }

    .sidebar .brand{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:16px;
    }
    .sidebar .brand img{
      width:32px;
      height:32px;
      border-radius:6px;
      object-fit:cover;
      border:1px solid var(--g600);
      background:#000;
    }
    .sidebar .brand .title{
      font-weight:700;
      color:var(--text);
      font-size:15px;
      line-height:1.2;
    }
    .sidebar .brand .subtitle{
      font-size:11px;
      color:var(--muted);
      line-height:1.2;
    }

    nav.sidebar-nav{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    nav.sidebar-nav a{
      display:flex;
      gap:10px;
      color:#e9edf2;
      text-decoration:none;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid transparent;
      font-size:13px;
      align-items:center;
    }
    nav.sidebar-nav a:hover{
      background:#24272c;
      border-color:#2e3238;
    }
    nav.sidebar-nav a.active{
      background:rgba(208,22,22,.15);
      border-color:#D01616;
    }

    .topbar{
      grid-area:topbar;
      background:rgba(255,255,255,.02);
      border-bottom:1px solid var(--g600);
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 16px;
      position:sticky;
      top:0;
      z-index:20;
      backdrop-filter:blur(8px);
      justify-content:space-between;
    }

    .brandbar-left{
      display:flex;
      align-items:center;
      gap:12px;
    }

    .trial-banner{
      display:none;
      background:none;
      color:#fecaca;
      font-size:12px;
      line-height:1.3;
      text-align:center;
      font-weight:500;
    }
    .trial-banner .live-dot{
      display:inline-block;
      width:8px;
      height:8px;
      border-radius:50%;
      background:#ff4d4d;
      box-shadow:0 0 8px #ff4d4d;
      margin-right:6px;
    }

    .top-actions-wrapper{
      margin-left:auto;
      position:relative;
    }

    .user-chip{
      display:flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      background:#1f2227;
      border:1px solid var(--g600);
      border-radius:10px;
      padding:6px 10px;
      font-size:12px;
      line-height:1.2;
    }
    .user-chip .avatar{
      background:#D01616;
      color:#fff;
      font-weight:700;
      font-size:11px;
      line-height:1;
      border-radius:6px;
      padding:6px 6px;
      min-width:24px;
      text-align:center;
    }

    .user-menu{
      display:none;
      position:absolute;
      right:0;
      top:calc(100% + 6px);
      background:#1a1c20;
      border:1px solid var(--g600);
      border-radius:10px;
      min-width:180px;
      box-shadow:0 20px 40px rgba(0,0,0,.6);
      z-index:9999;
      font-size:13px;
      padding:8px;
    }
    .user-menu a{
      display:block;
      color:var(--text);
      text-decoration:none;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid transparent;
    }
    .user-menu a:hover{
      background:#2a2d33;
      border-color:#3a3f46;
    }
    .user-menu hr{
      border:0;
      border-top:1px solid var(--g600);
      margin:6px 0;
    }
    .user-menu a.danger{
      color:#ff5a5f;
    }

    .main{
      grid-area:main;
      padding:18px;
      position:relative;
    }

    .page-header-row{
      display:flex;
      flex-wrap:wrap;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom:16px;
      gap:12px;
    }
    .page-header-left{
      min-width:0;
    }
    .page-header-left h2{
      margin:0;
      font-size:16px;
      line-height:1.4;
      font-weight:600;
      color:var(--text);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .page-header-left .sub{
      font-size:12px;
      color:var(--muted);
      line-height:1.3;
      max-width:600px;
    }

    .page-header-right{
      display:flex;
      align-items:flex-start;
      flex-direction:column;
      gap:8px;
      margin-left:auto;
    }

    .add-feed-btn{
      display:inline-block;
      background:rgba(208,22,22,.12);
      color:#fff;
      border:1px solid #D01616;
      border-radius:10px;
      font-size:13px;
      font-weight:600;
      padding:8px 12px;
      cursor:pointer;
      line-height:1.2;
      text-decoration:none;
      text-align:center;
    }
    .add-feed-btn:hover{
      background:rgba(208,22,22,.18);
    }

    .last-fetch{
      font-size:11px;
      line-height:1.3;
      color:var(--muted);
    }

    /* FEEDS GRID */
    .feeds-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(320px,1fr));
      gap:16px;
    }

    .feed-card{
      position:relative;
      background:linear-gradient(180deg,#1a1c20,#131417);
      border:1px solid var(--g600);
      border-radius:16px;
      padding:16px;
      display:flex;
      flex-direction:column;
      min-height:260px;
    }

    .card-header-row{
      display:flex;
      align-items:flex-start;
      margin-bottom:12px;
    }

    .feed-main{
      flex:1;
      min-width:0;
    }
    .feed-title{
      margin:0;
      font-size:14px;
      font-weight:600;
      color:var(--text);
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:6px;
    }
    .feed-watching{
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
      margin:4px 0 8px;
    }
    .feed-risk{
      font-size:12px;
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:6px;
    }
    .risk-pill{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      font-size:11px;
      line-height:1.2;
      font-weight:600;
      border:1px solid rgba(255,255,255,.15);
    }
    .risk-high{
      color:var(--danger);
      background:rgba(255,90,95,.12);
      border-color:rgba(255,90,95,.35);
    }
    .risk-med{
      color:var(--warn);
      background:rgba(240,180,41,.12);
      border-color:rgba(240,180,41,.35);
    }
    .risk-low{
      color:var(--ok);
      background:rgba(51,196,141,.12);
      border-color:rgba(51,196,141,.35);
    }

    .feed-controls{
      margin-left:auto;
      text-align:right;
      min-width:max-content;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:8px;
    }
    .live-badge{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      line-height:1.2;
      font-weight:600;
      color:#ff5a5f;
    }
    .live-dot{
      width:8px;
      height:8px;
      border-radius:50%;
      background:#ff5a5f;
      box-shadow:0 0 8px #ff5a5f;
    }
    .edit-btn{
      background:#1f2227;
      color:#fff;
      border:1px solid var(--g600);
      border-radius:8px;
      font-size:11px;
      font-weight:600;
      padding:6px 8px;
      line-height:1.2;
      cursor:pointer;
    }
    .edit-btn:hover{
      background:#2a2d33;
    }

    .feed-body{
      flex:1;
      min-height:120px;
      border:1px solid var(--g600);
      border-radius:12px;
      background:rgba(0,0,0,.15);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .feed-events{
      flex:1;
      overflow-y:auto;
      scrollbar-width:thin;
      scrollbar-color:#3a3f46 transparent;
      font-size:13px;
      line-height:1.4;
    }
    .feed-events::-webkit-scrollbar{
      width:6px;
    }
    .feed-events::-webkit-scrollbar-track{
      background:transparent;
    }
    .feed-events::-webkit-scrollbar-thumb{
      background:#3a3f46;
      border-radius:3px;
    }

    .feed-event-row{
      padding:10px 12px;
      border-bottom:1px solid var(--g600);
      cursor:pointer;
    }
    .feed-event-row:last-child{
      border-bottom:none;
    }
    .event-head{
      font-size:13px;
      color:var(--text);
      font-weight:600;
      line-height:1.4;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .event-meta{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      color:var(--muted);
      font-size:11px;
      line-height:1.3;
      margin-top:4px;
    }
    .event-meta .city{
      color:#fff;
      font-weight:500;
    }

    .feed-footer{
      font-size:11px;
      color:var(--muted);
      border-top:1px solid var(--g600);
      background:rgba(255,255,255,.02);
      padding:8px 12px;
      line-height:1.3;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      flex-wrap:wrap;
      gap:6px;
    }
    .feed-footer .src,
    .feed-footer .ts{
      white-space:nowrap;
    }

    /* drawer on right */
    .drawer{
      position:fixed;
      top:0;
      right:0;
      bottom:0;
      width:360px;
      max-width:90%;
      background:linear-gradient(180deg,#1a1c20,#131417);
      border-left:1px solid var(--g600);
      box-shadow:-20px 0 40px rgba(0,0,0,.8);
      transform:translateX(100%);
      transition:transform .22s ease;
      z-index:9999;
      display:flex;
      flex-direction:column;
    }
    .drawer.open{
      transform:translateX(0);
    }
    .drawer-head{
      padding:16px;
      border-bottom:1px solid var(--g600);
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
    }
    .drawer-head-left{
      font-size:13px;
      line-height:1.4;
      color:var(--text);
    }
    .drawer-head-left .drawer-city{
      font-weight:600;
      color:var(--text);
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:6px;
    }
    .drawer-head-left .drawer-title{
      font-size:12px;
      color:var(--muted);
      font-weight:400;
    }
    .drawer-close-btn{
      background:#1f2227;
      color:#fff;
      border:1px solid var(--g600);
      border-radius:8px;
      font-size:11px;
      font-weight:600;
      padding:6px 8px;
      line-height:1.2;
      cursor:pointer;
      text-align:center;
    }
    .drawer-close-btn:hover{
      background:#2a2d33;
    }

    .drawer-body{
      flex:1;
      overflow-y:auto;
      padding:16px;
      scrollbar-width:thin;
      scrollbar-color:#3a3f46 transparent;
      font-size:13px;
      line-height:1.5;
      color:var(--text);
    }
    .drawer-body::-webkit-scrollbar{
      width:6px;
    }
    .drawer-body::-webkit-scrollbar-track{
      background:transparent;
    }
    .drawer-body::-webkit-scrollbar-thumb{
      background:#3a3f46;
      border-radius:3px;
    }

    .drawer-section{
      background:#1f2227;
      border:1px solid var(--g600);
      border-radius:12px;
      padding:12px;
      margin-bottom:12px;
    }
    .drawer-section h4{
      margin:0 0 6px;
      font-size:12px;
      font-weight:600;
      color:var(--text);
      display:flex;
      align-items:center;
      gap:6px;
    }
    .drawer-section .muted{
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
    }
    .map-card{
      background:#0f1012;
      border:1px solid var(--g600);
      border-radius:10px;
      height:140px;
      color:#8e97a3;
      font-size:12px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      gap:4px;
    }
    .map-card .crosshair{
      width:28px;
      height:28px;
      border-radius:50%;
      border:2px solid #ff5a5f;
      box-shadow:0 0 10px #ff5a5f;
    }

    .drawer-footer{
      padding:16px;
      border-top:1px solid var(--g600);
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:space-between;
      align-items:flex-start;
    }
    .view-full-btn{
      background:#D01616;
      border:1px solid #D01616;
      border-radius:10px;
      color:#fff;
      font-size:12px;
      line-height:1.2;
      font-weight:600;
      padding:8px 10px;
      cursor:pointer;
      text-decoration:none;
      text-align:center;
      min-width:120px;
    }
    .view-full-btn:hover{
      background:#e11b1b;
    }
    .drawer-meta{
      font-size:11px;
      line-height:1.4;
      color:var(--muted);
    }

    /* modal overlay */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:99999;
      padding:16px;
    }
    .modal-overlay.show{
      display:flex;
    }
    .modal-card{
      width:100%;
      max-width:360px;
      background:linear-gradient(180deg,#1a1c20,#131417);
      border:1px solid var(--g600);
      border-radius:16px;
      box-shadow:0 30px 60px rgba(0,0,0,.8);
      padding:16px;
      color:var(--text);
      font-size:13px;
      line-height:1.4;
    }
    .modal-card h3{
      margin:0 0 10px;
      font-size:14px;
      font-weight:600;
      color:var(--text);
    }
    .modal-card label{
      font-size:12px;
      font-weight:500;
      color:var(--muted);
      display:block;
      margin:10px 0 4px;
    }
    .modal-card input[type="text"]{
      width:100%;
      background:#1f2227;
      color:#fff;
      border:1px solid var(--g600);
      border-radius:8px;
      padding:8px 10px;
      font-size:13px;
      line-height:1.3;
      box-sizing:border-box;
    }
    .modal-flex-row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .modal-flex-row .half{
      flex:1;
      min-width:120px;
    }
    .modal-check-wrap{
      margin-top:12px;
      background:#1f2227;
      border:1px solid var(--g600);
      border-radius:8px;
      padding:10px;
      font-size:12px;
      line-height:1.4;
      color:var(--text);
      display:flex;
      gap:8px;
      align-items:flex-start;
    }
    .modal-check-wrap input[type="checkbox"]{
      margin-top:2px;
      flex-shrink:0;
    }
    .modal-check-copy{
      flex:1;
    }
    .modal-check-copy .check-head{
      font-weight:600;
      color:#fff;
      margin-bottom:2px;
      font-size:12px;
    }
    .modal-check-copy .check-sub{
      color:var(--muted);
      font-size:11px;
      line-height:1.4;
    }

    .modal-btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:flex-end;
      margin-top:16px;
    }
    .btn-cancel{
      background:#1f2227;
      border:1px solid var(--g600);
      border-radius:10px;
      color:#fff;
      font-size:12px;
      line-height:1.2;
      font-weight:600;
      padding:8px 10px;
      cursor:pointer;
      text-align:center;
    }
    .btn-save{
      background:#D01616;
      border:1px solid #D01616;
      border-radius:10px;
      color:#fff;
      font-size:12px;
      line-height:1.2;
      font-weight:600;
      padding:8px 10px;
      cursor:pointer;
      text-align:center;
      min-width:90px;
    }
    .btn-save:hover{
      background:#e11b1b;
    }

    @media(max-width:900px){
      .app{
        grid-template-columns:1fr;
        grid-template-areas:
          "topbar"
          "main";
      }
      .sidebar{ display:none; }
      .drawer{ width:90%; max-width:400px; }
    }
  </style>
</head>
<body>

<div class="app">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">
      <img src="CityintLogo.jpg" alt="CityIntel Logo">
      <div style="display:flex;flex-direction:column;">
        <div class="title">CityIntel</div>
        <div class="subtitle">Live Situational Intelligence</div>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a href="index.html">Dashboard</a>
      <a href="alerts.html">Alerts</a>
      <a href="events.html">Events</a>
      <a href="reports.html">Reports</a>
      <a href="watch.html">My Live Feed</a>
      <a href="sources.html">Sources</a>
      <a href="operations-log.html">Operations Log</a>
      <a href="analytics.html">Analytics</a>
      <a href="system-flow.html">System Flow</a>
      <a class="active" href="live-feed.html">Live Feed</a>
      <a href="settings.html">Settings</a>
    </nav>
  </aside>

  <!-- TOP BAR -->
  <header class="topbar">
    <div class="brandbar-left">
      <div style="display:flex;flex-direction:column;">
        <div style="font-weight:700;font-size:14px;color:#fff;line-height:1.3;">
          Live Feed
        </div>
        <div class="trial-banner" id="trial-banner">
          <span class="live-dot"></span>
          <span id="trial-text">Trial: 1 day left</span>
        </div>
      </div>
    </div>

    <div class="top-actions-wrapper" id="topActions"></div>
  </header>

  <!-- MAIN -->
  <main class="main">

    <section class="page-header-row">
      <div class="page-header-left">
        <h2>
          City / Region Watch
        </h2>
        <div class="sub">
          You define which locations matter. We stream emerging activity,
          protest chatter, police presence, traffic disruption, etc.
          Click an item for full context, office proximity, and map.
        </div>
      </div>

      <div class="page-header-right">
        <button class="add-feed-btn" id="btnAddFeed">+ Add Feed</button>
        <div class="last-fetch">
          <span id="lastRefresh">Last refresh: â€”</span><br/>
          Auto-refresh ~15s
        </div>
      </div>
    </section>

    <!-- GRID OF FEEDS -->
    <section class="feeds-grid" id="feedsGrid"></section>

  </main>
</div>

<!-- DRAWER (right slide panel) -->
<div class="drawer" id="drawer">
  <div class="drawer-head">
    <div class="drawer-head-left">
      <div class="drawer-city" id="drawerCity">City</div>
      <div class="drawer-title" id="drawerTitle">Incident title goes here</div>
    </div>
    <button class="drawer-close-btn" id="drawerClose">Close</button>
  </div>

  <div class="drawer-body">
    <div class="drawer-section">
      <h4>Location / Office Proximity</h4>
      <div class="muted" id="drawerProximity">2.1 km NE of London HQ (Stratford, East London)</div>
      <div class="map-card" id="drawerMapCard">
        <div class="crosshair"></div>
        <div>Map Preview (placeholder)</div>
        <div style="font-size:11px;color:#8e97a3;">
          Incident â†” Office distance overlay
        </div>
      </div>
    </div>

    <div class="drawer-section">
      <h4>Details / Field Notes</h4>
      <div class="muted" id="drawerDetails">
        Police presence and road disruption reported. Crowd gathering.
      </div>
    </div>

    <div class="drawer-section">
      <h4>Earlier Activity in this Area</h4>
      <div class="muted" id="drawerEarlier">
        â€¢ 07:20 â€“ minor roadblock<br/>
        â€¢ 06:55 â€“ protest convoy spotted<br/>
        â€¢ 06:10 â€“ police staging units nearby
      </div>
    </div>
  </div>

  <div class="drawer-footer">
    <a class="view-full-btn" id="drawerViewFull" href="incident.html">View Full Incident</a>
    <div class="drawer-meta">
      <div id="drawerRisk">Risk: High</div>
      <div id="drawerTime">07:59 â€¢ source: CityIntel mock</div>
    </div>
  </div>
</div>

<!-- MODAL: ADD / EDIT FEED -->
<div class="modal-overlay" id="feedModalOverlay">
  <div class="modal-card">
    <h3 id="modalTitle">New Feed</h3>

    <div class="modal-flex-row">
      <div class="half">
        <label for="modalCities">Cities / Regions</label>
        <input id="modalCities" type="text" placeholder="e.g. London, Paris, Berlin" />
      </div>
      <div class="half">
        <label for="modalName">Internal label</label>
        <input id="modalName" type="text" placeholder="London + Paris Watch" />
      </div>
    </div>

    <label for="modalRisk">Risk levels to watch</label>
    <input id="modalRisk" type="text" placeholder="high,med,low" />

    <!-- checkbox block on its own line -->
    <div class="modal-check-wrap">
      <input id="modalUseLive" type="checkbox" />
      <div class="modal-check-copy">
        <div class="check-head">Live feed (beta)</div>
        <div class="check-sub">
          Streams directly from external alert sources. May include raw / unverified intel.
        </div>
      </div>
    </div>

    <div class="modal-btn-row">
      <button class="btn-cancel" id="modalCancel">Cancel</button>
      <button class="btn-save" id="modalSave">Save Feed</button>
    </div>
  </div>
</div>

<script>
/* ================= AUTH GUARD / TOP RIGHT USER CHIP ================= */
(function initTopActions(){
  const host = document.getElementById('topActions');
  if (!host) return;

  const CIAuth = window.CIAuth;
  if (!CIAuth) return;

  const isLoggedIn = CIAuth.isLoggedIn();
  const profile = (function(){
    try { return JSON.parse(localStorage.getItem('ci_profile')||'{}'); }
    catch(e){ return {}; }
  })();

  // trial banner logic
  (function(){
    const banner = document.getElementById('trial-banner');
    const txt = document.getElementById('trial-text');
    let subInfo = {
      subscribed: (localStorage.getItem('ci_subscribed')==='true'),
      trialEndsAt: null
    };
    // we don't yet store trialEndsAt locally, but we will later
    // so we'll just show banner if not subscribed:
    if (!subInfo.subscribed){
      banner.style.display='block';
      txt.textContent='Trial: limited access';
    } else {
      banner.style.display='none';
    }
  })();

  host.innerHTML = '';

  if (isLoggedIn) {
    // compute initials & role
    let initials='CI', role='Analyst';
    if (profile.name){
      const parts=profile.name.trim().split(/\s+/);
      initials = parts.slice(0,2).map(p=>p[0]?.toUpperCase()||'').join('')||'CI';
    }
    if (profile.role) role=profile.role;

    host.innerHTML = `
      <div class="user-chip" id="userChip">
        <div class="avatar">${initials}</div>
        <div style="display:flex;flex-direction:column;line-height:1.2;">
          <div style="color:#fff;font-weight:600;font-size:12px;">${role}</div>
          <div style="color:#8e97a3;font-size:11px;">${profile.email||''}</div>
        </div>
      </div>
      <div class="user-menu" id="userMenu">
        <a href="settings.html">Settings / Billing</a>
        <a href="analytics.html">Analytics</a>
        <a href="system-flow.html">System Flow</a>
        <a href="operations-log.html">Operations Log</a>
        <hr/>
        <a href="#" class="danger" id="logoutLink">Log out</a>
      </div>
    `;

    const chip = document.getElementById('userChip');
    const menu = document.getElementById('userMenu');

    chip.addEventListener('click', ()=>{
      menu.style.display = (menu.style.display==='block') ? 'none' : 'block';
    });
    document.addEventListener('click', (e)=>{
      if (!host.contains(e.target)) menu.style.display='none';
    });

    document.getElementById('logoutLink').addEventListener('click',(e)=>{
      e.preventDefault();
      CIAuth.logout();
      location.href='login.html';
    });

  } else {
    const here = location.pathname.split('/').pop() || 'index.html';
    const next = encodeURIComponent(here + location.search + location.hash);
    host.innerHTML = `
      <a class="add-feed-btn" href="login.html?next=${next}">Log in</a>
    `;
  }
})();

/* ====================== PAGE PROTECT ====================== */
(function(){
  if (!window.CIAuth) return;
  // pages that require subscription: live-feed counts as protected
  window.CIAuth.requireAuth('login.html');
})();

/* =============== FEED STATE / STORAGE / HELPERS =============== */

function loadFeeds(){
  try{
    return JSON.parse(localStorage.getItem('ci_live_feeds')||'[]');
  }catch(e){
    return [];
  }
}
function saveFeeds(feeds){
  localStorage.setItem('ci_live_feeds', JSON.stringify(feeds));
}

function riskPill(r){
  const cls = r==='high' ? 'risk-pill risk-high'
           : r==='med'  ? 'risk-pill risk-med'
           : 'risk-pill risk-low';
  const label = r==='high' ? 'High'
             : r==='med'  ? 'Med'
             : 'Low';
  return `<span class="${cls}">${label}</span>`;
}

function timeAgo(iso){
  if(!iso) return '';
  const d=new Date(iso);
  const now=Date.now();
  const diffSec=Math.floor((now-d.getTime())/1000);
  if(diffSec<60) return diffSec+"s ago";
  const diffMin=Math.floor(diffSec/60);
  if(diffMin<60) return diffMin+"m ago";
  const diffHr=Math.floor(diffMin/60);
  if(diffHr<24) return diffHr+"h ago";
  const diffDay=Math.floor(diffHr/24);
  return diffDay+"d ago";
}

/* ==================== DRAWER LOGIC ==================== */
const drawerEl = document.getElementById('drawer');
const drawerCity = document.getElementById('drawerCity');
const drawerTitle = document.getElementById('drawerTitle');
const drawerProximity = document.getElementById('drawerProximity');
const drawerDetails = document.getElementById('drawerDetails');
const drawerEarlier = document.getElementById('drawerEarlier');
const drawerRisk = document.getElementById('drawerRisk');
const drawerTime = document.getElementById('drawerTime');
const drawerViewFull = document.getElementById('drawerViewFull');
const drawerClose = document.getElementById('drawerClose');

function openDrawerForEvent(feed, evt){
  // fill fields
  drawerCity.textContent = evt.city || 'Unknown city';
  drawerTitle.textContent = evt.title || 'No title';

  // example office/location strings
  drawerProximity.textContent =
    (evt.officeProximity || "2.1 km NE of London HQ (Stratford, East London)");

  drawerDetails.textContent =
    (evt.details || "Police presence and road disruption reported. Crowd gathering.");

  drawerEarlier.innerHTML =
    (evt.historyHtml || (
      "â€¢ 07:20 â€“ minor roadblock<br/>" +
      "â€¢ 06:55 â€“ protest convoy spotted<br/>" +
      "â€¢ 06:10 â€“ police staging units nearby"
    ));

  drawerRisk.textContent = "Risk: " + (evt.risk || 'low');
  drawerTime.textContent =
    (evt.when ? (new Date(evt.when).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})) : '') +
    " â€¢ source: " + (evt.src || 'CityIntel mock');

  // We also pass data to incident.html via query params for now
  const incidentURL =
    "incident.html?" +
    new URLSearchParams({
      city: evt.city || '',
      title: evt.title || '',
      risk: evt.risk || '',
      when: evt.when || '',
      src: evt.src || '',
      details: evt.details || '',
      proximity: evt.officeProximity || '',
    }).toString();

  drawerViewFull.setAttribute('href', incidentURL);

  // open drawer
  drawerEl.classList.add('open');
}
drawerClose.addEventListener('click', ()=> drawerEl.classList.remove('open') );

/* ==================== MODAL LOGIC ==================== */
const modalOverlay = document.getElementById('feedModalOverlay');
const modalTitle = document.getElementById('modalTitle');
const modalCities = document.getElementById('modalCities');
const modalName = document.getElementById('modalName');
const modalRisk = document.getElementById('modalRisk');
const modalUseLive = document.getElementById('modalUseLive');
const modalCancel = document.getElementById('modalCancel');
const modalSave = document.getElementById('modalSave');

let editingFeedIndex = null;

function openFeedModal(feedIndex){
  const feeds = loadFeeds();
  if(feedIndex===null || feedIndex===undefined){
    // new feed
    editingFeedIndex = null;
    modalTitle.textContent = "New Feed";
    modalCities.value = "";
    modalName.value = "";
    modalRisk.value = "high,med,low";
    modalUseLive.checked = true;
  } else {
    editingFeedIndex = feedIndex;
    const f = feeds[feedIndex];
    modalTitle.textContent = "Edit Feed";
    modalCities.value = f.cities.join(", ");
    modalName.value = f.name || "";
    modalRisk.value = f.risk.join(", ");
    modalUseLive.checked = !!f.useLive;
  }
  modalOverlay.classList.add('show');
}

function closeFeedModal(){
  modalOverlay.classList.remove('show');
}

modalCancel.addEventListener('click', closeFeedModal);

modalOverlay.addEventListener('click', (e)=>{
  if(e.target===modalOverlay){
    closeFeedModal();
  }
});

/* ==================== FETCH + RENDER ==================== */

async function fetchEventsForFeed(feed){
  // feed = { cities:[], risk:[], useLive:true/false }
  try {
    const paramsCities = encodeURIComponent(feed.cities.join(","));
    const paramsRisk = encodeURIComponent(feed.risk.join(","));
    let url;
    if(feed.useLive){
      // future real endpoint:
      url = `https://api.cityintelapi.com/api/live-news?cities=${paramsCities}&risk=${paramsRisk}`;
      console.log("Live feed active for", feed.cities.join(", "));
    } else {
      // mock endpoint we already have
      url = `https://api.cityintelapi.com/api/live?cities=${paramsCities}&risk=${paramsRisk}`;
    }

    const res = await fetch(url);
    if(!res.ok){
      throw new Error("HTTP "+res.status);
    }
    const j = await res.json();
    return (j.events || []).slice(0,20); // cap
  } catch(err){
    console.warn("fetchEventsForFeed failed", err);
    return [];
  }
}

function renderFeeds(){
  const grid = document.getElementById('feedsGrid');
  const feeds = loadFeeds();
  grid.innerHTML = '';

  feeds.forEach((feed, idx)=>{
    const card = document.createElement('div');
    card.className='feed-card';

    const liveBadgeHTML = feed.useLive ? `
      <div class="live-badge">
        <span class="live-dot"></span>
        <span>LIVE</span>
      </div>` : '';

    card.innerHTML = `
      <div class="card-header-row">
        <div class="feed-main">
          <div class="feed-title">
            <span>${feed.name || 'Custom Watch'}</span>
          </div>
          <div class="feed-watching">
            Watching:
            <strong>${feed.cities.join(', ')}</strong>
          </div>
          <div class="feed-risk">
            ${feed.risk.map(riskPill).join('')}
          </div>
        </div>
        <div class="feed-controls">
          ${liveBadgeHTML}
          <button class="edit-btn" data-edit="${idx}">Edit</button>
        </div>
      </div>

      <div class="feed-body">
        <div class="feed-events" id="events-${idx}">
          <div style="color:#8e97a3;font-size:12px;padding:16px;">
            Loadingâ€¦
          </div>
        </div>
        <div class="feed-footer">
          <span class="src">source: simulated feed</span>
          <span class="ts" id="ts-${idx}">â€”</span>
        </div>
      </div>
    `;

    grid.appendChild(card);

    // attach edit click
    const editBtn = card.querySelector('.edit-btn');
    editBtn.addEventListener('click', ()=>{
      openFeedModal(idx);
    });

  });

  // after building cards, load data
  refreshAllFeeds();
}

async function refreshAllFeeds(){
  const feeds = loadFeeds();
  const nowTs = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  document.getElementById('lastRefresh').textContent = `Last refresh: ${nowTs}`;

  feeds.forEach(async (feed, idx)=>{
    const evWrap = document.getElementById(`events-${idx}`);
    const tsEl = document.getElementById(`ts-${idx}`);
    if(!evWrap || !tsEl) return;

    const events = await fetchEventsForFeed(feed);

    if(!events.length){
      evWrap.innerHTML = `
        <div style="color:#8e97a3;font-size:12px;padding:16px;">
          No recent items.
        </div>
      `;
      tsEl.textContent = nowTs;
      return;
    }

    evWrap.innerHTML = '';
    events.forEach(evt=>{
      const row = document.createElement('div');
      row.className='feed-event-row';
      row.innerHTML = `
        <div class="event-head">
          <span>${evt.city || 'Unknown city'}</span> â€” <span>${evt.title || ''}</span>
        </div>
        <div class="event-meta">
          <span class="city">${evt.city||''}</span>
          <span>${evt.risk||''}</span>
          <span>${timeAgo(evt.when)}</span>
        </div>
      `;
      row.addEventListener('click', ()=>{
        openDrawerForEvent(feed, evt);
      });
      evWrap.appendChild(row);
    });

    tsEl.textContent = nowTs;
  });
}

/* ==================== SAVE FEED (NEW OR EDIT) ==================== */
modalSave.addEventListener('click', ()=>{
  const citiesArr = modalCities.value
    .split(',')
    .map(s=>s.trim())
    .filter(Boolean);

  const riskArr = modalRisk.value
    .split(',')
    .map(s=>s.trim().toLowerCase())
    .filter(Boolean);

  const lbl = modalName.value.trim() || (citiesArr[0] ? `${citiesArr[0]} Watch` : "Custom Watch");

  const liveChecked = modalUseLive.checked;

  if(!citiesArr.length){
    alert("Please enter at least one city/region.");
    return;
  }
  if(!riskArr.length){
    alert("Please enter at least one risk level (high,med,low).");
    return;
  }

  const feeds = loadFeeds();
  const newFeedObj = {
    name: lbl,
    cities: citiesArr,
    risk: riskArr,
    useLive: liveChecked
  };

  if(editingFeedIndex===null){
    // new feed
    feeds.push(newFeedObj);
  } else {
    // update feed
    feeds[editingFeedIndex] = newFeedObj;
  }

  saveFeeds(feeds);
  closeFeedModal();
  renderFeeds();
});

/* "Add Feed" button (new feed) */
document.getElementById('btnAddFeed').addEventListener('click', ()=>{
  openFeedModal(null);
});

/* ==================== FIRST LOAD ==================== */
(function initFeeds(){
  let feeds = loadFeeds();
  if(!feeds.length){
    // seed with 1 default
    feeds = [{
      name:'London + Paris Watch',
      cities:['London','Paris'],
      risk:['high','med','low'],
      useLive:true
    }];
    saveFeeds(feeds);
  }
  renderFeeds();

  // auto-refresh every ~15s
  setInterval(refreshAllFeeds, 15000);
})();
</script>

<!-- auth.js must be loaded before this page runs -->
<script src="auth.js"></script>

</body>
</html>
