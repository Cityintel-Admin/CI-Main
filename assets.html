<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CityIntel â€” Assets & Locations</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="./CityintLogo.jpg">

  <style>
  /* ===== CityIntel theme + components ===== */
  :root{
    --brand-red:#D01616; --brand-black:#0C0C0C;
    --brand-gray-900:#111214; --brand-gray-800:#16171a; --brand-gray-700:#1c1e22;
    --brand-gray-600:#24272c; --brand-gray-500:#2e3238;
    --muted:#8e97a3; --text:#e9edf2; --ok:#33c48d; --warn:#f0b429; --danger:#ff5a5f;
    --card-radius:16px; --shadow:0 8px 24px rgba(0,0,0,0.35);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,var(--brand-gray-900),var(--brand-gray-800));
    color:var(--text); font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  }

  /* Layout */
  .app{
    display:grid; grid-template-columns:260px 1fr; grid-template-rows:60px auto 1fr;
    grid-template-areas:"sidebar topbar" "sidebar main" "sidebar main"; min-height:100vh;
  }
  .sidebar{
    grid-area:sidebar; background:linear-gradient(180deg,var(--brand-black),#131416);
    border-right:1px solid var(--brand-gray-600); display:flex; flex-direction:column; padding:18px 14px; gap:18px;
  }
  .brand{display:flex;align-items:center;gap:10px; padding:8px 10px; border-radius:12px;
    background:linear-gradient(90deg,rgba(208,22,22,0.2),rgba(208,22,22,0));}
  .brand img{width:34px;height:34px;object-fit:contain;border-radius:6px;background:#fff}
  .brand .title{font-weight:700;letter-spacing:.3px}
  nav a{display:flex;align-items:center;gap:10px;color:#e9edf2;text-decoration:none;
    padding:10px 12px;border-radius:10px;border:1px solid transparent}
  nav a:hover{background:#24272c;border-color:#2e3238}
  nav a.active{background:rgba(208,22,22,0.15);border-color:#D01616}

  .topbar{
    grid-area:topbar;background:rgba(255,255,255,0.02);border-bottom:1px solid var(--brand-gray-600);
    display:flex;align-items:center;gap:12px;padding:10px 16px;position:sticky;top:0;z-index:10;backdrop-filter:blur(8px)
  }
  .search{flex:1;display:flex;align-items:center;gap:10px;background:var(--brand-gray-700);
    border:1px solid var(--brand-gray-600);border-radius:12px;padding:8px 12px}
  .search input{flex:1;background:transparent;border:none;outline:none;color:var(--text)}
  .login-btn {
    display:inline-block;
    padding:8px 12px;
    border-radius:999px;
    background:#D01616;
    border:1px solid #9c0f0f;
    color:#fff;
    font-weight:700;
    text-decoration:none;
    white-space:nowrap;
  }
  .login-btn:hover { filter:brightness(1.05); }

  .user { display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:12px; background:var(--brand-gray-700); border:1px solid var(--brand-gray-600); cursor:pointer; }
  .avatar { width:28px;height:28px; background:#fff;color:#000;border-radius:50%; display:grid;place-items:center;font-weight:700; }

  .dropdown {
    position:absolute; right:0; top:calc(100% + 6px);
    background:#1a1c20; border:1px solid var(--brand-gray-600); border-radius:10px;
    padding:6px 0; box-shadow:0 4px 12px rgba(0,0,0,0.4);
    display:none; min-width:140px; z-index:50;
  }
  .dropdown a { display:block; padding:8px 12px; color:var(--text); text-decoration:none; font-size:14px; }
  .dropdown a:hover { background:rgba(255,255,255,0.05); }

  .main{grid-area:main;padding:18px}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}

  /* Cards */
  .card{background:linear-gradient(180deg,#1a1c20,#131417);border:1px solid var(--brand-gray-600);
    border-radius:var(--card-radius);box-shadow:var(--shadow);padding:16px}
  .card h3{margin:0 0 10px 0;font-size:16px;letter-spacing:.2px}

  /* Table */
  table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:12px}
  thead th{text-align:left;font-size:12px;color:var(--muted);background:var(--brand-gray-700);padding:10px;border-bottom:1px solid var(--brand-gray-600)}
  tbody td{padding:10px;border-bottom:1px solid var(--brand-gray-600);font-size:13px}
  tr:hover td{background:rgba(255,255,255,0.02)}

  .badge{
    display:inline-block;
    padding:2px 8px;
    border-radius:999px;
    font-size:11px;
    border:1px solid rgba(255,255,255,0.15);
    background:rgba(255,255,255,0.06);
  }

  .btn{
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--brand-gray-600);
    background:var(--brand-gray-700);
    color:var(--text);
    font-size:13px;
    cursor:pointer;
  }
  .btn:hover{background:#24272c}
  .btn-danger{
    border-color:#5c2b2b;
    background:rgba(92,43,43,0.4);
    color:#ff7a7f;
  }
  .btn-danger:hover{background:rgba(92,43,43,0.8)}

  .form-grid{
    display:grid;
    grid-template-columns:repeat(2, minmax(0,1fr));
    gap:10px;
  }
  .form-grid .full{grid-column:1/-1}
  .field{
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .field label{
    font-size:12px;
    color:var(--muted);
  }
  .field input,
  .field select{
    padding:6px 8px;
    border-radius:8px;
    border:1px solid var(--brand-gray-600);
    background:var(--brand-gray-800);
    color:var(--text);
    font-size:13px;
  }
  .field input:focus,
  .field select:focus{
    outline:none;
    border-color:#D01616;
  }

  .pill-hint{
    font-size:12px;
    color:var(--muted);
    margin-top:6px;
  }

  @media (max-width:1100px){
    .app{grid-template-columns:68px 1fr}
    .brand .title,nav span{display:none}
    .sidebar{padding:14px 10px}
  }
  @media (max-width:880px){
    .grid{grid-template-columns:1fr}
  }


    
/* ===== Mobile layout tweaks ===== */
@media (max-width: 720px) {
  /* Stack layout: topbar, sidebar row, then main content */
  .app{
    grid-template-columns: 1fr;
    grid-template-rows: auto auto 1fr;
    grid-template-areas:
      "topbar"
      "sidebar"
      "main";
  }

  .sidebar{
    border-right: none;
    border-top: 1px solid var(--brand-gray-600);
    flex-direction: row;
    align-items: center;
    gap: 8px;
    padding: 8px;
    overflow-x: auto;
    white-space: nowrap;
  }

  .sidebar nav{
    display: flex;
    flex-wrap: nowrap;
    gap: 8px;
  }

  .sidebar nav a{
    font-size: 12px;
    padding: 6px 10px;
    white-space: nowrap;
  }

  .brand{
    flex-shrink: 0;
  }

  .main{
    padding: 10px;
  }

  .card{
    padding: 12px;
  }

  /* Map + heatmap sizing on small screens */
  #riskMap{
    height: 320px;
  }

  #risk-heatmap .cell{
    width: 72px;
    height: 52px;
    font-size: 10px;
  }

  /* Map toolbar (search + window slider) stack nicely */
  .risk-toolbar{
    flex-direction: column;
    align-items: stretch;
    gap: 6px;
  }
}



    
  </style>
</head>
<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">
        <img src="CityintLogo.jpg" alt="CityIntel Logo" />
        <div class="title">CityIntel</div>
      </div>
      <nav>
        <a href="index.html">Dashboard</a>
        <a href="alerts.html">Alerts</a>
        <a href="events.html">Events</a>
        <a href="live-feed.html">Live Feed</a>
        <a href="test.html">Test Feed</a>
        <a href="brief.html">Intelligence Brief</a>
        <a href="trends.html">Trends & Forecasts</a>
        <a href="reports.html">Reports</a>
        <a href="assets.html" class="active">Assets</a>
        <a href="sources.html">Sources</a>
        <a href="settings.html">Settings</a>
        <a href="about.html">About</a>
      </nav>
    </aside>

    <!-- TOPBAR -->
    <header class="topbar">
      <div class="search">ðŸ”Ž <input placeholder="Search assets, citiesâ€¦" /></div>
      <div id="topActions" style="position:relative"></div>
    </header>

    <!-- MAIN -->
    <main class="main">
      <div class="grid">
        <!-- Left: Assets table -->
        <section class="card" style="grid-column: span 7;">
          <h3>Company Assets</h3>
          <p style="color:var(--muted);margin-top:4px">
            Maintain a live register of offices, plants, data centres, and key locations.
            These will be overlaid on the risk map to show exposure.
          </p>

          <table style="margin-top:10px">
            <thead>
              <tr>
                <th>Name</th>
                <th>City</th>
                <th>Country</th>
                <th>Type</th>
                <th>Lat</th>
                <th>Lon</th>
                <th style="width:80px">Actions</th>
              </tr>
            </thead>
            <tbody id="assetsBody"></tbody>
          </table>
        </section>

        <!-- Right: Asset form -->
        <section class="card" style="grid-column: span 5;">
          <h3>Add / Edit Asset</h3>
          <p class="pill-hint">
            Add critical company locations (HQs, branches, warehouses, plants, data centres, etc.).
            Lat/Lon are optional but required if you want them on the map.
          </p>

          <form id="assetForm" style="margin-top:10px">
            <input type="hidden" id="assetIndex" value="">
            <div class="form-grid">
              <div class="field full">
                <label for="assetName">Asset name</label>
                <input id="assetName" required placeholder="e.g. UK Headquarters">
              </div>
              
          <div class="field full">
          <label for="assetAddress">Address (optional)</label>
          <input id="assetAddress" placeholder="e.g. 731 Lexington Ave, Manhattan">
          </div>        
              
              <div class="field">
                <label for="assetCity">City</label>
                <input id="assetCity" required placeholder="e.g. London">
              </div>
              <div class="field">
                <label for="assetCountry">Country</label>
                <input id="assetCountry" required placeholder="e.g. United Kingdom">
              </div>
              <div class="field">
                <label for="assetType">Type</label>
                <select id="assetType">
                  <option value="office">Office</option>
                  <option value="hq">Headquarters</option>
                  <option value="plant">Plant / Factory</option>
                  <option value="warehouse">Warehouse / DC</option>
                  <option value="data-centre">Data Centre</option>
                  <option value="retail">Retail / Store</option>
                  <option value="other">Other</option>
                </select>
              </div>
              <div class="field">
                <label for="assetLat">Latitude</label>
                <input id="assetLat" type="number" step="0.000001" placeholder="51.5074">
              </div>
              <div class="field">
                <label for="assetLon">Longitude</label>
                <input id="assetLon" type="number" step="0.000001" placeholder="-0.1278">
              </div>

              <!-- Auto-locate button -->
              <div class="field full">
                <button type="button" class="btn" id="geoBtn">Auto-locate from name, city &amp; country</button>
                <div class="pill-hint">
                  Example: "731 Lexington Ave, New York, USA" â€” we'll look up coordinates for you.
                </div>
              </div>
            </div>

            <div style="display:flex;align-items:center;gap:8px;margin-top:14px">
              <button type="submit" class="btn" id="saveBtn">Save asset</button>
              <button type="button" class="btn" id="resetBtn">Clear form</button>
              <button type="button" class="btn btn-danger" id="deleteBtn" style="margin-left:auto;display:none">
                Delete asset
              </button>
            </div>
          </form>
        </section>
      </div>
    </main>
  </div>

  <!-- Active nav highlight (fallback) -->
  <script>
    (function () {
      const here = location.pathname.split("/").pop() || "assets.html";
      document.querySelectorAll("aside.sidebar nav a").forEach(a=>{
        if ((here === "" && a.getAttribute("href")==="index.html") || here === a.getAttribute("href")) {
          a.classList.add("active");
        }
      });
    })();
  </script>

  <!-- Auth + user menu -->
  <script src="auth.js"></script>
  <script>
  (function mountTopActions(){
    function host(){ return document.getElementById('topActions'); }

    function render(){
      const el = host();
      if (!el) return;

      if (!window.CIAuth){ el.innerHTML = ''; return; }

      if (CIAuth.isLoggedIn()){
        const u = CIAuth.who();
        const initials = (u.name||'CI').split(/\s+/).slice(0,2).map(s=>s[0]?.toUpperCase()||'').join('') || 'CI';
        const role = u.role || 'Analyst';
        el.innerHTML = `
          <div class="user" id="userChip" style="display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;background:#1c1e22;border:1px solid #2e3238;cursor:pointer">
            <div class="avatar" style="width:28px;height:28px;background:#fff;color:#000;border-radius:50%;display:grid;place-items:center;font-weight:700">${initials}</div>
            ${role}
          </div>
          <div class="dropdown" id="userMenu">
            <a href="settings.html">Settings</a>
            <a href="profile.html">Profile</a>
            <a href="#" id="logoutLink">Log out</a>
          </div>
        `;

        const chip = document.getElementById('userChip');
        const menu = document.getElementById('userMenu');
        chip.addEventListener('click', ()=> menu.style.display = (menu.style.display==='block'?'none':'block'));
        document.addEventListener('click', e => { if (!el.contains(e.target)) menu.style.display='none'; });
        document.getElementById('logoutLink').addEventListener('click', e=>{
          e.preventDefault();
          CIAuth.logout();
          window.dispatchEvent(new Event('ci:auth:logout'));
          render();
        });

      } else {
        const here = location.pathname.split('/').pop() || 'assets.html';
        const next = encodeURIComponent(here + location.search + location.hash);
        el.innerHTML = `<a class="login-btn" href="login.html?next=${next}">Log in</a>`;
      }
    }

    document.addEventListener('DOMContentLoaded', render);
    window.addEventListener('ci:auth:login', render);
    window.addEventListener('ci:auth:logout', render);
    window.addEventListener('storage', (e)=>{
      if (['ci_user','ci_token'].includes(e.key)) render();
    });

    let tries = 10;
    const t = setInterval(()=>{
      if (--tries <= 0) clearInterval(t);
      render();
    }, 300);
  })();
  </script>

  <script src="admin-links.js"></script>

  <!-- Asset management logic + auto-locate -->
  <script>
  (function assetManager(){
    const STORAGE_KEY = 'ci_assets';

    function seedFromGlobal(){
      return Array.isArray(window.CIAssets) ? window.CIAssets : [];
    }

    function loadAssets(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return seedFromGlobal();
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : seedFromGlobal();
      } catch(e){
        console.warn('Failed to parse ci_assets from localStorage', e);
        return seedFromGlobal();
      }
    }

    function saveAssets(list){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
      }catch(e){
        console.warn('Failed to save ci_assets to localStorage', e);
      }
      // Keep global in sync so other pages (map) can read it
      window.CIAssets = list;
    }

    let assets = loadAssets();

    const tbody      = document.getElementById('assetsBody');
    const form       = document.getElementById('assetForm');
    const idxInput   = document.getElementById('assetIndex');
    const nameInput  = document.getElementById('assetName');
    const addressInput = document.getElementById('assetAddress');
    const cityInput  = document.getElementById('assetCity');
    const countryInp = document.getElementById('assetCountry');
    const typeSelect = document.getElementById('assetType');
    const latInput   = document.getElementById('assetLat');
    const lonInput   = document.getElementById('assetLon');
    const resetBtn   = document.getElementById('resetBtn');
    const deleteBtn  = document.getElementById('deleteBtn');
    const geoBtn     = document.getElementById('geoBtn');

    function renderTable(){
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!assets.length){
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="color:#8e97a3;padding:10px">
              No assets yet. Use the form on the right to add your first location.
            </td>
          </tr>`;
        return;
      }

      assets.forEach((a, idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${a.name || ''}</td>
          <td>${a.city || ''}</td>
          <td>${a.country || ''}</td>
          <td><span class="badge">${a.type || 'asset'}</span></td>
          <td>${typeof a.lat === 'number' ? a.lat.toFixed(4) : '-'}</td>
          <td>${typeof a.lon === 'number' ? a.lon.toFixed(4) : '-'}</td>
          <td>
            <button class="btn" data-action="edit" data-idx="${idx}" style="padding:3px 8px;font-size:11px;">Edit</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function clearForm(){
      idxInput.value = '';
      nameInput.value = '';
      addressInput.value = '';
      cityInput.value = '';
      countryInp.value = '';
      typeSelect.value = 'office';
      latInput.value = '';
      lonInput.value = '';
      deleteBtn.style.display = 'none';
    }

    function fillFormFromAsset(a, idx){
      idxInput.value = String(idx);
      nameInput.value = a.name || '';
      addressInput.value = a.address || '';
      cityInput.value = a.city || '';
      countryInp.value = a.country || '';
      typeSelect.value = a.type || 'office';
      latInput.value = (typeof a.lat === 'number') ? a.lat : '';
      lonInput.value = (typeof a.lon === 'number') ? a.lon : '';
      deleteBtn.style.display = 'inline-block';
    }

    // Handle table edit click
    if (tbody) {
      tbody.addEventListener('click', e=>{
        const btn = e.target.closest('button[data-action="edit"]');
        if (!btn) return;
        const idx = parseInt(btn.getAttribute('data-idx'), 10);
        if (isNaN(idx) || !assets[idx]) return;
        fillFormFromAsset(assets[idx], idx);
      });
    }

    // Auto-locate: use name + city + country to find lat/lon
    if (geoBtn) {
  geoBtn.addEventListener('click', async () => {
    const addr  = addressInput.value.trim();
    const city  = cityInput.value.trim();
    const ctry  = countryInp.value.trim();
    const name  = nameInput.value.trim();

    // Prefer address + city + country
    let parts;
    if (addr) {
      parts = [addr, city, ctry];
    } else {
      // Fallback to name + city + country
      parts = [name, city, ctry];
    }

    parts = parts.filter(Boolean);

    if (!parts.length) {
      alert('Please enter at least city and country first.');
      return;
    }

        const query = parts.join(', ');
        try {
          geoBtn.textContent = 'Locating...';
          geoBtn.disabled = true;

          const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`;
          const res = await fetch(url, {
            headers: { 'Accept': 'application/json' }
          });
          const data = await res.json();
          console.log('Geo result for', query, data);

          if (!Array.isArray(data) || !data.length) {
            alert('Location not found. Try adjusting the address or country.');
          } else {
            const r = data[0];
            latInput.value = Number(r.lat).toFixed(6);
            lonInput.value = Number(r.lon).toFixed(6);
          }
        } catch (err) {
          console.error('Geo lookup failed', err);
          alert('Geocoding error. Please try again.');
        } finally {
          geoBtn.textContent = 'Auto-locate from name, city & country';
          geoBtn.disabled = false;
        }
      });
    }

    // Handle form submit (add / update)
    if (form){
      form.addEventListener('submit', e=>{
        e.preventDefault();
        const idx = idxInput.value === '' ? -1 : parseInt(idxInput.value, 10);

        const base = {
          id: (idx >= 0 && assets[idx] && assets[idx].id) || `asset-${Date.now()}-${Math.random().toString(16).slice(2,6)}`,
          name: nameInput.value.trim(),
          address: addressInput.value.trim(),
          city: cityInput.value.trim(),
          country: countryInp.value.trim(),
          type: typeSelect.value || 'office'
        };

        const lat = parseFloat(latInput.value);
        const lon = parseFloat(lonInput.value);
        if (!isNaN(lat)) base.lat = lat;
        if (!isNaN(lon)) base.lon = lon;

        if (!base.name || !base.city || !base.country){
          alert('Please provide at least name, city and country.');
          return;
        }

        if (idx >= 0 && assets[idx]){
          assets[idx] = Object.assign({}, assets[idx], base);
        } else {
          assets.push(base);
        }

        saveAssets(assets);
        renderTable();
        clearForm();
      });
    }

    // Clear form
    if (resetBtn){
      resetBtn.addEventListener('click', e=>{
        e.preventDefault();
        clearForm();
      });
    }

    // Delete asset
    if (deleteBtn){
      deleteBtn.addEventListener('click', e=>{
        e.preventDefault();
        const idx = idxInput.value === '' ? -1 : parseInt(idxInput.value, 10);
        if (idx < 0 || !assets[idx]) return;
        if (!confirm(`Delete asset "${assets[idx].name}"?`)) return;
        assets.splice(idx,1);
        saveAssets(assets);
        renderTable();
        clearForm();
      });
    }

    // Initial render
    renderTable();
  })();
  </script>
</body>
</html>
