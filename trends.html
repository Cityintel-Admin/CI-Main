<!doctype html>
<html lang="en">
<head>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" crossorigin="anonymous"></script>


  <meta charset="utf-8" />
  <title>CityIntel — Trends & Forecasts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --red:#D01616; --g900:#111214; --g800:#16171a; --g700:#1c1e22; --g600:#2e3238;
      --text:#e9edf2; --muted:#8e97a3; --ok:#33c48d; --warn:#f0b429; --danger:#ff5a5f;
      --radius:16px; --shadow:0 8px 24px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--g900),var(--g800));color:var(--text);
      font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .app{display:grid;grid-template-columns:260px 1fr;grid-template-rows:60px 1fr;
      grid-template-areas:"sidebar topbar" "sidebar main";min-height:100vh}
    .sidebar{grid-area:sidebar;background:linear-gradient(180deg,#0C0C0C,#131416);
      border-right:1px solid var(--g600);display:flex;flex-direction:column;padding:18px 14px;gap:18px}
    .brand{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:12px;
      background:linear-gradient(90deg,rgba(208,22,22,.2),rgba(208,22,22,0))}
    .brand img{width:34px;height:34px;object-fit:contain;border-radius:6px;background:#fff}
    .brand .title{font-weight:700;letter-spacing:.3px}
    nav a{display:flex;align-items:center;gap:10px;color:#e9edf2;text-decoration:none;
      padding:10px 12px;border-radius:10px;border:1px solid transparent}
    nav a:hover{background:#24272c;border-color:#2e3238}
    nav a.active{background:rgba(208,22,22,.15);border-color:var(--red)}
    .topbar{grid-area:topbar;background:rgba(255,255,255,.02);border-bottom:1px solid var(--g600);
      display:flex;align-items:center;gap:12px;padding:10px 16px;position:sticky;top:0;z-index:10;backdrop-filter:blur(8px)}
    .main{grid-area:main;padding:18px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{background:linear-gradient(180deg,#1a1c20,#131417);border:1px solid var(--g600);
      border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .card h3{margin:0 0 10px 0;font-size:16px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--g600);background:var(--g700)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;border:1px solid var(--g600);
      background:var(--g700);color:var(--text);cursor:pointer;text-decoration:none}
    .btn:hover{filter:brightness(1.05)}
    .slider{appearance:none;width:220px;height:6px;border-radius:6px;background:#2a2d33;outline:none}
    .legend{display:flex;gap:12px;align-items:center}
    .dot{width:10px;height:10px;border-radius:2px;display:inline-block}
    svg{width:100%;height:220px;display:block}
    table{width:100%;border-collapse:collapse;margin-top:8px;border-radius:12px;overflow:hidden}
    thead th{background:var(--g700);text-align:left;padding:10px;color:var(--muted)}
    tbody td{padding:10px;border-top:1px solid var(--g600);vertical-align:middle}
    .spark{width:120px;height:28px}
    .badge{display:inline-block;padding:3px 8px;border-radius:999px;font-weight:700;border:1px solid rgba(255,255,255,.15)}
    .badge.low{color:var(--ok);background:rgba(51,196,141,.12);border-color:rgba(51,196,141,.35)}
    .badge.med{color:var(--warn);background:rgba(240,180,41,.12);border-color:rgba(240,180,41,.35)}
    .badge.high{color:var(--danger);background:rgba(255,90,95,.12);border-color:rgba(255,90,95,.35)}
    .link{color:#8fb4ff;text-decoration:none} .link:hover{text-decoration:underline}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .login-btn{display:inline-block;padding:8px 12px;border-radius:999px;background:var(--red);border:1px solid #9c0f0f;color:#fff;font-weight:700;text-decoration:none}
    .user{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;background:var(--g700);border:1px solid var(--g600);cursor:pointer}
    .avatar{width:28px;height:28px;background:#fff;color:#000;border-radius:50%;display:grid;place-items:center;font-weight:700}
    .dropdown{position:absolute;right:0;top:calc(100% + 6px);background:#1a1c20;border:1px solid var(--g600);border-radius:10px;padding:6px 0;box-shadow:0 4px 12px rgba(0,0,0,.4);display:none;min-width:140px;z-index:50}
    .dropdown a{display:block;padding:8px 12px;color:var(--text);text-decoration:none}
    .dropdown a:hover{background:rgba(255,255,255,.05)}

#trendChart {width: 100%;max-height: 320px; /* Try 280–360px depending on preference */
  aspect-ratio: auto 16 / 9; /* optional, helps on wide screens */
}

  .tbtn{cursor:pointer;padding:6px 10px;border-radius:10px;border:1px solid #2e3238;background:#1c1e22;color:#e9edf2}
  .tbtn.active{border-color:#D01616;background:rgba(208,22,22,.12)}


  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <img src="CityintLogo.jpg" alt="CityIntel Logo" />
        <div class="title">CityIntel</div>
      </div>
      <nav>
        <a href="index.html">Dashboard</a>
        <a href="alerts.html">Alerts</a>
        <a href="events.html">Events</a>
        <a href="reports.html">Reports</a>
        <a href="sources.html">Sources & Reliability</a>
        <a href="operationslog.html">Operations Log</a>
        <a class="active" href="trends.html">Trends & Forecasts</a>
        <a href="settings.html">Settings</a>
        <a href="about.html">About</a>
      </nav>
      <div style="margin-top:auto;color:var(--muted);font-size:12px">For information use only — not for redistribution</div>
    </aside>

    <header class="topbar">
      <div style="font-weight:700">Trends & Forecasts</div>
      <div style="margin-left:auto;position:relative" id="topActions"></div>
    </header>

    <main class="main">

<section class="card" style="margin:16px 0">
  <h2 style="margin:0 0 10px">Trend — Actuals, 7-Day Avg, 14-Day Projection</h2>
  <canvas id="trendChart" height="140"></canvas>
<div id="trendControls" style="display:flex;gap:10px;align-items:center;margin:6px 0 10px">
  <label style="display:flex;gap:6px;align-items:center">
    <span>Continent</span>
    <select id="trendContinent">
      <option value="__all">All</option>
      <option>Africa</option>
      <option>Asia</option>
      <option>Europe</option>
      <option>North America</option>
      <option>South America</option>
      <option>Oceania</option>
    </select>
  </label>
  <label style="display:flex;gap:6px;align-items:center">
    <input type="checkbox" id="trendWeighted" checked>
    <span>Weighted (risk-adjusted)</span>
  </label>
</div>
  
<div id="trendControls" style="display:flex;gap:8px;align-items:center;margin:8px 0 4px">
  <span style="color:#8e97a3;font-size:13px">Range:</span>
  <button data-range="90"  class="tbtn">90d</button>
  <button data-range="180" class="tbtn">6m</button>
  <button data-range="365" class="tbtn">12m</button>
  <div style="color:#8e97a3;font-size:12px;margin-top:6px">
    Actual daily counts from your dataset; 7-day moving average; simple projection extends the average forward 14 days.
  </div>
</section>


      <div class="grid">
        <!-- Weekly Volume -->
        <section class="card" style="grid-column: span 12;">
          <div class="row" style="justify-content:space-between">
            <h3 style="margin:0">Weekly Volume (last 12 weeks)</h3>
            <div class="row">
              <label class="row muted" style="gap:6px">
                <input type="checkbox" id="togglePred">
                Include predictive
              </label>
              <div class="legend">
                <span class="dot" style="background:#3a6cf4"></span><span class="muted">Count</span>
                <span class="dot" style="background:#9ab3ff"></span><span class="muted">Forecast (+4w)</span>
              </div>
            </div>
          </div>
          <svg id="volChart" viewBox="0 0 800 220" preserveAspectRatio="none"></svg>
          <div class="muted" id="volCaption"></div>
        </section>

        <!-- Risk Mix + Window Controls -->
        <section class="card" style="grid-column: span 6;">
          <div class="row" style="justify-content:space-between">
            <h3 style="margin:0">Risk Mix</h3>
            <div class="row">
              <div class="muted">Window:</div>
              <input id="winDays" class="slider" type="range" min="7" max="90" step="1" value="30">
              <div class="pill" id="winLabel">30 days</div>
            </div>
          </div>
          <svg id="mixChart" viewBox="0 0 260 220"></svg>
          <div class="legend" style="margin-top:6px">
            <span class="dot" style="background:#33c48d"></span>Low
            <span class="dot" style="background:#f0b429"></span>Med
            <span class="dot" style="background:#ff5a5f"></span>High
          </div>
        </section>

        <!-- Compare (City/Country) -->
        <section class="card" style="grid-column: span 6;">
          <div class="row" style="justify-content:space-between">
            <h3 style="margin:0">Compare (next 30 days)</h3>
            <div class="row">
              <label class="pill" style="display:flex;gap:8px;align-items:center">
                Group by:
                <select id="groupBy" style="background:transparent;border:none;color:var(--text)">
                  <option value="city">City</option>
                  <option value="country">Country</option>
                </select>
              </label>
              <input id="groupFilter" placeholder="Filter…" class="pill" style="border:none;background:var(--g700);color:var(--text)">
              <button class="btn" id="btnReset">Reset</button>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th id="thLabel">City</th>
                <th>Count</th>
                <th>Risk (mode)</th>
                <th>Trend</th>
                <th>Next Event</th>
              </tr>
            </thead>
            <tbody id="groupBody"></tbody>
          </table>
        </section>
      </div>
    </main>
  </div>

  <!-- Data + helpers -->
  <script src="auth.js"></script>
  <script src="filterEvents.js"></script>
  <script src="alerts-data.js"></script>



<script>
(function pageGuard(){
  const NEED_LOGIN = true;          // this page requires a login
  const NEED_SUB = false;           // set to true on pages that require an active sub

  // Must be logged in?
  if (NEED_LOGIN && (!window.CIAuth || !CIAuth.isLoggedIn())) {
    const here = location.pathname.split('/').pop() || 'index.html';
    const next = encodeURIComponent(here + location.search + location.hash);
    location.href = 'login.html?next=' + next;
    return;
  }

  // Must be subscribed?
  if (NEED_SUB) {
    const isSub = localStorage.getItem('ci_subscribed') === 'true';
    if (!isSub) {
      location.href = 'subscribe.html';
      return;
    }
  }
})();
</script>


  
  <script>

(function compatProfileShim(){
  if (!window.CIAuth || !CIAuth.isLoggedIn()) return;
  const u = CIAuth.who(); // {name,email,role}
  if (!u) return;

  // Ensure legacy ci_profile is present for existing UI components
  const legacy = JSON.parse(localStorage.getItem('ci_profile') || '{}');
  if (!legacy.email || legacy.email !== u.email) {
    localStorage.setItem('ci_profile', JSON.stringify({
      name: u.name || 'CityIntel User',
      email: u.email,
      role: (u.role || 'Admin'),   // your two admins are Admins
      is_admin: (u.role || 'Admin').toLowerCase() === 'admin'
    }));
  }

  // Ensure subscription flag exists so old guards don’t redirect to subscribe
  if (localStorage.getItem('ci_subscribed') == null) {
    // If you want a gated trial, flip this to 'false' and set it on payment success.
    localStorage.setItem('ci_subscribed', 'true');
  }
})();





/* CityIntel – Alerts dataset validator (non-destructive) */
(function CIValidate(){
  const data = Array.isArray(window.alertsData) ? window.alertsData : [];
  const okRisk = new Set(['low','medium','high','med','hi']); // we’ll normalize
  const seen = new Set();

  const issues = { missing:[], badRisk:[], badTime:[], duplicates:[], badKeys:[] };
  let valid = 0;

  const normRisk = r => {
    const s = String(r||'').toLowerCase();
    if (s.startsWith('hi')) return 'high';
    if (s.startsWith('me')) return 'medium';
    if (s.startsWith('lo')) return 'low';
    return s;
  };

  const must = ['title','city','country','continent','risk','time','summary'];
  const hasBadKeyCase = (obj) => {
    // warn if we see 'Country'/'Continent' instead of lowercase
    return ('Country' in obj) || ('Continent' in obj);
  };

  data.forEach((a, idx) => {
    // 1) missing fields
    const miss = must.filter(k => !(k in a));
    if (miss.length) issues.missing.push({ index: idx, title: a.title||'', missing: miss.join(', ') });

    // 2) bad key case
    if (hasBadKeyCase(a)) issues.badKeys.push({ index: idx, title: a.title||'', hasCountryKey: !!a.Country, hasContinentKey: !!a.Continent });

    // 3) risk check
    const nr = normRisk(a.risk);
    if (!okRisk.has(nr)) issues.badRisk.push({ index: idx, title: a.title||'', risk:a.risk });

    // 4) time check
    const d = new Date(a.time);
    if (isNaN(d)) issues.badTime.push({ index: idx, title: a.title||'', time:a.time });

    // 5) duplicate check (title|city|ISO-minute)
    const isoMin = isNaN(d) ? '' : new Date(d.getTime() - (d.getSeconds()*1000 + d.getMilliseconds())).toISOString().slice(0,16);
    const key = `${a.title||''}|${(a.city||'').toLowerCase()}|${isoMin}`;
    if (seen.has(key)) issues.duplicates.push({ index: idx, title:a.title||'', city:a.city||'', time: a.time });
    else seen.add(key);

    // final validity
    if (!miss.length && okRisk.has(nr) && !isNaN(d)) valid++;
  });

  const total = data.length;
  console.group('%cCityIntel — Alerts dataset validation','color:#0ff');
  console.log('Total entries:', total);
  console.log('Valid entries:', valid);
  const warn = (name, arr) => { 
    if (arr.length) { console.warn(`${name}: ${arr.length}`); console.table(arr.slice(0,20)); }
    else { console.log(`${name}: 0`); }
  };
  warn('Missing required fields', issues.missing);
  warn('Bad key casing (Country/Continent)', issues.badKeys);
  warn('Bad risk values', issues.badRisk);
  warn('Bad time values', issues.badTime);
  warn('Duplicates (title|city|minute)', issues.duplicates);
  console.groupEnd();

  // Optional quick normalizer (no mutation): preview what % are nonstandard ‘med/hi’
  const nonStd = data.filter(a => ['med','hi'].includes(String(a.risk||'').toLowerCase()));
  if (nonStd.length) {
    console.info(`Risk normalization preview: ${nonStd.length} entries would be normalized to 'medium'/'high'.`);
  }
})();




(function trendPhase5(){
  if (!window.alertsData || !alertsData.length) return;

  const TZ = 'Europe/London';
  const $ = sel => document.querySelector(sel);
  const dayKey = d => new Date(d).toLocaleDateString('en-CA', { timeZone: TZ }); // YYYY-MM-DD
  const parseTime = v => { const d = new Date(v); return isNaN(d) ? null : d; };

  const canvas = document.getElementById('trendChart');
  if (!canvas) return;

  let currentDays = 90; // default
  let chart = null;

  // moving average
  const movAvg = (arr, w=7) => {
    const out = new Array(arr.length).fill(null);
    let sum = 0;
    for (let i=0;i<arr.length;i++){
      sum += arr[i];
      if (i>=w) sum -= arr[i-w];
      out[i] = i < w-1 ? null : +(sum / Math.min(i+1, w)).toFixed(2);
    }
    return out;
  };

  function buildSeries(windowDays){
    const now = new Date();
    const start = new Date(+now - windowDays*864e5);

    const buckets = new Map();
    alertsData.forEach(a=>{
      const dt = parseTime(a.time);
      if (!dt || dt < start || dt > now) return;
      const k = dayKey(dt);
      if (!buckets.has(k)) buckets.set(k, {count:0});
      buckets.get(k).count += 1;
    });

    const days = [];
    for (let i=windowDays; i>=0; i--){
      const d = new Date(+now - i*864e5);
      const k = dayKey(d);
      const row = buckets.get(k) || {count:0};
      days.push({ k, d, count: row.count });
    }
    const totals = days.map(x=>x.count);
    const avg7   = movAvg(totals, 7);

    // simple 14d projection from recent mean
    const recent = totals.slice(-Math.min(14, totals.length)).filter(n=>Number.isFinite(n));
    const lambda = recent.length ? recent.reduce((a,b)=>a+b,0)/recent.length : 0;
    const projLen = 14;
    const projVals = Array.from({length:projLen}, _ => +lambda.toFixed(2));
    const projLabels = Array.from({length:projLen}, (_,i)=>{
      const d = new Date(+now + (i+1)*864e5);
      return new Date(d).toLocaleDateString('en-CA', { timeZone: TZ });
    });

    return {
      labels: days.map(x=>x.k).concat(projLabels),
      actual: totals.concat(Array(projLen).fill(null)),
      avg7:   avg7.concat(Array(projLen).fill(null)),
      proj:   Array(days.length).fill(null).concat(projVals)
    };
  }

  function render(windowDays){
    const series = buildSeries(windowDays);

    if (chart) chart.destroy();
    chart = new Chart(canvas, {
      type: 'line',
      data: {
        labels: series.labels,
        datasets: [
          { label:'Daily (actual)', data:series.actual, borderWidth:2, tension:.2, pointRadius:0 },
          { label:'7-day avg',     data:series.avg7,   borderWidth:2, borderDash:[6,3], tension:.2, pointRadius:0 },
          { label:'Projection (14d)', data:series.proj, borderWidth:2, borderDash:[2,4], tension:.2, pointRadius:0 }
        ]
      },
      options: {
        responsive:true,
        maintainAspectRatio:true,
        aspectRatio:2.2,
        scales:{ x:{ ticks:{ maxRotation:0, autoSkip:true, autoSkipPadding:20 } }, y:{ beginAtZero:true, grace:'10%' } },
        plugins:{ legend:{ labels:{ boxWidth:12, usePointStyle:true, pointStyle:'line' } }, tooltip:{ intersect:false, mode:'index' } }
      }
    });
    // set active button
    document.querySelectorAll('.tbtn').forEach(b=>{
      b.classList.toggle('active', +b.dataset.range === windowDays);
    });
  }

  // wire buttons
  document.querySelectorAll('.tbtn').forEach(b=>{
    b.addEventListener('click', ()=>{
      currentDays = +b.dataset.range;
      render(currentDays);
    });
  });

  // initial
  render(currentDays);
})();



    // ---------- Helpers ----------
    const H = {
      parse(v){ return (window.CIHelpers && CIHelpers.parseWhenAny(v)) || (v?new Date(v):null); },
      riskKey(r){ r=String(r||'').toLowerCase(); if(r.startsWith('hi'))return'high'; if(r.startsWith('me'))return'med'; return'low'; },
      weeksAgo(d, n){ const x = new Date(d); x.setDate(x.getDate() - n*7); return x; },
      startOfWeek(d){ const x = new Date(d); const day = (x.getDay()+6)%7; x.setHours(0,0,0,0); x.setDate(x.getDate()-day); return x; }
    };

    // Normalize dataset once
    const RAW = Array.isArray(window.alertsData) ? window.alertsData : [];
    const NORM = RAW.map(a=>{
      const t = H.parse(a.time || a.datetime || a.date || a.when);
      return { ...a, _dt: t, risk: H.riskKey(a.risk||a.Risk), city: a.city||a.City||'', country: a.Country||a.country||'' };
    }).filter(a=>a._dt);

    // ---------- 1) Weekly Volume + simple forecast ----------
    function weeklyBuckets(list, weeks=12, includePredictive=false){
      const now = new Date();
      const end = H.startOfWeek(now);
      const buckets = [];
      for(let i=weeks-1;i>=0;i--){
        const start = H.weeksAgo(end, i);
        const stop  = H.weeksAgo(end, i-1);
        const n = list.filter(a=>{
          if(!includePredictive && a.predictive===true) return false;
          return a._dt >= start && a._dt < stop;
        }).length;
        buckets.push({label: start.toLocaleDateString('en-GB',{day:'2-digit',month:'short'}), n});
      }
      return buckets;
    }

    // least-squares line y = a + b*x
    function linearFit(y){
      const n = y.length; if(!n) return {a:0,b:0};
      const xs = y.map((_,i)=>i);
      const sx = xs.reduce((s,v)=>s+v,0), sy = y.reduce((s,v)=>s+v,0);
      const sxx = xs.reduce((s,v)=>s+v*v,0), sxy = xs.reduce((s,v,i)=>s+v*y[i],0);
      const denom = (n*sxx - sx*sx) || 1;
      const b = (n*sxy - sx*sy) / denom;
      const a = (sy - b*sx) / n;
      return {a,b};
    }

    function renderAreaWithForecast(svgId, data, forecastHorizon=4){
      const svg = document.getElementById(svgId);
      const W = 800, Hh = 220, pad=20;
      svg.setAttribute('viewBox', `0 0 ${W} ${Hh}`);
      svg.innerHTML = '';
      const counts = data.map(d=>d.n);
      const {a,b} = linearFit(counts);
      const future = Array.from({length:forecastHorizon}, (_,k)=> Math.max(0, Math.round(a + b*(counts.length + k))));
      const all = counts.concat(future);
      const max = Math.max(1, ...all);
      const step = (W - pad*2) / (all.length-1 || 1);

      const yScale = v => (Hh - pad) - (v/max)*(Hh - pad*2);

      // area (historical)
      let dPath = `M ${pad} ${Hh-pad}`;
      counts.forEach((v,i)=>{
        const x = pad + i*step, y = yScale(v);
        dPath += ` L ${x} ${y}`;
      });
      dPath += ` L ${pad + (counts.length-1)*step} ${Hh-pad} Z`;

      const area = document.createElementNS('http://www.w3.org/2000/svg','path');
      area.setAttribute('d', dPath);
      area.setAttribute('fill', 'rgba(58,108,244,0.25)');
      area.setAttribute('stroke', '#3a6cf4');
      area.setAttribute('stroke-width', '2');
      svg.appendChild(area);

      // forecast line (dashed)
      const fStartX = pad + (counts.length-1)*step;
      const fPath = document.createElementNS('http://www.w3.org/2000/svg','path');
      let d2 = `M ${fStartX} ${yScale(counts[counts.length-1])}`;
      future.forEach((v,i)=>{
        const x = pad + (counts.length + i)*step, y = yScale(v);
        d2 += ` L ${x} ${y}`;
      });
      fPath.setAttribute('d', d2);
      fPath.setAttribute('fill','none');
      fPath.setAttribute('stroke','#9ab3ff');
      fPath.setAttribute('stroke-width','2');
      fPath.setAttribute('stroke-dasharray','6 4');
      svg.appendChild(fPath);

      // x labels (sparse, include +w for forecast)
      [...data.map(d=>d.label), ...future.map((_,i)=>`+${i+1}w`)].forEach((lab,i)=>{
        if (i%2!==0) return;
        const x = pad + i*step;
        const tx = document.createElementNS('http://www.w3.org/2000/svg','text');
        tx.setAttribute('x', x); tx.setAttribute('y', Hh-4);
        tx.setAttribute('fill', '#8e97a3'); tx.setAttribute('font-size','10'); tx.setAttribute('text-anchor','middle');
        tx.textContent = lab;
        svg.appendChild(tx);
      });
    }

    // ---------- 2) Risk Mix Donut ----------
    function aggregateWindow(days){
      const now = new Date();
      const end = new Date(now.getTime() + days*86400000);
      const counts = {low:0, med:0, high:0};
      NORM.forEach(a=>{
        if(a._dt >= now && a._dt <= end){ counts[a.risk] = (counts[a.risk]||0)+1; }
      });
      return counts;
    }

    function renderDonut(svgId, counts){
      const svg = document.getElementById(svgId);
      const W=260,Hh=220,cx=130,cy=110,r=70,th=22;
      svg.setAttribute('viewBox', `0 0 ${W} ${Hh}`);
      svg.innerHTML = '';

      const total = Math.max(1, counts.low + counts.med + counts.high);
      const arcs = [
        {k:'low',  v:counts.low,  color:'#33c48d'},
        {k:'med',  v:counts.med,  color:'#f0b429'},
        {k:'high', v:counts.high, color:'#ff5a5f'}
      ].filter(a=>a.v>0);

      let angle= -Math.PI/2;
      const toXY = (ang, rad)=>[cx + Math.cos(ang)*rad, cy + Math.sin(ang)*rad];

      arcs.forEach(a=>{
        const frac = a.v/total;
        const ang2 = angle + frac * Math.PI*2;
        const [x1,y1] = toXY(angle, r);
        const [x2,y2] = toXY(ang2, r);
        const large = frac > .5 ? 1 : 0;

        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        const d = [
          `M ${x1} ${y1}`,
          `A ${r} ${r} 0 ${large} 1 ${x2} ${y2}`,
          `L ${cx + Math.cos(ang2)*(r-th)} ${cy + Math.sin(ang2)*(r-th)}`,
          `A ${r-th} ${r-th} 0 ${large} 0 ${cx + Math.cos(angle)*(r-th)} ${cy + Math.sin(angle)*(r-th)}`,
          'Z'
        ].join(' ');
        path.setAttribute('d', d);
        path.setAttribute('fill', a.color);
        svg.appendChild(path);

        angle = ang2;
      });

      const totalTxt = document.createElementNS('http://www.w3.org/2000/svg','text');
      totalTxt.setAttribute('x', cx); totalTxt.setAttribute('y', cy);
      totalTxt.setAttribute('fill', '#e9edf2'); totalTxt.setAttribute('font-size','18'); totalTxt.setAttribute('font-weight','700'); totalTxt.setAttribute('text-anchor','middle'); totalTxt.textContent = total;
      svg.appendChild(totalTxt);

      const subTxt = document.createElementNS('http://www.w3.org/2000/svg','text');
      subTxt.setAttribute('x', cx); subTxt.setAttribute('y', cy+18);
      subTxt.setAttribute('fill', '#8e97a3'); subTxt.setAttribute('font-size','11'); subTxt.setAttribute('text-anchor','middle'); subTxt.textContent = 'upcoming';
      svg.appendChild(subTxt);
    }

    // ---------- 3) Compare (City/Country) with deep links ----------
    function weeklyBucketsFor(list, weeks=6){
      const end = H.startOfWeek(new Date());
      const out=[];
      for(let i=weeks-1;i>=0;i--){
        const s = H.weeksAgo(end,i), e = H.weeksAgo(end,i-1);
        out.push(list.filter(a=> a._dt>=s && a._dt<e).length);
      }
      return out;
    }

    function groupNext30(byKey='city'){
      const now = new Date();
      const end = new Date(now.getTime()+30*86400000);
      const by = new Map();
      NORM.forEach(a=>{
        if(a._dt >= now && a._dt <= end){
          const k = String(a[byKey]||'').trim();
          if(!k) return;
          if(!by.has(k)) by.set(k, []);
          by.get(k).push(a);
        }
      });
      return by;
    }

    function modeRisk(list){
      const c = {low:0, med:0, high:0};
      list.forEach(a=>c[a.risk]++);
      if(c.high>=c.med && c.high>=c.low) return 'high';
      if(c.med>=c.low) return 'med';
      return 'low';
    }

    function sparkline(vals){
      const W=120,Hh=28,pad=2; const max = Math.max(1, ...vals);
      const step = (W - pad*2) / Math.max(1, vals.length-1);
      const ys = vals.map(v => (Hh-pad) - (v/max)*(Hh - pad*2));
      const xs = vals.map((_,i)=> pad + i*step);
      let d = `M ${xs[0]} ${ys[0]}`;
      for(let i=1;i<xs.length;i++) d += ` L ${xs[i]} ${ys[i]}`;
      return `<svg class="spark" viewBox="0 0 ${W} ${Hh}" preserveAspectRatio="none">
        <path d="${d}" fill="none" stroke="#3a6cf4" stroke-width="2"/>
      </svg>`;
    }

    function renderGroupTable(byKey='city', q=''){
      const th = document.getElementById('thLabel');
      th.textContent = byKey==='city' ? 'City' : 'Country';
      const body = document.getElementById('groupBody');
      body.innerHTML = '';
      const by = groupNext30(byKey);
      const rows = [];
      for(const [label, list] of by){
        if(q && !label.toLowerCase().includes(q.toLowerCase())) continue;
        const count = list.length;
        const rk = modeRisk(list);
        const badge = `<span class="badge ${rk}">${rk[0].toUpperCase()+rk.slice(1)}</span>`;
        const series = weeklyBucketsFor(list, 6);
        const next = list.slice().sort((a,b)=>a._dt-b._dt)[0];
        const nextTxt = next ? `${next.title || ''} — ${next._dt.toLocaleDateString('en-GB',{day:'2-digit',month:'short'})}` : '<span class="muted">—</span>';
        const href = `events.html?q=${encodeURIComponent(label)}`;
        rows.push({label,count,badge,series,nextTxt,href});
      }
      rows.sort((a,b)=>b.count-a.count).slice(0,12).forEach(r=>{
        body.insertAdjacentHTML('beforeend', `
          <tr>
            <td><a class="link" href="${r.href}">${r.label}</a></td>
            <td>${r.count}</td>
            <td>${r.badge}</td>
            <td>${sparkline(r.series)}</td>
            <td>${r.nextTxt}</td>
          </tr>
        `);
      });
    }

    // ---------- Wire UI + Initial renders ----------
    (function init(){
      // Weekly volume + forecast
      const predCb = document.getElementById('togglePred');
      function drawVol(){
        const data = weeklyBuckets(NORM, 12, predCb.checked);
        renderAreaWithForecast('volChart', data, 4);
        const sum = data.reduce((s,x)=>s+x.n,0);
        document.getElementById('volCaption').textContent =
          `${sum} events over last 12 weeks (${predCb.checked?'incl.':'excl.'} predictive) • forecast shows dashed (+4w)`;
      }
      predCb.addEventListener('change', drawVol);
      drawVol();

      // Risk mix
      const win = document.getElementById('winDays');
      const lab = document.getElementById('winLabel');
      function drawMix(){
        const days = parseInt(win.value,10);
        lab.textContent = `${days} days`;
        renderDonut('mixChart', aggregateWindow(days));
      }
      win.addEventListener('input', drawMix);
      drawMix();

      // Compare table
      const groupSel = document.getElementById('groupBy');
      const filt = document.getElementById('groupFilter');
      const drawTable = ()=> renderGroupTable(groupSel.value, filt.value);
      document.getElementById('btnReset').addEventListener('click', ()=>{ filt.value=''; drawTable(); });
      groupSel.addEventListener('change', drawTable);
      filt.addEventListener('input', drawTable);
      drawTable();
    })();

    
/* CityIntel – Trend series with continent filter + weighting */
(function CITrendFilter(){
  const data = Array.isArray(window.alertsData) ? window.alertsData : [];

  // Helpers
  const startOfWeek = (d) => {
    const x=new Date(d); const day=(x.getDay()+6)%7; // Monday=0
    x.setHours(0,0,0,0); x.setDate(x.getDate()-day); return x;
  };
  const fmtYMD = (d) => d.toISOString().slice(0,10);
  const parse = (t) => { const d=new Date(t); return isNaN(d)?null:d; };
  const normContinent = c => String(c||'').trim();
  const normRisk = r => {
    const s = String(r||'').toLowerCase();
    if (s.startsWith('hi')) return 'high';
    if (s.startsWith('me')) return 'medium';
    return 'low';
  };

  const RISK_W = { low:0.5, medium:1.0, high:1.5 }; // tweakable

  function computeSeries({ continent='__all', weighted=true, weeks=12 }) {
    const now = new Date();
    const start = new Date(now);
    start.setDate(start.getDate() - (weeks*7));
    start.setHours(0,0,0,0);

    // build weekly buckets
    const buckets = new Map(); // key: yyyy-mm-dd (Mon), val: { rawCount, weightedSum }
    function ensureBucket(k){ if(!buckets.has(k)) buckets.set(k, { raw:0, w:0 }); return buckets.get(k); }

    data.forEach(a => {
      const d = parse(a.time);
      if (!d || d < start || d > now) return;
      const cont = normContinent(a.continent || a.Continent);
      if (continent !== '__all' && cont !== continent) return;

      const wk = startOfWeek(d);
      const key = fmtYMD(wk);
      const r = normRisk(a.risk);
      const w = weighted ? (RISK_W[r] || 1) : 1;

      const b = ensureBucket(key);
      b.raw += 1;
      b.w += w;
    });

    // sort buckets by date
    const keys = Array.from(buckets.keys()).sort();
    const labels = keys;
    const values = keys.map(k => {
      const b = buckets.get(k);
      return Math.round((weighted ? b.w : b.raw) * 100) / 100;
    });

    return { labels, values, options:{ continent, weighted, weeks } };
  }

  function rerender(){
    const sel = document.getElementById('trendContinent');
    const chk = document.getElementById('trendWeighted');
    const continent = sel ? sel.value : '__all';
    const weighted  = chk ? !!chk.checked : true;

    const series = computeSeries({ continent, weighted, weeks:12 });

    if (typeof window.renderTrendChart === 'function') {
      // Hand off to your existing chart renderer
      window.renderTrendChart(series.labels, series.values, series.options);
    } else {
      // Fallback: console only
      console.group('Trend series (fallback)');
      console.log('Options:', series.options);
      console.log('First 6 points:', series.labels.slice(0,6).map((l,i)=>[l, series.values[i]]));
      console.groupEnd();
    }
  }

  // Wire UI
  document.addEventListener('change', (e)=>{
    if (e.target && (e.target.id === 'trendContinent' || e.target.id === 'trendWeighted')) {
      rerender();
    }
  });

  // Kick off once the page is idle (and your chart code likely loaded)
  (window.requestIdleCallback || window.setTimeout)(rerender, 0);

  // Expose utility if you want to call directly elsewhere
  window.CITrend = { computeSeries, rerender };
})();
  </script>
</body>
</html>






