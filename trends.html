<!doctype html>
<html lang="en">
<head>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" crossorigin="anonymous"></script>


  <meta charset="utf-8" />
  <title>CityIntel â€” Trends & Forecasts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --red:#D01616; --g900:#111214; --g800:#16171a; --g700:#1c1e22; --g600:#2e3238;
      --text:#e9edf2; --muted:#8e97a3; --ok:#33c48d; --warn:#f0b429; --danger:#ff5a5f;
      --radius:16px; --shadow:0 8px 24px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--g900),var(--g800));color:var(--text);
      font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
	  
    .app{display:grid;grid-template-columns:260px 1fr;grid-template-rows:60px 1fr;
      grid-template-areas:"sidebar topbar" "sidebar main";min-height:100vh}
	  
    .sidebar{grid-area:sidebar;background:linear-gradient(180deg,#0C0C0C,#131416);
      border-right:1px solid var(--g600);display:flex;flex-direction:column;padding:18px 14px;gap:18px}
	  
    .brand{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:12px;
      background:linear-gradient(90deg,rgba(208,22,22,.2),rgba(208,22,22,0))}
	  
    .brand img{width:34px;height:34px;object-fit:contain;border-radius:6px;background:#fff}
    .brand .title{font-weight:700;letter-spacing:.3px}
    nav a{display:flex;align-items:center;gap:10px;color:#e9edf2;text-decoration:none;
      padding:10px 12px;border-radius:10px;border:1px solid transparent}
    nav a:hover{background:#24272c;border-color:#2e3238}
    nav a.active{background:rgba(208,22,22,.15);border-color:var(--red)}
	  
    .topbar{grid-area:topbar;background:rgba(255,255,255,.02);border-bottom:1px solid var(--g600);
      display:flex;align-items:center;gap:12px;padding:10px 16px;position:sticky;top:0;z-index:10;backdrop-filter:blur(8px)}

#topActions{margin-left:auto;display:flex; align-items:center; gap:10px;min-width: fit-content;position: relative;}

	  
    .main{grid-area:main;padding:18px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{background:linear-gradient(180deg,#1a1c20,#131417);border:1px solid var(--g600);
      border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .card h3{margin:0 0 10px 0;font-size:16px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--g600);background:var(--g700)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;border:1px solid var(--g600);
      background:var(--g700);color:var(--text);cursor:pointer;text-decoration:none}
    .btn:hover{filter:brightness(1.05)}
    .slider{appearance:none;width:220px;height:6px;border-radius:6px;background:#2a2d33;outline:none}
    .legend{display:flex;gap:12px;align-items:center}
    .dot{width:10px;height:10px;border-radius:2px;display:inline-block}
    svg{width:100%;height:220px;display:block}
    table{width:100%;border-collapse:collapse;margin-top:8px;border-radius:12px;overflow:hidden}
    thead th{background:var(--g700);text-align:left;padding:10px;color:var(--muted)}
    tbody td{padding:10px;border-top:1px solid var(--g600);vertical-align:middle}
    .spark{width:120px;height:28px}
    .badge{display:inline-block;padding:3px 8px;border-radius:999px;font-weight:700;border:1px solid rgba(255,255,255,.15)}
    .badge.low{color:var(--ok);background:rgba(51,196,141,.12);border-color:rgba(51,196,141,.35)}
    .badge.med{color:var(--warn);background:rgba(240,180,41,.12);border-color:rgba(240,180,41,.35)}
    .badge.high{color:var(--danger);background:rgba(255,90,95,.12);border-color:rgba(255,90,95,.35)}
    .link{color:#8fb4ff;text-decoration:none} .link:hover{text-decoration:underline}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .login-btn{display:inline-block;padding:8px 12px;border-radius:999px;background:var(--red);border:1px solid #9c0f0f;color:#fff;font-weight:700;text-decoration:none}
    .user{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;background:var(--g700);border:1px solid var(--g600);cursor:pointer}
    .avatar{width:28px;height:28px;background:#fff;color:#000;border-radius:50%;display:grid;place-items:center;font-weight:700}
    .dropdown{position:absolute;right:0;top:calc(100% + 6px);background:#1a1c20;border:1px solid var(--g600);border-radius:10px;padding:6px 0;box-shadow:0 4px 12px rgba(0,0,0,.4);display:none;min-width:140px;z-index:50}
    .dropdown a{display:block;padding:8px 12px;color:var(--text);text-decoration:none}
    .dropdown a:hover{background:rgba(255,255,255,.05)}

#trendChart {width: 100%;max-height: 320px; /* Try 280â€“360px depending on preference */
  aspect-ratio: auto 16 / 9; /* optional, helps on wide screens */
}

  .tbtn{cursor:pointer;padding:6px 10px;border-radius:10px;border:1px solid #2e3238;background:#1c1e22;color:#e9edf2}
  .tbtn.active{border-color:#D01616;background:rgba(208,22,22,.12)}

	    .brandbar{display:flex;align-items:center;gap:10px;padding:16px 20px;border-bottom:1px solid var(--line);
            background:linear-gradient(90deg,rgba(208,22,22,.2),rgba(208,22,22,0))}
  .brandbar img{width:auto;height:60px;object-fit:contain;border-radius:6px;background:#fff}
  .wrap{max-width:1100px;margin:28px auto;padding:20px}
  .hero{text-align:center;margin:6px 0 18px}
  .hero h1{margin:0 0 6px;font-size:26px;color:var(--brand-red)}
  .hero p{margin:0;color:var(--muted)}
	  

/* --- Risk Mix bar layout --- */
.risk-bar-row{
  display:flex;
  align-items:center;
  gap:10px;
  margin:6px 0;
  font-size:12px;
}

.risk-bar-label{
  width:40px;
  color:#e5e7eb;
  font-weight:500;
}

.risk-bar-track{
  flex:1;
  height:14px;
  border-radius:999px;
  background:#111827;
  overflow:hidden;
  border:1px solid #282c34;
}

.risk-bar-fill{
  height:100%;
  border-radius:999px;
  transition:width .25s ease-out;
}

.risk-bar-high{ background:#ef4444; }  /* red   */
.risk-bar-med { background:#f59e0b; }  /* amber */
.risk-bar-low { background:#22c55e; }  /* green */

.risk-bar-value{
  width:42px;
  text-align:right;
  color:#e5e7eb;
  font-weight:500;
}


/* Risk level pill (lists) */
.risk-pill-chip{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  font-size:11px;
  font-weight:600;
  border:1px solid rgba(255,255,255,.18);
  opacity:0.9;
}

.risk-pill-chip.low{
  color:var(--ok);
  background:rgba(51,196,141,.12);
  border-color:rgba(51,196,141,.35);
}

.risk-pill-chip.med{
  color:var(--warn);
  background:rgba(240,180,41,.12);
  border-color:rgba(240,180,41,.35);
}

.risk-pill-chip.high{
  color:var(--danger);
  background:rgba(255,90,95,.12);
  border-color:rgba(255,90,95,.35);
}

	  
    
  </style>
</head>
<body>

  <div class="brandbar">
    <img src="CityintLogo.jpg" alt="CityIntel Logo">
    <div class="title" style="font-weight:700;font-size:18px">CityIntel</div>
	<div id="trial-banner" style="display:none;position:absolute;
    left:50%; transform:translateX(-50%); background:none;
    color:#fecaca; padding:8px 12px; text-align:center;">
  <span id="trial-text">Your trial ends soon.</span>
</div>	
	  <div id="topActions" style="position:relative"></div>
  </div>


  
  <div class="app">
    <aside class="sidebar">
<div class="section-label"></div>
      <nav>
        <a href="index.html">Dashboard</a>
        <a href="alerts.html">Alerts</a>
        <a href="events.html">Events</a>
		<a href="live-feed.html">Live Feed</a>
	<a href="brief.html">Intelligence Brief</a>
        <a href="reports.html">Reports</a>
	<a class="active" href="trends.html">Trends & Forecasts</a> 
        <a href="sources.html">Sources</a>    
        <a href="settings.html">Settings</a>
        <a href="about.html">About</a>
      </nav>
    </aside>

    <main class="main">
	
      
<section class="card" style="margin:16px 0">
  <h2 style="margin:0 0 10px">Trend â€” Actuals, 7-Day Avg, 14-Day Projection</h2>
  <canvas id="trendChart" height="140"></canvas>
<div id="trendControls" style="display:flex;gap:10px;align-items:center;margin:6px 0 10px">
  <label style="display:flex;gap:6px;align-items:center">
    <span>Continent</span>
    <select id="trendContinent">
      <option value="__all">All</option>
      <option>Africa</option>
      <option>Asia</option>
      <option>Europe</option>
      <option>North America</option>
      <option>South America</option>
      <option>Oceania</option>
    </select>
  </label>
  <label style="display:flex;gap:6px;align-items:center">
    <input type="checkbox" id="trendWeighted" checked>
    <span>Weighted (risk-adjusted)</span>
  </label>
</div>
  
<div id="trendControls" style="display:flex;gap:8px;align-items:center;margin:8px 0 4px">
  <span style="color:#8e97a3;font-size:13px">Range:</span>
  <button data-range="90"  class="tbtn">90d</button>
  <button data-range="180" class="tbtn">6m</button>
  <button data-range="365" class="tbtn">12m</button>
  <div style="color:#8e97a3;font-size:12px;margin-top:6px">
    Actual daily counts from your dataset; 7-day moving average; simple projection extends the average forward 14 days.
  </div>
</section>


      <div class="grid">
        <!-- Weekly Volume -->
        <section class="card" style="grid-column: span 12;">
          <div class="row" style="justify-content:space-between">
            <h3 style="margin:0">Weekly Volume (last 12 weeks)</h3>
            <div class="row">
              <label class="row muted" style="gap:6px">
                <input type="checkbox" id="togglePred">
                Include predictive
              </label>
              <div class="legend">
                <span class="dot" style="background:#3a6cf4"></span><span class="muted">Count</span>
                <span class="dot" style="background:#9ab3ff"></span><span class="muted">Forecast (+4w)</span>
              </div>
            </div>
          </div>
          <svg id="volChart" viewBox="0 0 800 220" preserveAspectRatio="none"></svg>
          <div class="muted" id="volCaption"></div>
        </section>



<section class="card" style="grid-column: span 12;">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:6px;">
    <h3 style="margin:0;">Protests â€” last 30 days</h3>

    <label style="font-size:12px;color:#9ca3af;display:flex;align-items:center;gap:6px;">
      City
      <select id="cityProtestSelect"
              style="background:#050810;border:1px solid #2f3540;border-radius:999px;
                     padding:4px 10px;color:#e5e7eb;font-size:12px;">
        <!-- JS will populate options -->
      </select>
    </label>
  </div>

  <div id="cityProtestsSummary" class="subtext" style="margin-bottom:8px;">
    Loading recent protest activityâ€¦
  </div>

  <div id="cityProtestsList" class="subtext">
    <!-- JS will populate -->
  </div>
</section>



<section class="card" style="grid-column: span 12;">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:6px;">
    <h3 style="margin:0;">Upcoming protests â€” next 30 days</h3>

    <label style="font-size:12px;color:#9ca3af;display:flex;align-items:center;gap:6px;">
      City
      <select id="cityUpcomingSelect"
              style="background:#050810;border:1px solid #2f3540;border-radius:999px;
                     padding:4px 10px;color:#e5e7eb;font-size:12px;">
        <!-- JS will populate options (same set as above) -->
      </select>
    </label>
  </div>

  <div id="cityUpcomingSummary" class="subtext" style="margin-bottom:8px;">
    Loading upcoming protest activityâ€¦
  </div>

  <div id="cityUpcomingList" class="subtext">
    <!-- JS will populate -->
  </div>
</section>

		  
<!-- RISK MIX FOR SELECTED CITY -->
<section class="card" style="grid-column: 1 / -1;">
  <h3 style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
    <span>Risk Mix â€” <span id="riskMixCityLabel">All cities</span></span>
    <span style="font-size:12px;font-weight:400;color:#9ca3af;">
      Window: <span id="riskMixWindowLabel">30 days</span>
    </span>
  </h3>

  <!-- window slider -->
  <div class="row" style="gap:8px;margin:2px 0 10px;">
    <span class="muted" style="font-size:12px;">Adjust window</span>
    <input id="riskWindowSlider"
           type="range"
           min="7" max="90" step="7" value="30"
           class="slider"
           style="max-width:220px;">
  </div>

  <div id="riskMixBody">
    <div id="riskMixBars">
      <div class="risk-bar-row">
        <div class="risk-bar-label">High</div>
        <div class="risk-bar-track">
          <div class="risk-bar-fill risk-bar-high" id="riskBarHigh" style="width:0%"></div>
        </div>
        <div class="risk-bar-value" id="riskPctHigh">0%</div>
      </div>

      <div class="risk-bar-row">
        <div class="risk-bar-label">Med</div>
        <div class="risk-bar-track">
          <div class="risk-bar-fill risk-bar-med" id="riskBarMed" style="width:0%"></div>
        </div>
        <div class="risk-bar-value" id="riskPctMed">0%</div>
      </div>

      <div class="risk-bar-row">
        <div class="risk-bar-label">Low</div>
        <div class="risk-bar-track">
          <div class="risk-bar-fill risk-bar-low" id="riskBarLow" style="width:0%"></div>
        </div>
        <div class="risk-bar-value" id="riskPctLow">0%</div>
      </div>
    </div>

    <div id="riskMixMeta" class="subtext" style="margin-top:10px;">
      0 upcoming protest-related alerts in the next 30 days.
    </div>
  </div>
</section>

      </div>
    </main>
  </div>

  <!-- Data + helpers -->
  <script src="auth.js"></script>
  <script src="filterEvents.js"></script>
  <script src="alerts-data.js"></script>



<script>
(function pageGuard(){
  const NEED_LOGIN = true;          // this page requires a login
  const NEED_SUB = false;           // set to true on pages that require an active sub

  // Must be logged in?
  if (NEED_LOGIN && (!window.CIAuth || !CIAuth.isLoggedIn())) {
    const here = location.pathname.split('/').pop() || 'index.html';
    const next = encodeURIComponent(here + location.search + location.hash);
    location.href = 'login.html?next=' + next;
    return;
  }

  // Must be subscribed?
  if (NEED_SUB) {
    const isSub = localStorage.getItem('ci_subscribed') === 'true';
    if (!isSub) {
      location.href = 'subscribe.html';
      return;
    }
  }
})();
</script>


  
 <script>
(function compatProfileShim(){
  if (!window.CIAuth || !CIAuth.isLoggedIn()) return;
  const u = CIAuth.who();
  if (!u) return;
  localStorage.setItem('ci_profile', JSON.stringify({
    name: u.name || 'CityIntel User',
    email: u.email,
    role: u.role || 'Admin',
    is_admin: (u.role||'').toLowerCase()==='admin'
  }));
  // Do NOT auto-set ci_subscribed here anymore
})();
</script>



<script>

/* CityIntel â€“ Alerts dataset validator (non-destructive) */
(function CIValidate(){
  const data = Array.isArray(window.alertsData) ? window.alertsData : [];
  const okRisk = new Set(['low','medium','high','med','hi']); // weâ€™ll normalize
  const seen = new Set();

  const issues = { missing:[], badRisk:[], badTime:[], duplicates:[], badKeys:[] };
  let valid = 0;

  const normRisk = r => {
    const s = String(r||'').toLowerCase();
    if (s.startsWith('hi')) return 'high';
    if (s.startsWith('me')) return 'medium';
    if (s.startsWith('lo')) return 'low';
    return s;
  };

  const must = ['title','city','country','continent','risk','time','summary'];
  const hasBadKeyCase = (obj) => {
    // warn if we see 'Country'/'Continent' instead of lowercase
    return ('Country' in obj) || ('Continent' in obj);
  };

  data.forEach((a, idx) => {
    // 1) missing fields
    const miss = must.filter(k => !(k in a));
    if (miss.length) issues.missing.push({ index: idx, title: a.title||'', missing: miss.join(', ') });

    // 2) bad key case
    if (hasBadKeyCase(a)) issues.badKeys.push({ index: idx, title: a.title||'', hasCountryKey: !!a.Country, hasContinentKey: !!a.Continent });

    // 3) risk check
    const nr = normRisk(a.risk);
    if (!okRisk.has(nr)) issues.badRisk.push({ index: idx, title: a.title||'', risk:a.risk });

    // 4) time check
    const d = new Date(a.time);
    if (isNaN(d)) issues.badTime.push({ index: idx, title: a.title||'', time:a.time });

    // 5) duplicate check (title|city|ISO-minute)
    const isoMin = isNaN(d) ? '' : new Date(d.getTime() - (d.getSeconds()*1000 + d.getMilliseconds())).toISOString().slice(0,16);
    const key = `${a.title||''}|${(a.city||'').toLowerCase()}|${isoMin}`;
    if (seen.has(key)) issues.duplicates.push({ index: idx, title:a.title||'', city:a.city||'', time: a.time });
    else seen.add(key);

    // final validity
    if (!miss.length && okRisk.has(nr) && !isNaN(d)) valid++;
  });

  const total = data.length;
  console.group('%cCityIntel â€” Alerts dataset validation','color:#0ff');
  console.log('Total entries:', total);
  console.log('Valid entries:', valid);
  const warn = (name, arr) => { 
    if (arr.length) { console.warn(`${name}: ${arr.length}`); console.table(arr.slice(0,20)); }
    else { console.log(`${name}: 0`); }
  };
  warn('Missing required fields', issues.missing);
  warn('Bad key casing (Country/Continent)', issues.badKeys);
  warn('Bad risk values', issues.badRisk);
  warn('Bad time values', issues.badTime);
  warn('Duplicates (title|city|minute)', issues.duplicates);
  console.groupEnd();

  // Optional quick normalizer (no mutation): preview what % are nonstandard â€˜med/hiâ€™
  const nonStd = data.filter(a => ['med','hi'].includes(String(a.risk||'').toLowerCase()));
  if (nonStd.length) {
    console.info(`Risk normalization preview: ${nonStd.length} entries would be normalized to 'medium'/'high'.`);
  }
})();



(function trendPhase5(){
  if (!window.alertsData || !alertsData.length) return;

  const TZ = 'Europe/London';
  const $ = sel => document.querySelector(sel);
  const dayKey = d => new Date(d).toLocaleDateString('en-CA', { timeZone: TZ }); // YYYY-MM-DD
  const parseTime = v => { const d = new Date(v); return isNaN(d) ? null : d; };

  const canvas = document.getElementById('trendChart');
  if (!canvas) return;

  let currentDays   = 90;   // default range
  let chart         = null;
  let currentSeries = null; // holds last computed series for tooltips

  // normalise risk
  const riskKey = r => {
    const s = String(r || '').toLowerCase();
    if (s.startsWith('hi')) return 'high';
    if (s.startsWith('me')) return 'med';
    if (s.startsWith('lo')) return 'low';
    return 'med';
  };

  // moving average
  const movAvg = (arr, w=7) => {
    const out = new Array(arr.length).fill(null);
    let sum = 0;
    for (let i=0;i<arr.length;i++){
      sum += arr[i];
      if (i>=w) sum -= arr[i-w];
      out[i] = i < w-1 ? null : +(sum / Math.min(i+1, w)).toFixed(2);
    }
    return out;
  };

  function buildSeries(windowDays, citySlug) {
    const now   = new Date();
    const start = new Date(+now - windowDays * 864e5);
    const slug  = (citySlug || '').toLowerCase();

    const buckets = new Map();
    alertsData.forEach(a => {
      const dt = parseTime(a.time || a.datetime || a.date || a.when);
      if (!dt || dt < start || dt > now) return;

      if (slug) {
        const aCity = (a.city || a.City || '').toLowerCase();
        if (aCity !== slug) return;
      }

      const k = dayKey(dt);
      if (!buckets.has(k)) {
        buckets.set(k, { count:0, high:0, med:0, low:0 });
      }
      const b = buckets.get(k);
      b.count += 1;

      const rk = riskKey(a.risk || a.Risk);
      if (rk === 'high') b.high++;
      else if (rk === 'med') b.med++;
      else b.low++;
    });

    // build contiguous daily series (including zero days)
    const days = [];
    for (let i=windowDays; i>=0; i--){
      const d  = new Date(+now - i*864e5);
      const k  = dayKey(d);
      const row = buckets.get(k) || { count:0, high:0, med:0, low:0 };
      days.push({ k, d, ...row });
    }

    const totals = days.map(x => x.count);
    const high   = days.map(x => x.high);
    const med    = days.map(x => x.med);
    const low    = days.map(x => x.low);
    const avg7   = movAvg(totals, 7);

    // simple 14d projection from recent mean
    const recent   = totals.slice(-Math.min(14, totals.length)).filter(n => Number.isFinite(n));
    const lambda   = recent.length ? recent.reduce((a,b)=>a+b,0)/recent.length : 0;
    const projLen  = 14;
    const projVals = Array.from({length:projLen}, _ => +lambda.toFixed(2));
    const projLabels = Array.from({length:projLen}, (_,i)=>{
      const d = new Date(+now + (i+1)*864e5);
      return new Date(d).toLocaleDateString('en-CA', { timeZone: TZ });
    });

    return {
      labels: days.map(x=>x.k).concat(projLabels),
      actual: totals.concat(Array(projLen).fill(null)),
      avg7:   avg7.concat(Array(projLen).fill(null)),
      proj:   Array(days.length).fill(null).concat(projVals),
      // risk breakdown only exists for historical days
      high,
      med,
      low
    };
  }

  function render(windowDays){
    const citySlug = (window.ciSelectedCitySlug || '').toLowerCase();
    const series   = buildSeries(windowDays, citySlug);
    currentSeries  = series;

    if (chart) chart.destroy();

    chart = new Chart(canvas, {
      type: 'line',
      data: {
        labels: series.labels,
        datasets: [
          {
            label:'Daily (actual)',
            data: series.actual,
            borderWidth: 2.5,
            tension: .25,
            pointRadius: 0,
            hitRadius: 8,
            borderColor: '#3b82f6'
          },
          {
            label:'7-day avg',
            data: series.avg7,
            borderWidth: 2,
            borderDash: [6,3],
            tension: .25,
            pointRadius: 0,
            hitRadius: 8,
            borderColor: '#a5b4fc'
          },
          {
            label:'Projection (14d)',
            data: series.proj,
            borderWidth: 2,
            borderDash: [2,4],
            tension: .25,
            pointRadius: 0,
            hitRadius: 8,
            borderColor: '#f97316'
          }
        ]
      },
      options: {
        responsive:true,
        maintainAspectRatio:true,
        aspectRatio:2.2,
        scales:{
          x:{ 
            ticks:{ maxRotation:0, autoSkip:true, autoSkipPadding:20 },
            grid:{ display:false }
          },
          y:{
            beginAtZero:true,
            grace:'10%',
            grid:{ color:'rgba(148,163,184,0.25)' }
          }
        },
        plugins:{
          legend:{
            labels:{ boxWidth:12, usePointStyle:true, pointStyle:'line' }
          },
          tooltip:{
            intersect:false,
            mode:'index',
            callbacks:{
              afterBody(ctx){
                if (!currentSeries || !ctx.length) return;
                const idx = ctx[0].dataIndex;

                // Projection area â€“ no per-risk breakdown
                if (idx >= currentSeries.high.length) {
                  return 'Projection only â€” no historical risk breakdown for this point.';
                }

                const h = currentSeries.high[idx] || 0;
                const m = currentSeries.med[idx]  || 0;
                const l = currentSeries.low[idx]  || 0;
                if (!h && !m && !l) return; // all zero

                return `High: ${h} â€¢ Med: ${m} â€¢ Low: ${l}`;
              }
            }
          }
        }
      }
    });

    // set active button
    document.querySelectorAll('.tbtn').forEach(b=>{
      b.classList.toggle('active', +b.dataset.range === windowDays);
    });
  }

  // wire range buttons
  document.querySelectorAll('.tbtn').forEach(b=>{
    b.addEventListener('click', ()=>{
      currentDays = +b.dataset.range;
      render(currentDays);
    });
  });

  // initial
  render(currentDays);

  // allow other code (city selector) to force a redraw with same range
  window.ciRedrawTrend = function () {
    render(currentDays);
  };
})();




    // ---------- Helpers ----------
    const H = {
      parse(v){ return (window.CIHelpers && CIHelpers.parseWhenAny(v)) || (v?new Date(v):null); },
      riskKey(r){ r=String(r||'').toLowerCase(); if(r.startsWith('hi'))return'high'; if(r.startsWith('me'))return'med'; return'low'; },
      weeksAgo(d, n){ const x = new Date(d); x.setDate(x.getDate() - n*7); return x; },
      startOfWeek(d){ const x = new Date(d); const day = (x.getDay()+6)%7; x.setHours(0,0,0,0); x.setDate(x.getDate()-day); return x; }
    };

    // Normalize dataset once
    const RAW = Array.isArray(window.alertsData) ? window.alertsData : [];
    const NORM = RAW.map(a=>{
      const t = H.parse(a.time || a.datetime || a.date || a.when);
      return { ...a, _dt: t, risk: H.riskKey(a.risk||a.Risk), city: a.city||a.City||'', country: a.Country||a.country||'' };
    }).filter(a=>a._dt);

    // ---------- 1) Weekly Volume + simple forecast ----------
        function weeklyBuckets(list, weeks = 12, includePredictive = false, citySlug = '') {
      const now = new Date();
      const end = H.startOfWeek(now);
      const buckets = [];
      const slug = (citySlug || '').toLowerCase();

      for (let i = weeks - 1; i >= 0; i--) {
        const start = H.weeksAgo(end, i);
        const stop  = H.weeksAgo(end, i - 1);
        const n = list.filter(a => {
          if (!includePredictive && a.predictive === true) return false;
          if (slug) {
            const aCity = (a.city || '').toLowerCase();
            if (aCity !== slug) return false;
          }
          return a._dt >= start && a._dt < stop;
        }).length;
        buckets.push({
          label: start.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }),
          n
        });
      }
      return buckets;
    }


    // least-squares line y = a + b*x
    function linearFit(y){
      const n = y.length; if(!n) return {a:0,b:0};
      const xs = y.map((_,i)=>i);
      const sx = xs.reduce((s,v)=>s+v,0), sy = y.reduce((s,v)=>s+v,0);
      const sxx = xs.reduce((s,v)=>s+v*v,0), sxy = xs.reduce((s,v,i)=>s+v*y[i],0);
      const denom = (n*sxx - sx*sx) || 1;
      const b = (n*sxy - sx*sy) / denom;
      const a = (sy - b*sx) / n;
      return {a,b};
    }

    function renderAreaWithForecast(svgId, data, forecastHorizon=4){
      const svg = document.getElementById(svgId);
      const W = 800, Hh = 220, pad=20;
      svg.setAttribute('viewBox', `0 0 ${W} ${Hh}`);
      svg.innerHTML = '';
      const counts = data.map(d=>d.n);
      const {a,b} = linearFit(counts);
      const future = Array.from({length:forecastHorizon}, (_,k)=> Math.max(0, Math.round(a + b*(counts.length + k))));
      const all = counts.concat(future);
      const max = Math.max(1, ...all);
      const step = (W - pad*2) / (all.length-1 || 1);

      const yScale = v => (Hh - pad) - (v/max)*(Hh - pad*2);

      // area (historical)
      let dPath = `M ${pad} ${Hh-pad}`;
      counts.forEach((v,i)=>{
        const x = pad + i*step, y = yScale(v);
        dPath += ` L ${x} ${y}`;
      });
      dPath += ` L ${pad + (counts.length-1)*step} ${Hh-pad} Z`;

      const area = document.createElementNS('http://www.w3.org/2000/svg','path');
      area.setAttribute('d', dPath);
      area.setAttribute('fill', 'rgba(58,108,244,0.25)');
      area.setAttribute('stroke', '#3a6cf4');
      area.setAttribute('stroke-width', '2');
      svg.appendChild(area);

      // forecast line (dashed)
      const fStartX = pad + (counts.length-1)*step;
      const fPath = document.createElementNS('http://www.w3.org/2000/svg','path');
      let d2 = `M ${fStartX} ${yScale(counts[counts.length-1])}`;
      future.forEach((v,i)=>{
        const x = pad + (counts.length + i)*step, y = yScale(v);
        d2 += ` L ${x} ${y}`;
      });
      fPath.setAttribute('d', d2);
      fPath.setAttribute('fill','none');
      fPath.setAttribute('stroke','#9ab3ff');
      fPath.setAttribute('stroke-width','2');
      fPath.setAttribute('stroke-dasharray','6 4');
      svg.appendChild(fPath);

      // x labels (sparse, include +w for forecast)
      [...data.map(d=>d.label), ...future.map((_,i)=>`+${i+1}w`)].forEach((lab,i)=>{
        if (i%2!==0) return;
        const x = pad + i*step;
        const tx = document.createElementNS('http://www.w3.org/2000/svg','text');
        tx.setAttribute('x', x); tx.setAttribute('y', Hh-4);
        tx.setAttribute('fill', '#8e97a3'); tx.setAttribute('font-size','10'); tx.setAttribute('text-anchor','middle');
        tx.textContent = lab;
        svg.appendChild(tx);
      });
    }



    // ---------- Wire UI + Initial renders ----------
      (function init(){
      // Weekly volume + forecast
      const predCb = document.getElementById('togglePred');
      const volCaptionEl = document.getElementById('volCaption');

      function drawVol() {
        const citySlug  = (window.ciSelectedCitySlug  || '').toLowerCase();
        const cityLabel = window.ciSelectedCityLabel || 'all cities';

        const data = weeklyBuckets(NORM, 12, predCb.checked, citySlug);
        renderAreaWithForecast('volChart', data, 4);

        const sum = data.reduce((s, x) => s + x.n, 0);
        if (volCaptionEl) {
          volCaptionEl.textContent =
            `${sum} events in ${cityLabel} over last 12 weeks ` +
            `(${predCb.checked ? 'incl.' : 'excl.'} predictive) â€¢ forecast shows dashed (+4w)`;
        }
      }

      predCb.addEventListener('change', drawVol);
      drawVol();

      // ðŸ”´ NEW: allow other code to force a redraw when city changes
      window.ciRedrawWeeklyVolume = drawVol;


      // Risk mix
      const win = document.getElementById('winDays');
      const lab = document.getElementById('winLabel');
      function drawMix(){
        const days = parseInt(win.value,10);
        lab.textContent = `${days} days`;
        renderDonut('mixChart', aggregateWindow(days));
      }
      win.addEventListener('input', drawMix);
      drawMix();

      // Compare table
      const groupSel = document.getElementById('groupBy');
      const filt = document.getElementById('groupFilter');
      const drawTable = ()=> renderGroupTable(groupSel.value, filt.value);
      document.getElementById('btnReset').addEventListener('click', ()=>{ filt.value=''; drawTable(); });
      groupSel.addEventListener('change', drawTable);
      filt.addEventListener('input', drawTable);
      drawTable();
    })();

    
/* CityIntel â€“ Trend series with continent filter + weighting */
(function CITrendFilter(){
  const data = Array.isArray(window.alertsData) ? window.alertsData : [];

  // Helpers
  const startOfWeek = (d) => {
    const x=new Date(d); const day=(x.getDay()+6)%7; // Monday=0
    x.setHours(0,0,0,0); x.setDate(x.getDate()-day); return x;
  };
  const fmtYMD = (d) => d.toISOString().slice(0,10);
  const parse = (t) => { const d=new Date(t); return isNaN(d)?null:d; };
  const normContinent = c => String(c||'').trim();
  const normRisk = r => {
    const s = String(r||'').toLowerCase();
    if (s.startsWith('hi')) return 'high';
    if (s.startsWith('me')) return 'medium';
    return 'low';
  };

  const RISK_W = { low:0.5, medium:1.0, high:1.5 }; // tweakable

  function computeSeries({ continent='__all', weighted=true, weeks=12 }) {
    const now = new Date();
    const start = new Date(now);
    start.setDate(start.getDate() - (weeks*7));
    start.setHours(0,0,0,0);

    // build weekly buckets
    const buckets = new Map(); // key: yyyy-mm-dd (Mon), val: { rawCount, weightedSum }
    function ensureBucket(k){ if(!buckets.has(k)) buckets.set(k, { raw:0, w:0 }); return buckets.get(k); }

    data.forEach(a => {
      const d = parse(a.time);
      if (!d || d < start || d > now) return;
      const cont = normContinent(a.continent || a.Continent);
      if (continent !== '__all' && cont !== continent) return;

      const wk = startOfWeek(d);
      const key = fmtYMD(wk);
      const r = normRisk(a.risk);
      const w = weighted ? (RISK_W[r] || 1) : 1;

      const b = ensureBucket(key);
      b.raw += 1;
      b.w += w;
    });

    // sort buckets by date
    const keys = Array.from(buckets.keys()).sort();
    const labels = keys;
    const values = keys.map(k => {
      const b = buckets.get(k);
      return Math.round((weighted ? b.w : b.raw) * 100) / 100;
    });

    return { labels, values, options:{ continent, weighted, weeks } };
  }

  function rerender(){
    const sel = document.getElementById('trendContinent');
    const chk = document.getElementById('trendWeighted');
    const continent = sel ? sel.value : '__all';
    const weighted  = chk ? !!chk.checked : true;

    const series = computeSeries({ continent, weighted, weeks:12 });

    if (typeof window.renderTrendChart === 'function') {
      // Hand off to your existing chart renderer
      window.renderTrendChart(series.labels, series.values, series.options);
    } else {
      // Fallback: console only
      console.group('Trend series (fallback)');
      console.log('Options:', series.options);
      console.log('First 6 points:', series.labels.slice(0,6).map((l,i)=>[l, series.values[i]]));
      console.groupEnd();
    }
  }

  // Wire UI
  document.addEventListener('change', (e)=>{
    if (e.target && (e.target.id === 'trendContinent' || e.target.id === 'trendWeighted')) {
      rerender();
    }
  });

  // Kick off once the page is idle (and your chart code likely loaded)
  (window.requestIdleCallback || window.setTimeout)(rerender, 0);

  // Expose utility if you want to call directly elsewhere
  window.CITrend = { computeSeries, rerender };
})();
  </script>

<script>
(function(){
  const API_BASE = 'https://api.cityintelapi.com';
  const bar = document.getElementById('trial-banner');
  const txt = document.getElementById('trial-text');

  function who(){ try { return JSON.parse(localStorage.getItem('ci_profile')||'{}'); } catch { return {}; } }
  function pad(n){ return String(n).padStart(2,'0'); }

  async function getStatus(email){
    const u = new URL(API_BASE + '/api/sub-status');
    u.searchParams.set('email', email);
    const r = await fetch(u);
    if (!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  }

  function startCountdown(endIso){
    const end = new Date(endIso).getTime();
    function tick(){
      const now = Date.now();
      const ms = end - now;
      if (ms <= 0){
        // trial ended â†’ bounce to subscribe
        bar.style.display = 'none';
        location.href = 'subscribe.html?reason=trial_ended';
        return;
      }
      const s = Math.floor(ms/1000);
      const d = Math.floor(s/86400);
      const h = Math.floor((s%86400)/3600);
      const m = Math.floor((s%3600)/60);
      const sec = s%60;
      const parts = [];
      if (d) parts.push(d+'d');
      parts.push(pad(h)+'h', pad(m)+'m', pad(sec)+'s');
      txt.textContent = 'Trial active â€” ends in ' + parts.join(' ');
      bar.style.display = '';
    }
    tick();
    return setInterval(tick, 1000);
  }

  (async function init(){
    const p = who();
    if (!p.email) return; // not logged in

    try{
      const data = await getStatus(p.email);
      if (data.trialEndsAt){
        startCountdown(data.trialEndsAt);
      }
    }catch(e){
      // silent
      console.warn('trial banner error', e);
    }
  })();
})();
</script>

	
<script>
(function mountTopActions(){
  const host = document.getElementById('topActions');
  if (!host) return;

  // Helper: initials from name/email
  const initialsOf = (nameOrEmail='CI') => {
    const s = String(nameOrEmail).trim();
    if (!s) return 'CI';
    if (s.includes('@')) return s[0].toUpperCase();
    const parts = s.split(/\s+/);
    return (parts[0]?.[0]||'C').toUpperCase() + (parts[1]?.[0]||'I').toUpperCase();
  };

  // Logged-in view (CIAuth)
  if (window.CIAuth && CIAuth.isLoggedIn()) {
    const u = CIAuth.who(); // {name,email,role,subscribed?...}
    const initials = initialsOf(u.name || u.email);
    const role = u.role || 'Member';
    const isAdmin = String(role).toLowerCase() === 'admin';

    host.innerHTML = `
      <div class="user" id="userChip" style="cursor:pointer">
        <div class="avatar">${initials}</div>
        ${role}
      </div>
      <div class="dropdown" id="userMenu">
        ${isAdmin ? `<a href="analytics.html">Analytics</a><a href="system-flow.html">System Flow</a><a href="operationslog.html">Operations Log</a>` : ``}
        <a href="settings.html">Manage Billing</a>
        <a href="#" id="logoutLink">Log out</a>
      </div>
    `;

    const chip = document.getElementById('userChip');
    const menu = document.getElementById('userMenu');
    chip.addEventListener('click', () => {
      menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
    });
    document.addEventListener('click', (e) => {
      if (!host.contains(e.target)) menu.style.display = 'none';
    });

    document.getElementById('logoutLink').addEventListener('click', (e) => {
      e.preventDefault();
      try { CIAuth.logout(); } catch(_) {}
      location.href = 'index.html';
    });

  } else {
    // Logged-out view: Login pill with return param
    const here = location.pathname.split('/').pop() || 'index.html';
    const next = encodeURIComponent(here + location.search + location.hash);
    host.innerHTML = `<a class="login-btn" href="login.html?next=${next}">Log in</a>`;
  }
})();
</script>


	
<script>
// --- tiny helper to parse dates safely ---
function ciParseDate(v) {
  if (!v) return null;
  const d = new Date(v);
  return isNaN(d.getTime()) ? null : d;
}

// Basic "does this alert look like a protest?" check
function isProtestyAlert(a) {
  const text = (
    (a.title || '') + ' ' +
    (a.summary || '') + ' ' +
    (a.description || '')
  ).toLowerCase();

  return /protest|march|rally|demonstration|demo/.test(text);
}

// Build a list of cities that have protesty alerts in the last ~90 days
function buildProtestCities() {
  const data = Array.isArray(window.alertsData) ? window.alertsData : [];
  const now  = new Date();
  const from = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000); // 90 days

  const set = new Set();

  data.forEach(a => {
    const dt = ciParseDate(a.time || a.datetime || a.date || a.when);
    if (!dt || dt < from || dt > now) return;
    if (!isProtestyAlert(a)) return;

    const city = (a.city || '').trim();
    if (!city) return;

    set.add(city);
  });

  return Array.from(set).sort((a, b) => a.localeCompare(b));
}



	// normalise risk values (Low / MED / hi etc) â†’ low / med / high
function ciRiskKey(r) {
  const s = String(r || '').toLowerCase();
  if (s.startsWith('hi')) return 'high';
  if (s.startsWith('me')) return 'med';
  if (s.startsWith('lo')) return 'low';
  return 'med'; // sensible default
}

	
// ---------- LAST 30 DAYS ----------
function renderCityProtestsLast30(cityName) {
  const summaryBox = document.getElementById('cityProtestsSummary');
  const listBox    = document.getElementById('cityProtestsList');

  if (!summaryBox || !listBox) return;

  const data = Array.isArray(window.alertsData) ? window.alertsData : [];
  if (!data.length) {
    summaryBox.textContent = 'No feed data is available yet.';
    listBox.textContent    = '';
    return;
  }

  const now  = new Date();
  const from = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000); // last 30 days
  const citySlug = (cityName || '').toLowerCase();

  const matches = data
    .map(a => {
      const dt = ciParseDate(a.time || a.datetime || a.date || a.when);
      return { ...a, _dt: dt };
    })
    .filter(a => a._dt && a._dt >= from && a._dt <= now)
    .filter(a => {
      if (!isProtestyAlert(a)) return false;

      const aCity = (a.city || '').toLowerCase();
      return citySlug && aCity === citySlug;
    })
    .sort((a, b) => b._dt - a._dt); // newest first

  if (!matches.length) {
    summaryBox.textContent =
      `No protest-related alerts for ${cityName} in the last 30 days.`;
    listBox.textContent = '';
    return;
  }

  summaryBox.textContent =
    `${matches.length} protest-related alert${matches.length === 1 ? '' : 's'} in ${cityName} over the last 30 days.`;

  listBox.innerHTML = '';
  matches.slice(0, 8).forEach(a => {
    const row = document.createElement('div');
    row.style.marginBottom = '8px';
    row.style.cursor = 'pointer';

    const when = a._dt.toLocaleString('en-GB', {
      day: '2-digit',
      month: 'short',
      hour: '2-digit',
      minute: '2-digit'
    });

    const riskRaw  = (a.risk || '').toString();
const riskKey  = ciRiskKey(riskRaw);                 // low / med / high
const riskText = riskRaw ? riskRaw.toUpperCase() : 'RISK';
const title    = a.title || 'Protest-related alert';

row.innerHTML = `
  <div style="font-size:13px;font-weight:600;display:flex;justify-content:space-between;align-items:center;">
    <span>${title}</span>
    <span class="risk-pill-chip ${riskKey}">
      ${riskText}
    </span>
  </div>
  <div style="font-size:12px;color:#8e97a3;">
    ${when} â€¢ ${cityName}
  </div>
  <div style="font-size:12px;margin-top:2px;">
    ${(a.summary || '').slice(0, 160)}${(a.summary || '').length > 160 ? 'â€¦' : ''}
  </div>
`;


    const titleForSearch = (a.title || '').trim();
    if (titleForSearch) {
      row.addEventListener('click', () => {
        const url = `incident.html?search=${encodeURIComponent(titleForSearch)}&from=brief`;
        location.href = url;
      });
    }

    listBox.appendChild(row);
  });
}

// ---------- NEXT 30 DAYS ----------
function renderCityUpcomingProtests30(cityName) {
  const summaryBox = document.getElementById('cityUpcomingSummary');
  const listBox    = document.getElementById('cityUpcomingList');

  if (!summaryBox || !listBox) return;

  const data = Array.isArray(window.alertsData) ? window.alertsData : [];
  if (!data.length) {
    summaryBox.textContent = 'No feed data is available yet.';
    listBox.textContent    = '';
    return;
  }

  const now  = new Date();
  const end  = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000); // next 30 days
  const citySlug = (cityName || '').toLowerCase();

  const matches = data
    .map(a => {
      const dt = ciParseDate(a.time || a.datetime || a.date || a.when);
      return { ...a, _dt: dt };
    })
    .filter(a => a._dt && a._dt >= now && a._dt <= end)
    .filter(a => {
      if (!isProtestyAlert(a)) return false;

      const aCity = (a.city || '').toLowerCase();
      return citySlug && aCity === citySlug;
    })
    .sort((a, b) => a._dt - b._dt); // soonest first

  if (!matches.length) {
    summaryBox.textContent =
      `No upcoming protest-related alerts for ${cityName} in the next 30 days.`;
    listBox.textContent = '';
    return;
  }

  summaryBox.textContent =
    `${matches.length} upcoming protest-related alert${matches.length === 1 ? '' : 's'} in ${cityName} over the next 30 days.`;

  listBox.innerHTML = '';
  matches.slice(0, 8).forEach(a => {
    const row = document.createElement('div');
    row.style.marginBottom = '8px';
    row.style.cursor = 'pointer';

    const when = a._dt.toLocaleString('en-GB', {
      day: '2-digit',
      month: 'short',
      hour: '2-digit',
      minute: '2-digit'
    });

    const riskRaw  = (a.risk || '').toString();
const riskKey  = ciRiskKey(riskRaw);
const riskText = riskRaw ? riskRaw.toUpperCase() : 'RISK';
const title    = a.title || 'Upcoming protest';

row.innerHTML = `
  <div style="font-size:13px;font-weight:600;display:flex;justify-content:space-between;align-items:center;">
    <span>${title}</span>
    <span class="risk-pill-chip ${riskKey}">
      ${riskText}
    </span>
  </div>
  <div style="font-size:12px;color:#8e97a3;">
    ${when} â€¢ ${cityName}
  </div>
  <div style="font-size:12px;margin-top:2px;">
    ${(a.summary || '').slice(0, 160)}${(a.summary || '').length > 160 ? 'â€¦' : ''}
  </div>
`;


    const titleForSearch = (a.title || '').trim();
    if (titleForSearch) {
      row.addEventListener('click', () => {
        const url = `incident.html?search=${encodeURIComponent(titleForSearch)}&from=brief`;
        location.href = url;
      });
    }

    listBox.appendChild(row);
  });
}

// ---------- Initialise both cards + keep selectors in sync ----------
document.addEventListener('DOMContentLoaded', () => {
  const pastSelect    = document.getElementById('cityProtestSelect');
  const upcomingSelect = document.getElementById('cityUpcomingSelect');
  const pastSummary   = document.getElementById('cityProtestsSummary');
  const upcomingSummary = document.getElementById('cityUpcomingSummary');

  const cities = buildProtestCities();

  if (!cities.length) {
    if (pastSelect)    pastSelect.innerHTML    = `<option value="">No cities found</option>`;
    if (upcomingSelect) upcomingSelect.innerHTML = `<option value="">No cities found</option>`;
    if (pastSummary)   pastSummary.textContent   = 'No protest-related alerts found in the feed yet.';
    if (upcomingSummary) upcomingSummary.textContent = 'No protest-related alerts found in the feed yet.';
    return;
  }

  const optionsHtml = cities.map(c => {
    const slug = c.toLowerCase();
    return `<option value="${slug}">${c}</option>`;
  }).join('');

  if (pastSelect)    pastSelect.innerHTML    = optionsHtml;
  if (upcomingSelect) upcomingSelect.innerHTML = optionsHtml;

  // Prefer London as default if available
  let defaultCity = cities[0];
  const hasLondon = cities.some(c => c.toLowerCase() === 'london');
  if (hasLondon) defaultCity = cities.find(c => c.toLowerCase() === 'london');

  const defaultSlug = defaultCity.toLowerCase();
  if (pastSelect)    pastSelect.value    = defaultSlug;
  if (upcomingSelect) upcomingSelect.value = defaultSlug;

    
	
	function handleCityChange(slug) {
    const city = cities.find(c => c.toLowerCase() === slug) || slug || 'Selected city';

    // ðŸ”´ NEW: store globally so charts can use it
    window.ciSelectedCitySlug  = slug || '';
    window.ciSelectedCityLabel = city;

    if (pastSelect)    pastSelect.value    = slug;
    if (upcomingSelect) upcomingSelect.value = slug;

    // existing cards
    renderCityProtestsLast30(city);
    renderCityUpcomingProtests30(city);

    // ðŸ”´ NEW: keep risk mix + charts in sync with city
    if (typeof updateRiskMixForCity === 'function') {
      updateRiskMixForCity();
    }
    if (typeof window.ciRedrawWeeklyVolume === 'function') {
      window.ciRedrawWeeklyVolume();
    }
    if (typeof window.ciRedrawTrend === 'function') {
      window.ciRedrawTrend();
    }
  }


  // initial render
  handleCityChange(defaultSlug);

  if (pastSelect) {
    pastSelect.addEventListener('change', () => {
      handleCityChange(pastSelect.value);
    });
  }

  if (upcomingSelect) {
    upcomingSelect.addEventListener('change', () => {
      handleCityChange(upcomingSelect.value);
    });
  }
});
</script>



	<script>
// --- Risk Mix (per selected city + window) --------------------------

// Uses ciParseDate + isProtestyAlert helpers defined just above

function updateRiskMixForCity() {
  const alerts = Array.isArray(window.alertsData) ? window.alertsData : [];
  const citySel   = document.getElementById('cityUpcomingSelect'); // same dropdown as "Upcoming protests â€” next 30 days"
  const winSlider = document.getElementById('riskWindowSlider');

  if (!alerts.length || !citySel) return;

  const citySlug  = (citySel.value || '').toLowerCase();
  const cityLabel =
    citySel.options[citySel.selectedIndex]?.text || 'Selected city';

  const windowDays = winSlider ? parseInt(winSlider.value, 10) || 30 : 30;
  const now  = new Date();
  const end  = new Date(now.getTime() + windowDays * 24 * 60 * 60 * 1000);

  // Filter down to protest-style alerts in this city within the window
  const protests = alerts.filter(a => {
    if (!isProtestyAlert(a)) return false;

    const dt = ciParseDate(a.time || a.datetime || a.date || a.when);
    if (!dt || dt < now || dt > end) return false;

    const aCitySlug = (a.city || '').toLowerCase();
    return aCitySlug === citySlug;
  });

  const total = protests.length;

  const counters = { high: 0, med: 0, low: 0 };
  protests.forEach(a => {
    const r = String(a.risk || '').toLowerCase();
    if (r.startsWith('hi')) counters.high++;
    else if (r.startsWith('me')) counters.med++;
    else counters.low++;
  });

  const pct = key => total ? Math.round((counters[key] / total) * 100) : 0;

  // DOM targets
  const cityLbl  = document.getElementById('riskMixCityLabel');
  const winLbl   = document.getElementById('riskMixWindowLabel');
  const meta     = document.getElementById('riskMixMeta');

  const barHigh  = document.getElementById('riskBarHigh');
  const barMed   = document.getElementById('riskBarMed');
  const barLow   = document.getElementById('riskBarLow');

  const pctHighEl = document.getElementById('riskPctHigh');
  const pctMedEl  = document.getElementById('riskPctMed');
  const pctLowEl  = document.getElementById('riskPctLow');

  if (cityLbl) cityLbl.textContent = cityLabel;
  if (winLbl)  winLbl.textContent  = `${windowDays} days`;

  if (meta) {
    if (!total) {
      meta.textContent =
        `No upcoming protest-related alerts for ${cityLabel} in the next ${windowDays} days.`;
    } else {
      meta.textContent =
        `${total} upcoming protest-related alerts in ${cityLabel} in the next ${windowDays} days ` +
        `(${counters.high} high, ${counters.med} medium, ${counters.low} low).`;
    }
  }

  if (barHigh) barHigh.style.width = pct('high') + '%';
  if (barMed)  barMed.style.width  = pct('med')  + '%';
  if (barLow)  barLow.style.width  = pct('low')  + '%';

  if (pctHighEl) pctHighEl.textContent = pct('high') + '%';
  if (pctMedEl)  pctMedEl.textContent  = pct('med')  + '%';
  if (pctLowEl)  pctLowEl.textContent  = pct('low')  + '%';
}

// Wire up events
document.addEventListener('DOMContentLoaded', () => {
  updateRiskMixForCity();

  const citySel   = document.getElementById('cityUpcomingSelect');
  const winSlider = document.getElementById('riskWindowSlider');

  if (citySel) {
    citySel.addEventListener('change', updateRiskMixForCity);
  }
  if (winSlider) {
    winSlider.addEventListener('input', updateRiskMixForCity);
  }
});
</script>


	
</body>
</html>









