<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CityIntel — Log in</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --brand:#D01616; --brand-dark:#9c0f0f;
      --g900:#111214; --g800:#16171a; --g700:#1c1e22; --g600:#2e3238;
      --text:#e9edf2; --muted:#8e97a3;
      --radius:16px; --pill:999px; --shadow:0 8px 24px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      background:linear-gradient(180deg,var(--g900),var(--g800));
      font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }

    /* Top banner (matches subscribe.html) */
    .bar{
      height:64px;
      background:linear-gradient(90deg,rgba(208,22,22,.2),rgba(208,22,22,0));
      border-bottom:1px solid var(--g600);
      display:flex; align-items:center; gap:10px; padding:0 16px;
      position:sticky; top:0; z-index:10;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .brand img{width:36px;height:36px;object-fit:contain;border-radius:6px;background:#fff}
    .brand b{font-weight:800;letter-spacing:.2px}

    /* Page head */
    .wrap{max-width:900px; margin:28px auto; padding:0 16px}
    .head{text-align:center; margin:8px 0 22px}
    .head h1{margin:0 0 6px 0; font-size:28px; letter-spacing:.2px; color:var(--brand)}
    .head p{margin:0; color:var(--muted)}

    /* Centered card */
    .center{display:grid; place-items:center}
    .card{
      width:min(520px,100%);
      background:linear-gradient(180deg,#1a1c20,#131417);
      border:1px solid var(--g600); border-radius:var(--radius);
      padding:20px; box-shadow:var(--shadow);
    }

    label{display:block; font-size:12px; color:var(--muted); margin:12px 0 6px}
    input{
      width:100%; padding:12px 12px; border-radius:12px;
      border:1px solid var(--g600); background:var(--g700); color:var(--text); outline:none;
    }
    input:focus{border-color:#3a3f47}

    /* Buttons match subscribe (pill + bold red) */
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 16px; border-radius:var(--pill);
      border:1px solid var(--brand-dark);
      background:var(--brand); color:#fff; font-weight:800; cursor:pointer; min-width:130px;
    }
    .btn:disabled{opacity:.65; cursor:not-allowed}
    .ghost{
      border:1px solid var(--g600); background:var(--g700); color:var(--text);
    }
    .row{display:flex; align-items:center; gap:10px; margin-top:16px}

    .err{
      display:none; margin-top:12px;
      color:#fff; background:#5a1f1f; border:1px solid #8d2a2a; padding:10px 12px; border-radius:12px;
    }

    /* Footer row under form */
    .foot{
      display:flex; justify-content:space-between; align-items:center; margin-top:14px;
    }
    .back{
      color:var(--brand); text-decoration:none; font-weight:700;
    }
    .muted{color:var(--muted)}
  </style>
</head>
<body>

  <!-- Banner -->
  <header class="bar">
    <div class="brand">
      <img src="CityintLogo.jpg" alt="CityIntel logo" />
      <b>CityIntel</b>
    </div>
  </header>

  <main class="wrap">
    <div class="head">
      <h1>Log in to CityIntel</h1>
      <p>Access protest intelligence, live alerts, and risk dashboards for your selected regions.</p>
    </div>

    <div class="center">
      <!-- Account card -->
      <section class="card" aria-labelledby="loginTitle">
        <h2 id="loginTitle" style="margin:0 0 8px 0">Account</h2>
        <div id="alreadyIn" class="muted" style="display:none;margin:6px 0 12px">
          You're already signed in — press Continue to proceed.
        </div>

        <form id="loginForm">
          <label for="email">Email</label>
          <input id="email" type="email" autocomplete="username" placeholder="you@cityintel.com" required />

          <label for="password">Password</label>
          <input id="password" type="password" autocomplete="current-password" placeholder="••••••••" required />

          <div class="row">
            <button class="btn" id="btnLogin" type="submit">Log in</button>
            <a class="btn ghost" href="subscribe.html">Subscribe</a>
          </div>

          <div id="loginErr" class="err" role="alert"></div>

          <div class="foot">
            <a class="back" href="index.html">← Back to Dashboard</a>
            <span class="muted">Billing email becomes your login.</span>
          </div>
        </form>
      </section>
    </div>
  </main>

  <!-- Auth + wiring -->
  <script src="auth.js"></script>
  <script>
    (function(){
      const form = document.getElementById('loginForm');
      const btn  = document.getElementById('btnLogin');
      const errB = document.getElementById('loginErr');
      const email= document.getElementById('email');
      const pass = document.getElementById('password');

      function qs(name, def='index.html'){
        try{ const u = new URL(location.href); return u.searchParams.get(name) || def; }catch{ return def; }
      }
      const nextUrl = qs('next','index.html');

      function showErr(msg){ errB.textContent = msg; errB.style.display = 'block'; }
      function clearErr(){ errB.textContent = ''; errB.style.display = 'none'; }

      if (window.CIAuth && CIAuth.isLoggedIn()) {
        document.getElementById('alreadyIn').style.display = 'block';
        btn.textContent = 'Continue';
      }

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        clearErr();
        btn.disabled = true; btn.textContent = (CIAuth && CIAuth.isLoggedIn()) ? 'Continuing…' : 'Signing in…';
        try{
          if (!CIAuth || !CIAuth.login) throw new Error('Auth not available.');
          if (!CIAuth.isLoggedIn()) {
            await CIAuth.login(email.value, pass.value);
          }
          location.href = nextUrl;
        } catch(err){
          showErr(err?.message || 'Login failed.');
          btn.disabled = false; btn.textContent = 'Log in';
        }
      });
    })();
  </script>
</body>
</html>
