<!doctype html>
<html lang="en">
<head>

<script>
  (function(){
    const isSub = localStorage.getItem('ci_subscribed') === 'true';
    if (!isSub) {
      // Not subscribed → redirect back to settings
      location.replace('settings.html');
    }
  })();
</script>

  <meta charset="utf-8" />
  <title>CityIntel — Unsubscribe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --brand-red:#D01616; --brand-black:#0C0C0C;
      --g900:#111214; --g800:#16171a; --g700:#1c1e22; --g600:#24272c; --g500:#2e3238;
      --text:#e9edf2; --muted:#8e97a3; --ok:#33c48d; --warn:#f0b429; --danger:#ff5a5f;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:linear-gradient(180deg,var(--g900),var(--g800)); color:var(--text);
      min-height:100vh; display:grid; place-items:center; padding:20px;
    }
    .card{
      width:100%; max-width:680px; background:#16171a; border:1px solid var(--g600);
      border-radius:var(--radius); padding:22px;
      box-shadow:0 12px 32px rgba(0,0,0,.35);
    }
    .brand{
      display:flex; align-items:center; gap:12px; margin-bottom:8px;
    }
    .brand img{ width:34px; height:34px; background:#fff; border-radius:8px; object-fit:contain }
    h1{ font-size:22px; margin:8px 0 12px 0 }
    p.lead{ color:#cbd5e1; margin:0 0 16px 0 }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    label{ display:block; font-size:12px; color:#8e97a3; margin-bottom:6px }
    input, select, textarea{
      width:100%; background:#1c1e22; color:var(--text); border:1px solid #24272c;
      border-radius:10px; padding:10px 12px; outline:none;
    }
    textarea{ min-height:92px; resize:vertical }
    .muted{ color:#8e97a3; font-size:12px }
    .warn{
      background:rgba(255,90,95,.12); border:1px solid rgba(255,90,95,.35);
      color:#ff5a5f; padding:10px 12px; border-radius:10px; margin:10px 0 6px;
    }
    .actions{ display:flex; gap:10px; margin-top:14px; flex-wrap:wrap }
    .btn{
      display:inline-block; padding:10px 14px; border-radius:999px; border:1px solid var(--g500);
      color:#e9edf2; text-decoration:none; background:#1c1e22;
    }
    .btn:hover{ border-color:#D01616 }
    .btn-danger{ background:#D01616; border-color:#9c0f0f; color:#fff }
    .btn-danger:hover{ filter:brightness(1.05) }
    .btn-ghost{ background:transparent }
    .center{ text-align:center }
    .divider{ height:1px; background:#24272c; margin:16px 0 }
    .footer-note{ color:#8e97a3; font-size:12px; text-align:center; margin-top:10px }
    .success{
      display:none; text-align:center;
      background:rgba(51,196,141,.12); border:1px solid rgba(51,196,141,.35);
      color:#33c48d; padding:12px; border-radius:10px; margin-top:14px;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="brand">
      <img src="CityintLogo.jpg" alt="CityIntel logo">
      <strong>CityIntel</strong>
    </div>
    <h1>Manage Subscription — Unsubscribe</h1>
    <p class="lead">
      You’re about to cancel access to subscriber-only content. You’ll still be able to view the free Dashboard.
    </p>

    <div class="warn">Unsubscribing will remove your access immediately.</div>

    <form id="unsubForm" novalidate>
      <div class="row">
        <div>
          <label for="email">Email</label>
          <input id="email" name="email" type="email" placeholder="you@example.com" required />
        </div>
        <div>
          <label for="reason">Reason (optional)</label>
          <select id="reason" name="reason">
            <option value="">Prefer not to say</option>
            <option value="cost">Cost</option>
            <option value="value">Not enough value</option>
            <option value="features">Missing features</option>
            <option value="other">Other</option>
          </select>
        </div>
      </div>

      <div style="margin-top:12px">
        <label for="notes">Additional feedback (optional)</label>
        <textarea id="notes" name="notes" placeholder="Tell us what would make CityIntel more useful for you…"></textarea>
      </div>

      <div class="divider"></div>

      <div class="muted">
        After unsubscribing, you can re-subscribe any time from <em>Settings</em>.
      </div>

      <div class="actions">
        <button type="button" class="btn" id="cancelBtn">Cancel</button>
        <button type="submit" class="btn btn-danger">Unsubscribe</button>
      </div>

      <div id="done" class="success">You’ve been unsubscribed. Redirecting…</div>
    </form>

    <div class="footer-note">For information use only — not for redistribution</div>
  </div>

  <script src="metrics.js"></script>
  <script>
    (function(){
      // Prefill email from stored profile
      try{
        const p = JSON.parse(localStorage.getItem('ci_profile') || '{}');
        if (p && p.email) document.getElementById('email').value = p.email;
      }catch(e){}

      // Cancel → back to Settings
      document.getElementById('cancelBtn').addEventListener('click', function(){
        location.href = 'settings.html';
      });

      // Handle submit
      document.getElementById('unsubForm').addEventListener('submit', function(e){
        e.preventDefault();

        const email = (document.getElementById('email').value || '').trim().toLowerCase();
        if (!email) {
          alert('Please enter your email to confirm.');
          return;
        }
        const reason = document.getElementById('reason').value || '';
        const notes  = document.getElementById('notes').value || '';

        // Metrics (best-effort)
        try {
          if (window.CIMetrics && CIMetrics.logCancel) {
            CIMetrics.logCancel({ email: email, reason: reason, notes: notes });
          }
        } catch(e){ /* ignore */ }

        // Flip subscription flag (keep profile so they can log in again)
        localStorage.setItem('ci_subscribed', 'false');

        // Small UX: show success then redirect to freeview Dashboard
        const done = document.getElementById('done');
        done.style.display = 'block';
        setTimeout(()=>{ location.href = 'index.html'; }, 1200);
      });
    })();
  </script>
</body>
</html>