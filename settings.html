<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CityIntel — Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Core scripts (load early so user chip and guards work) -->
  <script src="auth.js"></script>
  <script src="admin-links.js"></script>

  <style>
    :root{
      --brand-red:#D01616;--gray-900:#111214;--gray-800:#16171a;--gray-700:#1c1e22;--gray-600:#24272c;--gray-500:#2e3238;
      --text:#e9edf2;--muted:#8e97a3;--ok:#33c48d;--warn:#f0b429;--danger:#ff5a5f;
    }
    body{margin:0;font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
         background:linear-gradient(180deg,var(--gray-900),var(--gray-800));color:var(--text)}
    .app{display:grid;grid-template-columns:260px 1fr;grid-template-rows:60px 1fr;
         grid-template-areas:"sidebar topbar" "sidebar main";min-height:100vh}
    .sidebar{grid-area:sidebar;background:#0C0C0C;border-right:1px solid var(--gray-600);
             display:flex;flex-direction:column;padding:18px 14px;gap:18px}
    .brand{display:flex;align-items:center;gap:10px;padding:8px 10px;background:rgba(208,22,22,.1);border-radius:12px}
    .brand img{width:34px;height:34px;background:#fff;border-radius:6px;object-fit:contain}
    nav a{display:flex;align-items:center;padding:10px 12px;border-radius:10px;text-decoration:none;color:var(--text);border:1px solid transparent}
    nav a:hover{background:#24272c;border-color:#2e3238}
    nav a.active{background:rgba(208,22,22,.15);border-color:var(--brand-red)}
    .footnote{margin-top:auto;color:var(--muted);font-size:12px}
    .topbar{grid-area:topbar;background:rgba(255,255,255,.02);border-bottom:1px solid var(--gray-600);
            display:flex;align-items:center; gap:12px;padding:10px 16px;gap:10px;position:sticky;top:0;z-index:10}
    #topActions{margin-left:auto;display:flex;align-items:center;gap:12px;min-width:fit-content;position:relative}
    .main{grid-area:main;padding:20px}
    .card{background:linear-gradient(180deg,#1a1c20,#131417);border:1px solid var(--gray-600);border-radius:16px;padding:16px;margin-bottom:20px}

    /* Pills (branding) */
    .pill-btn{display:inline-block;padding:12px 28px;border-radius:9999px;border:1px solid #9c0f0f;
              background:#D01616;color:#fff;font-weight:700;text-decoration:none;cursor:pointer}
    .pill-btn:hover{filter:brightness(1.05)}
    .pill-btn.neutral{background:#fff;border-color:#ccc;color:#111}        /* Logout (white) */
    .pill-btn.warning{background:#f0b429;border-color:#c08f22;color:#111}  /* Forgotten Password (amber) */
    .pill-btn.change{background:#ff7a1a;border-color:#c85f10;color:#111}   /* Change Password (orange) */
    .pill-btn.success{background:#66ff00;border-color:#3bb300;color:#111}  /* Manage Billing (green) */
    .pill-btn.danger{background:#ff5a5f;border-color:#d34b4f;color:#111}   /* Subscribe (red) */

    /* User chip + dropdown (shared look) */
    .user{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;background:#1c1e22;border:1px solid #24272c;cursor:pointer}
    .avatar{width:28px;height:28px;background:#fff;color:#000;border-radius:50%;display:grid;place-items:center;font-weight:700}
    .login-btn{display:inline-block;padding:8px 12px;border-radius:999px;background:#D01616;border:1px solid #9c0f0f;color:#fff;font-weight:700;text-decoration:none;white-space:nowrap}
    .dropdown{position:absolute;right:0;top:calc(100% + 6px);background:#1a1c20;border:1px solid #24272c;border-radius:10px;padding:6px 0;
              box-shadow:0 4px 12px rgba(0,0,0,.4);display:none;min-width:160px;z-index:50}
    .dropdown a{display:block;padding:8px 12px;color:#e9edf2;text-decoration:none;font-size:14px}
    .dropdown a:hover{background:rgba(255,255,255,.05)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:800px){.row{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand"><img src="CityintLogo.jpg" alt="Logo"/><div>CityIntel</div></div>
      <nav>
        <a href="index.html">Dashboard</a>
        <a href="alerts.html">Alerts</a>
        <a href="events.html">Events</a>
        <a href="brief.html">Intelligence Brief</a>
        <a href="incident.html">Incident Drilldown</a>
        <a href="reports.html">Reports</a>
        <a href="trends.html">Trends & Forecasts</a>
        <a href="sources.html">Sources</a>
        <a href="settings.html" class="active">Settings</a>
        <a href="about.html">About</a>
      </nav>
      <div class="footnote">For information use only — not for redistribution</div>
    </aside>

    <header class="topbar">
      <h3 style="margin:0">Settings</h3>
      <div style="margin-left:auto"><a href="index.html" style="color:#e9edf2;text-decoration:none;border:1px solid var(--g600);padding:6px 10px;border-radius:10px">Back to Dashboard</a></div>
    </header>

    <main class="main">
      <section class="card" style="margin-bottom:16px">
        <h2 style="margin:0 0 6px">Account</h2>
        <div id="who" style="color:#8e97a3">Loading…</div>
      </section>

      <section class="card">
        <h3 style="margin:0 0 10px">Billing</h3>
        <p class="muted" style="color:#8e97a3">Update card, invoices, cancel or resume your plan.</p>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="pill-btn primary" id="btnBilling">Manage Billing</button>
          <button class="pill-btn neutral" id="btnLogout">Log Out</button>
        </div>
      </section>
    </main>
  </div>

  <script src="auth.js"></script>
  <script src="admin-links.js"></script>

  <script>
    // Show who is logged in
    (function showWho(){
      try {
        const el = document.getElementById('who');
        const me = (window.CIAuth && CIAuth.who()) || null;
        if (!me) { el.textContent = 'Not logged in.'; return; }
        el.textContent = `${me.name || me.email} • ${me.role || 'Analyst'}`;
      } catch(e){}
    })();

    // Manage Billing -> call Worker to create portal session
    (function wireBilling(){
      const btn = document.getElementById('btnBilling');
      if (!btn) return;
      btn.addEventListener('click', async ()=>{
        try {
          const me = CIAuth.who();
          if (!me?.email) { alert('Please log in first.'); return; }
          // API_BASE is defined inside auth.js; fallback here if needed:
          const API_BASE = (window.API_BASE) || 'https://cityintel-api.cityintel2.workers.dev';
          const res = await fetch(`${API_BASE}/api/portal-session`, {
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify({
              email: me.email,
              return_url: location.origin + location.pathname  // come back here
            })
          });
          if (!res.ok) throw new Error(await res.text());
          const data = await res.json();
          if (data?.url) location.href = data.url;
          else throw new Error('No portal URL returned');
        } catch(e){
          console.error('Manage billing click failed:', e);
          alert('Unexpected error. Please try again.');
        }
      });
    })();

    // Log out button
    (function wireLogout(){
      const btn = document.getElementById('btnLogout');
      if (!btn) return;
      btn.addEventListener('click', (e)=>{
        e.preventDefault();
        try { CIAuth.logout(); } catch(_) {}
        location.href = 'index.html';
      });
    })();

    // Optional: refresh sub state on load so UI reflects portal changes
    (async function refreshOnLoad(){
      try { if (window.CIAuth && CIAuth.isLoggedIn()) await CIAuth.refreshSubStatus(); } catch(e){}
    })();
  </script>

  <!-- Top-right user chip (shared pattern) -->
  <script>
  (function mountTopActions(){
    const host = document.getElementById('topActions');
    if (!host) return;

    const initialsOf = (s='CI') => {
      s = String(s||'').trim();
      if (!s) return 'CI';
      if (s.includes('@')) return s[0].toUpperCase();
      const p = s.split(/\s+/); return (p[0]?.[0]||'C').toUpperCase()+(p[1]?.[0]||'I').toUpperCase();
    };

    if (window.CIAuth && CIAuth.isLoggedIn()) {
      const u = CIAuth.who(); const initials = initialsOf(u.name||u.email); const role = u.role||'Member';
      const isAdmin = String(role).toLowerCase()==='admin';
      host.innerHTML = \`
        <div class="user" id="userChip"><div class="avatar">\${initials}</div>\${role}</div>
        <div class="dropdown" id="userMenu">
          \${isAdmin?'<a href="analytics.html">Analytics</a><a href="system-flow.html">System Flow</a><a href="operationslog.html">Operations Log</a>':''}
          <a href="settings.html">Manage Billing</a>
          <a href="#" id="logoutLink">Log out</a>
        </div>\`;
      const chip=document.getElementById('userChip'), menu=document.getElementById('userMenu');
      chip.addEventListener('click',()=>{menu.style.display=(menu.style.display==='block')?'none':'block';});
      document.addEventListener('click',(e)=>{ if(!host.contains(e.target)) menu.style.display='none'; });
      document.getElementById('logoutLink').addEventListener('click',(e)=>{ e.preventDefault(); try{CIAuth.logout();}catch{} location.href='index.html'; });
    } else {
      const here = location.pathname.split('/').pop()||'index.html';
      const next = encodeURIComponent(here + location.search + location.hash);
      host.innerHTML = \`<a class="login-btn" href="login.html?next=\${next}">Log in</a>\`;
    }
  })();
  </script>
</body>
</html>
