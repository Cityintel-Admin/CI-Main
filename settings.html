<!doctype html>
<html lang="en">
<head>

<script src="metrics.js"></script>
<script src="auth.js"></script>

	<script>
(function compatProfileShim(){
  if (!window.CIAuth || !CIAuth.isLoggedIn()) return;
  const u = CIAuth.who(); // {name,email,role}
  if (!u) return;

  // Ensure legacy ci_profile is present for existing UI components
  const legacy = JSON.parse(localStorage.getItem('ci_profile') || '{}');
  if (!legacy.email || legacy.email !== u.email) {
    localStorage.setItem('ci_profile', JSON.stringify({
      name: u.name || 'CityIntel User',
      email: u.email,
      role: (u.role || 'Admin'),   // your two admins are Admins
      is_admin: (u.role || 'Admin').toLowerCase() === 'admin'
    }));
  }

  // Ensure subscription flag exists so old guards don’t redirect to subscribe
  if (localStorage.getItem('ci_subscribed') == null) {
    // If you want a gated trial, flip this to 'false' and set it on payment success.
    localStorage.setItem('ci_subscribed', 'true');
  }
})();
</script>

	

  <meta charset="utf-8" />
  <title>CityIntel — Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--brand-red:#D01616;--gray-900:#111214;--gray-800:#16171a;--gray-700:#1c1e22;--gray-600:#24272c;--gray-500:#2e3238;--text:#e9edf2}
    body{margin:0;font:14px/1.5 system-ui;background:linear-gradient(180deg,var(--gray-900),var(--gray-800));color:var(--text)}
    .app{display:grid;grid-template-columns:260px 1fr;grid-template-rows:60px 1fr;grid-template-areas:"sidebar topbar" "sidebar main";min-height:100vh}
    .sidebar{grid-area:sidebar;background:#0c0c0c;border-right:1px solid var(--gray-600);display:flex;flex-direction:column;padding:18px 14px;gap:18px}
    .brand{display:flex;align-items:center;gap:10px;padding:8px 10px;background:rgba(208,22,22,0.1);border-radius:12px}
    .brand img{width:34px;height:34px;background:#fff;border-radius:6px}
    nav a{display:flex;align-items:center;padding:10px 12px;border-radius:10px;text-decoration:none;color:var(--text);border:1px solid transparent}
    nav a:hover{background:var(--gray-600);border-color:var(--gray-500)}
    nav a.active{background:rgba(208,22,22,0.15);border-color:var(--brand-red)}
    .sidebar .footnote{margin-top:auto;font-size:12px;color:#8e97a3}
    .topbar{grid-area:topbar;background:rgba(255,255,255,0.02);border-bottom:1px solid var(--gray-600);display:flex;align-items:center;padding:10px 16px}
    
#topActions{margin-left:auto;display:flex; align-items:center; gap:12px;min-width: fit-content;position: relative;}

    .main{grid-area:main;padding:20px}
    .card{background:#16171a;border:1px solid var(--gray-600);border-radius:16px;padding:16px;margin-bottom:20px}
    label{display:block;margin:10px 0 6px;color:#8e97a3}
    input,select{background:#1c1e22;border:1px solid var(--gray-600);color:var(--text);border-radius:10px;padding:8px 10px;width:100%}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:800px){.row{grid-template-columns:1fr}}
    .pill-btn {display:inline-block;padding:12px 32px;border-radius:9999px;background:var(--brand-red);border:1px solid #9c0f0f;color:#fff;font-weight:700;
  text-decoration:none;margin:6px 6px 0 0;cursor:pointer;flex:1;}
.pill-btn:hover { filter:brightness(1.05); }
.pill-btn.danger { color:#1a1c20; background:#D01616; border-color:#4a1f1f; }
.pill-btn.primary { background:#D01616; border-color:#9c0f0f }    /* (if you need a primary) */
.pill-btn.warning { color:#1a1c20; background:#ffff00; border-color:#ffff00 } /* Forgotten Password */
.pill-btn.change { color:#1a1c20; background:#ff5f1f; border-color:#ff5f1f } /* change Password */
.pill-btn.success  { color:#1a1c20; background:#66ff00; border-color:#66ff00 }      /* Manage Billing (green) */
.pill-btn.neutral { background:#ffffff; color:#1a1c20; border:1px solid #ccc;  /* light grey border for contrast */
}

         /* space between buttons */
  

.btn-row {display:flex;gap:12px;margin-top: 16px;}              /* space between buttons */
  
.pill-btn .pill {flex: 1;text-align: center;padding: 10px 0;border-radius: 20px;                /* makes all buttons equal width */ /* centers the text inside */          
 border: 1px solid var(--g500);text-decoration: none;color: var(--text);background: var(--g700);
  transition: background .2s;}

.btn-row .pill:hover {background: var(--g600);}

.btn-row .pill.green {background: #33c48d;color: #fff;}

.btn-row .pill.red {background: #ff5a5f;color: #fff;}


.forgot-box {
  margin-top:14px; padding:12px; border:1px solid var(--brand-gray-600);
  border-radius:12px; background:#1a1c20; display:none;
}
.forgot-box label { display:block; margin:10px 0 6px; color:var(--muted) }
.forgot-box input {
  width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--brand-gray-600);
  background:#1c1e22; color:var(--text); outline:none;
}
/* Inputs for password form */
.pw-form label {display:block;margin:14px 0 6px;color:var(--muted);}
.pw-form input {width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#1c1e22;color:var(--text);outline:none;}
    .logout{background:rgba(208,22,22,0.1);border-color:#9c0f0f;color:var(--brand-red)}
    .logout:hover{background:rgba(208,22,22,0.2)}
    .unsubscribe{background:rgba(208,22,22,0.1);border-color:#9c0f0f;color:var(--brand-red)}
    .unsubscribe:hover{background:rgba(208,22,22,0.2)}

    .login-btn{ display:inline-block;padding:8px 12px;border-radius:999px;background:#D01616;
  border:1px solid #9c0f0f;color:#fff;font-weight:700;text-decoration:none;white-space:nowrap;
}
    .login-btn:hover{filter:brightness(1.05)}
    .user{ display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;
  background:#1c1e22;border:1px solid #24272c;cursor:pointer;
}
    .avatar{ width:28px;height:28px;background:#fff;color:#000;border-radius:50%;
  display:grid;place-items:center;font-weight:700;
}
    .dropdown{ position:absolute;right:0;top:calc(100% + 6px);background:#1a1c20;border:1px solid #24272c;
  border-radius:10px;padding:6px 0;box-shadow:0 4px 12px rgba(0,0,0,.4);display:none;min-width:140px;z-index:50;
}
    .dropdown a{display:block;padding:8px 12px;color:#e9edf2;text-decoration:none;font-size:14px}
    .dropdown a:hover{background:rgba(255,255,255,0.05)}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand"><img src="CityintLogo.jpg" alt="Logo"/><div>CityIntel</div></div>
      <nav>
        <a href="index.html" class="active">Dashboard</a>
        <a href="alerts.html">Alerts</a>
        <a href="events.html">Events</a>
	<a href="brief.html">Intelligence Brief</a>
	<a href="incident.html">Incident Drilldown</a>
	<a href="trends.html">Trends & Forecasts</a>
        <a href="reports.html">Reports</a>
		<a href="sources.html">Sources</a>
        <a href="operationslog.html">Operations Log</a>
        <a href="settings.html">Settings</a>
        <a href="about.html">About</a>
      </nav>
      <div class="footnote">For information use only — not for redistribution</div>
    </aside>

    <header class="topbar"><h3>Settings</h3>
  <div id="topActions" style="position:relative"></div>
</header>


        <!-- Buttons -->
	<main class="main">
        <section class="card">
  <h3>Account Settings</h3>
  <p>Manage your CityIntel subscription.</p>


<div class="actions" style="display:flex1;gap:12px;flex-wrap:wrap">
  <a href="index.html" class="pill-btn neutral">Log Out</a>
  <a href="forgotten-password.html" class="pill-btn warning">Forgotten Password</a>
  <a href="change-password.html" class="pill-btn change">Change Password</a>
  <a href="manage-billing.html" class="pill-btn success">Manage Billing</a>
  <a href="subscribe.html" class="pill-btn danger">Subscribe / Manage Subscription</a>
  <a href="unsubscribe.html" class="pill-btn danger">Unsubscribe</a>
</div>

  </section>


    <main class="main">
      <div class="card">
        <h3>Preferences</h3>
        <div class="row">
          <div>
            <label>Default City</label>
            <select>
              <option>Edinburgh</option><option>London</option><option>Leeds</option>
              <option>Coventry</option><option>Glasgow</option><option>Newcastle</option>
            </select>
          </div>
          <div>
            <label>Theme</label>
            <select><option>Dark (CityIntel)</option><option>Light</option></select>
          </div>
          <div>
            <label>Notifications</label>
            <select><option>All alerts</option><option>High risk only</option><option>Muted</option></select>
          </div>
          <div>
            <label>Data refresh (mins)</label>
            <input type="number" value="10"/>
          </div>
        </div>


</main>

<script>
function logout(){
  localStorage.setItem('ci_subscribed','false');
  window.location.href = 'index.html';
}

function unsubscribe()try {
    const p = JSON.parse(localStorage.getItem('ci_profile') || '{}');
    CIMetrics.logCancel({ email: p.email || '' });
  } catch(e){}{
  localStorage.removeItem('ci_profile');
  localStorage.removeItem('ci_subscribed');
  alert("You have unsubscribed.");
  window.location.href = 'index.html';
}

document.getElementById('pwForm').addEventListener('submit', function(e){
  e.preventDefault();
  try {
    const profile = JSON.parse(localStorage.getItem('ci_profile')||'{}');
    const currentPw = document.getElementById('currentPw').value;
    const newPw = document.getElementById('newPw').value;

    if(profile.password === currentPw){
      profile.password = newPw;
      localStorage.setItem('ci_profile', JSON.stringify(profile));
      alert("Password updated successfully.");
      document.getElementById('pwForm').reset();
    } else {
      alert("Current password is incorrect.");
    }
  } catch(e){
    alert("No profile found. Please subscribe first.");
  }
});
</script>
      </div>
    </main>
  </div>
  <script>
    // highlight nav
    const here=location.pathname.split("/").pop()||"index.html";
    document.querySelectorAll("aside.sidebar nav a").forEach(a=>{
      if(a.getAttribute("href")===here)a.classList.add("active");
    });
    // log out = only remove subscribed flag
    document.getElementById("logoutBtn").addEventListener("click",()=>{
      localStorage.removeItem("ci_subscribed");
      location.replace("index.html"); // back to Freeview
    });
    // unsubscribe = remove everything
    document.getElementById("unsubscribeBtn").addEventListener("click",()=>{
      localStorage.removeItem("ci_subscribed");
      localStorage.removeItem("ci_profile");
      alert("You have unsubscribed. Access revoked.");
      location.replace("index.html");
    });
  </script>

<script>
  // Existing functions (logout / unsubscribe) stay as-is

  // Toggle panel
  const forgotToggle = document.getElementById('forgotToggle');
  const forgotBox = document.getElementById('forgotBox');
  const forgotCancel = document.getElementById('forgotCancel');
  const forgotSubmit = document.getElementById('forgotSubmit');

  if (forgotToggle && forgotBox) {
    forgotToggle.addEventListener('click', () => {
      // Prefill email if profile exists
      try {
        const p = JSON.parse(localStorage.getItem('ci_profile') || '{}');
        if (p.email && document.getElementById('fpEmail')) {
          document.getElementById('fpEmail').value = p.email;
        }
      } catch(e){}
      forgotBox.style.display = 'block';
    });
  }
  if (forgotCancel && forgotBox) {
    forgotCancel.addEventListener('click', () => {
      forgotBox.style.display = 'none';
    });
  }

  if (forgotSubmit) {
    forgotSubmit.addEventListener('click', () => {
      try {
        const profile = JSON.parse(localStorage.getItem('ci_profile') || '{}');
        const emailInput = (document.getElementById('fpEmail').value || '').trim().toLowerCase();
        const newPw = document.getElementById('fpNew').value;

        if (!emailInput || !newPw) {
          alert('Please enter your email and a new password.');
          return;
        }
        if (!profile.email) {
          alert('No subscription found. Please subscribe first.');
          return;
        }
        if (profile.email.toLowerCase() !== emailInput) {
          alert('Email does not match the subscribed account.');
          return;
        }

        // Update password and keep user logged in
        profile.password = newPw;
        localStorage.setItem('ci_profile', JSON.stringify(profile));
        localStorage.setItem('ci_subscribed', 'true');

        alert('Password updated successfully.');
        forgotBox.style.display = 'none';
      } catch(e){
        alert('Unexpected error. Please try again.');
      }
    });
  }
</script>
<script>
  // Placeholder for now; later we'll create a portal URL and redirect.
  const manageBtn = document.getElementById('manageBilling');
  if (manageBtn) {
    manageBtn.addEventListener('click', () => {
      alert('Billing portal coming soon. This will open your Manage Billing page.');
    });
  }
</script>

<script>
(function addAdminNav(){
  const nav = document.querySelector("aside.sidebar nav");
  if(!nav) return;

let isAdmin = false;
if (window.CIAuth && CIAuth.isLoggedIn()){
  const u = CIAuth.who();
  isAdmin = String(u.role||'').toLowerCase()==='admin';
}
if (isAdmin) {
  // show admin links
} catch(e){}

  // Only admins see the link
  if (isAdmin) {
    const a = document.createElement('a');
    a.href = "analytics.html"; a.textContent = "Analytics";
	a.href = "operationslog.html"; a.textContent = "Operations Log";  
	a.href = "system-flow.html"; a.textContent = "System Flow";  
    nav.appendChild(a);
  }
})();
</script>

<script>
(function mountTopActions(){
  const host = document.getElementById('topActions');
  if (!host) return;

  const isSub = localStorage.getItem('ci_subscribed') === 'true';

  // derive initials + role
  let initials = 'CI', role = 'Analyst';
  try {
    const p = JSON.parse(localStorage.getItem('ci_profile') || '{}');
    if (p.name) {
      const parts = p.name.trim().split(/\s+/);
      initials = parts.slice(0,2).map(s => s[0]?.toUpperCase() || '').join('') || 'CI';
    }
    if (p.role) role = p.role;
  } catch(e){}

  host.innerHTML = '';

  if (isSub) {
    // Logged in: show user chip and dropdown
    host.innerHTML = `
      <div class="user" id="userChip">
        <div class="avatar">${initials}</div>
        ${role}
      </div>
      <div class="dropdown" id="userMenu">
        <a href="#" id="logoutLink">Log out</a>
      </div>
    `;

    const chip = document.getElementById('userChip');
    const menu = document.getElementById('userMenu');

    chip.addEventListener('click', ()=> {
      menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
    });
    document.addEventListener('click', (e)=> {
      if (!host.contains(e.target)) menu.style.display = 'none';
    });

    document.getElementById('logoutLink').addEventListener('click', (e)=> {
      e.preventDefault();
      // log out but keep profile if you prefer; here we clear both
      localStorage.removeItem('ci_subscribed');
      localStorage.removeItem('ci_profile');
      location.reload();
    });

  } else {
    // Logged out: show Login pill; return to the current page after login
    const here = location.pathname.split('/').pop() || 'index.html';
    const next = encodeURIComponent(here + location.search + location.hash);
    host.innerHTML = `<a class="login-btn" href="login.html?next=${next}">Log in</a>`;
  }
})();
</script>
</body>

</html>




