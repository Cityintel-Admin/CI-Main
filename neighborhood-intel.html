

<!doctype html>
<html lang="en">
<head>


<script src="auth.js"></script>

	
	<script>
(function pageGuard(){
  const NEED_LOGIN = true;          // this page requires a login
  const NEED_SUB = false;           // set to true on pages that require an active sub

  // Must be logged in?
  if (NEED_LOGIN && (!window.CIAuth || !CIAuth.isLoggedIn())) {
    const here = location.pathname.split('/').pop() || 'index.html';
    const next = encodeURIComponent(here + location.search + location.hash);
    location.href = 'login.html?next=' + next;
    return;
  }

  // Must be subscribed?
  if (NEED_SUB) {
    const isSub = localStorage.getItem('ci_subscribed') === 'true';
    if (!isSub) {
      location.href = 'subscribe.html';
      return;
    }
  }
})();
</script>
	
	
	<script>
(function compatProfileShim(){
  if (!window.CIAuth || !CIAuth.isLoggedIn()) return;
  const u = CIAuth.who();
  if (!u) return;
  localStorage.setItem('ci_profile', JSON.stringify({
    name: u.name || 'CityIntel User',
    email: u.email,
    role: u.role || 'Admin',
    is_admin: (u.role||'').toLowerCase()==='admin'
  }));
  // Do NOT auto-set ci_subscribed here anymore
})();
</script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CityIntel — Neighbourhood Intel</title>

  <!-- Leaflet (same version as test.html) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="auth.js"></script>
  <script src="admin-links.js"></script>

 <style>
    :root{--brand-red:#D01616;--gray-900:#111214;--gray-800:#16171a;--gray-700:#1c1e22;--gray-600:#24272c;--gray-500:#2e3238;--text:#e9edf2}
    body{margin:0;font:14px/1.5 system-ui;background:linear-gradient(180deg,var(--gray-900),var(--gray-800));color:var(--text)}
    .app{display:grid;grid-template-columns:260px 1fr;grid-template-rows:60px 1fr;grid-template-areas:"sidebar topbar" "sidebar main";min-height:100vh}
    .sidebar{grid-area:sidebar;background:#0c0c0c;border-right:1px solid var(--gray-600);display:flex;flex-direction:column;padding:18px 14px;gap:18px}
    .brand{display:flex;align-items:center;gap:10px;padding:8px 10px;background:rgba(208,22,22,0.1);border-radius:12px}
    .brand img{width:34px;height:34px;background:#fff;border-radius:6px}
    nav a{display:flex;align-items:center;padding:10px 12px;border-radius:10px;text-decoration:none;color:var(--text);border:1px solid transparent}
    nav a:hover{background:var(--gray-600);border-color:var(--gray-500)}
    nav a.active{background:rgba(208,22,22,0.15);border-color:var(--brand-red)}
    .sidebar .footnote{margin-top:auto;font-size:12px;color:#8e97a3}
    .topbar{ grid-area: topbar;background: rgba(255,255,255,0.02);border-bottom:1px solid var(--brand-gray-600);display:flex; align-items:center; gap:12px;
  padding:10px 16px;position:sticky; top:0; z-index:10;backdrop-filter: blur(8px);}
    .search{flex:1;display:flex; align-items:center; gap:10px;background:var(--brand-gray-700);border:1px solid var(--brand-gray-600);
  border-radius:12px; padding:8px 12px;min-width: 0;}
    .search input{flex:1; min-width:0;background:transparent; border:none; outline:none; color:var(--text);}

#topActions{margin-left:auto;display:flex; align-items:center; gap:10px;min-width: fit-content;position: relative;}
    
    .login-btn:hover{filter:brightness(1.05)}
    .user{ display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;
  background:#1c1e22;border:1px solid #24272c;cursor:pointer;
}
    .avatar{ width:28px;height:28px;background:#fff;color:#000;border-radius:50%;
  display:grid;place-items:center;font-weight:700;
}
    .dropdown{ position:absolute;right:0;top:calc(100% + 6px);background:#1a1c20;border:1px solid #24272c;
  border-radius:10px;padding:6px 0;box-shadow:0 4px 12px rgba(0,0,0,.4);display:none;min-width:140px;z-index:50;
}
    .dropdown a{display:block;padding:8px 12px;color:#e9edf2;text-decoration:none;font-size:14px}
    .dropdown a:hover{background:rgba(255,255,255,0.05)}

  .brandbar{display:flex;align-items:center;gap:10px;padding:16px 20px;border-bottom:1px solid var(--line);
            background:linear-gradient(90deg,rgba(208,22,22,.2),rgba(208,22,22,0))}
  .brandbar img{width:auto;height:60px;object-fit:contain;border-radius:6px;background:#fff}
  .wrap{max-width:1100px;margin:28px auto;padding:20px}
  .hero{text-align:center;margin:6px 0 18px}
  .hero h1{margin:0 0 6px;font-size:26px;color:var(--brand-red)}
  .hero p{margin:0;color:var(--muted)}

    #trial-banner{
      flex:1;
      text-align:center;
      font-size:12px;
      font-weight:600;
      color:#fecaca;
    }

    .logout-link{
      color:#8e97a3;
      font-size:12px;
    }

    .main{
      grid-area:main;
      padding:18px;
    }

    .page-head{
      display:flex;
      align-items:flex-start;
      flex-wrap:wrap;
      gap:12px;
      margin-bottom:16px;
    }
    .page-head-left h2{
      margin:0;
      font-size:16px;
      font-weight:600;
      color:var(--text);
    }
    .page-head-left .sub{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }
    .page-head-right{
      margin-left:auto;
      display:flex;
      flex-direction:column;
      align-items:center;
      min-width:160px;
      gap:8px;
    }

.page-title-bar{
  display:flex;
  align-items:flex-start;
  gap:10px;
  margin-bottom:12px;
}

.page-title-main{
  display:flex;
  flex-direction:column;
  gap:4px;
}

.page-title-bar h2{
  margin:0;
  font-size:18px;
  font-weight:600;
  color:var(--text);
}

.page-title-sub{
  font-size:12px;
  color:#8e97a3; /* muted */
}

.page-title-actions{
  margin-left:auto;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}

.btn-outline-pill{
  border-radius:999px;
  border:1px solid var(--gray-600);
  background:#1f2024;
  color:#e9edf2;
  font-size:12px;
  font-weight:500;
  padding:6px 12px;
  cursor:pointer;
  text-decoration:none;
  display:inline-flex;
  align-items:center;
  gap:6px;
  white-space:nowrap;
}

.btn-outline-pill:hover{
  background:#2a2d32;
  border-color:#D01616;
  color:#fff;
}

    .btn-red{
      background:#D01616;
      color:#fff;
      font-size:13px;
      font-weight:600;
      border:1px solid #D01616;
      border-radius:10px;
      padding:8px 12px;
      cursor:pointer;
      line-height:1.2;
      text-align:center;
      min-width:140px;
    }
    .btn-red:hover{
      background:#ff2a2a;
      border-color:#ff2a2a;
    }

    .feeds-grid{
  display: grid;
  gap: 16px;
  /* default: responsive 1–2 columns */
  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
}

/* On wider screens, force 3 equal columns */
@media (min-width: 1280px){
  .feeds-grid{
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }
}

    .feed-card{
      background:linear-gradient(180deg,#1a1c20,#131417);
      border:1px solid var(--g600);
      border-radius:16px;
      display:flex;
      flex-direction:column;
      min-height:260px;
      max-height:400px;
    }

    .feed-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      border-bottom:1px solid var(--g600);
      padding:12px 16px;
    }
    .feed-head-left{
      font-size:13px;
      color:var(--text);
      line-height:1.4;
    }
    .feed-city{
      font-weight:600;
      font-size:14px;
      color:#fff;
    }

    .feed-head-meta{
      margin-top:4px;
      font-size:11px;
      color:#9ca3af;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
    }

    .feed-head-meta span.badge{
      padding:2px 6px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.45);
      background:rgba(15,23,42,.8);
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.03em;
    }

    .feed-risk{
      display:inline-block;
      font-size:11px;
      line-height:1.2;
      font-weight:600;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.15);
    }
    .feed-risk.high{
      background:rgba(255,90,95,.12);
      border-color:rgba(255,90,95,.35);
      color:#ff5a5f;
    }
    .feed-risk.med{
      background:rgba(240,180,41,.12);
      border-color:rgba(240,180,41,.35);
      color:#f0b429;
    }
    .feed-risk.low{
      background:rgba(51,196,141,.12);
      border-color:rgba(51,196,141,.35);
      color:#33c48d;
    }
    .feed-head-right{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:4px;
    }

/* Helps remove thin gaps/bands between raster tiles */
.leaflet-container { background: #b9d7ea; } /* any light ocean-ish colour */
.leaflet-tile {
  outline: 1px solid transparent;           /* forces consistent compositing */
  transform: translate3d(0,0,0);
  backface-visibility: hidden;
}

	.feed-kw{
     margin-top:4px;
     font-size:12px;
     color:var(--muted);
     white-space:nowrap;
     overflow:hidden;
     text-overflow:ellipsis;
     max-width: 100%;
    }

	  .live-map-feed-label{
  font-size:12px;
  font-weight:600;
  color:#e5e7eb;
  margin-bottom:4px;
}

.live-map-feed-counts{
  display:flex;
  gap:8px;
  align-items:center;
  font-size:11px;
  color:#cbd5e1;
}
.live-map-feed-counts .dot{
  width:6px;height:6px;border-radius:999px;display:inline-block;margin-right:4px;
}
.live-map-feed-counts .dot-high{ background:#ff5a5f; }
.live-map-feed-counts .dot-med { background:#f0b429; }
.live-map-feed-counts .dot-low { background:#33c48d; }

/* --- Alerts panel layout + scrolling --- */
#mapAlertsPanel{
  display:none;                 /* JS toggles this */
  flex-direction:column;
  gap:8px;
  height:100%;
  min-height:0;                 /* critical so inner scroller works */
}

#mapAlertsList{
  flex:1;
  min-height:0;
  overflow:auto;
  padding-right:10px;           /* avoids scrollbar overlap */
}

/* keep Back button visible and not covering the scrollbar */
#mapAlertsBackBtn{
  position:sticky;
  bottom:0;
  z-index:2;
  margin-top:6px;
}
	  
.kw-chip{
  display:inline-block;
  padding:2px 6px;
  border:1px solid var(--g600);
  border-radius:999px;
  font-size:11px;
  color:#cfd6df;
  background:#1f2024;
  margin-right:6px;
}
.kw-more{
  font-size:11px;
  opacity:.8;
}

/* ---------------------------------------------------------
   RECENCY AGE VISUALS
--------------------------------------------------------- */

.age-fresh {
  opacity: 1;
  border-color: #3f3f3f !important;
}

.age-recent {
  opacity: 0.85;
  border-color: #333 !important;
}

.age-older {
  opacity: 0.65;
  border-color: #262626 !important;
}

.age-stale {
  opacity: 0.45;
  border-color: #1e1e1e !important;
}

/* LIVE badge in feed header */
    .live-pill {
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:rgba(208,22,22,0.15);
      border:1px solid #D01616;
      color:#ff4d4d;
      font-size:11px;
      font-weight:600;
      line-height:1.2;
      padding:3px 8px;
      border-radius:999px;
    }
    .live-dot {
      width:6px;
      height:6px;
      border-radius:50%;
      background:#ff4d4d;
      box-shadow:0 0 6px #ff4d4d,0 0 10px #ff4d4d;
    }

    /* checkbox row in modal */
    .modal-row-inline {
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
      margin-bottom:12px;
    }
    .modal-row-inline input[type="checkbox"] {
      margin-top:2px;
      accent-color:#D01616; /* modern browsers */
    }
    .modal-row-inline .live-row-text {
      color:#fff;
      font-size:13px;
      line-height:1.4;
    }
    .modal-row-inline .live-row-hint {
      font-size:11px;
      color:var(--muted);
      line-height:1.4;
    }

    .btn-ghost{
      background:#1f2024;
      color:#e9edf2;
      border:1px solid var(--g600);
      border-radius:8px;
      padding:4px 8px;
      font-size:12px;
      line-height:1.2;
      cursor:pointer;
    }
    .btn-ghost:hover{
      background:#2a2d32;
    }

    .feed-body{
      flex:1;
      overflow-y:auto;
      padding:12px 16px 16px;
      font-size:13px;
    }
    .feed-item{
      border-left:4px solid #D01616;
      background:linear-gradient(90deg,rgba(208,22,22,.1),rgba(208,22,22,0));
      border-radius:8px;
      border:1px solid var(--g600);
      padding:10px 12px;
      margin-bottom:10px;
      cursor:pointer;
    }
    .feed-item:last-child{
      margin-bottom:0;
    }
    .feed-title-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:8px;
      font-size:13px;
      font-weight:600;
      color:#fff;
    }
    .feed-meta{
      font-size:11px;
      color:var(--muted);
      line-height:1.4;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }

    .feed-footer{
      border-top:1px solid var(--g600);
      padding:10px 16px;
      font-size:11px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .feed-footer .src{
      color:var(--muted);
    }
    .feed-footer .refresh{
      cursor:pointer;
      color:#8e97a3;
    }
    .feed-footer .refresh:hover{
      color:#fff;
    }

    /* slide-in detail panel */
    .detail-panel{
      position:fixed;
      top:0;
      right:0;
      height:100vh;
      width:360px;
      max-width:80%;
      background:#1a1c20;
      border-left:1px solid var(--g600);
      box-shadow:-20px 0 40px rgba(0,0,0,.8);
      color:#e9edf2;
      font-size:13px;
      line-height:1.5;
      display:flex;
      flex-direction:column;
      transform:translateX(100%);
      transition:transform .25s ease;
      z-index:10000;
    }
    .detail-panel.open{
      transform:translateX(0%);
    }

    /* Desktop: reserve space so the incident detail panel doesn't cover the map */
    @media (min-width: 1100px){
      body.detail-open .main{
        margin-right:360px;
        transition:margin-right 220ms ease;
      }
    }

    .detail-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      padding:16px;
      border-bottom:1px solid var(--g600);
      background:#131417;
    }
    .detail-head-left{
      max-width:260px;
    }
    .detail-title{
      font-size:14px;
      font-weight:600;
      color:#fff;
      margin-bottom:4px;
    }
    .detail-meta{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }
    .detail-close{
      background:none;
      border:0;
      color:#8e97a3;
      font-size:12px;
      cursor:pointer;
      padding:4px 6px;
      border-radius:6px;
    }
    .detail-close:hover{
      color:#fff;
      background:#2a2d32;
    }

    .detail-body{
      flex:1;
      overflow-y:auto;
      padding:16px;
    }
    .detail-section{
      margin-bottom:16px;
      background:linear-gradient(180deg,#1a1c20,#131417);
      border:1px solid var(--g600);
      border-radius:12px;
      padding:12px;
    }
    .detail-section h4{
      margin:0 0 6px;
      font-size:12px;
      font-weight:600;
      color:#fff;
      text-transform:uppercase;
      letter-spacing:.03em;
    }
    .detail-section .small{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }

    .detail-footer{
      border-top:1px solid var(--g600);
      background:#131417;
      padding:12px 16px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .earlier-list {
  margin: 0;
  padding-left: 18px;
  list-style: disc;
  line-height: 1.4;
  gap: 4px;
}
    .earlier-list li {
  margin-bottom: 4px;
}

.event-group {
  background: #1a1a1a;
  padding: 14px;
  border-radius: 10px;
  margin-bottom: 10px;
  border: 1px solid #2a2a2a;
}

.eg-header {
  display: flex;
  justify-content: space-between;
  cursor: pointer;
  align-items: center;
}

.eg-title {
  font-size: 15px;
  font-weight: 600;
  display: flex;
  gap: 8px;
  align-items: center;
}

.eg-icon {
  display: inline-flex;
  width: 22px;
  height: 22px;
  border-radius: 6px;
  background: #333;
  justify-content: center;
  align-items: center;
  font-size: 12px;
  font-weight: 700;
}

.eg-meta {
  display: flex;
  gap: 10px;
  font-size: 13px;
  opacity: 0.9;
}

.eg-sub {
  margin-top: 3px;
  font-size: 12px;
  opacity: 0.85;
  display: flex;
  gap: 12px;
}

.eg-when {
  opacity: 0.85;
}

.eg-body {
  margin-top: 12px;
  padding-left: 8px;
  border-left: 2px solid #333;
  max-height: 140px;      /* adjust if you want more/less */
  overflow-y: auto;
}

.eg-item {
  margin-bottom: 9px;
}

.eg-item-when {
  font-size: 12px;
  opacity: 0.7;
}

.eg-item-text {
  font-size: 13px;
  line-height: 1.3;
  display: -webkit-box;
  -webkit-line-clamp: 3;     /* show up to 3 lines */
  -webkit-box-orient: vertical;
  overflow: hidden;
}
	.eg-footer {
  margin-top: 8px;
  text-align: right;
}
.eg-footer .eg-view-btn {
  font-size: 11px;
  padding: 4px 8px;
}  

/* --- Global "Now" strip above feeds --- */
.live-now-strip{
  margin: 10px 0 14px;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid var(--g600);
  background: linear-gradient(90deg, rgba(208,22,22,.14), rgba(12,10,20,.9));
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 8px;
  font-size: 12px;
}

.live-now-label{
  font-weight: 600;
  color: #fecaca;
  text-transform: uppercase;
  letter-spacing: .06em;
  font-size: 11px;
}

.live-now-stats{
  color: #e5e7eb;
  opacity: .9;
}

.live-now-stats span{
  margin-right: 6px;
}

.live-now-stats .dot-high{ color:#f97373; }
.live-now-stats .dot-med { color:#fbbf24; }
.live-now-stats .dot-low { color:#4ade80; }

.live-now-pills{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin-left:auto;
}

.live-now-pill{
  border-radius:999px;
  border:1px solid rgba(248,113,113,.7);
  background:rgba(127,29,29,.9);
  color:#fee2e2;
  font-size:11px;
  padding:4px 8px;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:4px;
  white-space:nowrap;
}

.live-now-pill span:first-child{
  font-size:13px;
}

.live-now-pill:hover{
  filter:brightness(1.1);
}

.live-now-empty{
  font-size:12px;
  color:#9ca3af;
}

    .btn-full-incident{
      background:#D01616;
      color:#fff;
      border:1px solid #D01616;
      border-radius:10px;
      padding:10px 12px;
      font-size:13px;
      font-weight:600;
      line-height:1.2;
      text-align:center;
      text-decoration:none;
      cursor:pointer;
    }
    .btn-full-incident:hover{
      background:#ff2a2a;
      border-color:#ff2a2a;
    }

    .btn-back-dash{
      display:inline-block;
      text-decoration:none;
      color:#ff5a5f;
      font-size:12px;
      font-weight:600;
      text-align:center;
    }

    /* Add Feed modal */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:10001;
    }
    .modal-box{
      background:#1a1c20;
      border:1px solid var(--g600);
      border-radius:16px;
      width:420px;
      max-width:90%;
      box-shadow:0 30px 60px rgba(0,0,0,.9);
      padding:16px;
      color:var(--text);
      font-size:13px;
    }
    .modal-box h3{
      margin:0 0 12px;
      font-size:14px;
      font-weight:600;
      color:#fff;
    }
    .modal-row{
      margin-bottom:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .modal-row label{
      font-size:12px;
      color:var(--muted);
    }
    .modal-row input, .modal-row select{
      background:#1f2024;
      border:1px solid var(--g600);
      border-radius:8px;
      color:#fff;
      padding:10px 12px;
      font-size:14px;
      line-height:1.4;
      outline:none;
      width:90%;
    }
    .modal-row input:focus,
    .modal-row select:focus{
      border-color:#D01616;
    }
    .modal-actions{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .btn-cancel{
      background:#1f2024;
      border:1px solid var(--g600);
      border-radius:8px;
      color:#8e97a3;
      font-size:12px;
      line-height:1.2;
      padding:8px 10px;
      cursor:pointer;
      flex:1;
      text-align:center;
    }
    .btn-cancel:hover{
      background:#2a2d32;
      color:#fff;
    }
    .btn-save{
      background:#D01616;
      border:1px solid #D01616;
      border-radius:8px;
      color:#fff;
      font-size:12px;
      font-weight:600;
      line-height:1.2;
      padding:8px 10px;
      cursor:pointer;
      flex:1;
      text-align:center;
    }
    .btn-save:hover{
      background:#ff2a2a;
      border-color:#ff2a2a;
    }

	  /* Card that holds the live map */
.live-map-card{
  position: relative;
  padding: 16px 18px 20px;
}

/* Map + sidebar layout */
.live-map-shell{
  display:flex;
  gap:14px;
  align-items:stretch;
}

.live-map-main{
  flex:1;
  height:480px;          /* tweak: taller map */
  border-radius:14px;
  overflow:hidden;
}

/* Right-hand column */
.live-map-sidebar{
  width:250px;
  background:#05070b;
  border-radius:14px;
  border:1px solid #2e3238;
  padding:10px 12px;
  font-size:11px;
  color:#e5e7eb;
  display:flex;
  flex-direction:column;
  gap:10px;
}

/* Legend block */
.live-map-legend-block{
  border-radius:10px;
  background:#06070c;
  padding:8px 10px;
  border:1px solid #2e3238;
}

.live-map-legend-row{
  display:flex;
  align-items:center;
  gap:6px;
  margin-bottom:4px;
}

.live-map-legend-row:last-child{
  margin-bottom:0;
}

.live-map-chip{
  width:12px;
  height:12px;
  border-radius:3px;
  border:1px solid #111827;
}

.live-map-chip-high{ background:#ff5a5f; }
.live-map-chip-med { background:#f0b429; }
.live-map-chip-low { background:#6bcf6b; }

.live-map-dot{
  width:9px;
  height:9px;
  border-radius:999px;
  display:inline-block;
}

.live-map-dot-asset{ background:#3b82f6; }
.live-map-dot-trav { background:#f97316; }

/* Feeds area */
.live-map-sidebar-section{
  border-radius:10px;
  background:#05070b;
  border:1px solid #111827;
  padding:8px 8px 10px;
}

.live-map-sidebar-title{
  font-size:10px;
  letter-spacing:.06em;
  text-transform:uppercase;
  opacity:.75;
  margin-bottom:6px;
}

.live-map-feeds-list{
  display:flex;
  flex-direction:column;
  gap:4px;
  max-height:160px;
  overflow-y:auto;
  overflow-x:hidden;
  padding-right:8px;
  box-sizing:border-box;
}

.live-map-feed-row{
  width:100%;
  text-align:left;
  border-radius:12px;
  border:1px solid #374151;
  background:#0b1120;
  color:#e5e7eb;
  padding:8px 10px;
  display:flex;
  align-items:center;
  gap:10px;
  box-sizing:border-box;
}
.feed-open-btn{
  flex:1;
  display:flex;
  align-items:center;
  gap:10px;
  border:0;
  background:transparent;
  color:inherit;
  padding:0;
  cursor:pointer;
  min-width:0;
}
.feed-open-btn .feed-name{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:700;}
.feed-open-btn .feed-count{margin-left:auto; opacity:.85; font-weight:600; font-size:12px;}
.live-map-feed-remove{
  width:34px; height:34px;
  border-radius:10px;
  border:1px solid rgba(244,63,94,.55);
  background:rgba(244,63,94,.12);
  color:#fecaca;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  line-height:1;
}
.live-map-feed-remove:hover{background:rgba(244,63,94,.2);}

.live-map-feed-row:hover{
  background:#111827;
  border-color:#4b5563;
}

.live-map-feed-btn,
.gm-feed-pill{
  cursor: pointer;
  user-select: none;
  -webkit-user-select: none;
}

.live-map-feed-btn:hover{
  background:#1f2937;
  border-color:#9ca3af;
}

.live-map-add-btn{
  margin-top:8px;
  width:100%;
  border-radius:999px;
  border:1px dashed #4b5563;
  background:#05070b;
  color:#e5e7eb;
  font-size:11px;
  padding:4px 6px;
  cursor:pointer;
}

.live-map-add-btn:hover{
  background:#111827;
}

/* highlight when sidebar scrolls you to a feed card */
.feed-card-pulse{
  box-shadow:0 0 0 2px rgba(248,113,113,.8);
  transition:box-shadow .3s ease;
}

.live-radius-block{
  margin-top:12px;
  padding-top:8px;
  border-top:1px solid #2e3238;
}

.live-radius-label{
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.08em;
  color:#9ca3af;
  margin-bottom:6px;
}

.live-radius-pills{
  display:flex;
  gap:6px;
}

.radius-pill{
  flex:1;
  border-radius:999px;
  border:1px solid #4b5563;
  background:#111827;
  color:#e5e7eb;
  font-size:11px;
  padding:4px 0;
  cursor:pointer;
  text-align:center;
}

.radius-pill.active{
  border-color:#f97373;
  background:#7f1d1d;
  color:#fee2e2;
}

	/* --- Map sidebar: selected feed alerts list --- */
.map-alerts-list{
  display:flex;
  flex-direction:column;
  gap:8px;
  max-height:240px;     /* adjust if you want */
  overflow-y:auto;
  padding-right:2px;
}

.map-alert-item{
  border-radius:12px;
  border:1px solid #374151;
  background:#0b1120;
  padding:8px 10px;
  cursor:pointer;
}

.map-alert-item:hover{
  background:#111827;
  border-color:#4b5563;
}

.map-alert-item.active{
  border-color:#ef4444;
  box-shadow:0 0 0 2px rgba(239,68,68,0.25) inset;
}

.map-alert-top{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:8px;
  margin-bottom:6px;
}

.map-alert-title{
  font-size:12px;
  font-weight:600;
  color:#e5e7eb;
  line-height:1.25;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
}

.map-alert-when{
  font-size:11px;
  opacity:.75;
  white-space:nowrap;
}

.map-alert-meta{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  align-items:center;
  font-size:11px;
  opacity:.9;
}

.map-risk-pill{
  font-size:10px;
  font-weight:700;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.15);
}

.map-risk-high{ background:rgba(255,90,95,.14); border-color:rgba(255,90,95,.35); color:#ff5a5f; }
.map-risk-med { background:rgba(240,180,41,.14); border-color:rgba(240,180,41,.35); color:#f0b429; }
.map-risk-low { background:rgba(51,196,141,.14); border-color:rgba(51,196,141,.35); color:#33c48d; }

.map-alert-empty{
  font-size:12px;
  opacity:.75;
  padding:8px 2px;
}

/* brief highlight when we jump to a feed card */
.feed-card-pulse{
  box-shadow:
    0 0 0 1px #f97316,
    0 0 10px rgba(249,115,22,0.7);
  transition: box-shadow .3s ease;
}

	  /* --- Global Risk & Exposure layout --- */
.global-map-wrap{
  margin-top: 10px;
  padding: 12px 14px 16px;
  display: grid;
  grid-template-columns: minmax(320px, 380px) minmax(0, 1fr); /* sidebar | map */
  gap: 16px;
  align-items: stretch;
}

.global-map-main{
  background:#020617;
  border-radius:16px;
  overflow:hidden;
  border:1px solid var(--gray-700);
  grid-column: 2;	
}

:root{
  --workspace-h: clamp(700px, 85vh, 1100px);

/* This is critical – gives the Leaflet container height */
#liveRiskMap{
  width:100%;
  height: var(--workspace-h);
  background:#cfe3f3;
  filter: saturate(1.05) contrast(1.05);
}

#liveMapFeedsList { max-height: 260px; overflow:auto; }

/* Right-hand side panel */
.global-map-side{
  background:#050708;
  border-radius:16px;
  border:1px solid var(--gray-700);
  padding:12px 14px;
  font-size:12px;
  height: var(--workspace-h);
  display:flex;
  flex-direction:column;
  gap:12px;
  grid-column: 1;	
  overflow: hidden;
}

/* Make the alerts panel a proper column layout */
.map-alerts-scroll{
  flex:1;
  overflow-y:auto;
  padding-right:6px; /* space for scrollbar */
}

/* Footer stays visible */
.map-alerts-footer{
  border-top:1px solid #2e3238;
  padding:8px;
  background:#05070b;
}

/* Back button styling */
.map-back-btn{
  width:100%;
  border-radius:999px;
  border:1px solid #4b5563;
  background:#111827;
  color:#e5e7eb;
  font-size:12px;
  padding:6px 0;
  cursor:pointer;
}

.map-back-btn:hover{
  background:#1f2937;
}

/* The list should scroll, not the whole panel */
#mapAlertsList{
  flex:1;
  padding-bottom: 44px;
  overflow-y:auto;
  max-height:none; /* override earlier max-height if set */
}

/* Keep the Back button always visible */
#mapAlertsBackBtn{
  position: sticky;
  bottom: 0;
  margin-top: 8px;
  background: #05070b;           /* match panel bg */
  border: 1px dashed #4b5563;
  border-radius: 999px;
}

/* Legend styling */
.global-map-legend-block{
  border-bottom:1px solid #2e3238;
  padding-bottom:8px;
}
.gm-legend-title{
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.08em;
  opacity:.8;
  margin-bottom:6px;
}
.gm-legend-row{
  display:flex;
  align-items:center;
  gap:6px;
  margin-bottom:3px;
}
.gm-chip{
  width:12px;
  height:12px;
  border-radius:3px;
  border:1px solid #111827;
}
.gm-high{ background:#ff5a5f; }
.gm-med{  background:#f0b429; }
.gm-low{  background:#6bcf6b; }

.gm-dot{
  width:10px;
  height:10px;
  border-radius:999px;
  display:inline-block;
}
.gm-asset{ background:#3b82f6; }
.gm-trav{  background:#f97316; }

/* Feed list inside side panel */
.global-map-feeds-block{
  margin-top:4px;
}
.gm-feeds-title{
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.08em;
  opacity:.75;
  margin-bottom:6px;
}
.gm-feed-pill{
  width:100%;
  text-align:left;
  border-radius:999px;
  border:1px solid #374151;
  background:#0b1120;
  color:#e5e7eb;
  font-size:12px;
  padding:5px 8px;
  margin-bottom:4px;
  cursor:pointer;
}
.gm-feed-pill:hover{
  background:#111827;
  border-color:#4b5563;
}
.gm-feed-add{
  width:100%;
  margin-top:4px;
  border-radius:999px;
  border:1px solid #4b5563;
  background:#111827;
  color:#e5e7eb;
  font-size:11px;
  padding:5px 8px;
  cursor:pointer;
}
.gm-feed-add:hover{
  background:#1f2937;
}

/* subtle highlight when a feed is jumped to */
.feed-card-highlight{
  box-shadow:0 0 0 2px rgba(248,113,113,.7);
  transition:box-shadow .25s ease;
}

#liveFeedSection{
  display:none !important;
}

/* asset / traveller markers */
.ci-asset-marker,
.ci-trav-marker{
  background:#111827;
  border-radius:999px;
  border:2px solid #000;
  box-shadow:0 0 6px rgba(0,0,0,0.6);
  color:#fff;
  font-size:10px;
  font-weight:700;
  line-height:18px;
  text-align:center;
}
.ci-asset-marker{ background:#3b82f6; }    /* blue */
.ci-trav-marker{ background:#f97316; }    /* orange */

    @media (max-width:900px){
      .app{
        grid-template-columns:1fr;
        grid-template-areas:
          "topbar"
          "main";
      }
      .sidebar{
        display:none;
      }
      .detail-panel{
        width:80%;
        max-width:400px;
      }
    }

@media (max-width: 1100px){
  .global-map-wrap{
    grid-template-columns: 1fr;
  }
  .global-map-side{
    grid-column: 1;
    height: auto;
    max-height: none;
  }
  .global-map-main{
    grid-column: 1;
  }
  #liveRiskMap{
    height: clamp(380px, 55vh, 560px);
  }
}

/* Traveller group marker (multiple travellers in same place) */
.trav-group-icon { background: transparent; border: none; }
.trav-bubble{
  width:34px; height:34px;
  border-radius:999px;
  display:flex; align-items:center; justify-content:center;
  background: rgba(255, 140, 0, 0.95);
  box-shadow: 0 8px 24px rgba(0,0,0,.45);
  border: 2px solid rgba(255,255,255,.75);
  font-weight: 800;
  color: #0b0f16;
}
.trav-bubble span{ transform: translateY(-.5px); }
.trav-popup{ font-family: inherit; }
.trav-popup-title{ font-weight: 800; margin-bottom: 8px; }
.trav-popup-list{ max-height: 240px; overflow:auto; padding-right: 4px; }
.trav-popup-item{ padding: 8px 0; border-top: 1px solid rgba(255,255,255,.12); }
.trav-popup-item:first-child{ border-top: none; padding-top: 0; }
.trav-name{ font-weight: 700; }
.trav-meta, .trav-dates{ opacity: .85; font-size: 12px; margin-top: 2px; }



/* Panic marker (live pin) */
.ci-panic-marker{
  background:#ff2d2d;
  border-radius:999px;
  border:2px solid rgba(255,255,255,.85);
  box-shadow:0 10px 28px rgba(0,0,0,.55);
  color:#0b0f16;
  font-size:12px;
  font-weight:900;
  line-height:18px;
  text-align:center;
}

/* ===== Operator Disposition / Queues ===== */
.disp-row{ display:flex; align-items:center; gap:8px; margin-top:8px; flex-wrap:wrap; }
.disp-label{ font-size:11px; letter-spacing:.08em; text-transform:uppercase; color:rgba(255,255,255,.72); }
.disp-select{
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.14);
  color: #e9edf2;
  border-radius: 10px;
  padding: 6px 10px;
  outline: none;
  font-weight: 600;
}
.disp-select:focus{ border-color: rgba(208,22,22,0.8); box-shadow: 0 0 0 3px rgba(208,22,22,0.18); }
.disp-select option{ color:#0b0f16; }
.disp-updated{ font-size:11px; opacity:.75; margin-left:6px; }
.disp-note-row{ margin-top:8px; }
.disp-note{
  width:100%;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.14);
  color: #e9edf2;
  border-radius: 10px;
  padding: 8px 10px;
  outline:none;
}
.disp-note:focus{ border-color: rgba(208,22,22,0.8); box-shadow: 0 0 0 3px rgba(208,22,22,0.18); }

.ci-status-pill{
  display:inline-flex; align-items:center; gap:6px;
  padding:2px 8px; border-radius:999px;
  font-size:11px; font-weight:700; letter-spacing:.02em;
  border:1px solid rgba(255,255,255,0.18);
  background: rgba(255,255,255,0.06);
  color:#e9edf2;
}
.ci-status-pill[data-status="untriaged"]{ display:none; }
.ci-status-pill[data-status="escalated"]{ border-color: rgba(255,90,95,0.6); background: rgba(255,90,95,0.16); }
.ci-status-pill[data-status="monitoring"]{ border-color: rgba(240,180,41,0.6); background: rgba(240,180,41,0.14); }
.ci-status-pill[data-status="cleared"]{ border-color: rgba(51,196,141,0.6); background: rgba(51,196,141,0.14); }

.queue-grid{ display:flex; gap:8px; flex-wrap:wrap; }
.queue-btn{
  flex:1 1 auto;
  background: rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.14);
  color:#e9edf2;
  border-radius:12px;
  padding:8px 10px;
  font-weight:700;
  cursor:pointer;
  display:flex; align-items:center; justify-content:space-between;
  min-width: 120px;
}
.queue-btn:hover{ border-color: rgba(208,22,22,0.55); }
.queue-count{
  display:inline-block;
  min-width: 22px;
  text-align:center;
  padding:2px 8px;
  border-radius:999px;
  background: rgba(0,0,0,0.25);
  border:1px solid rgba(255,255,255,0.14);
  font-size:11px;
}


/* ===== Operator Transition Modal (TOPO-style) ===== */
.ci-modal-overlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index: 9999;
  padding: 18px;
}
.ci-modal{
  width: min(820px, 96vw);
  max-height: min(78vh, 780px);
  background: #ffffff;
  color: #0b0f16;
  border-radius: 14px;
  box-shadow: 0 30px 90px rgba(0,0,0,0.55);
  overflow:hidden;
  display:flex;
  flex-direction:column;
}
.ci-modal header{
  padding: 18px 20px 14px 20px;
  border-bottom: 1px solid rgba(0,0,0,0.10);
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}
.ci-modal header #ciTransitionTitle{
  font-weight: 900;
  font-size: 18px;
  margin-right: 4px;
}
.ci-pill{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding: 4px 10px;
  border-radius: 999px;
  font-weight: 800;
  font-size: 12px;
  background: rgba(0,0,0,0.06);
  border: 1px solid rgba(0,0,0,0.10);
}
.ci-modal-meta{
  width:100%;
  font-size: 12px;
  opacity: .8;
  margin-top: 2px;
}
.ci-modal-body{
  padding: 16px 20px 18px 20px;
  overflow:auto;
}
.ci-form-grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 14px 16px;
  margin-top: 14px;
}
@media (max-width:720px){
  .ci-form-grid{ grid-template-columns: 1fr; }
}
.ci-field label{
  display:block;
  font-size: 11px;
  letter-spacing: .08em;
  text-transform: uppercase;
  font-weight: 800;
  margin-bottom: 6px;
  color: rgba(11,15,22,0.72);
}
.ci-field input, .ci-field select, .ci-field textarea{
  width:100%;
  border: 1px solid rgba(11,15,22,0.18);
  border-radius: 10px;
  padding: 10px 12px;
  font: inherit;
  outline: none;
}
.ci-field textarea{ min-height: 92px; resize: vertical; }
.ci-check-list{ display:grid; gap: 8px; }
.ci-check{
  display:flex;
  align-items:center;
  gap:10px;
  font-weight: 600;
  color: rgba(11,15,22,0.85);
}
.ci-check input{ width: 16px; height: 16px; }
.ci-modal footer{
  padding: 14px 20px;
  border-top: 1px solid rgba(0,0,0,0.10);
  display:flex;
  gap: 10px;
  justify-content:flex-end;
}
.ci-btn{
  border-radius: 10px;
  padding: 10px 14px;
  font-weight: 800;
  border: 1px solid rgba(11,15,22,0.20);
  background: #ffffff;
  cursor:pointer;
}
.ci-btn.primary{
  background: #5b3df5;
  border-color: #5b3df5;
  color: #ffffff;
}

/* ==== v7: Taller global map workspace + better sidebar scrolling ==== */
:root{
  --workspace-h: clamp(560px, 78vh, 900px);
}

/* Ensure the map and sidebar share the same tall workspace */
#liveRiskMap{ height: var(--workspace-h) !important; }
.global-map-side{ height: var(--workspace-h) !important; }

/* Let the sidebar content breathe and allow lists to scroll */
.global-map-side{ overflow:hidden; }

/* Panels inside the sidebar should be able to grow */
.live-map-sidebar-section{
  display:flex;
  flex-direction:column;
  min-height:0;
}

/* Feeds list: allow much more vertical room */
#mapFeedsPanel{ flex: 1 1 auto; min-height:0; }
#liveMapFeedsList{
  flex:1 1 auto;
  min-height:0;
  max-height:none !important;
  overflow:auto;
  padding-right:4px;
}

/* Alerts list when a feed is opened */
#mapAlertsPanel{
  flex: 1 1 auto;
  min-height:0;
}
#mapAlertsList{
  flex:1 1 auto;
  min-height:0;
  max-height:none !important;
  overflow:auto;
  padding-right:4px;
}

/* Slightly larger clickable area for the back button */
#mapAlertsBackBtn{ margin-top:10px; }


/* v9 scroll improvements */
.feeds-list, .latest-incidents, .feedsBox, .latestBox {
  overflow-y: auto !important;
  max-height: 100%;
}



  /* Neighbourhood Intel layout */
  .main {
    margin-left: 220px;
    padding: 22px 24px 28px;
  }
  .ni-grid {
    display: grid;
    grid-template-columns: 360px 1fr 420px;
    gap: 16px;
    align-items: start;
  }
  .ni-card {
    background: rgba(10,12,14,.82);
    border: 1px solid rgba(255,255,255,.08);
    border-radius: 16px;
    box-shadow: 0 12px 40px rgba(0,0,0,.45);
    overflow: hidden;
  }
  .ni-card .hd {
    padding: 14px 14px 12px;
    border-bottom: 1px solid rgba(255,255,255,.08);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
  }
  .ni-card .hd h2 {
    margin: 0;
    font-size: 14px;
    letter-spacing: .06em;
    text-transform: uppercase;
    color: rgba(255,255,255,.82);
  }
  .ni-card .bd {
    padding: 14px;
  }
  .ni-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 10px;
  }
  .ni-row.one {
    grid-template-columns: 1fr;
  }
  .ni-label {
    font-size: 11px;
    letter-spacing: .06em;
    text-transform: uppercase;
    color: rgba(255,255,255,.6);
    margin: 0 0 6px;
  }
  .ni-input, .ni-select, .ni-textarea {
    width: 100%;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.28);
    color: rgba(255,255,255,.92);
    padding: 10px 12px;
    outline: none;
  }
  .ni-textarea {
    min-height: 92px;
    resize: vertical;
  }
  .ni-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 10px;
  }
  .ni-btn {
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    color: rgba(255,255,255,.9);
    padding: 10px 12px;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 700;
  }
  .ni-btn.primary {
    border-color: rgba(255,40,40,.35);
    background: rgba(255,40,40,.18);
  }
  .ni-btn:disabled {
    opacity: .55;
    cursor: not-allowed;
  }

  .ni-map {
    height: clamp(520px, 74vh, 980px);
    border-radius: 16px;
  }

  .ni-feed {
    height: clamp(520px, 74vh, 980px);
    overflow: auto;
    padding: 6px 6px 10px;
  }
  .post {
    border: 1px solid rgba(255,255,255,.09);
    background: rgba(0,0,0,.22);
    border-radius: 14px;
    padding: 12px;
    margin: 8px 8px;
    cursor: pointer;
  }
  .post:hover {
    border-color: rgba(255,255,255,.16);
  }
  .post .t {
    display: flex;
    justify-content: space-between;
    gap: 10px;
    align-items: baseline;
  }
  .post .title {
    font-weight: 800;
    color: rgba(255,255,255,.92);
    line-height: 1.15;
  }
  .pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 5px 10px;
    border-radius: 999px;
    font-size: 12px;
    border: 1px solid rgba(255,255,255,.12);
    color: rgba(255,255,255,.85);
    background: rgba(255,255,255,.05);
    white-space: nowrap;
  }
  .pill.sev-high { border-color: rgba(255,60,60,.35); background: rgba(255,60,60,.16); }
  .pill.sev-med  { border-color: rgba(255,190,60,.35); background: rgba(255,190,60,.14); }
  .pill.sev-low  { border-color: rgba(120,220,120,.35); background: rgba(120,220,120,.12); }

  .meta {
    margin-top: 8px;
    color: rgba(255,255,255,.62);
    font-size: 12px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }
  .excerpt {
    margin-top: 10px;
    color: rgba(255,255,255,.78);
    font-size: 13px;
    line-height: 1.35;
  }

  /* Detail panel */
  .ni-detail {
    height: clamp(520px, 74vh, 980px);
    overflow: auto;
  }
  .ni-detail .empty {
    padding: 18px;
    color: rgba(255,255,255,.72);
  }

  /* Modal */
  .ni-backdrop {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,.55);
    z-index: 9999;
    padding: 18px;
  }
  .ni-modal {
    width: min(980px, 100%);
    max-height: 90vh;
    overflow: hidden;
    border-radius: 18px;
    background: rgba(18,20,24,.96);
    border: 1px solid rgba(255,255,255,.10);
    box-shadow: 0 30px 90px rgba(0,0,0,.65);
  }
  .ni-modal .bd{padding:16px;max-height:calc(90vh - 96px);overflow:auto}
  .ni-modal .hd {
    position: sticky;
    top: 0;
    background: rgba(18,20,24,.96);
    z-index: 2;
  }
  .ni-note {
    font-size: 12px;
    color: rgba(255,255,255,.6);
    margin-top: 8px;
    line-height: 1.35;
  }
  
  .ni-subnote{font-size:12px;color:rgba(255,255,255,.6);margin-top:6px;margin-bottom:6px;}

  /* Lightweight toast */
  .ni-toasts{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:10px;z-index:9999;pointer-events:none}
  .ni-toast{pointer-events:none;min-width:260px;max-width:420px;padding:12px 14px;border-radius:12px;background:rgba(20,22,26,.92);border:1px solid rgba(255,255,255,.12);box-shadow:0 10px 30px rgba(0,0,0,.45);color:#fff;font-size:13px;line-height:1.35}
  .ni-toast small{display:block;opacity:.75;margin-top:4px}
</style>
</head>

<body>

   <div class="brandbar">
    <img src="CityintLogo.jpg" alt="CityIntel Logo">
    <div class="title" style="font-weight:700;font-size:18px">CityIntel</div>
	<div id="trial-banner" style="display:none;position:absolute;
    left:50%; transform:translateX(-50%); background:none;
    color:#fecaca; padding:8px 12px; text-align:center;">
  <span id="trial-text">Your trial ends soon.</span>
</div>	
	  <div id="topActions" style="position:relative"></div>
  </div>
	
  <div class="app">
    <aside class="sidebar">
      <div class="section-label"></div>
      <nav>
        <a href="index.html">Dashboard</a>
		<a href="alerts.html">Alerts</a>
        <a href="events.html">Events</a>
		<a href="test.html">Test Feed</a>  
	    <a href="brief.html">Intelligence Brief</a>
	    <a href="trends.html">Trends & Forecasts</a>
        <a href="reports.html">Reports</a>
		<a href="sources.html">Sources</a>
        <a href="settings.html">Settings</a>
        <a href="about.html">About</a>
      </nav>
    </aside>

  <div class="main">
    <div style="display:flex; align-items:flex-start; justify-content:space-between; gap: 12px;">
      <div>
        <h1 style="margin:0 0 4px; font-size: 22px; color: rgba(255,255,255,.95);">Neighbourhood Intel</h1>
        <div style="color: rgba(255,255,255,.65); font-size: 13px;">
          A private, location-scoped exchange between neighbouring SOC teams. Pin-drop a location, post observations, and filter by radius/time.
        </div>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button class="ni-btn" id="btnDropPin">Drop pin</button>
        <button class="ni-btn primary" id="btnNewPost">New post</button>
      </div>
    </div>

    <div class="ni-grid" style="margin-top:16px;">
      <!-- Left: filters + feed -->
      <div class="ni-card">
        <div class="hd"><h2>Feed filter</h2><span class="pill" id="pillScope">No pin</span></div>
        <div class="bd">
          <div class="ni-row">
            <div>
              <div class="ni-label">Radius</div>
              <select class="ni-select" id="radiusKm">
                <option value="0.5">0.5 km</option>
                <option value="1" selected>1 km</option>
                <option value="2">2 km</option>
                <option value="5">5 km</option>
                <option value="10">10 km</option>
              </select>
            </div>
            <div>
              <div class="ni-label">Time window</div>
              <select class="ni-select" id="sinceHours">
                <option value="1">Last 1h</option>
                <option value="2">Last 2h</option>
                <option value="4">Last 4h</option>
                <option value="8">Last 8h</option>
                <option value="12" selected>Last 12h</option>
                <option value="24">Last 24h</option>
              </select>
            </div>
          </div>

          <div class="ni-row">
            <div>
              <div class="ni-label">Severity</div>
              <select class="ni-select" id="severity">
                <option value="">All</option>
                <option value="high">High</option>
                <option value="med">Med</option>
                <option value="low">Low</option>
              </select>
            </div>
            <div>
              <div class="ni-label">Category</div>
              <select class="ni-select" id="category">
                <option value="">All</option>
                <option value="recon">Suspicious reconnaissance</option>
                <option value="protest">Protest indicators</option>
                <option value="access">Access control concern</option>
                <option value="loitering">Loitering / surveillance</option>
                <option value="threats">Threatening comms</option>
                <option value="request">Request for info</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>

          <div class="ni-row one">
            <button class="ni-btn" id="btnRefresh">Refresh</button>
          </div>

          <div class="ni-note">
            Tip: Click “Drop pin”, then click on the map. Posts are filtered to your chosen radius/time window.
          </div>
        </div>

        <div class="hd"><h2>Posts</h2><span class="pill" id="pillCount">0</span></div>
        <div class="ni-feed" id="postList"></div>
      </div>

      <!-- Middle: map -->
      <div class="ni-card">
        <div class="hd"><h2>Map</h2><span class="pill" id="pillPin">Pin not set</span></div>
        <div class="bd" style="padding: 12px;">
          <div id="map" class="ni-map"></div>
        </div>
      </div>

      <!-- Right: detail -->
      <div class="ni-card ni-detail" id="detailCard">
        <div class="hd"><h2>Post details</h2><span class="pill" id="pillOrg">Signed in</span></div>
        <div class="empty" id="detailEmpty">Select a post to view details.</div>
        <div class="bd" id="detailBody" style="display:none;"></div>
      </div>
    </div>
  </div>

  <!-- New Post Modal -->
  <div class="ni-backdrop" id="niBackdrop" role="dialog" aria-modal="true">
    <div class="ni-modal">
      <div class="hd">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <h2 style="margin:0; font-size: 16px; color: rgba(255,255,255,.9); padding: 14px;">Create post</h2>
          <button class="ni-btn" id="btnCloseModal" style="margin-right: 14px;">Close</button>
        </div>
      </div>
      <div class="bd">
        <div class="ni-row">
          <div>
            <div class="ni-label">Title</div>
            <input class="ni-input" id="newTitle" placeholder="e.g., Person photographing entrance near loading bay" />
          </div>
          <div>
            <div class="ni-label">Observed time</div>
            <input class="ni-input" id="newObservedAt" type="datetime-local" />
          </div>
        </div>

        <div class="ni-row">
          <div>
            <div class="ni-label">Category</div>
            <select class="ni-select" id="newCategory">
              <option value="recon">Suspicious reconnaissance</option>
              <option value="protest">Protest indicators</option>
              <option value="access">Access control concern</option>
              <option value="loitering">Loitering / surveillance</option>
              <option value="threats">Threatening comms</option>
              <option value="request">Request for info</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div>
            <div class="ni-label">Severity</div>
            <select class="ni-select" id="newSeverity">
              <option value="high">High</option>
              <option value="med" selected>Med</option>
              <option value="low">Low</option>
            </select>
          </div>
        </div>

        <div class="ni-row one">
          <div>
            <div class="ni-label">Location (from pin)</div>
            <input class="ni-input" id="newGeoLabel" placeholder="Optional label (e.g., 'Front entrance', 'Car park')"/>
            <div class="ni-note" id="geoHelp">Drop a pin on the map to set the location. Location will be saved as approximate coordinates.</div>
          </div>
        </div>

        <div class="ni-row one">
          <div>
            <div class="ni-label">Details</div>
            <textarea class="ni-textarea" id="newBody" placeholder="Describe observed behaviour and why it matters. Avoid personal identifying information."></textarea>
          </div>
        </div>

        <div class="ni-row">
          <div>
            <div class="ni-label">Actions taken</div>
            <input class="ni-input" id="newActions" placeholder="e.g., notified building management; increased patrols" />
          </div>
          <div>
            <div class="ni-label">Attachments (optional URLs)</div>
            <input class="ni-input" id="newAttachments" placeholder="Comma-separated URLs (images/scenes)" />
            <div class="ni-subnote">Upload images (optional)</div>
            <input class="ni-input" id="attachFiles" type="file" accept="image/*" multiple />
            <div class="ni-subnote">Files upload on Publish and are stored as secure attachment URLs.</div>
          </div>
        </div>

        <div class="ni-row one">
          <label style="display:flex; gap:10px; align-items:flex-start; color: rgba(255,255,255,.8); font-size: 13px;">
            <input type="checkbox" id="newConfirm" />
            <span>
              I confirm this post does not include personal identifying information (names, phone numbers, plates, home addresses) and any images are privacy-safe.
            </span>
          </label>
        </div>

        <div class="ni-actions">
          <button class="ni-btn" id="btnCancelPost">Cancel</button>
          <button class="ni-btn primary" id="btnSubmitPost" disabled>Publish</button>
        </div>
      </div>
    </div>
  </div>

<script>
(function() {
  // Require auth (same style as other pages)
  if (window.CIAuth?.requireAuth) CIAuth.requireAuth();
  if (window.injectAdminLinks) injectAdminLinks();

  const API_BASE = (location.hostname.includes('github.io') ? 'https://api.cityintelapi.com' : '') || '';
  const ENDPOINT = API_BASE + '/api/neighbor/posts';

// --- Auth helpers (Workers expect X-User-Email) ---
function authHeaders(extra = {}) {
  const h = {};
  // Try a few common keys; page already uses userEmail variable when available.
  const email =
    (typeof userEmail !== 'undefined' && userEmail) ||
    localStorage.getItem('ci_user_email') ||
    localStorage.getItem('userEmail') ||
    localStorage.getItem('email') ||
    '';
  if (email) h['X-User-Email'] = email;
  return Object.assign(h, extra);
}

function isPinSet() {
  return !!(pinLatLng && typeof pinLatLng.lat === 'number' && typeof pinLatLng.lng === 'number');
}

// Load default area-of-interest (org HQ) and set initial map + pin.
async function loadOrgHQ() {
  try {
    const res = await fetch(API_BASE + '/api/org/assets', { headers: authHeaders() });
    if (!res.ok) return null;
    const data = await res.json();
    const assets = Array.isArray(data?.assets) ? data.assets : (Array.isArray(data) ? data : []);
    const hq = assets.find(a => a && typeof a.lat === 'number' && typeof a.lon === 'number') ||
               assets.find(a => a && typeof a.lat === 'number' && typeof a.lng === 'number') ||
               null;
    if (!hq) return null;
    const lat = typeof hq.lat === 'number' ? hq.lat : null;
    const lng = typeof hq.lon === 'number' ? hq.lon : (typeof hq.lng === 'number' ? hq.lng : null);
    if (lat == null || lng == null) return null;
    return { lat, lng, name: hq.name || hq.city || 'HQ' };
  } catch (e) {
    return null;
  }
}

  const els = {
    radiusKm: document.getElementById('radiusKm'),
    sinceHours: document.getElementById('sinceHours'),
    severity: document.getElementById('severity'),
    category: document.getElementById('category'),
    btnRefresh: document.getElementById('btnRefresh'),
    postList: document.getElementById('postList'),
    pillCount: document.getElementById('pillCount'),
    pillScope: document.getElementById('pillScope'),
    pillPin: document.getElementById('pillPin'),
    pillOrg: document.getElementById('pillOrg'),
    detailEmpty: document.getElementById('detailEmpty'),
    detailBody: document.getElementById('detailBody'),

    btnDropPin: document.getElementById('btnDropPin'),
    btnNewPost: document.getElementById('btnNewPost'),

    backdrop: document.getElementById('niBackdrop'),
    btnCloseModal: document.getElementById('btnCloseModal'),
    btnCancelPost: document.getElementById('btnCancelPost'),
    btnSubmitPost: document.getElementById('btnSubmitPost'),

    newTitle: document.getElementById('newTitle'),
    newObservedAt: document.getElementById('newObservedAt'),
    newCategory: document.getElementById('newCategory'),
    newSeverity: document.getElementById('newSeverity'),
    newGeoLabel: document.getElementById('newGeoLabel'),
    newBody: document.getElementById('newBody'),
    newActions: document.getElementById('newActions'),
    newAttachments: document.getElementById('newAttachments'),
    attachFiles: document.getElementById('attachFiles'),
    newConfirm: document.getElementById('newConfirm'),
    geoHelp: document.getElementById('geoHelp'),
  };

  // Identify user (used for per-user draft + server metadata)
  function getUserEmail() {
    try {
      if (localStorage.getItem('ci_user_email')) return localStorage.getItem('ci_user_email');
      const prof = JSON.parse(localStorage.getItem('ci_profile') || 'null');
      if (prof?.email) return prof.email;
      if (window.CIAuth?.who) return (CIAuth.who()?.email || '');
    } catch(e) {}
    return '';
  }
  const userEmail = getUserEmail();
  els.pillOrg.textContent = userEmail ? userEmail : 'Signed in';

  // Map setup (pin drop)
  const map = L.map('map', { zoomControl: true }).setView([51.5074, -0.1278], 11);
  L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 19
  }).addTo(map);

  let pinMarker = null;
  let pinLatLng = null;
  let pinDropMode = false;
  let postMarkers = [];
  let allPosts = [];
  let visiblePosts = [];

  function setPin(latlng) {
    pinLatLng = latlng;
    if (!pinMarker) {
      pinMarker = L.marker(latlng, { draggable: true }).addTo(map);
      pinMarker.on('dragend', () => {
        const ll = pinMarker.getLatLng();
        setPin(ll);
        refresh();
      });
    } else {
      pinMarker.setLatLng(latlng);
    }
    els.pillPin.textContent = `Pin: ${latlng.lat.toFixed(5)}, ${latlng.lng.toFixed(5)}`;
    els.pillScope.textContent = `${els.radiusKm.value} km / ${els.sinceHours.value}h`;
    els.geoHelp.textContent = `Location set: ${latlng.lat.toFixed(5)}, ${latlng.lng.toFixed(5)} (drag pin to adjust).`;
  }

  map.on('click', (e) => {
    if (!pinDropMode) return;
    pinDropMode = false;
    els.btnDropPin.textContent = 'Drop pin';
    setPin(e.latlng);
    refresh();
  });

  els.btnDropPin.addEventListener('click', () => {
    pinDropMode = !pinDropMode;
    els.btnDropPin.textContent = pinDropMode ? 'Click map…' : 'Drop pin';
  });

  // Feed render helpers
  function sevClass(s) {
    if (s === 'high') return 'sev-high';
    if (s === 'med') return 'sev-med';
    return 'sev-low';
  }
  function fmtTime(iso) {
    try {
      const d = new Date(iso);
      return d.toLocaleString();
    } catch(e) { return iso || ''; }
  }

  function clearPostMarkers() {
    for (const m of postMarkers) {
      try { map.removeLayer(m); } catch(e) {}
    }
    postMarkers = [];
  }

  function renderPosts(allItems, visibleItems) {
    const visibleIds = new Set((visibleItems || []).map(p => p.id));
    els.postList.innerHTML = '';
    clearPostMarkers();

    const count = (visibleItems || []).length;
    // Count badge (pill) in the POSTS header
    if (els.pillCount) els.pillCount.textContent = String(count);

    if (!count) {
      els.postList.innerHTML = `<div class="hint">No posts found for this radius/time window.</div>`;
    } else {
      for (const p of visibleItems) {
        const div = document.createElement('div');
        div.className = 'post-card';
        div.innerHTML = `
          <div class="row1">
            <div class="title">${escapeHtml(p.title || '(untitled)')}</div>
            <div class="pill ${String(p.severity || '').toLowerCase()}">${escapeHtml(p.severity || '')}</div>
          </div>
          <div class="meta">
            <span class="tag">${escapeHtml(p.category || '')}</span>
            <span>${escapeHtml(formatWhen(p.observed_at || p.created_at))}</span>
            <span>${escapeHtml(p.geo_label || 'Approx. pin')}</span>
          </div>
          <div class="excerpt">${escapeHtml((p.body||'').slice(0, 160))}${(p.body||'').length>160?'…':''}</div>
        `;
        div.addEventListener('click', () => selectPost(p));
        els.postList.appendChild(div);
      }
    }

    // Always show markers for all fetched posts; dim ones outside current radius filter
    for (const p of (allItems || [])) {
      if (typeof p.lat !== 'number' || typeof p.lng !== 'number') continue;
      const isVisible = visibleIds.has(p.id);
      const mk = L.circleMarker([p.lat, p.lng], {
        radius: isVisible ? 7 : 5,
        weight: 2,
        opacity: isVisible ? 0.9 : 0.35,
        fillOpacity: isVisible ? 0.35 : 0.12
      }).addTo(map);
      mk.on('click', () => selectPost(p));
      postMarkers.push(mk);
    }
  }

  function selectPost(p) {
    els.detailEmpty.style.display = 'none';
    els.detailBody.style.display = 'block';

    // Load comments from API on-demand, but fall back to local storage.
    (async () => {
      let apiComments = [];
      try {
        const res = await apiFetch(API_BASE + '/api/neighbor/comments?post_id=' + encodeURIComponent(p.id), { method:'GET' });
        if (res.ok) {
          const data = await res.json().catch(() => ({}));
          if (data && data.ok && Array.isArray(data.comments)) apiComments = data.comments;
        }
      } catch (e) {}

      const atts = Array.isArray(p.attachments) ? p.attachments : [];
      const localComments = getLocalComments(p.id);
      const comments = [...apiComments, ...localComments].sort((a,b)=>String(a.created_at||'').localeCompare(String(b.created_at||'')));

      els.detailBody.innerHTML = `
        <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;">
          <div>
            <div style="font-size:18px;font-weight:900;color:rgba(255,255,255,.95)">${escapeHtml(p.title || '')}</div>
            <div style="margin-top:6px;color:rgba(255,255,255,.65);font-size:12px;">
              <span class="pill ${sevClass(p.severity)}">${(p.severity||'').toUpperCase()}</span>
              <span class="pill">${escapeHtml(p.category||'other')}</span>
              <span style="margin-left:8px;">Observed: ${fmtTime(p.observed_at || p.created_at)}</span>
            </div>
          </div>
        </div>

        <div style="margin-top:14px;color:rgba(255,255,255,.85);line-height:1.45;white-space:pre-wrap;">${escapeHtml(p.body || '')}</div>

        <div style="margin-top:14px;color:rgba(255,255,255,.7);font-size:13px;">
          <div><b>Location:</b> ${escapeHtml(p.geo_label || 'Approx. pin')} • ${typeof p.lat==='number'?p.lat.toFixed(5):''}, ${typeof p.lng==='number'?p.lng.toFixed(5):''}</div>
          <div style="margin-top:6px;"><b>Actions taken:</b> ${escapeHtml(p.actions_taken || '—')}</div>
          <div style="margin-top:6px;"><b>Posted by:</b> ${escapeHtml(p.org_name || p.org_id || 'Org')} • ${fmtTime(p.created_at)}</div>
        </div>

        <div style="margin-top:14px;">
          <div class="ni-label">Attachments</div>
          <div>${atts.length ? atts.map(u => {
              const isData = typeof u === 'string' && u.startsWith('data:image');
              if (isData) return `<img src="${escapeAttr(u)}" style="max-width:100%;border-radius:12px;margin:6px 0"/>`;
              return `<a href="${escapeAttr(u)}" target="_blank" style="color:#ff8080">Open attachment</a>`;
            }).join('<br/>') : '<span style="color:rgba(255,255,255,.6)">None</span>'}</div>
        </div>

        <div style="margin-top:14px;">
          <div class="ni-label">Comments</div>
          <div id="niCommentsList">
            ${comments.length ? comments.map(c => `
              <div style="margin:8px 0;padding:10px;border:1px solid rgba(255,255,255,.1);border-radius:12px;background:rgba(0,0,0,.18)">
                <div style="font-size:12px;color:rgba(255,255,255,.6)">${escapeHtml(c.author || c.author_email || 'User')} • ${fmtTime(c.created_at)}</div>
                <div style="margin-top:6px;color:rgba(255,255,255,.85)">${escapeHtml(c.body||'')}</div>
              </div>
            `).join('') : '<span style="color:rgba(255,255,255,.6)">No comments yet.</span>'}
          </div>

          <div style="margin-top:12px;display:flex;gap:8px;align-items:flex-start;">
            <textarea id="niCommentInput" rows="3" placeholder="Add a comment…" style="flex:1;resize:vertical;min-height:72px;background:rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.14);border-radius:12px;color:#fff;padding:10px 12px;outline:none;"></textarea>
            <button id="niCommentSubmit" class="btn-outline-pill" style="height:38px;align-self:flex-end;">Post</button>
          </div>
          <div id="niCommentStatus" style="margin-top:6px;font-size:12px;color:rgba(255,255,255,.6)"></div>
        </div>
      `;

      wireCommentUI(p);
    })();

    if (pinLatLng && typeof p.lat === 'number' && typeof p.lng === 'number') {
      map.panTo([p.lat, p.lng]);
    }
  }

  function wireCommentUI(p) {
    const commentBtn = document.getElementById('niCommentSubmit');
    const commentInput = document.getElementById('niCommentInput');
    const commentStatus = document.getElementById('niCommentStatus');
    if (!commentBtn || !commentInput) return;

    commentBtn.addEventListener('click', async () => {
      const body = (commentInput.value || '').trim();
      if (!body) {
        if (commentStatus) commentStatus.textContent = 'Type a comment first.';
        return;
      }
      commentBtn.disabled = true;
      if (commentStatus) commentStatus.textContent = 'Posting…';

      const c = { author: userEmail || 'User', body, created_at: new Date().toISOString() };
      addLocalComment(p.id, c);
      commentInput.value = '';

      try { selectPost(p); } catch(e) {}

      try {
        const res = await apiFetch(API_BASE + '/api/neighbor/comments', {
          method: 'POST',
          body: JSON.stringify({ post_id: p.id, body })
        });
        if (res.ok) {
          if (commentStatus) commentStatus.textContent = 'Posted.';
          // refresh the detail panel to show API comments (author_email, ids)
          try { selectPost(p); } catch(e) {}
        } else {
          if (commentStatus) commentStatus.textContent = 'Saved locally (API error).';
        }
      } catch (e) {
        if (commentStatus) commentStatus.textContent = 'Saved locally (API unavailable).';
      }
      commentBtn.disabled = false;
    });
  }


  function escapeHtml(s) {
    return String(s || '').replace(/[&<>"']/g, (c) => {
      return { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c];
    });
  }
  function escapeAttr(s) {
    return String(s || '').replace(/"/g,'&quot;');
  }

  // Minimal toast so we don't depend on any external UI lib
  function toast(message, detail=''){
    const host = document.getElementById('niToasts');
    if(!host){ console.warn('toast:', message, detail); return; }
    const el = document.createElement('div');
    el.className = 'ni-toast';
    el.innerHTML = `${escapeHtml(message)}${detail?`<small>${escapeHtml(detail)}</small>`:''}`;
    host.appendChild(el);
    setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(6px)'; }, 2600);
    setTimeout(()=>{ el.remove(); }, 3200);
  }

  // API calls (with local fallback if Worker missing)
  function makeQuery() {
    const q = new URLSearchParams();
    // If a pin is set, apply radius filtering. If not, fetch "recent posts" globally.
    if (pinLatLng) {
      q.set('lat', String(pinLatLng.lat));
      q.set('lng', String(pinLatLng.lng));
      q.set('radiusKm', els.radiusKm.value);
    }
    q.set('sinceHours', els.sinceHours.value);
    if (els.severity.value) q.set('severity', els.severity.value);
    if (els.category.value) q.set('category', els.category.value);
    return q.toString();
  }

  async function apiFetch(url, opts) {
    const headers = Object.assign({
      'Content-Type':'application/json',
      'X-User-Email': userEmail || '',
    }, (opts && opts.headers) || {});
    const res = await fetch(url, Object.assign({}, opts, { headers }));
    return res;
  }

  function localKey() { return 'ci_neighbor_posts_v1'; }
  function localRead(key = 'ni_posts_cache') {
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : [];
    } catch (e) { return []; }
  }

function localWrite(key = 'ni_posts_cache', items = []) {
    try { localStorage.setItem(key, JSON.stringify(items || [])); } catch (e) {}
  }

function localCommentKey() { return 'ci_neighbor_comments_v1'; }
  function localCommentsRead() {
    try { return JSON.parse(localStorage.getItem(localCommentKey()) || '{}'); } catch(e) { return {}; }
  }
  function localCommentsWrite(map) {
    localStorage.setItem(localCommentKey(), JSON.stringify(map || {}));
  }
  function getLocalComments(postId) {
    if (!postId) return [];
    const map = localCommentsRead();
    const arr = map[postId];
    return Array.isArray(arr) ? arr : [];
  }
  function addLocalComment(postId, comment) {
    if (!postId || !comment) return;
    const map = localCommentsRead();
    const arr = Array.isArray(map[postId]) ? map[postId] : [];
    arr.push(comment);
    map[postId] = arr;
    localCommentsWrite(map);
  }
  function haversineKm(a,b) {
    const R=6371;
    const dLat=(b.lat-a.lat)*Math.PI/180;
    const dLng=(b.lng-a.lng)*Math.PI/180;
    const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2);
    const aa=s1*s1+Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*s2*s2;
    return 2*R*Math.asin(Math.min(1,Math.sqrt(aa)));
  }


  function applyRadiusFilter(postsArr) {
    const arr = Array.isArray(postsArr) ? postsArr : [];
    if (!isPinSet()) return arr;
    const radiusKm = Number(els.radiusKm.value) || 1;
    return arr.filter(p => {
      if (typeof p.lat !== 'number' || typeof p.lng !== 'number') return false;
      const d = haversineKm({ lat: pinLatLng.lat, lng: pinLatLng.lng }, { lat: p.lat, lng: p.lng });
      return d <= radiusKm;
    });
  }

  // Badge pills (top-right of filter/map cards)
  function setPinBadge() {
    if (!els.pillPin) return;
    if (!pinLatLng) { els.pillPin.textContent = 'No pin'; return; }
    els.pillPin.textContent = `Pin: ${Number(pinLatLng.lat).toFixed(5)}, ${Number(pinLatLng.lng).toFixed(5)}`;
  }

  function setFilterBadge() {
    if (!els.pillScope) return;
    const radius = Number(els.radiusKm?.value || 1);
    const hrs = Number(els.sinceHours?.value || 12);
    els.pillScope.textContent = `${radius} km / ${hrs}h`;
  }


  async function refresh() {
    setFilterBadge();
    setPinBadge();

    const sinceHours = Number(els.sinceHours.value) || 24;
    const sev = els.severity.value || 'all';
    const cat = els.category.value || 'all';
    const cutoff = Date.now() - sinceHours * 3600 * 1000;

    // Always try server first (may ignore radius); fall back to cached/local posts.
    try {
      const qs = makeQuery(); // includes hours/severity/category when set
      const res = await fetch(`${ENDPOINT}?${qs}`, { headers: authHeaders() });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      allPosts = Array.isArray(data.posts) ? data.posts : [];
      localWrite('ni_posts_cache', allPosts);
    } catch (e) {
      console.warn('Using cached posts (fetch failed):', e);
      allPosts = localRead('ni_posts_cache') || [];
    }

    // Safety net filtering (in case backend returns more than requested)
    allPosts = (allPosts || []).filter(p => {
      const t = Date.parse(p.observed_at || p.created_at || '');
      if (Number.isFinite(t) && t < cutoff) return false;
      if (sev !== 'all' && String(p.severity || '').toLowerCase() !== sev) return false;
      if (cat !== 'all' && String(p.category || '').toLowerCase() !== cat) return false;
      return true;
    });

    visiblePosts = applyRadiusFilter(allPosts);
    renderPosts(allPosts, visiblePosts);
  }

els.btnRefresh.addEventListener('click', refresh);
  for (const el of [els.radiusKm, els.sinceHours, els.severity, els.category]) {
    el.addEventListener('change', refresh);
  }

  // Modal helpers
  
  function renderAttachPreview() {
    if (!els.attachInfo || !els.attachPreview) return;
    const files = Array.from(els.attachFiles?.files || []);
    if (!files.length) {
      els.attachInfo.textContent = 'No files selected.';
      els.attachPreview.innerHTML = '';
      return;
    }
    els.attachInfo.textContent = `${files.length} file${files.length===1?'':'s'} selected`;
    // lightweight preview thumbnails
    els.attachPreview.innerHTML = '';
    files.slice(0, 5).forEach(f => {
      const chip = document.createElement('div');
      chip.style.cssText = 'padding:6px 8px;border:1px solid rgba(255,255,255,.12);border-radius:10px;font-size:12px;color:rgba(255,255,255,.75)';
      chip.textContent = f.name;
      els.attachPreview.appendChild(chip);
    });
    if (files.length > 5) {
      const more = document.createElement('div');
      more.style.cssText = 'padding:6px 8px;border:1px dashed rgba(255,255,255,.18);border-radius:10px;font-size:12px;color:rgba(255,255,255,.65)';
      more.textContent = `+${files.length-5} more`;
      els.attachPreview.appendChild(more);
    }
  }

  if (els.attachPick && els.attachFiles) {
    els.attachPick.addEventListener('click', () => els.attachFiles.click());
    els.attachFiles.addEventListener('change', renderAttachPreview);
  }

  function openModal() {
    els.backdrop.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }
  function closeModal() {
    els.backdrop.style.display = 'none';
    document.body.style.overflow = '';
  }

  function seedObservedNow() {
    const d = new Date();
    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
    els.newObservedAt.value = d.toISOString().slice(0,16);
  }

  els.btnNewPost.addEventListener('click', () => {
    if (!pinLatLng) {
      pinDropMode = true;
      els.btnDropPin.textContent = 'Click map…';
      alert('Drop a pin on the map first so your post is location-scoped.');
      return;
    }
    seedObservedNow();
    els.newTitle.value = '';
    els.newBody.value = '';
    els.newActions.value = '';
    els.newAttachments.value = '';
    if (els.attachFiles) els.attachFiles.value = '';
    if (typeof renderAttachPreview === 'function') renderAttachPreview();
    els.newGeoLabel.value = '';
    els.newConfirm.checked = false;
    els.btnSubmitPost.disabled = true;
    openModal();
  });
  els.btnCloseModal.addEventListener('click', closeModal);
  els.btnCancelPost.addEventListener('click', closeModal);
  els.backdrop.addEventListener('click', (e) => {
    if (e.target === els.backdrop) closeModal();
  });

  function validatePost() {
    const ok = !!els.newConfirm.checked && !!els.newTitle.value.trim() && !!els.newBody.value.trim() && !!pinLatLng;
    els.btnSubmitPost.disabled = !ok;
  }
  for (const el of [els.newConfirm, els.newTitle, els.newBody]) {
    el.addEventListener('input', validatePost);
    el.addEventListener('change', validatePost);
  }

  
  
// Upload selected images to the Worker (which forwards to Cloudflare Images).
// Returns an array of image URLs (public variants).
async function uploadFilesToWorker(fileList, opts = {}) {
  const files = Array.from(fileList || []);
  if (!files.length) return [];

  const maxCount = opts.maxCount ?? 3;
  const maxBytes = opts.maxBytes ?? 5_000_000; // 5MB default
  const allowed = opts.allowedTypes ?? ['image/jpeg','image/png','image/webp','image/gif'];

  const pick = files.slice(0, maxCount);
  for (const f of pick) {
    if (allowed.length && !allowed.includes(f.type)) {
      throw new Error('Unsupported file type: ' + (f.type || 'unknown'));
    }
    if (f.size > maxBytes) {
      throw new Error('File too large (max ' + Math.round(maxBytes/1_000_000) + 'MB): ' + f.name);
    }
  }

  const fd = new FormData();
  for (const f of pick) fd.append('files', f, f.name);

  const res = await fetch(`${API_BASE}/api/neighbor/upload`, {
    method: 'POST',
    headers: authHeaders(),
    body: fd,
  });
  if (!res.ok) {
    const t = await res.text().catch(() => '');
    throw new Error('Upload failed: ' + res.status + ' ' + t);
  }
  const data = await res.json();
  if (!data?.ok) throw new Error(data?.error || 'Upload failed');
  return Array.isArray(data.urls) ? data.urls : [];
}


btnSubmitPost.addEventListener('click', async () => {
    if (els.btnSubmitPost.disabled) return;

    // Build attachments from URL field + uploaded files
    let attachments = [];
    const urlText = (els.newAttachments?.value || '').trim();
    if (urlText) {
      attachments = urlText.split(',').map(s => s.trim()).filter(Boolean);
    }

    try {
      const uploaded = await uploadFilesToWorker(els.attachFiles?.files, { maxCount: 5, maxBytes: 5_000_000 });
      attachments = attachments.concat(uploaded);
    } catch (e) {
      toast(e?.message || String(e), true);
      return;
    }

    const payload = {
      title: els.newTitle.value.trim(),
      body: els.newBody.value.trim(),
      category: els.newCategory.value,
      severity: els.newSeverity.value,
      observed_at: new Date(els.newObservedAt.value).toISOString(),
      lat: pinLatLng.lat,
      lng: pinLatLng.lng,
      geo_label: els.newGeoLabel.value.trim(),
      radius_km: Number(els.radiusKm.value),
      actions_taken: els.newActions.value.trim(),
      attachments: attachments,
    };

    try {
      const res = await apiFetch(ENDPOINT, {
        method: 'POST',
        body: JSON.stringify(payload),
      });
      if (!res.ok) throw new Error('bad_status_' + res.status);
      const data = await res.json();
      if (!data?.ok) throw new Error(data?.error || 'bad_payload');
      closeModal();
      await refresh();
      return;
    } catch(e) {
      // local fallback
      const all = localRead();
      const id = 'local_' + Math.random().toString(16).slice(2);
      all.unshift(Object.assign({ id, created_at: new Date().toISOString(), org_name: 'Local', org_id: 'local', comments: [] }, payload));
      localWrite('ni_posts_cache', all);
      closeModal();
      await refresh();
    }
  });

  // Initial help
  els.postList.innerHTML = `<div style="padding:14px;color:rgba(255,255,255,.65)">Showing recent posts. Drop a pin to filter by radius.</div>`;

  // Initial load: default to org HQ if available so posts show immediately
  (async () => {
    const hq = await loadOrgHQ();
    if (hq) {
      map.setView([hq.lat, hq.lng], 12);
      setPin(L.latLng(hq.lat, hq.lng));
      setPinBadge();
    } else {
      // Keep existing default view but ensure zoom ~12
      try { map.setZoom(12); } catch (_) {}
    }
    await refresh();
  })();
})();</script>



<script>
(function mountTopActions(){
  const host = document.getElementById('topActions');
  if (!host) return;

  // Helper: initials from name/email
  const initialsOf = (nameOrEmail='CI') => {
    const s = String(nameOrEmail).trim();
    if (!s) return 'CI';
    if (s.includes('@')) return s[0].toUpperCase();
    const parts = s.split(/\s+/);
    return (parts[0]?.[0]||'C').toUpperCase() + (parts[1]?.[0]||'I').toUpperCase();
  };

  // Logged-in view (CIAuth)
  if (window.CIAuth && CIAuth.isLoggedIn()) {
    const u = CIAuth.who(); // {name,email,role,subscribed?...}
    const initials = initialsOf(u.name || u.email);
    const role = u.role || 'Member';
    const isAdmin = String(role).toLowerCase() === 'admin';

    host.innerHTML = `
      <div class="user" id="userChip" style="cursor:pointer">
        <div class="avatar">${initials}</div>
        ${role}
      </div>
      <div class="dropdown" id="userMenu">
        ${isAdmin ? `<a href="analytics.html">Analytics</a><a href="system-flow.html">System Flow</a><a href="operationslog.html">Operations Log</a>` : ``}
        <a href="settings.html">Manage Billing</a>
        <a href="#" id="logoutLink">Log out</a>
      </div>
    `;

    const chip = document.getElementById('userChip');
    const menu = document.getElementById('userMenu');
    chip.addEventListener('click', () => {
      menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
    });
    document.addEventListener('click', (e) => {
      if (!host.contains(e.target)) menu.style.display = 'none';
    });

    document.getElementById('logoutLink').addEventListener('click', (e) => {
      e.preventDefault();
      try { CIAuth.logout(); } catch(_) {}
      location.href = 'index.html';
    });

  } else {
    // Logged-out view: Login pill with return param
    const here = location.pathname.split('/').pop() || 'index.html';
    const next = encodeURIComponent(here + location.search + location.hash);
    host.innerHTML = `<a class="login-btn" href="login.html?next=${next}">Log in</a>`;
  }
})();
</script>

<div id="niToasts" class="ni-toasts" aria-live="polite" aria-atomic="true"></div>


</body>
</html>
