<!doctype html>
<html lang="en">
<head>

  <!-- auth + metrics -->
  <script src="auth.js"></script>
  <script src="metrics.js"></script>

  <!-- login/subscription guards -->
  <script>
  (function pageGuard(){
    const NEED_LOGIN = true;   // require login
    const NEED_SUB   = false;  // flip to true later to paywall
    if (NEED_LOGIN && (!window.CIAuth || !CIAuth.isLoggedIn())) {
      const here = location.pathname.split('/').pop() || 'index.html';
      const next = encodeURIComponent(here + location.search + location.hash);
      location.href = 'login.html?next=' + next;
      return;
    }
    if (NEED_SUB) {
      const isSub = localStorage.getItem('ci_subscribed') === 'true';
      if (!isSub) {
        location.href = 'subscribe.html';
        return;
      }
    }
  })();
  </script>

  <!-- compat shim so legacy code reading ci_profile still works -->
  <script>
  (function compatProfileShim(){
    if (!window.CIAuth || !CIAuth.isLoggedIn()) return;
    const u = CIAuth.who();
    if (!u) return;
    localStorage.setItem('ci_profile', JSON.stringify({
      name: u.name || 'CityIntel User',
      email: u.email,
      role:  u.role || 'Admin',
      is_admin: (u.role||'').toLowerCase()==='admin'
    }));
  })();
  </script>

  <meta charset="utf-8" />
  <title>CityIntel â€” Live Feed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --brand-red:#D01616;
      --gray-900:#111214;
      --gray-800:#16171a;
      --gray-700:#1c1e22;
      --gray-650:#1a1c20;
      --gray-600:#24272c;
      --gray-500:#2e3238;
      --text:#e9edf2;
      --muted:#8e97a3;
    }

    body{
      margin:0;
      font:14px/1.5 system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      color:var(--text);
      background:linear-gradient(180deg,var(--gray-900),var(--gray-800));
    }

    /* overall 2-col layout */
    .app{
      display:grid;
      grid-template-columns:260px 1fr;
      min-height:100vh;
      position:relative; /* so overlay can anchor */
    }

    /* sidebar */
    .sidebar{
      background:#0c0c0c;
      border-right:1px solid var(--gray-600);
      display:flex;
      flex-direction:column;
      padding:18px 14px;
      gap:18px;
    }
    nav a{
      display:flex;
      align-items:center;
      padding:10px 12px;
      border-radius:10px;
      text-decoration:none;
      color:var(--text);
      border:1px solid transparent;
      font-size:14px;
    }
    nav a:hover{
      background:var(--gray-600);
      border-color:var(--gray-500);
    }
    nav a.active{
      background:rgba(208,22,22,0.15);
      border-color:var(--brand-red);
    }
    .footnote{
      margin-top:auto;
      font-size:12px;
      color:var(--muted);
    }

    /* brand bar at top */
    .brandbar{
      display:flex;
      align-items:center;
      gap:10px;
      padding:16px 20px;
      border-bottom:1px solid var(--gray-600);
      background:linear-gradient(90deg,rgba(208,22,22,.2),rgba(208,22,22,0));
      position:relative;
    }
    .brandbar img{
      width:auto;
      height:60px;
      object-fit:contain;
      border-radius:6px;
      background:#fff;
    }
    .brandbar .title{
      font-weight:700;
      font-size:18px;
    }

    /* trial countdown in the bar */
    #trial-banner{
      display:none;
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      background:none;
      color:#fecaca;
      padding:8px 12px;
      text-align:center;
      font-size:13px;
      line-height:1.3;
      white-space:nowrap;
    }

    /* right side chip */
    #topActions{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:10px;
      min-width:fit-content;
      position:relative;
    }
    .user{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:12px;
      background:#1c1e22;
      border:1px solid #24272c;
      cursor:pointer;
    }
    .avatar{
      width:28px;
      height:28px;
      background:#fff;
      color:#000;
      border-radius:50%;
      display:grid;
      place-items:center;
      font-weight:700;
      font-size:13px;
    }
    .dropdown{
      position:absolute;
      right:0;
      top:calc(100% + 6px);
      background:#1a1c20;
      border:1px solid #24272c;
      border-radius:10px;
      padding:6px 0;
      box-shadow:0 4px 12px rgba(0,0,0,.4);
      display:none;
      min-width:160px;
      z-index:50;
    }
    .dropdown a{
      display:block;
      padding:8px 12px;
      color:#e9edf2;
      text-decoration:none;
      font-size:14px;
    }
    .dropdown a:hover{
      background:rgba(255,255,255,0.05);
    }

    /* login pill */
    .login-btn{
      display:inline-block;
      padding:8px 12px;
      border-radius:999px;
      background:#D01616;
      border:1px solid #9c0f0f;
      color:#fff;
      font-weight:700;
      text-decoration:none;
      white-space:nowrap;
      font-size:13px;
      line-height:1.2;
    }
    .login-btn:hover{ filter:brightness(1.05); }

    /* MAIN area */
    .main{
      padding:20px;
      min-width:0;
    }

    /* top row inside main */
    .main-toprow{
      display:flex;
      flex-wrap:wrap;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:16px;
    }
    .main-toprow-left h2{
      color:var(--text);
      margin:0 0 4px;
      font-size:18px;
      font-weight:600;
    }
    .main-toprow-left p{
      margin:0;
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
      max-width:600px;
    }

    .add-feed-btn{
      align-self:flex-start;
      background:#D01616;
      border:1px solid #9c0f0f;
      color:#fff;
      padding:8px 12px;
      line-height:1.2;
      border-radius:999px;
      font-size:13px;
      font-weight:700;
      cursor:pointer;
      text-decoration:none;
      white-space:nowrap;
    }
    .add-feed-btn:hover{ filter:brightness(1.05); }

    /* feeds grid: responsive 3-up -> 2-up -> 1-up */
    .feeds-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(min(360px,100%),1fr));
      gap:16px;
    }

    .feed-card{
      background:linear-gradient(180deg,#1a1c20,#131417);
      border:1px solid var(--gray-600);
      border-radius:16px;
      padding:16px;
      min-height:260px;
      display:flex;
      flex-direction:column;
    }

    .feed-head{
      display:flex;
      flex-wrap:wrap;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:12px;
    }
    .feed-title{
      font-size:14px;
      font-weight:600;
      color:var(--text);
      margin:0;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
    }
    .filter-dots{
      color:var(--muted);
      font-size:12px;
      line-height:1.3;
    }
    .feed-head-right{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:8px;
      flex-shrink:0;
    }
    .small-btn{
      font-size:12px;
      line-height:1.2;
      padding:6px 8px;
      border-radius:8px;
      background:#1c1e22;
      border:1px solid #2e3238;
      color:var(--text);
      text-decoration:none;
      cursor:pointer;
    }
    .small-btn.danger{
      background:rgba(208,22,22,.12);
      border-color:#D01616;
      color:#ff5a5f;
    }

    .feed-body{
      flex:1;
      min-height:180px;
      font-size:13px;
      line-height:1.4;
      color:var(--text);
      border-top:1px solid var(--gray-600);
      padding-top:12px;
      overflow:auto;
      max-height:280px;
    }

    .event-row{
      border-left:4px solid #ff5a5f;
      background:linear-gradient(90deg,rgba(255,90,95,.12),rgba(255,90,95,0));
      border-radius:10px;
      padding:10px 12px;
      margin-bottom:10px;
      cursor:pointer;
    }
    .event-row.med{
      border-left-color:#f0b429;
      background:linear-gradient(90deg,rgba(240,180,41,.12),rgba(240,180,41,0));
    }
    .event-topline{
      font-size:13px;
      font-weight:600;
      color:var(--text);
      margin-bottom:4px;
    }
    .event-meta{
      font-size:11px;
      color:var(--muted);
      margin-bottom:6px;
    }
    .event-src a{
      font-size:11px;
      color:#8e97a3;
      text-decoration:none;
    }
    .event-src a:hover{
      text-decoration:underline;
    }

    /* --- slide-over panel + backdrop --- */
    .details-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.5);
      display:none;
      z-index:400;
    }
    .details-panel{
      position:fixed;
      top:0;
      right:0;
      height:100vh;
      width:360px;
      max-width:85%;
      background:linear-gradient(180deg,#1a1c20,#131417);
      border-left:1px solid var(--gray-600);
      box-shadow:-20px 0 40px rgba(0,0,0,.8);
      padding:16px;
      color:var(--text);
      font-size:13px;
      line-height:1.4;
      display:flex;
      flex-direction:column;
      transform:translateX(100%);
      transition:transform .22s ease;
      z-index:401;
    }
    .details-panel.open{
      transform:translateX(0);
    }
    .panel-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px;
      margin-bottom:12px;
    }
    .panel-head-left h3{
      margin:0;
      font-size:15px;
      font-weight:600;
      color:var(--text);
      line-height:1.3;
    }
    .panel-head-left .meta-line{
      color:var(--muted);
      font-size:12px;
      line-height:1.3;
      margin-top:4px;
    }
    .panel-close-btn{
      background:#1c1e22;
      border:1px solid #2e3238;
      border-radius:8px;
      color:var(--text);
      font-size:12px;
      line-height:1.2;
      padding:6px 8px;
      cursor:pointer;
    }
    .panel-section{
      background:#0f1012;
      border:1px solid var(--gray-600);
      border-radius:12px;
      padding:12px;
      margin-bottom:12px;
    }
    .panel-section h4{
      margin:0 0 6px;
      font-size:12px;
      font-weight:600;
      color:var(--text);
      text-transform:uppercase;
      letter-spacing:.03em;
    }
    .panel-section p{
      margin:0;
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }
    .distance-chip{
      display:inline-block;
      background:#1c1e22;
      border:1px solid #2e3238;
      border-radius:8px;
      padding:4px 6px;
      font-size:12px;
      line-height:1.2;
      color:var(--text);
      margin-top:4px;
    }
    .mini-map{
      background:#1c1e22;
      border:1px solid #2e3238;
      border-radius:8px;
      height:120px;
      display:grid;
      place-items:center;
      color:#8e97a3;
      font-size:12px;
    }

    @media(max-width:900px){
      .app{
        grid-template-columns:1fr;
      }
      .sidebar{
        display:none;
      }
    }
  </style>
</head>

<body>

  <!-- Brand bar -->
  <div class="brandbar">
    <img src="CityintLogo.jpg" alt="CityIntel Logo">
    <div class="title">CityIntel</div>

    <div id="trial-banner">
      <span id="trial-text">Your trial ends soon.</span>
    </div>

    <div id="topActions" style="position:relative"></div>
  </div>

  <div class="app">

    <!-- Sidebar -->
    <aside class="sidebar">
      <nav>
        <a href="index.html">Dashboard</a>
        <a href="alerts.html">Alerts</a>
        <a href="events.html">Events</a>
        <a class="active" href="live-feed.html">Live Feed</a>
        <a href="brief.html">Intelligence Brief</a>
        <a href="incident.html">Incident Drilldown</a>
        <a href="reports.html">Reports</a>
        <a href="trends.html">Trends & Forecasts</a>
        <a href="sources.html">Sources</a>
        <a href="settings.html">Settings</a>
        <a href="about.html">About</a>
      </nav>
      <div class="footnote">
        For information use only â€” not for redistribution
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main">

      <div class="main-toprow">
        <div class="main-toprow-left">
          <h2>Live Feeds</h2>
          <p>Streaming situational chatter and incident reports for your selected locations. High / Medium risk is highlighted first.</p>
        </div>

        <button id="addFeedBtn" class="add-feed-btn">+ Add Feed</button>
      </div>

      <div id="feedsGrid" class="feeds-grid"></div>

    </main>

    <!-- Backdrop for slide-over -->
    <div id="detailsBackdrop" class="details-backdrop"></div>

    <!-- Slide-over details panel -->
    <aside id="detailsPanel" class="details-panel" aria-hidden="true">
      <div class="panel-head">
        <div class="panel-head-left">
          <h3 id="panelTitle">Incident title goes here</h3>
          <div class="meta-line" id="panelMeta">London â€¢ High risk â€¢ 20 Oct 14:22</div>
        </div>
        <button class="panel-close-btn" id="panelCloseBtn">Close</button>
      </div>

      <div class="panel-section">
        <h4>Location detail</h4>
        <p id="panelLocationText">Stratford, East London (approx.)</p>
        <div class="distance-chip" id="panelDistanceChip">~2.1 km from HQ</div>
      </div>

      <div class="panel-section">
        <h4>Map / Proximity</h4>
        <div class="mini-map" id="panelMapBox">
          Map preview coming soon
        </div>
      </div>

      <div class="panel-section">
        <h4>Recent in this city</h4>
        <p id="panelHistory">
          â€¢ Police presence reported earlier near Stratford.<br/>
          â€¢ Road closures causing disruption to transport hubs.
        </p>
      </div>
    </aside>

  </div><!-- /.app -->

  <!-- highlight active sidebar link -->
  <script>
  (function(){
    const here = location.pathname.split('/').pop() || 'index.html';
    document.querySelectorAll("aside.sidebar nav a").forEach(a=>{
      if(a.getAttribute("href")===here) a.classList.add("active");
    });
  })();
  </script>

  <!-- trial countdown -->
  <script>
  (function(){
    const API_BASE = 'https://api.cityintelapi.com';
    const bar = document.getElementById('trial-banner');
    const txt = document.getElementById('trial-text');

    function who(){ try { return JSON.parse(localStorage.getItem('ci_profile')||'{}'); } catch { return {}; } }

    function startCountdown(endIso){
      const end = new Date(endIso).getTime();
      function tick(){
        const now = Date.now();
        const ms = end - now;
        if (ms <= 0){
          bar.style.display = 'none';
          location.href = 'subscribe.html?reason=trial_ended';
          return;
        }
        const s = Math.floor(ms/1000);
        const d = Math.floor(s/86400);
        const h = Math.floor((s%86400)/3600);
        const m = Math.floor((s%3600)/60);
        const sec = s%60;
        const parts=[];
        if(d) parts.push(d+'d');
        parts.push(
          String(h).padStart(2,'0')+'h',
          String(m).padStart(2,'0')+'m',
          String(sec).padStart(2,'0')+'s'
        );
        txt.textContent = 'Trial active â€” ends in ' + parts.join(' ');
        bar.style.display = '';
      }
      tick();
      return setInterval(tick,1000);
    }

    (async function init(){
      const p = who();
      if(!p.email) return;
      try{
        const u = new URL(API_BASE + '/api/sub-status');
        u.searchParams.set('email', p.email);
        const r = await fetch(u);
        if(!r.ok) return;
        const data = await r.json();
        if(data.trialEndsAt){
          startCountdown(data.trialEndsAt);
        }
      }catch(e){
        console.warn('trial banner error', e);
      }
    })();
  })();
  </script>

  <!-- user chip dropdown -->
  <script>
  (function mountTopActions(){
    const host = document.getElementById('topActions');
    if (!host) return;

    function initialsOf(nameOrEmail='CI') {
      const s = String(nameOrEmail).trim();
      if (!s) return 'CI';
      if (s.includes('@')) return s[0].toUpperCase();
      const parts = s.split(/\s+/);
      return (parts[0]?.[0]||'C').toUpperCase() + (parts[1]?.[0]||'I').toUpperCase();
    }

    if (window.CIAuth && CIAuth.isLoggedIn()) {
      const u = CIAuth.who();
      const initials = initialsOf(u.name || u.email);
      const role = u.role || 'Member';
      const isAdmin = String(role).toLowerCase() === 'admin';

      host.innerHTML = `
        <div class="user" id="userChip">
          <div class="avatar">${initials}</div>
          ${role}
        </div>
        <div class="dropdown" id="userMenu">
          ${isAdmin ? `
            <a href="analytics.html">Analytics</a>
            <a href="system-flow.html">System Flow</a>
            <a href="operationslog.html">Operations Log</a>` : ``}
          <a href="settings.html">Manage Billing</a>
          <a href="#" id="logoutLink">Log out</a>
        </div>
      `;

      const chip = document.getElementById('userChip');
      const menu = document.getElementById('userMenu');
      chip.addEventListener('click', ()=>{
        menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
      });
      document.addEventListener('click', (e)=>{
        if (!host.contains(e.target)) menu.style.display='none';
      });

      document.getElementById('logoutLink').addEventListener('click', (e)=>{
        e.preventDefault();
        try { CIAuth.logout(); } catch(_){}
        location.href='index.html';
      });

    } else {
      const here = location.pathname.split('/').pop() || 'index.html';
      const next = encodeURIComponent(here + location.search + location.hash);
      host.innerHTML = `<a class="login-btn" href="login.html?next=${next}">Log in</a>`;
    }
  })();
  </script>

  <!-- Live Feed logic with persistence + details panel -->
  <script>
  (function(){
    const API_BASE = 'https://api.cityintelapi.com';
    const STORAGE_KEY = 'ci_live_feeds';

    // our in-memory feeds array
    let feeds = [];

    // details panel refs
    const panel = document.getElementById('detailsPanel');
    const backdrop = document.getElementById('detailsBackdrop');
    const closeBtn = document.getElementById('panelCloseBtn');
    const panelTitle = document.getElementById('panelTitle');
    const panelMeta  = document.getElementById('panelMeta');
    const panelLocationText = document.getElementById('panelLocationText');
    const panelDistanceChip = document.getElementById('panelDistanceChip');
    const panelMapBox = document.getElementById('panelMapBox');
    const panelHistory = document.getElementById('panelHistory');

    function openPanel(ev){
      // populate mock detail using the event row data
      const city = ev.city || 'Unknown city';
      const risk = ev.risk || 'med';
      const whenPretty = new Date(ev.when).toLocaleString('en-GB',{
        day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'
      });

      panelTitle.textContent = ev.title || (city + ' incident');
      panelMeta.textContent  = `${city} â€¢ ${risk.charAt(0).toUpperCase()+risk.slice(1)} risk â€¢ ${whenPretty}`;

      // mock location detail (placeholder: "Stratford, East London")
      panelLocationText.textContent = city + ' central district (approx.)';

      // fake distance from HQ
      panelDistanceChip.textContent = '~2 km from HQ';

      // small "map"
      panelMapBox.textContent = 'Map preview for ' + city;

      // "recent" history in that city
      panelHistory.innerHTML = `
        â€¢ Earlier report in ${city} about police presence.<br/>
        â€¢ Traffic disruption still ongoing.<br/>
        â€¢ Monitoring continues.
      `;

      // show
      panel.classList.add('open');
      panel.setAttribute('aria-hidden','false');
      backdrop.style.display = 'block';
    }

    function closePanel(){
      panel.classList.remove('open');
      panel.setAttribute('aria-hidden','true');
      backdrop.style.display = 'none';
    }

    backdrop.addEventListener('click', closePanel);
    closeBtn.addEventListener('click', closePanel);

    // ---------- helpers ----------
    function randPick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function nowISO(){ return new Date().toISOString(); }

    function generateMockEvents(cities, riskFilter){
      const risks = ['high','med','low'];
      const out=[];
      for(let i=0;i<5;i++){
        const city = randPick(cities);
        const r = randPick(risks);
        if(riskFilter.length && !riskFilter.includes(r)) continue;
        out.push({
          id: city + '_' + Date.now() + '_' + i,
          title: 'Incident unfolding near ' + city,
          city,
          risk: r,
          when: nowISO(),
          src: 'Simulated Source'
        });
      }
      // sort so high first, then med, then low
      out.sort((a,b)=>{
        const pr = rr=> rr==='high'?0: rr==='med'?1:2;
        return pr(a.risk)-pr(b.risk) || (new Date(b.when)-new Date(a.when));
      });
      return out;
    }

    async function fetchLiveFeed(cities, risks){
      // call Worker /api/live (mock right now) and fall back to generated
      const url = new URL(API_BASE + '/api/live');
      if (cities.length) url.searchParams.set('cities', cities.join(','));
      if (risks.length)  url.searchParams.set('risk', risks.join(','));

      try {
        const res = await fetch(url.toString(), { headers: { Accept: 'application/json' } });
        if (!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        if (data && data.events && data.events.length) {
          return data.events;
        } else {
          console.warn('Empty live data; using mock');
          return generateMockEvents(cities, risks);
        }
      } catch (err) {
        console.warn('fetchLiveFeed failed:', err);
        return generateMockEvents(cities, risks);
      }
    }

    function saveFeeds(){
      try {
        // save the visible events too, so refresh survives reload
        const minimal = feeds.map(f => ({
          cities: f.cities,
          risks: f.risks,
          events: f.events || []
        }));
        localStorage.setItem(STORAGE_KEY, JSON.stringify(minimal));
      } catch(e){
        console.warn('saveFeeds failed', e);
      }
    }

    function loadFeeds(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return [];
        const arr = JSON.parse(raw);
        if(!Array.isArray(arr)) return [];
        return arr.map(f => ({
          cities: f.cities || [],
          risks: f.risks || [],
          events: Array.isArray(f.events) ? f.events : []
        }));
      }catch(e){
        console.warn('loadFeeds failed', e);
        return [];
      }
    }

    // ---------- DOM refs ----------
    const feedsGrid = document.getElementById('feedsGrid');
    const addBtn    = document.getElementById('addFeedBtn');

    // ---------- render ----------
    function renderFeeds(){
      feedsGrid.innerHTML = '';
      if(!feeds.length){
        feedsGrid.innerHTML = `
          <div class="feed-card" style="text-align:center;justify-content:center;min-height:200px">
            <div style="color:var(--muted);font-size:13px;line-height:1.4;">
              No feeds yet.<br/>Click "Add Feed" to start watching locations.
            </div>
          </div>`;
        return;
      }

      feeds.forEach((feed, idx)=>{
        // build body
        let bodyHTML='';
        if(feed.events && feed.events.length){
          feed.events.forEach(ev=>{
            const high = (ev.risk==='high');
            const cls = high ? 'event-row' : 'event-row med';
            const whenPretty = new Date(ev.when).toLocaleString('en-GB',{
              day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'
            });
            const riskLabel = ev.risk==='high'?'High':'Medium';
            // embed data attributes on clickable row for panel
            bodyHTML += `
              <div class="${cls}" 
                   data-city="${ev.city||''}" 
                   data-title="${ev.title||''}" 
                   data-risk="${ev.risk||''}" 
                   data-when="${ev.when||''}">
                <div class="event-topline">${ev.city} â€” ${ev.title}</div>
                <div class="event-meta">${whenPretty} â€¢ ${riskLabel} risk</div>
                <div class="event-src">
                  <a href="#" target="_blank" rel="noopener">Source: ${ev.src}</a>
                </div>
              </div>`;
          });
        } else {
          bodyHTML = `<div style="color:var(--muted);font-size:12px;">No recent items.</div>`;
        }


   // âœ… Step A: Make each event clickable â†’ incident.html
          const evId = ev.id || `${ev.city}_${Date.now()}_${Math.floor(Math.random()*100000)}`;
          const stashKey = `ci_event_${evId}`;
          sessionStorage.setItem(stashKey, JSON.stringify(ev));

          bodyHTML += `
            <div class="${cls}" data-ev-id="${evId}"
                 data-city="${ev.city||''}"
                 data-title="${ev.title||''}"
                 data-risk="${ev.risk||''}"
                 data-when="${ev.when||''}">
              <div class="event-topline">${ev.city} â€” ${ev.title}</div>
              <div class="event-meta">${whenPretty} â€¢ ${riskLabel} risk</div>
              <div class="event-src"><a href="#" target="_blank" rel="noopener">Source: ${ev.src}</a></div>
            </div>`;
        });
      } else {
        bodyHTML = `<div style="color:var(--muted);font-size:12px;">No recent items.</div>`;
      }



        const riskStr = feed.risks.length
          ? feed.risks.map(r=>r[0].toUpperCase()+r.slice(1)).join(', ')
          : 'All';
        const citiesStr = feed.cities.join(', ');

        const card = document.createElement('div');
        card.className = 'feed-card';
        card.innerHTML = `
          <div class="feed-head">
            <div class="feed-head-left">
              <div class="feed-title">
                <span>${citiesStr}</span>
                <span class="filter-dots">â€¢ Risk: ${riskStr}</span>
              </div>
            </div>
            <div class="feed-head-right">
              <button class="small-btn" data-type="refresh" data-idx="${idx}">Refresh</button>
              <button class="small-btn danger" data-type="remove" data-idx="${idx}">Remove</button>
            </div>
          </div>
          <div class="feed-body">${bodyHTML}</div>
        `;
        feedsGrid.appendChild(card);
      });
    }

// Event delegation for clicks
  feedsGrid.addEventListener('click', (e)=>{
    const t = e.target;
    if(!(t instanceof HTMLElement)) return;

    const row = t.closest('.event-row');
    if (row) {
      const evId = row.getAttribute('data-ev-id');
      if (evId) {
        window.location.href = `incident.html?from=live&event=${encodeURIComponent(evId)}`;
        return;
      }
    }

    const btn = t.closest('button.small-btn');
    if(!btn) return;
    const type = btn.getAttribute('data-type');
    const idx  = Number(btn.getAttribute('data-idx'));
    if(type === 'remove') removeFeed(idx);
    else if(type === 'refresh') refreshFeed(idx);
  });




    // ---------- actions ----------
    async function refreshFeed(i){
      const f = feeds[i];
      if(!f) return;
      // pull from Worker (fallback to mock)
      f.events = await fetchLiveFeed(f.cities, f.risks);
      renderFeeds();
      saveFeeds();
    }

    function removeFeed(i){
      feeds.splice(i,1);
      renderFeeds();
      saveFeeds();
    }

    async function addFeed(){
      const citiesInput = prompt(
        'Which locations? (comma separated)\nExample: London, Paris, Berlin'
      );
      if(!citiesInput) return;
      const rawCities = citiesInput.split(',').map(s=>s.trim()).filter(Boolean);
      if(!rawCities.length) return;

      const riskInput = prompt(
        'Risk filter? (high,med,low or blank for all)\nExample: high,med'
      );
      const rawRisks = (riskInput||'')
        .split(',')
        .map(s=>s.trim().toLowerCase())
        .filter(Boolean);

      const newFeed = {
        cities: rawCities,
        risks: rawRisks,
        events: [] // we'll fill after first refresh
      };
      feeds.push(newFeed);
      renderFeeds();
      saveFeeds();
      // prime it with data
      const idx = feeds.length-1;
      refreshFeed(idx);
    }

    // click handlers - add feed / refresh / remove + row click for panel
    addBtn.addEventListener('click', addFeed);

    feedsGrid.addEventListener('click', (e)=>{
      const t = e.target;
      if(!(t instanceof HTMLElement)) return;

      // row click for panel
      const row = t.closest('.event-row');
      if (row) {
        const ev = {
          city: row.getAttribute('data-city') || '',
          title: row.getAttribute('data-title') || '',
          risk: row.getAttribute('data-risk') || '',
          when: row.getAttribute('data-when') || ''
        };
        openPanel(ev);
        return;
      }

      // button click logic
      const btn = t.closest('button.small-btn');
      if(!btn) return;
      const type = btn.getAttribute('data-type');
      const idx  = Number(btn.getAttribute('data-idx'));

      if(type === 'remove'){
        removeFeed(idx);
      } else if(type === 'refresh'){
        refreshFeed(idx);
      }
    });

    // ---------- init ----------
    feeds = loadFeeds();
    if(!feeds.length){
      feeds = [{ cities:['London','Paris'], risks:['high','med'], events:[] }];
    }
    renderFeeds();
    // refresh each feed once on load to get current data
    feeds.forEach((_,i)=>refreshFeed(i));
    // background refresh every 30s
    setInterval(()=>{ feeds.forEach((_,i)=>refreshFeed(i)); }, 30000);

  })();
  </script>

  <script src="admin-links.js"></script>
</body>
</html>
