<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CityIntel — Live Feed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --g900:#111214; --g800:#16171a; --g700:#1c1e22; --g600:#2e3238;
      --text:#e9edf2; --muted:#8e97a3; --danger:#ff5a5f; --warn:#f0b429;
      --ok:#33c48d;}

    body{ margin:0; background:linear-gradient(180deg,var(--g900),var(--g800));
      color:var(--text); font:14px/1.6 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      min-height:100vh; display:flex; flex-direction:column;}

    /* Top bar (like our other pages) */
    .topbar{ background:rgba(255,255,255,.03); border-bottom:1px solid var(--g600);
      display:flex; align-items:center; gap:12px; padding:10px 16px;
      position:sticky; top:0; z-index:10; backdrop-filter:blur(8px);}
    
    .brand{ display:flex; align-items:center; gap:10px; font-weight:600; color:var(--text);
      font-size:14px;}
    
    .brand img{
      width:32px;
      height:32px;
      border-radius:8px;
      object-fit:cover;
      background:#000;
      border:1px solid var(--g600);
    }
    .page-title{
      font-size:14px;
      font-weight:600;
      color:var(--text);
    }
    .muted{
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
    }

    /* right side actions */
    .actions{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .btn{
      background:#1f2227;
      border:1px solid var(--g600);
      color:var(--text);
      font-size:12px;
      line-height:1.2;
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      text-decoration:none;
      font-weight:500;
    }
    .btn.red{
      background:rgba(208,22,22,.12);
      border-color:#D01616;
      color:#ff5a5f;
      font-weight:600;
    }

    /* main feeds area */
    .feeds-wrap{
      flex:1;
      display:flex;
      flex-direction:row;
      gap:16px;
      padding:16px;
      overflow-x:auto;
    }

    /* each feed column */
    .feed-col{
      background:linear-gradient(180deg,#1a1c20,#131417);
      border:1px solid var(--g600);
      border-radius:16px;
      min-width:300px;
      max-width:320px;
      display:flex;
      flex-direction:column;
      max-height:calc(100vh - 80px); /* so it fits on screen under topbar */
    }

    .feed-head{
      border-bottom:1px solid var(--g600);
      padding:12px 14px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .feed-row-top{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      font-size:13px;
      color:var(--text);
      font-weight:600;
      line-height:1.4;
    }
    .feed-loc{
      display:flex;
      flex-direction:column;
    }
    .feed-filters{
      font-size:11px;
      color:var(--muted);
      line-height:1.4;
    }

    .feed-remove{
      background:none;
      border:none;
      color:var(--muted);
      font-size:11px;
      line-height:1.2;
      padding:2px 6px;
      border-radius:6px;
      border:1px solid transparent;
      cursor:pointer;
    }
    .feed-remove:hover{
      border-color:var(--g600);
      color:#ff5a5f;
    }

    /* the scrolling body of posts */
    .feed-body{
      flex:1;
      overflow-y:auto;
      padding:12px 14px;
    }

    /* each post */
    .post{
      border:1px solid var(--g600);
      background:linear-gradient(90deg,rgba(208,22,22,.07),rgba(208,22,22,0));
      border-radius:12px;
      padding:10px 12px;
      margin-bottom:10px;
      font-size:13px;
      line-height:1.4;
      cursor:pointer;
    }
    .post.high{
      border-left:4px solid var(--danger);
    }
    .post.med{
      border-left:4px solid var(--warn);
      background:linear-gradient(90deg,rgba(240,180,41,.07),rgba(240,180,41,0));
    }
    .post.low{
      border-left:4px solid var(--ok);
      background:linear-gradient(90deg,rgba(51,196,141,.07),rgba(51,196,141,0));
    }

    .post-headline{
      color:var(--text);
      font-weight:600;
      margin-bottom:4px;
    }
    .post-meta{
      font-size:11px;
      color:var(--muted);
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .risk-pill{
      font-weight:600;
    }

    /* footer sticky below columns on mobile-ish sizes */
    .footerbar{
      display:flex;
      padding:12px 16px;
      border-top:1px solid var(--g600);
      background:rgba(255,255,255,.03);
      font-size:12px;
    }
    .footerbar a{
      color:#ff5a5f;
      text-decoration:none;
      font-weight:600;
    }

    @media(max-width:600px){
      .feed-col{
        min-width:85vw;
        max-width:85vw;
      }
    }
  </style>
</head>
<body>

  <!-- top bar -->
  <header class="topbar">
    <div class="brand">
      <img src="CityintLogo.jpg" alt="CityIntel Logo"/>
      <div class="page-title">
        Live Feed
        <div class="muted">Streaming incidents & chatter from your watch areas</div>
      </div>
    </div>

    <div class="actions">
      <!-- later this will open a modal to create a new feed column -->
      <button class="btn" id="addFeedBtn">Add Feed</button>

      <!-- back to dashboard -->
      <a class="btn red" href="index.html">Back to Dashboard</a>

      <!-- user chip slot (re-use same topActions pattern later if you want) -->
    </div>
  </header>

  <!-- feeds go here -->
  <main class="feeds-wrap" id="feedsWrap">
    <!-- JS will inject .feed-col here -->
  </main>

  <!-- tiny footer -->
  <div class="footerbar">
    <div style="margin-left:auto;">
      Tip: remove a column with “Remove”. You can track different regions side by side.
    </div>
  </div>

  <script>
  //
  // Live Feed client logic (temporary mock data + localStorage state)
  //

  // -------------- helpers --------------
  function nowISO() { return new Date().toISOString(); }

  function fmtTime(iso){
    const d = new Date(iso);
    if (isNaN(d)) return '';
    return d.toLocaleString('en-GB',{
      day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'
    });
  }

  function riskClass(r){
    const v = (r||'').toLowerCase();
    if (v.startsWith('hi')) return 'high';
    if (v.startsWith('me')) return 'med';
    return 'low';
  }
  function riskLabel(r){
    const v = (r||'').toLowerCase();
    if (v.startsWith('hi')) return 'HIGH';
    if (v.startsWith('me')) return 'MED';
    return 'LOW';
  }

  // generate a fake feed item (this will be replaced by backend later)
  function fakeItem(overrides={}){
    const samples = [
      {
        city:"London, UK",
        headline:"Protesters gathering outside Whitehall, increased police presence reported",
        risk:"High",
        ts:nowISO(),
        src:"https://news.example/london"
      },
      {
        city:"Paris, FR",
        headline:"Transit disruption near Gare du Nord after spontaneous sit-in",
        risk:"Med",
        ts:nowISO(),
        src:"https://news.example/paris"
      },
      {
        city:"Paris, FR",
        headline:"Union groups announce demonstration for tomorrow in central Paris",
        risk:"Low",
        ts:nowISO(),
        src:"https://news.example/paris2"
      }
    ];
    const pick = samples[Math.floor(Math.random()*samples.length)];
    return { ...pick, ...overrides };
  }

  // -------------- feed state model --------------
  // a "feed column" tracked in localStorage looks like:
  // {
  //   id: "feed_xxx",
  //   name: "London High Risk",
  //   filters: {
  //     cities:["London"],
  //     countries:[],
  //     risk:["high"],
  //     keywords:[]
  //   },
  //   items:[ {city,headline,risk,ts,src}, ... ]  // newest first
  // }

  function loadFeeds(){
    try {
      return JSON.parse(localStorage.getItem('ci_livefeeds')) || [];
    } catch(e){
      return [];
    }
  }
  function saveFeeds(feeds){
    localStorage.setItem('ci_livefeeds', JSON.stringify(feeds));
  }

  // make sure we have at least something on first load
  function ensureSeedFeeds(){
    let feeds = loadFeeds();
    if (!feeds.length){
      feeds = [
        {
          id:"feed_london",
          name:"London / High Risk",
          filters:{
            cities:["London"],
            countries:[],
            risk:["high"],
            keywords:[]
          },
          items:[
            fakeItem({
              city:"London, UK",
              headline:"Police deploy public order units near Westminster following online calls to rally",
              risk:"High"
            }),
            fakeItem({
              city:"London, UK",
              headline:"Road closure near Parliament Square after crowd surge",
              risk:"High"
            })
          ]
        },
        {
          id:"feed_paris",
          name:"Paris / All Risk",
          filters:{
            cities:["Paris"],
            countries:["France"],
            risk:["high","med","low"],
            keywords:[]
          },
          items:[
            fakeItem({
              city:"Paris, FR",
              headline:"Clashes between small group and CRS near Châtelet",
              risk:"Med"
            }),
            fakeItem({
              city:"Paris, FR",
              headline:"Metro delays Line 4 after protest spillover on platform",
              risk:"Low"
            })
          ]
        }
      ];
      saveFeeds(feeds);
    }
  }

  // remove a feed column
  function removeFeed(id){
    const feeds = loadFeeds().filter(f=>f.id!==id);
    saveFeeds(feeds);
    renderAllFeeds();
  }

  // later we'll push new items to each feed (poll backend per filter)
  function simulateIncoming(){
    const feeds = loadFeeds();
    let changed = false;
    feeds.forEach(f=>{
      // 30% chance to append a new item to each feed every tick
      if (Math.random() < 0.3){
        const cityLabel = (f.filters.cities[0] || f.filters.countries[0] || 'Location');
        const newRisk = (f.filters.risk && f.filters.risk.length===1)
          ? f.filters.risk[0]
          : ['High','Med','Low'][Math.floor(Math.random()*3)];
        f.items.unshift(fakeItem({
          city:`${cityLabel}`,
          risk:newRisk,
          headline:`New report in ${cityLabel} - crowd movement / police posture update`,
          ts:nowISO()
        }));
        // keep list from growing forever in demo
        f.items = f.items.slice(0,30);
        changed = true;
      }
    });
    if (changed){
      saveFeeds(feeds);
      renderAllFeeds();
    }
  }

  // render helpers
  function renderFeedCol(feed){
    const col = document.createElement('div');
    col.className = 'feed-col';

    // header
    const locLine = feed.name || (feed.filters.cities.join(', ') || feed.filters.countries.join(', ') || 'Custom Feed');
    const filterBits = [];
    if (feed.filters.risk && feed.filters.risk.length){
      filterBits.push("Risk: " + feed.filters.risk.join(', '));
    }
    if (feed.filters.keywords && feed.filters.keywords.length){
      filterBits.push("Keywords: " + feed.filters.keywords.join(', '));
    }

    col.innerHTML = `
      <div class="feed-head">
        <div class="feed-row-top">
          <div class="feed-loc">
            <div>${locLine}</div>
            <div class="feed-filters">${filterBits.join(' • ') || 'All signals'}</div>
          </div>
          <button class="feed-remove" data-feed="${feed.id}">Remove</button>
        </div>
      </div>
    `;

    // body
    const body = document.createElement('div');
    body.className = 'feed-body';

    if (!feed.items || !feed.items.length){
      body.innerHTML = `<div style="color:var(--muted);font-size:12px;">No activity yet.</div>`;
    } else {
      feed.items.forEach(item=>{
        const cls = 'post ' + riskClass(item.risk);
        const div = document.createElement('div');
        div.className = cls;
        div.innerHTML = `
          <div class="post-headline">${item.city} — ${item.headline}</div>
          <div class="post-meta">
            <span>${fmtTime(item.ts)}</span>
            <span class="risk-pill">${riskLabel(item.risk)}</span>
          </div>
        `;
        if (item.src){
          div.addEventListener('click', ()=>{
            window.open(item.src,'_blank','noopener');
          });
        }
        body.appendChild(div);
      });
    }

    col.appendChild(body);
    return col;
  }

  function renderAllFeeds(){
    const wrap = document.getElementById('feedsWrap');
    if (!wrap) return;
    wrap.innerHTML = '';
    const feeds = loadFeeds();
    feeds.forEach(f=>{
      wrap.appendChild(renderFeedCol(f));
    });

    // hook up remove buttons
    wrap.querySelectorAll('.feed-remove').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-feed');
        removeFeed(id);
      });
    });
  }

  // boot
  ensureSeedFeeds();
  renderAllFeeds();

  // pretend we're getting new intel every 20 seconds
  setInterval(simulateIncoming, 20000);

// ---- Add Feed modal logic ----
const modal = document.getElementById('addFeedModal');
const addBtn = document.getElementById('addFeedBtn');
const cancelBtn = document.getElementById('cancelFeedBtn');
const createBtn = document.getElementById('createFeedBtn');

addBtn.addEventListener('click', () => {
  modal.classList.add('active');
});

cancelBtn.addEventListener('click', () => {
  modal.classList.remove('active');
});

modal.querySelector('.modal-backdrop').addEventListener('click', () => {
  modal.classList.remove('active');
});

createBtn.addEventListener('click', () => {
  const name = document.getElementById('feedName').value.trim();
  const cities = document.getElementById('feedCities').value.split(',').map(x=>x.trim()).filter(Boolean);
  const keywords = document.getElementById('feedKeywords').value.split(',').map(x=>x.trim()).filter(Boolean);
  const risk = Array.from(modal.querySelectorAll('.risk-options input:checked')).map(x=>x.value);

  if (!name && !cities.length) {
    alert('Please enter at least a name or one city/country.');
    return;
  }

  const feeds = loadFeeds();
  const newFeed = {
    id: 'feed_' + Math.random().toString(36).slice(2,8),
    name: name || (cities.join(', ') || 'Custom Feed'),
    filters: { cities, countries:[], risk, keywords },
    items: []
  };

  feeds.push(newFeed);
  saveFeeds(feeds);
  renderAllFeeds();

  modal.classList.remove('active');
  document.getElementById('feedName').value = '';
  document.getElementById('feedCities').value = '';
  document.getElementById('feedKeywords').value = '';
  modal.querySelectorAll('.risk-options input').forEach(cb=>cb.checked=true);
});

  </script>

  <!-- We’re *not* doing auth gating here yet. We'll plug CIAuth.requireAuth() later
       once we confirm layout and you're happy with the UX. -->


  <!-- Add Feed Modal -->
<div id="addFeedModal" style="display:none;">
  <div class="modal-backdrop"></div>
  <div class="modal-box">
    <h3>Add New Feed</h3>
    <label>
      <div>Feed Name</div>
      <input id="feedName" placeholder="e.g. London High Risk" />
    </label>

    <label>
      <div>Cities / Countries</div>
      <input id="feedCities" placeholder="e.g. London, Paris" />
    </label>

    <div class="risk-options">
      <div>Risk Levels</div>
      <label><input type="checkbox" value="high" checked> High</label>
      <label><input type="checkbox" value="med" checked> Medium</label>
      <label><input type="checkbox" value="low" checked> Low</label>
    </div>

    <label>
      <div>Keywords (optional)</div>
      <input id="feedKeywords" placeholder="e.g. protest, police" />
    </label>

    <div class="modal-actions">
      <button id="createFeedBtn" class="btn">Create Feed</button>
      <button id="cancelFeedBtn" class="btn red">Cancel</button>
    </div>
  </div>
</div>

<style>
/* ---------- Modal styling ---------- */
#addFeedModal {
  position: fixed;
  inset: 0;
  z-index: 200;
  display: none;
}
#addFeedModal.active {
  display: block;
}
#addFeedModal .modal-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(3px);
}
#addFeedModal .modal-box {
  position: relative;
  max-width: 400px;
  background: var(--g800);
  border: 1px solid var(--g600);
  border-radius: 16px;
  padding: 20px;
  margin: 80px auto;
  color: var(--text);
}
#addFeedModal h3 {
  margin-top: 0;
  font-size: 16px;
  color: var(--text);
}
#addFeedModal label {
  display: block;
  margin: 10px 0;
  font-size: 13px;
}
#addFeedModal input[type="text"],
#addFeedModal input[type="email"],
#addFeedModal input {
  width: 100%;
  background: #1a1c20;
  border: 1px solid var(--g600);
  border-radius: 8px;
  padding: 8px;
  color: var(--text);
  font-size: 13px;
}
#addFeedModal .risk-options {
  margin-top: 10px;
  font-size: 13px;
}
#addFeedModal .risk-options label {
  margin-right: 10px;
}
.modal-actions {
  margin-top: 15px;
  text-align: right;
  display: flex;
  gap: 10px;
  justify-content: flex-end;
}
</style>

</body>
</html>
