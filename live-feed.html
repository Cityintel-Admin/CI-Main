<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CityIntel — Live Feeds</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --g900:#111214;
      --g800:#16171a;
      --g700:#1c1e22;
      --g600:#2e3238;
      --text:#e9edf2;
      --muted:#8e97a3;
      --danger:#ff5a5f;
      --warn:#f0b429;
      --ok:#33c48d;
    }

    body{
      margin:0;
      background:linear-gradient(180deg,var(--g900),var(--g800));
      color:var(--text);
      font:14px/1.6 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }

    /* Page layout: top brand bar + main content */
    .brandbar {
      background:rgba(255,255,255,.03);
      border-bottom:1px solid var(--g600);
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 16px;
      position:sticky;
      top:0;
      z-index:50;
      backdrop-filter:blur(8px);
    }
    .brandbar .left {
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brandbar img {
      width:32px;
      height:32px;
      border-radius:6px;
      object-fit:cover;
    }
    .brandbar .title {
      font-weight:700;
      font-size:18px;
      color:var(--text);
    }

    .brandbar .trial-wrap{
      flex:1;
      display:flex;
      justify-content:center;
    }
    #trial-banner{
      display:none;
      background:none;
      color:#fecaca;
      font-size:13px;
      line-height:1.4;
      text-align:center;
      padding:6px 12px;
      border-radius:8px;
      border:1px solid rgba(255,90,95,.4);
      background:rgba(208,22,22,.12);
    }

    /* Right side: user chip / dropdown area */
    .brandbar .right {
      margin-left:auto;
      position:relative;
    }

    /* Main wrap */
    .main-wrap{
      padding:18px 16px 80px;
      max-width:1600px;
      margin:0 auto;
    }

    .page-head{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:10px;
      margin-bottom:16px;
    }
    .page-head h2{
      margin:0;
      font-size:16px;
      font-weight:600;
      color:var(--text);
    }
    .hint{
      font-size:12px;
      color:var(--muted);
    }
    .spacer{
      flex:1;
    }

    .btn{
      background:#2e3238;
      color:var(--text);
      border:1px solid var(--g600);
      border-radius:10px;
      font-size:13px;
      line-height:1.2;
      font-weight:500;
      padding:8px 10px;
      cursor:pointer;
    }
    .btn.red{
      background:rgba(208,22,22,.15);
      border-color:#D01616;
      color:#ff5a5f;
    }

    /* Masonry-ish columns area */
    .feeds-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(min(320px,100%),1fr));
      gap:16px;
    }

    /* Each feed column card */
    .feed-col{
      background:linear-gradient(180deg,#1a1c20,#131417);
      border:1px solid var(--g600);
      border-radius:16px;
      display:flex;
      flex-direction:column;
      max-height:80vh;
      min-height:320px;
    }

    .feed-head{
      padding:12px 16px;
      border-bottom:1px solid var(--g600);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
    }
    .feed-head .meta{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }
    .feed-title{
      font-weight:600;
      color:var(--text);
      font-size:14px;
      line-height:1.4;
    }
    .feed-remove{
      color:#ff5a5f;
      border:1px solid rgba(255,90,95,.4);
      background:rgba(208,22,22,.1);
      border-radius:8px;
      font-size:11px;
      line-height:1.2;
      padding:4px 8px;
      cursor:pointer;
    }

    .feed-body{
      flex:1;
      overflow-y:auto;
      min-height:0;
      padding:12px 16px;
      font-size:13px;
    }

    /* individual alert row */
    .alert-row{
      border:1px solid var(--g600);
      border-left:4px solid var(--danger);
      background:linear-gradient(90deg,rgba(208,22,22,.1),rgba(208,22,22,0));
      border-radius:12px;
      padding:10px 12px;
      margin-bottom:10px;
      cursor:pointer;
    }
    .alert-row.med{
      border-left-color:var(--warn);
      background:linear-gradient(90deg,rgba(240,180,41,.1),rgba(240,180,41,0));
    }
    .alert-row.low{
      border-left-color:var(--ok);
      background:linear-gradient(90deg,rgba(51,196,141,.1),rgba(51,196,141,0));
    }
    .alert-top{
      font-weight:600;
      color:var(--text);
      font-size:13px;
    }
    .alert-meta{
      font-size:11px;
      color:var(--muted);
      margin-top:4px;
      line-height:1.4;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }

    .pill{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      font-weight:700;
      font-size:10px;
      line-height:1.2;
      border:1px solid rgba(255,255,255,.15)
    }
    .pill.high{
      color:var(--danger);
      background:rgba(255,90,95,.12);
      border-color:rgba(255,90,95,.35)
    }
    .pill.med{
      color:var(--warn);
      background:rgba(240,180,41,.12);
      border-color:rgba(240,180,41,.35)
    }
    .pill.low{
      color:var(--ok);
      background:rgba(51,196,141,.12);
      border-color:rgba(51,196,141,.35)
    }

    /* --------- Add Feed Modal ---------- */
    #addFeedModal {
      position: fixed;
      inset: 0;
      z-index: 200;
      display: none;
    }
    #addFeedModal.active {
      display: block;
    }
    #addFeedModal .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(3px);
    }
    #addFeedModal .modal-box {
      position: relative;
      max-width: 400px;
      background: var(--g800);
      border: 1px solid var(--g600);
      border-radius: 16px;
      padding: 20px;
      margin: 80px auto;
      color: var(--text);
    }
    #addFeedModal h3 {
      margin-top: 0;
      font-size: 16px;
      color: var(--text);
    }
    #addFeedModal label {
      display: block;
      margin: 10px 0;
      font-size: 13px;
    }
    #addFeedModal input {
      width: 100%;
      background: #1a1c20;
      border: 1px solid var(--g600);
      border-radius: 8px;
      padding: 8px;
      color: var(--text);
      font-size: 13px;
    }
    #addFeedModal .risk-options {
      margin-top: 10px;
      font-size: 13px;
    }
    #addFeedModal .risk-options label {
      margin-right: 10px;
    }
    .modal-actions {
      margin-top: 15px;
      text-align: right;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    /* back link at bottom */
    .back-row{
      text-align:center;
      margin-top:24px;
    }
    .back-row a{
      color:#ff5a5f;
      text-decoration:none;
      font-size:13px;
      border:1px solid rgba(255,90,95,.4);
      background:rgba(208,22,22,.1);
      border-radius:8px;
      padding:8px 10px;
      display:inline-block;
    }

    /* simple scrollbar tweak for feed-body */
    .feed-body::-webkit-scrollbar{
      width:6px;
    }
    .feed-body::-webkit-scrollbar-track{
      background:#0f0f10;
      border-radius:999px;
    }
    .feed-body::-webkit-scrollbar-thumb{
      background:#3a3f46;
      border-radius:999px;
    }

    @media(max-width:600px){
      .brandbar{
        flex-wrap:wrap;
        align-items:flex-start;
      }
      .brandbar .right{
        order:3;
        width:100%;
        text-align:right;
      }
      .brandbar .trial-wrap{
        order:2;
        width:100%;
        justify-content:center;
      }
      .brandbar .left{
        order:1;
      }
    }
  </style>
</head>
<body>

  <!-- Brand / top bar -->
  <div class="brandbar">
    <div class="left">
      <img src="CityintLogo.jpg" alt="CityIntel Logo">
      <div class="title">CityIntel</div>
    </div>

    <div class="trial-wrap">
      <div id="trial-banner">
        <span id="trial-text">Your trial ends soon.</span>
      </div>
    </div>

    <div class="right">
      <!-- user chip will mount here -->
      <div id="topActions" style="position:relative"></div>
    </div>
  </div>

  <main class="main-wrap">

    <div class="page-head">
      <div>
        <h2>My Live Feeds</h2>
        <div class="hint">Streaming incidents, protest chatter, police activity, risk signals</div>
      </div>
      <div class="spacer"></div>
      <button class="btn" id="addFeedBtn">+ Add Feed</button>
    </div>

    <div id="feedsGrid" class="feeds-grid">
      <!-- columns injected here -->
    </div>

    <div class="back-row">
      <a href="index.html">Back to Dashboard</a>
    </div>
  </main>


  <!-- Add Feed Modal -->
  <div id="addFeedModal">
    <div class="modal-backdrop"></div>
    <div class="modal-box">
      <h3>Add New Feed</h3>

      <label>
        <div>Feed Name</div>
        <input id="feedName" placeholder="e.g. London High Risk">
      </label>

      <label>
        <div>Cities / Countries</div>
        <input id="feedCities" placeholder="e.g. London, Paris">
      </label>

      <div class="risk-options">
        <div>Risk Levels</div>
        <label><input type="checkbox" value="high" checked> High</label>
        <label><input type="checkbox" value="med" checked> Medium</label>
        <label><input type="checkbox" value="low" checked> Low</label>
      </div>

      <label>
        <div>Keywords (optional)</div>
        <input id="feedKeywords" placeholder="e.g. protest, police">
      </label>

      <div class="modal-actions">
        <button id="createFeedBtn" class="btn">Create Feed</button>
        <button id="cancelFeedBtn" class="btn red">Cancel</button>
      </div>
    </div>
  </div>


  <script src="auth.js"></script>
  <script src="admin-links.js"></script>
  <script>
  // -------------------------
  // Access control + trial banner
  // -------------------------
  (function initAccessAndTrial(){
    // Require login
    if (window.CIAuth && CIAuth.requireAuth) {
      CIAuth.requireAuth('login.html');
    }

    // trial banner logic (optional)
    try {
      const subscribed = localStorage.getItem('ci_subscribed') === 'true';
      const trialEnds = null; // you can later pull trial info from KV if you store it
      const banner = document.getElementById('trial-banner');
      const txt = document.getElementById('trial-text');

      if (!subscribed && banner && txt) {
        banner.style.display = 'inline-block';
        txt.textContent = trialEnds
          ? `Trial active until ${trialEnds}`
          : `Trial active — upgrade required for long-term access`;
      }
    } catch(e){}
  })();


  // -------------------------
  // Feed persistence helpers
  // -------------------------
  function loadFeeds(){
    try {
      return JSON.parse(localStorage.getItem('ci_livefeeds')||'[]');
    } catch(e){ return []; }
  }
  function saveFeeds(list){
    localStorage.setItem('ci_livefeeds', JSON.stringify(list));
  }

  // Helper for fake row content (placeholder live items)
  function generateDemoItems(feed){
    // feed.filters might include {cities, risk, keywords}
    // we'll just synthesize 4 stub events using first city if available
    const cityLabel = (feed.filters.cities && feed.filters.cities[0]) || 'City';
    const risk = (feed.filters.risk && feed.filters.risk[0]) || 'high';

    const demo = [];
    for (let i=0;i<4;i++){
      const level = ['high','med','low'][i%3];
      const now = new Date(Date.now() - i*3600000);
      demo.push({
        title: `${cityLabel}: ${level === 'high' ? 'Protest activity' : level === 'med' ? 'Police presence' : 'Traffic/slowdown'}`,
        city: cityLabel,
        risk: level,
        when: now.toLocaleString('en-GB',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}),
        src: 'Open Source / Social'
      });
    }
    return demo;
  }

  // Risk pill label
  function pillHTML(level){
    const cls = level==='high'?'high':level==='med'?'med':'low';
    const nice = level==='high'?'High':level==='med'?'Medium':'Low';
    return `<span class="pill ${cls}">${nice}</span>`;
  }

  // Render one feed column
  function renderFeedCol(feed){
    // pick data (for now demo only)
    const entries = generateDemoItems(feed);

    const locText = feed.filters.cities.length
      ? feed.filters.cities.join(', ')
      : (feed.filters.countries && feed.filters.countries.length
        ? feed.filters.countries.join(', ')
        : 'Any location');

    const riskText = (feed.filters.risk||[]).join(', ') || 'all';

    const box = document.createElement('section');
    box.className = 'feed-col';
    box.innerHTML = `
      <div class="feed-head">
        <div>
          <div class="feed-title">${feed.name}</div>
          <div class="meta">
            <div>Locations: ${locText}</div>
            <div>Risk: ${riskText}</div>
            ${feed.filters.keywords && feed.filters.keywords.length
              ? `<div>Keywords: ${feed.filters.keywords.join(', ')}</div>`
              : ''}
          </div>
        </div>
        <button class="feed-remove" data-id="${feed.id}">Remove</button>
      </div>
      <div class="feed-body">
        ${entries.map(ev=>`
          <div class="alert-row ${ev.risk}">
            <div class="alert-top">${ev.title}</div>
            <div class="alert-meta">
              <span>${ev.city}</span>
              <span>${ev.when}</span>
              <span>${pillHTML(ev.risk)}</span>
              <span>${ev.src}</span>
            </div>
          </div>
        `).join('')}
      </div>
    `;
    return box;
  }

  // Render all feeds into grid
  function renderAllFeeds(){
    const wrap = document.getElementById('feedsGrid');
    wrap.innerHTML = '';

    const feeds = loadFeeds();
    if (!feeds.length){
      const empty = document.createElement('div');
      empty.className = 'feed-col';
      empty.innerHTML = `
        <div class="feed-head">
          <div>
            <div class="feed-title">No feeds yet</div>
            <div class="meta">Click "Add Feed" to start monitoring cities, keywords, and risk levels in real-time.</div>
          </div>
        </div>
        <div class="feed-body">
          <div class="alert-row low">
            <div class="alert-top">Example: London protest chatter</div>
            <div class="alert-meta">
              <span>London</span>
              <span>14 Oct, 19:20</span>
              <span>${pillHTML('med')}</span>
              <span>Open Source / Social</span>
            </div>
          </div>
        </div>
      `;
      wrap.appendChild(empty);
      return;
    }

    feeds.forEach(f=>{
      wrap.appendChild(renderFeedCol(f));
    });

    // wire remove buttons
    wrap.querySelectorAll('.feed-remove').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-id');
        const all = loadFeeds().filter(f => f.id !== id);
        saveFeeds(all);
        renderAllFeeds();
      });
    });
  }

  // -------------------------
  // Add Feed modal logic
  // -------------------------
  const modal = document.getElementById('addFeedModal');
  const addBtn = document.getElementById('addFeedBtn');
  const cancelBtn = document.getElementById('cancelFeedBtn');
  const createBtn = document.getElementById('createFeedBtn');

  addBtn.addEventListener('click', () => {
    modal.classList.add('active');
  });

  cancelBtn.addEventListener('click', () => {
    modal.classList.remove('active');
  });

  modal.querySelector('.modal-backdrop').addEventListener('click', () => {
    modal.classList.remove('active');
  });

  createBtn.addEventListener('click', () => {
    const name = document.getElementById('feedName').value.trim();
    const cities = document.getElementById('feedCities').value
      .split(',')
      .map(x=>x.trim())
      .filter(Boolean);
    const keywords = document.getElementById('feedKeywords').value
      .split(',')
      .map(x=>x.trim())
      .filter(Boolean);
    const risk = Array.from(
      modal.querySelectorAll('.risk-options input:checked')
    ).map(x=>x.value);

    if (!name && !cities.length) {
      alert('Please enter at least a name or one city/country.');
      return;
    }

    const feeds = loadFeeds();
    const newFeed = {
      id: 'feed_' + Math.random().toString(36).slice(2,8),
      name: name || (cities.join(', ') || 'Custom Feed'),
      filters: {
        cities,
        countries: [], // future: allow separate country picker
        risk,
        keywords
      },
      items: []
    };

    feeds.push(newFeed);
    saveFeeds(feeds);
    renderAllFeeds();

    // reset + close
    modal.classList.remove('active');
    document.getElementById('feedName').value = '';
    document.getElementById('feedCities').value = '';
    document.getElementById('feedKeywords').value = '';
    modal.querySelectorAll('.risk-options input').forEach(cb=>cb.checked=true);
  });

  // initial paint
  renderAllFeeds();
  </script>
</body>
</html>
