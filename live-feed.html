<!DOCTYPE html>
<html lang="en">
<head>

<script src="auth.js"></script>
<script src="metrics.js"></script>
  
<script>
(function pageGuard(){
  const NEED_LOGIN = true;          // this page requires a login
  const NEED_SUB = false;           // set to true on pages that require an active sub

  // Must be logged in?
  if (NEED_LOGIN && (!window.CIAuth || !CIAuth.isLoggedIn())) {
    const here = location.pathname.split('/').pop() || 'index.html';
    const next = encodeURIComponent(here + location.search + location.hash);
    location.href = 'login.html?next=' + next;
    return;
  }

  // Must be subscribed?
  if (NEED_SUB) {
    const isSub = localStorage.getItem('ci_subscribed') === 'true';
    if (!isSub) {
      location.href = 'subscribe.html';
      return;
    }
  }
})();
</script>



  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CityIntel — Live Feed</title>
  <link rel="stylesheet" href="styles.css" />

  <style>

    :root{--brand-red:#D01616;--gray-900:#111214;--gray-800:#16171a;--gray-700:#1c1e22;--gray-600:#24272c;--gray-500:#2e3238;--text: #e9edf2}
    body{margin:0;font:14px/1.5 system-ui;background:linear-gradient(180deg,var(--gray-900),var(--gray-800));color:var(--text)}
 
   .app{display:grid;grid-template-columns:260px 1fr;grid-template-rows:60px 1fr;grid-template-areas:"sidebar topbar" "sidebar main";min-height:100vh}

    .sidebar{grid-area:sidebar;background:#0c0c0c;border-right:1px solid var(--gray-600);display:flex;flex-direction:column;padding:18px 14px;gap:18px}
    nav a{display:flex;align-items:center;padding:10px 12px;border-radius:10px;text-decoration:none;color:var(--text);border:1px solid transparent}
    nav a:hover{background:var(--gray-600);border-color:var(--gray-500)}
    nav a.active{background:rgba(208,22,22,0.15);border-color:var(--brand-red)}

#topActions{margin-left:auto;display:flex; align-items:center; gap:10px;min-width: fit-content;position: relative;}
    
    .user{ display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;
     background:#1c1e22;border:1px solid #24272c;cursor:pointer;}
    .avatar{ width:28px;height:28px;background:#fff;color:#000;border-radius:50%;

    .dropdown{ position:absolute;right:0;top:calc(100% + 6px);background:#1a1c20;border:1px solid #24272c;
     border-radius:10px;padding:6px 0;box-shadow:0 4px 12px rgba(0,0,0,.4);display:none;min-width:140px;z-index:50;}
    .dropdown a{display:block;padding:8px 12px;color:#e9edf2;text-decoration:none;font-size:14px}
    .dropdown a:hover{background:rgba(255,255,255,0.05)}





    /* Main area */
    .main-wrap {flex: 1;margin-left: 240px;min-height: 100vh;display: flex;flex-direction: column;}

  .brandbar{display:flex;align-items:center;gap:10px;padding:16px 20px;border-bottom:1px solid var(--line);
    background:linear-gradient(90deg,rgba(208,22,22,.2),rgba(208,22,22,0))}
  .brandbar img{width:auto;height:60px;object-fit:contain;border-radius:6px;background:#fff}

    .brandbar .title {font-weight: 700;font-size: 18px;}

    #trial-banner {
      position: absolute;
      bottom: -25px;
      left: 0;
      right: 0;
      text-align: center;
      color: #fecaca;
      font-size: 13px;
      font-weight: 500;
    }

    /* Header section */
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 24px;
      border-bottom: 1px solid #1f1f1f;
      flex-wrap: wrap;
    }

    .page-header h1 {
      font-size: 18px;
      color: #fff;
      font-weight: 600;
      margin: 0;
    }

    /* Add feed button */
    .add-feed-btn {
      background: #b91c1c;
      color: #fff;
      border: 1px solid #7f1d1d;
      border-radius: 9999px;
      font-size: 14px;
      font-weight: 600;
      padding: 8px 14px;
      line-height: 1.2;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.6);
      transition: background 0.15s, box-shadow 0.15s;
    }

    .add-feed-btn:hover {
      background: #dc2626;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.8);
    }

    .add-feed-btn .plus {
      font-weight: 700;
      font-size: 15px;
      line-height: 1;
    }

    /* Feed grid */
    #feed-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
      gap: 16px;
      align-items: start;
      padding: 24px;
    }

    /* Feed cards */
    .feed-card {
      background: radial-gradient(circle at 0% 0%, rgba(185, 28, 28, 0.12) 0%, rgba(0, 0, 0, 0) 60%),
        linear-gradient(to bottom right, #1a1c20 0%, #131417 100%);
      border: 1px solid rgba(255, 255, 255, 0.07);
      border-radius: 10px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.9);
      padding: 16px;
      min-height: 260px;
      display: flex;
      flex-direction: column;
      animation: fadeIn 0.5s ease forwards;
    }

    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(10px);}
      to {opacity: 1; transform: translateY(0);}
    }

    .feed-head {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-end;
      justify-content: space-between;
      margin-bottom: 12px;
      gap: 12px;
    }

    .feed-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 12px;
    }

    .feed-controls label {
      color: #9ca3af;
      font-size: 12px;
      line-height: 1.2;
      font-weight: 500;
      display: block;
      margin-bottom: 4px;
    }

    .feed-controls input,
    .feed-controls select {
      background-color: #0f1115;
      border: 1px solid #3f3f46;
      color: #fff;
      border-radius: 6px;
      font-size: 13px;
      line-height: 1.2;
      padding: 7px 8px;
      min-width: 130px;
    }

    .feed-controls input:focus,
    .feed-controls select:focus {
      outline: 2px solid #b91c1c;
      outline-offset: 0;
      border-color: #b91c1c;
    }

    .remove-btn {
      background: #1f2937;
      color: #fff;
      border: 1px solid #4b5563;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      padding: 7px 10px;
      cursor: pointer;
      height: 32px;
      line-height: 1.2;
      white-space: nowrap;
    }

    .remove-btn:hover {
      background: #b91c1c;
      border-color: #7f1d1d;
    }

    .feed-events {
      flex: 1;
      min-height: 140px;
      max-height: 220px;
      overflow-y: auto;
      padding-right: 6px;
      border-top: 1px solid rgba(255, 255, 255, 0.07);
      margin-top: 8px;
    }

    .event-row {
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      padding: 10px 0;
      font-size: 13px;
      line-height: 1.4;
      color: #e5e7eb;
    }

    .event-row:last-child {
      border-bottom: none;
    }

    .event-title {
      font-weight: 600;
      color: #fff;
      margin-bottom: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      word-break: break-word;
    }

    .risk-pill {
      font-size: 11px;
      font-weight: 600;
      line-height: 1;
      padding: 4px 6px;
      border-radius: 9999px;
      border: 1px solid rgba(0, 0, 0, 0.6);
      text-transform: capitalize;
    }

    .risk-high {background: #991b1b; color: #fff; border-color: #000;}
    .risk-med {background: #ca8a04; color: #000; border-color: #000;}
    .risk-low {background: #065f46; color: #e6fffa; border-color: #000;}

    .event-meta {
      font-size: 12px;
      color: #9ca3af;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .event-meta .dot {
      color: #4b5563;
    }

    .event-meta .src {
      color: #60a5fa;
      cursor: default;
    }
  </style>
</head>

<body>

  <div class="brandbar">
    <img src="CityintLogo.jpg" alt="CityIntel Logo">
    <div class="title" style="font-weight:700;font-size:18px">CityIntel</div>
	<div id="trial-banner" style="display:none;position:absolute;
    left:50%; transform:translateX(-50%); background:none;
    color:#fecaca; padding:8px 12px; text-align:center;">
  <span id="trial-text">Your trial ends soon.</span>
</div>	
	  <div id="topActions" style="position:relative"></div>
  </div>

 <div class="app">
  <aside class="sidebar">
 <div class="section-label"></div>
      <nav>
        <a href="index.html">Dashboard</a>
        <a href="alerts.html">Alerts</a>
        <a href="events.html">Events</a>
		<a href="live-feed.html">Live Feed</a>
	<a href="brief.html">Intelligence Brief</a>
	<a href="incident.html">Incident Drilldown</a>
	    <a href="reports.html">Reports</a>
	<a href="trends.html">Trends & Forecasts</a>
		<a href="sources.html">Sources</a>
        <a href="settings.html">Settings</a>
        <a href="about.html">About</a>
      </nav>
    </aside>

  <!-- Main -->
  <main class="main-wrap">

    <div class="page-header">
      <h1>Live Feeds</h1>
      <button id="addFeedBtn" class="add-feed-btn">
        <span class="plus">+</span>
        <span>Add Feed</span>
      </button>
    </div>

    <div id="feed-container"></div>
  </main>

  <script>
    const API_BASE = 'https://api.cityintelapi.com/api/live';
    let feedCounter = 0;

    document.getElementById('addFeedBtn').addEventListener('click', createFeed);

    function createFeed() {
      feedCounter++;
      const feedId = `feed-${feedCounter}`;
      const wrapper = document.createElement('div');
      wrapper.className = 'feed-card';
      wrapper.id = feedId;

      wrapper.innerHTML = `
        <div class="feed-head">
          <div class="feed-controls">
            <div>
              <label>Cities</label>
              <input type="text" class="cities-input" value="London,Paris">
            </div>
            <div>
              <label>Risk</label>
              <select class="risk-select" multiple size="3">
                <option value="high" selected>High</option>
                <option value="med" selected>Medium</option>
                <option value="low">Low</option>
              </select>
            </div>
          </div>
          <button class="remove-btn">Remove</button>
        </div>
        <div class="feed-events"></div>
      `;

      document.getElementById('feed-container').appendChild(wrapper);

      const removeBtn = wrapper.querySelector('.remove-btn');
      removeBtn.addEventListener('click', () => wrapper.remove());

      const citiesInput = wrapper.querySelector('.cities-input');
      const riskSelect = wrapper.querySelector('.risk-select');
      const eventsBox = wrapper.querySelector('.feed-events');

      async function refreshFeed() {
        const citiesVal = citiesInput.value.split(',').map(s => s.trim()).filter(Boolean);
        const selectedRisk = [...riskSelect.options].filter(o => o.selected).map(o => o.value);

        const url = new URL(API_BASE);
        if (citiesVal.length) url.searchParams.set('cities', citiesVal.join(','));
        if (selectedRisk.length) url.searchParams.set('risk', selectedRisk.join(','));

        try {
          const res = await fetch(url.toString(), { headers: { Accept: 'application/json' } });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();

          if (!data.events || !data.events.length) {
            eventsBox.innerHTML = `<div class="event-row" style="color:#9ca3af;">No recent activity.</div>`;
            return;
          }

          eventsBox.innerHTML = data.events.map(ev => {
            const riskClass = ev.risk === 'high' ? 'risk-high' : ev.risk === 'med' ? 'risk-med' : 'risk-low';
            return `
              <div class="event-row">
                <div class="event-title">
                  <span>${ev.title}</span>
                  <span class="risk-pill ${riskClass}">${ev.risk}</span>
                </div>
                <div class="event-meta">
                  <span>${ev.city}</span>
                  <span class="dot">•</span>
                  <span>${new Date(ev.when).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                  <span class="dot">•</span>
                  <span class="src">${ev.src}</span>
                </div>
              </div>
            `;
          }).join('');
        } catch (err) {
          eventsBox.innerHTML = `<div class="event-row" style="color:#ef4444;">Error fetching live data.</div>`;
        }
      }

      refreshFeed();
      const intervalId = setInterval(refreshFeed, 15000);

      const obs = new MutationObserver(() => {
        if (!document.body.contains(wrapper)) {
          clearInterval(intervalId);
          obs.disconnect();
        }
      });
      obs.observe(document.body, { childList: true, subtree: true });
    }

    // create first default feed
    createFeed();
  </script>
</body>
</html>
