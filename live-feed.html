<!doctype html>
<html lang="en">
<head>

  <script src="auth.js"></script>


<script>
(function pageGuard(){
  const NEED_LOGIN = true;          // this page requires a login
  const NEED_SUB = false;           // set to true on pages that require an active sub

  // Must be logged in?
  if (NEED_LOGIN && (!window.CIAuth || !CIAuth.isLoggedIn())) {
    const here = location.pathname.split('/').pop() || 'index.html';
    const next = encodeURIComponent(here + location.search + location.hash);
    location.href = 'login.html?next=' + next;
    return;
  }

  // Must be subscribed?
  if (NEED_SUB) {
    const isSub = localStorage.getItem('ci_subscribed') === 'true';
    if (!isSub) {
      location.href = 'subscribe.html';
      return;
    }
  }
})();
</script>

<script>
(function compatProfileShim(){
  if (!window.CIAuth || !CIAuth.isLoggedIn()) return;
  const u = CIAuth.who();
  if (!u) return;
  localStorage.setItem('ci_profile', JSON.stringify({
    name: u.name || 'CityIntel User',
    email: u.email,
    role: u.role || 'Admin',
    is_admin: (u.role||'').toLowerCase()==='admin'
  }));
  // Do NOT auto-set ci_subscribed here anymore
})();
</script>


  
  <meta charset="utf-8" />
  <title>CityIntel — Live Feed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <style>
      :root{--brand-red:#D01616;--gray-900:#111214;--gray-800:#16171a;--gray-700:#1c1e22;--gray-600:#24272c;--gray-500:#2e3238;--text:#e9edf2}
      body{margin:0;font:14px/1.5 system-ui;background:linear-gradient(180deg,var(--gray-900),var(--gray-800));color:var(--text)}

     .app{display:grid;grid-template-columns:260px 1fr;grid-template-rows:60px 1fr;grid-template-areas:"sidebar topbar" "sidebar main";min-height:100vh}
    .sidebar{grid-area:sidebar;background:#0c0c0c;border-right:1px solid var(--gray-600);display:flex;flex-direction:column;padding:18px 14px;gap:18px}
      nav a{display:flex;align-items:center;padding:10px 12px;border-radius:10px;text-decoration:none;color:var(--text);border:1px solid transparent}
      nav a:hover{background:var(--gray-600);border-color:var(--gray-500)}
      nav a.active{background:rgba(208,22,22,0.15);border-color:var(--brand-red)}

    .topbar{ grid-area: topbar;background: rgba(255,255,255,0.02);border-bottom:1px solid var(--brand-gray-600);display:flex; align-items:center; gap:12px;
     padding:10px 16px;position:sticky; top:0; z-index:10;backdrop-filter: blur(8px);}

#topActions{margin-left:auto;display:flex; align-items:center; gap:10px;min-width: fit-content;position: relative;}
    
    .user{ display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;
  background:#1c1e22;border:1px solid #24272c;cursor:pointer;
}
    .avatar{ width:28px;height:28px;background:#fff;color:#000;border-radius:50%;
  display:grid;place-items:center;font-weight:700;
}
    .dropdown{ position:absolute;right:0;top:calc(100% + 6px);background:#1a1c20;border:1px solid #24272c;
  border-radius:10px;padding:6px 0;box-shadow:0 4px 12px rgba(0,0,0,.4);display:none;min-width:140px;z-index:50;
}
    .dropdown a{display:block;padding:8px 12px;color:#e9edf2;text-decoration:none;font-size:14px}
    .dropdown a:hover{background:rgba(255,255,255,0.05)}

  .brandbar{display:flex;align-items:center;gap:10px;padding:16px 20px;border-bottom:1px solid var(--line);
    background:linear-gradient(90deg,rgba(208,22,22,.2),rgba(208,22,22,0))}
  .brandbar img{width:auto;height:60px;object-fit:contain;border-radius:6px;background:#fff}



    #trial-banner{
      flex:1;
      text-align:center;
      font-size:12px;
      font-weight:600;
      color:#fecaca;
    }


    .logout-link{
      color:#8e97a3;
      font-size:12px;
    }

    .main{
      grid-area:main;
      padding:18px;
    }

    .page-head{
      display:flex;
      align-items:flex-start;
      flex-wrap:wrap;
      gap:12px;
      margin-bottom:16px;
    }
    .page-head-left h2{
      margin:0;
      font-size:16px;
      font-weight:600;
      color:var(--text);
    }
    .page-head-left .sub{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }
    .page-head-right{
      margin-left:auto;
      display:flex;
      flex-direction:column;
      align-items:center;
      min-width:160px;
      gap:8px;
    }

    .btn-red{
      background:#D01616;
      color:#fff;
      font-size:13px;
      font-weight:600;
      border:1px solid #D01616;
      border-radius:10px;
      padding:8px 12px;
      cursor:pointer;
      line-height:1.2;
      text-align:center;
      min-width:140px;
    }
    .btn-red:hover{
      background:#ff2a2a;
      border-color:#ff2a2a;
    }

    .feeds-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(min(360px,100%),1fr));
      gap:16px;
    }

    .feed-card{
      background:linear-gradient(180deg,#1a1c20,#131417);
      border:1px solid var(--g600);
      border-radius:16px;
      display:flex;
      flex-direction:column;
      min-height:260px;
      max-height:400px;
    }

    .feed-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      border-bottom:1px solid var(--g600);
      padding:12px 16px;
    }
    .feed-head-left{
      font-size:13px;
      color:var(--text);
      line-height:1.4;
    }
    .feed-city{
      font-weight:600;
      font-size:14px;
      color:#fff;
    }
    .feed-risk{
      display:inline-block;
      font-size:11px;
      line-height:1.2;
      font-weight:600;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.15);
    }
    .feed-risk.high{
      background:rgba(255,90,95,.12);
      border-color:rgba(255,90,95,.35);
      color:#ff5a5f;
    }
    .feed-risk.med{
      background:rgba(240,180,41,.12);
      border-color:rgba(240,180,41,.35);
      color:#f0b429;
    }
    .feed-risk.low{
      background:rgba(51,196,141,.12);
      border-color:rgba(51,196,141,.35);
      color:#33c48d;
    }
    .feed-head-right{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:4px;
    }
    .btn-ghost{
      background:#1f2024;
      color:#e9edf2;
      border:1px solid var(--g600);
      border-radius:8px;
      padding:4px 8px;
      font-size:12px;
      line-height:1.2;
      cursor:pointer;
    }
    .btn-ghost:hover{
      background:#2a2d32;
    }

    .feed-body{
      flex:1;
      overflow-y:auto;
      padding:12px 16px 16px;
      font-size:13px;
    }
    .feed-item{
      border-left:4px solid #D01616;
      background:linear-gradient(90deg,rgba(208,22,22,.1),rgba(208,22,22,0));
      border-radius:8px;
      border:1px solid var(--g600);
      padding:10px 12px;
      margin-bottom:10px;
      cursor:pointer;
    }
    .feed-item:last-child{
      margin-bottom:0;
    }
    .feed-title-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:8px;
      font-size:13px;
      font-weight:600;
      color:#fff;
    }
    .feed-meta{
      font-size:11px;
      color:var(--muted);
      line-height:1.4;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }

    .feed-footer{
      border-top:1px solid var(--g600);
      padding:10px 16px;
      font-size:11px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .feed-footer .src{
      color:var(--muted);
    }
    .feed-footer .refresh{
      cursor:pointer;
      color:#8e97a3;
    }
    .feed-footer .refresh:hover{
      color:#fff;
    }

    /* slide-in detail panel */
    .detail-panel{
      position:fixed;
      top:0;
      right:0;
      height:100vh;
      width:360px;
      max-width:80%;
      background:#1a1c20;
      border-left:1px solid var(--g600);
      box-shadow:-20px 0 40px rgba(0,0,0,.8);
      color:#e9edf2;
      font-size:13px;
      line-height:1.5;
      display:flex;
      flex-direction:column;
      transform:translateX(100%);
      transition:transform .25s ease;
      z-index:10000;
    }
    .detail-panel.open{
      transform:translateX(0%);
    }

    .detail-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      padding:16px;
      border-bottom:1px solid var(--g600);
      background:#131417;
    }
    .detail-head-left{
      max-width:260px;
    }
    .detail-title{
      font-size:14px;
      font-weight:600;
      color:#fff;
      margin-bottom:4px;
    }
    .detail-meta{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }
    .detail-close{
      background:none;
      border:0;
      color:#8e97a3;
      font-size:12px;
      cursor:pointer;
      padding:4px 6px;
      border-radius:6px;
    }
    .detail-close:hover{
      color:#fff;
      background:#2a2d32;
    }

    .detail-body{
      flex:1;
      overflow-y:auto;
      padding:16px;
    }
    .detail-section{
      margin-bottom:16px;
      background:linear-gradient(180deg,#1a1c20,#131417);
      border:1px solid var(--g600);
      border-radius:12px;
      padding:12px;
    }
    .detail-section h4{
      margin:0 0 6px;
      font-size:12px;
      font-weight:600;
      color:#fff;
      text-transform:uppercase;
      letter-spacing:.03em;
    }
    .detail-section .small{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }

    .detail-footer{
      border-top:1px solid var(--g600);
      background:#131417;
      padding:12px 16px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .btn-full-incident{
      background:#D01616;
      color:#fff;
      border:1px solid #D01616;
      border-radius:10px;
      padding:10px 12px;
      font-size:13px;
      font-weight:600;
      line-height:1.2;
      text-align:center;
      text-decoration:none;
      cursor:pointer;
    }
    .btn-full-incident:hover{
      background:#ff2a2a;
      border-color:#ff2a2a;
    }

    .btn-back-dash{
      display:inline-block;
      text-decoration:none;
      color:#ff5a5f;
      font-size:12px;
      font-weight:600;
      text-align:center;
    }

    /* Add Feed modal */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:10001;
    }
    .modal-box{
      background:#1a1c20;
      border:1px solid var(--g600);
      border-radius:16px;
      width:320px;
      max-width:90%;
      box-shadow:0 30px 60px rgba(0,0,0,.9);
      padding:16px;
      color:var(--text);
      font-size:13px;
    }
    .modal-box h3{
      margin:0 0 12px;
      font-size:14px;
      font-weight:600;
      color:#fff;
    }
    .modal-row{
      margin-bottom:12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .modal-row label{
      font-size:12px;
      color:var(--muted);
    }
    .modal-row input, .modal-row select{
      background:#1f2024;
      border:1px solid var(--g600);
      border-radius:8px;
      color:#fff;
      padding:8px 10px;
      font-size:13px;
      line-height:1.4;
      outline:none;
      width:100%;
    }
    .modal-row input:focus,
    .modal-row select:focus{
      border-color:#D01616;
    }
    .modal-actions{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .btn-cancel{
      background:#1f2024;
      border:1px solid var(--g600);
      border-radius:8px;
      color:#8e97a3;
      font-size:12px;
      line-height:1.2;
      padding:8px 10px;
      cursor:pointer;
      flex:1;
      text-align:center;
    }
    .btn-cancel:hover{
      background:#2a2d32;
      color:#fff;
    }
    .btn-save{
      background:#D01616;
      border:1px solid #D01616;
      border-radius:8px;
      color:#fff;
      font-size:12px;
      font-weight:600;
      line-height:1.2;
      padding:8px 10px;
      cursor:pointer;
      flex:1;
      text-align:center;
    }
    .btn-save:hover{
      background:#ff2a2a;
      border-color:#ff2a2a;
    }

    @media (max-width:900px){
      .app{
        grid-template-columns:1fr;
        grid-template-areas:
          "topbar"
          "main";
      }
      .sidebar{
        display:none;
      }
      .detail-panel{
        width:80%;
        max-width:400px;
      }
    }
  </style>
</head>


  <script>
  // must be after the header DOM exists
  document.addEventListener('DOMContentLoaded', function(){
    CIAuth.injectUserChip(document.getElementById('topActions'));
    CIAuth.updateSidebarForRole(document.querySelector('aside.sidebar nav'));
  });
</script>

  
<body>
    
 <div class="brandbar">
    <img src="CityintLogo.jpg" alt="CityIntel Logo">
    <div class="title" style="font-weight:700;font-size:18px">CityIntel</div>
	<div id="trial-banner" style="display:none;position:absolute;
    left:50%; transform:translateX(-50%); background:none;
    color:#fecaca; padding:8px 12px; text-align:center;">
  <span id="trial-text">Your trial ends soon.</span>
</div>	
	  <div id="topActions" style="position:relative"></div>
  </div>
	
  <div class="app">
    <aside class="sidebar">
       <div class="section-label"></div>
      <nav>
        <a href="index.html">Dashboard</a>
        <a href="alerts.html">Alerts</a>
        <a href="events.html">Events</a>
		<a href="live-feed.html">Live Feed</a>
	<a href="brief.html">Intelligence Brief</a>
	<a href="incident.html">Incident Drilldown</a>
	    <a href="reports.html">Reports</a>
	<a href="trends.html">Trends & Forecasts</a>
		<a href="sources.html">Sources</a>
        <a href="settings.html">Settings</a>
        <a href="about.html">About</a>
      </nav>
      <div class="footnote">For information use only — not for redistribution</div>
    </aside>


  <!-- MAIN -->
  <main class="main">
    <div class="page-head">
      <div class="page-head-left">
        <h2>Live Feed</h2>
        <div class="sub">Streaming incident chatter for your selected regions.</div>
      </div>

      <div class="page-head-right">
        <!-- centered static red button -->
        <button id="btnAddFeed" class="btn-red" type="button">+ Add Feed</button>
      </div>
    </div>

    <div id="feedsGrid" class="feeds-grid">
      <!-- Cards injected here -->
    </div>
  </main>
</div>

<!-- DETAIL PANEL -->
<aside id="detailPanel" class="detail-panel">
  <div class="detail-head">
    <div class="detail-head-left">
      <div id="detailTitle" class="detail-title">[Incident Title]</div>
      <div class="detail-meta" id="detailMeta">
        [City / Risk / Time]
      </div>
    </div>
    <button class="detail-close" id="detailClose">Close ✕</button>
  </div>

  <div class="detail-body">
    <div class="detail-section">
      <h4>Summary</h4>
      <div id="detailSummary" class="small">
        -
      </div>
    </div>

    <div class="detail-section">
      <h4>Location / Impact</h4>
      <div id="detailLocation" class="small">
        Approx. location details here.
      </div>
      <div id="detailImpact" class="small" style="margin-top:8px;">
        Impact to nearby assets here.
      </div>
    </div>

    <div class="detail-section">
      <h4>Earlier Today in This Area</h4>
      <div id="detailEarlier" class="small">
        No earlier incidents recorded.
      </div>
    </div>
  </div>

  <div class="detail-footer">
    <a id="viewFullBtn" class="btn-full-incident" href="incident.html">View Full Incident →</a>
    <a class="btn-back-dash" href="index.html">← Back to Dashboard</a>
  </div>
</aside>

<!-- ADD FEED MODAL -->
<div id="modalOverlay" class="modal-overlay">
  <div class="modal-box">
    <h3>Add Feed</h3>
    <div class="modal-row">
      <label for="feedCityInput">City / Region (e.g. London)</label>
      <input id="feedCityInput" type="text" placeholder="London" />
    </div>
    <div class="modal-row">
      <label for="feedRiskSelect">Risk Levels to Include</label>
      <select id="feedRiskSelect" multiple size="3">
        <option value="high">High</option>
        <option value="med">Medium</option>
        <option value="low">Low</option>
      </select>
      <div style="font-size:11px;color:var(--muted);line-height:1.4;">
        Hold Ctrl (or Cmd on Mac) to select multiple.
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" id="modalCancel">Cancel</button>
      <button class="btn-save" id="modalSave">Save Feed</button>
    </div>
  </div>
</div>

<script>
// -------------------- top bar user chip / dropdown --------------------
(function mountTopActions(){
  const host = document.getElementById('topActions');
  if (!host) return;

  const p = JSON.parse(localStorage.getItem('ci_profile') || '{}');
  const initials = (function(name){
    if(!name) return 'CI';
    const parts = name.trim().split(/\s+/);
    return parts.slice(0,2).map(s=>s[0]?.toUpperCase()||'').join('') || 'CI';
  })(p.name);

  const role = p.role || 'Analyst';
  const isSub = (localStorage.getItem('ci_subscribed') === 'true');

  host.innerHTML = `
    <div class="user" id="userChip">
      <div class="avatar">${initials}</div>
      ${role}
    </div>
    <div class="dropdown" id="userMenu">
      <a href="settings.html">Settings</a>
      <a href="analytics.html">Analytics</a>
      <a href="system-flow.html">System Flow</a>
      <a href="operations-log.html">Operations Log</a>
      <a href="#" id="logoutLink"><span class="logout-link">Log out</span></a>
    </div>
  `;

  const chip  = document.getElementById('userChip');
  const menu  = document.getElementById('userMenu');
  const logoutLink = document.getElementById('logoutLink');

  chip.addEventListener('click', ()=>{
    menu.style.display = (menu.style.display==='block')?'none':'block';
  });
  document.addEventListener('click',(e)=>{
    if(!host.contains(e.target)) menu.style.display='none';
  });

  logoutLink.addEventListener('click',(e)=>{
    e.preventDefault();
    if(window.CIAuth && CIAuth.logout) CIAuth.logout();
    location.href='index.html';
  });

  // trial banner logic
  const trialBanner = document.getElementById('trial-banner');
  const trialText   = document.getElementById('trial-text');
  const trialEnds   = localStorage.getItem('ci_trialEndsAt');
  const subscribed  = (localStorage.getItem('ci_subscribed') === 'true');

  if (!subscribed && trialEnds) {
    // show "Your trial ends <time>"
    try {
      const d = new Date(trialEnds);
      const leftMin = Math.max(0, Math.round((d - Date.now()) / 60000));
      trialBanner.style.display='block';
      if (leftMin <= 0) {
        trialText.textContent = 'Your trial has ended.';
      } else if (leftMin < 60) {
        trialText.textContent = `Your trial ends in ${leftMin} min`;
      } else {
        const leftHr = Math.round(leftMin/60);
        trialText.textContent = `Your trial ends in ${leftHr} hour${leftHr!==1?'s':''}`;
      }
    } catch(e){
      trialBanner.style.display='block';
      trialText.textContent = 'Trial active.';
    }
  }
})();

// -------------------- FEED STORAGE / STATE --------------------
const STORAGE_KEY = 'ci_live_feeds_v1';

// read feeds from localStorage
function loadFeeds(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr)?arr:[];
  }catch(e){
    return [];
  }
}

// save feeds to localStorage
function saveFeeds(feeds){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(feeds));
}

// add a feed definition {id, places[], risks[]}
function addFeedDef(def){
  const feeds = loadFeeds();
  feeds.push(def);
  saveFeeds(feeds);
}

// -------------------- RENDER / FETCH MOCK DATA --------------------
async function fetchMockEventsForFeed(feed){
  // feed.places is array of cities, feed.risks is array of risk levels
  // We'll ask Worker for mock data (still fake but consistent format)
  const params = new URLSearchParams();
  if(feed.places && feed.places.length){
    params.set('cities', feed.places.join(','));
  }
  if(feed.risks && feed.risks.length){
    params.set('risk', feed.risks.join(','));
  }
  const url = `https://api.cityintelapi.com/api/live?${params.toString()}`;

  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error('bad response');
    const data = await res.json();
    return data.events || [];
  }catch(e){
    console.warn('mock fetch fail', e);
    return [];
  }
}

function riskClass(r){
  if(r==='high') return 'high';
  if(r==='med')  return 'med';
  return 'low';
}

function fmtWhen(iso){
  try{
    return new Date(iso).toLocaleString('en-GB',{
      timeZone:'Europe/London',
      day:'2-digit',month:'short',
      hour:'2-digit',minute:'2-digit'
    });
  }catch(e){
    return iso||'';
  }
}

// -------------------- DETAIL PANEL HANDLING --------------------
const detailPanel   = document.getElementById('detailPanel');
const detailTitleEl = document.getElementById('detailTitle');
const detailMetaEl  = document.getElementById('detailMeta');
const detailSummaryEl = document.getElementById('detailSummary');
const detailLocationEl = document.getElementById('detailLocation');
const detailImpactEl   = document.getElementById('detailImpact');
const detailEarlierEl  = document.getElementById('detailEarlier');
const detailCloseBtn = document.getElementById('detailClose');
const viewFullBtn   = document.getElementById('viewFullBtn');

function openDetailPanel(item, relatedList){
  // item = {title, city, risk, when, ...}
  // relatedList = array of all events in that feed (for "earlier today")

  detailTitleEl.textContent = item.title || '[Incident Title]';
  detailMetaEl.textContent = `${item.city||'Unknown'} • ${item.risk||'n/a'} • ${fmtWhen(item.when)}`;

  detailSummaryEl.textContent = item.description ||
                                `Ongoing situation reported in ${item.city||'the area'}.`;

  // mock "location / impact"
  detailLocationEl.textContent =
    `Approx area: ${item.city||'unknown'} (exact location may be refining).`;
  detailImpactEl.textContent =
    `Nearest office: CityIntel HQ, ~2km. Impact: Elevated security posture recommended.`;

  // earlier today in same city
  const sameCityEarlier = (relatedList||[])
    .filter(x => x.city===item.city && x.when !== item.when)
    .slice(0,3)
    .map(x => `• ${fmtWhen(x.when)} — ${x.title}`)
    .join('\n');
  detailEarlierEl.textContent = sameCityEarlier || 'No earlier incidents recorded.';

  // incident deep-link -> you could add query params later
  viewFullBtn.href = 'incident.html';

  detailPanel.classList.add('open');
}
function closeDetailPanel(){
  detailPanel.classList.remove('open');
}
detailCloseBtn.addEventListener('click', closeDetailPanel);

// close if click outside panel (optional)
// window.addEventListener('click', (e)=>{
//   if(detailPanel.classList.contains('open')){
//     // if click is not inside panel
//     if(!detailPanel.contains(e.target)){
//       closeDetailPanel();
//     }
//   }
// });

// -------------------- CARD RENDER --------------------
async function renderFeeds(){
  const grid = document.getElementById('feedsGrid');
  const feeds = loadFeeds();

  // if there are no feeds saved, seed one default
  if(!feeds.length){
    const first = {
      id: 'default-1',
      places: ['London'],
      risks: ['high','med','low']
    };
    saveFeeds([first]);
  }

  const finalFeeds = loadFeeds();

  grid.innerHTML = '';

  for (const feed of finalFeeds){
    const events = await fetchMockEventsForFeed(feed);

    const card = document.createElement('section');
    card.className = 'feed-card';

    // header
    const citiesLabel = feed.places.join(', ');
    const risksLabel  = feed.risks.join(', ');
    const topCity = feed.places[0] || 'Unknown';

    card.innerHTML = `
      <div class="feed-head">
        <div class="feed-head-left">
          <div class="feed-city">${citiesLabel}</div>
          <div style="margin-top:4px;font-size:12px;color:${feed.risks.includes('high')?'#ff5a5f':feed.risks.includes('med')?'#f0b429':'#33c48d'};">
            Watching: ${risksLabel}
          </div>
        </div>
        <div class="feed-head-right">
          <button class="btn-ghost btn-edit-feed" data-feedid="${feed.id}">Edit</button>
        </div>
      </div>

      <div class="feed-body"></div>

      <div class="feed-footer">
        <div class="src">source: simulated source</div>
        <div class="refresh" data-feedid="${feed.id}">↻ refresh</div>
      </div>
    `;

    const bodyEl = card.querySelector('.feed-body');

    if (!events.length){
      bodyEl.innerHTML = `<div style="color:var(--muted);font-size:12px;">No recent items in ${citiesLabel}.</div>`;
    } else {
      events.slice(0,8).forEach(ev=>{
        const itemEl = document.createElement('div');
        itemEl.className = 'feed-item';
        itemEl.style.borderLeftColor =
          ev.risk==='high' ? '#ff5a5f' :
          ev.risk==='med'  ? '#f0b429' :
                             '#33c48d';

        itemEl.innerHTML = `
          <div class="feed-title-row">
            <div>${ev.city || topCity} — ${ev.title}</div>
            <div class="feed-risk ${riskClass(ev.risk)}">${ev.risk}</div>
          </div>
          <div class="feed-meta">
            <span>${fmtWhen(ev.when)}</span>
            <span>${ev.risk.toUpperCase()} priority</span>
          </div>
        `;

        // clicking an item opens side panel instead of nav
        itemEl.addEventListener('click', ()=>{
          openDetailPanel(ev, events);
        });

        bodyEl.appendChild(itemEl);
      });
    }

    // refresh link
    const refreshBtn = card.querySelector('.refresh');
    refreshBtn.addEventListener('click', ()=>{
      renderFeeds(); // just rerender for now
    });

    // edit feed
    const editBtn = card.querySelector('.btn-edit-feed');
    editBtn.addEventListener('click', ()=>{
      openFeedModal(feed);
    });

    grid.appendChild(card);
  }
}

// -------------------- FEED MODAL LOGIC --------------------
const overlayEl = document.getElementById('modalOverlay');
const cityInput = document.getElementById('feedCityInput');
const riskSel   = document.getElementById('feedRiskSelect');
const cancelBtn = document.getElementById('modalCancel');
const saveBtn   = document.getElementById('modalSave');
const addFeedBtn= document.getElementById('btnAddFeed');

let editingFeedId = null;

function openFeedModal(feed){
  editingFeedId = feed ? feed.id : null;
  overlayEl.style.display='flex';

  if(feed){
    cityInput.value = (feed.places||[]).join(', ');
    // reset all first
    for (let i=0;i<riskSel.options.length;i++){
      riskSel.options[i].selected = false;
    }
    (feed.risks||[]).forEach(r=>{
      for (let i=0;i<riskSel.options.length;i++){
        if(riskSel.options[i].value===r){
          riskSel.options[i].selected = true;
        }
      }
    });
  } else {
    cityInput.value = '';
    for (let i=0;i<riskSel.options.length;i++){
      riskSel.options[i].selected = false;
    }
    // default select high+med
    for (let i=0;i<riskSel.options.length;i++){
      if(['high','med'].includes(riskSel.options[i].value)){
        riskSel.options[i].selected = true;
      }
    }
  }
}

function closeFeedModal(){
  overlayEl.style.display='none';
  editingFeedId = null;
}

cancelBtn.addEventListener('click', closeFeedModal);
overlayEl.addEventListener('click',(e)=>{
  if(e.target===overlayEl){
    closeFeedModal();
  }
});
addFeedBtn.addEventListener('click', ()=>openFeedModal(null));

saveBtn.addEventListener('click', ()=>{
  const rawCities = cityInput.value.trim();
  if(!rawCities){
    alert('Please enter at least one city/region.');
    return;
  }
  const places = rawCities.split(',').map(s=>s.trim()).filter(Boolean);

  const risks = [];
  for (let i=0;i<riskSel.options.length;i++){
    if(riskSel.options[i].selected){
      risks.push(riskSel.options[i].value);
    }
  }
  if(!risks.length){
    alert('Please pick at least one risk level.');
    return;
  }

  const feeds = loadFeeds();

  if(editingFeedId){
    // update existing
    const idx = feeds.findIndex(f=>f.id===editingFeedId);
    if(idx>=0){
      feeds[idx].places = places;
      feeds[idx].risks  = risks;
    }
    saveFeeds(feeds);
  } else {
    // create new
    const id = 'feed-' + Date.now().toString(36);
    feeds.push({ id, places, risks });
    saveFeeds(feeds);
  }

  closeFeedModal();
  renderFeeds();
});

// -------------------- INIT --------------------
renderFeeds();

</script>

<!-- auth helpers / admin links -->

<script src="admin-links.js"></script>

</body>
</html>
